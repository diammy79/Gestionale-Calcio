<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âš½ Moreschi Gestionale Calcio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: system-ui, -apple-system, sans-serif;
      scroll-behavior: smooth;
    }
    
    /* ========== ANIMAZIONI E TRANSIZIONI ========== */
    
    /* Fade in generale */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Slide in da sinistra */
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* Slide in da destra */
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* Scale up */
    @keyframes scaleUp {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    /* Pulse */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Shake */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    /* Applicazione animazioni */
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    .animate-slide-in-left {
      animation: slideInLeft 0.5s ease-out;
    }
    
    .animate-slide-in-right {
      animation: slideInRight 0.5s ease-out;
    }
    
    .animate-scale-up {
      animation: scaleUp 0.3s ease-out;
    }
    
    .animate-pulse-slow {
      animation: pulse 2s ease-in-out infinite;
    }
    
    .animate-shake {
      animation: shake 0.5s ease-in-out;
    }
    
    /* ========== TRANSIZIONI SMOOTH ========== */
    
    * {
      transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
      transition-duration: 200ms;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    button, a, input, select, textarea {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* ========== HOVER EFFECTS MIGLIORATI ========== */
    
    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    button:not(:disabled):active {
      transform: translateY(0);
    }
    
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* ========== LOADING STATES ========== */
    
    /* Skeleton loader */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }
    
    /* Spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-left-color: #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    /* ========== RESPONSIVE MOBILE ========== */
    
    /* Miglioramenti touch */
    @media (hover: none) and (pointer: coarse) {
      button, a, input, select {
        min-height: 44px; /* Apple guidelines */
        min-width: 44px;
      }
      
      /* Disabilita hover su touch */
      button:hover {
        transform: none;
      }
    }
    
    /* Tablet e mobile */
    @media (max-width: 768px) {
      /* Font piÃ¹ grandi su mobile */
      body {
        font-size: 16px;
      }
      
      /* Padding ridotto */
      .mobile-compact {
        padding: 0.5rem !important;
      }
      
      /* Nascondi testo su mobile, mostra solo icone */
      .hide-text-mobile span {
        display: none;
      }
      
      /* Tab scrollabile */
      .tab-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin; /* Mostra scrollbar sottile su Firefox */
        scrollbar-color: #cbd5e0 transparent; /* Colore scrollbar */
      }
      
      .tab-container::-webkit-scrollbar {
        height: 4px; /* Scrollbar sottile su Chrome/Safari */
      }
      
      .tab-container::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .tab-container::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 2px;
      }
      
      .tab-container::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
      }
      
      /* Su mobile nascondi completamente lo scrollbar */
      @media (max-width: 768px) {
        .tab-container {
          scrollbar-width: none;
        }
        
        .tab-container::-webkit-scrollbar {
          display: none;
        }
      }
    }
    
    /* Solo mobile piccolo */
    @media (max-width: 480px) {
      /* Stack su mobile */
      .mobile-stack {
        flex-direction: column !important;
      }
      
      /* Full width su mobile */
      .mobile-full {
        width: 100% !important;
      }
    }
    
    /* ========== MIGLIORAMENTI SCROLL ========== */
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* ========== FOCUS STATES ========== */
    
    button:focus, input:focus, select:focus, textarea:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    
    /* ========== GLASSMORPHISM (opzionale) ========== */
    
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* ========== GRADIENT TEXT ========== */
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* ========== BADGE PULSE ========== */
    
    @keyframes badge-pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.1);
      }
    }
    
    .badge-animated {
      animation: badge-pulse 2s ease-in-out infinite;
    }
    
    /* ========== CARD IMPROVEMENTS ========== */
    
    .card-modern {
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .card-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
    }
    
    /* ========== RIPPLE EFFECT ========== */
    
    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
    
    .ripple {
      position: relative;
      overflow: hidden;
    }
    
    .ripple::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transform: scale(0);
      opacity: 0;
    }
    
    .ripple:active::after {
      animation: ripple 0.6s ease-out;
    }
    
    /* ========== PRINT STYLES ========== */
    
    @media print {
      button, .no-print {
        display: none !important;
      }
    }
    
    /* ========== TOAST NOTIFICATIONS ========== */
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    
    .toast {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: start;
      gap: 12px;
      animation: slideInRight 0.3s ease-out;
      min-width: 300px;
    }
    
    .toast.toast-success {
      border-left: 4px solid #10b981;
    }
    
    .toast.toast-error {
      border-left: 4px solid #ef4444;
    }
    
    .toast.toast-warning {
      border-left: 4px solid #f59e0b;
    }
    
    .toast.toast-info {
      border-left: 4px solid #3b82f6;
    }
    
    .toast.toast-exit {
      animation: slideOutRight 0.3s ease-in;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    
    /* ========== LOADING SPINNER ENHANCED ========== */
    
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-center;
      z-index: 9998;
      backdrop-filter: blur(4px);
    }
    
    .loading-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: scaleUp 0.3s ease-out;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 16px;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    /* ========== DRAG & DROP STYLES ========== */
    
    .draggable {
      cursor: move;
      transition: all 0.2s ease;
    }
    
    .draggable:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .draggable.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .drop-zone {
      min-height: 60px;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .drop-zone.drag-over {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    /* ========== CALENDAR STYLES ========== */
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .calendar-day:hover {
      background: #f3f4f6;
      border-color: #3b82f6;
    }
    
    .calendar-day.today {
      background: #dbeafe;
      border-color: #3b82f6;
      font-weight: bold;
    }
    
    .calendar-day.has-event {
      background: #fef3c7;
    }
    
    .calendar-day.has-event::after {
      content: '';
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      background: #f59e0b;
      border-radius: 50%;
    }
    
    /* ========== INJURY STATUS BADGES ========== */
    
    .injury-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .injury-badge.active {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .injury-badge.recovering {
      background: #fef3c7;
      color: #92400e;
    }
    
    .injury-badge.recovered {
      background: #d1fae5;
      color: #065f46;
    }
  </style>
  <meta name="theme-color" content="#1a56db">
  <meta name="description" content="Moreschi Gestionale Calcio - Gestione Squadra Completa">
  <link rel="manifest" href="manifest.json">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useMemo } = React;

// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyBKMsg16kzFnY529eR03DUjGoOO-XZonZc",
  authDomain: "gestionale-calcio-59318.firebaseapp.com",
  projectId: "gestionale-calcio-59318",
  storageBucket: "gestionale-calcio-59318.firebasestorage.app",
  messagingSenderId: "573513891203",
  appId: "1:573513891203:web:a7ae4934de0913b6120ab6"
};

let firebaseApp, auth, db;
try {
  firebaseApp = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
    console.log('Persistenza:', err.code);
  });
} catch (error) {
  console.error('Errore inizializzazione Firebase:', error);
}

// ============================================
// COMPONENTE LOGIN
// ============================================
const LoginScreen = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
      setError('Email o password non validi');
      console.error('Errore login:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-600 via-blue-700 to-blue-900 flex items-center justify-center p-4">
      <div className="max-w-md w-full">
        <div className="text-center mb-8">
          <div className="text-7xl mb-4 animate-bounce">âš½</div>
          <h1 className="text-5xl font-black text-white mb-2" style={{textShadow: '3px 3px 6px rgba(0,0,0,0.4)'}}>
            Moreschi Gestionale Calcio
          </h1>
          <p className="text-blue-200 text-lg">Gestione Squadra Completa</p>
        </div>

        <div className="bg-white rounded-2xl shadow-2xl p-8">
          <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Accedi</h2>
          
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                placeholder="example@domain.com"
                required
                disabled={loading}
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                required
                disabled={loading}
              />
            </div>

            {error && (
              <div className="bg-red-50 border-2 border-red-300 text-red-700 px-4 py-3 rounded-lg text-sm">
                {error}
              </div>
            )}

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
              {loading ? 'Accesso in corso...' : 'Accedi'}
            </button>
          </form>

        </div>

        <div className="text-center mt-6">
          <p className="text-blue-200 text-sm">
            Moreschi Gestionale Calcio Â© 2025 - Mister Roberto
          </p>
        </div>
      </div>
    </div>
  );
};

const LogOut = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
    <polyline points="16 17 21 12 16 7"/>
    <line x1="21" y1="12" x2="9" y2="12"/>
  </svg>
);



// Definizione icone SVG
const Download = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
    <polyline points="7 10 12 15 17 10"/>
    <line x1="12" y1="15" x2="12" y2="3"/>
  </svg>
);

const Plus = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="12" y1="5" x2="12" y2="19"/>
    <line x1="5" y1="12" x2="19" y2="12"/>
  </svg>
);

const Trash2 = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <polyline points="3 6 5 6 21 6"/>
    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
    <line x1="10" y1="11" x2="10" y2="17"/>
    <line x1="14" y1="11" x2="14" y2="17"/>
  </svg>
);

const Save = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
    <polyline points="17 21 17 13 7 13 7 21"/>
    <polyline points="7 3 7 8 15 8"/>
  </svg>
);


// IndexedDB wrapper per salvataggio automatico affidabile
const DB_NAME = 'RealDORDatabase';
const DB_VERSION = 1;
const STORE_NAME = 'teamData';

const initDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME);
      }
    };
  });
};

const saveToIndexedDB = async (key, data) => {
  try {
    const db = await initDB();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    store.put(data, key);
    return new Promise((resolve, reject) => {
      transaction.oncomplete = () => resolve(true);
      transaction.onerror = () => reject(transaction.error);
    });
  } catch (error) {
    console.error('Errore salvataggio IndexedDB:', error);
    return false;
  }
};

const loadFromIndexedDB = async (key) => {
  try {
    const db = await initDB();
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(key);
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (error) {
    console.error('Errore caricamento IndexedDB:', error);
    return null;
  }
};

const SoccerTeamTracker = () => {
    // Stati autenticazione
  const [user, setUser] = useState(null);
  const [userRole, setUserRole] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);

  const [isLoading, setIsLoading] = useState(true);
  const [lastSaved, setLastSaved] = useState(null);
  const [recoveryMinutes, setRecoveryMinutes] = useState('');
  const [players, setPlayers] = useState([
    { numero: 1, nome: "Frassine Lorenzo", ruolo: "Portiere", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 2, nome: "Boudene Anis", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 3, nome: "Adu Gyamfi Kyei Ofori", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 4, nome: "Scotti Filippo", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 5, nome: "Zucca Diego", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 6, nome: "Esposito Riccardo", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 7, nome: "Eddikh Aslam", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 8, nome: "Tinubu Ryan Olufemi", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 9, nome: "Medeghini Nicolas", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 10, nome: "Paloschi Riccardo", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 11, nome: "Ekoma Prince Aseosa", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 12, nome: "Venturelli Nicola", ruolo: "Portiere", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 13, nome: "Gabusi Francesco", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 14, nome: "Leone", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 15, nome: "Pupino Lorenzo", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 16, nome: "Testaverde Simone", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 17, nome: "Ayari Youssef", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 18, nome: "Bevilacqua Matteo", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 19, nome: "Bentalha Omar Elfarouk", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 20, nome: "Hepaj Aron", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 21, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 22, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 23, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 24, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 25, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 26, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 27, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 28, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 29, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 30, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" }
  ]);

  const [trainings, setTrainings] = useState([]);
  const [matches, setMatches] = useState([]);
  const [activeTab, setActiveTab] = useState('trainings');
  const [editingPlayer, setEditingPlayer] = useState(null);
  const [showInstructionsModal, setShowInstructionsModal] = useState(false);
  const [expandedTrainings, setExpandedTrainings] = useState({});
  const [expandedMatches, setExpandedMatches] = useState({});
  const [matchTimer, setMatchTimer] = useState(0);
  const [isTimerRunning, setIsTimerRunning] = useState(false);
  const [timerInterval, setTimerInterval] = useState(null);
  const [liveMatchMode, setLiveMatchMode] = useState(null);
  const [substitutionMode, setSubstitutionMode] = useState(null);
  const [recoveryTime, setRecoveryTime] = useState(0);
  const [isRecoveryRunning, setIsRecoveryRunning] = useState(false);
  const [recoveryInterval, setRecoveryInterval] = useState(null);
  const [showModuloModal, setShowModuloModal] = useState(null);
  const [moduloTattico, setModuloTattico] = useState({});
  const [playerSelectionModal, setPlayerSelectionModal] = useState(null);
  const [dragState, setDragState] = useState(null); // Per tracciare drag offset
  const [matchEnded, setMatchEnded] = useState(false);
  const [appTitle, setAppTitle] = useState('Moreschi Roberto - Gestione squadra Real DOR Under 18');
  const [isEditingTitle, setIsEditingTitle] = useState(false);
  const [enlargedPhoto, setEnlargedPhoto] = useState(null);
  const [halfTime, setHalfTime] = useState(1);
  const [showVictoryCelebration, setShowVictoryCelebration] = useState(false);
  const [teamLogo, setTeamLogo] = useState('');
  const [showManualImport, setShowManualImport] = useState(false);
  const [manualImportData, setManualImportData] = useState('');
  const [confirmDialog, setConfirmDialog] = useState({ show: false, message: '', onConfirm: null });
  const [cardTypeDialog, setCardTypeDialog] = useState({ show: false, cardType: '', playerNum: 0, matchId: null, playerName: '', minuto: null });
  
  // State per Divisione Squadre
  const [numSquadre, setNumSquadre] = useState(2);
  const [includiPortieri, setIncludiPortieri] = useState(true);
  const [showDivisioneResults, setShowDivisioneResults] = useState(false);
  const [infortunati, setInfortunati] = useState(new Set());
  const [regenerateKey, setRegenerateKey] = useState(0);
  
  // State per Convocazioni
  const [convocati, setConvocati] = useState(new Set());
  const [showConvocazioniModal, setShowConvocazioniModal] = useState(false);
  const [infoPartita, setInfoPartita] = useState({
    squadra1: '',
    squadra2: '',
    dataPartita: '',
    oraRitrovo: '',
    indirizzoCompo: ''
  });
  
  // State per Analisi Tattica
  const [moduloAvversario, setModuloAvversario] = useState('');
  
  // ========== STATE PER SINCRONIZZAZIONE CLOUD ==========
  const [syncStatus, setSyncStatus] = useState('idle'); // 'idle', 'syncing', 'success', 'error'
  const [lastSynced, setLastSynced] = useState(null);
  const [syncError, setSyncError] = useState('');
  const [autoSyncEnabled, setAutoSyncEnabled] = useState(true);
  const [syncConflicts, setSyncConflicts] = useState(null);
  const [showConflictModal, setShowConflictModal] = useState(false);
  
  // ========== STATE PER NUOVE FEATURE ==========
  // Toast Notifications
  const [toasts, setToasts] = useState([]);
  
  // Loading States
  const [loadingMessage, setLoadingMessage] = useState('');
  const [loadingProgress, setLoadingProgress] = useState(0);
  const [showLoading, setShowLoading] = useState(false);
  
  // Gestione Infortuni
  const [injuries, setInjuries] = useState([]);
  const [showInjuryModal, setShowInjuryModal] = useState(false);
  const [selectedPlayerForInjury, setSelectedPlayerForInjury] = useState(null);
  
  // Calendario
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [showEventModal, setShowEventModal] = useState(false);
  const [selectedDate, setSelectedDate] = useState(null);
  
  // Drag & Drop
  const [draggedPlayer, setDraggedPlayer] = useState(null);
  const [formationPositions, setFormationPositions] = useState({});
  
  // Sistema MVP
  const [showMVPModal, setShowMVPModal] = useState(false);
  const [selectedMatchForMVP, setSelectedMatchForMVP] = useState(null);

  // Carica dati da IndexedDB all'avvio
    // Gestione autenticazione
  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (user) => {
      if (user) {
        setUser(user);
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            const role = userDoc.data().role || 'user';
            setUserRole(role);
          } else {
            setUserRole('user');
          }
        } catch (error) {
          console.error('Errore recupero ruolo:', error);
          setUserRole('user');
        }
      } else {
        setUser(null);
        setUserRole(null);
      }
      setAuthLoading(false);
    });

    return () => unsubscribe();
  }, []);

  useEffect(() => {
    const loadData = async () => {
      try {
        const savedData = await loadFromIndexedDB('squadraRealDOR');
        if (savedData) {
          let loadedPlayers = savedData.players || players;
          
          loadedPlayers = loadedPlayers.map(p => ({
            ...p,
            dataCreazione: p.dataCreazione || (p.nome ? "2025-08-01" : "")
          }));
          
          if (loadedPlayers.length < 30) {
            const currentLength = loadedPlayers.length;
            for (let i = currentLength + 1; i <= 30; i++) {
              loadedPlayers.push({ 
                numero: i, 
                nome: "", 
                ruolo: "", 
                dataNascita: "", 
                telefono: "", 
                foto: "", 
                piede: "",
                dataCreazione: ""
              });
            }
          }
          
          setPlayers(loadedPlayers);
          setTrainings(savedData.trainings || []);
          setMatches(savedData.matches || []);
          setAppTitle(savedData.appTitle || appTitle);
          setTeamLogo(savedData.teamLogo || '');
          setInjuries(savedData.injuries || []);
          setLastSaved(savedData.lastSaved ? new Date(savedData.lastSaved) : null);
        }
      } catch (error) {
        console.error('Errore caricamento dati:', error);
      } finally {
        setIsLoading(false);
      }
    };
    loadData();
  }, []);

  // Salvataggio AUTOMATICO
  useEffect(() => {
    if (isLoading) return;
    
    const saveData = async () => {
      const dataToSave = {
        players,
        trainings,
        matches,
        appTitle,
        teamLogo,
        injuries,
        lastSaved: new Date().toISOString()
      };
      
      const success = await saveToIndexedDB('squadraRealDOR', dataToSave);
      if (success) {
        setLastSaved(new Date());
      }
    };
    
    saveData();
  }, [players, trainings, matches, appTitle, teamLogo, injuries, isLoading]);

  useEffect(() => {
    if (isTimerRunning) {
      const interval = setInterval(() => {
        setMatchTimer(prev => {
          const newTime = prev + 1;
          
          if (newTime === 2700 && halfTime === 1) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 4; i++) {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 550;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
              }, i * 1000);
            }
            
            setIsTimerRunning(false);
            setIsRecoveryRunning(true);
            setRecoveryTime(0);
          }
          
          if (newTime === 5400 && halfTime === 2) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 4; i++) {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 550;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
              }, i * 1000);
            }
            
            setIsTimerRunning(false);
            setIsRecoveryRunning(true);
            setRecoveryTime(0);
          }
          
          return newTime;
        });
      }, 1000);
      setTimerInterval(interval);
      return () => clearInterval(interval);
    } else if (timerInterval) {
      clearInterval(timerInterval);
      setTimerInterval(null);
    }
  }, [isTimerRunning, halfTime]);

  useEffect(() => {
    if (isRecoveryRunning) {
      const interval = setInterval(() => {
        setRecoveryTime(prev => {
          const newTime = prev + 1;
          if (recoveryMinutes && parseInt(recoveryMinutes) > 0 && newTime === parseInt(recoveryMinutes) * 60) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 4; i++) {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 550;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
              }, i * 1000);
            }
            
            setIsRecoveryRunning(false);
            
            if (halfTime === 1) {
              setHalfTime(2);
              setMatchTimer(2700);
              setRecoveryTime(0);
              setRecoveryMinutes('');
            } else {
              setMatchEnded(true);
            }
          }
          return newTime;
        });
      }, 1000);
      setRecoveryInterval(interval);
      return () => clearInterval(interval);
    } else if (recoveryInterval) {
      clearInterval(recoveryInterval);
      setRecoveryInterval(null);
    }
  }, [isRecoveryRunning, recoveryMinutes, halfTime]);

  const startTimer = () => setIsTimerRunning(true);
  const pauseTimer = () => setIsTimerRunning(false);

  const addMinute = () => {
    setMatchTimer(prev => {
      const maxTime = halfTime === 1 ? 2700 : 5400;
      return Math.min(prev + 60, maxTime);
    });
  };

  const removeMinute = () => {
    setMatchTimer(prev => {
      const minTime = halfTime === 1 ? 0 : 2700;
      return Math.max(prev - 60, minTime);
    });
  };

  const addRecoveryMinute = () => {
    setRecoveryTime(prev => prev + 60);
  };

  const removeRecoveryMinute = () => {
    setRecoveryTime(prev => Math.max(prev - 60, 0));
  };

  const endMatch = () => {
    setIsTimerRunning(false);
    setIsRecoveryRunning(false);
    setMatchEnded(true);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const startLiveMatch = (matchId) => {
    setLiveMatchMode(matchId);
    setMatchTimer(0);
    setIsTimerRunning(false);
    setSubstitutionMode(null);
    setRecoveryTime(0);
    setIsRecoveryRunning(false);
    setMatchEnded(false);
    setRecoveryMinutes('');
  };

  const closeLiveMatch = () => {
    setLiveMatchMode(null);
    setIsTimerRunning(false);
    setMatchTimer(0);
    setSubstitutionMode(null);
    setRecoveryTime(0);
    setIsRecoveryRunning(false);
    setMatchEnded(false);
    setRecoveryMinutes('');
  };

  const initiateSubstitution = (playerOut) => {
    const match = matches.find(m => m.id === liveMatchMode);
    const player = players.find(p => p.numero === playerOut);
    
    if (match && player) {
      const numSostituzioni = Object.values(match.sostituzioni || {}).filter(v => v === true).length;
      
      if (numSostituzioni >= 5) {
        showConfirm(`ðŸš« SOSTITUZIONE NON CONSENTITA!\n\nâš ï¸ HAI GIÃ€ EFFETTUATO 5 SOSTITUZIONI\n\nNon Ã¨ possibile effettuare la 6Â° sostituzione.\nIl regolamento consente un massimo di 5 sostituzioni per partita.`, () => {});
        return;
      }
      
      if (numSostituzioni === 4) {
        showConfirm(`âš ï¸ ATTENZIONE - ULTIMA SOSTITUZIONE!\n\nQuesta sarÃ  la tua 5Â° e ULTIMA sostituzione possibile.\n\nESCE: ${player.nome} (#${playerOut})\n\nConfermi?`, () => {
          setSubstitutionMode(playerOut);
        });
      } else {
        showConfirm(`ðŸ”„ Confermi la SOSTITUZIONE di ${player.nome} (#${playerOut})?\n\nDopo aver confermato, clicca sul giocatore che entra dalla panchina.\n\nSostituzioni effettuate: ${numSostituzioni}/5`, () => {
          setSubstitutionMode(playerOut);
        });
      }
    }
  };

  const completeSubstitution = (matchId, playerOut, playerIn) => {
    const match = matches.find(m => m.id === matchId);
    const playerOutData = players.find(p => p.numero === playerOut);
    const playerInData = players.find(p => p.numero === playerIn);
    
    if (match && playerOutData && playerInData) {
      let minutiAttuali;
      if (halfTime === 1) {
        minutiAttuali = Math.floor(matchTimer / 60);
      } else {
        minutiAttuali = Math.floor(matchTimer / 60);
      }
      
      const ordineDistinta = match.ordineDistinta || {};
      const magliaOut = ordineDistinta[playerOut] || playerOut;
      const magliaIn = ordineDistinta[playerIn] || playerIn;
      
      showConfirm(`ðŸ”„ CONFERMA SOSTITUZIONE:\n\nESCE: ${playerOutData.nome} (#${magliaOut})\nENTRA: ${playerInData.nome} (#${magliaIn})\n\nMinuto: ${minutiAttuali}'`, () => {
        const minutiGiocatiOut = minutiAttuali;
        const minutiGiocatiIn = 90 - minutiAttuali;
        
        const newSost = { ...match.sostituzioni, [playerOut]: true };
        const newEntr = { ...match.entrati, [playerIn]: true };
        const newMin = { 
          ...match.minutiGiocati, 
          [playerOut]: minutiGiocatiOut.toString(),
          [playerIn]: minutiGiocatiIn.toString()
        };
        
        const ordineDistinta = match.ordineDistinta || {};
        const newOrdineDistinta = { ...ordineDistinta };
        
        let posizioneVisualizzazione = match.posizioneVisualizzazione;
        if (!posizioneVisualizzazione) {
          posizioneVisualizzazione = {};
          
          const titolariArray = Object.keys(match.titolari)
            .filter(num => match.titolari[num])
            .map(num => parseInt(num));
          
          const hasOrdineDistinta = titolariArray.some(num => ordineDistinta[num] && ordineDistinta[num] !== num.toString());
          
          if (hasOrdineDistinta) {
            titolariArray.sort((a, b) => {
              const ordA = parseInt(ordineDistinta[a] || 999);
              const ordB = parseInt(ordineDistinta[b] || 999);
              if (ordA === ordB) return a - b;
              return ordA - ordB;
            });
          } else {
            titolariArray.sort((a, b) => a - b);
          }
          
          titolariArray.forEach((numero, index) => {
            posizioneVisualizzazione[numero] = index + 1;
          });
        }
        const newPosizioneVisualizzazione = { ...posizioneVisualizzazione };
        
        let posizioneDelSostituito = newPosizioneVisualizzazione[playerOut];
        let posizioneDelSubentrante = newPosizioneVisualizzazione[playerIn];
        
        if (!posizioneDelSubentrante) {
          const maxPos = Math.max(...Object.values(newPosizioneVisualizzazione).filter(v => !isNaN(v)));
          posizioneDelSubentrante = maxPos + 1;
        }
        
        if (!posizioneDelSostituito) {
          const titolariArray = Object.keys(match.titolari)
            .filter(num => match.titolari[num])
            .map(num => parseInt(num));
          
          const hasOrdineDistinta = titolariArray.some(num => ordineDistinta[num] && ordineDistinta[num] !== num.toString());
          
          if (hasOrdineDistinta) {
            titolariArray.sort((a, b) => {
              const ordA = parseInt(ordineDistinta[a] || 999);
              const ordB = parseInt(ordineDistinta[b] || 999);
              if (ordA === ordB) return a - b;
              return ordA - ordB;
            });
          } else {
            titolariArray.sort((a, b) => a - b);
          }
          
          const index = titolariArray.indexOf(playerOut);
          if (index !== -1) {
            posizioneDelSostituito = index + 1;
          }
        }
        
        if (posizioneDelSostituito) {
          newPosizioneVisualizzazione[playerIn] = posizioneDelSostituito;
          newPosizioneVisualizzazione[playerOut] = posizioneDelSubentrante;
        }
        
        const sostituzioniDettaglio = match.sostituzioniDettaglio || {};
        const newSostituzioniDettaglio = {
          ...sostituzioniDettaglio,
          [playerOut]: { sostituito: true, sostituitoreDa: playerIn, minuto: minutiAttuali },
          [playerIn]: { entrato: true, alPostoDi: playerOut, minuto: minutiAttuali }
        };
        
        setMatches(matches.map(m => 
          m.id === matchId ? { 
            ...m,
            sostituzioni: newSost, 
            entrati: newEntr,
            minutiGiocati: newMin,
            ordineDistinta: newOrdineDistinta,
            posizioneVisualizzazione: newPosizioneVisualizzazione,
            sostituzioniDettaglio: newSostituzioniDettaglio
          } : m
        ));
        
        setSubstitutionMode(null);
      });
    }
  };

  const cancelSubstitution = () => {
    setSubstitutionMode(null);
  };

  const showConfirm = (message, onConfirm) => {
    setConfirmDialog({ show: true, message, onConfirm });
  };

  const handleConfirm = () => {
    if (confirmDialog.onConfirm) {
      confirmDialog.onConfirm();
    }
    setConfirmDialog({ show: false, message: '', onConfirm: null });
  };

  const handleCancel = () => {
    setConfirmDialog({ show: false, message: '', onConfirm: null });
  };

  // ========== FUNZIONI TOAST NOTIFICATIONS ==========
  const showToast = (message, type = 'info', duration = 3000) => {
    const id = Date.now();
    const toast = { id, message, type };
    
    setToasts(prev => [...prev, toast]);
    
    setTimeout(() => {
      setToasts(prev => prev.map(t => t.id === id ? { ...t, exiting: true } : t));
      setTimeout(() => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, 300);
    }, duration);
  };
  
  const showLoadingWithProgress = (message, duration = 0) => {
    setLoadingMessage(message);
    setLoadingProgress(0);
    setShowLoading(true);
    
    if (duration > 0) {
      const steps = 100;
      const interval = duration / steps;
      let current = 0;
      
      const progressInterval = setInterval(() => {
        current += 1;
        setLoadingProgress(current);
        
        if (current >= 100) {
          clearInterval(progressInterval);
          setTimeout(() => setShowLoading(false), 500);
        }
      }, interval);
    }
  };
  
  const hideLoading = () => {
    setShowLoading(false);
    setLoadingProgress(0);
  };
  
  // ========== FUNZIONI GESTIONE INFORTUNI ==========
  const addInjury = (playerNum, injuryData) => {
    const newInjury = {
      id: Date.now(),
      playerNum,
      playerName: players.find(p => p.numero === playerNum)?.nome || '',
      type: injuryData.type,
      startDate: injuryData.startDate || new Date().toISOString().split('T')[0],
      estimatedReturn: injuryData.estimatedReturn,
      notes: injuryData.notes || '',
      status: 'active'
    };
    
    setInjuries(prev => [...prev, newInjury]);
    showToast(`ðŸ¤• Infortunio registrato per ${newInjury.playerName}`, 'warning');
  };
  
  const updateInjuryStatus = (injuryId, newStatus) => {
    setInjuries(prev => prev.map(inj => 
      inj.id === injuryId ? { ...inj, status: newStatus } : inj
    ));
    
    const injury = injuries.find(i => i.id === injuryId);
    if (injury) {
      const statusMessages = {
        'active': 'ðŸ¤• Infortunio attivo',
        'recovering': 'ðŸ“ˆ In recupero',
        'recovered': 'âœ… Recuperato'
      };
      showToast(`${statusMessages[newStatus]}: ${injury.playerName}`, 'success');
    }
  };
  
  const removeInjury = (injuryId) => {
    setInjuries(prev => prev.filter(inj => inj.id !== injuryId));
    showToast('Infortunio rimosso', 'info');
  };
  
  const getActiveInjuries = () => {
    return injuries.filter(inj => inj.status === 'active');
  };
  
  const getPlayerInjury = (playerNum) => {
    return injuries.find(inj => inj.playerNum === playerNum && inj.status === 'active');
  };
  
  // ========== FUNZIONI CALENDARIO ==========
  const getDaysInMonth = (month, year) => {
    return new Date(year, month + 1, 0).getDate();
  };
  
  const getFirstDayOfMonth = (month, year) => {
    return new Date(year, month, 1).getDay();
  };
  
  const getEventsForDate = (date) => {
    const dateStr = date.toISOString().split('T')[0];
    const dayTrainings = trainings.filter(t => t.data === dateStr);
    const dayMatches = matches.filter(m => m.data === dateStr);
    return { trainings: dayTrainings, matches: dayMatches };
  };
  
  // ========== FUNZIONI DRAG & DROP ==========
  const handleDragStart = (e, playerNum) => {
    setDraggedPlayer(playerNum);
    e.dataTransfer.effectAllowed = 'move';
  };
  
  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };
  
  const handleDrop = (e, position) => {
    e.preventDefault();
    if (draggedPlayer !== null) {
      setFormationPositions(prev => ({
        ...prev,
        [position]: draggedPlayer
      }));
      setDraggedPlayer(null);
    }
  };
  
  const clearPosition = (position) => {
    setFormationPositions(prev => {
      const newPositions = { ...prev };
      delete newPositions[position];
      return newPositions;
    });
  };

  // Gestione logout
  const handleLogout = async () => {
    try {
      await auth.signOut();
    } catch (error) {
      console.error('Errore logout:', error);
    }
  };

  const quickAddGoal = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      showConfirm(`âš½ Confermi il GOL di ${player.nome} (#${playerNum})?`, () => {
        const newGol = { ...match.golFatti, [playerNum]: (parseInt(match.golFatti[playerNum] || 0) + 1).toString() };
        
        // Salva evento in timeline
        const timeline = match.timeline || [];
        const newEvent = {
          id: Date.now(),
          tipo: 'gol',
          playerNum: playerNum,
          playerNome: player.nome,
          timestamp: new Date().toISOString(),
          minuto: minuto  // STEP 3: Aggiungi minuto
        };
        
        // Update atomico - aggiorna tutto insieme
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, golFatti: newGol, timeline: [...timeline, newEvent] }
            : m
        ));
      });
    }
  };

  const quickAddAssist = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      showConfirm(`ðŸŽ¯ Confermi l'ASSIST di ${player.nome} (#${playerNum})?`, () => {
        const newAss = { ...match.assist, [playerNum]: (parseInt(match.assist[playerNum] || 0) + 1).toString() };
        
        // Salva evento in timeline
        const timeline = match.timeline || [];
        const newEvent = {
          id: Date.now(),
          tipo: 'assist',
          playerNum: playerNum,
          playerNome: player.nome,
          timestamp: new Date().toISOString(),
          minuto: minuto  // STEP 3: Aggiungi minuto
        };
        
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, assist: newAss, timeline: [...timeline, newEvent] }
            : m
        ));
      });
    }
  };

  const quickAddGoalConceded = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      showConfirm(`âš½ Confermi il GOL SUBITO da ${player.nome} (#${playerNum})?`, () => {
        const newGS = { ...match.golSubiti, [playerNum]: (parseInt(match.golSubiti[playerNum] || 0) + 1).toString() };
        
        // Salva evento in timeline
        const timeline = match.timeline || [];
        const newEvent = {
          id: Date.now(),
          tipo: 'golsubito',
          playerNum: playerNum,
          playerNome: player.nome,
          timestamp: new Date().toISOString(),
          minuto: minuto  // STEP 3: Aggiungi minuto
        };
        
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, golSubiti: newGS, timeline: [...timeline, newEvent] }
            : m
        ));
      });
    }
  };

  const quickAddYellowCard = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      setCardTypeDialog({
        show: true,
        cardType: 'yellow',
        playerNum: playerNum,
        matchId: matchId,
        playerName: player.nome,
        minuto: minuto  // STEP 3: Aggiungi minuto
      });
    }
  };

  const quickAddRedCard = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      setCardTypeDialog({
        show: true,
        cardType: 'red',
        playerNum: playerNum,
        matchId: matchId,
        playerName: player.nome,
        minuto: minuto  // STEP 3: Aggiungi minuto
      });
    }
  };
  
  const assignCard = (type) => {
    const { cardType, playerNum, matchId, playerName, minuto } = cardTypeDialog;
    const match = matches.find(m => m.id === matchId);
    
    if (!match) return;
    
    if (cardType === 'yellow') {
      const timeline = match.timeline || [];
      const newEvent = {
        id: Date.now(),
        tipo: 'giallo',
        sottotipo: type,
        playerNum: playerNum,
        playerNome: playerName,
        timestamp: new Date().toISOString(),
        minuto: minuto  // STEP 3: Aggiungi minuto
      };
      
      if (type === 'gioco') {
        const newGG = { ...match.gialli_gioco, [playerNum]: (parseInt(match.gialli_gioco[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, gialli_gioco: newGG, timeline: [...timeline, newEvent] }
            : m
        ));
      } else {
        const newGP = { ...match.gialli_protesta, [playerNum]: (parseInt(match.gialli_protesta[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, gialli_protesta: newGP, timeline: [...timeline, newEvent] }
            : m
        ));
      }
      
    } else if (cardType === 'red') {
      const timeline = match.timeline || [];
      const newEvent = {
        id: Date.now(),
        tipo: 'rosso',
        sottotipo: type,
        playerNum: playerNum,
        playerNome: playerName,
        timestamp: new Date().toISOString(),
        minuto: minuto  // STEP 3: Aggiungi minuto
      };
      
      if (type === 'gioco') {
        const newRG = { ...match.rossi_gioco, [playerNum]: (parseInt(match.rossi_gioco[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, rossi_gioco: newRG, timeline: [...timeline, newEvent] }
            : m
        ));
      } else {
        const newRP = { ...match.rossi_protesta, [playerNum]: (parseInt(match.rossi_protesta[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, rossi_protesta: newRP, timeline: [...timeline, newEvent] }
            : m
        ));
      }
    }
    
    setCardTypeDialog({ show: false, cardType: '', playerNum: 0, matchId: null, playerName: '', minuto: null });
  };

  const toggleTraining = (id) => {
    setExpandedTrainings(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const toggleMatch = (id) => {
    setExpandedMatches(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const getSortedTrainings = () => {
    return [...trainings].sort((a, b) => new Date(b.data) - new Date(a.data));
  };

  const getSortedMatches = () => {
    return [...matches].sort((a, b) => new Date(b.data) - new Date(a.data));
  };

  const updatePlayer = (numero, field, value) => {
    setPlayers(players.map(p => 
      p.numero === numero ? { ...p, [field]: value } : p
    ));
  };

  const clearPlayer = (numero) => {
    setPlayers(players.map(p => 
      p.numero === numero ? { ...p, nome: '', ruolo: '', dataNascita: '', telefono: '', foto: '', piede: '' } : p
    ));
  };

  const handleImageUpload = (numero, e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('âŒ Seleziona un file immagine valido (JPG, PNG, ecc.)');
      e.target.value = '';
      return;
    }

    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      alert(`âŒ File troppo grande (${(file.size / 1024 / 1024).toFixed(1)}MB). Max 5MB.`);
      e.target.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        const maxWidth = 400;
        const maxHeight = 400;
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width = (width * maxHeight) / height;
            height = maxHeight;
          }
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.92);
        
        const finalSize = resizedDataUrl.length;
        if (finalSize > 200 * 1024) {
          const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.85);
          if (compressedDataUrl.length > 200 * 1024) {
            alert('âŒ Impossibile ridurre l\'immagine. Prova con una foto piÃ¹ piccola.');
            e.target.value = '';
            return;
          }
          updatePlayer(numero, 'foto', compressedDataUrl);
        } else {
          updatePlayer(numero, 'foto', resizedDataUrl);
        }
        
        e.target.value = '';
      };
      img.onerror = () => {
        alert('âŒ Errore nel caricamento dell\'immagine.');
        e.target.value = '';
      };
      img.src = event.target.result;
    };
    reader.onerror = () => {
      alert('âŒ Errore nella lettura del file.');
      e.target.value = '';
    };
    reader.readAsDataURL(file);
  };

  const handleLogoUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('âŒ Per favore seleziona un file immagine valido (JPG, PNG, ecc.)');
      e.target.value = '';
      return;
    }

    const maxSize = 500 * 1024;
    if (file.size > maxSize) {
      alert(`âŒ Il file Ã¨ troppo grande (${(file.size / 1024).toFixed(0)}KB). Dimensione massima: 500KB.\n\nðŸ’¡ Prova a ridimensionare l'immagine prima di caricarla.`);
      e.target.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        const maxWidth = 200;
        const maxHeight = 200;
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width = (width * maxHeight) / height;
            height = maxHeight;
          }
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
        
        const finalSize = resizedDataUrl.length;
        if (finalSize > 100 * 1024) {
          alert('âŒ Impossibile ridurre sufficientemente l\'immagine. Prova con un\'immagine piÃ¹ piccola.');
          e.target.value = '';
          return;
        }

        setTeamLogo(resizedDataUrl);
        alert('âœ… Logo caricato con successo!');
      };
      img.onerror = () => {
        alert('âŒ Errore nel caricamento dell\'immagine. Prova con un altro file.');
        e.target.value = '';
      };
      img.src = event.target.result;
    };
    reader.onerror = () => {
      alert('âŒ Errore nella lettura del file.');
      e.target.value = '';
    };
    reader.readAsDataURL(file);
  };

  const removeLogo = () => {
    if (window.confirm('Sei sicuro di voler rimuovere il logo?')) {
      setTeamLogo('');
      alert('âœ… Logo rimosso!');
    }
  };

  const calculateAge = (dataNascita) => {
    if (!dataNascita) return '';
    const today = new Date();
    const birthDate = new Date(dataNascita);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    return age;
  };

  const addTraining = () => {
    const newTraining = {
      id: Date.now(),
      data: new Date().toISOString().split('T')[0],
      presenze: players.reduce((acc, p) => ({ ...acc, [p.numero]: true }), {}),
      infortuni: {}
    };
    setTrainings([...trainings, newTraining]);
  };

  const addMatch = () => {
    const newMatch = {
      id: Date.now(),
      data: new Date().toISOString().split('T')[0],
      squadraCasa: '',
      squadraTrasferta: '',
      risultato: '',
      convocati: {},
      titolari: {},
      entrati: {},
      sostituzioni: {},
      minutiGiocati: {},
      golFatti: {},
      assist: {},
      golSubiti: {},
      gialli_gioco: {},
      gialli_protesta: {},
      rossi_gioco: {},
      rossi_protesta: {},
      ordineDistinta: {},
      mvp: null // Numero del giocatore MVP
    };
    setMatches([...matches, newMatch]);
  };

  const updateTraining = (trainingId, field, value) => {
    setTrainings(trainings.map(t => 
      t.id === trainingId ? { ...t, [field]: value } : t
    ));
  };

  const updateMatch = (matchId, field, value) => {
    setMatches(matches.map(m => 
      m.id === matchId ? { ...m, [field]: value } : m
    ));
  };

  const deleteTraining = (id) => {
    setTrainings(trainings.filter(t => t.id !== id));
  };

  const deleteMatch = (id) => {
    setMatches(matches.filter(m => m.id !== id));
  };

  // ========== FUNZIONI SISTEMA MVP ==========
  
  /**
   * Apre il modal per votare l'MVP di una partita
   */
  const openMVPVoting = (matchId) => {
    const match = matches.find(m => m.id === matchId);
    if (!match) return;
    
    // Verifica che ci siano convocati
    const convocatiCount = Object.values(match.convocati || {}).filter(Boolean).length;
    if (convocatiCount === 0) {
      showToast('âš ï¸ Nessun giocatore convocato per questa partita', 'warning');
      return;
    }
    
    setSelectedMatchForMVP(matchId);
    setShowMVPModal(true);
  };
  
  /**
   * Assegna l'MVP a un giocatore per una partita
   */
  const assignMVP = (matchId, playerNum) => {
    const match = matches.find(m => m.id === matchId);
    if (!match) return;
    
    const player = players.find(p => p.numero === playerNum);
    if (!player || !player.nome) {
      showToast('âŒ Giocatore non valido', 'error');
      return;
    }
    
    // Verifica che il giocatore fosse convocato
    if (!match.convocati[playerNum]) {
      showToast('âš ï¸ Il giocatore non era convocato per questa partita', 'warning');
      return;
    }
    
    // Aggiorna il match con l'MVP
    setMatches(matches.map(m => 
      m.id === matchId ? { ...m, mvp: playerNum } : m
    ));
    
    showToast(`ðŸ† ${player.nome} nominato Man of the Match!`, 'success');
    setShowMVPModal(false);
    setSelectedMatchForMVP(null);
  };
  
  /**
   * Rimuove l'MVP da una partita
   */
  const removeMVP = (matchId) => {
    setMatches(matches.map(m => 
      m.id === matchId ? { ...m, mvp: null } : m
    ));
    showToast('ðŸ”„ MVP rimosso', 'info');
  };
  
  /**
   * Ottiene la classifica MVP della stagione
   */
  const getMVPLeaderboard = () => {
    const mvpCount = {};
    
    // Conta quante volte ogni giocatore Ã¨ stato MVP
    matches.forEach(match => {
      if (match.mvp && match.risultato) { // Solo partite con risultato
        mvpCount[match.mvp] = (mvpCount[match.mvp] || 0) + 1;
      }
    });
    
    // Converti in array e ordina
    return Object.entries(mvpCount)
      .map(([playerNum, count]) => {
        const player = players.find(p => p.numero === parseInt(playerNum));
        return {
          playerNum: parseInt(playerNum),
          playerName: player?.nome || 'Sconosciuto',
          playerPhoto: player?.foto || '',
          mvpCount: count
        };
      })
      .sort((a, b) => b.mvpCount - a.mvpCount);
  };
  
  /**
   * Ottiene il numero di MVP per un giocatore specifico
   */
  const getPlayerMVPCount = (playerNum) => {
    return matches.filter(m => m.mvp === playerNum && m.risultato).length;
  };

  const exportToJSON = () => {
    const data = {
      players,
      trainings,
      matches,
      appTitle,
      teamLogo,
      exportDate: new Date().toISOString()
    };
    const jsonString = JSON.stringify(data, null, 2);
    
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `real-dor-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    alert('âœ… File JSON scaricato con successo! Conservalo come backup di sicurezza.');
  };

  const handleFileImport = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        
        if (!data.players || !data.trainings || !data.matches) {
          alert('âŒ File JSON non valido! Assicurati di aver selezionato il file corretto.');
          return;
        }
        
        setPlayers(data.players);
        setTrainings(data.trainings);
        setMatches(data.matches);
        if (data.appTitle) setAppTitle(data.appTitle);
        if (data.teamLogo) setTeamLogo(data.teamLogo);
        
        alert('âœ… Dati importati con successo!');
        event.target.value = '';
      } catch (error) {
        alert('âŒ Errore nel caricamento del file! Verifica che sia un file JSON valido.');
        event.target.value = '';
      }
    };
    reader.onerror = () => {
      alert('âŒ Errore nella lettura del file. Riprova.');
      event.target.value = '';
    };
    reader.readAsText(file);
  };

  const handleManualImport = () => {
    try {
      const data = JSON.parse(manualImportData);
      
      if (!data.players || !data.trainings || !data.matches) {
        alert('âŒ File JSON non valido! Assicurati di aver copiato tutto il contenuto correttamente.');
        return;
      }
      
      setPlayers(data.players);
      setTrainings(data.trainings);
      setMatches(data.matches);
      if (data.appTitle) setAppTitle(data.appTitle);
      if (data.teamLogo) setTeamLogo(data.teamLogo);
      
      setShowManualImport(false);
      setManualImportData('');
      alert('âœ… Dati importati con successo!');
    } catch (error) {
      alert('âŒ Errore nel parsing del JSON! Verifica che il formato sia corretto.');
    }
  };

  // ========== FUNZIONI DI RESET DATABASE ==========
  
  const resetStagione = async () => {
    const conferma1 = window.confirm('âš ï¸ ATTENZIONE! Questa operazione cancellerÃ :\n\nâœ“ Tutti gli allenamenti\nâœ“ Tutte le partite\nâœ“ Tutte le statistiche\n\nâœ… MA manterrÃ :\nâœ“ La rosa giocatori\nâœ“ Il logo della squadra\n\nVuoi continuare?');
    
    if (!conferma1) return;
    
    const conferma2 = window.confirm('ðŸ”´ ULTIMA CONFERMA!\n\nSei sicuro di voler resettare la stagione?\nQuesta azione NON puÃ² essere annullata!');
    
    if (!conferma2) return;
    
    try {
      // Cancello solo allenamenti e partite
      setTrainings([]);
      setMatches([]);
      setExpandedTrainings({});
      setModuloTattico({});
      setModuloAvversarioState({});
      setAnalisiSelezionata({});
      setConvocati(new Set());
      
      // Salvo i dati resettati
      await saveToIndexedDB('trainings', []);
      await saveToIndexedDB('matches', []);
      
      alert('âœ… Stagione resettata con successo!\n\nLa rosa giocatori Ã¨ stata mantenuta.');
    } catch (error) {
      console.error('Errore durante il reset:', error);
      alert('âŒ Errore durante il reset. Riprova.');
    }
  };
  
  const resetCompleto = async () => {
    const conferma1 = window.confirm('ðŸ”´ ATTENZIONE! RESET COMPLETO!\n\nQuesta operazione cancellerÃ  TUTTO:\n\nâœ“ Tutti i giocatori\nâœ“ Tutti gli allenamenti\nâœ“ Tutte le partite\nâœ“ Tutte le statistiche\nâœ“ Il logo della squadra\nâœ“ Tutti i dati dell\'app\n\nVuoi continuare?');
    
    if (!conferma1) return;
    
    const conferma2 = window.confirm('ðŸ”´ðŸ”´ ULTIMA CONFERMA! ðŸ”´ðŸ”´\n\nSei ASSOLUTAMENTE SICURO?\nQuesta azione NON puÃ² essere annullata!\n\nTUTTO verrÃ  cancellato!');
    
    if (!conferma2) return;
    
    const conferma3 = window.confirm('Scrivi OK per confermare il reset completo\n\n(Annulla per tornare indietro)');
    
    if (!conferma3) return;
    
    try {
      // Cancello tutto
      setPlayers([]);
      setTrainings([]);
      setMatches([]);
      setTeamLogo(null);
      setInfortunati(new Set());
      setExpandedTrainings({});
      setModuloTattico({});
      setModuloAvversarioState({});
      setAnalisiSelezionata({});
      setConvocati(new Set());
      
      // Cancello dal database
      const db = await initDB();
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      await store.clear();
      
      alert('âœ… Database resettato completamente!\n\nL\'applicazione Ã¨ ora come nuova.');
      
      // Ricarico la pagina per stato pulito
      window.location.reload();
    } catch (error) {
      console.error('Errore durante il reset completo:', error);
      alert('âŒ Errore durante il reset completo. Riprova.');
    }
  };

  // ============================================
  // FUNZIONI DI SINCRONIZZAZIONE CLOUD
  // ============================================
  
  /**
   * Sincronizza i dati LOCALI â†’ CLOUD (Upload)
   */
  const syncToFirestore = async () => {
    if (!user) {
      setSyncError('Devi essere autenticato per sincronizzare');
      return false;
    }

    try {
      setSyncStatus('syncing');
      setSyncError('');

      const dataToSync = {
        players,
        trainings,
        matches,
        appTitle,
        teamLogo,
        injuries,
        lastSynced: new Date().toISOString(),
        userId: user.uid
      };

      // Salva su Firestore
      await db.collection('teamData').doc(user.uid).set(dataToSync, { merge: true });
      
      setLastSynced(new Date());
      setSyncStatus('success');
      
      // Reset stato dopo 3 secondi
      setTimeout(() => setSyncStatus('idle'), 3000);
      
      return true;
    } catch (error) {
      console.error('Errore sincronizzazione su cloud:', error);
      setSyncError('Errore durante la sincronizzazione: ' + error.message);
      setSyncStatus('error');
      return false;
    }
  };

  /**
   * Carica i dati CLOUD â†’ LOCALE (Download)
   */
  const syncFromFirestore = async (forceOverwrite = false) => {
    if (!user) {
      setSyncError('Devi essere autenticato per sincronizzare');
      return false;
    }

    try {
      setSyncStatus('syncing');
      setSyncError('');

      const docRef = db.collection('teamData').doc(user.uid);
      const doc = await docRef.get();

      if (!doc.exists) {
        setSyncError('Nessun dato trovato nel cloud. Effettua prima un upload.');
        setSyncStatus('error');
        return false;
    }

      const cloudData = doc.data();
      
      // Verifica conflitti se non Ã¨ un overwrite forzato
      if (!forceOverwrite) {
        const hasLocalData = players.some(p => p.nome) || trainings.length > 0 || matches.length > 0;
        
        if (hasLocalData) {
          // Controlla se i dati locali sono piÃ¹ recenti
          const localLastSaved = lastSaved ? new Date(lastSaved) : new Date(0);
          const cloudLastSynced = cloudData.lastSynced ? new Date(cloudData.lastSynced) : new Date(0);
          
          if (localLastSaved > cloudLastSynced) {
            // Dati locali piÃ¹ recenti - mostra dialogo conflitto
            setSyncConflicts({
              local: { players, trainings, matches, lastSaved: localLastSaved },
              cloud: { 
                players: cloudData.players, 
                trainings: cloudData.trainings, 
                matches: cloudData.matches, 
                lastSynced: cloudLastSynced 
              }
            });
            setShowConflictModal(true);
            setSyncStatus('idle');
            return false;
          }
        }
      }

      // Carica i dati dal cloud
      if (cloudData.players) setPlayers(cloudData.players);
      if (cloudData.trainings) setTrainings(cloudData.trainings);
      if (cloudData.matches) setMatches(cloudData.matches);
      if (cloudData.appTitle) setAppTitle(cloudData.appTitle);
      if (cloudData.teamLogo) setTeamLogo(cloudData.teamLogo);
      if (cloudData.injuries) setInjuries(cloudData.injuries);
      
      setLastSynced(new Date(cloudData.lastSynced));
      setSyncStatus('success');
      
      // Salva anche in locale
      const dataToSave = {
        players: cloudData.players,
        trainings: cloudData.trainings,
        matches: cloudData.matches,
        appTitle: cloudData.appTitle,
        teamLogo: cloudData.teamLogo,
        injuries: cloudData.injuries || [],
        lastSaved: new Date().toISOString()
      };
      await saveToIndexedDB('squadraRealDOR', dataToSave);
      
      // Reset stato dopo 3 secondi
      setTimeout(() => setSyncStatus('idle'), 3000);
      
      return true;
    } catch (error) {
      console.error('Errore caricamento da cloud:', error);
      setSyncError('Errore durante il caricamento: ' + error.message);
      setSyncStatus('error');
      return false;
    }
  };

  /**
   * Sincronizzazione bidirezionale intelligente
   */
  const smartSync = async () => {
    if (!user) {
      setSyncError('Devi essere autenticato per sincronizzare');
      return false;
    }

    try {
      setSyncStatus('syncing');
      setSyncError('');

      // Recupera dati dal cloud
      const docRef = db.collection('teamData').doc(user.uid);
      const doc = await docRef.get();

      if (!doc.exists) {
        // Nessun dato nel cloud, fai upload
        return await syncToFirestore();
      }

      const cloudData = doc.data();
      const cloudLastSynced = cloudData.lastSynced ? new Date(cloudData.lastSynced) : new Date(0);
      const localLastSaved = lastSaved ? new Date(lastSaved) : new Date(0);

      // Confronta timestamp
      if (localLastSaved > cloudLastSynced) {
        // Locale piÃ¹ recente â†’ Upload
        return await syncToFirestore();
      } else if (cloudLastSynced > localLastSaved) {
        // Cloud piÃ¹ recente â†’ Download
        return await syncFromFirestore(false);
      } else {
        // Stesso timestamp - giÃ  sincronizzato
        setSyncStatus('success');
        setLastSynced(new Date());
        setTimeout(() => setSyncStatus('idle'), 3000);
        return true;
      }
    } catch (error) {
      console.error('Errore smart sync:', error);
      setSyncError('Errore durante la sincronizzazione: ' + error.message);
      setSyncStatus('error');
      return false;
    }
  };

  /**
   * Risolvi conflitto - scegli quale versione mantenere
   */
  const resolveConflict = async (choice) => {
    if (choice === 'local') {
      // Mantieni locale e sovrascrivi cloud
      await syncToFirestore();
    } else if (choice === 'cloud') {
      // Mantieni cloud e sovrascrivi locale
      await syncFromFirestore(true);
    }
    
    setSyncConflicts(null);
    setShowConflictModal(false);
  };

  // ========== SINCRONIZZAZIONE AUTOMATICA ==========
  
  // Sync automatico ogni 5 minuti se abilitato
  useEffect(() => {
    if (!autoSyncEnabled || !user) return;
    
    const interval = setInterval(async () => {
      console.log('ðŸ”„ Sincronizzazione automatica...');
      await smartSync();
    }, 5 * 60 * 1000); // 5 minuti

    return () => clearInterval(interval);
  }, [autoSyncEnabled, user, players, trainings, matches, appTitle, teamLogo]);

  // Sync al login
  useEffect(() => {
    if (user && !authLoading) {
      console.log('ðŸ”„ Sincronizzazione iniziale al login...');
      setTimeout(() => smartSync(), 2000); // Aspetta 2 secondi dopo il login
    }
  }, [user, authLoading]);

  // ========== USE EFFECT PER GRAFICI DASHBOARD ==========
  useEffect(() => {
    if (activeTab === 'dashboard' && typeof Chart !== 'undefined') {
      // Aspetta che il DOM sia pronto
      setTimeout(() => {
        // Grafico Gol Fatti/Subiti
        const goalsCtx = document.getElementById('goalsChart');
        if (goalsCtx) {
          // Distruggi grafico esistente se c'Ã¨
          const existingChart = Chart.getChart(goalsCtx);
          if (existingChart) existingChart.destroy();
          
          const matchDates = matches.map(m => new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }));
          const golFatti = matches.map(m => Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0));
          const golSubiti = matches.map(m => Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0));
          
          new Chart(goalsCtx, {
            type: 'line',
            data: {
              labels: matchDates,
              datasets: [
                {
                  label: 'Gol Fatti',
                  data: golFatti,
                  borderColor: '#10b981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  tension: 0.4,
                  fill: true
                },
                {
                  label: 'Gol Subiti',
                  data: golSubiti,
                  borderColor: '#ef4444',
                  backgroundColor: 'rgba(239, 68, 68, 0.1)',
                  tension: 0.4,
                  fill: true
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { stepSize: 1 }
                }
              }
            }
          });
        }

        // Grafico Risultati (Vittorie/Pareggi/Sconfitte)
        const resultsCtx = document.getElementById('resultsChart');
        if (resultsCtx) {
          const existingChart = Chart.getChart(resultsCtx);
          if (existingChart) existingChart.destroy();
          
          let vittorie = 0, pareggi = 0, sconfitte = 0;
          matches.forEach(m => {
            if (!m.risultato || !m.risultato.includes('-')) return;
            const [golFatti, golSubiti] = m.risultato.split('-').map(g => parseInt(g) || 0);
            if (golFatti > golSubiti) vittorie++;
            else if (golFatti === golSubiti) pareggi++;
            else sconfitte++;
          });
          
          new Chart(resultsCtx, {
            type: 'doughnut',
            data: {
              labels: ['Vittorie', 'Pareggi', 'Sconfitte'],
              datasets: [{
                data: [vittorie, pareggi, sconfitte],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                }
              }
            }
          });
        }

        // Grafico Presenze Allenamenti
        const attendanceCtx = document.getElementById('attendanceChart');
        if (attendanceCtx) {
          const existingChart = Chart.getChart(attendanceCtx);
          if (existingChart) existingChart.destroy();
          
          const last10Trainings = trainings.slice(-10);
          const trainingDates = last10Trainings.map(t => new Date(t.data).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }));
          const presenze = last10Trainings.map(t => Object.values(t.presenze).filter(p => p).length);
          
          new Chart(attendanceCtx, {
            type: 'bar',
            data: {
              labels: trainingDates,
              datasets: [{
                label: 'Presenze',
                data: presenze,
                backgroundColor: '#3b82f6',
                borderRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { stepSize: 1 }
                }
              }
            }
          });
        }
      }, 100);
    }
  }, [activeTab, matches, trainings, players]);

  const toggleAutoSync = () => {
    setAutoSyncEnabled(!autoSyncEnabled);
    if (!autoSyncEnabled) {
      showToast('âœ… Sincronizzazione automatica ATTIVATA - Sync ogni 5 minuti', 'success');
    } else {
      showToast('â¸ï¸ Sincronizzazione automatica DISATTIVATA - Solo sync manuale', 'info');
    }
  };

  // ============================================
  // FINE FUNZIONI SINCRONIZZAZIONE
  // ============================================

  const calculateStats = () => {
    const stats = {};
    
    players.forEach(player => {
      if (!player.nome) return;
      
      stats[player.numero] = {
        nome: player.nome,
        ruolo: player.ruolo,
        dataCreazione: player.dataCreazione,
        allenamenti_presenze: 0,
        allenamenti_assenze: 0,
        infortuni: 0,
        partite_convocato: 0,
        partite_titolare: 0,
        minuti_totali: 0,
        gol: 0,
        assist: 0,
        gol_subiti: 0,
        gialli_gioco: 0,
        gialli_protesta: 0,
        rossi_gioco: 0,
        rossi_protesta: 0
      };
    });

    trainings.forEach(training => {
      Object.keys(training.presenze || {}).forEach(numero => {
        if (stats[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(training.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          if (training.presenze[numero] === true) {
            stats[numero].allenamenti_presenze++;
          } else if (training.presenze[numero] === false) {
            stats[numero].allenamenti_assenze++;
          }
        }
      });
      
      Object.keys(training.infortuni || {}).forEach(numero => {
        if (stats[numero] && training.infortuni[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(training.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].infortuni++;
        }
      });
    });

    matches.forEach(match => {
      Object.keys(match.convocati || {}).forEach(numero => {
        if (stats[numero] && match.convocati[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].partite_convocato++;
        }
      });
      
      Object.keys(match.titolari || {}).forEach(numero => {
        if (stats[numero] && match.titolari[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].partite_titolare++;
        }
      });
      
      Object.keys(match.sostituzioni || {}).forEach(numero => {
        if (stats[numero] && match.sostituzioni[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          if (!match.titolari[numero]) {
            stats[numero].partite_titolare++;
          }
        }
      });

      Object.keys(match.minutiGiocati || {}).forEach(numero => {
        if (stats[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].minuti_totali += parseInt(match.minutiGiocati[numero] || 0);
        }
      });

      ['golFatti', 'assist', 'golSubiti', 'gialli_gioco', 'gialli_protesta', 'rossi_gioco', 'rossi_protesta'].forEach(field => {
        const mappedField = field === 'golFatti' ? 'gol' : field === 'golSubiti' ? 'gol_subiti' : field;
        Object.keys(match[field] || {}).forEach(numero => {
          if (stats[numero]) {
            const playerDataCreazione = stats[numero].dataCreazione;
            if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
              return;
            }
            
            stats[numero][mappedField] += parseInt(match[field][numero] || 0);
          }
        });
      });
    });

    return Object.values(stats).filter(s => s.nome).sort((a, b) => a.nome.localeCompare(b.nome));
  };

  const getNumeroAlfabetico = (nomeGiocatore) => {
    const giocatoriOrdinati = players
      .filter(p => p.nome)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    
    const index = giocatoriOrdinati.findIndex(p => p.nome === nomeGiocatore);
    return index >= 0 ? index + 1 : null;
  };

  // ========== FUNZIONI PER DIVISIONE SQUADRE ==========
  
  const mappaRuolo = (ruolo) => {
    if (!ruolo) return 'Altri';
    const ruoloLower = ruolo.toLowerCase();
    
    // Portieri
    if (ruoloLower.includes('portiere') || ruoloLower === 'p') return 'Portieri';
    
    // Difensori
    if (ruoloLower.includes('difens') || 
        ruoloLower.includes('terzin') || 
        ruoloLower.includes('libero') ||
        ruoloLower.includes('centrale') && ruoloLower.includes('dif') ||
        ['dc', 'td', 'ts', 'lb'].includes(ruoloLower)) return 'Difensori';
    
    // Centrocampisti
    if (ruoloLower.includes('centroc') || 
        ruoloLower.includes('mediano') || 
        ruoloLower.includes('esterno') && !ruoloLower.includes('attacc') ||
        ruoloLower.includes('mezzala') ||
        ruoloLower.includes('regista') ||
        ['cc', 'md', 'ed', 'es', 'mc'].includes(ruoloLower)) return 'Centrocampisti';
    
    // Attaccanti
    if (ruoloLower.includes('attacc') || 
        ruoloLower.includes('punta') || 
        ruoloLower.includes('trequart') ||
        ruoloLower.includes('ala') ||
        ruoloLower.includes('seconda punta') ||
        ['pc', 'ad', 'as', 'tq'].includes(ruoloLower)) return 'Attaccanti';
    
    return 'Altri';
  };

  const teamColors = [
    { bg: 'bg-red-600', text: 'text-red-600', name: 'A' },
    { bg: 'bg-blue-600', text: 'text-blue-600', name: 'B' },
    { bg: 'bg-green-600', text: 'text-green-600', name: 'C' },
    { bg: 'bg-purple-600', text: 'text-purple-600', name: 'D' },
    { bg: 'bg-orange-600', text: 'text-orange-600', name: 'E' },
    { bg: 'bg-pink-600', text: 'text-pink-600', name: 'F' }
  ];

  const toggleInfortunato = (nome) => {
    const newInfortunati = new Set(infortunati);
    if (newInfortunati.has(nome)) {
      newInfortunati.delete(nome);
    } else {
      newInfortunati.add(nome);
    }
    setInfortunati(newInfortunati);
  };

  const organizzaGiocatori = () => {
    const ruoli = {
      'Portieri': [],
      'Difensori': [],
      'Centrocampisti': [],
      'Attaccanti': []
    };

    players.forEach(player => {
      if (player.nome && !infortunati.has(player.nome)) {
        const ruolo = mappaRuolo(player.ruolo);
        if (ruolo !== 'Altri' && !(ruolo === 'Portieri' && !includiPortieri)) {
          ruoli[ruolo].push(player);
        }
      }
    });

    return ruoli;
  };

  const dividiSquadre = useMemo(() => {
    const ruoli = organizzaGiocatori();
    
    const squadre = Array.from({ length: numSquadre }, () => ({
      'Portieri': [],
      'Difensori': [],
      'Centrocampisti': [],
      'Attaccanti': [],
      totale: 0
    }));

    const ruoliDaDistribuire = includiPortieri 
      ? ['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti']
      : ['Difensori', 'Centrocampisti', 'Attaccanti'];

    const totaleGiocatori = ruoliDaDistribuire.reduce(
      (sum, ruolo) => sum + ruoli[ruolo].length, 
      0
    );

    const basePerSquadra = Math.floor(totaleGiocatori / numSquadre);
    const squadreConExtra = totaleGiocatori % numSquadre;
    
    const targetPerSquadra = squadre.map((_, i) => 
      basePerSquadra + (i < squadreConExtra ? 1 : 0)
    );

    const distribuisciRuoloEquilibrato = (giocatori, nomeRuolo) => {
      if (giocatori.length === 0) return;
      
      const giocatoriMescolati = [...giocatori].sort(() => Math.random() - 0.5);
      
      giocatoriMescolati.forEach(giocatore => {
        const minRuolo = Math.min(...squadre.map(s => s[nomeRuolo].length));
        const squadreConMinRuolo = squadre
          .map((s, i) => ({ squadra: s, index: i }))
          .filter(({ squadra }) => squadra[nomeRuolo].length === minRuolo);
        
        let sceltaIndex = squadreConMinRuolo[0].index;
        let maxDistanza = targetPerSquadra[sceltaIndex] - squadre[sceltaIndex].totale;
        
        squadreConMinRuolo.forEach(({ index }) => {
          const distanza = targetPerSquadra[index] - squadre[index].totale;
          if (distanza > maxDistanza) {
            maxDistanza = distanza;
            sceltaIndex = index;
          }
        });
        
        squadre[sceltaIndex][nomeRuolo].push(giocatore);
        squadre[sceltaIndex].totale++;
      });
    };

    ruoliDaDistribuire.forEach(ruoloNome => {
      distribuisciRuoloEquilibrato(ruoli[ruoloNome], ruoloNome);
    });

    squadre.forEach(squadra => delete squadra.totale);

    return squadre;
  }, [numSquadre, includiPortieri, infortunati, regenerateKey, players]);

  const conteggioSquadre = useMemo(() => {
    return dividiSquadre.map(squadra => {
      const totale = Object.values(squadra).reduce((sum, giocatori) => sum + giocatori.length, 0);
      return {
        portieri: squadra.Portieri.length,
        difensori: squadra.Difensori.length,
        centrocampisti: squadra.Centrocampisti.length,
        attaccanti: squadra.Attaccanti.length,
        totale
      };
    });
  }, [dividiSquadre]);

  const giocatoriDisponibili = useMemo(() => {
    const ruoli = organizzaGiocatori();
    const ruoliDaContare = includiPortieri 
      ? ['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti']
      : ['Difensori', 'Centrocampisti', 'Attaccanti'];
    
    return ruoliDaContare.reduce((sum, ruolo) => sum + ruoli[ruolo].length, 0);
  }, [includiPortieri, infortunati, players]);

  const differenzaSquadre = useMemo(() => {
    if (conteggioSquadre.length === 0) return 0;
    const totali = conteggioSquadre.map(s => s.totale);
    return Math.max(...totali) - Math.min(...totali);
  }, [conteggioSquadre]);

  const rigeneraDivisione = () => {
    setShowDivisioneResults(true);
    setRegenerateKey(prev => prev + 1);
  };

  const downloadDivisionePDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('DIVISIONE SQUADRE EQUILIBRATE', 105, 20, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Real DOR Under 18', 105, 30, { align: 'center' });
    
    if (infortunati.size > 0) {
      doc.setFontSize(10);
      doc.setTextColor(150, 0, 0);
      doc.text(`Infortunati esclusi: ${infortunati.size}`, 105, 38, { align: 'center' });
      doc.setTextColor(0, 0, 0);
    }

    let yPosition = infortunati.size > 0 ? 48 : 45;

    dividiSquadre.forEach((squadra, index) => {
      if (index > 0 && yPosition > 200) {
        doc.addPage();
        yPosition = 20;
      }

      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      const totaleSquadra = conteggioSquadre[index].totale;
      doc.text(`SQUADRA ${teamColors[index].name} (${totaleSquadra} giocatori)`, 15, yPosition);
      yPosition += 6;
      
      doc.setFontSize(10);
      let dettagli = '';
      if (includiPortieri) dettagli += `P: ${conteggioSquadre[index].portieri} â€¢ `;
      dettagli += `D: ${conteggioSquadre[index].difensori} â€¢ `;
      dettagli += `C: ${conteggioSquadre[index].centrocampisti} â€¢ `;
      dettagli += `A: ${conteggioSquadre[index].attaccanti}`;
      doc.text(dettagli, 15, yPosition);
      yPosition += 8;

      const tableData = [];
      let numero = 1;

      ['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti'].forEach(ruolo => {
        squadra[ruolo].forEach(player => {
          tableData.push([
            numero++,
            player.nome,
            player.ruolo,
            player.dataNascita ? new Date(player.dataNascita).toLocaleDateString('it-IT') : 'N/A',
            player.piede || 'N/A'
          ]);
        });
      });

      doc.autoTable({
        startY: yPosition,
        head: [['N.', 'Nome', 'Ruolo', 'Data Nascita', 'Piede']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [100, 100, 100], fontSize: 9 },
        bodyStyles: { fontSize: 8 },
        columnStyles: {
          0: { cellWidth: 10 },
          1: { cellWidth: 50 },
          2: { cellWidth: 40 },
          3: { cellWidth: 30 },
          4: { cellWidth: 20 }
        },
        margin: { left: 15, right: 15 }
      });

      yPosition = doc.lastAutoTable.finalY + 15;
    });

    doc.save('divisione_squadre_equilibrate.pdf');
  };

  // ========== FUNZIONI PER CONVOCAZIONI ==========

  const toggleConvocato = (nome) => {
    const newConvocati = new Set(convocati);
    if (newConvocati.has(nome)) {
      newConvocati.delete(nome);
    } else {
      if (newConvocati.size >= 20) {
        alert('Puoi convocare massimo 20 giocatori!');
        return;
      }
      newConvocati.add(nome);
    }
    setConvocati(newConvocati);
  };

  const downloadConvocazioni = () => {
    if (convocati.size === 0) {
      alert('Seleziona almeno un giocatore da convocare!');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('CONVOCAZIONE', 105, 18, { align: 'center' });
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    doc.text('Real DOR Under 18', 105, 26, { align: 'center' });

    let yPos = 36;

    if (infoPartita.squadra1 && infoPartita.squadra2) {
      doc.setFontSize(15);
      doc.setFont(undefined, 'bold');
      doc.text(`${infoPartita.squadra1} VS ${infoPartita.squadra2}`, 105, yPos, { align: 'center' });
      yPos += 9;
    }

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    if (infoPartita.dataPartita) {
      const dataFormatted = new Date(infoPartita.dataPartita + 'T00:00:00').toLocaleDateString('it-IT', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      doc.text(`Data: ${dataFormatted}`, 105, yPos, { align: 'center' });
      yPos += 6;
    }

    if (infoPartita.oraRitrovo) {
      doc.text(`Ora ritrovo: ${infoPartita.oraRitrovo}`, 105, yPos, { align: 'center' });
      yPos += 6;
    }

    if (infoPartita.indirizzoCompo) {
      doc.setFontSize(9);
      doc.text(`Campo: ${infoPartita.indirizzoCompo}`, 105, yPos, { align: 'center' });
      yPos += 6;
    }

    yPos += 4;

    const giocatoriConvocati = players
      .filter(p => p.nome && convocati.has(p.nome))
      .sort((a, b) => a.nome.localeCompare(b.nome));

    doc.setFontSize(13);
    doc.setFont(undefined, 'bold');
    doc.text(`GIOCATORI CONVOCATI (${giocatoriConvocati.length})`, 105, yPos, { align: 'center' });
    yPos += 7;

    const tableData = giocatoriConvocati.map((player, idx) => [
      idx + 1,
      player.nome
    ]);

    doc.autoTable({
      startY: yPos,
      head: [['N.', 'Cognome e Nome']],
      body: tableData,
      theme: 'striped',
      headStyles: { 
        fillColor: [41, 128, 185],
        fontSize: 10,
        fontStyle: 'bold',
        halign: 'center',
        cellPadding: 2
      },
      bodyStyles: { 
        fontSize: 9,
        cellPadding: 2
      },
      columnStyles: {
        0: { cellWidth: 18, halign: 'center' },
        1: { cellWidth: 150 }
      },
      margin: { left: 20, right: 20 },
      alternateRowStyles: { fillColor: [245, 245, 245] }
    });

    const nomeFile = infoPartita.dataPartita 
      ? `convocazione_${infoPartita.dataPartita}.pdf`
      : `convocazione_${new Date().toISOString().split('T')[0]}.pdf`;
    
    doc.save(nomeFile);
  };

  // ========== FUNZIONE STAMPA LISTA PRESENZE ==========
  
  const stampaListaPresenze = () => {
    if (players.length === 0) {
      alert('Nessun giocatore nella rosa!');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 10;

    // Aggiungo logo se presente (molto piccolo)
    if (teamLogo) {
      try {
        doc.addImage(teamLogo, 'PNG', 15, 8, 12, 12);
      } catch (e) {
        console.log('Errore caricamento logo:', e);
      }
    }

    // Titolo compatto in linea con il logo
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('âš½ Real D.O.R. - Lista Presenze', teamLogo ? 30 : 15, 15);
    
    yPos = 23;

    // Data e note in una riga
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text('Data: ______________', 15, yPos);
    doc.text('Note: _________________________________________________', 70, yPos);
    
    yPos += 6;

    // Ordino giocatori alfabeticamente
    const giocatoriOrdinati = [...players]
      .filter(p => p.nome)
      .sort((a, b) => a.nome.localeCompare(b.nome));

    // Preparo dati per la tabella
    const tableData = giocatoriOrdinati.map((player, idx) => [
      idx + 1,
      player.nome,
      player.ruolo || '',
      '', // Colonna Presente
      ''  // Colonna Assente
    ]);

    doc.autoTable({
      startY: yPos,
      head: [['N.', 'Cognome e Nome', 'Ruolo', 'P', 'A']],
      body: tableData,
      theme: 'grid',
      headStyles: { 
        fillColor: [34, 139, 34],
        fontSize: 9,
        fontStyle: 'bold',
        halign: 'center',
        cellPadding: 2
      },
      bodyStyles: { 
        fontSize: 8,
        cellPadding: 1.5,
        minCellHeight: 7
      },
      columnStyles: {
        0: { cellWidth: 10, halign: 'center' },
        1: { cellWidth: 85 },
        2: { cellWidth: 45 },
        3: { cellWidth: 12, halign: 'center', fillColor: [240, 255, 240] },
        4: { cellWidth: 12, halign: 'center', fillColor: [255, 240, 240] }
      },
      margin: { left: 15, right: 15, bottom: 20 },
      didDrawCell: (data) => {
        // Aggiungo checkbox nelle colonne P e A
        if (data.column.index === 3 || data.column.index === 4) {
          if (data.row.index >= 0) {
            const size = 5;
            const x = data.cell.x + (data.cell.width - size) / 2;
            const y = data.cell.y + (data.cell.height - size) / 2;
            doc.setDrawColor(100);
            doc.rect(x, y, size, size);
          }
        }
      }
    });

    // Footer con legenda
    const finalY = doc.lastAutoTable.finalY;
    doc.setFontSize(7);
    doc.setFont(undefined, 'italic');
    doc.setTextColor(100, 100, 100);
    doc.text('P = Presente | A = Assente', 15, finalY + 5);
    doc.text(`Tot: ${giocatoriOrdinati.length}`, 105, finalY + 5, { align: 'center' });
    doc.text(`${new Date().toLocaleDateString('it-IT')}`, 195, finalY + 5, { align: 'right' });

    doc.save(`lista_presenze_${new Date().toISOString().split('T')[0]}.pdf`);
  };

  // ========== NUOVE FUNZIONI ESPORTAZIONE AVANZATE ==========
  
  // Export Report Stagionale Completo
  const downloadSeasonReportPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    
    // Header
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.text('ðŸ“Š REPORT STAGIONALE COMPLETO', 105, yPos, { align: 'center' });
    yPos += 10;
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'normal');
    doc.text(appTitle, 105, yPos, { align: 'center' });
    yPos += 5;
    
    doc.setFontSize(10);
    doc.text(`Generato il: ${new Date().toLocaleDateString('it-IT')}`, 105, yPos, { align: 'center' });
    yPos += 15;
    
    // Statistiche Generali
    const totalMatches = matches.length;
    const totalTrainings = trainings.length;
    const activePlayers = players.filter(p => p.nome).length;
    
    const victories = matches.filter(m => {
      const our = parseInt(m.golFatti ? Object.values(m.golFatti).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0) : 0);
      const their = Object.values(m.golSubiti || {}).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
      return our > their;
    }).length;
    
    const draws = matches.filter(m => {
      const our = parseInt(m.golFatti ? Object.values(m.golFatti).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0) : 0);
      const their = Object.values(m.golSubiti || {}).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
      return our === their;
    }).length;
    
    const defeats = totalMatches - victories - draws;
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('STATISTICHE GENERALI', 15, yPos);
    yPos += 8;
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    doc.text(`â€¢ Giocatori in rosa: ${activePlayers}`, 20, yPos);
    yPos += 6;
    doc.text(`â€¢ Partite giocate: ${totalMatches} (V: ${victories}, P: ${draws}, S: ${defeats})`, 20, yPos);
    yPos += 6;
    doc.text(`â€¢ Allenamenti svolti: ${totalTrainings}`, 20, yPos);
    yPos += 12;
    
    // Top 5 Marcatori
    const goalScorers = {};
    matches.forEach(match => {
      if (match.golFatti) {
        Object.entries(match.golFatti).forEach(([num, gol]) => {
          const goals = parseInt(gol || 0);
          if (goals > 0) {
            goalScorers[num] = (goalScorers[num] || 0) + goals;
          }
        });
      }
    });
    
    const topScorers = Object.entries(goalScorers)
      .map(([num, gol]) => {
        const player = players.find(p => p.numero === parseInt(num));
        return { nome: player?.nome || `#${num}`, gol };
      })
      .sort((a, b) => b.gol - a.gol)
      .slice(0, 5);
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('ðŸ† TOP 5 MARCATORI', 15, yPos);
    yPos += 8;
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    topScorers.forEach((scorer, i) => {
      doc.text(`${i + 1}. ${scorer.nome}: ${scorer.gol} gol`, 20, yPos);
      yPos += 6;
    });
    yPos += 8;
    
    // Top 5 Assist
    const assistProviders = {};
    matches.forEach(match => {
      if (match.assist) {
        Object.entries(match.assist).forEach(([num, assists]) => {
          const count = parseInt(assists || 0);
          if (count > 0) {
            assistProviders[num] = (assistProviders[num] || 0) + count;
          }
        });
      }
    });
    
    const topAssisters = Object.entries(assistProviders)
      .map(([num, assists]) => {
        const player = players.find(p => p.numero === parseInt(num));
        return { nome: player?.nome || `#${num}`, assists };
      })
      .sort((a, b) => b.assists - a.assists)
      .slice(0, 5);
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('ðŸ‘Ÿ TOP 5 ASSIST', 15, yPos);
    yPos += 8;
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    topAssisters.forEach((assister, i) => {
      doc.text(`${i + 1}. ${assister.nome}: ${assister.assists} assist`, 20, yPos);
      yPos += 6;
    });
    
    // Nuova pagina per lista completa giocatori
    doc.addPage();
    yPos = 20;
    
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('ROSA COMPLETA', 105, yPos, { align: 'center' });
    yPos += 12;
    
    const playersData = players
      .filter(p => p.nome)
      .map(p => {
        const goals = goalScorers[p.numero] || 0;
        const assists = assistProviders[p.numero] || 0;
        return [
          p.numero,
          p.nome,
          p.ruolo,
          goals,
          assists
        ];
      });
    
    doc.autoTable({
      startY: yPos,
      head: [['#', 'Nome', 'Ruolo', 'Gol', 'Assist']],
      body: playersData,
      theme: 'grid',
      headStyles: { fillColor: [26, 86, 219], fontSize: 10, fontStyle: 'bold' },
      bodyStyles: { fontSize: 9 },
      columnStyles: {
        0: { cellWidth: 15, halign: 'center' },
        1: { cellWidth: 70 },
        2: { cellWidth: 55 },
        3: { cellWidth: 20, halign: 'center' },
        4: { cellWidth: 20, halign: 'center' }
      }
    });
    
    doc.save(`report_stagionale_${new Date().toISOString().split('T')[0]}.pdf`);
  };
  
  // Export Scheda Singolo Giocatore - REPORT COMPLETO
  const downloadPlayerCardPDF = (playerNum) => {
    const player = players.find(p => p.numero === playerNum);
    if (!player || !player.nome) {
      alert('Giocatore non valido!');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 15;
    
    // ========== HEADER CON FOTO ==========
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('âš½ REPORT GIOCATORE', 105, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(100, 100, 100);
    doc.text(appTitle, 105, yPos, { align: 'center' });
    yPos += 10;
    
    // Box header con foto
    doc.setDrawColor(0, 51, 153);
    doc.setLineWidth(0.5);
    doc.rect(15, yPos, 180, 45);
    
    // Foto se presente
    if (player.foto) {
      try {
        doc.addImage(player.foto, 'JPEG', 20, yPos + 5, 35, 35);
      } catch (e) {
        console.log('Errore caricamento foto');
      }
    } else {
      doc.setFillColor(240, 240, 240);
      doc.rect(20, yPos + 5, 35, 35, 'F');
      doc.setFontSize(24);
      doc.setTextColor(150, 150, 150);
      doc.text(`#${player.numero}`, 37.5, yPos + 27, { align: 'center' });
    }
    
    // Dati anagrafici a destra della foto
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text(player.nome, 60, yPos + 12);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Ruolo: ${player.ruolo || 'N/A'}`, 60, yPos + 20);
    doc.text(`Numero Maglia: ${getNumeroAlfabetico(player.nome)}`, 60, yPos + 26);
    
    if (player.dataNascita) {
      const age = calculateAge(player.dataNascita);
      doc.text(`EtÃ : ${age} anni (${player.dataNascita})`, 60, yPos + 32);
    }
    if (player.piede) {
      doc.text(`Piede: ${player.piede}`, 60, yPos + 38);
    }
    
    yPos += 50;
    
    // ========== STATISTICHE ALLENAMENTI ==========
    const playerTrainings = trainings.filter(t => {
      if (!player.dataCreazione) return true;
      return new Date(t.data) >= new Date(player.dataCreazione);
    });
    
    const presenzeCount = playerTrainings.filter(t => t.presenze && t.presenze[player.numero]).length;
    const assenzeCount = playerTrainings.filter(t => t.presenze && !t.presenze[player.numero]).length;
    const totAllenamenti = presenzeCount + assenzeCount;
    const percPresenze = totAllenamenti > 0 ? ((presenzeCount / totAllenamenti) * 100).toFixed(1) : 0;
    
    const infortuniCount = trainings.filter(t => t.infortuni && t.infortuni[player.numero]).length;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('ðŸ‹ï¸ STATISTICHE ALLENAMENTI', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`â€¢ Presenze: ${presenzeCount}/${totAllenamenti}`, 20, yPos);
    doc.text(`â€¢ % Presenze: ${percPresenze}%`, 110, yPos);
    yPos += 6;
    doc.text(`â€¢ Assenze: ${assenzeCount}`, 20, yPos);
    doc.text(`â€¢ Infortuni: ${infortuniCount}`, 110, yPos);
    yPos += 10;
    
    // ========== STATISTICHE PARTITE ==========
    const playerMatches = matches.filter(m => {
      if (!player.dataCreazione) return true;
      return new Date(m.data) >= new Date(player.dataCreazione);
    });
    
    const convocato = playerMatches.filter(m => m.convocati && m.convocati[player.numero]).length;
    const titolare = playerMatches.filter(m => m.titolari && m.titolari[player.numero]).length;
    const percConvocazioni = playerMatches.length > 0 ? ((convocato / playerMatches.length) * 100).toFixed(1) : 0;
    const percTitolarita = playerMatches.length > 0 ? ((titolare / playerMatches.length) * 100).toFixed(1) : 0;
    
    let totalGoals = 0;
    let totalAssists = 0;
    let totalGolSubiti = 0;
    let gialliGioco = 0;
    let gialliProtesta = 0;
    let rossiGioco = 0;
    let rossiProtesta = 0;
    let totalMinutes = 0;
    
    playerMatches.forEach(match => {
      totalGoals += parseInt(match.golFatti?.[player.numero] || 0);
      totalAssists += parseInt(match.assist?.[player.numero] || 0);
      totalGolSubiti += parseInt(match.golSubiti?.[player.numero] || 0);
      gialliGioco += parseInt(match.gialliGioco?.[player.numero] || 0);
      gialliProtesta += parseInt(match.gialliProtesta?.[player.numero] || 0);
      rossiGioco += parseInt(match.rossiGioco?.[player.numero] || 0);
      rossiProtesta += parseInt(match.rossiProtesta?.[player.numero] || 0);
      totalMinutes += parseInt(match.minutiGiocati?.[player.numero] || 0);
    });
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('âš½ STATISTICHE PARTITE', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`â€¢ Convocato: ${convocato}/${playerMatches.length}`, 20, yPos);
    doc.text(`â€¢ % Convocazioni: ${percConvocazioni}%`, 110, yPos);
    yPos += 6;
    doc.text(`â€¢ Titolare: ${titolare}/${playerMatches.length}`, 20, yPos);
    doc.text(`â€¢ % TitolaritÃ : ${percTitolarita}%`, 110, yPos);
    yPos += 6;
    doc.text(`â€¢ Minuti giocati: ${totalMinutes}'`, 20, yPos);
    yPos += 10;
    
    // ========== STATISTICHE GIOCO ==========
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('ðŸ“Š STATISTICHE GIOCO', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`â€¢ Gol: ${totalGoals}`, 20, yPos);
    doc.text(`â€¢ Assist: ${totalAssists}`, 110, yPos);
    yPos += 6;
    if (totalGolSubiti > 0) {
      doc.text(`â€¢ Gol Subiti: ${totalGolSubiti}`, 20, yPos);
      yPos += 6;
    }
    
    // Cartellini
    if (gialliGioco + gialliProtesta + rossiGioco + rossiProtesta > 0) {
      doc.text(`â€¢ ðŸŸ¨ Giallo Gioco: ${gialliGioco}`, 20, yPos);
      doc.text(`â€¢ ðŸŸ¨ Giallo Protesta: ${gialliProtesta}`, 110, yPos);
      yPos += 6;
      doc.text(`â€¢ ðŸŸ¥ Rosso Gioco: ${rossiGioco}`, 20, yPos);
      doc.text(`â€¢ ðŸŸ¥ Rosso Protesta: ${rossiProtesta}`, 110, yPos);
      yPos += 6;
    }
    yPos += 5;
    
    // ========== LISTA PARTITE DETTAGLIATA ==========
    if (yPos > 200) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('ðŸ“‹ PARTITE GIOCATE', 15, yPos);
    yPos += 7;
    
    const matchesWithPlayer = playerMatches.filter(m => 
      (m.convocati && m.convocati[player.numero]) || 
      (m.titolari && m.titolari[player.numero]) ||
      (m.minutiGiocati && m.minutiGiocati[player.numero] > 0)
    ).sort((a, b) => new Date(b.data) - new Date(a.data));
    
    if (matchesWithPlayer.length > 0) {
      const tableData = matchesWithPlayer.slice(0, 15).map(m => {
        const data = new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
        const isTitolare = m.titolari && m.titolari[player.numero];
        const minuti = m.minutiGiocati?.[player.numero] || 0;
        const gol = m.golFatti?.[player.numero] || 0;
        const assist = m.assist?.[player.numero] || 0;
        const risultato = m.risultato || '-';
        
        return [
          data,
          m.avversario || 'N/A',
          risultato,
          isTitolare ? 'âœ“' : '-',
          minuti + "'",
          gol > 0 ? gol : '-',
          assist > 0 ? assist : '-'
        ];
      });
      
      doc.autoTable({
        startY: yPos,
        head: [['Data', 'Avversario', 'Ris.', 'Tit.', 'Min', 'G', 'A']],
        body: tableData,
        theme: 'grid',
        headStyles: { 
          fillColor: [0, 51, 153],
          fontSize: 8,
          fontStyle: 'bold',
          halign: 'center'
        },
        bodyStyles: { 
          fontSize: 7,
          cellPadding: 1.5
        },
        columnStyles: {
          0: { cellWidth: 18 },
          1: { cellWidth: 50 },
          2: { cellWidth: 18, halign: 'center' },
          3: { cellWidth: 12, halign: 'center' },
          4: { cellWidth: 15, halign: 'center' },
          5: { cellWidth: 10, halign: 'center' },
          6: { cellWidth: 10, halign: 'center' }
        },
        margin: { left: 15, right: 15 }
      });
      
      yPos = doc.lastAutoTable.finalY + 10;
      
      if (matchesWithPlayer.length > 15) {
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`(Mostrate le ultime 15 partite su ${matchesWithPlayer.length} totali)`, 15, yPos);
        yPos += 5;
      }
    } else {
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100);
      doc.setFont(undefined, 'italic');
      doc.text('Nessuna partita giocata', 20, yPos);
      yPos += 10;
    }
    
    // ========== MVP ==========
    const mvpCount = matches.filter(m => m.mvp === player.numero).length;
    if (mvpCount > 0) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(218, 165, 32);
      doc.text(`ðŸ† MVP: ${mvpCount} ${mvpCount === 1 ? 'volta' : 'volte'}`, 15, yPos);
      yPos += 8;
    }
    
    // ========== INFORTUNI ==========
    if (infortuniCount > 0) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(200, 0, 0);
      doc.text(`ðŸ¤• Infortuni: ${infortuniCount}`, 15, yPos);
      yPos += 8;
    }
    
    // ========== FOOTER ==========
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.setFont(undefined, 'italic');
    doc.text(`Report generato il ${new Date().toLocaleDateString('it-IT')} - ${appTitle}`, 105, 285, { align: 'center' });
    
    const fileName = `report_${player.nome.replace(/\s+/g, '_').toLowerCase()}.pdf`;
    doc.save(fileName);
    showToast(`ðŸ“„ Report PDF di ${player.nome} scaricato!`, 'success');
  };
  
  // Download Backup JSON
  const downloadBackupJSON = () => {
    const backupData = {
      version: '2.0',
      exportDate: new Date().toISOString(),
      appTitle,
      teamLogo,
      players,
      trainings,
      matches,
      infoPartita,
      moduloTattico
    };
    
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `backup_gestionale_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    alert('âœ… Backup completato! File salvato.');
  };

  // ========== FUNZIONI PER ANALISI TATTICA ==========

  const moduliDisponibili = [
    { nome: '4-4-2', descrizione: 'Classico equilibrato' },
    { nome: '4-3-3', descrizione: 'Offensivo con ali' },
    { nome: '3-5-2', descrizione: 'Dominio centrocampo' },
    { nome: '4-2-3-1', descrizione: 'Moderno e versatile' },
    { nome: '3-4-3', descrizione: 'Ultra offensivo' },
    { nome: '5-3-2', descrizione: 'Difensivo e compatto' },
    { nome: '4-1-4-1', descrizione: 'Pressing alto' },
    { nome: '4-3-1-2', descrizione: 'Centrocampo folto' }
  ];

  const getPosizioniModulo = (modulo) => {
    const posizioni = {
      '4-4-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 20, y: 50, ruolo: 'E' }, { x: 40, y: 50, ruolo: 'CC' }, { x: 60, y: 50, ruolo: 'CC' }, { x: 80, y: 50, ruolo: 'E' },
        { x: 40, y: 25, ruolo: 'A' }, { x: 60, y: 25, ruolo: 'A' }
      ],
      '4-3-3': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 35, y: 55, ruolo: 'MC' }, { x: 50, y: 50, ruolo: 'CC' }, { x: 65, y: 55, ruolo: 'MC' },
        { x: 20, y: 25, ruolo: 'AD' }, { x: 50, y: 20, ruolo: 'PC' }, { x: 80, y: 25, ruolo: 'AS' }
      ],
      '3-5-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 30, y: 75, ruolo: 'DC' }, { x: 50, y: 75, ruolo: 'DC' }, { x: 70, y: 75, ruolo: 'DC' },
        { x: 15, y: 55, ruolo: 'E' }, { x: 35, y: 52, ruolo: 'MC' }, { x: 50, y: 50, ruolo: 'CC' }, { x: 65, y: 52, ruolo: 'MC' }, { x: 85, y: 55, ruolo: 'E' },
        { x: 40, y: 25, ruolo: 'A' }, { x: 60, y: 25, ruolo: 'A' }
      ],
      '4-2-3-1': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 40, y: 60, ruolo: 'MD' }, { x: 60, y: 60, ruolo: 'MD' },
        { x: 20, y: 38, ruolo: 'AE' }, { x: 50, y: 35, ruolo: 'TQ' }, { x: 80, y: 38, ruolo: 'AD' },
        { x: 50, y: 18, ruolo: 'PC' }
      ],
      '3-4-3': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 30, y: 75, ruolo: 'DC' }, { x: 50, y: 75, ruolo: 'DC' }, { x: 70, y: 75, ruolo: 'DC' },
        { x: 20, y: 55, ruolo: 'E' }, { x: 40, y: 52, ruolo: 'CC' }, { x: 60, y: 52, ruolo: 'CC' }, { x: 80, y: 55, ruolo: 'E' },
        { x: 20, y: 25, ruolo: 'AD' }, { x: 50, y: 20, ruolo: 'PC' }, { x: 80, y: 25, ruolo: 'AS' }
      ],
      '5-3-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 15, y: 75, ruolo: 'TD' }, { x: 32, y: 75, ruolo: 'DC' }, { x: 50, y: 75, ruolo: 'DC' }, { x: 68, y: 75, ruolo: 'DC' }, { x: 85, y: 75, ruolo: 'TS' },
        { x: 35, y: 52, ruolo: 'MC' }, { x: 50, y: 50, ruolo: 'CC' }, { x: 65, y: 52, ruolo: 'MC' },
        { x: 40, y: 25, ruolo: 'A' }, { x: 60, y: 25, ruolo: 'A' }
      ],
      '4-1-4-1': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 50, y: 62, ruolo: 'MD' },
        { x: 20, y: 48, ruolo: 'E' }, { x: 40, y: 45, ruolo: 'CC' }, { x: 60, y: 45, ruolo: 'CC' }, { x: 80, y: 48, ruolo: 'E' },
        { x: 50, y: 20, ruolo: 'PC' }
      ],
      '4-3-1-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 35, y: 55, ruolo: 'MC' }, { x: 50, y: 52, ruolo: 'CC' }, { x: 65, y: 55, ruolo: 'MC' },
        { x: 50, y: 35, ruolo: 'TQ' },
        { x: 40, y: 20, ruolo: 'A' }, { x: 60, y: 20, ruolo: 'A' }
      ]
    };
    return posizioni[modulo] || [];
  };

  const CampoTattico = ({ moduloNostro, moduloAvversario, evidenziaContrasto }) => {
    const posizioniNostre = getPosizioniModulo(moduloNostro);
    const posizioniAvversarie = getPosizioniModulo(moduloAvversario).map(pos => ({
      ...pos,
      y: 100 - pos.y
    }));

    const calcolaDistanza = (x1, y1, x2, y2) => {
      return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    };

    const sovrapposizioni = [];
    const giocatoriGiaUsati = new Set();
    
    posizioniNostre.forEach((posNostra, idxNostra) => {
      posizioniAvversarie.forEach((posAvversaria, idxAvversaria) => {
        const distanza = calcolaDistanza(posNostra.x, posNostra.y, posAvversaria.x, posAvversaria.y);
        const sogliaSovrapposizione = 2.5;
        
        if (distanza < sogliaSovrapposizione) {
          const keyNostra = `nost-${idxNostra}`;
          const keyAvversaria = `avv-${idxAvversaria}`;
          
          if (!giocatoriGiaUsati.has(keyNostra) && !giocatoriGiaUsati.has(keyAvversaria)) {
            sovrapposizioni.push({
              x: (posNostra.x + posAvversaria.x) / 2,
              y: (posNostra.y + posAvversaria.y) / 2,
              ruoloNostro: posNostra.ruolo,
              ruoloAvversario: posAvversaria.ruolo,
              indexNostra: idxNostra,
              indexAvversaria: idxAvversaria
            });
            giocatoriGiaUsati.add(keyNostra);
            giocatoriGiaUsati.add(keyAvversaria);
          }
        }
      });
    });

    const posizioniNostreFiltrate = posizioniNostre.filter((_, idx) => !giocatoriGiaUsati.has(`nost-${idx}`));
    const posizioniAvversarieFiltrate = posizioniAvversarie.filter((_, idx) => !giocatoriGiaUsati.has(`avv-${idx}`));

    return (
      <div className="bg-green-700 rounded-lg p-4 shadow-xl">
        <svg viewBox="0 0 100 100" className="w-full h-auto" style={{ maxHeight: '600px' }}>
          <rect width="100" height="100" fill="#2d7a3e" />
          
          <line x1="0" y1="50" x2="100" y2="50" stroke="white" strokeWidth="0.3" opacity="0.8" />
          <circle cx="50" cy="50" r="8" fill="none" stroke="white" strokeWidth="0.3" opacity="0.8" />
          <circle cx="50" cy="50" r="0.8" fill="white" opacity="0.8" />
          
          <rect x="30" y="0" width="40" height="15" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <rect x="42" y="0" width="16" height="8" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <circle cx="50" cy="10" r="0.6" fill="white" opacity="0.6" />
          
          <rect x="30" y="85" width="40" height="15" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <rect x="42" y="92" width="16" height="8" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <circle cx="50" cy="90" r="0.6" fill="white" opacity="0.6" />
          
          <rect x="0.5" y="0.5" width="99" height="99" fill="none" stroke="white" strokeWidth="0.5" opacity="0.8" />

          <text x="50" y="48" textAnchor="middle" fill="white" fontSize="3" opacity="0.5" fontWeight="bold">
            AVVERSARI
          </text>
          <text x="50" y="52" textAnchor="middle" fill="white" fontSize="3" opacity="0.5" fontWeight="bold">
            NOSTRA SQUADRA
          </text>

          <defs>
            <clipPath id="leftHalf">
              <rect x="-2.5" y="-2.5" width="2.5" height="5" />
            </clipPath>
            <clipPath id="rightHalf">
              <rect x="0" y="-2.5" width="2.5" height="5" />
            </clipPath>
          </defs>

          {posizioniAvversarieFiltrate.map((pos, idx) => (
            <g key={`avv-solo-${idx}`}>
              <circle 
                cx={pos.x} 
                cy={pos.y} 
                r="2.5" 
                fill="#ef4444" 
                stroke="white" 
                strokeWidth="0.3"
                opacity="0.9"
              />
              <text 
                x={pos.x} 
                y={pos.y + 0.8} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.8" 
                fontWeight="bold"
              >
                {pos.ruolo}
              </text>
            </g>
          ))}

          {posizioniNostreFiltrate.map((pos, idx) => (
            <g key={`nost-solo-${idx}`}>
              <circle 
                cx={pos.x} 
                cy={pos.y} 
                r="2.5" 
                fill="#3b82f6" 
                stroke="white" 
                strokeWidth="0.3"
                opacity="0.9"
              />
              <text 
                x={pos.x} 
                y={pos.y + 0.8} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.8" 
                fontWeight="bold"
              >
                {pos.ruolo}
              </text>
            </g>
          ))}

          {sovrapposizioni.map((sovr, idx) => (
            <g key={`sovr-${idx}`}>
              <g clipPath="url(#leftHalf)" transform={`translate(${sovr.x}, ${sovr.y})`}>
                <circle 
                  cx="0" 
                  cy="0" 
                  r="2.5" 
                  fill="#ef4444" 
                  opacity="0.95"
                />
              </g>
              
              <g clipPath="url(#rightHalf)" transform={`translate(${sovr.x}, ${sovr.y})`}>
                <circle 
                  cx="0" 
                  cy="0" 
                  r="2.5" 
                  fill="#3b82f6" 
                  opacity="0.95"
                />
              </g>
              
              <circle 
                cx={sovr.x} 
                cy={sovr.y} 
                r="2.5" 
                fill="none" 
                stroke="white" 
                strokeWidth="0.4"
              />
              
              <line 
                x1={sovr.x} 
                y1={sovr.y - 2.5} 
                x2={sovr.x} 
                y2={sovr.y + 2.5} 
                stroke="white" 
                strokeWidth="0.3"
              />
              
              <text 
                x={sovr.x} 
                y={sovr.y - 0.3} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.3" 
                fontWeight="bold"
              >
                {sovr.ruoloAvversario}
              </text>
              <text 
                x={sovr.x} 
                y={sovr.y + 1.3} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.3" 
                fontWeight="bold"
              >
                {sovr.ruoloNostro}
              </text>
            </g>
          ))}

          {evidenziaContrasto && (
            <>
              <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#fbbf24" />
                </marker>
              </defs>
            </>
          )}
        </svg>

        <div className="mt-4 flex flex-col gap-2">
          <div className="flex justify-center gap-6 text-white text-sm">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full bg-red-500 border-2 border-white"></div>
              <span className="font-semibold">Avversari ({moduloAvversario})</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full bg-blue-500 border-2 border-white"></div>
              <span className="font-semibold">Nostra Squadra ({moduloNostro})</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full border-2 border-white" style={{background: 'linear-gradient(90deg, #ef4444 50%, #3b82f6 50%)'}}>
              </div>
              <span className="font-semibold">Zona Contesa</span>
            </div>
          </div>
          {sovrapposizioni.length > 0 && (
            <div className="text-center text-white text-xs opacity-75">
              {sovrapposizioni.length} zone di contrasto diretto
            </div>
          )}
        </div>
      </div>
    );
  };

  const analizzaModuloAvversario = (modulo) => {
    const analisi = {
      '4-4-2': {
        puntiDeboli: [
          'Vulnerabile sulle fasce contro moduli a 3 punte',
          'Centrocampo puÃ² essere sopraffatto numericamente',
          'Spazi tra linee sfruttabili con trequartista'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Le tre punte sovraccaricano i due centrali avversari',
            vantaggi: ['SuperioritÃ  numerica in attacco', 'Ampiezza sulle fasce', 'Pressing sui mediani'],
            tattiche: ['Attaccare gli spazi tra terzino e centrale', 'Ali larghe per allargare la difesa', 'Centravanti mobile tra i due centrali'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Velocita esplosiva per puntare 1 contro 1', 'Dribbling superiore per saltare avversario', 'Capacita di cross preciso dal fondo', 'Resistenza per coprire tutta la fascia', 'Tecnica individuale eccellente'],
                importanza: 'FONDAMENTALE - Devono dominare i duelli con i terzini avversari'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Mobilita per muoversi tra i due centrali', 'Capacita di proteggere palla', 'Finalizzazione precisa', 'Senso della posizione', 'Fisicita per tenere i palloni'],
                importanza: 'ESSENZIALE - Deve occupare entrambi i centrali avversari'
              },
              {
                ruolo: 'REGISTA (Centrocampista Centrale)',
                caratteristiche: ['Visione di gioco superiore', 'Passaggio lungo preciso', 'Intelligenza tattica', 'Capacita di dettare i tempi', 'Buona tecnica di base'],
                importanza: 'CRITICO - Deve orchestrare il gioco e servire le punte'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Il trequartista trova spazio tra le linee avversarie',
            vantaggi: ['Trequartista libero tra centrocampo e difesa', 'SuperioritÃ  numerica a centrocampo', 'Transizioni veloci'],
            tattiche: ['Trequartista negli spazi tra linee', 'Esterni ad attaccare i terzini', 'Doppio mediano per controllare il gioco'],
            ruoliChiave: [
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita e imprevedibilita', 'Ottima visione di gioco', 'Tecnica sopraffina', 'Capacita di giocare tra le linee', 'Dribbling stretto e controllo di palla'],
                importanza: 'FONDAMENTALE - Fulcro del gioco tra centrocampo e attacco'
              },
              {
                ruolo: 'MEDIANI (Coppia)',
                caratteristiche: ['Intelligenza tattica elevata', 'Capacita di interdizione', 'Passaggio verticale preciso', 'Copertura reciproca', 'Lettura delle situazioni'],
                importanza: 'ESSENZIALE - Devono dominare centrocampo ed equilibrare'
              },
              {
                ruolo: 'ESTERNI OFFENSIVI',
                caratteristiche: ['Velocita nelle ripartenze', 'Capacita di attaccare la profondita', 'Dribbling efficace', 'Cross precisi', 'Rientri difensivi disciplinati'],
                importanza: 'IMPORTANTE - Creano ampiezza e attaccano gli spazi'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 85,
            motivo: 'SuperioritÃ  numerica a centrocampo (5 vs 4)',
            vantaggi: ['Dominio del centrocampo', 'Quinti che sovraccaricano le fasce', 'SoliditÃ  difensiva'],
            tattiche: ['Dominare il centrocampo numericamente', 'Quinti a creare superioritÃ  sulle fasce', 'Pressing sui mediani avversari'],
            ruoliChiave: [
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Resistenza straordinaria', 'Velocita per coprire 70+ metri', 'Capacita offensive e difensive bilanciate', 'Cross preciso', 'Intelligenza posizionale'],
                importanza: 'FONDAMENTALE - Devono dominare le fasce per 90 minuti'
              },
              {
                ruolo: 'REGISTA CENTRALE',
                caratteristiche: ['Visione di gioco panoramica', 'Passaggio lungo e corto di qualita', 'Posizionamento impeccabile', 'Capacita di verticalizzare', 'Calma sotto pressione'],
                importanza: 'ESSENZIALE - Deve orchestrare il gioco a centrocampo'
              },
              {
                ruolo: 'CENTRALE LIBERO',
                caratteristiche: ['Lettura del gioco eccellente', 'Capacita di impostare', 'Passaggio lungo preciso', 'Leadership difensiva', 'Posizionamento anticipatorio'],
                importanza: 'CRITICO - Deve dirigere la difesa a 3'
              }
            ]
          }
        ]
      },
      '4-3-3': {
        puntiDeboli: [
          'Terzini esposti in fase difensiva',
          'Due mediani centrali possono essere in inferioritÃ ',
          'Spazi centrali tra i centrocampisti'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-1-2',
            efficacia: 95,
            motivo: 'SuperioritÃ  numerica in mezzo al campo',
            vantaggi: ['3 centrocampisti vs 2 mediani avversari', 'Trequartista a disturbare il regista', 'SoliditÃ  centrale'],
            tattiche: ['Chiudere il centro del campo', 'Pressare i due mediani', 'Sfruttare gli spazi tra le linee'],
            ruoliChiave: [
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['SuperioritÃ  numerica sui due mediani', 'Capacita di chiudere gli spazi centrali', 'Pressione coordinata', 'Controllo del possesso', 'Mobilita per coprire il campo'],
                importanza: 'FONDAMENTALE - Devono soffocare i due mediani avversari'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Pressing sul regista avversario', 'Capacita di intercettare passaggi', 'Creativita negli spazi', 'Inserimenti negli spazi', 'Visione di gioco'],
                importanza: 'ESSENZIALE - Deve disturbare la costruzione e creare gioco'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti coordinati', 'Pressing sui difensori', 'Capacita di finalizzare contropiede', 'Gioco di sponda', 'Sfruttamento spazi tra le linee'],
                importanza: 'IMPORTANTE - Devono sfruttare la superioritÃ  a centrocampo'
              }
            ]
          },
          {
            modulo: '4-4-2',
            efficacia: 85,
            motivo: 'Equilibrio e compattezza difensiva',
            vantaggi: ['Quattro difensori contro tre attaccanti', 'Esterni bassi contro le ali', 'Compattezza difensiva'],
            tattiche: ['Esterni che rientrano sulle ali avversarie', 'Blocco basso compatto', 'Ripartenze in verticale'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Disciplina nel rientro difensivo', 'Marcatura stretta sulle ali', 'Capacita di duello 1vs1', 'Resistenza per doppia fase', 'Velocita nelle ripartenze'],
                importanza: 'FONDAMENTALE - Devono neutralizzare le ali avversarie'
              },
              {
                ruolo: 'DIFENSORI CENTRALI (Coppia)',
                caratteristiche: ['Compattezza e coperture reciproche', 'Marcatura sul centravanti', 'Anticipazione sui movimenti', 'Fisicita nei duelli', 'Comunicazione costante'],
                importanza: 'ESSENZIALE - Devono tenere il blocco compatto e basso'
              },
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Coppia)',
                caratteristiche: ['Copertura degli spazi centrali', 'Capacita di recupero palla', 'Passaggio verticale preciso', 'Disciplina posizionale', 'Supporto alle ripartenze'],
                importanza: 'CRITICO - Devono proteggere la difesa e innescare contropiede'
              }
            ]
          },
          {
            modulo: '5-3-2',
            efficacia: 80,
            motivo: 'Difesa a 5 per neutralizzare le tre punte',
            vantaggi: ['ParitÃ  numerica in difesa', 'Braccetti sui esterni avversari', 'SoliditÃ  difensiva'],
            tattiche: ['Difesa a 5 per coprire il fronte offensivo', 'Braccetti sulle ali avversarie', 'Ripartenze rapide'],
            ruoliChiave: [
              {
                ruolo: 'BRACCETTI (Difensori Laterali)',
                caratteristiche: ['Marcatura stretta sulle ali', 'Velocita per seguire gli attaccanti esterni', 'Capacita di duello 1vs1', 'Aggressivita nei contrasti', 'Copertura sulla fascia'],
                importanza: 'FONDAMENTALE - Devono annullare le ali avversarie'
              },
              {
                ruolo: 'CENTRALE LIBERO',
                caratteristiche: ['Lettura del gioco anticipatoria', 'Coperture sul centravanti', 'Leadership difensiva', 'Capacita di impostazione', 'Posizionamento impeccabile'],
                importanza: 'ESSENZIALE - Deve coordinare la linea a 5 e coprire il centro'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Capacita di tenere palla', 'Pressing coordinato', 'Finalizzazione nelle ripartenze', 'Movimenti per creare spazi', 'Resistenza fisica'],
                importanza: 'IMPORTANTE - Devono sfruttare le ripartenze rapide'
              }
            ]
          }
        ]
      },
      '3-5-2': {
        puntiDeboli: [
          'Tre difensori vulnerabili contro attacchi sulle fasce',
          'Quinti devono coprire molta fascia',
          'Spazi tra braccetti e centrale'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Ali larghe per attaccare i tre difensori centrali',
            vantaggi: ['SuperioritÃ  numerica in attacco (3 vs 3)', 'Ali larghe sfruttano gli spazi', 'Terzini per sovraccaricare le fasce'],
            tattiche: ['Ali molto larghe per allargare la difesa', 'Attaccare gli spazi laterali', 'Terzini alti per sovraccaricare i quinti'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Ampiezza massima per allargare i tre difensori', 'Velocita per attaccare gli spazi larghi', 'Dribbling per superare i braccetti', 'Movimenti dentro-fuori', 'Cross e finalizzazione'],
                importanza: 'FONDAMENTALE - Devono sfruttare l\'ampiezza e creare spazi'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni costanti sulle fasce', 'Capacita di creare 2vs1 contro i quinti', 'Cross dal fondo', 'Spinta offensiva continua', 'Sincronizzazione con le ali'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce e stancare i quinti'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Movimenti tra i tre difensori', 'Capacita di occupare il centrale', 'Finalizzazione precisa', 'Gioco aereo efficace', 'Attacco della profondita'],
                importanza: 'CRITICO - Deve impegnare i tre difensori centrali'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Esterni e terzini per attaccare le fasce',
            vantaggi: ['Quattro attaccanti sugli esterni', 'Centrocampo equilibrato', 'Ampiezza massima'],
            tattiche: ['Esterni larghi contro i braccetti', 'Terzini offensivi per sovraccarico', 'Attaccare gli spazi laterali'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Posizionamento largo contro i braccetti', 'Velocita per puntare 1vs1', 'Dribbling per superare l\'avversario', 'Capacita di tagliare dentro', 'Cross e finalizzazione'],
                importanza: 'FONDAMENTALE - Devono attaccare i braccetti e creare ampiezza'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni sincronizzate', 'Capacita di creare 2vs1 sui quinti', 'Cross dal fondo', 'Resistenza per spinta continua', 'Ampiezza offensiva massima'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con gli esterni'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita negli spazi centrali', 'Capacita di servire gli esterni', 'Visione per cambi di lato rapidi', 'Dribbling tra le linee', 'Inserimenti coordinati'],
                importanza: 'CRITICO - Deve orchestrare gli attacchi sulle fasce'
              }
            ]
          },
          {
            modulo: '3-4-3',
            efficacia: 85,
            motivo: 'Attacco speculare con maggiore offensivitÃ ',
            vantaggi: ['ParitÃ  difensiva ma piÃ¹ punte', 'Ali contro quinti', 'Pressing alto efficace'],
            tattiche: ['Pressing alto sui tre difensori', 'Ali contro quinti affaticati', 'Attacco costante sulle fasce'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Pressing aggressivo sui quinti', 'Velocita per sfruttare stanchezza avversaria', 'Dribbling per saltare l\'uomo', 'Ampiezza massima sulle fasce', 'Finalizzazione da posizione laterale'],
                importanza: 'FONDAMENTALE - Devono sfinire e superare i quinti avversari'
              },
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Supporto alle ali', 'Sovrapposizioni coordinate', 'Capacita di creare superioritÃ ', 'Cross e assistenza', 'Resistenza per doppia fase'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con le ali'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Pressing sul centrale libero', 'Movimenti per occupare i tre difensori', 'Capacita di finalizzazione', 'Gioco aereo efficace', 'Coordinazione con le ali'],
                importanza: 'CRITICO - Deve pressare e impegnare la difesa a tre'
              }
            ]
          }
        ]
      },
      '4-2-3-1': {
        puntiDeboli: [
          'Centrocampo puÃ² essere sovraccaricato',
          'Due mediani soli contro centrocampi numerosi',
          'Punta isolata se trequartista non sostiene'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 90,
            motivo: 'Tre centrocampisti vs due mediani avversari',
            vantaggi: ['SuperioritÃ  numerica in mezzo', 'Dominio del centrocampo', 'Triangolazioni centrali'],
            tattiche: ['Pressare i due mediani', 'Dominare il centrocampo centrale', 'Giro palla rapido per aprire spazi'],
            ruoliChiave: [
              {
                ruolo: 'REGISTA (Centrocampista Centrale)',
                caratteristiche: ['Visione di gioco superiore', 'Passaggio preciso sotto pressione', 'Capacita di dettare i tempi', 'Intelligenza posizionale', 'Tecnica di base eccellente'],
                importanza: 'FONDAMENTALE - Deve dominare il duello con i due mediani'
              },
              {
                ruolo: 'MEZZALI (Centrocampisti Interni)',
                caratteristiche: ['Inserimenti coordinati negli spazi', 'Capacita di pressione sui mediani', 'Dinamismo e resistenza', 'Passaggio verticale preciso', 'Senso tattico elevato'],
                importanza: 'ESSENZIALE - Devono creare superioritÃ  numerica costante'
              },
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Velocita per attaccare gli spazi', 'Dribbling per saltare i terzini', 'Capacita di tagliare dentro al campo', 'Finalizzazione precisa', 'Movimenti coordinati'],
                importanza: 'CRITICO - Devono sfruttare gli spazi creati dal centrocampo'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 85,
            motivo: 'Cinque centrocampisti dominano la zona centrale',
            vantaggi: ['SuperioritÃ  numerica totale a centrocampo', 'Quinti vs terzini', 'Controllo del gioco'],
            tattiche: ['Dominare il centrocampo', 'Pressione sui portatori di palla', 'Quinti per creare superioritÃ '],
            ruoliChiave: [
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Resistenza eccezionale per 90 minuti', 'Velocita nelle transizioni', 'Capacita offensive e difensive', 'Cross precisi', 'Disciplina tattica'],
                importanza: 'FONDAMENTALE - Devono sovraccarica re le fasce contro i terzini'
              },
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Trio)',
                caratteristiche: ['Dominio fisico e tecnico', 'Capacita di recupero palla', 'Passaggio verticale di qualita', 'Mobilita per coprire spazi', 'Intelligenza tattica superiore'],
                importanza: 'ESSENZIALE - Devono soffocare i due mediani avversari'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Mobilita per attaccare la profondita', 'Capacita di legare il gioco', 'Finalizzazione efficace', 'Movimenti coordinati', 'Pressing sui difensori'],
                importanza: 'IMPORTANTE - Devono sfruttare il dominio a centrocampo'
              }
            ]
          },
          {
            modulo: '4-1-4-1',
            efficacia: 80,
            motivo: 'Pressing ultra-aggressivo sul trequartista',
            vantaggi: ['Mediano sul trequartista avversario', 'Pressing alto coordinato', 'Recupero palla alto'],
            tattiche: ['Mediano che marca il trequartista', 'Pressing aggressivo sulla costruzione', 'Corto muso per recupero alto'],
            ruoliChiave: [
              {
                ruolo: 'MEDIANO (Davanti alla difesa)',
                caratteristiche: ['Marcatura asfissiante sul trequartista', 'Lettura preventiva dei passaggi', 'Aggressivita nel contrasto', 'Disciplina posizionale ferrea', 'Capacita di interdizione totale'],
                importanza: 'FONDAMENTALE - Deve annullare il trequartista avversario'
              },
              {
                ruolo: 'CENTROCAMPISTI (Quartetto)',
                caratteristiche: ['Pressing coordinato e aggressivo', 'Chiusura degli spazi centrali', 'Capacita di scaglionamento', 'Resistenza fisica elevata', 'Rapidita nelle transizioni'],
                importanza: 'ESSENZIALE - Devono recuperare palla nella meta campo avversaria'
              },
              {
                ruolo: 'PUNTA CENTRALE',
                caratteristiche: ['Pressing sui difensori centrali', 'Capacita di tenere palla', 'Finalizzazione nelle ripartenze', 'Intelligenza nei movimenti', 'Resistenza al gioco spalle alla porta'],
                importanza: 'IMPORTANTE - Deve essere il primo difensore e sfruttare le ripartenze'
              }
            ]
          }
        ]
      },
      '3-4-3': {
        puntiDeboli: [
          'Difesa esposta contro attacchi veloci',
          'Centrocampo in inferioritÃ  numerica',
          'Esterni devono correre molto'
        ],
        moduliConsigliati: [
          {
            modulo: '4-4-2',
            efficacia: 90,
            motivo: 'Quattro difensori contro tre punte, equilibrio totale',
            vantaggi: ['SoliditÃ  difensiva', 'Equilibrio in tutti i reparti', 'Blocco compatto'],
            tattiche: ['Difesa solida contro le tre punte', 'Esterni che rientrano', 'Ripartenze verticali veloci'],
            ruoliChiave: [
              {
                ruolo: 'DIFENSORI CENTRALI (Coppia)',
                caratteristiche: ['Marcatura stretta sul centravanti', 'Coperture reciproche perfette', 'Fisicita nei duelli aerei', 'Capacita di anticipazione', 'Leadership difensiva'],
                importanza: 'FONDAMENTALE - Devono neutralizzare la punta centrale avversaria'
              },
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Disciplina nel rientrare sulle ali', 'Capacita di duello 1vs1', 'Resistenza per doppia fase', 'Velocita nelle ripartenze', 'Intelligenza posizionale'],
                importanza: 'ESSENZIALE - Devono chiudere le fasce contro le ali avversarie'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Velocita esplosiva nelle ripartenze', 'Capacita di tenere palla', 'Finalizzazione precisa', 'Movimenti coordinati', 'Pressing sui tre difensori'],
                importanza: 'CRITICO - Devono punire le ripartenze verticali'
              }
            ]
          },
          {
            modulo: '5-3-2',
            efficacia: 85,
            motivo: 'Difesa a 5 per contenere l\'attacco avversario',
            vantaggi: ['SuperioritÃ  numerica difensiva', 'Coperture costanti', 'SoliditÃ  estrema'],
            tattiche: ['Difesa a cinque per contenere', 'Braccetti sulle ali avversarie', 'Assorbire la pressione e ripartire'],
            ruoliChiave: [
              {
                ruolo: 'BRACCETTI (Difensori Laterali)',
                caratteristiche: ['Marcatura asfissiante sulle ali', 'Velocita per inseguire gli attaccanti', 'Capacita di duello aereo', 'Aggressivita nei contrasti', 'Copertura sulla fascia'],
                importanza: 'FONDAMENTALE - Devono annullare le ali avversarie'
              },
              {
                ruolo: 'CENTRALE LIBERO',
                caratteristiche: ['Lettura anticipatoria del gioco', 'Coperture preventive', 'Capacita di impostazione', 'Leadership difensiva assoluta', 'Posizionamento impeccabile'],
                importanza: 'ESSENZIALE - Deve coordinare la linea a 5 e coprire'
              },
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Capacita di assorbire pressione', 'Qualita nel passaggio verticale', 'Resistenza fisica elevata', 'Intelligenza nelle ripartenze', 'Controllo del tempo di gioco'],
                importanza: 'CRITICO - Devono gestire le transizioni difesa-attacco'
              }
            ]
          },
          {
            modulo: '4-3-1-2',
            efficacia: 80,
            motivo: 'SuperioritÃ  numerica a centrocampo',
            vantaggi: ['Dominio del centrocampo', 'Controllo del possesso', 'Trequartista libero'],
            tattiche: ['Controllare il centrocampo', 'Possesso palla per stancare l\'avversario', 'Pressing coordinato'],
            ruoliChiave: [
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Controllo totale del possesso palla', 'Passaggio corto preciso', 'Mobilita per coprire il campo', 'Capacita di recupero', 'Intelligenza nel giro palla'],
                importanza: 'FONDAMENTALE - Devono dominare il centrocampo e stancare l\'avversario'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita tra le linee', 'Visione di gioco superiore', 'Tecnica individuale eccellente', 'Capacita di verticalizzare', 'Dribbling in spazi stretti'],
                importanza: 'ESSENZIALE - Deve essere la chiave per sbloccare la difesa'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti coordinati', 'Capacita di attaccare la profondita', 'Finalizzazione precisa', 'Pressing sui tre difensori', 'Gioco spalle alla porta'],
                importanza: 'IMPORTANTE - Devono sfruttare gli spazi creati dal possesso'
              }
            ]
          }
        ]
      },
      '5-3-2': {
        puntiDeboli: [
          'Rinuncia all\'ampiezza offensiva',
          'Solo due attaccanti, scarso peso offensivo',
          'Centrocampo puÃ² essere sopraffatto'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Attacco sulle fasce e superioritÃ  in mezzo',
            vantaggi: ['Ali contro braccetti difensivi', 'SuperioritÃ  a centrocampo', 'Possesso palla prolungato'],
            tattiche: ['Allargare il gioco sulle fasce', 'Dominare il centrocampo', 'Possesso per far uscire l\'avversario'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Velocita per attaccare gli spazi larghi', 'Dribbling per superare i braccetti', 'Capacita di cross dal fondo', 'Movimenti dentro-fuori', 'Finalizzazione da posizione defilata'],
                importanza: 'FONDAMENTALE - Devono sfruttare l\'ampiezza e attaccare i braccetti'
              },
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Controllo del possesso palla', 'Passaggio preciso per allargare', 'Mobilita per coprire il campo', 'Capacita di verticalizzazione', 'Intelligenza nel giro palla'],
                importanza: 'ESSENZIALE - Devono dominare il centrocampo e servire le ali'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Spinta costante sulla fascia', 'Sovrapposizioni coordinate', 'Cross precisi', 'Capacita di creare superioritÃ ', 'Resistenza per doppia fase'],
                importanza: 'CRITICO - Devono sovraccaricare le fasce con le ali'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Quattro attaccanti per scardinare il blocco difensivo',
            vantaggi: ['Attacco a cinque con terzini', 'SuperioritÃ  offensiva', 'Trequartista libero'],
            tattiche: ['Attaccare sulle fasce costantemente', 'Possesso prolungato', 'Terzini sempre alti'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Ampiezza massima sulle fasce', 'Dribbling per saltare i braccetti', 'Movimenti dentro-fuori coordinati', 'Cross precisi', 'Capacita di finalizzazione'],
                importanza: 'FONDAMENTALE - Devono allargare la difesa a 5 avversaria'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita negli spazi centrali', 'Capacita di combinazioni rapide', 'Visione di gioco superiore', 'Dribbling in spazi stretti', 'Inserimenti negli spazi'],
                importanza: 'ESSENZIALE - Deve trovare varchi nella difesa compatta'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni costanti', 'Resistenza per fase offensiva prolungata', 'Cross dal fondo', 'Capacita di creare superioritÃ ', 'Sincronia con gli esterni'],
                importanza: 'CRITICO - Devono sovraccaricare le fasce costantemente'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 80,
            motivo: 'Cinque centrocampisti per dominare il gioco',
            vantaggi: ['SuperioritÃ  a centrocampo', 'Controllo del possesso', 'Quinti offensivi'],
            tattiche: ['Dominare il centrocampo', 'Possesso palla lungo', 'Quinti che attaccano costantemente'],
            ruoliChiave: [
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Spinta offensiva continua', 'Resistenza per 90 minuti di fase attiva', 'Cross dal fondo', 'Capacita di creare superioritÃ  numerica', 'Dribbling sulla fascia'],
                importanza: 'FONDAMENTALE - Devono attaccare costantemente le fasce'
              },
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Trio)',
                caratteristiche: ['Controllo del possesso prolungato', 'Passaggio preciso per cambiare gioco', 'Pazienza nel giro palla', 'Capacita di verticalizzare al momento giusto', 'Mobilita per aprire linee di passaggio'],
                importanza: 'ESSENZIALE - Devono dominare il possesso e stancare l\'avversario'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti per attaccare la profondita', 'Capacita di finalizzare occasioni', 'Gioco di sponda', 'Inserimenti coordinati', 'Pressing sui difensori'],
                importanza: 'IMPORTANTE - Devono sfruttare gli spazi creati dal possesso'
              }
            ]
          }
        ]
      },
      '4-1-4-1': {
        puntiDeboli: [
          'Punta molto isolata',
          'Distanze tra i reparti se non coordinati',
          'Dipendenza dal mediano davanti alla difesa'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-1-2',
            efficacia: 90,
            motivo: 'Due punte contro difesa a quattro e trequartista sul mediano',
            vantaggi: ['SuperioritÃ  in attacco', 'Trequartista sul mediano avversario', 'Peso offensivo maggiore'],
            tattiche: ['Due punte per impegnare i centrali', 'Trequartista a pressare il mediano', 'Centrocampisti che inseriscono'],
            ruoliChiave: [
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti complementari tra loro', 'Capacita di attaccare i due centrali', 'Finalizzazione precisa', 'Gioco di sponda efficace', 'Pressing coordinato'],
                importanza: 'FONDAMENTALE - Devono impegnare costantemente i due centrali'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Pressing asfissiante sul mediano', 'Capacita di inserimento', 'Creativita negli spazi', 'Visione di gioco', 'Tecnica individuale superiore'],
                importanza: 'ESSENZIALE - Deve annullare il mediano e creare gioco'
              },
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Inserimenti negli spazi', 'Supporto alle punte', 'Capacita di finalizzazione da fuori', 'Equilibrio tra fase difensiva e offensiva', 'Mobilita costante'],
                importanza: 'CRITICO - Devono creare superioritÃ  numerica in attacco'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 85,
            motivo: 'Quattro trequartisti per superare il pressing',
            vantaggi: ['SuperioritÃ  nella trequarti', 'Esterni mobili', 'Triangolazioni rapide'],
            tattiche: ['Giro palla veloce per superare il pressing', 'Esterni che attaccano gli spazi', 'Combinazioni strette'],
            ruoliChiave: [
              {
                ruolo: 'TREQUARTISTA CENTRALE',
                caratteristiche: ['Tecnica sopraffina sotto pressione', 'Capacita di giocate nello stretto', 'Visione per combinazioni rapide', 'Mobilita per sfuggire al mediano', 'Dribbling in spazi ridotti'],
                importanza: 'FONDAMENTALE - Deve battere il pressing del mediano avversario'
              },
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Velocita per attaccare gli spazi', 'Capacita di venire incontro', 'Triangolazioni con trequartista', 'Dribbling per saltare l\'uomo', 'Ampiezza e profondita'],
                importanza: 'ESSENZIALE - Devono allargare il pressing e creare superioritÃ '
              },
              {
                ruolo: 'MEDIANI (Coppia)',
                caratteristiche: ['Controllo del possesso', 'Passaggio veloce e preciso', 'Capacita di cambiare gioco', 'Mobilita per aprire linee', 'Copertura reciproca'],
                importanza: 'IMPORTANTE - Devono far girare palla velocemente per battere il pressing'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 80,
            motivo: 'SuperioritÃ  numerica a centrocampo',
            vantaggi: ['Cinque contro quattro in mezzo', 'Quinti offensivi', 'Controllo del gioco'],
            tattiche: ['Dominare il centrocampo', 'Quinti per creare superioritÃ ', 'Possesso palla prolungato'],
            ruoliChiave: [
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Trio)',
                caratteristiche: ['SuperioritÃ  numerica sul quartetto avversario', 'Controllo del possesso', 'Capacita di verticalizzare', 'Mobilita per aprire spazi', 'Passaggio preciso'],
                importanza: 'FONDAMENTALE - Devono dominare il centrocampo con superioritÃ '
              },
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Ampiezza sulle fasce', 'Capacita di creare superioritÃ  numerica', 'Cross dal fondo', 'Resistenza per fase attiva prolungata', 'Spinta offensiva costante'],
                importanza: 'ESSENZIALE - Devono allargare il campo e sovraccaricare le fasce'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti per attaccare la profondita', 'Capacita di finalizzare', 'Gioco di sponda', 'Pressing sulla costruzione', 'Coordinazione nei movimenti'],
                importanza: 'IMPORTANTE - Devono sfruttare il dominio a centrocampo'
              }
            ]
          }
        ]
      },
      '4-3-1-2': {
        puntiDeboli: [
          'Mancanza di ampiezza, niente esterni',
          'Fasce scoperte in fase difensiva',
          'Terzini soli contro ali avversarie'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Ali larghe per sfruttare le fasce scoperte',
            vantaggi: ['Ali libere sulle fasce', 'Terzini soli da attaccare', 'Ampiezza massima'],
            tattiche: ['Ali larghe contro terzini isolati', 'Attaccare costantemente le fasce', 'Cross dalle fasce'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Ampiezza massima sulle fasce', 'Velocita per puntare i terzini isolati', 'Dribbling superiore 1vs1', 'Cross precisi dal fondo', 'Capacita di finalizzazione'],
                importanza: 'FONDAMENTALE - Devono dominare i duelli con i terzini isolati'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni costanti', 'Sincronizzazione con le ali', 'Capacita di creare 2vs1', 'Cross dalla linea di fondo', 'Spinta offensiva continua'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con le ali'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Movimenti per attaccare gli spazi centrali', 'Capacita di finalizzare i cross', 'Gioco aereo efficace', 'Senso della posizione', 'Fisicita nei duelli'],
                importanza: 'CRITICO - Deve sfruttare i cross dalle fasce'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Tre trequartisti sulle fasce per sovraccarico',
            vantaggi: ['Esterni che attaccano le fasce', 'Ampiezza offensiva', 'Terzini offensivi'],
            tattiche: ['Esterni larghi sulle fasce', 'Terzini che sovraccaricare', 'Attacco sugli spazi laterali'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Posizionamento largo sulle fasce', 'Velocita per attaccare i terzini', 'Capacita di tagliare dentro al campo', 'Dribbling efficace', 'Cross e finalizzazione'],
                importanza: 'FONDAMENTALE - Devono attaccare costantemente le fasce scoperte'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni sincronizzate', 'Capacita di creare 2vs1', 'Resistenza per spinta continua', 'Cross dal fondo', 'Ampiezza offensiva'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con gli esterni'
              },
              {
                ruolo: 'TREQUARTISTA CENTRALE',
                caratteristiche: ['Creativita negli spazi centrali', 'Capacita di servire gli esterni', 'Visione di gioco per cambi di lato', 'Dribbling tra le linee', 'Inserimenti coordinati'],
                importanza: 'IMPORTANTE - Deve orchestrare gli attacchi sulle fasce'
              }
            ]
          },
          {
            modulo: '3-4-3',
            efficacia: 85,
            motivo: 'Ali e esterni per dominare le fasce',
            vantaggi: ['Sei giocatori sulle fasce', 'Ampiezza totale', 'Sovraccarichi laterali'],
            tattiche: ['Attacco costante sulle fasce', 'Ali e quinti insieme', 'Cross e sovrapposizioni'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Posizionamento largo massimo', 'Velocita per puntare i terzini', 'Dribbling superiore 1vs1', 'Finalizzazione da posizione laterale', 'Movimenti dentro-fuori'],
                importanza: 'FONDAMENTALE - Devono dominare le fasce esterne'
              },
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Sovrapposizioni coordinate con le ali', 'Resistenza per doppia fase', 'Cross dal fondo', 'Capacita di creare 2vs1 o 3vs2', 'Spinta offensiva costante'],
                importanza: 'ESSENZIALE - Devono creare superioritÃ  numerica sulle fasce'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Punto di riferimento in area', 'Capacita di finalizzare cross', 'Gioco aereo dominante', 'Movimenti per liberare spazio', 'Fisicita nei duelli'],
                importanza: 'CRITICO - Deve capitalizzare i cross dalle fasce'
              }
            ]
          }
        ]
      }
    };

    return analisi[modulo] || null;
  };

  // Render condizionale autenticazione
  if (authLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-600 to-blue-900 flex items-center justify-center">
        <div className="text-center">
          <div className="text-7xl mb-4 animate-bounce">âš½</div>
          <p className="text-white text-xl">Caricamento...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return <LoginScreen />;
  }

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center">
        <div className="text-center animate-scale-up">
          <div className="text-6xl mb-6 animate-bounce">âš½</div>
          <div className="spinner mx-auto mb-4"></div>
          <div className="text-2xl font-bold text-gray-800 mb-2 animate-pulse">Caricamento dati...</div>
          <div className="text-gray-600 text-sm">Attendere prego</div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-lg shadow-xl p-6 mb-6 animate-fade-in card-modern">
          <div className="flex items-start justify-between gap-4 mb-2">
            <div className="flex items-center gap-4 flex-1 min-w-0">
              <div className="relative flex-shrink-0">
                {teamLogo ? (
                  <div className="relative group">
                    <img 
                      src={teamLogo} 
                      alt="Logo squadra" 
                      className="w-32 h-32 object-contain rounded-lg"
                    />
                    <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-lg transition-all flex items-center justify-center gap-1">
                      <label className="opacity-0 group-hover:opacity-100 cursor-pointer bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition-all">
                        <input
                          type="file"
                          accept="image/*"
                          onChange={handleLogoUpload}
                          className="hidden"
                        />
                        âœï¸
                      </label>
                      <button
                        onClick={removeLogo}
                        className="opacity-0 group-hover:opacity-100 bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-all"
                      >
                        ðŸ—‘ï¸
                      </button>
                    </div>
                  </div>
                ) : (
                  <label className="w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all group">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleLogoUpload}
                      className="hidden"
                    />
                    <div className="text-center">
                      <div className="text-4xl group-hover:scale-110 transition-transform">ðŸ–¼ï¸</div>
                      <div className="text-xs text-gray-500 mt-1">Logo</div>
                    </div>
                  </label>
                )}
              </div>

              <div className="flex-1 min-w-0">
                {isEditingTitle ? (
                  <input
                    type="text"
                    value={appTitle}
                    onChange={(e) => setAppTitle(e.target.value)}
                    onBlur={() => setIsEditingTitle(false)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') setIsEditingTitle(false);
                    }}
                    className="text-3xl font-bold text-gray-800 border-2 border-blue-500 rounded px-2 py-1 w-full"
                    autoFocus
                  />
                ) : (
                  <h1 className="text-3xl font-bold text-gray-800 break-words">{appTitle}</h1>
                )}
              </div>
            </div>

            <div className="flex flex-wrap items-center gap-3">
              <div className="flex flex-col gap-2">
                <button
                  onClick={() => setIsEditingTitle(true)}
                  className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm flex items-center gap-1 whitespace-nowrap"
                  title="Modifica titolo"
                >
                  âœï¸ Modifica Titolo
                </button>
                <button
                  onClick={() => setShowInstructionsModal(true)}
                  className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold whitespace-nowrap"
                >
                  ðŸ“– Istruzioni
                </button>
              </div>

              {/* Badge Ruolo e Logout */}
              <div className="flex flex-col gap-2">
                <div className={`px-4 py-2 rounded-lg font-bold text-sm text-center ${
                  userRole === 'admin' 
                    ? 'bg-yellow-400 text-yellow-900' 
                    : 'bg-blue-200 text-blue-900'
                }`}>
                  {userRole === 'admin' ? 'ðŸ‘‘ ADMIN' : 'ðŸ‘ï¸ VISUALIZZATORE'}
                </div>
                <button
                  onClick={handleLogout}
                  className="flex items-center justify-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors font-semibold text-white whitespace-nowrap"
                >
                  <LogOut className="w-5 h-5" />
                  <span>Esci</span>
                </button>
              </div>
            </div>
          </div>
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-3">
              <p className="text-gray-600">Sistema di tracciamento allenamenti, partite e statistiche</p>
              <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold badge-animated">
                ðŸ’¾ Salvataggio Automatico Attivo
              </span>
              {lastSaved && (
                <span className="text-xs text-gray-500">
                  Ultimo salvataggio: {lastSaved.toLocaleTimeString('it-IT')}
                </span>
              )}
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-xl p-6 mb-6 animate-fade-in card-modern">
          <div className="flex gap-2 mb-6 border-b overflow-x-auto tab-container">
            {['dashboard', 'trainings', 'divisione', 'matches', 'tattica', 'convocazioni', 'stats', 'top', 'roster', 'injuries', 'calendar', 'export', 'sync'].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-3 md:px-6 py-3 font-semibold whitespace-nowrap ripple rounded-t-lg text-sm md:text-base flex-shrink-0 ${
                  activeTab === tab
                    ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                    : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'
                }`}
              >
                {tab === 'trainings' && (
                  <>
                    <span className="hidden md:inline">{`Allenamenti (${trainings.length})`}</span>
                    <span className="md:hidden">ðŸƒ {trainings.length}</span>
                  </>
                )}
                {tab === 'matches' && (
                  <>
                    <span className="hidden md:inline">{`Partite (${matches.length})`}</span>
                    <span className="md:hidden">âš½ {matches.length}</span>
                  </>
                )}
                {tab === 'stats' && (
                  <>
                    <span className="hidden md:inline">Statistiche</span>
                    <span className="md:hidden">ðŸ“Š</span>
                  </>
                )}
                {tab === 'top' && (
                  <>
                    <span className="hidden md:inline">ðŸ† Giocatori TOP</span>
                    <span className="md:hidden">ðŸ†</span>
                  </>
                )}
                {tab === 'tattica' && (
                  <>
                    <span className="hidden md:inline">ðŸŽ¯ Analisi Tattica</span>
                    <span className="md:hidden">ðŸŽ¯</span>
                  </>
                )}
                {tab === 'divisione' && (
                  <>
                    <span className="hidden md:inline">âš–ï¸ Divisione Squadre</span>
                    <span className="md:hidden">âš–ï¸</span>
                  </>
                )}
                {tab === 'convocazioni' && (
                  <>
                    <span className="hidden md:inline">ðŸ“‹ Convocazioni</span>
                    <span className="md:hidden">ðŸ“‹</span>
                  </>
                )}
                {tab === 'roster' && (
                  <>
                    <span className="hidden md:inline">Gestione Rosa</span>
                    <span className="md:hidden">ðŸ‘¥</span>
                  </>
                )}
                {tab === 'dashboard' && (
                  <>
                    <span className="hidden md:inline">ðŸ“Š Dashboard</span>
                    <span className="md:hidden">ðŸ“Š</span>
                  </>
                )}
                {tab === 'injuries' && (
                  <>
                    <span className="hidden md:inline">ðŸ¤• Infortuni</span>
                    <span className="md:hidden">ðŸ¤•</span>
                  </>
                )}
                {tab === 'calendar' && (
                  <>
                    <span className="hidden md:inline">ðŸ“… Calendario</span>
                    <span className="md:hidden">ðŸ“…</span>
                  </>
                )}
                {tab === 'export' && (
                  <>
                    <span className="hidden md:inline">ðŸ’¾ Esportazioni</span>
                    <span className="md:hidden">ðŸ’¾</span>
                  </>
                )}
                {tab === 'sync' && (
                  <>
                    <span className="hidden md:inline">â˜ï¸ Sincronizzazione</span>
                    <span className="md:hidden">â˜ï¸</span>
                  </>
                )}
              </button>
            ))}
          </div>

          {/* ============================================ */}
          {/* TAB DASHBOARD - NUOVO */}
          {/* ============================================ */}
          {activeTab === 'dashboard' && (
            <div className="animate-fade-in">
              <div className="mb-6">
                <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ“Š Dashboard Stagionale</h2>
                <p className="text-gray-600">Panoramica completa delle statistiche e andamento della stagione</p>
              </div>

              {/* Quick Stats Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-6 border-2 border-blue-200 animate-scale-up">
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl">âš½</div>
                    <div className="text-3xl font-bold text-blue-600">{matches.length}</div>
                  </div>
                  <div className="text-gray-700 font-semibold">Partite Giocate</div>
                  <div className="text-sm text-gray-600 mt-1">
                    {matches.filter(m => m.risultato && m.risultato.includes('-')).length} completate
                  </div>
                </div>

                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200 animate-scale-up" style={{animationDelay: '0.1s'}}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl">ðŸƒ</div>
                    <div className="text-3xl font-bold text-green-600">{trainings.length}</div>
                  </div>
                  <div className="text-gray-700 font-semibold">Allenamenti</div>
                  <div className="text-sm text-gray-600 mt-1">
                    Media presenze: {trainings.length > 0 ? Math.round((trainings.reduce((acc, t) => acc + Object.values(t.presenze).filter(p => p).length, 0) / trainings.length)) : 0}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow-lg p-6 border-2 border-yellow-200 animate-scale-up" style={{animationDelay: '0.2s'}}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl">ðŸ‘¥</div>
                    <div className="text-3xl font-bold text-yellow-600">{players.filter(p => p.nome).length}</div>
                  </div>
                  <div className="text-gray-700 font-semibold">Giocatori Attivi</div>
                  <div className="text-sm text-gray-600 mt-1">
                    {getActiveInjuries().length} infortunati
                  </div>
                </div>

                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-lg p-6 border-2 border-purple-200 animate-scale-up" style={{animationDelay: '0.3s'}}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl">ðŸŽ¯</div>
                    <div className="text-3xl font-bold text-purple-600">
                      {matches.reduce((sum, m) => {
                        if (!m.golFatti) return sum;
                        return sum + Object.values(m.golFatti).reduce((s, g) => s + (parseInt(g) || 0), 0);
                      }, 0)}
                    </div>
                  </div>
                  <div className="text-gray-700 font-semibold">Gol Totali</div>
                  <div className="text-sm text-gray-600 mt-1">
                    Media: {matches.length > 0 ? (matches.reduce((sum, m) => sum + Object.values(m.golFatti || {}).reduce((s, g) => s + (parseInt(g) || 0), 0), 0) / matches.length).toFixed(1) : 0} per partita
                  </div>
                </div>
              </div>

              {/* Grafici */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* Grafico Gol Fatti/Subiti */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“ˆ Andamento Gol</h3>
                  <canvas id="goalsChart" className="w-full" style={{maxHeight: '300px'}}></canvas>
                </div>

                {/* Grafico Risultati */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ† Risultati Partite</h3>
                  <canvas id="resultsChart" className="w-full" style={{maxHeight: '300px'}}></canvas>
                </div>

                {/* Grafico Presenze Allenamenti */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“Š Presenze Allenamenti</h3>
                  <canvas id="attendanceChart" className="w-full" style={{maxHeight: '300px'}}></canvas>
                </div>

                {/* Top Marcatori Quick View */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">âš½ Top 5 Marcatori</h3>
                  <div className="space-y-3">
                    {players
                      .map(p => ({
                        ...p,
                        gol: matches.reduce((sum, m) => sum + (parseInt(m.golFatti?.[p.numero]) || 0), 0)
                      }))
                      .filter(p => p.gol > 0)
                      .sort((a, b) => b.gol - a.gol)
                      .slice(0, 5)
                      .map((p, idx) => (
                        <div key={p.numero} className="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                          <div className="flex items-center gap-3">
                            <div className={`text-2xl font-bold ${idx === 0 ? 'text-yellow-500' : idx === 1 ? 'text-gray-400' : idx === 2 ? 'text-orange-600' : 'text-gray-600'}`}>
                              {idx + 1}Â°
                            </div>
                            {p.foto && (
                              <img src={p.foto} alt={p.nome} className="w-10 h-10 rounded-full object-cover" />
                            )}
                            <div>
                              <div className="font-semibold text-gray-800">{p.nome}</div>
                              <div className="text-sm text-gray-600">#{p.numero}</div>
                            </div>
                          </div>
                          <div className="text-2xl font-bold text-blue-600">{p.gol}</div>
                        </div>
                      ))}
                  </div>
                </div>
              </div>

              {/* Report Mensile Automatico */}
              <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">
                <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“‹ Report Mensile Automatico</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-sm text-gray-600 mb-2">Partite del Mese</div>
                    <div className="text-3xl font-bold text-gray-800">
                      {matches.filter(m => {
                        const matchDate = new Date(m.data);
                        const now = new Date();
                        return matchDate.getMonth() === now.getMonth() && matchDate.getFullYear() === now.getFullYear();
                      }).length}
                    </div>
                  </div>
                  <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-sm text-gray-600 mb-2">Allenamenti del Mese</div>
                    <div className="text-3xl font-bold text-gray-800">
                      {trainings.filter(t => {
                        const trainDate = new Date(t.data);
                        const now = new Date();
                        return trainDate.getMonth() === now.getMonth() && trainDate.getFullYear() === now.getFullYear();
                      }).length}
                    </div>
                  </div>
                  <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-sm text-gray-600 mb-2">Gol del Mese</div>
                    <div className="text-3xl font-bold text-gray-800">
                      {matches
                        .filter(m => {
                          const matchDate = new Date(m.data);
                          const now = new Date();
                          return matchDate.getMonth() === now.getMonth() && matchDate.getFullYear() === now.getFullYear();
                        })
                        .reduce((sum, m) => sum + Object.values(m.golFatti || {}).reduce((s, g) => s + (parseInt(g) || 0), 0), 0)}
                    </div>
                  </div>
                </div>
              </div>

              {/* Classifica MVP (Man of the Match) */}
              <div className="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg shadow-lg p-6 border-2 border-yellow-200 mt-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                      ðŸ† Man of the Match - Classifica Stagionale
                    </h3>
                    <p className="text-sm text-gray-600 mt-1">
                      I giocatori che hanno vinto piÃ¹ volte il premio MVP
                    </p>
                  </div>
                  <div className="text-3xl">â­</div>
                </div>
                
                {(() => {
                  const leaderboard = getMVPLeaderboard();
                  
                  if (leaderboard.length === 0) {
                    return (
                      <div className="text-center py-8 text-gray-500">
                        <div className="text-4xl mb-2">ðŸ†</div>
                        <p>Nessun MVP assegnato ancora</p>
                        <p className="text-sm mt-2">Vota il migliore in campo dopo ogni partita!</p>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="space-y-3">
                      {leaderboard.map((entry, idx) => (
                        <div 
                          key={entry.playerNum}
                          className={`flex items-center justify-between rounded-lg p-4 transition-all hover:scale-102 ${
                            idx === 0 
                              ? 'bg-gradient-to-r from-yellow-100 to-amber-100 border-2 border-yellow-400 shadow-md'
                              : idx === 1
                              ? 'bg-gradient-to-r from-gray-100 to-slate-100 border-2 border-gray-300'
                              : idx === 2
                              ? 'bg-gradient-to-r from-orange-100 to-amber-100 border-2 border-orange-300'
                              : 'bg-white border-2 border-gray-200'
                          }`}
                        >
                          <div className="flex items-center gap-4">
                            <div className={`text-3xl font-bold ${
                              idx === 0 ? 'text-yellow-600' : 
                              idx === 1 ? 'text-gray-500' : 
                              idx === 2 ? 'text-orange-600' : 
                              'text-gray-600'
                            }`}>
                              {idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : `${idx + 1}Â°`}
                            </div>
                            
                            {entry.playerPhoto ? (
                              <img 
                                src={entry.playerPhoto} 
                                alt={entry.playerName}
                                className="w-16 h-16 rounded-full object-cover border-2 border-white shadow-md"
                              />
                            ) : (
                              <div className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center border-2 border-white shadow-md">
                                <span className="text-2xl font-bold text-gray-500">
                                  {entry.playerNum}
                                </span>
                              </div>
                            )}
                            
                            <div>
                              <div className="font-bold text-gray-800 text-lg">
                                {entry.playerName}
                              </div>
                              <div className="text-sm text-gray-600">
                                #{entry.playerNum}
                              </div>
                            </div>
                          </div>
                          
                          <div className="flex items-center gap-3">
                            <div className="text-right">
                              <div className="text-3xl font-bold text-yellow-600">
                                {entry.mvpCount}
                              </div>
                              <div className="text-sm text-gray-600">
                                {entry.mvpCount === 1 ? 'MVP' : 'MVP'}
                              </div>
                            </div>
                            <div className="text-3xl">
                              {idx === 0 ? 'ðŸŒŸ' : 'â­'}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  );
                })()}
              </div>
            </div>
          )}

          {activeTab === 'trainings' && (
            <div>
              <div className="flex justify-between items-center mb-4 flex-wrap gap-3">
                <h2 className="text-2xl font-bold text-gray-800">Allenamenti</h2>
                <div className="flex gap-3">
                  <button
                    onClick={stampaListaPresenze}
                    className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                  >
                    <Download size={20} />
                    ðŸ“‹ Stampa Lista Presenze
                  </button>
                  <button
                    onClick={addTraining}
                    className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <Plus size={20} />
                    Aggiungi Nuovo Allenamento
                  </button>
                </div>
              </div>

              {trainings.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-lg">Nessun allenamento registrato</p>
                  <p className="text-sm mt-2">Clicca su "Aggiungi Nuovo Allenamento" per iniziare</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {getSortedTrainings().map(training => (
                    <div key={training.id} className="border rounded-lg bg-gray-50">
                      <div 
                        className="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-100 transition-colors"
                        onClick={() => toggleTraining(training.id)}
                      >
                        <div className="flex items-center gap-4 flex-1">
                          <span className="text-2xl">{expandedTrainings[training.id] ? 'â–¼' : 'â–¶'}</span>
                          <div className="flex items-center gap-4">
                            <input
                              type="date"
                              value={training.data}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateTraining(training.id, 'data', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg font-semibold"
                            />
                            <div>
                              <span className="font-semibold text-lg">Allenamento</span>
                              <span className="text-sm text-gray-600 ml-4">
                                Presenti: {Object.values(training.presenze).filter(p => p === true).length} | 
                                Assenti: {Object.values(training.presenze).filter(p => p === false).length} | 
                                Infortuni: {Object.values(training.infortuni).filter(i => i).length}
                              </span>
                            </div>
                          </div>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            deleteTraining(training.id);
                          }}
                          className="text-red-600 hover:text-red-700 p-2"
                        >
                          <Trash2 size={20} />
                        </button>
                      </div>

                      {expandedTrainings[training.id] && (
                        <div className="p-4 border-t">
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            {players.filter(p => {
                              if (!p.nome) return false;
                              if (!p.dataCreazione) return true;
                              return new Date(p.dataCreazione) <= new Date(training.data);
                            }).map(player => (
                              <div key={player.numero} className="flex items-center gap-2 bg-white p-2 rounded">
                                <span className="font-bold text-gray-700 w-8">{player.numero}</span>
                                <span className="flex-1 text-sm">{player.nome}</span>
                                <label className="flex items-center gap-1">
                                  <input
                                    type="checkbox"
                                    checked={training.presenze[player.numero] === true}
                                    onChange={(e) => {
                                      const newPresenze = { ...training.presenze, [player.numero]: e.target.checked ? true : undefined };
                                      updateTraining(training.id, 'presenze', newPresenze);
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-xs text-green-600">P</span>
                                </label>
                                <label className="flex items-center gap-1">
                                  <input
                                    type="checkbox"
                                    checked={training.presenze[player.numero] === false}
                                    onChange={(e) => {
                                      const newPresenze = { ...training.presenze, [player.numero]: e.target.checked ? false : undefined };
                                      updateTraining(training.id, 'presenze', newPresenze);
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-xs text-orange-600">A</span>
                                </label>
                                <label className="flex items-center gap-1">
                                  <input
                                    type="checkbox"
                                    checked={training.infortuni[player.numero] || false}
                                    onChange={(e) => {
                                      const newInfortuni = { ...training.infortuni, [player.numero]: e.target.checked };
                                      updateTraining(training.id, 'infortuni', newInfortuni);
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-xs text-red-600">I</span>
                                </label>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

{activeTab === 'matches' && (
            <div>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold text-gray-800">Partite</h2>
                <button
                  onClick={addMatch}
                  className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <Plus size={20} />
                  Aggiungi Nuova Partita
                </button>
              </div>

              {matches.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-lg">Nessuna partita registrata</p>
                  <p className="text-sm mt-2">Clicca su "Aggiungi Nuova Partita" per iniziare</p>
                </div>
              ) : (
                <div className="space-y-6">
                  {getSortedMatches().map(match => (
                    <div key={match.id} className="border rounded-lg bg-gray-50">
                      <div 
                        className={`flex justify-between items-center p-4 cursor-pointer hover:bg-gray-100 transition-colors ${expandedMatches[match.id] ? 'sticky top-0 z-20 bg-gray-100 border-b-2 border-blue-300' : ''}`}
                        onClick={() => toggleMatch(match.id)}
                      >
                        <div className="flex items-center gap-4 flex-1">
                          <span className="text-2xl">{expandedMatches[match.id] ? 'â–¼' : 'â–¶'}</span>
                          <div className="flex gap-4 flex-wrap flex-1">
                            <input
                              type="date"
                              value={match.data}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'data', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg font-semibold"
                            />
                            <input
                              type="text"
                              placeholder="Squadra Casa"
                              value={match.squadraCasa}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'squadraCasa', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg"
                            />
                            <input
                              type="text"
                              placeholder="Squadra Trasferta"
                              value={match.squadraTrasferta}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'squadraTrasferta', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg"
                            />
                            <input
                              type="text"
                              placeholder="Risultato (es: 2-1)"
                              value={match.risultato}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'risultato', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg w-32"
                            />
                          </div>
                        </div>
                        <div className="flex gap-2 flex-wrap">
                          {/* Pulsante MVP */}
                          {match.risultato && match.risultato.includes('-') && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                openMVPVoting(match.id);
                              }}
                              className={`px-4 py-2 rounded-lg transition-colors font-semibold flex items-center gap-2 ${
                                match.mvp 
                                  ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white hover:from-yellow-600 hover:to-yellow-700'
                                  : 'bg-yellow-100 text-yellow-700 border-2 border-yellow-400 hover:bg-yellow-200'
                              }`}
                            >
                              {match.mvp ? (
                                <>
                                  <span>ðŸ†</span>
                                  <span className="hidden sm:inline">
                                    MVP: {players.find(p => p.numero === match.mvp)?.nome.split(' ')[0] || `#${match.mvp}`}
                                  </span>
                                </>
                              ) : (
                                <>
                                  <span>â­</span>
                                  <span className="hidden sm:inline">Vota MVP</span>
                                </>
                              )}
                            </button>
                          )}
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setShowModuloModal(match.id);
                            }}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                          >
                            âš½ Modulo
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              startLiveMatch(match.id);
                            }}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold"
                          >
                            âš¡ Live
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              deleteMatch(match.id);
                            }}
                            className="text-red-600 hover:text-red-700 p-2"
                          >
                            <Trash2 size={20} />
                          </button>
                        </div>
                      </div>

                      {expandedMatches[match.id] && (
                        <div className="border-t">
                          {/* Hint mobile */}
                          <div className="md:hidden bg-blue-50 p-2 text-xs text-center text-blue-700 border-b">
                            ðŸ‘ˆ Scorri a destra per vedere tutte le colonne â†’
                          </div>
                          <div className="overflow-x-auto overflow-y-auto max-h-[600px]">
                            <table className="w-full text-xs">
                              <thead className="bg-blue-100 sticky top-0 z-10">
                                <tr>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">NÂ° Maglia</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Giocatore</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Conv.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Tit.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Sost.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Entr.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Min.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Gol</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Ass.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">G.Sub</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">ðŸŸ¨ Gio</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">ðŸŸ¨ Pro</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">ðŸŸ¥ Gio</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">ðŸŸ¥ Pro</th>
                                </tr>
                              </thead>
                            <tbody className="bg-white">
                              {players.filter(p => {
                                if (!p.nome) return false;
                                if (!p.dataCreazione) return true;
                                return new Date(p.dataCreazione) <= new Date(match.data);
                              }).sort((a, b) => {
                                const ordineDistinta = match.ordineDistinta || {};
                                const ordineA = parseInt(ordineDistinta[a.numero] || 999);
                                const ordineB = parseInt(ordineDistinta[b.numero] || 999);
                                if (ordineA === ordineB) return a.numero - b.numero;
                                return ordineA - ordineB;
                              }).map(player => (
                                <tr key={player.numero} className="border-b hover:bg-gray-50">
                                  <td className="p-1">
                                    <input
                                      type="number"
                                      min="1"
                                      max="99"
                                      value={(match.ordineDistinta || {})[player.numero] || ''}
                                      onChange={(e) => {
                                        const ordineDistinta = match.ordineDistinta || {};
                                        updateMatch(match.id, 'ordineDistinta', { ...ordineDistinta, [player.numero]: e.target.value });
                                      }}
                                      onBlur={(e) => {
                                        const newValue = e.target.value;
                                        const ordineDistinta = match.ordineDistinta || {};
                                        
                                        const isDuplicate = Object.entries(ordineDistinta).some(
                                          ([numero, valore]) => numero !== player.numero.toString() && valore === newValue && newValue !== ''
                                        );
                                        
                                        if (isDuplicate) {
                                          alert(`âš ï¸ Il numero ${newValue} Ã¨ giÃ  assegnato ad un altro giocatore nella distinta!`);
                                          updateMatch(match.id, 'ordineDistinta', { ...ordineDistinta, [player.numero]: '' });
                                        }
                                      }}
                                      className="w-12 px-2 py-1 border rounded text-center font-bold"
                                      placeholder={player.numero}
                                    />
                                  </td>
                                  <td className="p-1 text-sm font-bold">{player.nome}</td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.convocati[player.numero] || false}
                                      onChange={(e) => updateMatch(match.id, 'convocati', { ...match.convocati, [player.numero]: e.target.checked })}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.titolari[player.numero] || false}
                                      onChange={(e) => {
                                        const newTit = { ...match.titolari, [player.numero]: e.target.checked };
                                        const newMin = { ...match.minutiGiocati };
                                        if (e.target.checked) newMin[player.numero] = '90';
                                        setMatches(matches.map(m => m.id === match.id ? { ...m, titolari: newTit, minutiGiocati: newMin } : m));
                                      }}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.sostituzioni[player.numero] || false}
                                      onChange={(e) => updateMatch(match.id, 'sostituzioni', { ...match.sostituzioni, [player.numero]: e.target.checked })}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.entrati[player.numero] || false}
                                      onChange={(e) => updateMatch(match.id, 'entrati', { ...match.entrati, [player.numero]: e.target.checked })}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      max="90"
                                      value={match.minutiGiocati[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'minutiGiocati', { ...match.minutiGiocati, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-12">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.golFatti[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'golFatti', { ...match.golFatti, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-12">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.assist[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'assist', { ...match.assist, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    {player.ruolo.includes('Portiere') && (
                                      <input
                                        type="number"
                                        min="0"
                                        value={match.golSubiti[player.numero] || ''}
                                        onChange={(e) => updateMatch(match.id, 'golSubiti', { ...match.golSubiti, [player.numero]: e.target.value })}
                                        className="w-full px-2 py-1 border rounded text-center"
                                      />
                                    )}
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.gialli_gioco[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'gialli_gioco', { ...match.gialli_gioco, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.gialli_protesta[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'gialli_protesta', { ...match.gialli_protesta, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.rossi_gioco[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'rossi_gioco', { ...match.rossi_gioco, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.rossi_protesta[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'rossi_protesta', { ...match.rossi_protesta, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                          </div>
                          <div className="text-xs text-gray-600 mt-2 px-4 pb-2">
                            ðŸ’¡ Inserisci il numero di maglia nell'ordine della distinta ufficiale (es: 1 per il primo, 12 per il portiere in panchina, ecc.)
                          </div>
                          
                          {/* STEP 2: Cronologia Eventi Partita */}
                          {match.timeline && match.timeline.length > 0 && (
                            <div className="border-t mt-4 pt-4 px-4 pb-4 bg-gradient-to-br from-blue-50 to-blue-100">
                              <h4 className="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <span className="text-2xl">ðŸ“‹</span>
                                Cronologia Eventi Partita
                              </h4>
                              
                              <div className="space-y-2">
                                {match.timeline
                                  .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                                  .map((evento, idx) => {
                                    const time = new Date(evento.timestamp);
                                    const orario = time.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                                    
                                    // STEP 3: Mostra minuto se disponibile, altrimenti orario
                                    const displayTime = evento.minuto !== null && evento.minuto !== undefined 
                                      ? `${evento.minuto}'` 
                                      : orario;
                                    
                                    let icon = 'ðŸ“Œ';
                                    let bgColor = 'bg-gray-100';
                                    let textColor = 'text-gray-800';
                                    let label = evento.tipo;
                                    
                                    if (evento.tipo === 'gol') {
                                      icon = 'âš½';
                                      bgColor = 'bg-green-100';
                                      textColor = 'text-green-800';
                                      label = 'GOL';
                                    } else if (evento.tipo === 'golsubito') {
                                      icon = 'ðŸ”´';
                                      bgColor = 'bg-red-100';
                                      textColor = 'text-red-800';
                                      label = 'GOL SUBITO';
                                    } else if (evento.tipo === 'assist') {
                                      icon = 'ðŸŽ¯';
                                      bgColor = 'bg-blue-100';
                                      textColor = 'text-blue-800';
                                      label = 'ASSIST';
                                    } else if (evento.tipo === 'giallo') {
                                      icon = 'ðŸŸ¨';
                                      bgColor = 'bg-yellow-100';
                                      textColor = 'text-yellow-800';
                                      label = evento.sottotipo === 'gioco' ? 'GIALLO (gioco)' : 'GIALLO (proteste)';
                                    } else if (evento.tipo === 'rosso') {
                                      icon = 'ðŸŸ¥';
                                      bgColor = 'bg-red-100';
                                      textColor = 'text-red-800';
                                      label = evento.sottotipo === 'gioco' ? 'ROSSO (gioco)' : 'ROSSO (proteste)';
                                    }
                                    
                                    return (
                                      <div 
                                        key={evento.id || idx} 
                                        className={`${bgColor} rounded-lg p-3 flex items-center justify-between animate-fade-in hover:shadow-md transition-shadow`}
                                      >
                                        <div className="flex items-center gap-3 flex-1">
                                          <span className="text-3xl">{icon}</span>
                                          <div className="flex-1">
                                            <div className={`font-bold ${textColor} text-sm`}>{label}</div>
                                            <div className="text-gray-700 font-semibold">
                                              {evento.playerNome} 
                                              <span className="text-gray-600 text-xs ml-1">(#{evento.playerNum})</span>
                                            </div>
                                          </div>
                                        </div>
                                        
                                        <div className="flex items-center gap-3">
                                          <span className="text-gray-600 font-mono text-sm">{displayTime}</span>
                                          
                                          {/* Pulsante Rimuovi Evento */}
                                          <button
                                            onClick={() => {
                                              if (confirm(`Rimuovere evento: ${label} di ${evento.playerNome}?`)) {
                                                const newTimeline = match.timeline.filter((e, i) => (e.id || i) !== (evento.id || idx));
                                                updateMatch(match.id, 'timeline', newTimeline);
                                                showToast('ðŸ—‘ï¸ Evento rimosso', 'info');
                                              }
                                            }}
                                            className="text-red-600 hover:text-red-800 hover:bg-red-200 p-2 rounded-lg transition-colors"
                                            title="Rimuovi evento"
                                          >
                                            ðŸ—‘ï¸
                                          </button>
                                        </div>
                                      </div>
                                    );
                                  })}
                              </div>
                              
                              <div className="mt-3 text-xs text-gray-600 flex items-center gap-2">
                                <span>â„¹ï¸</span>
                                <span>Gli eventi vengono registrati automaticamente quando usi i pulsanti quick-add durante la partita</span>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

{showModuloModal && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowModuloModal(null)}>
    <div className="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
      {(() => {
        const match = matches.find(m => m.id === showModuloModal);
        const titolari = players.filter(p => match.titolari[p.numero]);
        
        const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
        const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
        const posizioniModuloCorrente = (matchModulo.moduli[moduloCorrente] || {}).posizioni || {};
        const currentModulo = { modulo: moduloCorrente, posizioni: posizioniModuloCorrente };
        
        const moduli = {
          '4-4-2': { nome: '4-4-2', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'ED', 'CC1', 'CC2', 'ES', 'PC1', 'PC2'] },
          '4-3-3': { nome: '4-3-3', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MC1', 'CC', 'MC2', 'AD', 'PC', 'AS'] },
          '3-5-2': { nome: '3-5-2', posizioni: ['P', 'DC1', 'DC2', 'DC3', 'ED', 'MC1', 'CC', 'MC2', 'ES', 'PC1', 'PC2'] },
          '4-2-3-1': { nome: '4-2-3-1', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MD1', 'MD2', 'AE', 'TQ', 'AD', 'PC'] },
          '3-4-3': { nome: '3-4-3', posizioni: ['P', 'DC1', 'DC2', 'DC3', 'ED', 'CC1', 'CC2', 'ES', 'AD', 'PC', 'AS'] },
          '5-3-2': { nome: '5-3-2', posizioni: ['P', 'TD', 'DC1', 'DC2', 'DC3', 'TS', 'MC1', 'CC', 'MC2', 'PC1', 'PC2'] },
          '4-1-4-1': { nome: '4-1-4-1', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MD', 'ED', 'CC1', 'CC2', 'ES', 'PC'] },
          '4-3-1-2': { nome: '4-3-1-2', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MC1', 'CC', 'MC2', 'TQ', 'PC1', 'PC2'] },
          '4-1-2-2-1': { nome: '4-1-2-2-1', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MD', 'CC1', 'CC2', 'AE', 'AD', 'PC'] }
        };
        
        const layoutPosizioni = {
          '4-4-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'ED', top: '50%', left: '85%' },
            { pos: 'CC1', top: '50%', left: '60%' },
            { pos: 'CC2', top: '50%', left: '40%' },
            { pos: 'ES', top: '50%', left: '15%' },
            { pos: 'PC1', top: '20%', left: '60%' },
            { pos: 'PC2', top: '20%', left: '40%' }
          ],
          '4-3-3': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MC1', top: '50%', left: '75%' },
            { pos: 'CC', top: '50%', left: '50%' },
            { pos: 'MC2', top: '50%', left: '25%' },
            { pos: 'AD', top: '20%', left: '75%' },
            { pos: 'PC', top: '20%', left: '50%' },
            { pos: 'AS', top: '20%', left: '25%' }
          ],
          '3-5-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'DC1', top: '75%', left: '70%' },
            { pos: 'DC2', top: '75%', left: '50%' },
            { pos: 'DC3', top: '75%', left: '30%' },
            { pos: 'ED', top: '55%', left: '90%' },
            { pos: 'MC1', top: '55%', left: '65%' },
            { pos: 'CC', top: '55%', left: '50%' },
            { pos: 'MC2', top: '55%', left: '35%' },
            { pos: 'ES', top: '55%', left: '10%' },
            { pos: 'PC1', top: '20%', left: '60%' },
            { pos: 'PC2', top: '20%', left: '40%' }
          ],
          '4-2-3-1': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MD1', top: '60%', left: '60%' },
            { pos: 'MD2', top: '60%', left: '40%' },
            { pos: 'AE', top: '35%', left: '80%' },
            { pos: 'TQ', top: '35%', left: '50%' },
            { pos: 'AD', top: '35%', left: '20%' },
            { pos: 'PC', top: '15%', left: '50%' }
          ],
          '3-4-3': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'DC1', top: '75%', left: '70%' },
            { pos: 'DC2', top: '75%', left: '50%' },
            { pos: 'DC3', top: '75%', left: '30%' },
            { pos: 'ED', top: '55%', left: '85%' },
            { pos: 'CC1', top: '55%', left: '60%' },
            { pos: 'CC2', top: '55%', left: '40%' },
            { pos: 'ES', top: '55%', left: '15%' },
            { pos: 'AD', top: '20%', left: '75%' },
            { pos: 'PC', top: '20%', left: '50%' },
            { pos: 'AS', top: '20%', left: '25%' }
          ],
          '5-3-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '90%' },
            { pos: 'DC1', top: '75%', left: '70%' },
            { pos: 'DC2', top: '75%', left: '50%' },
            { pos: 'DC3', top: '75%', left: '30%' },
            { pos: 'TS', top: '75%', left: '10%' },
            { pos: 'MC1', top: '50%', left: '70%' },
            { pos: 'CC', top: '50%', left: '50%' },
            { pos: 'MC2', top: '50%', left: '30%' },
            { pos: 'PC1', top: '20%', left: '60%' },
            { pos: 'PC2', top: '20%', left: '40%' }
          ],
          '4-1-4-1': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MD', top: '60%', left: '50%' },
            { pos: 'ED', top: '45%', left: '85%' },
            { pos: 'CC1', top: '45%', left: '60%' },
            { pos: 'CC2', top: '45%', left: '40%' },
            { pos: 'ES', top: '45%', left: '15%' },
            { pos: 'PC', top: '15%', left: '50%' }
          ],
          '4-3-1-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MC1', top: '55%', left: '70%' },
            { pos: 'CC', top: '55%', left: '50%' },
            { pos: 'MC2', top: '55%', left: '30%' },
            { pos: 'TQ', top: '35%', left: '50%' },
            { pos: 'PC1', top: '15%', left: '60%' },
            { pos: 'PC2', top: '15%', left: '40%' }
          ],
          '4-1-2-2-1': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MD', top: '60%', left: '50%' },
            { pos: 'CC1', top: '45%', left: '60%' },
            { pos: 'CC2', top: '45%', left: '40%' },
            { pos: 'AE', top: '25%', left: '75%' },
            { pos: 'AD', top: '25%', left: '25%' },
            { pos: 'PC', top: '10%', left: '50%' }
          ]
        };
        
        const layoutCorrente = layoutPosizioni[currentModulo.modulo];
        
        return (
          <>
            <div className="p-6 border-b sticky top-0 bg-white z-10">
              <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-blue-800">âš½ Modulo Tattico - {match.squadraCasa} vs {match.squadraTrasferta}</h2>
                <button onClick={() => setShowModuloModal(null)} className="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
              </div>
            </div>
            
            <div className="p-6">
              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">Seleziona Modulo:</label>
                <div className="grid grid-cols-4 gap-2">
                {Object.keys(moduli).map(mod => (
                  <button
                    key={mod}
                    onClick={() => {
                      const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                      setModuloTattico({
                        ...moduloTattico, 
                        [match.id]: { 
                          moduloCorrente: mod,
                          moduli: matchModulo.moduli
                        }
                      });
                    }}
                    className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                      currentModulo.modulo === mod 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    {mod}
                  </button>
                ))}
              </div>
            </div>
              
              
              {titolari.length !== 11 && (
                <div className="mb-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg">
                  âš ï¸ Attenzione: Hai selezionato {titolari.length} titolari. Seleziona esattamente 11 giocatori come titolari per visualizzare il modulo.
                </div>
              )}
              
              {titolari.length === 11 && (
                <div>
                  <div className="relative w-full rounded-lg overflow-hidden mb-12" style={{ 
                    paddingBottom: '85%', 
                    maxWidth: '455px', 
                    margin: '0 auto',
                    background: 'linear-gradient(180deg, #2d5016 0%, #1a3d0f 100%)',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
                  }}>
                    <div className="absolute inset-0">
                      <div className="absolute top-0 left-0 right-0 h-0.5 bg-white opacity-90"></div>
                      <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-white opacity-90"></div>
                      <div className="absolute top-0 bottom-0 left-0 w-0.5 bg-white opacity-90"></div>
                      <div className="absolute top-0 bottom-0 right-0 w-0.5 bg-white opacity-90"></div>
                      
                      <div className="absolute top-0 left-1/2 w-20 h-1 bg-white opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute top-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(-40px)' }}></div>
                      <div className="absolute top-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(40px)' }}></div>
                      
                      <div className="absolute top-0 left-1/2 w-36 h-20 border-2 border-white border-t-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute top-0 left-1/2 w-24 h-10 border-2 border-white border-t-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute left-1/2 w-16 h-16 border-2 border-white opacity-90 rounded-full border-t-0 border-l-0 border-r-0" style={{ top: '48px', transform: 'translateX(-50%) scaleY(0.5)' }}></div>
                      <div className="absolute left-1/2 w-2 h-2 bg-white opacity-90 rounded-full" style={{ top: '70px', transform: 'translateX(-50%)' }}></div>
                      
                      <div className="absolute top-1/2 left-0 right-0 h-0.5 bg-white opacity-90" style={{ transform: 'translateY(-50%)' }}></div>
                      
                      <div className="absolute top-1/2 left-1/2 w-24 h-24 border-2 border-white opacity-90 rounded-full" style={{ transform: 'translate(-50%, -50%)' }}></div>
                      <div className="absolute top-1/2 left-1/2 w-2 h-2 bg-white opacity-90 rounded-full" style={{ transform: 'translate(-50%, -50%)' }}></div>
                      
                      <div className="absolute bottom-0 left-1/2 w-36 h-20 border-2 border-white border-b-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute bottom-0 left-1/2 w-24 h-10 border-2 border-white border-b-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute left-1/2 w-16 h-16 border-2 border-white opacity-90 rounded-full border-b-0 border-l-0 border-r-0" style={{ bottom: '48px', transform: 'translateX(-50%) scaleY(0.5)' }}></div>
                      <div className="absolute left-1/2 w-2 h-2 bg-white opacity-90 rounded-full" style={{ bottom: '70px', transform: 'translateX(-50%)' }}></div>
                      
                      <div className="absolute bottom-0 left-1/2 w-20 h-1 bg-white opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute bottom-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(-40px)' }}></div>
                      <div className="absolute bottom-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(40px)' }}></div>
                      
                      <div className="absolute top-0 left-0 w-6 h-6 border-2 border-white opacity-90 rounded-br-full border-t-0 border-l-0"></div>
                      <div className="absolute top-0 left-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute top-0 left-0 w-2.5 h-2 bg-yellow-400 opacity-90"></div>
                      
                      <div className="absolute top-0 right-0 w-6 h-6 border-2 border-white opacity-90 rounded-bl-full border-t-0 border-r-0"></div>
                      <div className="absolute top-0 right-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute top-0 right-0 w-2.5 h-2 bg-yellow-400 opacity-90" style={{ transform: 'translateX(-2.5px)' }}></div>
                      
                      <div className="absolute bottom-0 left-0 w-6 h-6 border-2 border-white opacity-90 rounded-tr-full border-b-0 border-l-0"></div>
                      <div className="absolute bottom-0 left-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute bottom-0 left-0 w-2.5 h-2 bg-yellow-400 opacity-90"></div>
                      
                      <div className="absolute bottom-0 right-0 w-6 h-6 border-2 border-white opacity-90 rounded-tl-full border-b-0 border-r-0"></div>
                      <div className="absolute bottom-0 right-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute bottom-0 right-0 w-2.5 h-2 bg-yellow-400 opacity-90" style={{ transform: 'translateX(-2.5px)' }}></div>
                      
                      <div className="absolute inset-0 opacity-10" style={{
                        backgroundImage: 'repeating-linear-gradient(90deg, transparent, transparent 8%, rgba(255,255,255,0.1) 8%, rgba(255,255,255,0.1) 16%)'
                      }}></div>
                    </div>
                    
                    {layoutCorrente.map((pos, idx) => {
                      const giocatoreAssegnato = currentModulo.posizioni[pos.pos];
                      const giocatore = giocatoreAssegnato ? players.find(p => p.numero === giocatoreAssegnato) : null;
                      
                      // Ottieni offset salvato per questa posizione
                      const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                      const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                      const offsets = matchModulo.moduli?.[moduloCorrente]?.offsets || {};
                      const offset = offsets[pos.pos] || { x: 0, y: 0 };
                      
                      // Calcola posizione finale con offset
                      const finalTop = `calc(${pos.top} + ${offset.y}px)`;
                      const finalLeft = `calc(${pos.left} + ${offset.x}px)`;
                      
                      return (
                        <div
                          key={pos.pos}
                          className="absolute"
                          style={{ 
                            top: finalTop, 
                            left: finalLeft, 
                            transform: 'translate(-50%, -50%)'
                          }}
                          onDragOver={(e) => {
                            e.preventDefault();
                          }}
                        >
                          {giocatore ? (
                            <div 
                              className="relative group" 
                              draggable="true"
                              onDragStart={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                const campoRect = e.currentTarget.closest('.relative.w-full').getBoundingClientRect();
                                
                                setDragState({
                                  matchId: match.id,
                                  pos: pos.pos,
                                  startX: e.clientX,
                                  startY: e.clientY,
                                  campoRect: {
                                    width: campoRect.width,
                                    height: campoRect.height,
                                    left: campoRect.left,
                                    top: campoRect.top
                                  }
                                });
                                
                                e.dataTransfer.effectAllowed = 'move';
                              }}
                              onDragEnd={(e) => {
                                if (!dragState || dragState.matchId !== match.id || dragState.pos !== pos.pos) {
                                  setDragState(null);
                                  return;
                                }
                                
                                // Calcola quanto Ã¨ stato trascinato
                                const deltaX = e.clientX - dragState.startX;
                                const deltaY = e.clientY - dragState.startY;
                                
                                // Se movimento minimo, ignora (click accidentale)
                                if (Math.abs(deltaX) < 5 && Math.abs(deltaY) < 5) {
                                  setDragState(null);
                                  return;
                                }
                                
                                // Salva offset
                                const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                                const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                                const moduliAggiornati = { ...matchModulo.moduli };
                                
                                if (!moduliAggiornati[moduloCorrente]) {
                                  moduliAggiornati[moduloCorrente] = { posizioni: {}, offsets: {} };
                                }
                                
                                const currentOffsets = { ...(moduliAggiornati[moduloCorrente].offsets || {}) };
                                const existingOffset = currentOffsets[pos.pos] || { x: 0, y: 0 };
                                
                                // Aggiungi il nuovo offset a quello esistente
                                currentOffsets[pos.pos] = { 
                                  x: Math.round(existingOffset.x + deltaX), 
                                  y: Math.round(existingOffset.y + deltaY) 
                                };
                                
                                moduliAggiornati[moduloCorrente] = {
                                  ...moduliAggiornati[moduloCorrente],
                                  offsets: currentOffsets
                                };
                                
                                setModuloTattico({
                                  ...moduloTattico,
                                  [match.id]: {
                                    moduloCorrente: moduloCorrente,
                                    moduli: moduliAggiornati
                                  }
                                });
                                
                                setDragState(null);
                              }}
                              style={{ cursor: 'move' }}
                            >
                              <div className="relative" style={{ width: '39px', height: '49px' }}>
                                <div className="absolute -bottom-1 left-1/2 w-12 h-2.5 bg-black opacity-30 rounded-full blur-sm" style={{ transform: 'translateX(-50%)' }}></div>
                                
                                <svg viewBox="0 0 40 50" className="w-full h-full drop-shadow-md">
                                  <rect x="14" y="32" width="4" height="12" fill="#FF6B35" rx="2"/>
                                  <rect x="22" y="32" width="4" height="12" fill="#FF6B35" rx="2"/>
                                  <rect x="14" y="42" width="4" height="6" fill="#1a1a1a" rx="1"/>
                                  <rect x="22" y="42" width="4" height="6" fill="#1a1a1a" rx="1"/>
                                  
                                  <rect x="12" y="18" width="16" height="16" fill="#FF6B35" rx="3"/>
                                  <rect x="14" y="20" width="12" height="2" fill="#FF8C42" opacity="0.6"/>
                                  
                                  <rect x="8" y="20" width="4" height="10" fill="#FF6B35" rx="2"/>
                                  <rect x="28" y="20" width="4" height="10" fill="#FF6B35" rx="2"/>
                                  
                                  <circle cx="20" cy="12" r="6" fill="#FFD4B2"/>
                                  
                                  <path d="M 14 10 Q 14 6 20 6 Q 26 6 26 10" fill="#3d2817"/>
                                </svg>
                                
                                <div className="absolute top-4 left-1/2 transform -translate-x-1/2 text-white font-bold" style={{ fontSize: '16px', textShadow: '1px 1px 2px rgba(0,0,0,0.8)' }}>
                                  {(match.ordineDistinta && match.ordineDistinta[giocatore.numero]) || giocatore.numero}
                                </div>
                              </div>
                              
                              <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-center whitespace-nowrap">
                                <div className="bg-white px-1 py-0.5 rounded shadow-sm border border-gray-300">
                                  <div className="font-bold text-gray-900" style={{ fontSize: '8px' }}>
                                    {giocatore.nome}
                                  </div>
                                  <div className="text-blue-600 font-semibold" style={{ fontSize: '7px' }}>{pos.pos}</div>
                                </div>
                              </div>
                              
                              <button
                                onClick={() => {
                                  const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                                  const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                                  const moduliAggiornati = { ...matchModulo.moduli };
                                  
                                  const newPosizioni = { ...(moduliAggiornati[moduloCorrente]?.posizioni || {}) };
                                  delete newPosizioni[pos.pos];
                                  
                                  moduliAggiornati[moduloCorrente] = {
                                    ...moduliAggiornati[moduloCorrente],
                                    posizioni: newPosizioni
                                  };
                                  
                                  setModuloTattico({
                                    ...moduloTattico, 
                                    [match.id]: { 
                                      moduloCorrente: moduloCorrente,
                                      moduli: moduliAggiornati 
                                    }
                                  });
                                }}
                                className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 text-white rounded-full font-normal hover:bg-red-600 shadow-sm opacity-40 hover:opacity-100"
                                style={{ zIndex: 10, fontSize: '6px' }}
                              >
                                âœ•
                              </button>
                              
                              {offset.x !== 0 || offset.y !== 0 ? (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                                    const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                                    const moduliAggiornati = { ...matchModulo.moduli };
                                    
                                    const currentOffsets = { ...(moduliAggiornati[moduloCorrente]?.offsets || {}) };
                                    delete currentOffsets[pos.pos];
                                    
                                    moduliAggiornati[moduloCorrente] = {
                                      ...moduliAggiornati[moduloCorrente],
                                      offsets: currentOffsets
                                    };
                                    
                                    setModuloTattico({
                                      ...moduloTattico,
                                      [match.id]: {
                                        moduloCorrente: moduloCorrente,
                                        moduli: moduliAggiornati
                                      }
                                    });
                                  }}
                                  className="absolute -top-1 -left-1 w-3 h-3 bg-blue-500 text-white rounded-full font-normal hover:bg-blue-600 shadow-sm opacity-40 hover:opacity-100"
                                  style={{ zIndex: 10, fontSize: '6px' }}
                                  title="Reset posizione"
                                >
                                  â†º
                                </button>
                              ) : null}
                            </div>
                          ) : (
                            <button
                              onClick={() => {
                                setPlayerSelectionModal({ matchId: match.id, posizione: pos.pos });
                              }}
                              className="relative hover:opacity-100 transition-opacity cursor-pointer"
                              style={{ width: '34px', height: '43px' }}
                            >
                              <svg viewBox="0 0 40 50" className="w-full h-full opacity-40 hover:opacity-60">
                                <rect x="14" y="32" width="4" height="12" fill="#999" rx="2"/>
                                <rect x="22" y="32" width="4" height="12" fill="#999" rx="2"/>
                                <rect x="12" y="18" width="16" height="16" fill="#999" rx="3"/>
                                <rect x="8" y="20" width="4" height="10" fill="#999" rx="2"/>
                                <rect x="28" y="20" width="4" height="10" fill="#999" rx="2"/>
                                <circle cx="20" cy="12" r="6" fill="#999"/>
                                <circle cx="20" cy="25" r="8" fill="#4CAF50" opacity="0.8"/>
                                <text x="20" y="30" textAnchor="middle" fill="white" fontSize="14" fontWeight="bold">+</text>
                              </svg>
                              <div className="absolute -bottom-7 left-1/2 transform -translate-x-1/2 text-center">
                                <div className="bg-gray-400 text-white px-1 py-0.5 rounded font-semibold" style={{ fontSize: '7px' }}>
                                  {pos.pos}
                                </div>
                              </div>
                            </button>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  
                  <div className="mt-20">
                    <h3 className="text-lg font-bold text-gray-800 mb-3">Giocatori da Assegnare:</h3>
                    <div className="grid grid-cols-2 gap-3">
                      {titolari.filter(p => !Object.values(currentModulo.posizioni).includes(p.numero)).sort((a, b) => {
                        const numA = parseInt((match.ordineDistinta && match.ordineDistinta[a.numero]) || a.numero);
                        const numB = parseInt((match.ordineDistinta && match.ordineDistinta[b.numero]) || b.numero);
                        return numA - numB;
                      }).map(player => (
                        <div key={player.numero} className="border rounded-lg p-3 bg-gray-50">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">
                              {(match.ordineDistinta && match.ordineDistinta[player.numero]) || player.numero}
                            </div>
                            <div className="flex-1">
                              <div className="font-bold text-sm">{player.nome}</div>
                              <div className="text-xs text-gray-600">{player.ruolo}</div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {Object.keys(currentModulo.posizioni).length === 11 && (
                    <div className="mt-6 p-4 bg-green-100 border border-green-400 rounded-lg text-center">
                      âœ… Modulo completo! Tutti i giocatori sono stati assegnati.
                    </div>
                  )}
                </div>
              )}
              
              <div className="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 className="font-bold text-sm mb-2">ðŸ“‹ Legenda Posizioni:</h4>
                <div className="grid grid-cols-4 gap-2 text-xs">
                  <div><strong>P:</strong> Portiere</div>
                  <div><strong>TD:</strong> Terzino Dx</div>
                  <div><strong>TS:</strong> Terzino Sx</div>
                  <div><strong>DC:</strong> Difensore Centrale</div>
                  <div><strong>ED:</strong> Esterno Dx</div>
                  <div><strong>ES:</strong> Esterno Sx</div>
                  <div><strong>CC:</strong> Centrocampista Centrale</div>
                  <div><strong>MC:</strong> Mezzala Centrale</div>
                  <div><strong>MD:</strong> Mediano</div>
                  <div><strong>TQ:</strong> Trequartista</div>
                  <div><strong>AD:</strong> Attaccante Dx</div>
                  <div><strong>AS:</strong> Attaccante Sx</div>
                  <div><strong>PC:</strong> Punta Centrale</div>
                  <div><strong>AE:</strong> Ala Esterna</div>
                </div>
              </div>
            </div>
          </>
        );
      })()}
    </div>
  </div>
)}

{playerSelectionModal && (() => {
  const match = matches.find(m => m.id === playerSelectionModal.matchId);
  const titolari = players.filter(p => match.titolari[p.numero]);
  const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
  const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
  const posizioniModuloCorrente = (matchModulo.moduli[moduloCorrente] || {}).posizioni || {};
  
  const giocatoriDisponibili = titolari.filter(p => 
    !Object.values(posizioniModuloCorrente).includes(p.numero)
  ).sort((a, b) => {
    const numA = parseInt((match.ordineDistinta && match.ordineDistinta[a.numero]) || a.numero);
    const numB = parseInt((match.ordineDistinta && match.ordineDistinta[b.numero]) || b.numero);
    return numA - numB;
  });
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setPlayerSelectionModal(null)}>
      <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={(e) => e.stopPropagation()}>
        <div className="p-4 border-b bg-blue-600 text-white rounded-t-lg">
          <div className="flex justify-between items-center">
            <h3 className="text-xl font-bold">Seleziona Giocatore per {playerSelectionModal.posizione}</h3>
            <button onClick={() => setPlayerSelectionModal(null)} className="text-white hover:text-gray-200 text-2xl">âœ•</button>
          </div>
        </div>
        
        <div className="p-4 max-h-[60vh] overflow-y-auto">
          {giocatoriDisponibili.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              <p className="text-lg font-semibold">Nessun giocatore disponibile</p>
              <p className="text-sm mt-2">Tutti i giocatori sono giÃ  assegnati</p>
            </div>
          ) : (
            <div className="space-y-2">
              {giocatoriDisponibili.map(player => (
                <button
                  key={player.numero}
                  onClick={() => {
                    const moduliAggiornati = { ...matchModulo.moduli };
                    
                    moduliAggiornati[moduloCorrente] = {
                      ...moduliAggiornati[moduloCorrente],
                      posizioni: { 
                        ...(moduliAggiornati[moduloCorrente]?.posizioni || {}), 
                        [playerSelectionModal.posizione]: player.numero 
                      }
                    };
                    
                    setModuloTattico({
                      ...moduloTattico,
                      [match.id]: {
                        moduloCorrente: moduloCorrente,
                        moduli: moduliAggiornati
                      }
                    });
                    
                    setPlayerSelectionModal(null);
                  }}
                  className="w-full flex items-center gap-4 p-3 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors border-2 border-transparent hover:border-blue-500"
                >
                  <div className="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg flex-shrink-0">
                    {(match.ordineDistinta && match.ordineDistinta[player.numero]) || player.numero}
                  </div>
                  <div className="text-left flex-1">
                    <div className="font-bold text-gray-900 text-lg">{player.nome}</div>
                    <div className="text-sm text-gray-600">{player.ruolo}</div>
                  </div>
                  <div className="text-blue-600 font-bold text-xl">â†’</div>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
})()}

{activeTab === 'stats' && (
            <div className="h-[calc(100vh-280px)] flex flex-col">
              <h2 className="text-2xl font-bold text-gray-800 mb-3">Statistiche Giocatori</h2>
              
              {/* Layout TABLET/DESKTOP - Tabella */}
              <div className="hidden md:flex flex-1 overflow-auto">
                <table className="w-full text-xs border-collapse">
                  <thead className="bg-blue-100 sticky top-0">
                    <tr>
                      <th className="p-1 text-left border">NÂ°</th>
                      <th className="p-1 text-left border">Nome</th>
                      <th className="p-1 text-left border">Ruolo</th>
                      <th className="p-1 text-center border">Allenamenti Presenze</th>
                      <th className="p-1 text-center border">Allenamenti Assenze</th>
                      <th className="p-1 text-center border">% Presenze</th>
                      <th className="p-1 text-center border">Infortuni</th>
                      <th className="p-1 text-center border">Partite Convocato</th>
                      <th className="p-1 text-center border">% Convocazioni</th>
                      <th className="p-1 text-center border">Partite Titolare</th>
                      <th className="p-1 text-center border">% TitolaritÃ </th>
                      <th className="p-1 text-center border">Minuti Totali</th>
                      <th className="p-1 text-center border">Gol</th>
                      <th className="p-1 text-center border">Assist</th>
                      <th className="p-1 text-center border">Gol Subiti</th>
                      <th className="p-1 text-center border">Gialli Gioco</th>
                      <th className="p-1 text-center border">Gialli Protesta</th>
                      <th className="p-1 text-center border">Rossi Gioco</th>
                      <th className="p-1 text-center border">Rossi Protesta</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white">
                    {calculateStats().map(stat => {
                      const totAllenamenti = stat.allenamenti_presenze + stat.allenamenti_assenze;
                      const percPresenze = totAllenamenti > 0 ? ((stat.allenamenti_presenze / totAllenamenti) * 100).toFixed(0) : '-';
                      const totPartite = matches.length;
                      const percConvocazioni = totPartite > 0 ? ((stat.partite_convocato / totPartite) * 100).toFixed(0) : '-';
                      const percTitolarita = totPartite > 0 ? ((stat.partite_titolare / totPartite) * 100).toFixed(0) : '-';
                      
                      return (
                        <tr key={stat.nome} className="border-b hover:bg-gray-50">
                          <td className="p-1 font-bold border">{getNumeroAlfabetico(stat.nome)}</td>
                          <td className="p-1 text-xs border">{stat.nome}</td>
                          <td className="p-1 text-xs border">{stat.ruolo}</td>
                          <td className="p-1 text-center border">{stat.allenamenti_presenze}</td>
                          <td className="p-1 text-center border">{stat.allenamenti_assenze}</td>
                          <td className="p-1 text-center border font-semibold text-blue-600">{percPresenze}{percPresenze !== '-' ? '%' : ''}</td>
                          <td className="p-1 text-center text-red-600 border">{stat.infortuni}</td>
                          <td className="p-1 text-center border">{stat.partite_convocato}</td>
                          <td className="p-1 text-center border font-semibold text-blue-600">{percConvocazioni}{percConvocazioni !== '-' ? '%' : ''}</td>
                          <td className="p-1 text-center border">{stat.partite_titolare}</td>
                          <td className="p-1 text-center border font-semibold text-purple-600">{percTitolarita}{percTitolarita !== '-' ? '%' : ''}</td>
                          <td className="p-1 text-center font-semibold border">{stat.minuti_totali}</td>
                          <td className="p-1 text-center text-green-600 font-bold border">{stat.gol}</td>
                          <td className="p-1 text-center text-blue-600 border">{stat.assist}</td>
                          <td className="p-1 text-center text-red-600 border">{stat.gol_subiti || '-'}</td>
                          <td className="p-1 text-center text-orange-400 border">{stat.gialli_gioco}</td>
                          <td className="p-1 text-center text-red-600 border">{stat.gialli_protesta}</td>
                          <td className="p-1 text-center text-orange-400 border">{stat.rossi_gioco}</td>
                          <td className="p-1 text-center text-red-600 border">{stat.rossi_protesta}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              
              {/* Layout MOBILE - Card */}
              <div className="flex md:hidden flex-1 overflow-auto">
                <div className="w-full space-y-3 pb-4">
                  {calculateStats().map(stat => {
                    const totAllenamenti = stat.allenamenti_presenze + stat.allenamenti_assenze;
                    const percPresenze = totAllenamenti > 0 ? ((stat.allenamenti_presenze / totAllenamenti) * 100).toFixed(0) : '-';
                    const totPartite = matches.length;
                    const percConvocazioni = totPartite > 0 ? ((stat.partite_convocato / totPartite) * 100).toFixed(0) : '-';
                    const percTitolarita = totPartite > 0 ? ((stat.partite_titolare / totPartite) * 100).toFixed(0) : '-';
                    
                    return (
                      <div key={stat.nome} className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-4">
                        {/* Header Card */}
                        <div className="flex items-center gap-3 mb-3 pb-3 border-b-2 border-gray-200">
                          <div className="text-2xl font-bold text-gray-700">#{getNumeroAlfabetico(stat.nome)}</div>
                          <div className="flex-1">
                            <div className="font-bold text-gray-800">{stat.nome}</div>
                            <div className="text-xs text-gray-600">{stat.ruolo}</div>
                          </div>
                        </div>
                        
                        {/* Allenamenti */}
                        <div className="mb-3">
                          <div className="text-xs font-bold text-gray-700 mb-1">ðŸ‹ï¸ ALLENAMENTI</div>
                          <div className="grid grid-cols-3 gap-2 text-xs">
                            <div className="text-center">
                              <div className="text-gray-600">Presenze</div>
                              <div className="font-bold text-green-600">{stat.allenamenti_presenze}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Assenze</div>
                              <div className="font-bold text-red-600">{stat.allenamenti_assenze}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">% Pres.</div>
                              <div className="font-bold text-blue-600">{percPresenze}{percPresenze !== '-' ? '%' : ''}</div>
                            </div>
                          </div>
                          <div className="text-center mt-2">
                            <span className="text-gray-600 text-xs">Infortuni: </span>
                            <span className="font-bold text-red-600">{stat.infortuni}</span>
                          </div>
                        </div>
                        
                        {/* Partite */}
                        <div className="mb-3">
                          <div className="text-xs font-bold text-gray-700 mb-1">âš½ PARTITE</div>
                          <div className="grid grid-cols-3 gap-2 text-xs">
                            <div className="text-center">
                              <div className="text-gray-600">Convocato</div>
                              <div className="font-bold">{stat.partite_convocato}</div>
                              <div className="text-blue-600 font-semibold text-[10px]">{percConvocazioni}{percConvocazioni !== '-' ? '%' : ''}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Titolare</div>
                              <div className="font-bold">{stat.partite_titolare}</div>
                              <div className="text-purple-600 font-semibold text-[10px]">{percTitolarita}{percTitolarita !== '-' ? '%' : ''}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Minuti</div>
                              <div className="font-bold text-blue-700">{stat.minuti_totali}</div>
                            </div>
                          </div>
                        </div>
                        
                        {/* Statistiche Gioco */}
                        <div className="mb-3">
                          <div className="text-xs font-bold text-gray-700 mb-1">ðŸ“Š STATISTICHE</div>
                          <div className="grid grid-cols-3 gap-2 text-xs">
                            <div className="text-center">
                              <div className="text-gray-600">Gol</div>
                              <div className="font-bold text-green-600 text-lg">{stat.gol}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Assist</div>
                              <div className="font-bold text-blue-600 text-lg">{stat.assist}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Gol Sub.</div>
                              <div className="font-bold text-red-600 text-lg">{stat.gol_subiti || '-'}</div>
                            </div>
                          </div>
                        </div>
                        
                        {/* Cartellini */}
                        {(stat.gialli_gioco > 0 || stat.gialli_protesta > 0 || stat.rossi_gioco > 0 || stat.rossi_protesta > 0) && (
                          <div>
                            <div className="text-xs font-bold text-gray-700 mb-1">ðŸŸ¨ðŸŸ¥ CARTELLINI</div>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center justify-between bg-yellow-50 p-2 rounded">
                                <span className="text-gray-700">ðŸŸ¨ Gioco:</span>
                                <span className="font-bold text-orange-600">{stat.gialli_gioco}</span>
                              </div>
                              <div className="flex items-center justify-between bg-red-50 p-2 rounded">
                                <span className="text-gray-700">ðŸŸ¨ Protesta:</span>
                                <span className="font-bold text-red-600">{stat.gialli_protesta}</span>
                              </div>
                              <div className="flex items-center justify-between bg-orange-50 p-2 rounded">
                                <span className="text-gray-700">ðŸŸ¥ Gioco:</span>
                                <span className="font-bold text-orange-600">{stat.rossi_gioco}</span>
                              </div>
                              <div className="flex items-center justify-between bg-red-100 p-2 rounded">
                                <span className="text-gray-700">ðŸŸ¥ Protesta:</span>
                                <span className="font-bold text-red-700">{stat.rossi_protesta}</span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}

{activeTab === 'top' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">ðŸ† Giocatori TOP</h2>
              <p className="text-gray-600 mb-4">I migliori 3 giocatori per ogni categoria</p>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border-2 border-blue-300">
                  <h3 className="text-lg font-bold text-blue-800 mb-3">ðŸŽ¯ Top Presenze Allenamenti</h3>
                  <div className="space-y-2">
                    {calculateStats().sort((a, b) => b.allenamenti_presenze - a.allenamenti_presenze).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-blue-600">{p.allenamenti_presenze}</div>
                          <div className="text-xs text-gray-500">presenze</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border-2 border-green-300">
                  <h3 className="text-lg font-bold text-green-800 mb-3">âš½ Top Gol</h3>
                  <div className="space-y-2">
                    {calculateStats().filter(p => p.gol > 0).sort((a, b) => b.gol - a.gol).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-green-600">{p.gol}</div>
                          <div className="text-xs text-gray-500">gol</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => p.gol > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun gol segnato</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border-2 border-purple-300">
                  <h3 className="text-lg font-bold text-purple-800 mb-3">ðŸŽ¯ Top Assist</h3>
                  <div className="space-y-2">
                    {calculateStats().filter(p => p.assist > 0).sort((a, b) => b.assist - a.assist).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-purple-600">{p.assist}</div>
                          <div className="text-xs text-gray-500">assist</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => p.assist > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun assist</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border-2 border-yellow-300">
                  <h3 className="text-lg font-bold text-yellow-800 mb-3">ðŸŸ¨ Top Cartellini Gialli</h3>
                  <div className="space-y-2">
                    {calculateStats().map(p => ({...p, totGialli: p.gialli_gioco + p.gialli_protesta})).filter(p => p.totGialli > 0).sort((a, b) => b.totGialli - a.totGialli).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-yellow-600">{p.totGialli}</div>
                          <div className="text-xs text-gray-500">gialli</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => (p.gialli_gioco + p.gialli_protesta) > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun cartellino giallo</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border-2 border-red-300">
                  <h3 className="text-lg font-bold text-red-800 mb-3">ðŸŸ¥ Top Cartellini Rossi</h3>
                  <div className="space-y-2">
                    {calculateStats().map(p => ({...p, totRossi: p.rossi_gioco + p.rossi_protesta})).filter(p => p.totRossi > 0).sort((a, b) => b.totRossi - a.totRossi).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-red-600">{p.totRossi}</div>
                          <div className="text-xs text-gray-500">rossi</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => (p.rossi_gioco + p.rossi_protesta) > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun cartellino rosso</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 border-2 border-indigo-300">
                  <h3 className="text-lg font-bold text-indigo-800 mb-3">â±ï¸ Top Minuti Giocati</h3>
                  <div className="space-y-2">
                    {calculateStats().filter(p => p.minuti_totali > 0).sort((a, b) => b.minuti_totali - a.minuti_totali).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-indigo-600">{p.minuti_totali}</div>
                          <div className="text-xs text-gray-500">minuti</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => p.minuti_totali > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun minuto giocato</div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}

{activeTab === 'roster' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Gestione Rosa</h2>
              <div className="space-y-4">
                {players
                  .slice()
                  .sort((a, b) => {
                    if (!a.nome && !b.nome) return a.numero - b.numero;
                    if (!a.nome) return 1;
                    if (!b.nome) return -1;
                    return a.nome.localeCompare(b.nome);
                  })
                  .map((player, index) => (
                  <div key={player.numero} className="bg-white border rounded-lg p-4 card-hover animate-fade-in" style={{animationDelay: `${index * 0.05}s`}}>
                    <div className="flex gap-4">
                      <div className="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0 relative">
                        {player.foto ? (
                          <img 
                            src={player.foto} 
                            alt={player.nome} 
                            className="w-full h-full object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity" 
                            onClick={() => setEnlargedPhoto({ foto: player.foto, nome: player.nome })}
                            title="Clicca per ingrandire"
                          />
                        ) : (
                          <div className="text-gray-400 text-center">
                            <div className="text-3xl font-bold">{player.nome ? index + 1 : player.numero}</div>
                          </div>
                        )}
                        {editingPlayer === player.numero && (
                          <label className="absolute bottom-0 right-0 bg-blue-600 text-white p-1 rounded-tl rounded-br cursor-pointer hover:bg-blue-700">
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageUpload(player.numero, e)}
                              className="hidden"
                            />
                            <span className="text-xs">ðŸ“·</span>
                          </label>
                        )}
                      </div>
                      <div className="flex-1">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Numero</label>
                            <div className="text-xl font-bold text-blue-600">{player.nome ? index + 1 : player.numero}</div>
                          </div>
                          <div className="md:col-span-2">
                            <label className="text-xs font-semibold text-gray-600">Nome Completo</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="text"
                                value={player.nome}
                                onChange={(e) => updatePlayer(player.numero, 'nome', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                                placeholder="Nome e Cognome"
                              />
                            ) : (
                              <div className="flex items-center gap-2">
                                <div className={player.nome ? 'font-semibold' : 'text-gray-400 italic'}>{player.nome || 'Slot libero'}</div>
                                {player.nome && (
                                  <>
                                    {getPlayerInjury(player.numero) ? (
                                      <span className="injury-badge active" title="Infortunato">ðŸ¤•</span>
                                    ) : (
                                      <span className="injury-badge recovered" title="Disponibile">âœ…</span>
                                    )}
                                  </>
                                )}
                              </div>
                            )}
                          </div>
                          
                          {/* Quick Stats - Solo se giocatore attivo */}
                          {player.nome && editingPlayer !== player.numero && (
                            <div className="md:col-span-3 mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                              <div className="grid grid-cols-5 gap-4 text-center">
                                <div>
                                  <div className="text-2xl font-bold text-blue-600">
                                    {matches.reduce((sum, m) => sum + (parseInt(m.golFatti?.[player.numero]) || 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Gol</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-green-600">
                                    {matches.reduce((sum, m) => sum + (parseInt(m.assist?.[player.numero]) || 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Assist</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-purple-600">
                                    {trainings.reduce((sum, t) => sum + (t.presenze[player.numero] ? 1 : 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Allenamenti</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-orange-600">
                                    {matches.reduce((sum, m) => sum + (m.convocati?.[player.numero] ? 1 : 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Convocazioni</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-yellow-600">
                                    {getPlayerMVPCount(player.numero)}
                                  </div>
                                  <div className="text-xs text-gray-600">MVP ðŸ†</div>
                                </div>
                              </div>
                            </div>
                          )}
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Ruolo</label>
                            {editingPlayer === player.numero ? (
                              <select
                                value={player.ruolo}
                                onChange={(e) => updatePlayer(player.numero, 'ruolo', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              >
                                <option value="">Seleziona...</option>
                                <option value="Portiere">Portiere</option>
                                <option value="Difensore centrale">Difensore centrale</option>
                                <option value="Terzino dx">Terzino dx</option>
                                <option value="Terzino sx">Terzino sx</option>
                                <option value="Mediano">Mediano</option>
                                <option value="Centrocampista centrale">Centrocampista centrale</option>
                                <option value="Esterno alto dx">Esterno alto dx</option>
                                <option value="Esterno alto sx">Esterno alto sx</option>
                                <option value="Trequartista">Trequartista</option>
                                <option value="Attaccante">Attaccante</option>
                              </select>
                            ) : (
                              <div className={player.ruolo ? '' : 'text-gray-400 italic'}>{player.ruolo || '-'}</div>
                            )}
                          </div>
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Data di Nascita</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="date"
                                value={player.dataNascita}
                                onChange={(e) => updatePlayer(player.numero, 'dataNascita', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            ) : (
                              <div className={player.dataNascita ? '' : 'text-gray-400 italic'}>
                                {player.dataNascita ? `${player.dataNascita} (${calculateAge(player.dataNascita)} anni)` : '-'}
                              </div>
                            )}
                          </div>
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Piede Preferito</label>
                            {editingPlayer === player.numero ? (
                              <select
                                value={player.piede}
                                onChange={(e) => updatePlayer(player.numero, 'piede', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              >
                                <option value="">Seleziona...</option>
                                <option value="Destro">Destro</option>
                                <option value="Sinistro">Sinistro</option>
                                <option value="Ambidestro">Ambidestro</option>
                              </select>
                            ) : (
                              <div className={player.piede ? '' : 'text-gray-400 italic'}>{player.piede || '-'}</div>
                            )}
                          </div>
                          <div className="md:col-span-2 lg:col-span-3">
                            <label className="text-xs font-semibold text-gray-600">Telefono</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="tel"
                                value={player.telefono}
                                onChange={(e) => updatePlayer(player.numero, 'telefono', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                                placeholder="Numero di telefono"
                              />
                            ) : (
                              <div className={player.telefono ? '' : 'text-gray-400 italic'}>{player.telefono || '-'}</div>
                            )}
                          </div>
                          <div className="md:col-span-2 lg:col-span-3">
                            <label className="text-xs font-semibold text-gray-600">ðŸ“… Data Creazione in Rosa</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="date"
                                value={player.dataCreazione}
                                onChange={(e) => updatePlayer(player.numero, 'dataCreazione', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            ) : (
                              <div className={player.dataCreazione ? 'text-sm' : 'text-gray-400 italic'}>
                                {player.dataCreazione ? `Dal ${new Date(player.dataCreazione).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })}` : 'Non impostata'}
                              </div>
                            )}
                            <div className="text-xs text-gray-500 mt-1">Il giocatore apparirÃ  solo negli allenamenti e partite dalla data indicata</div>
                          </div>
                        </div>
                      </div>
                      <div className="flex flex-col gap-2">
                        {editingPlayer === player.numero ? (
                          <>
                            <button 
                              onClick={() => {
                                setEditingPlayer(null);
                                showToast(`âœ… Giocatore ${player.nome || '#' + player.numero} salvato!`, 'success');
                              }} 
                              className="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 flex items-center gap-1"
                            >
                              <Save size={14} /> Salva
                            </button>
                            <button onClick={() => clearPlayer(player.numero)} className="px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                              Cancella
                            </button>
                          </>
                        ) : (
                          <>
                            <button onClick={() => setEditingPlayer(player.numero)} className="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                              Modifica
                            </button>
                            {player.nome && (
                              <button 
                                onClick={() => downloadPlayerCardPDF(player.numero)} 
                                className="px-3 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 flex items-center justify-center gap-1"
                                title="Genera Report PDF"
                              >
                                ðŸ“„ Report
                              </button>
                            )}
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* ========== SEZIONE ANALISI TATTICA ========== */}
          {activeTab === 'tattica' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">ðŸŽ¯ Analisi Tattica Avversari</h2>
              
              <div className="mb-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg">
                <div className="flex items-start gap-3">
                  <div className="text-purple-600 text-3xl">âš½</div>
                  <div>
                    <p className="font-semibold text-purple-900 mb-2">Analisi Tattica Intelligente</p>
                    <p className="text-sm text-purple-800">
                      Seleziona il modulo di gioco degli avversari e ricevi suggerimenti tattici personalizzati 
                      su quale modulo utilizzare per contrastarli efficacemente, con strategie dettagliate e punti chiave.
                    </p>
                  </div>
                </div>
              </div>

              <div className="mb-8">
                <label className="block text-lg font-bold text-gray-800 mb-3">
                  Seleziona il Modulo degli Avversari
                </label>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {moduliDisponibili.map(modulo => (
                    <button
                      key={modulo.nome}
                      onClick={() => setModuloAvversario(modulo.nome)}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        moduloAvversario === modulo.nome
                          ? 'bg-purple-600 text-white border-purple-600 shadow-lg transform scale-105'
                          : 'bg-white text-gray-800 border-gray-300 hover:border-purple-400 hover:shadow'
                      }`}
                    >
                      <div className="text-2xl font-bold mb-1">{modulo.nome}</div>
                      <div className="text-xs opacity-80">{modulo.descrizione}</div>
                    </button>
                  ))}
                </div>
              </div>

              {moduloAvversario && (() => {
                const analisi = analizzaModuloAvversario(moduloAvversario);
                if (!analisi) return null;

                return (
                  <div className="space-y-6">
                    {/* Punti deboli dell'avversario */}
                    <div className="bg-red-50 border-2 border-red-300 rounded-lg p-6">
                      <h3 className="text-xl font-bold text-red-900 mb-4 flex items-center gap-2">
                        <span className="text-2xl">âš ï¸</span>
                        Punti Deboli del {moduloAvversario}
                      </h3>
                      <ul className="space-y-2">
                        {analisi.puntiDeboli.map((punto, idx) => (
                          <li key={idx} className="flex items-start gap-2">
                            <span className="text-red-600 font-bold mt-1">â€¢</span>
                            <span className="text-red-900">{punto}</span>
                          </li>
                        ))}
                      </ul>
                    </div>

                    {/* Moduli consigliati */}
                    <div>
                      <h3 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span className="text-3xl">ðŸ’¡</span>
                        Moduli Consigliati per Contrastarli
                      </h3>
                      
                      <div className="space-y-6">
                        {analisi.moduliConsigliati.map((consiglio, idx) => (
                          <div 
                            key={idx}
                            className="bg-white border-2 rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-shadow"
                            style={{
                              borderColor: idx === 0 ? '#10b981' : idx === 1 ? '#3b82f6' : '#8b5cf6'
                            }}
                          >
                            {/* Header con efficacia */}
                            <div 
                              className="p-4 text-white"
                              style={{
                                backgroundColor: idx === 0 ? '#10b981' : idx === 1 ? '#3b82f6' : '#8b5cf6'
                              }}
                            >
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                  <span className="text-3xl">
                                    {idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                                  </span>
                                  <div>
                                    <div className="text-2xl font-bold">{consiglio.modulo}</div>
                                    <div className="text-sm opacity-90">
                                      {idx === 0 ? 'Scelta Ottimale' : idx === 1 ? 'Alternativa Valida' : 'Opzione Tattica'}
                                    </div>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className="text-3xl font-bold">{consiglio.efficacia}%</div>
                                  <div className="text-xs opacity-90">Efficacia</div>
                                </div>
                              </div>
                            </div>

                            {/* Contenuto */}
                            <div className="p-6">
                              {/* Motivo principale */}
                              <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <div className="font-semibold text-blue-900 mb-1">ðŸ“‹ PerchÃ© funziona:</div>
                                <div className="text-blue-800">{consiglio.motivo}</div>
                              </div>

                              {/* Vantaggi */}
                              <div className="mb-4">
                                <div className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                  <span className="text-green-600">âœ“</span>
                                  Vantaggi Chiave:
                                </div>
                                <div className="grid md:grid-cols-2 gap-2">
                                  {consiglio.vantaggi.map((vantaggio, vIdx) => (
                                    <div key={vIdx} className="flex items-start gap-2 bg-green-50 p-2 rounded border border-green-200">
                                      <span className="text-green-600 font-bold">âœ“</span>
                                      <span className="text-green-900 text-sm">{vantaggio}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {/* Tattiche specifiche */}
                              <div>
                                <div className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                  <span className="text-purple-600">âš¡</span>
                                  Indicazioni Tattiche:
                                </div>
                                <div className="space-y-2">
                                  {consiglio.tattiche.map((tattica, tIdx) => (
                                    <div key={tIdx} className="flex items-start gap-2 bg-purple-50 p-3 rounded border border-purple-200">
                                      <span className="text-purple-600 font-bold text-lg">{tIdx + 1}.</span>
                                      <span className="text-purple-900">{tattica}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {consiglio.ruoliChiave && consiglio.ruoliChiave.length > 0 && (
                                <div className="mt-6">
                                  <div className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <span className="text-orange-600 text-xl">ðŸ‘¤</span>
                                    Ruoli Chiave - Giocatori Indispensabili:
                                  </div>
                                  <div className="space-y-3">
                                    {consiglio.ruoliChiave.map((ruolo, rIdx) => (
                                      <div key={rIdx} className="bg-gradient-to-r from-orange-50 to-yellow-50 p-4 rounded-lg border-2 border-orange-300">
                                        <div className="flex items-start gap-3 mb-2">
                                          <div className="flex-shrink-0 w-7 h-7 rounded-full bg-orange-600 text-white flex items-center justify-center font-bold text-sm">
                                            {rIdx + 1}
                                          </div>
                                          <div className="flex-1">
                                            <div className="font-bold text-base text-orange-900">{ruolo.ruolo}</div>
                                            <div className="text-xs text-orange-700 font-semibold mt-1">
                                              {ruolo.importanza}
                                            </div>
                                          </div>
                                        </div>
                                        <div className="ml-10">
                                          <div className="text-xs font-semibold text-gray-700 mb-1">Caratteristiche:</div>
                                          <div className="space-y-1">
                                            {ruolo.caratteristiche.map((car, cIdx) => (
                                              <div key={cIdx} className="flex items-start gap-2 text-xs">
                                                <span className="text-orange-600 font-bold">â€¢</span>
                                                <span className="text-gray-800">{car}</span>
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                  <div className="mt-3 p-2 bg-orange-100 rounded border border-orange-300">
                                    <div className="text-xs text-orange-900">
                                      <span className="font-bold">Nota:</span> Per rendere al massimo con questo modulo, assicurati di avere giocatori forti in questi ruoli specifici.
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Rappresentazione tattica su campo */}
                              <div className="mt-6 pt-6 border-t-2 border-gray-200">
                                <div className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                  <span className="text-green-600 text-xl">âš½</span>
                                  Rappresentazione Tattica:
                                </div>
                                <CampoTattico 
                                  moduloNostro={consiglio.modulo} 
                                  moduloAvversario={moduloAvversario}
                                  evidenziaContrasto={true}
                                />
                                <div className="mt-3 p-3 bg-green-50 rounded border border-green-200">
                                  <div className="text-sm text-green-900">
                                    <span className="font-bold">ðŸ’¡ Come leggere il campo:</span> I giocatori in rosso rappresentano gli avversari, 
                                    quelli in blu la tua squadra. Osserva come il tuo modulo {consiglio.modulo} crea superioritÃ  numerica 
                                    nelle zone chiave rispetto al loro {moduloAvversario}.
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Nota finale */}
                    <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">ðŸ’¡</span>
                        <div className="text-sm text-yellow-900">
                          <span className="font-bold">Nota Tattica:</span> Questi suggerimenti sono basati su principi tattici consolidati. 
                          Ricorda di adattare la strategia alle caratteristiche specifiche dei tuoi giocatori e alle condizioni della partita. 
                          La migliore tattica Ã¨ quella che i tuoi giocatori sanno eseguire al meglio!
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}

              {!moduloAvversario && (
                <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                  <div className="text-6xl mb-4">ðŸŽ¯</div>
                  <div className="text-xl font-semibold text-gray-600 mb-2">
                    Seleziona un modulo per iniziare l'analisi
                  </div>
                  <div className="text-gray-500">
                    Scegli il modulo tattico degli avversari per ricevere suggerimenti personalizzati
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ========== SEZIONE DIVISIONE SQUADRE ========== */}
          {activeTab === 'divisione' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">âš–ï¸ Divisione Squadre Equilibrate</h2>
              
              <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="flex items-start gap-3">
                  <div className="text-blue-600 text-2xl">â„¹ï¸</div>
                  <div>
                    <p className="font-semibold text-blue-900 mb-1">Come funziona</p>
                    <p className="text-sm text-blue-800">
                      Il sistema divide automaticamente i giocatori disponibili in squadre equilibrate per ruolo.
                      Ogni squadra avrÃ  un numero simile di portieri, difensori, centrocampisti e attaccanti.
                    </p>
                  </div>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Numero di squadre
                  </label>
                  <select 
                    value={numSquadre}
                    onChange={(e) => setNumSquadre(Number(e.target.value))}
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value={2}>2 squadre</option>
                    <option value={3}>3 squadre</option>
                    <option value={4}>4 squadre</option>
                    <option value={5}>5 squadre</option>
                    <option value={6}>6 squadre</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Portieri
                  </label>
                  <div className="flex items-center space-x-4 p-3 border border-gray-300 rounded-lg">
                    <label className="flex items-center cursor-pointer">
                      <input
                        type="radio"
                        checked={includiPortieri}
                        onChange={() => setIncludiPortieri(true)}
                        className="mr-2 h-4 w-4"
                      />
                      <span>Includi portieri</span>
                    </label>
                    <label className="flex items-center cursor-pointer">
                      <input
                        type="radio"
                        checked={!includiPortieri}
                        onChange={() => setIncludiPortieri(false)}
                        className="mr-2 h-4 w-4"
                      />
                      <span>Escludi portieri</span>
                    </label>
                  </div>
                </div>
              </div>

              <div className="mb-6 bg-gray-50 border rounded-lg p-4">
                <h3 className="font-bold text-gray-800 mb-3">Giocatori Infortunati ({infortunati.size})</h3>
                <p className="text-sm text-gray-600 mb-3">Seleziona i giocatori infortunati da escludere dalla divisione:</p>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-2">
                  {players.filter(p => p.nome).map(player => (
                    <label 
                      key={player.numero}
                      className={`flex items-center p-2 rounded cursor-pointer transition ${
                        infortunati.has(player.nome) 
                          ? 'bg-yellow-100 border-2 border-yellow-400' 
                          : 'bg-white border-2 border-transparent hover:bg-gray-100'
                      }`}
                    >
                      <input
                        type="checkbox"
                        checked={infortunati.has(player.nome)}
                        onChange={() => toggleInfortunato(player.nome)}
                        className="mr-2 h-4 w-4"
                      />
                      <span className="text-sm">{player.nome}</span>
                    </label>
                  ))}
                </div>
              </div>

              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p className="font-semibold text-blue-900 mb-1">ðŸ“Š Informazioni distribuzione</p>
                <p className="text-sm text-blue-800">
                  <span className="font-medium">Giocatori disponibili:</span> <span className="font-bold">{giocatoriDisponibili}</span>
                  <br />
                  <span className="font-medium">Giocatori per squadra:</span> <span className="font-bold">
                    {Math.floor(giocatoriDisponibili / numSquadre)}
                    {giocatoriDisponibili % numSquadre > 0 && ` - ${Math.ceil(giocatoriDisponibili / numSquadre)}`}
                  </span>
                  {showDivisioneResults && (
                    <>
                      <br />
                      <span className={differenzaSquadre <= 1 ? 'text-green-700 font-semibold' : 'text-orange-700 font-semibold'}>
                        âš–ï¸ Totali squadre: {conteggioSquadre.map(s => s.totale).join(', ')}
                        {differenzaSquadre <= 1 ? ' âœ“ PERFETTO' : ' âš ï¸ NON BILANCIATO'}
                      </span>
                    </>
                  )}
                </p>
              </div>

              <div className="flex gap-4 mb-6">
                <button
                  onClick={rigeneraDivisione}
                  className="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition"
                >
                  {showDivisioneResults ? 'ðŸ”„ Rigenera Divisione' : 'âš½ Genera Divisione'}
                </button>
                {showDivisioneResults && (
                  <button
                    onClick={downloadDivisionePDF}
                    className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition"
                  >
                    ðŸ“¥ Scarica PDF Divisione
                  </button>
                )}
              </div>

              {showDivisioneResults && (
                <div className="space-y-6">
                  {dividiSquadre.map((squadra, index) => (
                    <div key={index} className="bg-white rounded-lg shadow-lg overflow-hidden border-2">
                      <div className={`${teamColors[index].bg} text-white p-4`}>
                        <h3 className="text-xl font-bold">
                          SQUADRA {teamColors[index].name} ({conteggioSquadre[index].totale} giocatori)
                        </h3>
                        <div className="mt-2 text-sm flex flex-wrap gap-x-4">
                          {includiPortieri && (
                            <span><span className="font-medium">Portieri:</span> {conteggioSquadre[index].portieri}</span>
                          )}
                          <span><span className="font-medium">Difensori:</span> {conteggioSquadre[index].difensori}</span>
                          <span><span className="font-medium">Centrocampisti:</span> {conteggioSquadre[index].centrocampisti}</span>
                          <span><span className="font-medium">Attaccanti:</span> {conteggioSquadre[index].attaccanti}</span>
                        </div>
                      </div>
                      
                      <div className="p-4">
                        {['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti'].map(ruolo => {
                          if (squadra[ruolo].length === 0) return null;
                          return (
                            <div key={ruolo} className="mb-4">
                              <h4 className="font-bold text-gray-700 mb-2">{ruolo} ({squadra[ruolo].length})</h4>
                              <div className="grid md:grid-cols-2 gap-2">
                                {squadra[ruolo].map(player => (
                                  <div key={player.numero} className="bg-gray-50 p-2 rounded border">
                                    <div className="font-medium">{player.nome}</div>
                                    <div className="text-sm text-gray-600">{player.ruolo}</div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* ========== SEZIONE CONVOCAZIONI ========== */}
          {activeTab === 'convocazioni' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">ðŸ“‹ Convocazioni Partita</h2>
              
              <div className="mb-6 p-4 bg-cyan-50 border border-cyan-200 rounded-lg">
                <div className="flex items-start gap-3">
                  <div className="text-cyan-600 text-2xl">â„¹ï¸</div>
                  <div>
                    <p className="font-semibold text-cyan-900 mb-1">Crea la lista convocati</p>
                    <p className="text-sm text-cyan-800">
                      Seleziona i giocatori da convocare per la prossima partita (max 20) e genera un PDF con la lista ufficiale.
                      Inserisci le informazioni della partita per un documento completo.
                    </p>
                  </div>
                </div>
              </div>

              <div className="mb-6 bg-white border rounded-lg p-4">
                <h3 className="font-bold text-gray-800 mb-4">Informazioni Partita</h3>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Squadra Casa</label>
                    <input
                      type="text"
                      value={infoPartita.squadra1}
                      onChange={(e) => setInfoPartita({...infoPartita, squadra1: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                      placeholder="Es: Real DOR"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Squadra Ospite</label>
                    <input
                      type="text"
                      value={infoPartita.squadra2}
                      onChange={(e) => setInfoPartita({...infoPartita, squadra2: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                      placeholder="Es: Avversari"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Data Partita</label>
                    <input
                      type="date"
                      value={infoPartita.dataPartita}
                      onChange={(e) => setInfoPartita({...infoPartita, dataPartita: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Ora Ritrovo</label>
                    <input
                      type="time"
                      value={infoPartita.oraRitrovo}
                      onChange={(e) => setInfoPartita({...infoPartita, oraRitrovo: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Indirizzo Campo</label>
                    <input
                      type="text"
                      value={infoPartita.indirizzoCompo}
                      onChange={(e) => setInfoPartita({...infoPartita, indirizzoCompo: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                      placeholder="Es: Via dello Sport 123, Brescia"
                    />
                  </div>
                </div>
              </div>

              {['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti', 'Altri'].map(categoria => {
                const giocatori = players.filter(p => 
                  p.nome && mappaRuolo(p.ruolo) === categoria
                );
                if (giocatori.length === 0) return null;
                
                return (
                  <div key={categoria} className="mb-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-3 border-b pb-2">
                      {categoria} ({giocatori.filter(p => convocati.has(p.nome)).length}/{giocatori.length})
                    </h3>
                    <div className="grid md:grid-cols-2 gap-2">
                      {giocatori.map(player => {
                        const isInfortunato = infortunati.has(player.nome);
                        return (
                        <label 
                          key={player.numero}
                          className={`flex items-center p-3 rounded-lg cursor-pointer transition ${
                            convocati.has(player.nome) 
                              ? 'bg-cyan-50 border-2 border-cyan-400' 
                              : 'bg-gray-50 border-2 border-transparent hover:bg-gray-100'
                          } ${isInfortunato ? 'opacity-75' : ''}`}
                        >
                          <input
                            type="checkbox"
                            checked={convocati.has(player.nome)}
                            onChange={() => toggleConvocato(player.nome)}
                            className="mr-3 h-5 w-5 text-cyan-600 rounded"
                          />
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <span className="font-medium text-gray-900">{player.nome}</span>
                              {isInfortunato && (
                                <span className="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full font-semibold">
                                  ðŸ¤• INFORTUNATO
                                </span>
                              )}
                            </div>
                            <div className="text-sm text-gray-500">{player.ruolo}</div>
                          </div>
                        </label>
                      )})}
                    </div>
                  </div>
                );
              })}

              <div className="sticky bottom-0 bg-white border-t-2 border-gray-200 p-4 -mx-6 -mb-6 mt-6">
                <div className="flex justify-between items-center">
                  <span className="text-gray-700 font-medium text-lg">
                    {convocati.size} / 20 giocatori convocati
                  </span>
                  <button
                    onClick={downloadConvocazioni}
                    disabled={convocati.size === 0}
                    className={`py-3 px-8 rounded-lg font-semibold transition ${
                      convocati.size === 0
                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        : 'bg-cyan-600 text-white hover:bg-cyan-700'
                    }`}
                  >
                    ðŸ“¥ Scarica PDF Convocazione
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>

        {showInstructionsModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
              <div className="p-6 border-b sticky top-0 bg-white">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold text-gray-800">ðŸ“– Istruzioni d'uso</h3>
                  <button
                    onClick={() => setShowInstructionsModal(false)}
                    className="text-gray-600 hover:text-gray-800 text-2xl"
                  >
                    âœ•
                  </button>
                </div>
              </div>
              
              <div className="p-6 space-y-6">
                <div className="bg-green-50 border-2 border-green-400 rounded-lg p-4">
                  <h4 className="font-bold text-green-800 mb-2">âœ… SALVATAGGIO AUTOMATICO ATTIVO</h4>
                  <p className="text-green-900 text-sm">
                    Tutti i dati vengono salvati automaticamente sul tuo dispositivo ogni volta che apporti modifiche. Non devi fare nulla! L'app funziona anche offline.
                  </p>
                </div>

                <div className="border-l-4 border-blue-500 pl-4">
                  <h4 className="font-bold text-blue-800 mb-3 text-lg">ðŸ“± 1. GESTIONE ROSA</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Aggiungi giocatori:</strong> Clicca "Aggiungi Giocatore" e compila nome, ruolo, numero maglia</li>
                    <li><strong>Foto giocatore:</strong> Clicca sull'icona ðŸ“· per aggiungere foto dal dispositivo (si comprime automaticamente)</li>
                    <li><strong>Modifica:</strong> Clicca "Modifica" per aggiornare i dati, poi "Salva" per confermare</li>
                    <li><strong>Infortuni:</strong> Segna i giocatori infortunati cliccando sull'icona ðŸ¤•</li>
                    <li><strong>Logo squadra:</strong> Clicca sul logo in alto per caricarne uno personalizzato</li>
                  </ul>
                </div>

                <div className="border-l-4 border-green-500 pl-4">
                  <h4 className="font-bold text-green-800 mb-3 text-lg">âš½ 2. ALLENAMENTI</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Crea allenamento:</strong> Clicca "Aggiungi Nuovo Allenamento" e seleziona la data</li>
                    <li><strong>Presenze:</strong> Segna P (Presente), A (Assente), o I (Infortunato) per ogni giocatore</li>
                    <li><strong>Lista presenze PDF:</strong> Clicca "ðŸ“‹ Stampa Lista Presenze" per generare un foglio da compilare sul campo</li>
                    <li><strong>Statistiche:</strong> Le presenze vengono conteggiate automaticamente nelle statistiche</li>
                  </ul>
                </div>

                <div className="border-l-4 border-purple-500 pl-4">
                  <h4 className="font-bold text-purple-800 mb-3 text-lg">âš–ï¸ 3. DIVISIONE SQUADRE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Squadre equilibrate:</strong> Seleziona i giocatori disponibili e scegli il numero di squadre (2-6)</li>
                    <li><strong>Algoritmo automatico:</strong> Il sistema divide i giocatori per creare squadre bilanciate</li>
                    <li><strong>PDF stampabile:</strong> Genera un PDF con le squadre divise da portare in campo</li>
                    <li><strong>Perfetto per:</strong> Partitelle in allenamento, tornei interni, allenamenti specifici</li>
                  </ul>
                </div>

                <div className="border-l-4 border-red-500 pl-4">
                  <h4 className="font-bold text-red-800 mb-3 text-lg">ðŸ† 4. PARTITE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Crea partita:</strong> Clicca "Aggiungi Nuova Partita", compila avversario, data e campo</li>
                    <li><strong>Convoca giocatori:</strong> Seleziona i convocati e scegli i titolari (max 11)</li>
                    <li><strong>ModalitÃ  Live âš¡:</strong> Durante la partita, usa la modalitÃ  live per registrare tutto in tempo reale</li>
                    <li><strong>Eventi live:</strong> Registra gol, assist, cartellini gialli/rossi, sostituzioni (max 5)</li>
                    <li><strong>Timer:</strong> Timer integrato con tempo di recupero e avviso sonoro a fine tempo</li>
                    <li><strong>Modulo tattico:</strong> Scegli il modulo (4-4-2, 4-3-3, 3-5-2, ecc.) e visualizza lo schema</li>
                  </ul>
                </div>

                <div className="border-l-4 border-indigo-500 pl-4">
                  <h4 className="font-bold text-indigo-800 mb-3 text-lg">ðŸŽ¯ 5. ANALISI TATTICA</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Studia avversari:</strong> Inserisci il modulo dell'avversario per vedere i punti deboli</li>
                    <li><strong>Moduli consigliati:</strong> Il sistema suggerisce i 3 moduli migliori con efficacia in %</li>
                    <li><strong>Tattiche dettagliate:</strong> Per ogni modulo consigliato trovi vantaggi, tattiche e contromosse</li>
                    <li><strong>Ruoli chiave:</strong> Scopri quali giocatori sono fondamentali e che caratteristiche devono avere</li>
                    <li><strong>8 moduli disponibili:</strong> 4-4-2, 4-3-3, 3-5-2, 4-2-3-1, 3-4-3, 5-3-2, 4-1-4-1, 4-3-1-2</li>
                  </ul>
                </div>

                <div className="border-l-4 border-cyan-500 pl-4">
                  <h4 className="font-bold text-cyan-800 mb-3 text-lg">ðŸ“‹ 6. CONVOCAZIONI</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Lista convocati:</strong> Seleziona fino a 20 giocatori per la prossima partita</li>
                    <li><strong>Infortunati:</strong> Puoi convocare anche gli infortunati (sono evidenziati con badge rosso)</li>
                    <li><strong>Info partita:</strong> Inserisci squadre, data, ora ritrovo e indirizzo campo</li>
                    <li><strong>PDF ufficiale:</strong> Genera un PDF professionale con tutti i dettagli da stampare e distribuire</li>
                  </ul>
                </div>

                <div className="border-l-4 border-yellow-500 pl-4">
                  <h4 className="font-bold text-yellow-800 mb-3 text-lg">ðŸ“Š 7. STATISTICHE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Dati completi:</strong> Presenze allenamenti, partite giocate, minuti, gol, assist, cartellini</li>
                    <li><strong>Percentuali:</strong> % convocazioni, % titolaritÃ , media minuti, media gol per partita</li>
                    <li><strong>Ordinamento:</strong> Clicca sulle intestazioni delle colonne per ordinare i dati</li>
                    <li><strong>Calcolo automatico:</strong> Le statistiche si aggiornano automaticamente ad ogni evento</li>
                  </ul>
                </div>

                <div className="border-l-4 border-orange-500 pl-4">
                  <h4 className="font-bold text-orange-800 mb-3 text-lg">ðŸ† 8. GIOCATORI TOP</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Classifiche automatiche:</strong> Top 10 per ogni categoria prestazionale</li>
                    <li><strong>Categorie:</strong> Presenze, minuti giocati, gol segnati, assist forniti, MVP stagione</li>
                    <li><strong>Motivazione:</strong> Usa queste classifiche per premiare i migliori e motivare la squadra</li>
                  </ul>
                </div>

                <div className="border-l-4 border-gray-500 pl-4">
                  <h4 className="font-bold text-gray-800 mb-3 text-lg">ðŸ’¾ 9. GESTIONE BACKUP</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Esporta JSON:</strong> Scarica un backup di tutti i dati in formato JSON</li>
                    <li><strong>Importa JSON:</strong> Carica un backup per trasferire dati su altro dispositivo</li>
                    <li><strong>Cloud storage:</strong> Salva il backup su Google Drive/Dropbox per sicurezza extra</li>
                    <li><strong>Sincronizza:</strong> Usa backup per sincronizzare tra PC e tablet</li>
                    <li><strong>Note:</strong> Il backup Ã¨ opzionale, i dati sono giÃ  salvati automaticamente</li>
                  </ul>
                </div>

                <div className="border-l-4 border-red-600 pl-4">
                  <h4 className="font-bold text-red-800 mb-3 text-lg">ðŸ”„ 10. RESET DATABASE - NUOVA STAGIONE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Reset Stagione (consigliato):</strong> Cancella allenamenti/partite ma mantiene la rosa giocatori</li>
                    <li><strong>Reset Completo:</strong> Cancella tutto e ricomincia da zero (usa con cautela!)</li>
                    <li><strong>Procedura consigliata:</strong> Fai backup â†’ Reset Stagione â†’ Riparti con stessa squadra</li>
                    <li><strong>Sicurezza:</strong> Multiple conferme prima di ogni operazione di reset</li>
                  </ul>
                </div>

                <div className="bg-blue-50 border-2 border-blue-400 rounded-lg p-4 mt-6">
                  <h4 className="font-bold text-blue-800 mb-2">ðŸ’¡ CONSIGLI PRATICI</h4>
                  <ul className="list-disc ml-6 text-sm text-blue-900 space-y-1">
                    <li>Usa il tablet durante le partite per la modalitÃ  Live</li>
                    <li>Stampa le liste presenze prima degli allenamenti</li>
                    <li>Studia i moduli avversari prima delle partite importanti</li>
                    <li>Scarica backup periodici come sicurezza</li>
                    <li>Usa le classifiche TOP per motivare i giocatori</li>
                    <li>Al cambio stagione: Backup â†’ Reset Stagione â†’ Continua</li>
                  </ul>
                </div>

                <div className="bg-purple-50 border-2 border-purple-400 rounded-lg p-4">
                  <h4 className="font-bold text-purple-800 mb-2">ðŸ“± COMPATIBILITÃ€</h4>
                  <p className="text-purple-900 text-sm">
                    <strong>PC:</strong> Chrome, Firefox, Edge, Safari<br/>
                    <strong>Tablet/Smartphone:</strong> Android, iOS, iPad<br/>
                    <strong>Offline:</strong> Funziona senza connessione internet<br/>
                    <strong>Sincronizzazione:</strong> Usa backup JSON per trasferire dati tra dispositivi
                  </p>
                </div>
              </div>

              <div className="p-6 border-t bg-gray-50">
                <button
                  onClick={() => setShowInstructionsModal(false)}
                  className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                >
                  Ho capito, iniziamo!
                </button>
              </div>
            </div>
          </div>
        )}

        {liveMatchMode && (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
            <div className="min-h-screen flex items-start justify-center p-4">
              <div className="bg-white rounded-lg shadow-2xl max-w-6xl w-full my-8 max-h-[calc(100vh-4rem)] flex flex-col">
                {(() => {
                  const match = matches.find(m => m.id === liveMatchMode);
                  
                  const sortByDistinta = (players) => {
                    return players.sort((a, b) => {
                      const posizioni = match.posizioneVisualizzazione || {};
                      const ordineDistinta = match.ordineDistinta || {};
                      
                      let ordineA = parseInt(posizioni[a.numero]);
                      if (!ordineA || isNaN(ordineA)) {
                        if (match.entrati && match.entrati[a.numero]) {
                          const dettaglio = (match.sostituzioniDettaglio || {})[a.numero];
                          if (dettaglio && dettaglio.alPostoDi) {
                            ordineA = parseInt(posizioni[dettaglio.alPostoDi]);
                          }
                        }
                        
                        if (!ordineA || isNaN(ordineA)) {
                          ordineA = parseInt(ordineDistinta[a.numero] || a.numero);
                        }
                      }
                      
                      let ordineB = parseInt(posizioni[b.numero]);
                      if (!ordineB || isNaN(ordineB)) {
                        if (match.entrati && match.entrati[b.numero]) {
                          const dettaglio = (match.sostituzioniDettaglio || {})[b.numero];
                          if (dettaglio && dettaglio.alPostoDi) {
                            ordineB = parseInt(posizioni[dettaglio.alPostoDi]);
                          }
                        }
                        
                        if (!ordineB || isNaN(ordineB)) {
                          ordineB = parseInt(ordineDistinta[b.numero] || b.numero);
                        }
                      }
                      
                      if (ordineA === ordineB) return a.numero - b.numero;
                      return ordineA - ordineB;
                    });
                  };
                  
                  // âœ… CORREZIONE BUG: I giocatori sostituiti ora appaiono in panchina
                  const inCampo = sortByDistinta(players.filter(p => 
                    (match.titolari[p.numero] || match.entrati[p.numero]) && !match.sostituzioni[p.numero]
                  ));
                  
                  const panchina = sortByDistinta(players.filter(p => 
                    ((match.convocati[p.numero] && !match.titolari[p.numero] && !match.entrati[p.numero]) ||
                     match.sostituzioni[p.numero]) &&
                    !match.rossi_gioco[p.numero] &&
                    !match.rossi_protesta[p.numero]
                  ));
                  
                  return (
                    <>
                      <div className="flex-shrink-0 sticky top-0 z-20">
                        <div className="p-4 border-b bg-gradient-to-r from-green-600 to-blue-600 text-white">
                          <div className="flex justify-between items-center">
                            <div>
                              <h3 className="text-2xl font-bold">âš¡ MODALITÃ€ LIVE</h3>
                              <p className="text-sm">{match.squadraCasa} vs {match.squadraTrasferta}</p>
                              <div className="flex items-center gap-6 mt-2">
                                <div className="text-4xl font-bold">
                                  ðŸ“Š {(() => {
                                    const golFatti = Object.values(match.golFatti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                    const golSubiti = Object.values(match.golSubiti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                    const realDorInCasa = match.squadraCasa && match.squadraCasa.toLowerCase().includes('real dor');
                                    const golCasa = realDorInCasa ? golFatti : golSubiti;
                                    const golTrasferta = realDorInCasa ? golSubiti : golFatti;
                                    return `${golCasa} - ${golTrasferta}`;
                                  })()}
                                </div>
                                <div className={`px-4 py-2 rounded-lg font-bold text-lg ${
                                  (() => {
                                    const numSost = Object.values(match.sostituzioni || {}).filter(v => v === true).length;
                                    if (numSost >= 5) return 'bg-red-600 animate-pulse';
                                    if (numSost === 4) return 'bg-yellow-600 animate-pulse';
                                    return 'bg-blue-600';
                                  })()
                                }`}>
                                  ðŸ”„ Sostituzioni: {Object.values(match.sostituzioni || {}).filter(v => v === true).length}/5
                                </div>
                              </div>
                            </div>
                            <div className="flex gap-2">
                              {matchEnded && (() => {
                                const golFatti = Object.values(match.golFatti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                const golSubiti = Object.values(match.golSubiti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                const realDorInCasa = match.squadraCasa && match.squadraCasa.toLowerCase().includes('real dor');
                                const golCasa = realDorInCasa ? golFatti : golSubiti;
                                const golTrasferta = realDorInCasa ? golSubiti : golFatti;
                                const abbiamovinto = golCasa > golTrasferta;
                                
                                if (abbiamovinto) {
                                  return (
                                    <button 
                                      onClick={() => setShowVictoryCelebration(true)} 
                                      className="px-6 py-3 bg-yellow-400 text-black rounded-lg hover:bg-yellow-500 font-black text-lg animate-pulse shadow-lg border-4 border-yellow-600"
                                    >
                                      ðŸŽ‰ VITTORIA! ðŸŽ‰
                                    </button>
                                  );
                                }
                                return null;
                              })()}
                              <button onClick={closeLiveMatch} className="px-4 py-2 bg-white text-gray-800 rounded-lg hover:bg-gray-100 font-semibold">
                                âœ• Chiudi
                              </button>
                            </div>
                          </div>
                        </div>

                        <div className="p-2 bg-gray-900 text-white shadow-xl border-b border-gray-700">
                        <div className="flex items-center justify-center gap-4">
                          <div className="flex items-center gap-3">
                            <div className="flex flex-col items-center gap-1">
                              <div className="flex items-center gap-2">
                                <div className={`px-3 py-1 rounded-lg font-bold text-sm ${halfTime === 1 ? 'bg-green-600' : 'bg-gray-600'}`}>
                                  1Â° TEMPO
                                </div>
                                <div className={`px-3 py-1 rounded-lg font-bold text-sm ${halfTime === 2 ? 'bg-green-600' : 'bg-gray-600'}`}>
                                  2Â° TEMPO
                                </div>
                              </div>
                              <div className="text-xs font-semibold opacity-70">TEMPO REGOLAMENTARE</div>
                              <div className="text-4xl font-bold font-mono">{formatTime(matchTimer)}</div>
                              {!matchEnded && (
                                <div className="flex gap-2">
                                  {!isTimerRunning ? (
                                    <button 
                                      onClick={startTimer} 
                                      disabled={(halfTime === 1 && matchTimer >= 2700) || (halfTime === 2 && matchTimer >= 5400)} 
                                      className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                      â–¶ Start
                                    </button>
                                  ) : (
                                    <button onClick={pauseTimer} className="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold">
                                      â¸ Pausa
                                    </button>
                                  )}
                                </div>
                              )}
                            </div>
                            {!matchEnded && (
                              <div className="flex flex-col gap-1">
                                <button onClick={addMinute} className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xl">â–²</button>
                                <button onClick={removeMinute} className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xl">â–¼</button>
                              </div>
                            )}
                          </div>

                          <div className="flex items-center gap-4 border-l-2 border-white pl-6">
                            <div className="flex flex-col items-center gap-2">
                              <div className="text-sm font-semibold opacity-70">RECUPERO</div>
                              <div className={`text-4xl font-bold font-mono ${
                                (matchTimer >= 2700 && halfTime === 1) || (matchTimer >= 5400 && halfTime === 2) 
                                  ? 'text-yellow-400' 
                                  : 'text-gray-600'
                              }`}>
                                +{formatTime(recoveryTime)}
                              </div>
                              {((matchTimer >= 2700 && halfTime === 1) || (matchTimer >= 5400 && halfTime === 2)) && (
                                <div className="flex items-center gap-2">
                                  <label className="text-xs opacity-70">Min previsti:</label>
                                  <input
                                    type="number"
                                    min="0"
                                    max="15"
                                    value={recoveryMinutes}
                                    onChange={(e) => setRecoveryMinutes(e.target.value)}
                                    placeholder="Min"
                                    className="w-12 px-2 py-1 bg-gray-800 border border-gray-600 rounded text-center text-white placeholder-gray-500"
                                  />
                                </div>
                              )}
                              {!matchEnded && isRecoveryRunning && (
                                <button onClick={() => setIsRecoveryRunning(false)} className="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold text-sm">
                                  â¸ Pausa
                                </button>
                              )}
                              {!matchEnded && !isRecoveryRunning && ((matchTimer >= 2700 && halfTime === 1) || (matchTimer >= 5400 && halfTime === 2)) && (
                                <button onClick={() => setIsRecoveryRunning(true)} className="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold text-sm">
                                  â–¶ Riprendi
                                </button>
                              )}
                            </div>
                            {!matchEnded && matchTimer >= 2700 && (
                              <div className="flex flex-col gap-1">
                                <button onClick={addRecoveryMinute} className="px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-xl">â–²</button>
                                <button onClick={removeRecoveryMinute} className="px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-xl">â–¼</button>
                              </div>
                            )}
                          </div>

                          {!matchEnded && (
                            <div className="border-l-2 border-white pl-6 flex flex-col gap-2">
                              {halfTime === 1 && matchTimer >= 2700 && (
                                <button onClick={() => {
                                  showConfirm('â±ï¸ PASSA AL 2Â° TEMPO\n\nVuoi passare al secondo tempo?\nIl recupero del 1Â° tempo verrÃ  azzerato.\n\nConfermi?', () => {
                                    setHalfTime(2);
                                    setMatchTimer(2700);
                                    setRecoveryTime(0);
                                    setRecoveryMinutes('');
                                    setIsRecoveryRunning(false);
                                    setIsTimerRunning(false);
                                  });
                                }} className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm">
                                  â© 2Â° TEMPO
                                </button>
                              )}
                              <button onClick={() => {
                                showConfirm('â±ï¸ AZZERA TIMER\n\nIl timer verrÃ  resettato a 0:00 (inizio 1Â° tempo).\n\nConfermi?', () => {
                                  setMatchTimer(0);
                                  setIsTimerRunning(false);
                                  setRecoveryTime(0);
                                  setIsRecoveryRunning(false);
                                  setHalfTime(1);
                                  setRecoveryMinutes('');
                                  setMatchEnded(false);
                                });
                              }} className="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold text-sm">
                                â±ï¸ AZZERA
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                      </div>

                        {/* ========== TIMELINE EVENTI PARTITA ========== */}
                        <div className="p-1 bg-white border-b border-gray-200">
                          <h4 className="text-xs font-bold text-gray-800 mb-0.5">â±ï¸ Timeline Eventi</h4>
                          <div className="relative">
                            {/* Linea temporale */}
                            <div className="absolute left-0 right-0 top-3 h-1 bg-gray-300 rounded"></div>
                            <div className="absolute left-0 top-3 h-1 bg-green-500 rounded" style={{ width: `${(matchTimer / 5400) * 100}%` }}></div>
                            
                            {/* Eventi sulla timeline */}
                            <div className="relative pt-3 min-h-[100px]">
                              {/* Marker inizio e fine */}
                              <div className="absolute left-0 top-0 flex flex-col items-center">
                                <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                <div className="text-xs text-gray-600 mt-1">0'</div>
                              </div>
                              <div className="absolute right-0 top-0 flex flex-col items-center">
                                <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                <div className="text-xs text-gray-600 mt-1">90'</div>
                              </div>
                              
                              {/* STEP 4: Eventi da match.timeline */}
                              {(match.timeline || []).map((evento, idx) => {
                                // Calcola posizione basata su minuto
                                let position = 5; // default all'inizio
                                
                                if (evento.minuto !== null && evento.minuto !== undefined) {
                                  // Usa minuto esatto se disponibile
                                  position = (parseInt(evento.minuto) / 90) * 100;
                                } else {
                                  // Altrimenti distribuzione uniforme
                                  const allEvents = match.timeline || [];
                                  const eventIndex = allEvents.findIndex(e => e.id === evento.id);
                                  position = ((eventIndex + 1) / (allEvents.length + 1)) * 100;
                                }
                                
                                // FIX: Calcola offset verticale per eventi allo stesso minuto
                                const eventsAtSameMinute = (match.timeline || []).filter((e, i) => {
                                  if (evento.minuto !== null && evento.minuto !== undefined) {
                                    return e.minuto === evento.minuto && i <= idx;
                                  }
                                  return false;
                                });
                                const verticalOffset = (eventsAtSameMinute.length - 1) * 28; // 28px di offset per ogni evento
                                
                                // Determina icona e colore
                                let icon = 'ðŸ“Œ';
                                let bgColor = 'bg-gray-500';
                                
                                if (evento.tipo === 'gol') {
                                  icon = 'âš½';
                                  bgColor = 'bg-green-500';
                                } else if (evento.tipo === 'golsubito') {
                                  icon = 'ðŸ”´';
                                  bgColor = 'bg-red-600';
                                } else if (evento.tipo === 'assist') {
                                  icon = 'ðŸŽ¯';
                                  bgColor = 'bg-blue-500';
                                } else if (evento.tipo === 'giallo') {
                                  icon = 'ðŸŸ¨';
                                  bgColor = 'bg-yellow-400';
                                } else if (evento.tipo === 'rosso') {
                                  icon = 'ðŸŸ¥';
                                  bgColor = 'bg-red-500';
                                } else {
                                  return null; // Non mostrare eventi sconosciuti
                                }
                                
                                return (
                                  <div 
                                    key={evento.id || `evento-${idx}`}
                                    className="absolute flex flex-col items-center"
                                    style={{ 
                                      left: `${Math.min(position, 95)}%`,
                                      top: `${verticalOffset}px`
                                    }}
                                    title={`${evento.playerNome} (${evento.tipo})`}
                                  >
                                    <div className={`w-4 h-4 ${bgColor} rounded-full flex items-center justify-center text-white text-xs font-bold`}>
                                      {icon}
                                    </div>
                                    <div className="text-xs text-gray-800 mt-1 whitespace-nowrap font-semibold">
                                      {evento.playerNome.split(' ')[0]}
                                    </div>
                                  </div>
                                );
                              })}
                              
                              {/* Sostituzioni sulla timeline */}
                              {Object.entries(match.sostituzioniDettaglio || {}).map(([playerNum, dettaglio]) => {
                                if (!dettaglio.minuto) return null;
                                
                                // Mostra solo per chi esce (sostituito), non duplicare per chi entra
                                if (!dettaglio.sostituito) return null;
                                
                                const position = (parseInt(dettaglio.minuto) / 90) * 100;
                                
                                // Trova giocatori
                                const playerOut = players.find(p => p.numero === parseInt(playerNum));
                                const playerIn = players.find(p => p.numero === dettaglio.sostituitoreDa);
                                
                                if (!playerOut || !playerIn) return null;
                                
                                // Estrai cognomi
                                const cognomeOut = playerOut.nome.split(' ')[0];
                                const cognomeIn = playerIn.nome.split(' ')[0];
                                
                                return (
                                  <div 
                                    key={`sost-${playerNum}`}
                                    className="absolute top-0 flex flex-col items-center"
                                    style={{ left: `${Math.min(position, 95)}%` }}
                                  >
                                    <div className="w-4 h-4 bg-yellow-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                      ðŸ”„
                                    </div>
                                    <div className="text-xs mt-1 whitespace-nowrap font-semibold">
                                      <div className="text-red-600">{cognomeOut}</div>
                                      <div className="text-green-600">{cognomeIn}</div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                          
                          {/* Legenda Timeline */}
                          <div className="flex items-center gap-2 justify-center mt-1 text-xs flex-wrap pb-1">
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                              <span>Gol</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                              <span>Assist</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-red-600 rounded-full"></div>
                              <span>Gol Subiti</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-yellow-400 rounded"></div>
                              <span>Gialli</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-red-500 rounded"></div>
                              <span>Rossi</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
                              <span>Sostituzioni</span>
                            </div>
                          </div>
                        </div>

                      <div className="flex-1 overflow-y-auto">
                        <div className="p-4">
                        {substitutionMode && (
                          <div className="mb-4 p-4 bg-orange-100 border-2 border-orange-400 rounded-lg">
                            <div className="flex justify-between">
                              <div>
                                <h5 className="font-bold text-orange-800">ðŸ”„ SOSTITUZIONE IN CORSO</h5>
                                <p className="text-sm text-orange-700">Esce: #{substitutionMode} - {players.find(p => p.numero === substitutionMode)?.nome}</p>
                              </div>
                              <button onClick={cancelSubstitution} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                                âœ• Annulla
                              </button>
                            </div>
                          </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                          <div>
                            <h4 className="text-lg font-bold mb-3 text-green-700">âš½ IN CAMPO ({inCampo.length}/11)</h4>
                            <div className="space-y-2">
                              {inCampo.map(player => {
                                const isExpelled = (match.rossi_gioco[player.numero] > 0 || match.rossi_protesta[player.numero] > 0);
                                return (
                                <div key={player.numero} className={`border-2 rounded-lg p-3 relative ${
                                  isExpelled ? 'bg-gray-200 border-gray-400 opacity-40' :
                                  match.sostituzioni[player.numero] ? 'bg-red-200 border-red-500' : 
                                  substitutionMode === player.numero ? 'bg-orange-200 border-orange-600' : 
                                  match.entrati[player.numero] ? 'bg-blue-400 border-blue-700' : 'bg-green-100 border-green-400'
                                }`}
                                  style={isExpelled ? { pointerEvents: 'none' } : {}}
                                >
                                  {isExpelled && (
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30">
                                      <div className="bg-red-600 text-white font-black text-4xl px-6 py-3 rounded-lg shadow-2xl border-4 border-red-800" style={{textShadow: '2px 2px 4px rgba(0,0,0,0.8)'}}>
                                        ESPULSO
                                      </div>
                                    </div>
                                  )}
                                  <div className="flex justify-between mb-2 relative z-20">
                                    <div className="flex items-center gap-2">
                                      <span className="text-xl font-bold">#{(match.ordineDistinta || {})[player.numero] || player.numero}</span>
                                      <span className="font-semibold">{player.nome}</span>
                                      {match.entrati[player.numero] && (() => {
                                        const dettaglio = (match.sostituzioniDettaglio || {})[player.numero];
                                        if (dettaglio && dettaglio.alPostoDi) {
                                          const sostituito = players.find(p => p.numero === dettaglio.alPostoDi);
                                          return (
                                            <span className="px-2 py-1 bg-green-700 text-white rounded font-bold text-xs">
                                              â†‘ ENTRATO al posto di #{dettaglio.alPostoDi} {sostituito ? sostituito.nome : ''}
                                            </span>
                                          );
                                        }
                                        return <span className="px-2 py-1 bg-green-700 text-white rounded font-bold text-xs">â†‘ ENTRATO</span>;
                                      })()}
                                      {match.sostituzioni[player.numero] && (() => {
                                        const dettaglio = (match.sostituzioniDettaglio || {})[player.numero];
                                        if (dettaglio && dettaglio.sostituitoreDa) {
                                          const sostitutore = players.find(p => p.numero === dettaglio.sostituitoreDa);
                                          return (
                                            <span className="px-2 py-1 bg-red-700 text-white rounded font-bold text-xs">
                                              â†“ SOSTITUITO da #{dettaglio.sostituitoreDa} {sostitutore ? sostitutore.nome : ''}
                                            </span>
                                          );
                                        }
                                        return null;
                                      })()}
                                      {(match.gialli_gioco[player.numero] > 0 || match.gialli_protesta[player.numero] > 0) && !match.rossi_gioco[player.numero] && !match.rossi_protesta[player.numero] && (
                                        <span className="px-2 py-1 bg-yellow-400 text-black rounded font-bold animate-pulse text-xs">âš ï¸ AMMONITO</span>
                                      )}
                                    </div>
                                    <div className="flex gap-1 text-xs">
                                      {player.ruolo === 'Portiere' ? (
                                        <span className="px-2 py-1 bg-red-600 text-white rounded font-bold">âš½ Subiti: {match.golSubiti[player.numero] || 0}</span>
                                      ) : (
                                        <>
                                          <span className="px-2 py-1 bg-green-600 text-white rounded">âš½ {match.golFatti[player.numero] || 0}</span>
                                          <span className="px-2 py-1 bg-blue-600 text-white rounded">ðŸŽ¯ {match.assist[player.numero] || 0}</span>
                                        </>
                                      )}
                                    </div>
                                  </div>
                                  {!substitutionMode && (
                                    <div className="flex gap-2 flex-wrap relative z-20">
                                      {player.ruolo === 'Portiere' ? (
                                        <>
                                          <button onClick={() => quickAddGoalConceded(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="flex-1 px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">
                                            âš½ GOL SUBITO
                                          </button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">ðŸŸ¨</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">ðŸŸ¥</button>
                                        </>
                                      ) : (
                                        <>
                                          <button onClick={() => quickAddGoal(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold text-sm">âš½ GOL</button>
                                          <button onClick={() => quickAddAssist(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold text-sm">ðŸŽ¯ ASSIST</button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">ðŸŸ¨</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">ðŸŸ¥</button>
                                        </>
                                      )}
                                    </div>
                                  )}
                                  {!match.sostituzioni[player.numero] && !substitutionMode && (
                                    <button onClick={() => initiateSubstitution(player.numero)} className="w-full mt-2 px-3 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 font-semibold text-sm relative z-20">
                                      ðŸ”„ SOSTITUISCI
                                    </button>
                                  )}
                                </div>
                              );})}
                            </div>
                          </div>

                          <div>
                            <h4 className="text-lg font-bold mb-3 text-gray-700">ðŸª‘ PANCHINA</h4>
                            <div className="space-y-2">
                              {panchina.map(player => {
                                const isExpelled = (match.rossi_gioco[player.numero] > 0 || match.rossi_protesta[player.numero] > 0);
                                const isSubstituted = match.sostituzioni[player.numero];
                                return (
                                <div key={player.numero} className={`border-2 rounded-lg p-3 relative ${
                                  isExpelled || isSubstituted ? 'bg-gray-200 border-gray-400 opacity-40' :
                                  match.entrati[player.numero] ? 'bg-blue-400 border-blue-700' : 
                                  substitutionMode ? 'bg-yellow-100 border-yellow-400 cursor-pointer hover:border-yellow-600' : 'bg-gray-100 border-gray-300'
                                }`}
                                  onClick={() => {
                                    if (substitutionMode && !match.entrati[player.numero] && !isSubstituted && !isExpelled) {
                                      completeSubstitution(liveMatchMode, substitutionMode, player.numero);
                                    }
                                  }}
                                  style={(isSubstituted || isExpelled) ? { pointerEvents: 'none' } : {}}
                                >
                                  {isExpelled && (
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30">
                                      <div className="bg-red-600 text-white font-black text-3xl px-4 py-2 rounded-lg shadow-2xl border-4 border-red-800" style={{textShadow: '2px 2px 4px rgba(0,0,0,0.8)'}}>
                                        ESPULSO
                                      </div>
                                    </div>
                                  )}
                                  <div className="flex justify-between mb-2 relative z-20">
                                    <div className="flex items-center gap-2">
                                      <span className="text-xl font-bold">#{(match.ordineDistinta || {})[player.numero] || player.numero}</span>
                                      <span className="font-semibold">{player.nome}</span>
                                      {match.sostituzioni[player.numero] && (() => {
                                        const dettaglio = (match.sostituzioniDettaglio || {})[player.numero];
                                        if (dettaglio && dettaglio.sostituitoreDa) {
                                          const sostitutore = players.find(p => p.numero === dettaglio.sostituitoreDa);
                                          return (
                                            <span className="px-2 py-1 bg-red-700 text-white rounded font-bold text-xs">
                                              â†“ SOSTITUITO da #{dettaglio.sostituitoreDa} {sostitutore ? sostitutore.nome : ''}
                                            </span>
                                          );
                                        }
                                        return <span className="px-2 py-1 bg-red-600 text-white rounded font-bold text-xs">â†“ SOSTITUITO</span>;
                                      })()}
                                      {match.entrati[player.numero] && (match.gialli_gioco[player.numero] > 0 || match.gialli_protesta[player.numero] > 0) && !match.rossi_gioco[player.numero] && (
                                        <span className="px-2 py-1 bg-yellow-400 text-black rounded font-bold animate-pulse text-xs">âš ï¸ AMMONITO</span>
                                      )}
                                    </div>
                                    {match.entrati[player.numero] && !match.sostituzioni[player.numero] && (
                                      <div className="flex gap-1 text-xs">
                                        <span className="px-2 py-1 bg-green-700 text-white rounded font-semibold">â†‘ ENTRATO</span>
                                        {player.ruolo === 'Portiere' ? (
                                          <span className="px-2 py-1 bg-red-600 text-white rounded font-bold">âš½ Subiti: {match.golSubiti[player.numero] || 0}</span>
                                        ) : (
                                          <>
                                            <span className="px-2 py-1 bg-green-600 text-white rounded">âš½ {match.golFatti[player.numero] || 0}</span>
                                            <span className="px-2 py-1 bg-blue-600 text-white rounded">ðŸŽ¯ {match.assist[player.numero] || 0}</span>
                                          </>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                  {!match.entrati[player.numero] && !substitutionMode && (
                                    <button 
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        showConfirm(`â–¶ Confermi l'INGRESSO IN CAMPO di ${player.nome} (#${player.numero})?`, () => {
                                          updateMatch(liveMatchMode, 'entrati', { ...match.entrati, [player.numero]: true });
                                        });
                                      }} 
                                      className="w-full px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold text-sm relative z-20"
                                    >
                                      â–¶ ENTRA IN CAMPO
                                    </button>
                                  )}
                                  {match.entrati[player.numero] && !substitutionMode && (
                                    <div className="flex gap-2 flex-wrap mt-2 relative z-20">
                                      {player.ruolo === 'Portiere' ? (
                                        <>
                                          <button onClick={() => quickAddGoalConceded(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="flex-1 px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">âš½ GOL SUBITO</button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">ðŸŸ¨</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">ðŸŸ¥</button>
                                        </>
                                      ) : (
                                        <>
                                          <button onClick={() => quickAddGoal(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold text-sm">âš½ GOL</button>
                                          <button onClick={() => quickAddAssist(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold text-sm">ðŸŽ¯ ASSIST</button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">ðŸŸ¨</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">ðŸŸ¥</button>
                                        </>
                                      )}
                                    </div>
                                  )}
                                </div>
                              );})}
                            </div>
                          </div>
                        </div>
                      </div>
                      </div>
                    </>
                  );
                })()}
              </div>
            </div>
          </div>
        )}

        {/* ============================================ */}
        {/* TAB CALENDARIO - NUOVO */}
        {/* ============================================ */}
        {activeTab === 'calendar' && (
          <div className="animate-fade-in">
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ“… Calendario Eventi</h2>
              <p className="text-gray-600">Vista mensile di allenamenti e partite programmate</p>
            </div>

            {/* Controlli Mese/Anno */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6 border-2 border-gray-200">
              <div className="flex items-center justify-between mb-4">
                <button
                  onClick={() => {
                    if (selectedMonth === 0) {
                      setSelectedMonth(11);
                      setSelectedYear(selectedYear - 1);
                    } else {
                      setSelectedMonth(selectedMonth - 1);
                    }
                  }}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  â† Mese Prec.
                </button>
                <h3 className="text-2xl font-bold text-gray-800">
                  {new Date(selectedYear, selectedMonth).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}
                </h3>
                <button
                  onClick={() => {
                    if (selectedMonth === 11) {
                      setSelectedMonth(0);
                      setSelectedYear(selectedYear + 1);
                    } else {
                      setSelectedMonth(selectedMonth + 1);
                    }
                  }}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Mese Succ. â†’
                </button>
              </div>

              {/* Calendario Grid */}
              <div className="calendar-grid mb-4">
                {['L', 'M', 'M', 'G', 'V', 'S', 'D'].map((day, idx) => (
                  <div key={idx} className="text-center font-bold text-gray-600 p-2">
                    {day}
                  </div>
                ))}
                
                {/* Giorni vuoti iniziali */}
                {Array.from({ length: getFirstDayOfMonth(selectedMonth, selectedYear) === 0 ? 6 : getFirstDayOfMonth(selectedMonth, selectedYear) - 1 }).map((_, idx) => (
                  <div key={`empty-${idx}`} className="calendar-day opacity-0"></div>
                ))}
                
                {/* Giorni del mese */}
                {Array.from({ length: getDaysInMonth(selectedMonth, selectedYear) }).map((_, idx) => {
                  const day = idx + 1;
                  const date = new Date(selectedYear, selectedMonth, day);
                  const dateStr = date.toISOString().split('T')[0];
                  const events = getEventsForDate(date);
                  const isToday = new Date().toDateString() === date.toDateString();
                  const hasEvents = events.trainings.length > 0 || events.matches.length > 0;
                  
                  return (
                    <div
                      key={day}
                      className={`calendar-day ${isToday ? 'today' : ''} ${hasEvents ? 'has-event' : ''}`}
                      onClick={() => {
                        if (hasEvents) {
                          setSelectedDate(date);
                          setShowEventModal(true);
                        }
                      }}
                    >
                      <div className="font-semibold mb-1">{day}</div>
                      <div className="space-y-1">
                        {events.trainings.length > 0 && (
                          <div className="text-xs bg-blue-200 text-blue-800 rounded px-1">
                            ðŸƒ {events.trainings.length}
                          </div>
                        )}
                        {events.matches.length > 0 && (
                          <div className="text-xs bg-green-200 text-green-800 rounded px-1">
                            âš½ {events.matches.length}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Legenda */}
              <div className="flex items-center gap-4 justify-center text-sm">
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 bg-blue-200 rounded"></div>
                  <span>ðŸƒ Allenamento</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 bg-green-200 rounded"></div>
                  <span>âš½ Partita</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 bg-blue-100 border-2 border-blue-600 rounded"></div>
                  <span>ðŸ“… Oggi</span>
                </div>
              </div>
            </div>

            {/* Prossimi Eventi */}
            <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
              <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“‹ Prossimi Eventi</h3>
              <div className="space-y-3">
                {[...trainings, ...matches]
                  .filter(e => new Date(e.data) >= new Date())
                  .sort((a, b) => new Date(a.data) - new Date(b.data))
                  .slice(0, 5)
                  .map((event, idx) => {
                    const isMatch = event.squadraCasa !== undefined;
                    return (
                      <div key={idx} className={`flex items-center justify-between p-3 rounded-lg ${isMatch ? 'bg-green-50 border-2 border-green-200' : 'bg-blue-50 border-2 border-blue-200'}`}>
                        <div className="flex items-center gap-3">
                          <div className="text-3xl">{isMatch ? 'âš½' : 'ðŸƒ'}</div>
                          <div>
                            <div className="font-semibold text-gray-800">
                              {isMatch ? `${event.squadraCasa} vs ${event.squadraTrasferta}` : 'Allenamento'}
                            </div>
                            <div className="text-sm text-gray-600">
                              {new Date(event.data).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}
                            </div>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm font-semibold text-gray-700">
                            {Math.ceil((new Date(event.data) - new Date()) / (1000 * 60 * 60 * 24))} giorni
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>
          </div>
        )}

        {/* Modal Eventi Giorno */}
        {showEventModal && selectedDate && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto animate-scale-up">
              <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold">
                    ðŸ“… {selectedDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                  </h3>
                  <button
                    onClick={() => setShowEventModal(false)}
                    className="text-white hover:text-gray-200 text-3xl font-bold"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6">
                {(() => {
                  const events = getEventsForDate(selectedDate);
                  return (
                    <div className="space-y-4">
                      {events.trainings.length > 0 && (
                        <div>
                          <h4 className="text-lg font-bold text-gray-800 mb-3">ðŸƒ Allenamenti ({events.trainings.length})</h4>
                          {events.trainings.map(t => (
                            <div key={t.id} className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-2">
                              <div className="font-semibold text-gray-800 mb-2">Presenze: {Object.values(t.presenze).filter(p => p).length}/{players.filter(p => p.nome).length}</div>
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {events.matches.length > 0 && (
                        <div>
                          <h4 className="text-lg font-bold text-gray-800 mb-3">âš½ Partite ({events.matches.length})</h4>
                          {events.matches.map(m => (
                            <div key={m.id} className="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-2">
                              <div className="font-bold text-lg text-gray-800 mb-2">
                                {m.squadraCasa} vs {m.squadraTrasferta}
                              </div>
                              {m.risultato && (
                                <div className="text-2xl font-bold text-green-600">{m.risultato}</div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {events.trainings.length === 0 && events.matches.length === 0 && (
                        <div className="text-center text-gray-500 py-8">
                          Nessun evento in questa data
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
            </div>
          </div>
        )}

        {/* ============================================ */}
        {/* TAB GESTIONE INFORTUNI - NUOVO */}
        {/* ============================================ */}
        {activeTab === 'injuries' && (
          <div className="animate-fade-in">
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ¤• Gestione Infortuni</h2>
              <p className="text-gray-600">Traccia e gestisci gli infortuni dei giocatori</p>
            </div>

            {/* Pulsante Nuovo Infortunio */}
            <div className="mb-6">
              <button
                onClick={() => setShowInjuryModal(true)}
                className="flex items-center gap-2 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold"
              >
                <Plus size={20} />
                Registra Nuovo Infortunio
              </button>
            </div>

            {/* Statistiche Infortuni */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg shadow-lg p-6 border-2 border-red-200">
                <div className="text-4xl mb-2">ðŸ¤•</div>
                <div className="text-3xl font-bold text-red-600">{getActiveInjuries().length}</div>
                <div className="text-gray-700 font-semibold">Infortuni Attivi</div>
              </div>
              
              <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow-lg p-6 border-2 border-yellow-200">
                <div className="text-4xl mb-2">ðŸ“ˆ</div>
                <div className="text-3xl font-bold text-yellow-600">
                  {injuries.filter(i => i.status === 'recovering').length}
                </div>
                <div className="text-gray-700 font-semibold">In Recupero</div>
              </div>
              
              <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200">
                <div className="text-4xl mb-2">âœ…</div>
                <div className="text-3xl font-bold text-green-600">
                  {injuries.filter(i => i.status === 'recovered').length}
                </div>
                <div className="text-gray-700 font-semibold">Recuperati</div>
              </div>
            </div>

            {/* Lista Infortuni Attivi */}
            {getActiveInjuries().length > 0 && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6 border-2 border-red-200">
                <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸš¨ Infortuni Attivi</h3>
                <div className="space-y-4">
                  {getActiveInjuries().map(injury => {
                    const daysSince = Math.floor((new Date() - new Date(injury.startDate)) / (1000 * 60 * 60 * 24));
                    const daysUntil = Math.ceil((new Date(injury.estimatedReturn) - new Date()) / (1000 * 60 * 60 * 24));
                    const totalDays = Math.ceil((new Date(injury.estimatedReturn) - new Date(injury.startDate)) / (1000 * 60 * 60 * 24));
                    const progress = Math.min(100, Math.max(0, (daysSince / totalDays) * 100));
                    
                    return (
                      <div key={injury.id} className="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                              <h4 className="text-lg font-bold text-gray-800">{injury.playerName}</h4>
                              <span className="text-sm text-gray-600">#{injury.playerNum}</span>
                            </div>
                            <div className="space-y-1 text-sm text-gray-700">
                              <div><strong>Tipo:</strong> {injury.type}</div>
                              <div><strong>Dal:</strong> {new Date(injury.startDate).toLocaleDateString('it-IT')}</div>
                              <div><strong>Rientro stimato:</strong> {new Date(injury.estimatedReturn).toLocaleDateString('it-IT')} 
                                <span className="ml-2 font-semibold text-red-600">
                                  ({daysUntil > 0 ? `${daysUntil} giorni` : 'Oggi o passato'})
                                </span>
                              </div>
                              {injury.notes && <div><strong>Note:</strong> {injury.notes}</div>}
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => updateInjuryStatus(injury.id, 'recovering')}
                              className="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm"
                              title="Segna come in recupero"
                            >
                              ðŸ“ˆ
                            </button>
                            <button
                              onClick={() => updateInjuryStatus(injury.id, 'recovered')}
                              className="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm"
                              title="Segna come recuperato"
                            >
                              âœ…
                            </button>
                            <button
                              onClick={() => removeInjury(injury.id)}
                              className="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm"
                              title="Rimuovi"
                            >
                              ðŸ—‘ï¸
                            </button>
                          </div>
                        </div>
                        
                        {/* Progress Bar Recupero */}
                        <div className="mt-3">
                          <div className="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Progresso recupero</span>
                            <span>{progress.toFixed(0)}%</span>
                          </div>
                          <div className="progress-bar">
                            <div 
                              className="progress-bar-fill"
                              style={{
                                width: `${progress}%`,
                                background: progress < 33 ? '#ef4444' : progress < 66 ? '#f59e0b' : '#10b981'
                              }}
                            ></div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Tutti gli Infortuni (con filtro stato) */}
            <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
              <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“‹ Storico Completo</h3>
              {injuries.length === 0 ? (
                <div className="text-center text-gray-500 py-8">
                  Nessun infortunio registrato
                </div>
              ) : (
                <div className="space-y-3">
                  {injuries.map(injury => (
                    <div key={injury.id} className={`rounded-lg p-4 border-2 ${
                      injury.status === 'active' ? 'bg-red-50 border-red-200' :
                      injury.status === 'recovering' ? 'bg-yellow-50 border-yellow-200' :
                      'bg-green-50 border-green-200'
                    }`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <span className={`injury-badge ${injury.status}`}>
                            {injury.status === 'active' ? 'ðŸ¤• Attivo' :
                             injury.status === 'recovering' ? 'ðŸ“ˆ Recupero' :
                             'âœ… Recuperato'}
                          </span>
                          <div>
                            <div className="font-semibold text-gray-800">{injury.playerName} #{injury.playerNum}</div>
                            <div className="text-sm text-gray-600">{injury.type}</div>
                          </div>
                        </div>
                        <div className="text-sm text-gray-600">
                          {new Date(injury.startDate).toLocaleDateString('it-IT')} â†’ {new Date(injury.estimatedReturn).toLocaleDateString('it-IT')}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Modal Nuovo Infortunio */}
        {showInjuryModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full animate-scale-up">
              <div className="bg-gradient-to-r from-red-600 to-red-800 text-white p-6 rounded-t-lg">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold">ðŸ¤• Registra Nuovo Infortunio</h3>
                  <button
                    onClick={() => {
                      setShowInjuryModal(false);
                      setSelectedPlayerForInjury(null);
                    }}
                    className="text-white hover:text-gray-200 text-3xl font-bold"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6">
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Giocatore</label>
                    <select
                      value={selectedPlayerForInjury || ''}
                      onChange={(e) => setSelectedPlayerForInjury(parseInt(e.target.value))}
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    >
                      <option value="">Seleziona giocatore...</option>
                      {players.filter(p => p.nome).map(p => (
                        <option key={p.numero} value={p.numero}>
                          #{p.numero} - {p.nome}
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Tipo di Infortunio</label>
                    <input
                      type="text"
                      id="injuryType"
                      placeholder="Es: Distorsione caviglia, Stiramento muscolare..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    />
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Data Inizio</label>
                      <input
                        type="date"
                        id="injuryStartDate"
                        defaultValue={new Date().toISOString().split('T')[0]}
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Rientro Stimato</label>
                      <input
                        type="date"
                        id="injuryReturnDate"
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Note (opzionale)</label>
                    <textarea
                      id="injuryNotes"
                      rows="3"
                      placeholder="Descrizione, trattamenti, raccomandazioni..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    ></textarea>
                  </div>
                  
                  <button
                    onClick={() => {
                      if (!selectedPlayerForInjury) {
                        showToast('Seleziona un giocatore!', 'warning');
                        return;
                      }
                      
                      const type = document.getElementById('injuryType').value;
                      const startDate = document.getElementById('injuryStartDate').value;
                      const returnDate = document.getElementById('injuryReturnDate').value;
                      const notes = document.getElementById('injuryNotes').value;
                      
                      if (!type || !returnDate) {
                        showToast('Compila tutti i campi obbligatori!', 'warning');
                        return;
                      }
                      
                      addInjury(selectedPlayerForInjury, {
                        type,
                        startDate,
                        estimatedReturn: returnDate,
                        notes
                      });
                      
                      setShowInjuryModal(false);
                      setSelectedPlayerForInjury(null);
                    }}
                    className="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold"
                  >
                    Registra Infortunio
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Votazione MVP */}
        {showMVPModal && selectedMatchForMVP && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-3xl w-full animate-scale-up max-h-[90vh] overflow-y-auto">
              {(() => {
                const match = matches.find(m => m.id === selectedMatchForMVP);
                if (!match) return null;
                
                const convocati = players.filter(p => match.convocati[p.numero]);
                
                return (
                  <>
                    <div className="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-6 rounded-t-lg sticky top-0 z-10">
                      <div className="flex justify-between items-center">
                        <div>
                          <h3 className="text-2xl font-bold">ðŸ† Man of the Match</h3>
                          <p className="text-yellow-100 mt-1">
                            {match.squadraCasa} vs {match.squadraTrasferta}
                          </p>
                        </div>
                        <button
                          onClick={() => {
                            setShowMVPModal(false);
                            setSelectedMatchForMVP(null);
                          }}
                          className="text-white hover:text-yellow-200 text-3xl font-bold"
                        >
                          Ã—
                        </button>
                      </div>
                    </div>
                    
                    <div className="p-6">
                      <div className="mb-4">
                        <p className="text-gray-600 text-center">
                          Chi Ã¨ stato il migliore in campo? â­
                        </p>
                      </div>
                      
                      {convocati.length === 0 ? (
                        <div className="text-center py-8 text-gray-500">
                          Nessun giocatore convocato per questa partita
                        </div>
                      ) : (
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                          {convocati.map(player => {
                            const isCurrentMVP = match.mvp === player.numero;
                            const gol = match.golFatti[player.numero] || 0;
                            const assist = match.assist[player.numero] || 0;
                            
                            return (
                              <button
                                key={player.numero}
                                onClick={() => assignMVP(match.id, player.numero)}
                                className={`relative p-4 rounded-lg border-2 transition-all hover:scale-105 ${
                                  isCurrentMVP
                                    ? 'bg-gradient-to-br from-yellow-100 to-yellow-200 border-yellow-500 shadow-lg'
                                    : 'bg-white border-gray-200 hover:border-yellow-400 hover:shadow-md'
                                }`}
                              >
                                {isCurrentMVP && (
                                  <div className="absolute -top-2 -right-2 bg-yellow-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg animate-pulse-slow">
                                    ðŸ†
                                  </div>
                                )}
                                
                                <div className="flex flex-col items-center">
                                  {player.foto ? (
                                    <img
                                      src={player.foto}
                                      alt={player.nome}
                                      className="w-16 h-16 rounded-full object-cover mb-2 border-2 border-gray-200"
                                    />
                                  ) : (
                                    <div className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mb-2 border-2 border-gray-300">
                                      <span className="text-2xl font-bold text-gray-500">
                                        {player.numero}
                                      </span>
                                    </div>
                                  )}
                                  
                                  <div className="text-center">
                                    <p className="font-bold text-sm text-gray-800 mb-1">
                                      {player.nome.split(' ')[0]}
                                    </p>
                                    <p className="text-xs text-gray-600 mb-2 line-clamp-2">
                                      {player.nome}
                                    </p>
                                    
                                    {(gol > 0 || assist > 0) && (
                                      <div className="flex justify-center gap-2 text-xs">
                                        {gol > 0 && (
                                          <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded">
                                            âš½ {gol}
                                          </span>
                                        )}
                                        {assist > 0 && (
                                          <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                                            ðŸŽ¯ {assist}
                                          </span>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      )}
                      
                      {match.mvp && (
                        <div className="mt-6 pt-6 border-t border-gray-200">
                          <button
                            onClick={() => {
                              removeMVP(match.id);
                              setShowMVPModal(false);
                              setSelectedMatchForMVP(null);
                            }}
                            className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg transition-colors font-semibold"
                          >
                            ðŸ”„ Rimuovi MVP
                          </button>
                        </div>
                      )}
                    </div>
                  </>
                );
              })()}
            </div>
          </div>
        )}

        {activeTab === 'export' && (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">ðŸ’¾ Esportazioni e Backup</h2>
            
            {/* ========== SEZIONE ESPORTAZIONI ========== */}
            <div>
              <h3 className="text-xl font-bold text-gray-700 mb-4">ðŸ“Š Esportazioni</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-6 border-2 border-blue-200">
                  <div className="text-4xl mb-4">ðŸ“Š</div>
                  <h3 className="text-xl font-bold text-gray-800 mb-2">Report Stagionale</h3>
                  <p className="text-gray-600 text-sm mb-4">
                    Esporta un report completo con tutte le statistiche della stagione in PDF
                  </p>
                  <button
                    onClick={downloadSeasonReportPDF}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    Scarica Report PDF
                  </button>
                </div>
                
                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200">
                  <div className="text-4xl mb-4">ðŸ‘¤</div>
                  <h3 className="text-xl font-bold text-gray-800 mb-2">Scheda Giocatore</h3>
                  <p className="text-gray-600 text-sm mb-4">
                    Esporta la scheda dettagliata di un singolo giocatore con tutte le sue statistiche
                  </p>
                  <select 
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-3"
                    id="playerSelect"
                  >
                    <option value="">Seleziona giocatore...</option>
                    {players.filter(p => p.nome).map(p => (
                      <option key={p.numero} value={p.numero}>#{p.numero} - {p.nome}</option>
                    ))}
                  </select>
                  <button
                    onClick={() => {
                      const select = document.getElementById('playerSelect');
                      const playerNum = parseInt(select.value);
                      if (playerNum) {
                        downloadPlayerCardPDF(playerNum);
                      } else {
                        alert('Seleziona un giocatore!');
                      }
                    }}
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    Scarica Scheda PDF
                  </button>
                </div>
                
                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-lg p-6 border-2 border-purple-200">
                  <div className="text-4xl mb-4">ðŸ’¾</div>
                  <h3 className="text-xl font-bold text-gray-800 mb-2">Backup Completo</h3>
                  <p className="text-gray-600 text-sm mb-4">
                    Scarica un backup completo di tutti i dati in formato JSON
                  </p>
                  <button
                    onClick={downloadBackupJSON}
                    className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    Scarica Backup JSON
                  </button>
                </div>
              </div>
              
              <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-6 mt-6">
                <div className="flex items-start gap-3">
                  <div className="text-2xl">â„¹ï¸</div>
                  <div>
                    <h4 className="font-bold text-gray-800 mb-2">Note sulle esportazioni:</h4>
                    <ul className="text-sm text-gray-700 space-y-1">
                      <li>â€¢ Il <strong>Report Stagionale</strong> include statistiche generali, top marcatori, assist e rosa completa</li>
                      <li>â€¢ La <strong>Scheda Giocatore</strong> contiene foto, dati anagrafici e statistiche dettagliate individuali</li>
                      <li>â€¢ Il <strong>Backup JSON</strong> puÃ² essere reimportato in seguito per ripristinare tutti i dati</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            {/* ========== SEZIONE BACKUP E RESET ========== */}
            <div className="pt-6 border-t-4 border-gray-200">
              <h3 className="text-xl font-bold text-gray-700 mb-4">ðŸ’¾ Gestione Backup e Reset Stagione</h3>
              
              <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
                <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ’¾ Gestione Backup (Opzionale)</h3>
                <div className="mb-4 p-4 bg-green-50 border-2 border-green-400 rounded-lg">
                  <p className="font-bold text-green-800 mb-2">âœ… I tuoi dati sono salvati automaticamente sul dispositivo</p>
                  <p className="text-sm text-green-900">
                    Usa queste funzioni solo se vuoi:
                  </p>
                  <ul className="list-disc ml-6 mt-2 text-sm text-green-900">
                    <li><strong>Trasferire i dati</strong> su un altro dispositivo</li>
                    <li><strong>Creare un backup</strong> di sicurezza su cloud (Google Drive, Dropbox, ecc.)</li>
                    <li><strong>Ripristinare</strong> dati da un file di backup precedente</li>
                  </ul>
                </div>
                <div className="flex gap-4 flex-wrap">
                  <label className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors cursor-pointer">
                    <Download size={20} className="rotate-180" />
                    ðŸ“± Importa da File JSON
                    <input
                      type="file"
                      accept=".json,application/json,text/plain"
                      onChange={handleFileImport}
                      className="hidden"
                      multiple={false}
                    />
                  </label>
                  <button
                    onClick={() => setShowManualImport(true)}
                    className="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors"
                  >
                    ðŸ“‹ Importa Manualmente
                  </button>
                  <button
                    onClick={exportToJSON}
                    className="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors"
                  >
                    <Download size={20} />
                    ðŸ’¾ Scarica Backup JSON
                  </button>
                </div>
              </div>

              <div className="bg-white rounded-lg shadow-xl p-6 border-2 border-red-200">
                <h3 className="text-xl font-bold text-red-700 mb-4">ðŸ”´ Reset Database - Nuova Stagione</h3>
                <div className="mb-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                  <p className="font-bold text-red-800 mb-2">âš ï¸ ATTENZIONE: Operazioni Permanenti</p>
                  <p className="text-sm text-red-900">
                    Usa queste funzioni solo quando devi iniziare una nuova stagione o resettare completamente l'app.
                  </p>
                  <p className="text-sm text-red-900 font-bold mt-2">
                    ðŸ’¡ CONSIGLIO: Crea un backup prima di resettare!
                  </p>
                </div>
                
                <div className="space-y-4">
                  <div className="p-4 bg-orange-50 border-2 border-orange-300 rounded-lg">
                    <h4 className="font-bold text-orange-900 mb-2">ðŸ”„ Reset Stagione (consigliato)</h4>
                    <p className="text-sm text-orange-800 mb-3">
                      Cancella allenamenti, partite e statistiche ma <strong>mantiene la rosa giocatori</strong> e il logo.
                      Ideale per iniziare una nuova stagione con la stessa squadra.
                    </p>
                    <button
                      onClick={resetStagione}
                      className="w-full flex items-center justify-center gap-2 bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors font-semibold"
                    >
                      ðŸ”„ Reset Stagione (mantieni rosa)
                    </button>
                  </div>
                  
                  <div className="p-4 bg-red-50 border-2 border-red-400 rounded-lg">
                    <h4 className="font-bold text-red-900 mb-2">ðŸ”´ Reset Completo (pericoloso)</h4>
                    <p className="text-sm text-red-800 mb-3">
                      Cancella <strong>TUTTO</strong>: giocatori, allenamenti, partite, statistiche, logo.
                      L'app tornerÃ  come nuova. Usa solo se vuoi ricominciare da zero.
                    </p>
                    <button
                      onClick={resetCompleto}
                      className="w-full flex items-center justify-center gap-2 bg-red-700 text-white px-6 py-3 rounded-lg hover:bg-red-800 transition-colors font-semibold"
                    >
                      ðŸ”´ Reset Completo (cancella tutto)
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {showManualImport && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[80vh] flex flex-col">
              <div className="p-6 border-b">
                <h3 className="text-2xl font-bold text-gray-800">ðŸ“‹ Importa Manualmente</h3>
                <p className="text-blue-600 font-bold text-lg mt-2">INCOLLA QUI IL CONTENUTO DEL FILE JSON</p>
                <p className="text-gray-600 mt-1 text-sm">Apri il file JSON con un editor di testo, seleziona tutto (Ctrl+A o Cmd+A) e incolla qui sotto</p>
              </div>
              
              <div className="flex-1 overflow-auto p-6">
                <textarea
                  value={manualImportData}
                  onChange={(e) => setManualImportData(e.target.value)}
                  placeholder='Incolla qui il contenuto del file JSON...'
                  className="w-full h-full min-h-[400px] p-4 border rounded-lg font-mono text-sm"
                />
              </div>
              
              <div className="p-6 border-t flex gap-3 justify-end">
                <button
                  onClick={handleManualImport}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                >
                  âœ… Importa Dati
                </button>
                <button
                  onClick={() => {
                    setShowManualImport(false);
                    setManualImportData('');
                  }}
                  className="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-semibold"
                >
                  Annulla
                </button>
              </div>
            </div>
          </div>
        )}

        {/* ============================================ */}
        {/* TAB SINCRONIZZAZIONE CLOUD */}
        {/* ============================================ */}
        {activeTab === 'sync' && (
          <div className="animate-fade-in">
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">â˜ï¸ Sincronizzazione Cloud</h2>
              <p className="text-gray-600">Gestisci la sincronizzazione dei dati tra dispositivo locale e cloud Firebase</p>
            </div>

            {/* Status Card */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 mb-6 border-2 border-blue-200">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-gray-800">Stato Sincronizzazione</h3>
                {syncStatus === 'syncing' && (
                  <div className="spinner"></div>
                )}
                {syncStatus === 'success' && (
                  <span className="text-green-600 text-2xl animate-pulse">âœ…</span>
                )}
                {syncStatus === 'error' && (
                  <span className="text-red-600 text-2xl animate-shake">âŒ</span>
                )}
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-sm text-gray-600 mb-1">Ultimo Salvataggio Locale</div>
                  <div className="text-lg font-bold text-gray-800">
                    {lastSaved ? lastSaved.toLocaleString('it-IT') : 'Mai salvato'}
                  </div>
                </div>
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-sm text-gray-600 mb-1">Ultima Sincronizzazione Cloud</div>
                  <div className="text-lg font-bold text-gray-800">
                    {lastSynced ? lastSynced.toLocaleString('it-IT') : 'Mai sincronizzato'}
                  </div>
                </div>
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-sm text-gray-600 mb-1">Sync Automatico</div>
                  <div className="text-lg font-bold">
                    {autoSyncEnabled ? (
                      <span className="text-green-600">âœ… Attivo</span>
                    ) : (
                      <span className="text-gray-500">â¸ï¸ Disattivo</span>
                    )}
                  </div>
                </div>
              </div>

              {syncError && (
                <div className="bg-red-100 border-2 border-red-300 rounded-lg p-4 mb-4">
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">âš ï¸</span>
                    <div>
                      <div className="font-bold text-red-800 mb-1">Errore di Sincronizzazione</div>
                      <div className="text-sm text-red-700">{syncError}</div>
                    </div>
                  </div>
                </div>
              )}

              <div className="flex items-center justify-between bg-white rounded-lg p-4 shadow">
                <div>
                  <div className="font-bold text-gray-800">Sincronizzazione Automatica</div>
                  <div className="text-sm text-gray-600">
                    {autoSyncEnabled ? 'Sincronizza ogni 5 minuti automaticamente' : 'Sincronizzazione manuale'}
                  </div>
                </div>
                <button
                  onClick={toggleAutoSync}
                  className={`px-6 py-3 rounded-lg font-bold transition-all ${
                    autoSyncEnabled 
                      ? 'bg-green-600 hover:bg-green-700 text-white' 
                      : 'bg-gray-400 hover:bg-gray-500 text-white'
                  }`}
                >
                  {autoSyncEnabled ? 'âœ… Attivo' : 'â¸ï¸ Disattivo'}
                </button>
              </div>
            </div>

            {/* Azioni di Sincronizzazione */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              
              {/* Sync Intelligente */}
              <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-6 border-2 border-blue-200">
                <div className="text-4xl mb-4">ðŸ”„</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Sincronizzazione Intelligente</h3>
                <p className="text-gray-600 text-sm mb-4">
                  Sincronizza automaticamente scegliendo la versione piÃ¹ recente tra locale e cloud
                </p>
                <button
                  onClick={smartSync}
                  disabled={syncStatus === 'syncing'}
                  className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {syncStatus === 'syncing' ? 'â³ Sincronizzazione...' : 'ðŸ”„ Sincronizza Ora'}
                </button>
              </div>

              {/* Upload Cloud */}
              <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200">
                <div className="text-4xl mb-4">â˜ï¸â†‘</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Carica su Cloud</h3>
                <p className="text-gray-600 text-sm mb-4">
                  Carica forzatamente i dati locali sul cloud, sovrascrivendo quelli presenti
                </p>
                <button
                  onClick={() => {
                    if (window.confirm('âš ï¸ Questa operazione sovrascriverÃ  i dati nel cloud con quelli locali.\n\nSei sicuro?')) {
                      syncToFirestore();
                    }
                  }}
                  disabled={syncStatus === 'syncing'}
                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {syncStatus === 'syncing' ? 'â³ Caricamento...' : 'â˜ï¸ Carica su Cloud'}
                </button>
              </div>

              {/* Download Cloud */}
              <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg shadow-lg p-6 border-2 border-orange-200">
                <div className="text-4xl mb-4">â˜ï¸â†“</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Scarica da Cloud</h3>
                <p className="text-gray-600 text-sm mb-4">
                  Scarica forzatamente i dati dal cloud, sovrascrivendo quelli locali
                </p>
                <button
                  onClick={() => {
                    if (window.confirm('âš ï¸ Questa operazione sovrascriverÃ  i dati locali con quelli del cloud.\n\nSei sicuro?')) {
                      syncFromFirestore(true);
                    }
                  }}
                  disabled={syncStatus === 'syncing'}
                  className="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {syncStatus === 'syncing' ? 'â³ Scaricamento...' : 'â˜ï¸ Scarica da Cloud'}
                </button>
              </div>

              {/* Statistiche Dati */}
              <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-lg p-6 border-2 border-purple-200">
                <div className="text-4xl mb-4">ðŸ“Š</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Statistiche Dati</h3>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-gray-600">Giocatori in rosa:</span>
                    <span className="font-bold text-gray-800">{players.filter(p => p.nome).length}/30</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Allenamenti registrati:</span>
                    <span className="font-bold text-gray-800">{trainings.length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Partite registrate:</span>
                    <span className="font-bold text-gray-800">{matches.length}</span>
                  </div>
                  <div className="flex justify-between pt-2 border-t">
                    <span className="text-gray-600">Utente connesso:</span>
                    <span className="font-bold text-gray-800 truncate max-w-[200px]" title={user?.email}>
                      {user?.email || 'N/A'}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            {/* Info Box */}
            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
              <div className="flex items-start gap-3">
                <div className="text-2xl">â„¹ï¸</div>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">Come Funziona la Sincronizzazione</h4>
                  <ul className="text-sm text-gray-700 space-y-2">
                    <li>
                      <strong>ðŸ”„ Sincronizzazione Intelligente:</strong> Confronta le date di modifica e sceglie automaticamente la versione piÃ¹ recente. Ideale per l'uso quotidiano.
                    </li>
                    <li>
                      <strong>â˜ï¸â†‘ Carica su Cloud:</strong> Forza il caricamento dei dati locali sul cloud. Usa questa opzione se hai fatto modifiche importanti in locale che vuoi salvare nel cloud.
                    </li>
                    <li>
                      <strong>â˜ï¸â†“ Scarica da Cloud:</strong> Forza il download dei dati dal cloud in locale. Usa questa opzione se hai modificato i dati da un altro dispositivo e vuoi aggiornarli qui.
                    </li>
                    <li>
                      <strong>âœ… Sincronizzazione Automatica:</strong> Se attiva, i dati vengono sincronizzati automaticamente ogni 5 minuti e al login. I dati locali sono sempre salvati immediatamente in IndexedDB.
                    </li>
                    <li>
                      <strong>ðŸ’¾ Backup Locale:</strong> I dati sono SEMPRE salvati in locale (IndexedDB). La sincronizzazione cloud Ã¨ un backup aggiuntivo, non sostituisce il salvataggio locale.
                    </li>
                    <li>
                      <strong>ðŸ”’ Privacy:</strong> I tuoi dati sono privati. Solo tu puoi accedere ai dati del tuo account. Ogni utente ha il suo spazio cloud separato.
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            {/* CompatibilitÃ  Export/Import */}
            <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6 mt-6">
              <div className="flex items-start gap-3">
                <div className="text-2xl">âœ…</div>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">CompatibilitÃ  con Export/Import JSON</h4>
                  <p className="text-sm text-gray-700 mb-2">
                    La sincronizzazione cloud NON sostituisce le funzioni di export/import JSON! Puoi sempre:
                  </p>
                  <ul className="text-sm text-gray-700 space-y-1 ml-4">
                    <li>â€¢ Esportare i dati in JSON come backup manuale</li>
                    <li>â€¢ Importare JSON per ripristinare o migrare dati</li>
                    <li>â€¢ Utilizzare JSON per trasferire dati tra account diversi</li>
                    <li>â€¢ Creare backup offline dei dati</li>
                  </ul>
                  <p className="text-sm text-gray-700 mt-2">
                    <strong>ðŸ’¡ Consiglio:</strong> Usa la sincronizzazione cloud per l'accesso multi-dispositivo quotidiano, e l'export JSON per backup di sicurezza periodici!
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {confirmDialog.show && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6 animate-scale-up">
              <div className="text-lg font-semibold text-gray-800 mb-4 whitespace-pre-line">
                {confirmDialog.message}
              </div>
              <div className="flex gap-3 justify-end">
                <button
                  onClick={handleCancel}
                  className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
                >
                  Annulla
                </button>
                <button
                  onClick={handleConfirm}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                >
                  Conferma
                </button>
              </div>
            </div>
          </div>
        )}

        {cardTypeDialog.show && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">
                  {cardTypeDialog.cardType === 'yellow' ? 'ðŸŸ¨' : 'ðŸŸ¥'}
                </div>
                <div className="text-xl font-bold text-gray-800 mb-2">
                  Cartellino {cardTypeDialog.cardType === 'yellow' ? 'GIALLO' : 'ROSSO'}
                </div>
                <div className="text-lg text-gray-700">
                  {cardTypeDialog.playerName} (#{cardTypeDialog.playerNum})
                </div>
              </div>
              
              <div className="text-center text-gray-700 font-semibold mb-4">
                Per quale motivo?
              </div>
              
              <div className="flex flex-col gap-3">
                <button
                  onClick={() => assignCard('gioco')}
                  className="px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-bold text-lg shadow-lg"
                >
                  âš½ Per GIOCO
                </button>
                <button
                  onClick={() => assignCard('protesta')}
                  className="px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-bold text-lg shadow-lg"
                >
                  ðŸ—£ï¸ Per PROTESTA
                </button>
                <button
                  onClick={() => setCardTypeDialog({ show: false, cardType: '', playerNum: 0, matchId: null, playerName: '', minuto: null })}
                  className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
                >
                  Annulla
                </button>
              </div>
            </div>
          </div>
        )}

        {enlargedPhoto && (
          <div 
            className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[100] p-4"
            onClick={() => setEnlargedPhoto(null)}
          >
            <div className="relative max-w-4xl max-h-[90vh] w-full">
              <button 
                onClick={() => setEnlargedPhoto(null)}
                className="absolute -top-12 right-0 text-white text-4xl font-bold hover:text-gray-300 transition-colors"
              >
                âœ•
              </button>
              {enlargedPhoto.nome && (
                <div className="absolute -top-12 left-0 text-white text-xl font-semibold">
                  {enlargedPhoto.nome}
                </div>
              )}
              <img 
                src={enlargedPhoto.foto} 
                alt={enlargedPhoto.nome || 'Giocatore'} 
                className="w-full h-full object-contain rounded-lg"
                onClick={(e) => e.stopPropagation()}
              />
            </div>
          </div>
        )}

        {showVictoryCelebration && (
          <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[110]">
            <div className="relative w-full h-full flex items-center justify-center">
              <div className="absolute inset-0 overflow-hidden pointer-events-none">
                {[...Array(50)].map((_, i) => (
                  <div
                    key={i}
                    className="absolute animate-confetti"
                    style={{
                      left: `${Math.random() * 100}%`,
                      top: `-${Math.random() * 20}%`,
                      width: '10px',
                      height: '10px',
                      backgroundColor: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'][Math.floor(Math.random() * 6)],
                      animationDelay: `${Math.random() * 3}s`,
                      animationDuration: `${3 + Math.random() * 2}s`,
                      transform: `rotate(${Math.random() * 360}deg)`
                    }}
                  />
                ))}
              </div>
              
              <div className="relative z-10 text-center px-4">
                <div className="text-8xl md:text-9xl font-black text-yellow-400 animate-bounce mb-4" style={{textShadow: '4px 4px 8px rgba(0,0,0,0.8), 0 0 40px rgba(255,215,0,0.8)'}}>
                  ðŸ† VITTORIA! ðŸ†
                </div>
                <div className="text-7xl md:text-8xl font-black text-white animate-pulse" style={{textShadow: '4px 4px 10px rgba(0,0,0,0.9), 0 0 30px rgba(255,255,255,0.5)'}}>
                  Volevano Vincere!!
                </div>
                <div className="text-7xl md:text-8xl font-black text-white animate-pulse mt-2" style={{textShadow: '4px 4px 10px rgba(0,0,0,0.9), 0 0 30px rgba(255,255,255,0.5)', animationDelay: '0.3s'}}>
                  Volevano Vincere!!
                </div>
                
                <div className="flex justify-center gap-4 mt-6 text-5xl">
                  <span className="animate-bounce" style={{animationDelay: '0s'}}>ðŸŽµ</span>
                  <span className="animate-bounce" style={{animationDelay: '0.2s'}}>ðŸŽ¶</span>
                  <span className="animate-bounce" style={{animationDelay: '0.4s'}}>ðŸŽµ</span>
                  <span className="animate-bounce" style={{animationDelay: '0.6s'}}>ðŸŽ¶</span>
                  <span className="animate-bounce" style={{animationDelay: '0.8s'}}>ðŸŽµ</span>
                </div>
                
                <button 
                  onClick={() => setShowVictoryCelebration(false)}
                  className="mt-8 px-4 py-2 bg-yellow-400 text-black rounded-lg hover:bg-yellow-500 font-bold text-sm shadow-lg border-2 border-yellow-600"
                >
                  âœ• Chiudi Festeggiamento
                </button>
              </div>
            </div>
          </div>
        )}
        
        {/* Modal Risoluzione Conflitti Sincronizzazione */}
        {showConflictModal && syncConflicts && (
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[110] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full p-6 animate-scale-up max-h-[90vh] overflow-y-auto">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">âš ï¸</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Conflitto di Sincronizzazione</h2>
                <p className="text-gray-600">Sono stati trovati dati sia in locale che nel cloud. Scegli quale versione mantenere:</p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                {/* Dati Locali */}
                <div className="border-2 border-blue-300 rounded-lg p-4 bg-blue-50">
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-3xl">ðŸ’¾</span>
                    <h3 className="text-xl font-bold text-gray-800">Dati Locali (Questo Dispositivo)</h3>
                  </div>
                  <div className="space-y-2 text-sm mb-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giocatori:</span>
                      <span className="font-bold">{syncConflicts.local.players.filter(p => p.nome).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Allenamenti:</span>
                      <span className="font-bold">{syncConflicts.local.trainings.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Partite:</span>
                      <span className="font-bold">{syncConflicts.local.matches.length}</span>
                    </div>
                    <div className="flex justify-between pt-2 border-t">
                      <span className="text-gray-600">Ultima modifica:</span>
                      <span className="font-bold">{syncConflicts.local.lastSaved.toLocaleString('it-IT')}</span>
                    </div>
                  </div>
                  <button
                    onClick={() => resolveConflict('local')}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    âœ… Mantieni Dati Locali
                  </button>
                  <p className="text-xs text-gray-600 mt-2 text-center">
                    SovrascriverÃ  i dati nel cloud
                  </p>
                </div>

                {/* Dati Cloud */}
                <div className="border-2 border-green-300 rounded-lg p-4 bg-green-50">
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-3xl">â˜ï¸</span>
                    <h3 className="text-xl font-bold text-gray-800">Dati Cloud (Firebase)</h3>
                  </div>
                  <div className="space-y-2 text-sm mb-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giocatori:</span>
                      <span className="font-bold">{syncConflicts.cloud.players.filter(p => p.nome).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Allenamenti:</span>
                      <span className="font-bold">{syncConflicts.cloud.trainings.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Partite:</span>
                      <span className="font-bold">{syncConflicts.cloud.matches.length}</span>
                    </div>
                    <div className="flex justify-between pt-2 border-t">
                      <span className="text-gray-600">Ultima sincronizzazione:</span>
                      <span className="font-bold">{syncConflicts.cloud.lastSynced.toLocaleString('it-IT')}</span>
                    </div>
                  </div>
                  <button
                    onClick={() => resolveConflict('cloud')}
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    âœ… Mantieni Dati Cloud
                  </button>
                  <p className="text-xs text-gray-600 mt-2 text-center">
                    SovrascriverÃ  i dati locali
                  </p>
                </div>
              </div>

              <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                <div className="flex items-start gap-3">
                  <span className="text-2xl">âš ï¸</span>
                  <div>
                    <h4 className="font-bold text-gray-800 mb-2">Attenzione!</h4>
                    <p className="text-sm text-gray-700">
                      Scegliendo una versione, l'altra verrÃ  <strong>completamente sovrascritta</strong>. 
                      Assicurati di scegliere la versione con i dati piÃ¹ aggiornati e completi.
                    </p>
                    <p className="text-sm text-gray-700 mt-2">
                      <strong>ðŸ’¡ Suggerimento:</strong> Se non sei sicuro, esporta prima un backup JSON dal tab Esportazioni!
                    </p>
                  </div>
                </div>
              </div>

              <button
                onClick={() => {
                  setSyncConflicts(null);
                  setShowConflictModal(false);
                }}
                className="w-full px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
              >
                â† Annulla
              </button>
            </div>
          </div>
        )}
        
        <style>{`
          @keyframes confetti {
            0% {
              transform: translateY(0) rotate(0deg);
              opacity: 1;
            }
            100% {
              transform: translateY(100vh) rotate(720deg);
              opacity: 0;
            }
          }
          
          .animate-confetti {
            animation: confetti linear infinite;
          }
        `}</style>
        
        {/* ========== TOAST NOTIFICATIONS ========== */}
        <div className="toast-container">
          {toasts.map(toast => (
            <div
              key={toast.id}
              className={`toast toast-${toast.type} ${toast.exiting ? 'toast-exit' : ''}`}
            >
              <div className="text-2xl">
                {toast.type === 'success' && 'âœ…'}
                {toast.type === 'error' && 'âŒ'}
                {toast.type === 'warning' && 'âš ï¸'}
                {toast.type === 'info' && 'â„¹ï¸'}
              </div>
              <div className="flex-1">
                <div className="font-semibold text-gray-800">{toast.message}</div>
              </div>
              <button
                onClick={() => setToasts(prev => prev.filter(t => t.id !== toast.id))}
                className="text-gray-400 hover:text-gray-600 text-xl font-bold"
              >
                Ã—
              </button>
            </div>
          ))}
        </div>

        {/* ========== LOADING OVERLAY MIGLIORATO ========== */}
        {showLoading && (
          <div className="loading-overlay">
            <div className="loading-content">
              <div className="text-6xl mb-4 animate-pulse">âš½</div>
              <div className="text-xl font-bold text-gray-800 mb-2">{loadingMessage}</div>
              {loadingProgress > 0 && (
                <>
                  <div className="progress-bar">
                    <div 
                      className="progress-bar-fill"
                      style={{ width: `${loadingProgress}%` }}
                    ></div>
                  </div>
                  <div className="text-sm text-gray-600 mt-2">{loadingProgress}%</div>
                </>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<SoccerTeamTracker />);
  </script>
</body>
</html>
