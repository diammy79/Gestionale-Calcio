<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  
  <!-- ========== META TAGS ANTI-CACHE ========== -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <title>âš½ Gestionale Calcio</title>
  
  <!-- ========== FAVICON ========== -->
  <!-- Emoji favicon (piÃ¹ semplice e compatibile) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš½</text></svg>">
  
  <!-- Apple Touch Icon (per iOS home screen) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš½</text></svg>">
  
  <!-- Apple Touch Icon (per iOS) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='%231a56db'/><path d='M50 10 L58 30 L78 30 L62 42 L70 62 L50 50 L30 62 L38 42 L22 30 L42 30 Z' fill='%23ffffff'/><circle cx='50' cy='50' r='12' fill='%23ffffff'/></svg>">
  
  <!-- Google Font - Nunito (friendly e professionale) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ========== DISABILITA PULL-TO-REFRESH SU MOBILE ========== */
    html {
      overscroll-behavior-y: contain;
    }
    
    body { 
      margin: 0; 
      padding: 0; 
      font-family: system-ui, -apple-system, sans-serif;
      scroll-behavior: smooth;
      overscroll-behavior-y: contain; /* Disabilita pull-to-refresh su mobile */
      -webkit-overflow-scrolling: touch; /* Smooth scrolling iOS */
      /* ðŸ”µ SFONDO BLU FISSO - elimina schermata bianca iniziale */
      background: linear-gradient(135deg, #1e40af 0%, #1c3d99 50%, #1e3a8a 100%);
      background-attachment: fixed;
    }
    
    /* Previeni overscroll su tutti i container principali */
    .min-h-screen {
      overscroll-behavior-y: contain;
    }
    
    /* ========== ANIMAZIONI E TRANSIZIONI ========== */
    
    /* Fade in generale */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Slide in da sinistra */
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* Slide in da destra */
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* Scale up */
    @keyframes scaleUp {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    /* Pulse */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Shake */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    /* Applicazione animazioni */
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    .animate-slide-in-left {
      animation: slideInLeft 0.5s ease-out;
    }
    
    .animate-slide-in-right {
      animation: slideInRight 0.5s ease-out;
    }
    
    .animate-scale-up {
      animation: scaleUp 0.3s ease-out;
    }
    
    .animate-pulse-slow {
      animation: pulse 2s ease-in-out infinite;
    }
    
    .animate-shake {
      animation: shake 0.5s ease-in-out;
    }
    
    /* ========== TRANSIZIONI SMOOTH ========== */
    
    * {
      transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
      transition-duration: 200ms;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    button, a, input, select, textarea {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* ========== HOVER EFFECTS MIGLIORATI ========== */
    
    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    button:not(:disabled):active {
      transform: translateY(0);
    }
    
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* ========== LOADING STATES ========== */
    
    /* Skeleton loader */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }
    
    /* Spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-left-color: #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    .spinner-small {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-left-color: #ffffff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    /* ========== RESPONSIVE MOBILE ========== */
    
    /* Miglioramenti touch */
    @media (hover: none) and (pointer: coarse) {
      button, a, input, select {
        min-height: 44px; /* Apple guidelines */
        min-width: 44px;
      }
      
      /* Disabilita hover su touch */
      button:hover {
        transform: none;
      }
    }
    
    /* Tablet e mobile */
    @media (max-width: 768px) {
      /* Font piÃ¹ grandi su mobile */
      body {
        font-size: 16px;
      }
      
      /* Padding ridotto */
      .mobile-compact {
        padding: 0.5rem !important;
      }
      
      /* Nascondi testo su mobile, mostra solo icone */
      .hide-text-mobile span {
        display: none;
      }
      
      /* Tab scrollabile */
      .tab-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin; /* Mostra scrollbar sottile su Firefox */
        scrollbar-color: #cbd5e0 transparent; /* Colore scrollbar */
      }
      
      .tab-container::-webkit-scrollbar {
        height: 4px; /* Scrollbar sottile su Chrome/Safari */
      }
      
      .tab-container::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .tab-container::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 2px;
      }
      
      .tab-container::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
      }
      
      /* Su mobile nascondi completamente lo scrollbar */
      @media (max-width: 768px) {
        .tab-container {
          scrollbar-width: none;
        }
        
        .tab-container::-webkit-scrollbar {
          display: none;
        }
      }
    }
    
    /* Solo mobile piccolo */
    @media (max-width: 480px) {
      /* Stack su mobile */
      .mobile-stack {
        flex-direction: column !important;
      }
      
      /* Full width su mobile */
      .mobile-full {
        width: 100% !important;
      }
    }
    
    /* ========== MIGLIORAMENTI SCROLL ========== */
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* ========== FOCUS STATES ========== */
    
    button:focus, input:focus, select:focus, textarea:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    
    /* ========== GLASSMORPHISM (opzionale) ========== */
    
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* ========== GRADIENT TEXT ========== */
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* ========== BADGE PULSE ========== */
    
    @keyframes badge-pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.1);
      }
    }
    
    .badge-animated {
      animation: badge-pulse 2s ease-in-out infinite;
    }
    
    /* ========== CARD IMPROVEMENTS ========== */
    
    .card-modern {
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .card-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
    }
    
    /* ========== RIPPLE EFFECT ========== */
    
    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
    
    .ripple {
      position: relative;
      overflow: hidden;
    }
    
    .ripple::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transform: scale(0);
      opacity: 0;
    }
    
    .ripple:active::after {
      animation: ripple 0.6s ease-out;
    }
    
    /* ========== PRINT STYLES ========== */
    
    @media print {
      button, .no-print {
        display: none !important;
      }
    }
    
    /* ========== TOAST NOTIFICATIONS ========== */
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    
    .toast {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: start;
      gap: 12px;
      animation: slideInRight 0.3s ease-out;
      min-width: 300px;
    }
    
    .toast.toast-success {
      border-left: 4px solid #10b981;
    }
    
    .toast.toast-error {
      border-left: 4px solid #ef4444;
    }
    
    .toast.toast-warning {
      border-left: 4px solid #f59e0b;
    }
    
    .toast.toast-info {
      border-left: 4px solid #3b82f6;
    }
    
    .toast.toast-exit {
      animation: slideOutRight 0.3s ease-in;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    
    /* ========== PULSE VELOCE PER CONVOCATI ========== */
    
    @keyframes pulse-fast {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .animate-pulse-fast {
      animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* ========== LOADING SPINNER ENHANCED ========== */
    
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-center;
      z-index: 9998;
      backdrop-filter: blur(4px);
    }
    
    .loading-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: scaleUp 0.3s ease-out;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 16px;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    /* ========== DRAG & DROP STYLES ========== */
    
    .draggable {
      cursor: move;
      transition: all 0.2s ease;
    }
    
    .draggable:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .draggable.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .drop-zone {
      min-height: 60px;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .drop-zone.drag-over {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    /* ========== CALENDAR STYLES ========== */
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    
    @media (min-width: 640px) {
      .calendar-grid {
        gap: 4px;
      }
    }
    
    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 2px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    
    @media (min-width: 640px) {
      .calendar-day {
        border-radius: 8px;
        padding: 4px;
        font-size: 14px;
      }
    }
    
    .calendar-day:hover {
      background: #f3f4f6;
      border-color: #3b82f6;
    }
    
    .calendar-day.today {
      background: #dbeafe;
      border-color: #3b82f6;
      font-weight: bold;
    }
    
    /* Allenamenti - Azzurro */
    .calendar-day.has-training {
      background: #dbeafe;
      border-color: #60a5fa;
    }
    
    .calendar-day.has-training::after {
      content: 'ðŸƒ';
      position: absolute;
      bottom: 1px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      line-height: 1;
    }
    
    @media (min-width: 640px) {
      .calendar-day.has-training::after {
        bottom: 2px;
        font-size: 14px;
      }
    }
    
    /* Partite - Verde */
    .calendar-day.has-match {
      background: #d1fae5;
      border-color: #34d399;
    }
    
    .calendar-day.has-match::after {
      content: 'âš½';
      position: absolute;
      bottom: 1px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      line-height: 1;
    }
    
    @media (min-width: 640px) {
      .calendar-day.has-match::after {
        bottom: 2px;
        font-size: 14px;
      }
    }
    
    /* Entrambi - Combinato */
    .calendar-day.has-both {
      background: linear-gradient(135deg, #dbeafe 50%, #d1fae5 50%);
      border-color: #60a5fa;
    }
    
    .calendar-day.has-both::after {
      content: 'ðŸƒâš½';
      position: absolute;
      bottom: 1px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      line-height: 1;
      letter-spacing: -2px;
    }
    
    @media (min-width: 640px) {
      .calendar-day.has-both::after {
        bottom: 2px;
        font-size: 12px;
      }
    }
    
    /* Rimuovo vecchio stile has-event */
    
    /* ========== INJURY STATUS BADGES ========== */
    
    .injury-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .injury-badge.active {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .injury-badge.recovering {
      background: #fef3c7;
      color: #92400e;
    }
    
    .injury-badge.recovered {
      background: #d1fae5;
      color: #065f46;
    }

    /* ========== OTTIMIZZAZIONI MOBILE - MIGLIORE LEGGIBILITÃ€ ========== */
    /* ========== OTTIMIZZAZIONE SMARTPHONE (max-width: 640px) ========== */
    @media (max-width: 640px) {
      /* ===== TITOLI E TESTI - RIDOTTI PER EVITARE OVERFLOW ===== */
      
      /* Titolo principale app - ridotto */
      h1, .text-3xl {
        font-size: 1.25rem !important; /* Ridotto da 1.875rem */
        line-height: 1.3 !important;
        word-break: break-word !important;
      }
      
      /* Titoli sezioni - ridotti */
      h2, .text-2xl {
        font-size: 1.125rem !important; /* Ridotto da 1.5rem */
        line-height: 1.3 !important;
        word-break: break-word !important;
      }
      
      /* Sottotitoli - ridotti */
      h3, .text-xl {
        font-size: 1rem !important; /* Ridotto da 1.25rem */
        line-height: 1.3 !important;
      }
      
      /* Testi grandi - ridotti */
      .text-lg {
        font-size: 0.95rem !important;
      }
      
      /* Testi normali - mantieni leggibili */
      .text-base, p {
        font-size: 0.875rem !important;
        line-height: 1.4 !important;
      }
      
      /* Testi piccoli - leggibili */
      .text-sm {
        font-size: 0.8125rem !important;
      }
      
      .text-xs {
        font-size: 0.75rem !important;
      }
      
      /* ===== NUMERI STATS - RIDOTTI ===== */
      .text-4xl {
        font-size: 1.75rem !important; /* Ridotto da 2.25rem */
      }
      
      .text-5xl {
        font-size: 2rem !important; /* Ridotto da 3rem */
      }
      
      .text-6xl {
        font-size: 2.25rem !important;
      }
      
      /* ===== HEADER E NAVIGATION - COMPATTO ===== */
      
      /* Header principale - ridotto padding */
      .bg-white.rounded-lg.shadow-xl:first-of-type {
        padding: 0.5rem !important;
      }
      
      /* Tab navigation - compatta */
      .tab-container button {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.8125rem !important;
        min-height: 40px !important;
        white-space: nowrap !important;
      }
      
      /* Badge ruolo - compatto */
      .bg-yellow-400, .bg-blue-200 {
        padding: 0.375rem 0.625rem !important;
        font-size: 0.75rem !important;
      }
      
      /* ===== BOTTONI - TOUCH FRIENDLY ===== */
      button, .btn, a.btn {
        min-height: 44px !important; /* Minimo Apple HIG */
        padding: 0.625rem 0.875rem !important;
        font-size: 0.875rem !important;
      }
      
      /* Bottoni piccoli (icone) */
      button.px-2, button.px-3 {
        padding: 0.5rem !important;
        min-width: 44px !important;
      }
      
      /* ===== CARDS E CONTAINER - SPAZIATURE RIDOTTE ===== */
      .card-modern, .bg-white.rounded-lg {
        padding: 0.75rem !important;
      }
      
      .p-4 {
        padding: 0.75rem !important;
      }
      
      .p-6 {
        padding: 1rem !important;
      }
      
      .px-4 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      .py-3, .py-4 {
        padding-top: 0.625rem !important;
        padding-bottom: 0.625rem !important;
      }
      
      /* ===== MARGINI - RIDOTTI ===== */
      .mb-2 {
        margin-bottom: 0.375rem !important;
      }
      
      .mb-3, .mb-4 {
        margin-bottom: 0.625rem !important;
      }
      
      .mb-6 {
        margin-bottom: 1rem !important;
      }
      
      /* ===== GAP - RIDOTTI ===== */
      .gap-2 {
        gap: 0.375rem !important;
      }
      
      .gap-3, .gap-4 {
        gap: 0.5rem !important;
      }
      
      /* ===== FORM ELEMENTS - COMPATTI ===== */
      input, select, textarea {
        min-height: 42px !important;
        padding: 0.5rem 0.625rem !important;
        font-size: 0.875rem !important;
      }
      
      label {
        font-size: 0.8125rem !important;
        margin-bottom: 0.25rem !important;
      }
      
      /* ===== TABELLE - RESPONSIVE ===== */
      table {
        font-size: 0.8125rem !important;
      }
      
      th, td {
        padding: 0.5rem 0.375rem !important;
      }
      
      /* ===== MODAL - OTTIMIZZATI ===== */
      .modal-content, .bg-white.rounded-lg.shadow-2xl {
        padding: 1rem !important;
        max-height: 85vh !important;
        overflow-y: auto !important;
      }
      
      /* Titoli modal - ridotti */
      .modal-content h3, .bg-white.rounded-lg.shadow-2xl h3 {
        font-size: 1.125rem !important;
      }
      
      /* ===== GESTIONE OVERFLOW - ANTI-SOVRAPPOSIZIONE ===== */
      
      /* Impedisci overflow orizzontale */
      * {
        max-width: 100%;
        box-sizing: border-box;
      }
      
      /* Titoli lunghi - ellipsis o wrap */
      h1, h2, h3, .font-bold {
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
        hyphens: auto !important;
      }
      
      /* Container principale */
      .min-h-screen {
        padding: 0.5rem !important;
      }
      
      /* ===== GRID LAYOUT - OTTIMIZZATO ===== */
      
      /* Grid stats - singola colonna su mobile molto piccolo */
      .grid.grid-cols-2 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
      }
      
      .grid.grid-cols-3 {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .grid.grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      /* ===== STATISTICHE CARDS - COMPATTE ===== */
      .bg-gradient-to-br {
        padding: 0.75rem !important;
      }
      
      /* Numeri grandi stats - ridotti */
      .bg-gradient-to-br .text-3xl {
        font-size: 1.5rem !important;
      }
      
      /* ===== BADGE E PILLS - COMPATTI ===== */
      .badge-animated, .rounded-full {
        font-size: 0.75rem !important;
        padding: 0.25rem 0.5rem !important;
      }
      
      /* ===== LOGO - RIDOTTO ===== */
      img[alt*="Logo"], .w-16, .h-16 {
        width: 2.5rem !important;
        height: 2.5rem !important;
        min-width: 2.5rem !important;
        min-height: 2.5rem !important;
      }
      
      /* ===== ICONE - PROPORZIONATE ===== */
      svg, .lucide {
        width: 1.125rem !important;
        height: 1.125rem !important;
      }
      
      /* ===== TOAST - COMPATTI ===== */
      .toast {
        font-size: 0.875rem !important;
        padding: 0.75rem 1rem !important;
        min-width: 85% !important;
      }
      
      /* ===== LISTA GIOCATORI - COMPATTA ===== */
      .space-y-2 > * {
        margin-top: 0.375rem !important;
      }
      
      .space-y-3 > * {
        margin-top: 0.5rem !important;
      }
      
      /* ===== FORMAZIONE CAMPO - LEGGIBILE ===== */
      .field-position {
        font-size: 0.7rem !important;
        padding: 0.375rem !important;
      }
      
      /* ===== CHECKBOX E RADIO - TOUCH FRIENDLY ===== */
      input[type="checkbox"], input[type="radio"] {
        width: 20px !important;
        height: 20px !important;
      }
      
      /* ===== SCROLL ORIZZONTALE - SMOOTH ===== */
      .overflow-x-auto {
        -webkit-overflow-scrolling: touch !important;
        scroll-behavior: smooth !important;
      }
      
      /* ===== FLEX LAYOUTS - ANTI-OVERFLOW ===== */
      .flex {
        flex-wrap: wrap !important;
      }
      
      .flex.gap-2 {
        gap: 0.375rem !important;
      }
      
      /* ===== BANNER INFORMATIVI - COMPATTI ===== */
      .bg-yellow-50, .bg-blue-50, .bg-green-50 {
        padding: 0.625rem !important;
        font-size: 0.8125rem !important;
      }
      
      /* ===== DIVIDERS - VISIBILI MA SOTTILI ===== */
      hr, .border-b, .border-t {
        border-width: 1px !important;
      }
    }
    
    /* ========== OTTIMIZZAZIONE SMARTPHONE PORTRAIT (max-width: 480px) ========== */
    @media (max-width: 480px) {
      /* Ulteriore riduzione per schermi molto piccoli */
      
      h1, .text-3xl {
        font-size: 1.125rem !important;
      }
      
      .tab-container button {
        padding: 0.5rem 0.625rem !important;
        font-size: 0.75rem !important;
      }
      
      .grid.grid-cols-2 {
        grid-template-columns: 1fr !important;
      }
      
      /* Bottoni fullwidth su schermi molto piccoli */
      .flex.gap-2 > button {
        flex: 1 1 100% !important;
      }
    }
    
    /* ========== OTTIMIZZAZIONE SMARTPHONE (max-width: 640px) ========== */
    @media (max-width: 640px) {
      /* Riduzione dimensioni titoli per evitare overflow */
      h1, .text-3xl {
        font-size: 1.5rem !important; /* Da 3xl a xl */
        line-height: 2rem !important;
      }
      
      h2, .text-2xl {
        font-size: 1.25rem !important; /* Da 2xl a lg */
        line-height: 1.75rem !important;
      }
      
      h3, .text-xl {
        font-size: 1.125rem !important; /* Da xl a lg */
        line-height: 1.75rem !important;
      }
      
      /* Riduzione padding generale per guadagnare spazio */
      .p-4 {
        padding: 0.75rem !important;
      }
      
      .p-6 {
        padding: 1rem !important;
      }
      
      .px-4 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      .px-6 {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
      }
      
      .py-4 {
        padding-top: 0.75rem !important;
        padding-bottom: 0.75rem !important;
      }
      
      .py-6 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
      }
      
      /* Header compatto */
      .mobile-header h1 {
        font-size: 1.25rem !important;
        line-height: 1.5rem !important;
      }
      
      /* Tab navbar: testo piÃ¹ piccolo e compatto */
      .tab-container button {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
        font-size: 0.75rem !important;
        white-space: nowrap;
      }
      
      /* Card statistiche: numeri e testi piÃ¹ compatti */
      .text-4xl {
        font-size: 1.875rem !important; /* Da 4xl a 2xl */
      }
      
      .text-5xl {
        font-size: 2.25rem !important; /* Da 5xl a 3xl */
      }
      
      /* Badge e bottoni piÃ¹ compatti */
      button {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.875rem !important;
      }
      
      button.text-xs {
        padding: 0.375rem 0.5rem !important;
        font-size: 0.75rem !important;
      }
      
      /* Modal: massimizza spazio disponibile */
      .modal-content {
        max-width: 100% !important;
        margin: 0.5rem !important;
        max-height: calc(100vh - 1rem) !important;
      }
      
      /* Tabelle: scroll orizzontale fluido */
      table {
        font-size: 0.8rem !important;
      }
      
      table th, table td {
        padding: 0.5rem !important;
      }
      
      /* Input e select piÃ¹ grandi per touch */
      input:not([type="checkbox"]):not([type="radio"]),
      select,
      textarea {
        font-size: 16px !important; /* Evita zoom automatico iOS */
        padding: 0.625rem !important;
      }
      
      /* Checkbox e radio piÃ¹ grandi per touch */
      input[type="checkbox"],
      input[type="radio"] {
        width: 20px !important;
        height: 20px !important;
        margin: 0.25rem !important;
      }
      
      /* Icone dimensionate correttamente */
      svg {
        flex-shrink: 0;
      }
      
      /* Gap ridotti per evitare sprechi di spazio */
      .gap-4 {
        gap: 0.75rem !important;
      }
      
      .gap-6 {
        gap: 1rem !important;
      }
      
      /* Grid piÃ¹ compatto */
      .grid {
        gap: 0.75rem !important;
      }
      
      /* Evita overflow di testo lungo */
      .break-words {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
      }
      
      /* Container full-width su mobile */
      .container {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      /* Toast piÃ¹ compatto */
      .toast {
        min-width: auto !important;
        width: calc(100vw - 2rem) !important;
      }
      
      .toast-container {
        right: 1rem !important;
        left: 1rem !important;
        top: 1rem !important;
      }
      
      /* Badge ruolo piÃ¹ compatto */
      .badge-ruolo {
        font-size: 0.7rem !important;
        padding: 0.25rem 0.5rem !important;
      }
      
      /* Nascondo testo ridondante su mobile */
      .mobile-hide-text {
        display: none !important;
      }
      
      /* Logo squadra piÃ¹ piccolo */
      img[alt*="Logo"] {
        max-width: 48px !important;
        max-height: 48px !important;
      }
      
      /* Pulsanti floating piÃ¹ accessibili */
      .fixed {
        bottom: 1rem !important;
        right: 1rem !important;
      }
      
      /* Prevenzione overflow generale */
      * {
        max-width: 100%;
      }
      
      /* Migliora rendering orientamento */
      @supports (-webkit-touch-callout: none) {
        /* iOS Safari specifico */
        body {
          -webkit-text-size-adjust: 100%;
        }
      }
    }
    
    /* ========== GESTIONE TESTO TAB PORTRAIT/LANDSCAPE ========== */
    
    /* Portrait mobile: grid 3 colonne compatto */
    @media (max-width: 640px) and (orientation: portrait) {
      .tab-container {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 0.5rem !important;
        border-bottom: none !important;
        overflow-x: visible !important;
      }
      
      .tab-container button {
        padding: 0.5rem 0.25rem !important;
        font-size: 0.65rem !important;
        border-radius: 0.5rem !important;
        border-bottom: none !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        gap: 0.25rem !important;
        min-height: 60px !important;
      }
      
      .tab-text-portrait {
        display: block !important;
        font-size: 0.65rem !important;
        text-align: center !important;
        line-height: 1.1 !important;
      }
      
      .tab-icon-only {
        display: block !important;
        font-size: 1.25rem !important;
      }
    }
    
    /* Landscape mobile: nascondi testo, mostra solo icone */
    @media (max-width: 640px) and (orientation: landscape) {
      .tab-text-portrait {
        display: none !important;
      }
      
      .tab-icon-only {
        display: inline !important;
      }
      
      /* Tab navbar: padding ridotto per solo icone */
      .tab-container button {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
      }
    }
    
    /* ========== CLASSIFICA RESPONSIVE MOBILE ========== */
    
    /* Mobile Portrait: Nascondi G, GF, GS, DR - Mostra solo V, P, S */
    @media (max-width: 640px) and (orientation: portrait) {
      .classifica-col-giocate,
      .classifica-col-gol {
        display: none !important;
      }
      
      .classifica-col-risultati {
        display: table-cell !important;
      }
    }
    
    /* Mobile Landscape: Nascondi G - Mostra V, P, S, GF, GS, DR */
    @media (max-width: 640px) and (orientation: landscape) {
      .classifica-col-giocate {
        display: none !important;
      }
      
      .classifica-col-risultati,
      .classifica-col-gol {
        display: table-cell !important;
      }
    }
    
    /* ========== STATISTICHE GIOCATORI LANDSCAPE MOBILE ========== */
    
    /* Landscape mobile: titolo e container ottimizzati */
    @media (max-width: 640px) and (orientation: landscape) {
      .stats-container-mobile {
        height: calc(100vh - 120px) !important; /* Riduce spazio header */
      }
      
      .stats-title-mobile {
        font-size: 1rem !important;
        margin-bottom: 0.5rem !important;
        padding: 0.25rem 0 !important;
        line-height: 1.25rem !important;
      }
      
      /* Card statistiche piÃ¹ compatte */
      .stats-container-mobile .bg-white.rounded-lg {
        padding: 0.75rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      /* Grid piÃ¹ compatto */
      .stats-container-mobile .grid {
        gap: 0.5rem !important;
      }
      
      /* Font piÃ¹ piccoli nelle card */
      .stats-container-mobile .text-xs {
        font-size: 0.7rem !important;
      }
      
      .stats-container-mobile .text-2xl {
        font-size: 1.25rem !important;
      }
    }
    
    /* ========== GESTIONE ROSA PORTRAIT MOBILE ========== */
    @media (max-width: 640px) and (orientation: portrait) {
      /* Layout verticale: foto sopra, info sotto */
      .roster-player-card > .flex {
        flex-direction: column !important;
        align-items: center !important;
        gap: 1rem !important;
      }
      
      /* Quick Stats: da 5 colonne a 3 per evitare sovrapposizioni */
      .roster-quick-stats {
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
        gap: 0.5rem !important;
      }
      
      /* Numeri statistiche piÃ¹ compatti */
      .roster-quick-stats .text-2xl {
        font-size: 1.25rem !important;
      }
      
      /* Testo etichette piÃ¹ piccolo */
      .roster-quick-stats .text-xs {
        font-size: 0.65rem !important;
        line-height: 1rem !important;
      }
      
      /* Foto giocatore centrata */
      .roster-player-photo {
        width: 80px !important;
        height: 80px !important;
      }
      
      /* Padding card piÃ¹ compatto */
      .roster-player-card {
        padding: 1rem !important;
      }
      
      /* Container info: full width */
      .roster-player-card .flex-1 {
        width: 100% !important;
      }
      
      /* Grid info giocatore: 2 colonne simmetriche */
      .roster-player-info {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 0.75rem !important;
        width: 100% !important;
      }
      
      /* Campi che devono occupare 2 colonne */
      .roster-player-info > div.md\:col-span-2,
      .roster-player-info > div.md\:col-span-3,
      .roster-player-info > div.lg\:col-span-3 {
        grid-column: span 2 / span 2 !important;
      }
      
      /* Numero giocatore leggibile */
      .roster-player-number {
        font-size: 1.5rem !important;
      }
      
      /* Labels piÃ¹ visibili */
      .roster-player-info label {
        font-size: 0.7rem !important;
        margin-bottom: 0.25rem !important;
        display: block !important;
      }
      
      /* Valori info piÃ¹ grandi */
      .roster-player-info > div > div:not(label):not(input):not(select) {
        font-size: 0.875rem !important;
        line-height: 1.25rem !important;
      }
    }
    
    /* ========== FIX RIDIMENSIONAMENTO ORIENTAMENTO MOBILE ========== */
    @media (max-width: 640px) and (orientation: landscape) {
      /* Landscape: massimizza spazio verticale */
      .mobile-header {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
      }
      
      h1, .text-3xl {
        font-size: 1.25rem !important;
      }
      
      .tab-container button {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
      }
      
      /* Fix altezza pulsanti gestione rosa in landscape */
      .flex.flex-row button {
        min-height: auto !important;
        max-height: 36px !important;
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
      }
    }
    
    /* ========== PRELOADER ANIMATO ========== */
    /* ðŸ”´ INIZIO CODICE PRELOADER - PER RIMUOVERLO CANCELLA DA QUI... */
    #preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e40af 0%, #1c3d99 50%, #1e3a8a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      pointer-events: all;
      transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    }
    
    #preloader.fade-out {
      opacity: 0;
      visibility: hidden;
    }
    
    /* Contenitore pallone + spinner */
    .preloader-ball-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin-bottom: 30px;
    }
    
    /* Pallone rimbalzante */
    .preloader-ball {
      font-size: 64px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      -webkit-transform: translate(-50%, -50%);
      animation: bounce 1.2s ease-in-out infinite;
      -webkit-animation: bounce 1.2s ease-in-out infinite;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
      -webkit-filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
      will-change: transform;
    }
    
    @keyframes bounce {
      0%, 100% { 
        transform: translate(-50%, -50%) translateY(0px);
      }
      50% { 
        transform: translate(-50%, -50%) translateY(-25px);
      }
    }
    
    @-webkit-keyframes bounce {
      0%, 100% { 
        -webkit-transform: translate(-50%, -50%) translateY(0px);
        transform: translate(-50%, -50%) translateY(0px);
      }
      50% { 
        -webkit-transform: translate(-50%, -50%) translateY(-25px);
        transform: translate(-50%, -50%) translateY(-25px);
      }
    }
    
    /* Spinner rotante */
    .preloader-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100px;
      height: 100px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #ffffff;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      -webkit-transform: translate(-50%, -50%);
      animation: spin 1s linear infinite;
      -webkit-animation: spin 1s linear infinite;
      will-change: transform;
    }
    
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    @-webkit-keyframes spin {
      0% { 
        -webkit-transform: translate(-50%, -50%) rotate(0deg);
        transform: translate(-50%, -50%) rotate(0deg);
      }
      100% { 
        -webkit-transform: translate(-50%, -50%) rotate(360deg);
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }
    
    /* Testo caricamento */
    .preloader-text {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      animation: fadeInOut 2s ease-in-out infinite;
      -webkit-animation: fadeInOut 2s ease-in-out infinite;
      font-family: 'Nunito', sans-serif;
    }
    
    @keyframes fadeInOut {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    
    @-webkit-keyframes fadeInOut {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    
    /* Titolo app */
    .preloader-title {
      color: rgba(255, 255, 255, 0.95);
      font-size: 28px;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      letter-spacing: 0.5px;
      font-family: 'Nunito', sans-serif;
    }
    
    /* Nome autore highlight */
    .preloader-author {
      color: #fbbf24;
      font-weight: 800;
    }
    
    /* Copyright */
    .preloader-copyright {
      color: rgba(255, 255, 255, 0.6);
      font-size: 11px;
      font-weight: 400;
      margin-top: 20px;
      letter-spacing: 0.3px;
      font-family: 'Nunito', sans-serif;
    }
    
    /* Punti animati */
    .preloader-dots {
      display: inline-block;
      width: 20px;
      text-align: left;
    }
    
    .preloader-dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
      -webkit-animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
    
    @-webkit-keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
    
    /* ðŸ“± RESPONSIVE MOBILE/TABLET */
    @media (max-width: 768px) {
      /* Contenitore pallone piÃ¹ piccolo */
      .preloader-ball-container {
        width: 100px;
        height: 100px;
        margin-bottom: 25px;
      }
      
      /* Pallone piÃ¹ piccolo */
      .preloader-ball {
        font-size: 52px;
      }
      
      /* Spinner piÃ¹ piccolo */
      .preloader-spinner {
        width: 85px;
        height: 85px;
        border-width: 3px;
      }
      
      /* Testo caricamento piÃ¹ piccolo */
      .preloader-text {
        font-size: 15px;
        margin-bottom: 8px;
      }
      
      /* Titolo app piÃ¹ piccolo e su 2 righe se necessario */
      .preloader-title {
        font-size: 20px;
        text-align: center;
        padding: 0 20px;
        line-height: 1.3;
      }
      
      /* Copyright piÃ¹ piccolo */
      .preloader-copyright {
        font-size: 10px;
        margin-top: 15px;
      }
    }
    
    /* ðŸ“± EXTRA SMALL (smartphone piccoli) */
    @media (max-width: 480px) {
      /* Contenitore pallone ancora piÃ¹ piccolo */
      .preloader-ball-container {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
      }
      
      /* Pallone ancora piÃ¹ piccolo */
      .preloader-ball {
        font-size: 44px;
      }
      
      /* Spinner ancora piÃ¹ piccolo */
      .preloader-spinner {
        width: 70px;
        height: 70px;
        border-width: 3px;
      }
      
      /* Testo caricamento ancora piÃ¹ piccolo */
      .preloader-text {
        font-size: 14px;
        margin-bottom: 6px;
      }
      
      /* Titolo app ancora piÃ¹ piccolo */
      .preloader-title {
        font-size: 18px;
        padding: 0 15px;
        line-height: 1.4;
      }
      
      /* Copyright ancora piÃ¹ piccolo */
      .preloader-copyright {
        font-size: 9px;
        margin-top: 12px;
      }
    }
    /* ðŸ”´ ...FINO A QUI per tornare alla versione precedente */
  </style>
  <meta name="theme-color" content="#1a56db">
  <meta name="description" content="Gestionale Calcio - Gestione Squadra Completa">
  <link rel="manifest" href="manifest.json">
  
  <!-- iOS Splash Screens -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gestionale Calcio">
  
  <!-- iPhone X/11/12/13/14 (1125x2436) -->
  <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="splash-iphone-x.png">
  
  <!-- iPhone XS Max/11 Pro Max/12 Pro Max/13 Pro Max/14 Plus (1242x2688) -->
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" href="splash-iphone-max.png">
  
  <!-- iPhone XR/11 (828x1792) -->
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" href="splash-iphone-xr.png">
  
  <!-- iPhone 6/7/8 (750x1334) -->
  <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="splash-iphone-8.png">
  
  <!-- Fallback icon -->
  <link rel="apple-touch-icon" href="icon-512.png">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
<body>
  <!-- ðŸ”´ INIZIO PRELOADER - PER RIMUOVERLO CANCELLA DA QUI... -->
  <div id="preloader">
    <div class="preloader-ball-container">
      <div class="preloader-spinner"></div>
      <div class="preloader-ball">âš½</div>
    </div>
    <div class="preloader-text">
      Caricamento app<span class="preloader-dots"></span>
    </div>
    <div class="preloader-title">
      <span class="preloader-author">Moreschi Roberto</span> - Gestionale Calcio
    </div>
    <div class="preloader-copyright">
      Â© 2026 - Tutti i diritti riservati
    </div>
  </div>
  <!-- ðŸ”´ ...FINO A QUI -->
  
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useMemo } = React;

// ============================================
// SISTEMA ANTI-CACHE CON VERSIONING
// ============================================
const APP_VERSION = '2026-02-09-21:28'; // Auto-aggiornato da Claude

// Controlla versione e forza reload se necessario
(() => {
  const savedVersion = localStorage.getItem('appVersion');
  
  if (savedVersion && savedVersion !== APP_VERSION) {
    console.log('ðŸ”„ NUOVA VERSIONE RILEVATA!');
    console.log('   Vecchia:', savedVersion);
    console.log('   Nuova:', APP_VERSION);
    console.log('   ðŸ”„ Forzando hard reload con pulizia cache...');
    
    // Aggiorna versione
    localStorage.setItem('appVersion', APP_VERSION);
    
    // Hard reload con pulizia cache
    window.location.reload(true);
    
    // Se reload(true) non funziona, usa questo metodo alternativo
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => caches.delete(name));
      }).then(() => {
        window.location.href = window.location.href + '?v=' + Date.now();
      });
    }
  } else if (!savedVersion) {
    // Prima volta, salva versione
    console.log('âœ… Prima apertura app, versione:', APP_VERSION);
    localStorage.setItem('appVersion', APP_VERSION);
  } else {
    console.log('âœ… Versione app corretta:', APP_VERSION);
  }
})();

// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyBKMsg16kzFnY529eR03DUjGoOO-XZonZc",
  authDomain: "gestionale-calcio-59318.firebaseapp.com",
  projectId: "gestionale-calcio-59318",
  storageBucket: "gestionale-calcio-59318.firebasestorage.app",
  messagingSenderId: "573513891203",
  appId: "1:573513891203:web:a7ae4934de0913b6120ab6"
};

let firebaseApp, auth, db, storage;
try {
  firebaseApp = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  
  // âœ… IMPORTANTE: NON persistere la sessione - richiede login ad ogni apertura app
  auth.setPersistence(firebase.auth.Auth.Persistence.NONE)
    .then(() => {
      console.log('ðŸ” Persistenza sessione: DISABILITATA (richiede login ogni volta)');
    })
    .catch((error) => {
      console.error('âš ï¸ Errore impostazione persistenza:', error);
    });
  
  db = firebase.firestore();
  storage = firebase.storage();
  db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
    console.log('Persistenza:', err.code);
  });
} catch (error) {
  console.error('Errore inizializzazione cloud:', error);
}

// ============================================
// COMPONENTE LOGIN
// ============================================
const LoginScreen = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // âœ… Al mount, carica email salvata da localStorage
  useEffect(() => {
    const savedEmail = localStorage.getItem('savedEmail');
    if (savedEmail) {
      setEmail(savedEmail);
      console.log('ðŸ“§ Email precaricata:', savedEmail);
    }
  }, []);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      await auth.signInWithEmailAndPassword(email, password);
      
      // âœ… Salva email in localStorage (ma NON la password!)
      localStorage.setItem('savedEmail', email);
      console.log('ðŸ’¾ Email salvata in localStorage');
      
    } catch (error) {
      setError('Email o password non validi');
      console.error('Errore login:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-600 via-blue-700 to-blue-900 flex items-center justify-center p-4">
      <div className="max-w-md w-full">
        <div className="text-center mb-8">
          <div className="text-7xl mb-4 animate-bounce">âš½</div>
          <h1 className="text-5xl font-black text-white mb-2" style={{textShadow: '3px 3px 6px rgba(0,0,0,0.4)'}}>
            Gestionale Calcio
          </h1>
          <p className="text-blue-200 text-lg">Gestione Squadra Completa</p>
        </div>

        <div className="bg-white rounded-2xl shadow-2xl p-8">
          <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Accedi</h2>
          
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                placeholder="example@domain.com"
                required
                disabled={loading}
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                required
                disabled={loading}
              />
            </div>

            {error && (
              <div className="bg-red-50 border-2 border-red-300 text-red-700 px-4 py-3 rounded-lg text-sm">
                {error}
              </div>
            )}

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
              {loading ? 'Accesso in corso...' : 'Accedi'}
            </button>
          </form>

        </div>

        <div className="text-center mt-6">
          <p className="text-blue-200 text-sm">
            Gestionale Calcio Â© {new Date().getFullYear()}
          </p>
        </div>
      </div>
    </div>
  );
};

const LogOut = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
    <polyline points="16 17 21 12 16 7"/>
    <line x1="21" y1="12" x2="9" y2="12"/>
  </svg>
);



// Definizione icone SVG
const Download = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
    <polyline points="7 10 12 15 17 10"/>
    <line x1="12" y1="15" x2="12" y2="3"/>
  </svg>
);

const Plus = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="12" y1="5" x2="12" y2="19"/>
    <line x1="5" y1="12" x2="19" y2="12"/>
  </svg>
);

const Trash2 = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <polyline points="3 6 5 6 21 6"/>
    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
    <line x1="10" y1="11" x2="10" y2="17"/>
    <line x1="14" y1="11" x2="14" y2="17"/>
  </svg>
);

const Save = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
    <polyline points="17 21 17 13 7 13 7 21"/>
    <polyline points="7 3 7 8 15 8"/>
  </svg>
);


// IndexedDB wrapper per salvataggio automatico affidabile
const DB_NAME = 'RealDORDatabase';
const DB_VERSION = 1;
const STORE_NAME = 'teamData';

const initDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME);
      }
    };
  });
};

const saveToIndexedDB = async (key, data) => {
  try {
    const db = await initDB();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    store.put(data, key);
    return new Promise((resolve, reject) => {
      transaction.oncomplete = () => resolve(true);
      transaction.onerror = () => reject(transaction.error);
    });
  } catch (error) {
    console.error('Errore salvataggio IndexedDB:', error);
    return false;
  }
};

const loadFromIndexedDB = async (key) => {
  try {
    const db = await initDB();
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(key);
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (error) {
    console.error('Errore caricamento IndexedDB:', error);
    return null;
  }
};

const SoccerTeamTracker = () => {
    // Stati autenticazione
  const [user, setUser] = useState(null);
  const [teamId, setTeamId] = useState(null); // Team ID condiviso tra ADMIN e USER
  const [userRole, setUserRole] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);

  const [isLoading, setIsLoading] = useState(true);
  const [loadingData, setLoadingData] = useState(true); // Track caricamento dati in background
  const [lastSaved, setLastSaved] = useState(null);
  const [recoveryMinutes, setRecoveryMinutes] = useState('');
  const [players, setPlayers] = useState([
    { numero: 1, nome: "Frassine Lorenzo", ruolo: "Portiere", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 2, nome: "Boudene Anis", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 3, nome: "Adu Gyamfi Kyei Ofori", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 4, nome: "Scotti Filippo", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 5, nome: "Zucca Diego", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 6, nome: "Esposito Riccardo", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 7, nome: "Eddikh Aslam", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 8, nome: "Tinubu Ryan Olufemi", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 9, nome: "Medeghini Nicolas", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 10, nome: "Paloschi Riccardo", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 11, nome: "Ekoma Prince Aseosa", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 12, nome: "Venturelli Nicola", ruolo: "Portiere", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 13, nome: "Gabusi Francesco", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 14, nome: "Leone", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 15, nome: "Pupino Lorenzo", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 16, nome: "Testaverde Simone", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 17, nome: "Ayari Youssef", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 18, nome: "Bevilacqua Matteo", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 19, nome: "Bentalha Omar Elfarouk", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 20, nome: "Hepaj Aron", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 21, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 22, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 23, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 24, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 25, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 26, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 27, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 28, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 29, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 30, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" }
  ]);

  const [trainings, setTrainings] = useState([]);
  const [matches, setMatches] = useState([]);
  const [activeTab, setActiveTab] = useState('dashboard'); // Apre sulla dashboard
  const [exerciseModalTraining, setExerciseModalTraining] = useState(null); // Modal esercizi rapido
  const [photoModalTraining, setPhotoModalTraining] = useState(null); // Modal foto allenamento
  const [photoModalMatch, setPhotoModalMatch] = useState(null); // Modal foto partita
  
  // Reset modal esercizi quando cambio tab
  useEffect(() => {
    console.log('ðŸ”„ activeTab changed to:', activeTab);
    setExerciseModalTraining(null);
    setPhotoModalTraining(null);
    setPhotoModalMatch(null);
  }, [activeTab]);
  
  // Log quando exerciseModalTraining cambia
  useEffect(() => {
    console.log('ðŸ“Š exerciseModalTraining changed:', exerciseModalTraining);
    if (exerciseModalTraining) {
      console.log('âœ… Modal dovrebbe essere visibile!');
      console.log('ðŸ“‹ Training data:', exerciseModalTraining.data);
      console.log('ðŸ“‹ Esercizi count:', exerciseModalTraining.esercizi?.length);
      console.log('ðŸŽ¨ activeTab corrente:', activeTab);
      console.log('ðŸ” exerciseModalTraining object completo:', JSON.stringify(exerciseModalTraining, null, 2));
    } else {
      console.log('âŒ Modal chiuso');
    }
  }, [exerciseModalTraining]);
  
  const [editingPlayer, setEditingPlayer] = useState(null);
  const [showInstructionsModal, setShowInstructionsModal] = useState(false);
  const [showResultsModal, setShowResultsModal] = useState(false);  // âœ… Modal elenco risultati
  const [showExitModal, setShowExitModal] = useState(false);  // âœ… Modal chiusura app
  const [expandedTrainings, setExpandedTrainings] = useState({});
  const [trainingTabActive, setTrainingTabActive] = useState({}); // 'presenze' o 'esercizi' per ogni training
  const [newEsercizio, setNewEsercizio] = useState({}); // Form nuovo esercizio per ogni training
  const [editingEsercizio, setEditingEsercizio] = useState(null); // {trainingId, esercizioId}
  const [expandedMatches, setExpandedMatches] = useState({});
  const [matchTimer, setMatchTimer] = useState(0);
  const [isTimerRunning, setIsTimerRunning] = useState(false);
  const [timerInterval, setTimerInterval] = useState(null);
  const [liveMatchMode, setLiveMatchMode] = useState(null);
  const [substitutionMode, setSubstitutionMode] = useState(null);
  const [recoveryTime, setRecoveryTime] = useState(0);
  const [isRecoveryRunning, setIsRecoveryRunning] = useState(false);
  const [recoveryInterval, setRecoveryInterval] = useState(null);
  const [showModuloModal, setShowModuloModal] = useState(null);
  const [moduloTattico, setModuloTattico] = useState({});
  const [playerSelectionModal, setPlayerSelectionModal] = useState(null);
  const [dragState, setDragState] = useState(null); // Per tracciare drag offset
  const [matchEnded, setMatchEnded] = useState(false);
  const [appTitle, setAppTitle] = useState('Moreschi Roberto - Gestionale squadra');
  const [teamName, setTeamName] = useState(''); // Nome squadra per identificare casa/trasferta
  const [isEditingTitle, setIsEditingTitle] = useState(false);
  const [enlargedPhoto, setEnlargedPhoto] = useState(null);
  const [halfTime, setHalfTime] = useState(1);
  const [showVictoryCelebration, setShowVictoryCelebration] = useState(false);
  const [teamLogo, setTeamLogo] = useState('');
  // const [teamLogoStorageUrl, setTeamLogoStorageUrl] = useState(''); // âš ï¸ DEPRECATO - Ora teamLogo contiene direttamente l'URL Storage
  const [confirmDialog, setConfirmDialog] = useState({ show: false, message: '', onConfirm: null });
  const [cardTypeDialog, setCardTypeDialog] = useState({ show: false, cardType: '', playerNum: 0, matchId: null, playerName: '', minuto: null });
  
  // State per Divisione Squadre
  const [numSquadre, setNumSquadre] = useState(2);
  const [includiPortieri, setIncludiPortieri] = useState(true);
  const [selectedTrainingForDivision, setSelectedTrainingForDivision] = useState('');
  const [showDivisioneResults, setShowDivisioneResults] = useState(false);
  const [infortunati, setInfortunati] = useState(new Set());
  const [giocatoriSelezionati, setGiocatoriSelezionati] = useState(new Set());  // Per divisione squadre
  const [regenerateKey, setRegenerateKey] = useState(0);
  
  // State per Convocazioni
  const [convocati, setConvocati] = useState(new Set());
  const [showConvocazioniModal, setShowConvocazioniModal] = useState(false);
  const [selectedMatchForConvocazioni, setSelectedMatchForConvocazioni] = useState('');
  const [infoPartita, setInfoPartita] = useState({
    squadra1: '',
    squadra2: '',
    dataPartita: '',
    oraRitrovo: '',
    indirizzoCompo: ''
  });
  
  // State per Analisi Tattica
  const [moduloAvversario, setModuloAvversario] = useState('');
  
  // ========== STATE PER CLASSIFICA CAMPIONATO ==========
  const [squadreGirone, setSquadreGirone] = useState([]); // Lista squadre del girone
  const [risultatiCampionato, setRisultatiCampionato] = useState([]); // Risultati per giornata
  const [classificaTab, setClassificaTab] = useState('classifica'); // 'squadre', 'risultati', 'classifica'
  const [statsSubTab, setStatsSubTab] = useState('overview'); // 'overview', 'dettagli', 'record'
  const [editingSquadra, setEditingSquadra] = useState(null);
  const [showAddSquadraModal, setShowAddSquadraModal] = useState(false);
  const [selectedGiornata, setSelectedGiornata] = useState(1);
  const [showImportMatchModal, setShowImportMatchModal] = useState(null); // Per import da partite Real DOR
  
  // ========== STATE PER SINCRONIZZAZIONE CLOUD ==========
  const [syncStatus, setSyncStatus] = useState('idle'); // 'idle', 'syncing', 'success', 'error'
  const [lastSynced, setLastSynced] = useState(null);
  const [syncError, setSyncError] = useState('');
  const [syncConflicts, setSyncConflicts] = useState(null);
  const [showConflictModal, setShowConflictModal] = useState(false);
  
  // ========== STATE PER GESTIONE UTENTI ADMIN ==========
  const [allUsers, setAllUsers] = useState([]);
  const [loadingUsers, setLoadingUsers] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [showUserModal, setShowUserModal] = useState(false);
  const [showCreateUserModal, setShowCreateUserModal] = useState(false);
  const [newUserEmail, setNewUserEmail] = useState('');
  const [newUserPassword, setNewUserPassword] = useState('');
  const [newUserRole, setNewUserRole] = useState('user');
  const [userActionLoading, setUserActionLoading] = useState(false);
  
  // ========== STATE PER NUOVE FEATURE ==========
  // Toast Notifications
  const [toasts, setToasts] = useState([]);
  
  // Loading States
  const [loadingMessage, setLoadingMessage] = useState('');
  const [loadingProgress, setLoadingProgress] = useState(0);
  const [showLoading, setShowLoading] = useState(false);
  
  // Gestione Infortuni
  const [injuries, setInjuries] = useState([]);
  const [showInjuryModal, setShowInjuryModal] = useState(false);
  const [selectedPlayerForInjury, setSelectedPlayerForInjury] = useState(null);
  const [showEditInjuryModal, setShowEditInjuryModal] = useState(false);
  const [editingInjury, setEditingInjury] = useState(null);
  
  // Calendario
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [showEventModal, setShowEventModal] = useState(false);
  const [selectedDate, setSelectedDate] = useState(null);
  
  // Drag & Drop
  const [draggedPlayer, setDraggedPlayer] = useState(null);
  const [formationPositions, setFormationPositions] = useState({});
  
  // Sistema MVP
  const [showMVPModal, setShowMVPModal] = useState(false);
  const [selectedMatchForMVP, setSelectedMatchForMVP] = useState(null);

  // ========== SISTEMA BACKUP ==========
  const [lastBackupDate, setLastBackupDate] = useState(null);
  const [availableBackups, setAvailableBackups] = useState([]);
  const [loadingBackups, setLoadingBackups] = useState(false);
  const [deviceType, setDeviceType] = useState(null);
  const [storageStats, setStorageStats] = useState({ used: 0, total: 0 });
  const [lastFullBackupDate, setLastFullBackupDate] = useState(null);
  const [realStorageSize, setRealStorageSize] = useState(null);
  const [loadingStorageSize, setLoadingStorageSize] = useState(false);

  // ========== SISTEMA ADMIN LOCK ==========
  const [adminLockActive, setAdminLockActive] = useState(false); // true se questo admin ha il lock
  const [otherAdminActive, setOtherAdminActive] = useState(null); // Info altro admin se attivo
  const [heartbeatInterval, setHeartbeatInterval] = useState(null); // Interval per heartbeat
  const [showAdminBlockModal, setShowAdminBlockModal] = useState(false); // Modal blocco accesso


  // Gestione autenticazione
  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (user) => {
      if (user) {
        setUser(user);
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            const role = userData.role || 'user';
            const userTeamId = userData.teamId || user.uid; // Usa teamId se esiste, altrimenti user.uid
            
            setUserRole(role);
            setTeamId(userTeamId);
            
            console.log('ðŸ‘¤ Utente autenticato:', {
              email: user.email,
              role: role,
              teamId: userTeamId,
              sameAsUid: userTeamId === user.uid
            });
            
            // âœ… AUTO-SYNC per TUTTI gli utenti al login (USER e ADMIN)
            console.log('ðŸ”„ Auto-sync da cloud al login...', {
              userEmail: user.email,
              role: role,
              teamId: userTeamId
            });
            // Piccolo delay per assicurarsi che tutto sia pronto
            setTimeout(async () => {
              try {
                console.log('â° Inizio loadDataFromCloud...');
                console.log('   ðŸ“ Parametri:', {
                  skipConfirm: true,
                  user: user.email,
                  teamId: userTeamId,
                  silent: true
                });
                
                // Passa user e teamId esplicitamente + silent = true
                await loadDataFromCloud(true, user, userTeamId, true);
                
                console.log('âœ… Auto-sync completato con successo!');
                console.log('   ðŸ“Š Dati ora in memoria');
              } catch (error) {
                console.error('âŒ Errore auto-sync:', error);
                console.error('Dettagli errore:', {
                  message: error.message,
                  code: error.code,
                  stack: error.stack
                });
                // âš ï¸ Mostra toast di errore - importante sapere se auto-sync fallisce!
                showToast('âš ï¸ Errore sincronizzazione automatica: ' + error.message, 'error');
              }
            }, 1500);
          } else {
            setUserRole('user');
          }
        } catch (error) {
          console.error('Errore recupero ruolo:', error);
          setUserRole('user');
        }
      } else {
        setUser(null);
        setUserRole(null);
      }
      setAuthLoading(false);
    });

    return () => unsubscribe();
  }, []);

  useEffect(() => {
    // âœ… CARICAMENTO OTTIMISTICO: Mostra UI SUBITO!
    setIsLoading(false);
    
    const loadData = async () => {
      setLoadingData(true); // Indica che dati sono in caricamento
      try {
        const savedData = await loadFromIndexedDB('squadraRealDOR');
        if (savedData) {
          let loadedPlayers = savedData.players || players;
          
          loadedPlayers = loadedPlayers.map(p => ({
            ...p,
            dataCreazione: p.dataCreazione || (p.nome ? "2025-08-01" : ""),
            fuoriRosa: p.fuoriRosa || false // âœ… Normalizza fuoriRosa
          }));
          
          if (loadedPlayers.length < 30) {
            const currentLength = loadedPlayers.length;
            for (let i = currentLength + 1; i <= 30; i++) {
              loadedPlayers.push({ 
                numero: i, 
                nome: "", 
                ruolo: "", 
                dataNascita: "", 
                telefono: "", 
                foto: "", 
                piede: "",
                dataCreazione: "",
                fuoriRosa: false // âœ… Default false per nuovi slot
              });
            }
          }
          
          setPlayers(loadedPlayers);
          setTrainings(savedData.trainings || []);
          setMatches(savedData.matches || []);
          setAppTitle(savedData.appTitle || appTitle);
          setTeamName(savedData.teamName || '');
          setTeamLogo(savedData.teamLogo || '');
          // setTeamLogoStorageUrl(savedData.teamLogoStorageUrl || ''); // âš ï¸ RIMOSSO
          setInjuries(savedData.injuries || []);
          setSquadreGirone(savedData.squadreGirone || []);
          setRisultatiCampionato(savedData.risultatiCampionato || []);
          setLastSaved(savedData.lastSaved ? new Date(savedData.lastSaved) : null);
        }
      } catch (error) {
        console.error('Errore caricamento dati:', error);
      } finally {
        setLoadingData(false); // Dati caricati, nasconde badge
      }
    };
    loadData();
  }, []);

  // ========== MIGRAZIONE AUTOMATICA LOGO A STORAGE ==========
  useEffect(() => {
    const migrateLogoToStorage = async () => {
      // Solo se:
      // 1. User autenticato
      // 2. teamLogo esiste
      // 3. teamLogo Ã¨ base64 (NON URL Storage)
      if (!user || !teamLogo || teamLogo.startsWith('https://firebasestorage')) {
        return;
      }

      console.log('ðŸ”„ Migrazione logo su cloud...');
      
      try {
        // Converti base64 a blob
        const response = await fetch(teamLogo);
        const blob = await response.blob();
        
        // Upload su cloud
        const storageRef = storage.ref();
        const fileName = `team-logos/${user.uid}/logo_migrated_${Date.now()}.png`;
        const fileRef = storageRef.child(fileName);
        
        await fileRef.put(blob);
        const downloadURL = await fileRef.getDownloadURL();
        
        // Sostituisci teamLogo con URL Storage
        setTeamLogo(downloadURL);
        
        console.log('âœ… Logo migrato su Storage:', downloadURL);
        showToast('âœ… Logo migrato su cloud!', 'success');
        
      } catch (error) {
        console.error('âŒ Errore migrazione logo:', error);
        // Non mostrare toast di errore per non confondere l'utente
        // Il logo base64 continuerÃ  a funzionare
      }
    };

    // Esegui migrazione dopo 2 secondi dall'avvio (per non bloccare caricamento iniziale)
    const timeout = setTimeout(() => {
      migrateLogoToStorage();
    }, 2000);

    return () => clearTimeout(timeout);
  }, [user, teamLogo]);

  // ========== CONTROLLO ADMIN LOCK AL LOGIN ==========
  useEffect(() => {
    if (!user || !teamId || userRole !== 'admin') return;
    
    const initializeAdminLock = async () => {
      console.log('ðŸ”’ Controllo admin lock per team:', teamId);
      
      // Controlla se c'Ã¨ un altro admin attivo
      const activeAdmin = await checkActiveAdmin();
      
      // âœ… FIX: Blocca SEMPRE se c'Ã¨ un lock attivo, anche se Ã¨ lo stesso utente da altro dispositivo!
      if (activeAdmin) {
        // C'Ã¨ un admin attivo (stesso utente o no, blocca comunque)
        console.log('âš ï¸ Admin attivo trovato. Dispositivo:', activeAdmin.deviceName);
        setOtherAdminActive(activeAdmin);
        setShowAdminBlockModal(true);
      } else {
        // Nessun admin attivo, acquisici il lock
        console.log('âœ… Nessun admin attivo, acquisisco lock...');
        const acquired = await acquireAdminLock();
        
        if (acquired) {
          showToast('âœ… Accesso consentito, puoi lavorare!', 'success');
        } else {
          showToast('âš ï¸ Errore acquisizione accesso, riprova', 'error');
        }
      }
    };
    
    initializeAdminLock();
  }, [user, teamId, userRole]);

  // ========== RILASCIO LOCK AUTOMATICO ALLA CHIUSURA ==========
  useEffect(() => {
    if (!user || userRole !== 'admin' || !adminLockActive) return;
    
    const handleBeforeUnload = async (e) => {
      // Rilascia il lock quando chiude la finestra/tab
      await releaseAdminLock();
    };
    
    window.addEventListener('beforeunload', handleBeforeUnload);
    
    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
      // Cleanup anche qui per sicurezza
      if (adminLockActive) {
        releaseAdminLock();
      }
    };
  }, [user, userRole, adminLockActive]);

  // NOTA: giocatoriSelezionati parte vuoto (size=0), quindi organizzaGiocatori 
  // includerÃ  tutti i giocatori per default. Quando si importa da allenamento,
  // viene popolato solo con i presenti.

  // Salvataggio AUTOMATICO
  useEffect(() => {
    if (isLoading) return;
    
    const saveData = async () => {
      const dataToSave = {
        players,
        trainings,
        matches,
        appTitle,
        teamName,
        teamLogo,  // Ora contiene direttamente URL Storage o base64
        // teamLogoStorageUrl, // âš ï¸ RIMOSSO - Campo ridondante
        injuries,
        squadreGirone,
        risultatiCampionato,
        lastSaved: new Date().toISOString()
      };
      
      const success = await saveToIndexedDB('squadraRealDOR', dataToSave);
      if (success) {
        setLastSaved(new Date());
      }
    };
    
    saveData();
  }, [players, trainings, matches, appTitle, teamName, teamLogo, injuries, squadreGirone, risultatiCampionato, isLoading]);

  // ========== AUTO-SALVATAGGIO CLOUD OGNI 5 MINUTI (SOLO ADMIN) ==========
  useEffect(() => {
    // Solo per admin con lock attivo
    if (!user || userRole !== 'admin' || !adminLockActive) return;
    
    console.log('â° Auto-salvataggio cloud attivato (ogni 5 minuti)');
    
    // Prima salvataggio dopo 5 minuti
    const autoSaveInterval = setInterval(async () => {
      try {
        console.log('ðŸ’¾ Auto-salvataggio cloud (5 min timer)...');
        await saveDataToCloud(true); // silent = true, nessun toast
        console.log('âœ… Auto-salvataggio cloud completato');
      } catch (error) {
        console.error('âŒ Errore auto-salvataggio cloud:', error);
        // Non mostriamo toast per non disturbare l'utente
      }
    }, 5 * 60 * 1000); // 5 minuti
    
    return () => clearInterval(autoSaveInterval);
  }, [user, userRole, adminLockActive, players, trainings, matches, injuries, squadreGirone, risultatiCampionato]);

  // ========== POLLING AUTO-RELOAD PER USER (OGNI MINUTO) ==========
  useEffect(() => {
    // Solo per user (non admin)
    if (!user || userRole !== 'user') return;
    
    console.log('ðŸ”„ Polling auto-reload attivato per USER (ogni minuto)');
    
    // Prima reload dopo 1 minuto
    const pollingInterval = setInterval(async () => {
      try {
        console.log('ðŸ”„ Polling: ricarico dati da cloud...');
        await loadDataFromCloud(true, user, teamId, true); // silent = true
        console.log('âœ… Polling: dati aggiornati da cloud');
      } catch (error) {
        console.error('âŒ Errore polling reload:', error);
        // Continua il polling anche se c'Ã¨ errore
      }
    }, 60 * 1000); // 1 minuto
    
    return () => clearInterval(pollingInterval);
  }, [user, userRole, teamId]);

  // ========== CARICAMENTO DATA ULTIMO BACKUP ==========
  useEffect(() => {
    const savedDate = localStorage.getItem('lastBackupDate');
    if (savedDate) {
      setLastBackupDate(savedDate);
    }
  }, []);

  useEffect(() => {
    if (isTimerRunning) {
      const interval = setInterval(() => {
        setMatchTimer(prev => {
          const newTime = prev + 1;
          
          if (newTime === 2700 && halfTime === 1) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 4; i++) {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 550;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
              }, i * 1000);
            }
            
            setIsTimerRunning(false);
            setIsRecoveryRunning(true);
            setRecoveryTime(0);
          }
          
          if (newTime === 5400 && halfTime === 2) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 4; i++) {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 550;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
              }, i * 1000);
            }
            
            setIsTimerRunning(false);
            setIsRecoveryRunning(true);
            setRecoveryTime(0);
          }
          
          return newTime;
        });
      }, 1000);
      setTimerInterval(interval);
      return () => clearInterval(interval);
    } else if (timerInterval) {
      clearInterval(timerInterval);
      setTimerInterval(null);
    }
  }, [isTimerRunning, halfTime]);

  useEffect(() => {
    if (isRecoveryRunning) {
      const interval = setInterval(() => {
        setRecoveryTime(prev => {
          const newTime = prev + 1;
          if (recoveryMinutes && parseInt(recoveryMinutes) > 0 && newTime === parseInt(recoveryMinutes) * 60) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 4; i++) {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 550;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
              }, i * 1000);
            }
            
            setIsRecoveryRunning(false);
            
            if (halfTime === 1) {
              setHalfTime(2);
              setMatchTimer(2700);
              setRecoveryTime(0);
              setRecoveryMinutes('');
            } else {
              setMatchEnded(true);
            }
          }
          return newTime;
        });
      }, 1000);
      setRecoveryInterval(interval);
      return () => clearInterval(interval);
    } else if (recoveryInterval) {
      clearInterval(recoveryInterval);
      setRecoveryInterval(null);
    }
  }, [isRecoveryRunning, recoveryMinutes, halfTime]);

  const startTimer = () => setIsTimerRunning(true);
  const pauseTimer = () => setIsTimerRunning(false);

  const addMinute = () => {
    setMatchTimer(prev => {
      const maxTime = halfTime === 1 ? 2700 : 5400;
      return Math.min(prev + 60, maxTime);
    });
  };

  const removeMinute = () => {
    setMatchTimer(prev => {
      const minTime = halfTime === 1 ? 0 : 2700;
      return Math.max(prev - 60, minTime);
    });
  };

  const addRecoveryMinute = () => {
    setRecoveryTime(prev => prev + 60);
  };

  const removeRecoveryMinute = () => {
    setRecoveryTime(prev => Math.max(prev - 60, 0));
  };

  const endMatch = () => {
    setIsTimerRunning(false);
    setIsRecoveryRunning(false);
    setMatchEnded(true);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const startLiveMatch = (matchId) => {
    setLiveMatchMode(matchId);
    setMatchTimer(0);
    setIsTimerRunning(false);
    setSubstitutionMode(null);
    setRecoveryTime(0);
    setIsRecoveryRunning(false);
    setMatchEnded(false);
    setRecoveryMinutes('');
  };

  const closeLiveMatch = () => {
    setLiveMatchMode(null);
    setIsTimerRunning(false);
    setMatchTimer(0);
    setSubstitutionMode(null);
    setRecoveryTime(0);
    setIsRecoveryRunning(false);
    setMatchEnded(false);
    setRecoveryMinutes('');
  };

  const initiateSubstitution = (playerOut) => {
    const match = matches.find(m => m.id === liveMatchMode);
    const player = players.find(p => p.numero === playerOut);
    
    if (match && player) {
      const numSostituzioni = Object.values(match.sostituzioni || {}).filter(v => v === true).length;
      
      if (numSostituzioni >= 5) {
        showConfirm(`ðŸš« SOSTITUZIONE NON CONSENTITA!\n\nâš ï¸ HAI GIÃ€ EFFETTUATO 5 SOSTITUZIONI\n\nNon Ã¨ possibile effettuare la 6Â° sostituzione.\nIl regolamento consente un massimo di 5 sostituzioni per partita.`, () => {});
        return;
      }
      
      if (numSostituzioni === 4) {
        showConfirm(`âš ï¸ ATTENZIONE - ULTIMA SOSTITUZIONE!\n\nQuesta sarÃ  la tua 5Â° e ULTIMA sostituzione possibile.\n\nESCE: ${player.nome} (#${playerOut})\n\nConfermi?`, () => {
          setSubstitutionMode(playerOut);
        });
      } else {
        showConfirm(`ðŸ”„ Confermi la SOSTITUZIONE di ${player.nome} (#${playerOut})?\n\nDopo aver confermato, clicca sul giocatore che entra dalla panchina.\n\nSostituzioni effettuate: ${numSostituzioni}/5`, () => {
          setSubstitutionMode(playerOut);
        });
      }
    }
  };

  const completeSubstitution = (matchId, playerOut, playerIn) => {
    const match = matches.find(m => m.id === matchId);
    const playerOutData = players.find(p => p.numero === playerOut);
    const playerInData = players.find(p => p.numero === playerIn);
    
    if (match && playerOutData && playerInData) {
      let minutiAttuali;
      if (halfTime === 1) {
        minutiAttuali = Math.floor(matchTimer / 60);
      } else {
        minutiAttuali = Math.floor(matchTimer / 60);
      }
      
      const ordineDistinta = match.ordineDistinta || {};
      const magliaOut = ordineDistinta[playerOut] || playerOut;
      const magliaIn = ordineDistinta[playerIn] || playerIn;
      
      showConfirm(`ðŸ”„ CONFERMA SOSTITUZIONE:\n\nESCE: ${playerOutData.nome} (#${magliaOut})\nENTRA: ${playerInData.nome} (#${magliaIn})\n\nMinuto: ${minutiAttuali}'`, () => {
        const minutiGiocatiOut = minutiAttuali;
        const minutiGiocatiIn = 90 - minutiAttuali;
        
        const newSost = { ...match.sostituzioni, [playerOut]: true };
        const newEntr = { ...match.entrati, [playerIn]: true };
        const newMin = { 
          ...match.minutiGiocati, 
          [playerOut]: minutiGiocatiOut.toString(),
          [playerIn]: minutiGiocatiIn.toString()
        };
        
        const ordineDistinta = match.ordineDistinta || {};
        const newOrdineDistinta = { ...ordineDistinta };
        
        let posizioneVisualizzazione = match.posizioneVisualizzazione;
        if (!posizioneVisualizzazione) {
          posizioneVisualizzazione = {};
          
          const titolariArray = Object.keys(match.titolari)
            .filter(num => match.titolari[num])
            .map(num => parseInt(num));
          
          const hasOrdineDistinta = titolariArray.some(num => ordineDistinta[num] && ordineDistinta[num] !== num.toString());
          
          if (hasOrdineDistinta) {
            titolariArray.sort((a, b) => {
              const ordA = parseInt(ordineDistinta[a] || 999);
              const ordB = parseInt(ordineDistinta[b] || 999);
              if (ordA === ordB) return a - b;
              return ordA - ordB;
            });
          } else {
            titolariArray.sort((a, b) => a - b);
          }
          
          titolariArray.forEach((numero, index) => {
            posizioneVisualizzazione[numero] = index + 1;
          });
        }
        const newPosizioneVisualizzazione = { ...posizioneVisualizzazione };
        
        let posizioneDelSostituito = newPosizioneVisualizzazione[playerOut];
        let posizioneDelSubentrante = newPosizioneVisualizzazione[playerIn];
        
        if (!posizioneDelSubentrante) {
          const maxPos = Math.max(...Object.values(newPosizioneVisualizzazione).filter(v => !isNaN(v)));
          posizioneDelSubentrante = maxPos + 1;
        }
        
        if (!posizioneDelSostituito) {
          const titolariArray = Object.keys(match.titolari)
            .filter(num => match.titolari[num])
            .map(num => parseInt(num));
          
          const hasOrdineDistinta = titolariArray.some(num => ordineDistinta[num] && ordineDistinta[num] !== num.toString());
          
          if (hasOrdineDistinta) {
            titolariArray.sort((a, b) => {
              const ordA = parseInt(ordineDistinta[a] || 999);
              const ordB = parseInt(ordineDistinta[b] || 999);
              if (ordA === ordB) return a - b;
              return ordA - ordB;
            });
          } else {
            titolariArray.sort((a, b) => a - b);
          }
          
          const index = titolariArray.indexOf(playerOut);
          if (index !== -1) {
            posizioneDelSostituito = index + 1;
          }
        }
        
        if (posizioneDelSostituito) {
          newPosizioneVisualizzazione[playerIn] = posizioneDelSostituito;
          newPosizioneVisualizzazione[playerOut] = posizioneDelSubentrante;
        }
        
        const sostituzioniDettaglio = match.sostituzioniDettaglio || {};
        const newSostituzioniDettaglio = {
          ...sostituzioniDettaglio,
          [playerOut]: { sostituito: true, sostituitoreDa: playerIn, minuto: minutiAttuali },
          [playerIn]: { entrato: true, alPostoDi: playerOut, minuto: minutiAttuali }
        };
        
        setMatches(matches.map(m => 
          m.id === matchId ? { 
            ...m,
            sostituzioni: newSost, 
            entrati: newEntr,
            minutiGiocati: newMin,
            ordineDistinta: newOrdineDistinta,
            posizioneVisualizzazione: newPosizioneVisualizzazione,
            sostituzioniDettaglio: newSostituzioniDettaglio
          } : m
        ));
        
        setSubstitutionMode(null);
      });
    }
  };

  const cancelSubstitution = () => {
    setSubstitutionMode(null);
  };

  const showConfirm = (message, onConfirm) => {
    setConfirmDialog({ show: true, message, onConfirm });
  };

  const handleConfirm = () => {
    if (confirmDialog.onConfirm) {
      confirmDialog.onConfirm();
    }
    setConfirmDialog({ show: false, message: '', onConfirm: null });
  };

  const handleCancel = () => {
    setConfirmDialog({ show: false, message: '', onConfirm: null });
  };

  // ========== FUNZIONI TOAST NOTIFICATIONS ==========
  const showToast = (message, type = 'info', duration = 3000) => {
    const id = Date.now();
    const toast = { id, message, type };
    
    setToasts(prev => [...prev, toast]);
    
    setTimeout(() => {
      setToasts(prev => prev.map(t => t.id === id ? { ...t, exiting: true } : t));
      setTimeout(() => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, 300);
    }, duration);
  };
  
  const showLoadingWithProgress = (message, duration = 0) => {
    setLoadingMessage(message);
    setLoadingProgress(0);
    setShowLoading(true);
    
    if (duration > 0) {
      const steps = 100;
      const interval = duration / steps;
      let current = 0;
      
      const progressInterval = setInterval(() => {
        current += 1;
        setLoadingProgress(current);
        
        if (current >= 100) {
          clearInterval(progressInterval);
          setTimeout(() => setShowLoading(false), 500);
        }
      }, interval);
    }
  };
  
  const hideLoading = () => {
    setShowLoading(false);
    setLoadingProgress(0);
  };
  
  // ========== FUNZIONI GESTIONE INFORTUNI ==========
  const addInjury = (playerNum, injuryData) => {
    const newInjury = {
      id: Date.now(),
      playerNum,
      playerName: players.find(p => p.numero === playerNum)?.nome || '',
      type: injuryData.type,
      startDate: injuryData.startDate || new Date().toISOString().split('T')[0],
      estimatedReturn: injuryData.estimatedReturn,
      notes: injuryData.notes || '',
      status: 'active'
    };
    
    setInjuries(prev => [...prev, newInjury]);
    showToast(`ðŸ¤• Infortunio registrato per ${newInjury.playerName}`, 'warning');
  };
  
  const updateInjuryStatus = (injuryId, newStatus) => {
    setInjuries(prev => prev.map(inj => 
      inj.id === injuryId ? { ...inj, status: newStatus } : inj
    ));
    
    const injury = injuries.find(i => i.id === injuryId);
    if (injury) {
      const statusMessages = {
        'active': 'ðŸ¤• Infortunio attivo',
        'recovering': 'ðŸ“ˆ In recupero',
        'recovered': 'âœ… Recuperato'
      };
      showToast(`${statusMessages[newStatus]}: ${injury.playerName}`, 'success');
    }
  };
  
  const removeInjury = (injuryId) => {
    setInjuries(prev => prev.filter(inj => inj.id !== injuryId));
    showToast('Infortunio rimosso', 'info');
  };
  
  const getActiveInjuries = () => {
    return injuries.filter(inj => inj.status === 'active');
  };
  
  const getPlayerInjury = (playerNum) => {
    return injuries.find(inj => inj.playerNum === playerNum && inj.status === 'active');
  };
  
  // ========== FUNZIONI CALENDARIO ==========
  const getDaysInMonth = (month, year) => {
    return new Date(year, month + 1, 0).getDate();
  };
  
  const getFirstDayOfMonth = (month, year) => {
    return new Date(year, month, 1).getDay();
  };
  
  const getEventsForDate = (date) => {
    const dateStr = date.toISOString().split('T')[0];
    const dayTrainings = trainings.filter(t => t.data === dateStr);
    const dayMatches = matches.filter(m => m.data === dateStr);
    return { trainings: dayTrainings, matches: dayMatches };
  };
  
  // ========== FUNZIONI DRAG & DROP ==========
  const handleDragStart = (e, playerNum) => {
    setDraggedPlayer(playerNum);
    e.dataTransfer.effectAllowed = 'move';
  };
  
  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };
  
  const handleDrop = (e, position) => {
    e.preventDefault();
    if (draggedPlayer !== null) {
      setFormationPositions(prev => ({
        ...prev,
        [position]: draggedPlayer
      }));
      setDraggedPlayer(null);
    }
  };
  
  const clearPosition = (position) => {
    setFormationPositions(prev => {
      const newPositions = { ...prev };
      delete newPositions[position];
      return newPositions;
    });
  };

  // Gestione logout
  const handleLogout = async () => {
    // âœ… Solo ADMIN â†’ Mostra modal salvataggio
    if (userRole === 'admin') {
      setShowExitModal(true);
      return;
    }
    
    // Per USER â†’ Chiude direttamente la finestra
    window.close();
  };

  // ========== FUNZIONI MODAL CHIUSURA APP ==========
  
  const handleExitWithSave = async () => {
    try {
      setShowExitModal(false);
      showToast('â˜ï¸ Preparazione dati per il salvataggio...', 'info');
      
      // âš ï¸ CRITICO: Delay per assicurare che tutti gli state siano aggiornati
      // React aggiorna gli state in modo asincrono, quindi aspettiamo che
      // eventuali modifiche recenti (fuoriRosa, injuries) siano completate
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Log dettagliato PRIMA del salvataggio
      console.log('ðŸ” State PRIMA del salvataggio cloud:', {
        players: players.length,
        injuries: injuries.length,
        injuriesData: injuries,
        playersWithFuoriRosa: players.filter(p => p.fuoriRosa).length,
        fuoriRosaData: players.filter(p => p.fuoriRosa).map(p => ({ numero: p.numero, nome: p.nome, fuoriRosa: p.fuoriRosa }))
      });
      
      showToast('â˜ï¸ Salvataggio su cloud in corso...', 'info');
      await saveDataToCloud(true); // silent = true per non mostrare toast doppio
      
      // Log DOPO il salvataggio
      console.log('âœ… Salvataggio cloud completato');
      
      // âœ… NUOVO: Rilascia lock admin prima di chiudere
      if (userRole === 'admin' && adminLockActive) {
        await releaseAdminLock();
        console.log('âœ… Lock admin rilasciato prima della chiusura');
      }
      
      showToast('âœ… Dati salvati! A presto!', 'success');
      // Piccolo delay per far vedere il toast
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // âœ… Logout da Firebase invece di window.close()
      try {
        await auth.signOut();
        console.log('âœ… Logout completato - Torna al login');
      } catch (error) {
        console.error('âŒ Errore logout:', error);
        window.location.reload();
      }
    } catch (error) {
      console.error('âŒ Errore salvataggio:', error);
      showToast('âŒ Errore: ' + error.message, 'error');
      // Non chiudere se c'Ã¨ errore
    }
  };

  const handleExitWithoutSave = async () => {
    setShowExitModal(false);
    
    // âœ… NUOVO: Rilascia lock admin
    if (userRole === 'admin' && adminLockActive) {
      await releaseAdminLock();
      console.log('âœ… Lock admin rilasciato senza salvataggio');
    }
    
    showToast('ðŸ‘‹ A presto!', 'info');
    setTimeout(async () => {
      try {
        // âœ… Logout da Firebase invece di window.close()
        // Con persistenza NONE, torna automaticamente al login!
        await auth.signOut();
        console.log('âœ… Logout completato - Torna al login');
      } catch (error) {
        console.error('âŒ Errore logout:', error);
        // Forza ricarica pagina se logout fallisce
        window.location.reload();
      }
    }, 500);
  };

  const handleCancelExit = () => {
    setShowExitModal(false);
  };

  // ========== FUNZIONE HELPER: MATCHING INTELLIGENTE CASA/TRASFERTA ==========
  /**
   * Determina se la squadra gioca in casa o trasferta
   * @param {Object} match - L'oggetto partita
   * @returns {boolean} - true se giochi in casa, false se in trasferta
   */
  const isTeamPlayingHome = (match) => {
    // Se ci sono squadraCasa e squadraTrasferta, usa QUELLI per determinare casa/trasferta
    if (match.squadraCasa && match.squadraTrasferta && teamName && teamName.trim()) {
      const teamLower = teamName.toLowerCase().trim();
      const casaLower = match.squadraCasa.toLowerCase().trim();
      
      // Match esatto
      if (casaLower === teamLower) {
        return true; // Sei in casa
      }
      
      // Match parziale intelligente (almeno 2 parole in comune)
      const teamWords = teamLower.split(/\s+/).filter(w => w.length > 2);
      const casaWords = casaLower.split(/\s+/).filter(w => w.length > 2);
      
      const commonWords = teamWords.filter(tw => 
        casaWords.some(cw => cw.includes(tw) || tw.includes(cw))
      );
      
      if (commonWords.length >= 2) {
        return true; // Sei in casa
      }
      
      // Non matcha con squadraCasa â†’ sei in trasferta
      return false;
    }
    
    // Fallback per vecchie partite o partite senza squadraCasa/squadraTrasferta
    // In questo caso, assumiamo che sia sempre casa (comportamento di default)
    return true;
  };

  const quickAddGoal = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      showConfirm(`âš½ Confermi il GOL di ${player.nome} (#${playerNum})?`, () => {
        const newGol = { ...match.golFatti, [playerNum]: (parseInt(match.golFatti[playerNum] || 0) + 1).toString() };
        
        // Salva evento in timeline
        const timeline = match.timeline || [];
        const newEvent = {
          id: Date.now(),
          tipo: 'gol',
          playerNum: playerNum,
          playerNome: player.nome,
          timestamp: new Date().toISOString(),
          minuto: minuto  // STEP 3: Aggiungi minuto
        };
        
        // Update atomico - aggiorna tutto insieme
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, golFatti: newGol, timeline: [...timeline, newEvent] }
            : m
        ));
      });
    }
  };

  const quickAddAssist = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      showConfirm(`ðŸŽ¯ Confermi l'ASSIST di ${player.nome} (#${playerNum})?`, () => {
        const newAss = { ...match.assist, [playerNum]: (parseInt(match.assist[playerNum] || 0) + 1).toString() };
        
        // Salva evento in timeline
        const timeline = match.timeline || [];
        const newEvent = {
          id: Date.now(),
          tipo: 'assist',
          playerNum: playerNum,
          playerNome: player.nome,
          timestamp: new Date().toISOString(),
          minuto: minuto  // STEP 3: Aggiungi minuto
        };
        
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, assist: newAss, timeline: [...timeline, newEvent] }
            : m
        ));
      });
    }
  };

  const quickAddGoalConceded = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      showConfirm(`âš½ Confermi il GOL SUBITO da ${player.nome} (#${playerNum})?`, () => {
        const newGS = { ...match.golSubiti, [playerNum]: (parseInt(match.golSubiti[playerNum] || 0) + 1).toString() };
        
        // Salva evento in timeline
        const timeline = match.timeline || [];
        const newEvent = {
          id: Date.now(),
          tipo: 'golsubito',
          playerNum: playerNum,
          playerNome: player.nome,
          timestamp: new Date().toISOString(),
          minuto: minuto  // STEP 3: Aggiungi minuto
        };
        
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, golSubiti: newGS, timeline: [...timeline, newEvent] }
            : m
        ));
      });
    }
  };

  const quickAddYellowCard = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      setCardTypeDialog({
        show: true,
        cardType: 'yellow',
        playerNum: playerNum,
        matchId: matchId,
        playerName: player.nome,
        minuto: minuto  // STEP 3: Aggiungi minuto
      });
    }
  };

  const quickAddRedCard = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      setCardTypeDialog({
        show: true,
        cardType: 'red',
        playerNum: playerNum,
        matchId: matchId,
        playerName: player.nome,
        minuto: minuto  // STEP 3: Aggiungi minuto
      });
    }
  };
  
  const assignCard = (type) => {
    const { cardType, playerNum, matchId, playerName, minuto } = cardTypeDialog;
    const match = matches.find(m => m.id === matchId);
    
    if (!match) return;
    
    if (cardType === 'yellow') {
      const timeline = match.timeline || [];
      const newEvent = {
        id: Date.now(),
        tipo: 'giallo',
        sottotipo: type,
        playerNum: playerNum,
        playerNome: playerName,
        timestamp: new Date().toISOString(),
        minuto: minuto  // STEP 3: Aggiungi minuto
      };
      
      if (type === 'gioco') {
        const newGG = { ...match.gialli_gioco, [playerNum]: (parseInt(match.gialli_gioco[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, gialli_gioco: newGG, timeline: [...timeline, newEvent] }
            : m
        ));
      } else {
        const newGP = { ...match.gialli_protesta, [playerNum]: (parseInt(match.gialli_protesta[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, gialli_protesta: newGP, timeline: [...timeline, newEvent] }
            : m
        ));
      }
      
    } else if (cardType === 'red') {
      const timeline = match.timeline || [];
      const newEvent = {
        id: Date.now(),
        tipo: 'rosso',
        sottotipo: type,
        playerNum: playerNum,
        playerNome: playerName,
        timestamp: new Date().toISOString(),
        minuto: minuto  // STEP 3: Aggiungi minuto
      };
      
      if (type === 'gioco') {
        const newRG = { ...match.rossi_gioco, [playerNum]: (parseInt(match.rossi_gioco[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, rossi_gioco: newRG, timeline: [...timeline, newEvent] }
            : m
        ));
      } else {
        const newRP = { ...match.rossi_protesta, [playerNum]: (parseInt(match.rossi_protesta[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, rossi_protesta: newRP, timeline: [...timeline, newEvent] }
            : m
        ));
      }
    }
    
    setCardTypeDialog({ show: false, cardType: '', playerNum: 0, matchId: null, playerName: '', minuto: null });
  };

  const toggleTraining = (id) => {
    setExpandedTrainings(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const toggleMatch = (id) => {
    setExpandedMatches(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const getSortedTrainings = () => {
    return [...trainings].sort((a, b) => new Date(b.data) - new Date(a.data));
  };

  const getSortedMatches = () => {
    return [...matches].sort((a, b) => new Date(b.data) - new Date(a.data));
  };

  const updatePlayer = (numero, field, value) => {
    setPlayers(players.map(p => 
      p.numero === numero ? { ...p, [field]: value } : p
    ));
  };

  const clearPlayer = (numero) => {
    setPlayers(players.map(p => 
      p.numero === numero ? { ...p, nome: '', ruolo: '', dataNascita: '', telefono: '', foto: '', piede: '' } : p
    ));
  };

  const handleImageUpload = async (numero, e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('âŒ Seleziona un file immagine valido (JPG, PNG, ecc.)');
      e.target.value = '';
      return;
    }

    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      alert(`âŒ File troppo grande (${(file.size / 1024 / 1024).toFixed(1)}MB). Max 5MB.`);
      e.target.value = '';
      return;
    }

    if (!user) {
      alert('âŒ Devi essere autenticato per caricare foto su cloud');
      e.target.value = '';
      return;
    }

    showToast('ðŸ“¤ Caricamento foto su cloud...', 'info', 2000);

    try {
      // Comprimi immagine prima dell'upload
      const compressedBlob = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            // Ridimensiona a 300x300 per qualitÃ  migliore
            const maxWidth = 300;
            const maxHeight = 300;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(
              (blob) => resolve(blob),
              'image/jpeg',
              0.85 // QualitÃ  85%
            );
          };
          img.onerror = () => reject(new Error('Errore caricamento immagine'));
          img.src = event.target.result;
        };
        reader.onerror = () => reject(new Error('Errore lettura file'));
        reader.readAsDataURL(file);
      });

      // Upload su cloud
      const storageRef = storage.ref();
      const fileName = `players/${user.uid}/${numero}_${Date.now()}.jpg`;
      const fileRef = storageRef.child(fileName);
      
      const uploadTask = await fileRef.put(compressedBlob);
      const downloadURL = await fileRef.getDownloadURL();
      
      // Elimina vecchia foto se presente
      const player = players.find(p => p.numero === numero);
      if (player?.foto && player.foto.startsWith('https://firebasestorage')) {
        try {
          const oldRef = storage.refFromURL(player.foto);
          await oldRef.delete();
        } catch (err) {
          console.log('Vecchia foto non trovata o giÃ  eliminata');
        }
      }
      
      // Salva URL nel player
      updatePlayer(numero, 'foto', downloadURL);
      
      const sizeKB = Math.round((uploadTask.bytesTransferred || 0) / 1024);
      showToast(`âœ… Foto caricata su cloud! (${sizeKB}KB)`, 'success');
      
      e.target.value = '';
    } catch (error) {
      console.error('Errore upload foto:', error);
      showToast('âŒ Errore caricamento foto: ' + error.message, 'error', 5000);
      e.target.value = '';
    }
  };

  const handleLogoUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      showToast('âŒ Seleziona un file immagine valido (JPG, PNG, ecc.)', 'error');
      e.target.value = '';
      return;
    }

    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      showToast(`âŒ File troppo grande (${(file.size / 1024 / 1024).toFixed(1)}MB). Max: 5MB`, 'error');
      e.target.value = '';
      return;
    }

    // Verifica autenticazione
    if (!user) {
      showToast('âŒ Devi essere autenticato per caricare il logo', 'error');
      e.target.value = '';
      return;
    }

    try {
      showLoadingWithProgress('ðŸ“¤ Caricamento logo squadra...', 0);
      
      // Comprimi logo (200x200px)
      const compressedBlob = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const maxWidth = 200;
            const maxHeight = 200;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
              if (blob) {
                resolve(blob);
              } else {
                reject(new Error('Errore compressione'));
              }
            }, 'image/png', 0.9);
          };
          img.onerror = () => reject(new Error('Errore caricamento immagine'));
          img.src = event.target.result;
        };
        reader.onerror = () => reject(new Error('Errore lettura file'));
        reader.readAsDataURL(file);
      });

      setLoadingProgress(30);

      // Elimina vecchio logo da Storage se presente
      if (teamLogo && teamLogo.startsWith('https://firebasestorage')) {
        try {
          const oldRef = storage.refFromURL(teamLogo);
          await oldRef.delete();
        } catch (err) {
          console.log('Vecchio logo non trovato o giÃ  eliminato');
        }
      }

      // Upload su cloud
      const storageRef = storage.ref();
      const fileName = `team-logos/${user.uid}/logo_${Date.now()}.png`;
      const fileRef = storageRef.child(fileName);
      
      const uploadTask = await fileRef.put(compressedBlob);
      const downloadURL = await fileRef.getDownloadURL();
      
      setLoadingProgress(80);

      // Salva URL logo (ora contiene direttamente l'URL Storage)
      setTeamLogo(downloadURL);
      // setTeamLogoStorageUrl(fileName); // âš ï¸ RIMOSSO - Non piÃ¹ necessario
      
      setLoadingProgress(100);
      setTimeout(() => hideLoading(), 500);
      
      const sizeKB = Math.round((uploadTask.bytesTransferred || 0) / 1024);
      showToast(`âœ… Logo caricato su cloud! (${sizeKB}KB)`, 'success');
      e.target.value = '';
      
    } catch (error) {
      hideLoading();
      console.error('Errore upload logo:', error);
      showToast('âŒ Errore caricamento logo: ' + error.message, 'error', 5000);
      e.target.value = '';
    }
  };

  const removeLogo = async () => {
    if (!window.confirm('Sei sicuro di voler rimuovere il logo?')) return;
    
    try {
      // Elimina da Storage se Ã¨ un URL Storage
      if (teamLogo && teamLogo.startsWith('https://firebasestorage')) {
        try {
          const storageRef = storage.refFromURL(teamLogo);
          await storageRef.delete();
        } catch (err) {
          console.log('Logo non trovato su Storage o giÃ  eliminato');
        }
      }
      
      setTeamLogo('');
      // setTeamLogoStorageUrl(''); // âš ï¸ RIMOSSO - Non piÃ¹ necessario
      showToast('âœ… Logo rimosso!', 'success');
      
    } catch (error) {
      console.error('Errore rimozione logo:', error);
      showToast('âŒ Errore rimozione logo', 'error');
    }
  };

  const calculateAge = (dataNascita) => {
    if (!dataNascita) return '';
    const today = new Date();
    const birthDate = new Date(dataNascita);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    return age;
  };

  const addTraining = () => {
    // Pre-compila infortuni dai giocatori con injury attivo
    const infortuniPrecompilati = {};
    injuries.forEach(injury => {
      if (injury.status === 'active') {
        infortuniPrecompilati[injury.playerNum] = true;
      }
    });
    
    // Pre-compila presenze: tutti true TRANNE gli infortunati
    const presenzePrecompilate = {};
    players.forEach(p => {
      presenzePrecompilate[p.numero] = !infortuniPrecompilati[p.numero]; // false se infortunato, true altrimenti
    });
    
    const newTraining = {
      id: Date.now(),
      data: new Date().toISOString().split('T')[0],
      presenze: presenzePrecompilate,
      infortuni: infortuniPrecompilati,
      esercizi: [],  // CAMPO per esercizi
      foto: []  // âœ… NUOVO: Array per massimo 3 foto
    };
    setTrainings([...trainings, newTraining]);
  };

  const addMatch = () => {
    const newMatch = {
      id: Date.now(),
      data: new Date().toISOString().split('T')[0],
      squadraCasa: '',
      squadraTrasferta: '',
      risultato: '',
      convocati: {},
      titolari: {},
      entrati: {},
      sostituzioni: {},
      minutiGiocati: {},
      golFatti: {},
      assist: {},
      golSubiti: {},
      gialli_gioco: {},
      gialli_protesta: {},
      rossi_gioco: {},
      rossi_protesta: {},
      ordineDistinta: {},
      mvp: null, // Numero del giocatore MVP
      foto: []  // âœ… NUOVO: Array per massimo 3 foto
    };
    setMatches([...matches, newMatch]);
  };

  const updateTraining = (trainingId, field, value) => {
    setTrainings(trainings.map(t => 
      t.id === trainingId ? { ...t, [field]: value } : t
    ));
  };

  const updateMatch = (matchId, field, value) => {
    setMatches(matches.map(m => 
      m.id === matchId ? { ...m, [field]: value } : m
    ));
  };

  const deleteTraining = (id) => {
    setTrainings(trainings.filter(t => t.id !== id));
  };

  // ========== TEMPLATE ESERCIZI PREDEFINITI ==========
  
  const templateEsercizi = [
    { nome: "Riscaldamento", durata: 15, descrizione: "Corsa leggera e stretching dinamico" },
    { nome: "Possesso palla 4v4", durata: 20, descrizione: "Mantenimento palla in quadrato 20x20m" },
    { nome: "Possesso palla 6v6", durata: 25, descrizione: "Mantenimento palla campo ridotto" },
    { nome: "Esercitazione passaggi", durata: 20, descrizione: "Triangolazioni e movimenti senza palla" },
    { nome: "Tiri in porta", durata: 15, descrizione: "Serie di tiri da diverse posizioni" },
    { nome: "Partitella 7v7", durata: 30, descrizione: "Partita tattica su campo ridotto" },
    { nome: "Partitella 11v11", durata: 40, descrizione: "Partita tattica su campo intero" },
    { nome: "Lavoro atletico", durata: 20, descrizione: "Circuito forza e resistenza" },
    { nome: "Portieri specifico", durata: 20, descrizione: "Lavoro tecnico portieri" },
    { nome: "Defaticamento", durata: 10, descrizione: "Stretching statico e recupero" },
    { nome: "Personalizzato", durata: 0, descrizione: "" }
  ];

  // ========== FUNZIONI GESTIONE ESERCIZI ==========
  
  const addEsercizio = (trainingId) => {
    const esercizio = newEsercizio[trainingId] || {};
    
    if (!esercizio.nome || !esercizio.durata) {
      alert('âŒ Inserisci nome e durata dell\'esercizio');
      return;
    }
    
    const nuovoEsercizio = {
      id: Date.now(),
      nome: esercizio.nome,
      durata: parseInt(esercizio.durata) || 0,
      descrizione: esercizio.descrizione || '',
      valutazione: esercizio.valutazione || ''
    };
    
    setTrainings(trainings.map(t => {
      if (t.id === trainingId) {
        return {
          ...t,
          esercizi: [...(t.esercizi || []), nuovoEsercizio]
        };
      }
      return t;
    }));
    
    // Reset form
    setNewEsercizio({ ...newEsercizio, [trainingId]: {} });
    showToast('âœ… Esercizio aggiunto!', 'success');
  };
  
  const updateEsercizio = (trainingId, esercizioId, field, value) => {
    setTrainings(trainings.map(t => {
      if (t.id === trainingId) {
        return {
          ...t,
          esercizi: (t.esercizi || []).map(e => 
            e.id === esercizioId ? { ...e, [field]: value } : e
          )
        };
      }
      return t;
    }));
  };
  
  const deleteEsercizio = (trainingId, esercizioId) => {
    if (!window.confirm('ðŸ—‘ï¸ Vuoi eliminare questo esercizio?')) return;
    
    setTrainings(trainings.map(t => {
      if (t.id === trainingId) {
        return {
          ...t,
          esercizi: (t.esercizi || []).filter(e => e.id !== esercizioId)
        };
      }
      return t;
    }));
    
    showToast('âœ… Esercizio eliminato', 'success');
  };
  
  const caricaTemplateEsercizio = (trainingId, template) => {
    setNewEsercizio({
      ...newEsercizio,
      [trainingId]: {
        nome: template.nome,
        durata: template.durata,
        descrizione: template.descrizione,
        valutazione: ''
      }
    });
  };
  
  const duplicaEserciziDaAllenamento = (targetTrainingId, sourceTrainingId) => {
    const sourceTraining = trainings.find(t => t.id === parseInt(sourceTrainingId));
    if (!sourceTraining || !sourceTraining.esercizi || sourceTraining.esercizi.length === 0) {
      alert('âŒ L\'allenamento selezionato non ha esercizi');
      return;
    }
    
    if (!window.confirm(`ðŸ“‹ Vuoi copiare ${sourceTraining.esercizi.length} esercizi dall'allenamento del ${sourceTraining.data}?`)) {
      return;
    }
    
    const eserciziCopiati = sourceTraining.esercizi.map(e => ({
      ...e,
      id: Date.now() + Math.random(), // Nuovo ID
      valutazione: '' // Reset valutazione
    }));
    
    setTrainings(trainings.map(t => {
      if (t.id === targetTrainingId) {
        return {
          ...t,
          esercizi: [...(t.esercizi || []), ...eserciziCopiati]
        };
      }
      return t;
    }));
    
    showToast(`âœ… ${eserciziCopiati.length} esercizi copiati!`, 'success');
  };
  
  const calcolaTotaleMinuti = (esercizi) => {
    if (!esercizi || esercizi.length === 0) return 0;
    return esercizi.reduce((tot, e) => tot + (parseInt(e.durata) || 0), 0);
  };

  // ========== FUNZIONI GESTIONE FOTO ALLENAMENTI/PARTITE ==========
  
  const handleAddTrainingPhoto = async (e, trainingId) => {
    const file = e.target.files[0];
    if (!file) return;

    // Validazione tipo file
    if (!file.type.startsWith('image/')) {
      showToast('âŒ Seleziona un file immagine valido (JPG, PNG, ecc.)', 'error');
      e.target.value = '';
      return;
    }

    // Validazione dimensione (max 5MB prima compressione)
    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      showToast(`âŒ File troppo grande (${(file.size / 1024 / 1024).toFixed(1)}MB). Max: 5MB`, 'error');
      e.target.value = '';
      return;
    }

    // Verifica autenticazione
    if (!user) {
      showToast('âŒ Devi essere autenticato per caricare foto su cloud', 'error');
      e.target.value = '';
      return;
    }

    // Verifica limite 3 foto
    const training = trainings.find(t => t.id === trainingId);
    if (training && training.foto && training.foto.length >= 3) {
      showToast('âŒ Massimo 3 foto per allenamento', 'warning');
      e.target.value = '';
      return;
    }

    try {
      showLoadingWithProgress('Caricamento foto in corso...', 2000);

      // Comprimi immagine
      const compressedBlob = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const maxWidth = 800;
            const maxHeight = 600;
            let width = img.width;
            let height = img.height;

            if (width > maxWidth || height > maxHeight) {
              if (width / maxWidth > height / maxHeight) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              } else {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
              if (blob) resolve(blob);
              else reject(new Error('Errore compressione'));
            }, 'image/jpeg', 0.8);
          };
          img.onerror = () => reject(new Error('Errore caricamento immagine'));
          img.src = event.target.result;
        };
        reader.onerror = () => reject(new Error('Errore lettura file'));
        reader.readAsDataURL(file);
      });

      // Upload su cloud
      const storageRef = storage.ref();
      const fileName = `training-photos/${user.uid}/${trainingId}_${Date.now()}.jpg`;
      const fileRef = storageRef.child(fileName);
      
      const uploadTask = await fileRef.put(compressedBlob);
      const downloadURL = await fileRef.getDownloadURL();
      
      // Aggiungi foto all'allenamento
      setTrainings(trainings.map(t => {
        if (t.id === trainingId) {
          const currentFoto = t.foto || [];
          return {
            ...t,
            foto: [...currentFoto, {
              id: Date.now(),
              url: downloadURL,  // â† URL Storage invece di base64
              storageRef: fileName,  // â† Path per eliminazione
              timestamp: new Date().toISOString()
            }]
          };
        }
        return t;
      }));
      
      hideLoading();
      const sizeKB = Math.round((uploadTask.bytesTransferred || 0) / 1024);
      showToast(`âœ… Foto caricata su cloud! (${sizeKB}KB)`, 'success');
      e.target.value = '';
      
    } catch (error) {
      hideLoading();
      console.error('Errore upload foto allenamento:', error);
      showToast('âŒ Errore caricamento foto: ' + error.message, 'error', 5000);
      e.target.value = '';
    }
  };

  const handleRemoveTrainingPhoto = async (trainingId, photoId) => {
    if (!window.confirm('ðŸ—‘ï¸ Vuoi eliminare questa foto?')) return;
    
    try {
      const training = trainings.find(t => t.id === trainingId);
      const foto = training?.foto?.find(f => f.id === photoId);
      
      // Elimina da Storage se presente
      if (foto?.storageRef) {
        try {
          const storageRef = storage.ref();
          const fileRef = storageRef.child(foto.storageRef);
          await fileRef.delete();
          console.log('âœ… Foto eliminata da Storage');
        } catch (err) {
          console.log('âš ï¸ Foto non trovata su Storage (giÃ  eliminata?)');
        }
      }
      
      // Rimuovi da state
      setTrainings(trainings.map(t => {
        if (t.id === trainingId) {
          return {
            ...t,
            foto: (t.foto || []).filter(f => f.id !== photoId)
          };
        }
        return t;
      }));
      
      showToast('âœ… Foto eliminata', 'success');
      
    } catch (error) {
      console.error('Errore eliminazione foto:', error);
      showToast('âŒ Errore eliminazione foto', 'error');
    }
  };

  const handleAddMatchPhoto = async (e, matchId) => {
    const file = e.target.files[0];
    if (!file) return;

    // Validazione tipo file
    if (!file.type.startsWith('image/')) {
      showToast('âŒ Seleziona un file immagine valido (JPG, PNG, ecc.)', 'error');
      e.target.value = '';
      return;
    }

    // Validazione dimensione (max 5MB per upload)
    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      showToast(`âŒ File troppo grande (${(file.size / 1024 / 1024).toFixed(1)}MB). Max: 5MB`, 'error');
      e.target.value = '';
      return;
    }

    // Verifica autenticazione
    if (!user) {
      showToast('âŒ Devi essere autenticato per caricare foto', 'error');
      e.target.value = '';
      return;
    }

    try {
      showLoadingWithProgress('ðŸ“¤ Caricamento foto partita...', 0);
      
      // Comprimi immagine
      const compressedBlob = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            // Ridimensiona mantenendo aspect ratio (max 1200x900)
            const maxWidth = 1200;
            const maxHeight = 900;
            let width = img.width;
            let height = img.height;

            if (width > maxWidth || height > maxHeight) {
              if (width / maxWidth > height / maxHeight) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              } else {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
              if (blob) {
                resolve(blob);
              } else {
                reject(new Error('Errore compressione'));
              }
            }, 'image/jpeg', 0.85);
          };
          img.onerror = () => reject(new Error('Errore caricamento immagine'));
          img.src = event.target.result;
        };
        reader.onerror = () => reject(new Error('Errore lettura file'));
        reader.readAsDataURL(file);
      });

      setLoadingProgress(30);

      // Upload su cloud
      const storageRef = storage.ref();
      const photoId = Date.now();
      const fileName = `match-photos/${user.uid}/${matchId}_${photoId}.jpg`;
      const fileRef = storageRef.child(fileName);
      
      const uploadTask = await fileRef.put(compressedBlob);
      const downloadURL = await fileRef.getDownloadURL();
      
      setLoadingProgress(70);

      // Aggiungi URL alla partita
      setMatches(matches.map(m => {
        if (m.id === matchId) {
          const currentFoto = m.foto || [];
          if (currentFoto.length >= 3) {
            showToast('âŒ Massimo 3 foto per partita', 'warning');
            return m;
          }
          return {
            ...m,
            foto: [...currentFoto, {
              id: photoId,
              url: downloadURL,
              storageUrl: fileName,
              timestamp: new Date().toISOString()
            }]
          };
        }
        return m;
      }));
      
      setLoadingProgress(100);
      setTimeout(() => hideLoading(), 500);
      
      const sizeKB = Math.round((uploadTask.bytesTransferred || 0) / 1024);
      showToast(`âœ… Foto caricata su cloud! (${sizeKB}KB)`, 'success');
      e.target.value = '';
      
    } catch (error) {
      hideLoading();
      console.error('Errore upload foto partita:', error);
      showToast('âŒ Errore caricamento: ' + error.message, 'error', 5000);
      e.target.value = '';
    }
  };

  const handleRemoveMatchPhoto = async (matchId, photoId) => {
    if (!window.confirm('ðŸ—‘ï¸ Vuoi eliminare questa foto?')) return;
    
    try {
      const match = matches.find(m => m.id === matchId);
      const foto = match?.foto?.find(f => f.id === photoId);
      
      // Elimina da Storage se ha storageUrl
      if (foto?.storageUrl) {
        try {
          const storageRef = storage.ref();
          const fileRef = storageRef.child(foto.storageUrl);
          await fileRef.delete();
        } catch (err) {
          console.log('Foto non trovata su Storage o giÃ  eliminata:', err);
        }
      }
      
      // Rimuovi da match
      setMatches(matches.map(m => {
        if (m.id === matchId) {
          return {
            ...m,
            foto: (m.foto || []).filter(f => f.id !== photoId)
          };
        }
        return m;
      }));
      
      showToast('âœ… Foto eliminata', 'success');
      
    } catch (error) {
      console.error('Errore eliminazione foto:', error);
      showToast('âŒ Errore eliminazione foto', 'error');
    }
  };

  // Esporta esercizi allenamento in PDF
  const exportEserciziPDF = (training) => {
    if (!training || !training.esercizi || training.esercizi.length === 0) {
      alert('Nessun esercizio da esportare!');
      return;
    }
    
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      let yPos = 15;
      
      // Logo se presente
      if (teamLogo) {
        try {
          doc.addImage(teamLogo, 'PNG', 15, 10, 15, 15);
        } catch (e) {
          console.log('Errore caricamento logo:', e);
        }
      }
      
      // Titolo
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text('ESERCIZI ALLENAMENTO', teamLogo ? 35 : 15, 20);
      yPos = 30;
      
      // Data allenamento
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      const dataFormatted = new Date(training.data).toLocaleDateString('it-IT', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      doc.text(dataFormatted, 15, yPos);
      yPos += 10;
      
      // Box riepilogo
      doc.setFillColor(240, 248, 255);
      doc.rect(15, yPos, 180, 20, 'F');
      doc.setDrawColor(59, 130, 246);
      doc.rect(15, yPos, 180, 20);
      
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text(`Totale: ${training.esercizi.length} esercizi`, 20, yPos + 7);
      doc.text(`Durata: ${calcolaTotaleMinuti(training.esercizi)} minuti`, 20, yPos + 14);
      yPos += 28;
      
      // Lista esercizi
      training.esercizi.forEach((esercizio, idx) => {
        // Check spazio pagina
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        
        // Numero esercizio
        doc.setFillColor(59, 130, 246);
        doc.circle(22, yPos + 3, 4, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`${idx + 1}`, 22, yPos + 4.5, { align: 'center' });
        
        // Nome esercizio
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(esercizio.nome, 30, yPos + 4);
        
        // Durata (senza icona)
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(59, 130, 246);
        const durataText = `${esercizio.durata} min`;
        const durataWidth = doc.getTextWidth(durataText);
        doc.text(durataText, 195 - durataWidth, yPos + 4);
        
        yPos += 8;
        
        // Descrizione
        if (esercizio.descrizione) {
          doc.setTextColor(80, 80, 80);
          doc.setFontSize(9);
          doc.setFont(undefined, 'normal');
          
          const lines = doc.splitTextToSize(esercizio.descrizione, 165);
          lines.forEach(line => {
            if (yPos > 280) {
              doc.addPage();
              yPos = 20;
            }
            doc.text(line, 30, yPos);
            yPos += 5;
          });
        }
        
        yPos += 5;
        
        // Linea separatore
        if (idx < training.esercizi.length - 1) {
          doc.setDrawColor(200, 200, 200);
          doc.line(15, yPos, 195, yPos);
          yPos += 8;
        }
      });
      
      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`${appTitle} - Pagina ${i} di ${pageCount}`, 105, 290, { align: 'center' });
      }
      
      // Salva PDF
      const fileName = `Esercizi_${training.data}.pdf`;
      doc.save(fileName);
      showToast('âœ… PDF esercizi esportato!', 'success');
      
    } catch (error) {
      console.error('Errore export PDF esercizi:', error);
      showToast('âŒ Errore export PDF: ' + error.message, 'error');
    }
  };

  // Esporta statistiche giocatori in PDF
  const exportStatsPDF = () => {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape'); // Landscape per tabella larga
      
      let yPos = 15;
      
      // Logo se presente
      if (teamLogo) {
        try {
          doc.addImage(teamLogo, 'PNG', 15, 10, 15, 15);
        } catch (e) {
          console.log('Errore caricamento logo:', e);
        }
      }
      
      // Titolo
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text('STATISTICHE GIOCATORI', teamLogo ? 35 : 15, 20);
      yPos = 30;
      
      // Data report
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      const dataOggi = new Date().toLocaleDateString('it-IT', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      doc.text(`Report generato il: ${dataOggi}`, 15, yPos);
      yPos += 10;
      
      // Riepilogo generale
      const allStats = calculateStats();
      const attivi = allStats.filter(s => {
        const player = players.find(p => p.nome === s.nome);
        return player && !player.fuoriRosa;
      }).length;
      const totGol = allStats.reduce((sum, s) => sum + s.gol, 0);
      const totAssist = allStats.reduce((sum, s) => sum + s.assist, 0);
      
      doc.setFillColor(240, 248, 255);
      doc.rect(15, yPos, 267, 20, 'F');
      doc.setDrawColor(59, 130, 246);
      doc.rect(15, yPos, 267, 20);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.text(`Giocatori Attivi: ${attivi}`, 20, yPos + 7);
      doc.text(`Giocatori Stagione: ${allStats.length}`, 20, yPos + 14);
      doc.text(`Gol Totali: ${totGol}`, 100, yPos + 7);
      doc.text(`Assist Totali: ${totAssist}`, 100, yPos + 14);
      yPos += 28;
      
      // Tabella statistiche
      const tableData = allStats.map((stat, idx) => {
        const totAllenamenti = stat.allenamenti_presenze + stat.allenamenti_assenze;
        const percPresenze = totAllenamenti > 0 ? ((stat.allenamenti_presenze / totAllenamenti) * 100).toFixed(0) + '%' : '-';
        const totPartite = matches.length;
        const percConv = totPartite > 0 ? ((stat.partite_convocato / totPartite) * 100).toFixed(0) + '%' : '-';
        const totGialli = stat.gialli_gioco + stat.gialli_protesta;
        const totRossi = stat.rossi_gioco + stat.rossi_protesta;
        
        return [
          idx + 1,
          stat.nome,
          stat.ruolo,
          stat.allenamenti_presenze,
          percPresenze,
          stat.infortuni || 0,
          stat.partite_convocato,
          percConv,
          stat.partite_titolare,
          stat.minuti_totali,
          stat.gol,
          stat.assist,
          totGialli,
          totRossi
        ];
      });
      
      doc.autoTable({
        startY: yPos,
        head: [[
          'N.',
          'Nome',
          'Ruolo',
          'Presenze',
          '%',
          'Infortuni',
          'Conv.',
          '%',
          'Titolare',
          'Minuti',
          'Gol',
          'Assist',
          'Gialli',
          'Rossi'
        ]],
        body: tableData,
        theme: 'striped',
        headStyles: { 
          fillColor: [59, 130, 246],
          fontSize: 9,
          fontStyle: 'bold'
        },
        bodyStyles: {
          fontSize: 8
        },
        columnStyles: {
          0: { cellWidth: 10, halign: 'center' },
          1: { cellWidth: 40 },
          2: { cellWidth: 25 },
          3: { cellWidth: 18, halign: 'center' },
          4: { cellWidth: 15, halign: 'center' },
          5: { cellWidth: 18, halign: 'center' },
          6: { cellWidth: 15, halign: 'center' },
          7: { cellWidth: 15, halign: 'center' },
          8: { cellWidth: 18, halign: 'center' },
          9: { cellWidth: 18, halign: 'center' },
          10: { cellWidth: 15, halign: 'center', fontStyle: 'bold' },
          11: { cellWidth: 15, halign: 'center', fontStyle: 'bold' },
          12: { cellWidth: 15, halign: 'center' },
          13: { cellWidth: 15, halign: 'center' }
        },
        margin: { left: 15, right: 15 }
      });
      
      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`${appTitle} - Pagina ${i} di ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
      }
      
      // Salva PDF
      const fileName = `Statistiche_Giocatori_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
      showToast('PDF statistiche esportato!', 'success');
      
    } catch (error) {
      console.error('Errore export PDF statistiche:', error);
      showToast('Errore export PDF: ' + error.message, 'error');
    }
  };

  const deleteMatch = (id) => {
    setMatches(matches.filter(m => m.id !== id));
  };

  // ========== FUNZIONI SISTEMA MVP ==========
  
  /**
   * Apre il modal per votare l'MVP di una partita
   */
  const openMVPVoting = (matchId) => {
    const match = matches.find(m => m.id === matchId);
    if (!match) return;
    
    // Verifica che ci siano convocati
    const convocatiCount = Object.values(match.convocati || {}).filter(Boolean).length;
    if (convocatiCount === 0) {
      showToast('âš ï¸ Nessun giocatore convocato per questa partita', 'warning');
      return;
    }
    
    setSelectedMatchForMVP(matchId);
    setShowMVPModal(true);
  };
  
  /**
   * Assegna l'MVP a un giocatore per una partita
   */
  const assignMVP = (matchId, playerNum) => {
    const match = matches.find(m => m.id === matchId);
    if (!match) return;
    
    const player = players.find(p => p.numero === playerNum);
    if (!player || !player.nome) {
      showToast('âŒ Giocatore non valido', 'error');
      return;
    }
    
    // Verifica che il giocatore fosse convocato
    if (!match.convocati[playerNum]) {
      showToast('âš ï¸ Il giocatore non era convocato per questa partita', 'warning');
      return;
    }
    
    // Aggiorna il match con l'MVP
    setMatches(matches.map(m => 
      m.id === matchId ? { ...m, mvp: playerNum } : m
    ));
    
    showToast(`ðŸ† ${player.nome} nominato Man of the Match!`, 'success');
    setShowMVPModal(false);
    setSelectedMatchForMVP(null);
  };
  
  /**
   * Rimuove l'MVP da una partita
   */
  const removeMVP = (matchId) => {
    setMatches(matches.map(m => 
      m.id === matchId ? { ...m, mvp: null } : m
    ));
    showToast('ðŸ”„ MVP rimosso', 'info');
  };
  
  /**
   * Ottiene la classifica MVP della stagione
   */
  const getMVPLeaderboard = () => {
    const mvpCount = {};
    
    // Conta quante volte ogni giocatore Ã¨ stato MVP
    matches.forEach(match => {
      if (match.mvp && match.risultato) { // Solo partite con risultato
        mvpCount[match.mvp] = (mvpCount[match.mvp] || 0) + 1;
      }
    });
    
    // Converti in array e ordina
    return Object.entries(mvpCount)
      .map(([playerNum, count]) => {
        const player = players.find(p => p.numero === parseInt(playerNum));
        return {
          playerNum: parseInt(playerNum),
          playerName: player?.nome || 'Sconosciuto',
          playerPhoto: player?.foto || '',
          mvpCount: count
        };
      })
      .sort((a, b) => b.mvpCount - a.mvpCount);
  };
  
  /**
   * Ottiene il numero di MVP per un giocatore specifico
   */
  const getPlayerMVPCount = (playerNum) => {
    return matches.filter(m => m.mvp === playerNum && m.risultato).length;
  };

  /**
   * Esporta la classifica campionato in PDF
   */
  const exportClassificaPDF = () => {
    if (squadreGirone.length === 0) {
      alert('Nessuna squadra presente nella classifica');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Titolo
    doc.setFontSize(20);
    doc.text('CLASSIFICA CAMPIONATO', 105, 20, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Stagione 2024/2025', 105, 28, { align: 'center' });
    
    // Data generazione
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}`, 105, 34, { align: 'center' });
    doc.setTextColor(0, 0, 0);
    
    let yPosition = 42;
    
    // Calcola classifica
    const classifica = squadreGirone.map(sq => {
      let punti = 0, giocate = 0, vinte = 0, pareggiate = 0, perse = 0, golFatti = 0, golSubiti = 0;
      
      risultatiCampionato.forEach(giornata => {
        giornata.partite.forEach(partita => {
          if (!partita.giocata) return;  // Solo partite giocate
          
          if (partita.squadraCasa === sq.nome) {
            giocate++;
            golFatti += partita.golCasa;
            golSubiti += partita.golTrasferta;
            if (partita.golCasa > partita.golTrasferta) {
              punti += 3;
              vinte++;
            } else if (partita.golCasa === partita.golTrasferta) {
              punti += 1;
              pareggiate++;
            } else {
              perse++;
            }
          } else if (partita.squadraTrasferta === sq.nome) {
            giocate++;
            golFatti += partita.golTrasferta;
            golSubiti += partita.golCasa;
            if (partita.golTrasferta > partita.golCasa) {
              punti += 3;
              vinte++;
            } else if (partita.golTrasferta === partita.golCasa) {
              punti += 1;
              pareggiate++;
            } else {
              perse++;
            }
          }
        });
      });
      
      return { 
        nome: sq.nome, 
        punti, 
        giocate, 
        vinte, 
        pareggiate, 
        perse, 
        golFatti, 
        golSubiti, 
        diffReti: golFatti - golSubiti 
      };
    }).sort((a, b) => {
      if (b.punti !== a.punti) return b.punti - a.punti;
      if (b.diffReti !== a.diffReti) return b.diffReti - a.diffReti;
      return b.golFatti - a.golFatti;
    });
    
    // Tabella classifica
    const tableData = classifica.map((sq, idx) => {
      const pos = (idx + 1).toString();
      
      return [
        pos,
        sq.nome,
        sq.punti,
        sq.giocate,
        sq.vinte,
        sq.pareggiate,
        sq.perse,
        sq.golFatti,
        sq.golSubiti,
        (sq.diffReti > 0 ? '+' : '') + sq.diffReti
      ];
    });
    
    doc.autoTable({
      startY: yPosition,
      head: [['Pos', 'Squadra', 'Pt', 'G', 'V', 'P', 'S', 'GF', 'GS', 'DR']],
      body: tableData,
      theme: 'grid',
      headStyles: { 
        fillColor: [59, 130, 246],
        fontSize: 10,
        fontStyle: 'bold',
        halign: 'center'
      },
      bodyStyles: { 
        fontSize: 9 
      },
      columnStyles: {
        0: { halign: 'center', cellWidth: 15 },
        1: { halign: 'left', cellWidth: 60 },
        2: { halign: 'center', fontStyle: 'bold', cellWidth: 12 },
        3: { halign: 'center', cellWidth: 10 },
        4: { halign: 'center', cellWidth: 10 },
        5: { halign: 'center', cellWidth: 10 },
        6: { halign: 'center', cellWidth: 10 },
        7: { halign: 'center', cellWidth: 12 },
        8: { halign: 'center', cellWidth: 12 },
        9: { halign: 'center', cellWidth: 15 }
      },
      didParseCell: function(data) {
        if (data.section === 'body') {
          // Evidenzia primo posto
          if (data.row.index === 0) {
            data.cell.styles.fillColor = [254, 243, 199]; // giallo chiaro
          }
          // Evidenzia podio
          else if (data.row.index <= 2) {
            data.cell.styles.fillColor = [219, 234, 254]; // azzurro chiaro
          }
          // Evidenzia zona retrocessione
          else if (data.row.index >= classifica.length - 2) {
            data.cell.styles.fillColor = [254, 226, 226]; // rosso chiaro
          }
        }
      }
    });
    
    yPosition = doc.lastAutoTable.finalY + 10;
    
    // Statistiche Aggregate
    if (risultatiCampionato.some(g => g.partite.some(p => p.giocata))) {
      doc.setFontSize(14);
      doc.text('STATISTICHE CAMPIONATO', 15, yPosition);
      yPosition += 8;
      
      // Capocannoniere
      const golPerSquadra = {};
      risultatiCampionato.forEach(giornata => {
        giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                        if (!golPerSquadra[partita.squadraCasa]) golPerSquadra[partita.squadraCasa] = 0;
          if (!golPerSquadra[partita.squadraTrasferta]) golPerSquadra[partita.squadraTrasferta] = 0;
          golPerSquadra[partita.squadraCasa] += partita.golCasa;
          golPerSquadra[partita.squadraTrasferta] += partita.golTrasferta;
        });
      });
      
      const topScorer = Object.entries(golPerSquadra)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
      
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text('MIGLIOR ATTACCO:', 15, yPosition);
      doc.setFont(undefined, 'normal');
      yPosition += 5;
      
      topScorer.forEach(([squadra, gol], idx) => {
        doc.setFontSize(9);
        const pos = `${idx + 1}Â°`;
        doc.text(`${pos} ${squadra}: ${gol} gol`, 20, yPosition);
        yPosition += 5;
      });
      
      yPosition += 3;
      
      // Miglior difesa
      const golSubitiPerSquadra = {};
      risultatiCampionato.forEach(giornata => {
        giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                        if (!golSubitiPerSquadra[partita.squadraCasa]) golSubitiPerSquadra[partita.squadraCasa] = 0;
          if (!golSubitiPerSquadra[partita.squadraTrasferta]) golSubitiPerSquadra[partita.squadraTrasferta] = 0;
          golSubitiPerSquadra[partita.squadraCasa] += partita.golTrasferta;
          golSubitiPerSquadra[partita.squadraTrasferta] += partita.golCasa;
        });
      });
      
      const bestDefense = Object.entries(golSubitiPerSquadra)
        .sort((a, b) => a[1] - b[1])
        .slice(0, 3);
      
      doc.setFont(undefined, 'bold');
      doc.text('MIGLIOR DIFESA:', 15, yPosition);
      doc.setFont(undefined, 'normal');
      yPosition += 5;
      
      bestDefense.forEach(([squadra, gol], idx) => {
        doc.setFontSize(9);
        const pos = `${idx + 1}Â°`;
        doc.text(`${pos} ${squadra}: ${gol} gol subiti`, 20, yPosition);
        yPosition += 5;
      });
      
      // Se c'Ã¨ spazio, aggiungi rendimento casa/trasferta
      if (yPosition < 240) {
        yPosition += 3;
        
        // Rendimento casa
        const puntiCasa = {};
        risultatiCampionato.forEach(giornata => {
          giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                          if (!puntiCasa[partita.squadraCasa]) puntiCasa[partita.squadraCasa] = 0;
            if (partita.golCasa > partita.golTrasferta) puntiCasa[partita.squadraCasa] += 3;
            else if (partita.golCasa === partita.golTrasferta) puntiCasa[partita.squadraCasa] += 1;
          });
        });
        
        const topCasa = Object.entries(puntiCasa)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3);
        
        doc.setFont(undefined, 'bold');
        doc.text('RENDIMENTO CASA:', 15, yPosition);
        doc.setFont(undefined, 'normal');
        yPosition += 5;
        
        topCasa.forEach(([squadra, punti], idx) => {
          doc.setFontSize(9);
          const pos = `${idx + 1}Â°`;
          doc.text(`${pos} ${squadra}: ${punti} punti`, 20, yPosition);
          yPosition += 5;
        });
        
        yPosition += 3;
        
        // Rendimento trasferta
        const puntiTrasferta = {};
        risultatiCampionato.forEach(giornata => {
          giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                          if (!puntiTrasferta[partita.squadraTrasferta]) puntiTrasferta[partita.squadraTrasferta] = 0;
            if (partita.golTrasferta > partita.golCasa) puntiTrasferta[partita.squadraTrasferta] += 3;
            else if (partita.golTrasferta === partita.golCasa) puntiTrasferta[partita.squadraTrasferta] += 1;
          });
        });
        
        const topTrasferta = Object.entries(puntiTrasferta)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3);
        
        doc.setFont(undefined, 'bold');
        doc.text('RENDIMENTO TRASFERTA:', 15, yPosition);
        doc.setFont(undefined, 'normal');
        yPosition += 5;
        
        topTrasferta.forEach(([squadra, punti], idx) => {
          doc.setFontSize(9);
          const pos = `${idx + 1}Â°`;
          doc.text(`${pos} ${squadra}: ${punti} punti`, 20, yPosition);
          yPosition += 5;
        });
      }
    }
    
    // Aggiungi footer
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.text(`Pagina ${i} di ${pageCount}`, 105, 290, { align: 'center' });
      doc.text(`Generato da ${appTitle}`, 105, 285, { align: 'center' });
    }
    
    // Salva PDF
    doc.save(`Classifica_Campionato_${new Date().toLocaleDateString('it-IT').replace(/\//g, '-')}.pdf`);
    showToast('PDF classifica generato!', 'success');
  };

  // ========== GESTIONE DISPOSITIVI E AUTO-SYNC ==========
  
  /**
   * Genera ID univoco dispositivo
   */
  const generateDeviceId = () => {
    let id = localStorage.getItem('uniqueDeviceId');
    if (!id) {
      id = 'device-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('uniqueDeviceId', id);
    }
    return id;
  };

  /**
   * Rileva nome dispositivo dal user agent
   */
  const getDeviceName = () => {
    const ua = navigator.userAgent;
    if (ua.match(/iPad/i) || ua.match(/Android.*Tablet/i)) return "Tablet";
    if (ua.match(/Mobile|iPhone|Android/i)) return "Mobile";
    return "PC";
  };

  /**
   * Salva configurazione dispositivo
   */
  /**
   * Pulisce ricorsivamente tutti i campi undefined da un oggetto
   * Firestore non accetta undefined, solo null o valori definiti
   */
  const cleanUndefinedFields = (obj) => {
    if (obj === null || obj === undefined) return null;
    
    if (Array.isArray(obj)) {
      return obj.map(item => cleanUndefinedFields(item));
    }
    
    if (typeof obj === 'object') {
      const cleaned = {};
      Object.keys(obj).forEach(key => {
        const value = obj[key];
        if (value !== undefined) {
          cleaned[key] = cleanUndefinedFields(value);
        }
      });
      return cleaned;
    }
    
    return obj;
  };

  /**
   * Salva dati su cloud Firebase
   */
  const saveDataToCloud = async (silent = false) => {
    // ðŸ” LOG DEBUG PRIMISSIMO - Verifica se funzione viene chiamata
    console.log('ðŸš€ saveDataToCloud CHIAMATA!', { 
      silent, 
      userPresente: !!user, 
      teamIdPresente: !!teamId,
      teamNameAttuale: teamName || '(vuoto)'
    });
    
    if (!user) {
      console.error('âŒ saveDataToCloud: user non presente');
      showToast('âŒ Devi essere autenticato per salvare su cloud', 'error');
      return;
    }
    
    if (!teamId) {
      console.error('âŒ saveDataToCloud: teamId non presente');
      showToast('âŒ Team ID non trovato', 'error');
      return;
    }
    
    try {
      console.log('ðŸ“¤ Inizio preparazione dati per cloud...', {
        userId: user.uid,
        teamId: teamId,
        saveLocation: `teamData/${teamId}`
      });
      
      // âœ… Assicura che tutti i giocatori abbiano il campo fuoriRosa
      const playersWithFuoriRosa = players.map(p => ({
        ...p,
        fuoriRosa: p.fuoriRosa || false // Default false se undefined
      }));
      
      const data = {
        players: playersWithFuoriRosa,
        trainings,
        matches,
        injuries,
        squadreGirone,        // âœ… AGGIUNTO: Squadre del girone
        risultatiCampionato,  // âœ… AGGIUNTO: Risultati campionato
        appTitle,             // âœ… AGGIUNTO: Titolo app
        teamName,             // âœ… AGGIUNTO: Nome squadra
        teamLogo,             // âœ… AGGIUNTO: Logo squadra (URL Storage o base64)
        // teamLogoStorageUrl, // âš ï¸ RIMOSSO - Campo ridondante
        timestamp: new Date().toISOString(),
        deviceId: generateDeviceId(),
        deviceName: getDeviceName()
      };
      
      // Log dettagliato per debug
      console.log('ðŸ’¾ Salvataggio su cloud:', {
        players: playersWithFuoriRosa.length,
        trainings: trainings.length,
        matches: matches.length,
        injuries: injuries.length,
        squadreGirone: squadreGirone.length,
        risultatiCampionato: risultatiCampionato.length,
        fuoriRosa: playersWithFuoriRosa.filter(p => p.fuoriRosa).length,
        appTitle: appTitle,
        teamName: teamName || '(vuoto)',  // âœ… Log per debug
        hasTeamLogo: !!teamLogo,
        timestamp: data.timestamp
      });
      
      // CRITICAL: Pulisci tutti gli undefined prima di salvare su cloud
      const cleanedData = cleanUndefinedFields(data);
      
      console.log('ðŸ§¹ Dati puliti, invio a cloud...');
      // âš ï¸ USA TEAMID invece di user.uid
      await db.collection('teamData').doc(teamId).set(cleanedData);
      console.log('âœ… Salvataggio cloud completato con successo!');
      
      // Aggiorna timestamp ultima sincronizzazione
      setLastSynced(new Date());
      
      if (!silent) {
        showToast('âœ… Dati salvati su cloud!', 'success');
      }
      
    } catch (error) {
      console.error('âŒ ERRORE SALVATAGGIO CLOUD:', error);
      console.error('Dettagli errore:', {
        message: error.message,
        code: error.code,
        stack: error.stack
      });
      if (!silent) {
        showToast('âŒ Errore salvataggio: ' + error.message, 'error');
      }
      throw error; // Rilancia per gestione in handleExitWithSave
    }
  };

  /**
   * Carica dati da cloud Firebase
   */
  const loadDataFromCloud = async (skipConfirm = false, explicitUser = null, explicitTeamId = null, silent = false) => {
    const userToUse = explicitUser || user;
    const teamIdToUse = explicitTeamId || teamId;
    
    if (!userToUse) {
      console.error('âŒ loadDataFromCloud: user non presente');
      return;
    }
    
    if (!teamIdToUse) {
      console.error('âŒ loadDataFromCloud: teamId non presente');
      return;
    }
    
    try {
      console.log('ðŸ“¡ Inizio caricamento da cloud...', {
        userId: userToUse.uid,
        teamId: teamIdToUse,
        loadLocation: `teamData/${teamIdToUse}`,
        skipConfirm: skipConfirm,
        userSource: explicitUser ? 'explicit' : 'state'
      });
      
      // âš ï¸ USA TEAMID invece di user.uid
      const doc = await db.collection('teamData').doc(teamIdToUse).get();
      
      console.log('ðŸ“„ Documento cloud ricevuto:', {
        exists: doc.exists,
        id: doc.id
      });
      
      if (!doc.exists) {
        console.warn('âš ï¸ NESSUN DOCUMENTO SU FIREBASE!');
        // Mostra toast anche se silent - Ã¨ un errore importante!
        showToast('â„¹ï¸ Nessun dato nel cloud', 'info');
        return;
      }
      
      const data = doc.data();
      
      // Log dettagliato per debug
      console.log('ðŸ“¥ Caricamento da cloud:', {
        players: (data.players || []).length,
        trainings: (data.trainings || []).length,
        matches: (data.matches || []).length,
        injuries: (data.injuries || []).length,
        squadreGirone: (data.squadreGirone || []).length,
        risultatiCampionato: (data.risultatiCampionato || []).length,
        fuoriRosa: (data.players || []).filter(p => p.fuoriRosa).length,
        appTitle: data.appTitle,
        hasTeamLogo: !!data.teamLogo,
        timestamp: data.timestamp,
        deviceId: data.deviceId,
        deviceName: data.deviceName
      });
      
      // Warning se sync da altro dispositivo recente (SOLO se non skipConfirm)
      if (!skipConfirm && data.deviceId && data.deviceId !== generateDeviceId()) {
        const timeDiff = Math.abs(new Date() - new Date(data.timestamp));
        const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
        
        const confirm = window.confirm(
          `âš ï¸ ATTENZIONE\n\n` +
          `Ultimo sync da: ${data.deviceName || 'Altro dispositivo'}\n` +
          `Quando: ${new Date(data.timestamp).toLocaleString('it-IT')} (${hoursDiff}h fa)\n\n` +
          `Scaricare questi dati?\n` +
          `(SovrascriverÃ  eventuali modifiche locali non salvate)`
        );
        
        if (!confirm) return;
      }
      
      // Backup prima di sovrascrivere
      await createLocalBackup();
      
      // âœ… Normalizza giocatori con campo fuoriRosa
      const normalizedPlayers = (data.players || []).map(p => ({
        ...p,
        fuoriRosa: p.fuoriRosa || false
      }));
      
      // Carica dati
      if (data.players) setPlayers(normalizedPlayers);
      if (data.trainings) setTrainings(data.trainings);
      if (data.matches) setMatches(data.matches);
      if (data.injuries) setInjuries(data.injuries);
      if (data.squadreGirone) setSquadreGirone(data.squadreGirone);              // âœ… AGGIUNTO
      if (data.risultatiCampionato) setRisultatiCampionato(data.risultatiCampionato);  // âœ… AGGIUNTO
      if (data.appTitle) setAppTitle(data.appTitle);                             // âœ… AGGIUNTO: Titolo app
      // Carica teamName anche se vuoto (usa hasOwnProperty per verificare esistenza)
      if (data.hasOwnProperty('teamName')) setTeamName(data.teamName || '');     // âœ… AGGIUNTO: Nome squadra
      if (data.teamLogo) setTeamLogo(data.teamLogo);                             // âœ… AGGIUNTO: Logo squadra
      // if (data.teamLogoStorageUrl) setTeamLogoStorageUrl(data.teamLogoStorageUrl); // âš ï¸ RIMOSSO - Campo ridondante
      
      // Log DOPO aver settato gli state
      console.log('âœ… State AGGIORNATI dopo caricamento cloud:', {
        players: normalizedPlayers.length,
        injuries: (data.injuries || []).length,
        injuriesData: data.injuries || [],
        playersWithFuoriRosa: normalizedPlayers.filter(p => p.fuoriRosa).length,
        fuoriRosaData: normalizedPlayers.filter(p => p.fuoriRosa).map(p => ({ numero: p.numero, nome: p.nome, fuoriRosa: p.fuoriRosa })),
        teamName: data.teamName || '(vuoto)',  // âœ… Log per debug
        teamNameCaricato: data.hasOwnProperty('teamName')
      });
      
      // Salva anche in IndexedDB
      await saveToIndexedDB('teamData', {
        players: normalizedPlayers,
        trainings: data.trainings || [],
        matches: data.matches || [],
        injuries: data.injuries || [],
        squadreGirone: data.squadreGirone || [],              // âœ… AGGIUNTO
        risultatiCampionato: data.risultatiCampionato || [],  // âœ… AGGIUNTO
        appTitle: data.appTitle || appTitle,                  // âœ… AGGIUNTO: Titolo app
        teamName: data.teamName || '',                        // âœ… AGGIUNTO: Nome squadra
        teamLogo: data.teamLogo || teamLogo                   // âœ… AGGIUNTO: Logo squadra (URL o base64)
        // teamLogoStorageUrl: data.teamLogoStorageUrl || ''  // âš ï¸ RIMOSSO - Campo ridondante
      });
      
      // Aggiorna timestamp ultima sincronizzazione
      setLastSynced(new Date());
      
      if (!silent) {
        showToast('âœ… Dati caricati da cloud!', 'success');
      }
      
    } catch (error) {
      console.error('Errore caricamento cloud:', error);
      // Mostra SEMPRE toast di errore, anche se silent=true
      showToast('âŒ Errore caricamento: ' + error.message, 'error');
    }
  };

  // ========== SISTEMA ADMIN LOCK ==========

  /**
   * Controlla se c'Ã¨ un admin attivo per questo team
   */
  const checkActiveAdmin = async () => {
    if (!teamId) {
      console.log('âš ï¸ checkActiveAdmin: teamId non presente');
      return null;
    }
    
    try {
      console.log('ðŸ“¡ checkActiveAdmin: Inizio controllo lock per teamId:', teamId);
      
      // âš ï¸ IMPORTANTE: Forza lettura dal SERVER, non dalla cache locale!
      // Altrimenti il secondo dispositivo non vede il lock del primo
      console.log('ðŸ“¡ checkActiveAdmin: Chiamo Firestore con { source: server }...');
      const lockDoc = await db.collection('adminLock').doc(teamId).get({ source: 'server' });
      
      console.log('ðŸ“¡ checkActiveAdmin: Risposta ricevuta. lockDoc.exists:', lockDoc.exists);
      
      if (!lockDoc.exists) {
        console.log('âœ… checkActiveAdmin: Nessun documento trovato, nessun admin attivo');
        return null; // Nessun admin attivo
      }
      
      const lockData = lockDoc.data();
      console.log('ðŸ“¡ checkActiveAdmin: Documento trovato:', lockData);
      
      const lastSeen = new Date(lockData.lastSeen);
      const now = new Date();
      const minutesSinceLastSeen = (now - lastSeen) / (1000 * 60);
      
      console.log('â±ï¸ checkActiveAdmin: Minuti dall\'ultimo ping:', minutesSinceLastSeen.toFixed(2));
      
      // Se l'ultimo ping Ã¨ piÃ¹ vecchio di 90 secondi, consideriamo il lock scaduto
      if (minutesSinceLastSeen > 1.5) {
        console.log('â° Lock scaduto (timeout 90 sec), rimuovo lock vecchio');
        await releaseAdminLock(); // Pulisci lock vecchio
        return null;
      }
      
      // Admin attivo e valido
      console.log('âš ï¸ checkActiveAdmin: Admin ATTIVO trovato:', lockData.email);
      return lockData;
      
    } catch (error) {
      console.error('âŒ checkActiveAdmin: ERRORE CATTURATO:', error);
      console.error('âŒ checkActiveAdmin: Tipo errore:', error.name);
      console.error('âŒ checkActiveAdmin: Messaggio:', error.message);
      console.error('âŒ checkActiveAdmin: Stack:', error.stack);
      return null;
    }
  };

  /**
   * Acquisisce il lock admin per questo team
   */
  const acquireAdminLock = async () => {
    if (!user || !teamId) return false;
    
    try {
      const lockData = {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName || user.email,
        lastSeen: new Date().toISOString(),
        deviceName: getDeviceName(),
        acquiredAt: new Date().toISOString()
      };
      
      await db.collection('adminLock').doc(teamId).set(lockData);
      setAdminLockActive(true);
      console.log('âœ… Lock admin acquisito:', lockData);
      
      // Avvia heartbeat
      startAdminHeartbeat();
      
      return true;
    } catch (error) {
      console.error('âŒ Errore acquisizione lock:', error);
      return false;
    }
  };

  /**
   * Rilascia il lock admin
   */
  const releaseAdminLock = async () => {
    if (!teamId) return;
    
    try {
      await db.collection('adminLock').doc(teamId).delete();
      setAdminLockActive(false);
      stopAdminHeartbeat();
      console.log('âœ… Lock admin rilasciato');
    } catch (error) {
      console.error('âŒ Errore rilascio lock:', error);
    }
  };

  /**
   * Avvia heartbeat per mantenere il lock attivo
   */
  const startAdminHeartbeat = () => {
    // Pulisci eventuale heartbeat esistente
    if (heartbeatInterval) {
      clearInterval(heartbeatInterval);
    }
    
    // Heartbeat ogni 30 secondi
    const interval = setInterval(async () => {
      if (!user || !teamId || !adminLockActive) return;
      
      try {
        await db.collection('adminLock').doc(teamId).update({
          lastSeen: new Date().toISOString()
        });
        console.log('ðŸ’“ Heartbeat inviato');
      } catch (error) {
        console.error('âŒ Errore heartbeat:', error);
        // Se fallisce, potrebbe essere che il lock Ã¨ stato rimosso
        setAdminLockActive(false);
        stopAdminHeartbeat();
      }
    }, 30000); // 30 secondi
    
    setHeartbeatInterval(interval);
  };

  /**
   * Ferma heartbeat
   */
  const stopAdminHeartbeat = () => {
    if (heartbeatInterval) {
      clearInterval(heartbeatInterval);
      setHeartbeatInterval(null);
    }
  };

  /**
   * Forza disconnessione admin precedente (solo in emergenza)
   */
  const forceDisconnectPreviousAdmin = async () => {
    if (!window.confirm(
      'âš ï¸ ATTENZIONE!\n\n' +
      'Stai per disconnettere forzatamente l\'altro admin.\n' +
      'Potrebbe perdere dati non salvati!\n\n' +
      'Procedi solo se sei CERTO che l\'altro admin non sta piÃ¹ lavorando.\n\n' +
      'Confermi la disconnessione forzata?'
    )) {
      return false;
    }
    
    try {
      await releaseAdminLock();
      showToast('âœ… Admin precedente disconnesso. Puoi accedere ora.', 'success');
      setShowAdminBlockModal(false);
      
      // Riacquisici il lock
      const acquired = await acquireAdminLock();
      if (acquired) {
        showToast('âœ… Accesso consentito, puoi lavorare!', 'success');
      }
      
      return true;
    } catch (error) {
      console.error('âŒ Errore disconnessione forzata:', error);
      showToast('âŒ Errore nella disconnessione forzata', 'error');
      return false;
    }
  };

  /**
   * Gestisce l'uscita del secondo admin che Ã¨ stato bloccato
   * Fa logout SENZA rilasciare il lock (perchÃ© non ce l'ha!)
   */
  const handleBlockedAdminExit = async () => {
    try {
      setShowAdminBlockModal(false);
      showToast('ðŸ‘‹ Logout in corso...', 'info');
      
      // NON rilasciare il lock - non ce l'abbiamo!
      // Semplicemente fare logout da Firebase
      await auth.signOut();
      
      // Il logout resetterÃ  tutto automaticamente
      console.log('âœ… Admin bloccato disconnesso correttamente');
      
    } catch (error) {
      console.error('âŒ Errore logout admin bloccato:', error);
      showToast('âŒ Errore durante il logout', 'error');
      
      // In caso di errore, forza comunque il logout
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    }
  };

  /**
   * Crea backup locale
   */
  const createLocalBackup = async () => {
    const backup = {
      players,
      trainings,
      matches,
      injuries,
      timestamp: new Date().toISOString()
    };
    
    // Salva in localStorage (max 5 backup)
    let backups = JSON.parse(localStorage.getItem('localBackups') || '[]');
    backups.unshift(backup);
    backups = backups.slice(0, 5); // Keep only last 5
    
    localStorage.setItem('localBackups', JSON.stringify(backups));
  };

  const exportToJSON = () => {
    const now = new Date().toISOString();
    
    // âœ… BACKUP COMPLETO anche per vecchia funzione
    const data = {
      version: '3.0',
      players,
      trainings,
      matches,
      injuries, // âœ… AGGIUNTO
      appTitle,
      teamName,
      teamLogo,
      exportDate: now,
      stats: {
        totalPlayers: players.filter(p => p.nome).length,
        totalTrainings: trainings.length,
        totalMatches: matches.length,
        totalInjuries: injuries.length
      }
    };
    const jsonString = JSON.stringify(data, null, 2);
    
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `real-dor-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    // âœ… Salva data ultimo backup
    setLastBackupDate(now);
    localStorage.setItem('lastBackupDate', now);
    
    showToast(`âœ… File JSON scaricato! Include ${data.stats.totalPlayers} giocatori, ${data.stats.totalTrainings} allenamenti, ${data.stats.totalMatches} partite`, 'success');
  };

  const handleFileImport = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        
        // Validazione base
        if (!data.players || !data.trainings || !data.matches) {
          showToast('âŒ File JSON non valido! Assicurati di aver selezionato il file corretto.', 'error');
          return;
        }
        
        // âœ… RIPRISTINO COMPLETO - Include tutto
        setPlayers(data.players);
        setTrainings(data.trainings);
        setMatches(data.matches);
        
        // âœ… Ripristina injuries (con controllo retrocompatibilitÃ )
        if (data.injuries) {
          setInjuries(data.injuries);
        }
        
        // âœ… Ripristina formazioni (con controllo retrocompatibilitÃ )
        if (data.formationPositions) {
          setFormationPositions(data.formationPositions);
        }
        
        // Ripristina impostazioni
        if (data.appTitle) setAppTitle(data.appTitle);
        if (data.teamName) setTeamName(data.teamName);
        if (data.teamLogo) setTeamLogo(data.teamLogo);
        if (data.infoPartita) setInfoPartita(data.infoPartita);
        if (data.moduloTattico) setModuloTattico(data.moduloTattico);
        
        // Report importazione
        const stats = data.stats || {
          totalPlayers: data.players.filter(p => p.nome).length,
          totalTrainings: data.trainings.length,
          totalMatches: data.matches.length,
          totalInjuries: data.injuries?.length || 0
        };
        
        showToast(`âœ… Dati importati con successo! ${stats.totalPlayers} giocatori, ${stats.totalTrainings} allenamenti, ${stats.totalMatches} partite, ${stats.totalInjuries} infortuni`, 'success');
        event.target.value = '';
      } catch (error) {
        console.error('Errore import:', error);
        showToast('âŒ Errore nel caricamento del file! Verifica che sia un file JSON valido.', 'error');
        event.target.value = '';
      }
    };
    reader.onerror = () => {
      showToast('âŒ Errore nella lettura del file. Riprova.', 'error');
      event.target.value = '';
    };
    reader.readAsText(file);
  };

  // ========== FUNZIONI DI RESET DATABASE ==========
  
  const resetStagione = async () => {
    const conferma1 = window.confirm(
      'âš ï¸ ATTENZIONE! Questa operazione cancellerÃ :\n\n' +
      'âœ“ Tutti gli allenamenti\n' +
      'âœ“ Tutte le partite\n' +
      'âœ“ Tutte le statistiche\n\n' +
      'âœ… MA manterrÃ :\n' +
      'âœ“ La rosa giocatori\n' +
      'âœ“ Il logo della squadra\n\n' +
      'ðŸ’¾ RACCOMANDAZIONE:\n' +
      'Vai su "Backup e Sync" e crea un backup completo\n' +
      'PRIMA di procedere con il reset!\n\n' +
      'Vuoi continuare?'
    );
    
    if (!conferma1) return;
    
    const conferma2 = window.confirm(
      'ðŸ”´ ULTIMA CONFERMA!\n\n' +
      'Sei sicuro di voler resettare la stagione?\n' +
      'Questa azione NON puÃ² essere annullata!\n\n' +
      'ðŸ’¡ CONSIGLIO: Se non hai fatto il backup, clicca\n' +
      'Annulla e vai su "Backup e Sync" per crearlo.'
    );
    
    if (!conferma2) return;
    
    try {
      // Cancello solo allenamenti e partite
      setTrainings([]);
      setMatches([]);
      setExpandedTrainings({});
      setModuloTattico({});
      setModuloAvversarioState({});
      setAnalisiSelezionata({});
      setConvocati(new Set());
      
      // Salvo i dati resettati
      await saveToIndexedDB('trainings', []);
      await saveToIndexedDB('matches', []);
      
      alert('âœ… Stagione resettata con successo!\n\nLa rosa giocatori Ã¨ stata mantenuta.');
    } catch (error) {
      console.error('Errore durante il reset:', error);
      alert('âŒ Errore durante il reset. Riprova.');
    }
  };
  
  const resetCompleto = async () => {
    const conferma1 = window.confirm(
      'ðŸ”´ ATTENZIONE! RESET COMPLETO!\n\n' +
      'Questa operazione cancellerÃ  TUTTO:\n\n' +
      'âœ“ Tutti i giocatori\n' +
      'âœ“ Tutti gli allenamenti\n' +
      'âœ“ Tutte le partite\n' +
      'âœ“ Tutte le statistiche\n' +
      'âœ“ Il logo della squadra\n' +
      'âœ“ Tutti i dati dell\'app\n\n' +
      'ðŸ’¾ RACCOMANDAZIONE IMPORTANTE:\n' +
      'Vai su "Backup e Sync" e crea un backup completo\n' +
      'PRIMA di procedere con il reset completo!\n\n' +
      'Vuoi continuare?'
    );
    
    if (!conferma1) return;
    
    const conferma2 = window.confirm(
      'ðŸ”´ðŸ”´ ULTIMA CONFERMA! ðŸ”´ðŸ”´\n\n' +
      'Sei ASSOLUTAMENTE SICURO?\n' +
      'Questa azione NON puÃ² essere annullata!\n\n' +
      'TUTTO verrÃ  cancellato!\n\n' +
      'ðŸ’¡ ULTIMO AVVISO: Se non hai fatto il backup,\n' +
      'clicca Annulla e vai su "Backup e Sync" per crearlo.'
    );
    
    if (!conferma2) return;
    
    const conferma3 = window.confirm('Scrivi OK per confermare il reset completo\n\n(Annulla per tornare indietro)');
    
    if (!conferma3) return;
    
    try {
      // Cancello tutto
      setPlayers([]);
      setTrainings([]);
      setMatches([]);
      setTeamLogo(null);
      setInfortunati(new Set());
      setExpandedTrainings({});
      setModuloTattico({});
      setModuloAvversarioState({});
      setAnalisiSelezionata({});
      setConvocati(new Set());
      
      // Cancello dal database
      const db = await initDB();
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      await store.clear();
      
      alert('âœ… Database resettato completamente!\n\nL\'applicazione Ã¨ ora come nuova.');
      
      // Ricarico la pagina per stato pulito
      window.location.reload();
    } catch (error) {
      console.error('Errore durante il reset completo:', error);
      alert('âŒ Errore durante il reset completo. Riprova.');
    }
  };

  // ============================================
  // FUNZIONI DI SINCRONIZZAZIONE CLOUD
  // ============================================
  
  /**
   * Sincronizza i dati LOCALI â†’ CLOUD (Upload)
   */
  /**
   * âš ï¸ FUNZIONE DEPRECATA E RIMOSSA
   * syncToFirestore() Ã¨ stata unificata con saveDataToCloud()
   * Tutte le operazioni di salvataggio cloud ora usano teamId invece di user.uid
   * per garantire consistenza e evitare documenti duplicati.
   * 
   * Usare sempre saveDataToCloud() per salvare su cloud.
   */

  /**
   * Carica i dati CLOUD â†’ LOCALE (Download)
   */
  const syncFromFirestore = async (forceOverwrite = false) => {
    console.log('ðŸ”½ SCARICA DA CLOUD - Inizio');
    console.log('   User:', user?.email);
    console.log('   User UID:', user?.uid);
    console.log('   Team ID:', teamId);
    console.log('   Force Overwrite:', forceOverwrite);
    
    if (!user) {
      console.log('âŒ ERRORE: Nessun user autenticato');
      setSyncError('Devi essere autenticato per sincronizzare');
      return false;
    }

    if (!teamId) {
      console.log('âŒ ERRORE: Team ID non presente');
      setSyncError('Team ID non trovato');
      return false;
    }

    try {
      setSyncStatus('syncing');
      setSyncError('');
      
      console.log('ðŸ“¡ Connessione al database cloud...');
      // âš ï¸ USA TEAMID invece di user.uid per consistenza
      const docRef = db.collection('teamData').doc(teamId);
      const doc = await docRef.get();
      
      console.log('ðŸ“„ Documento esistente?', doc.exists);

      if (!doc.exists) {
        console.log('âŒ ERRORE: Nessun dato nel cloud');
        setSyncError('Nessun dato trovato nel cloud. Effettua prima un upload.');
        setSyncStatus('error');
        return false;
    }

      const cloudData = doc.data();
      console.log('â˜ï¸ Dati cloud ricevuti:', {
        hasPlayers: !!cloudData.players,
        playersCount: cloudData.players?.length,
        hasTrainings: !!cloudData.trainings,
        trainingsCount: cloudData.trainings?.length,
        hasMatches: !!cloudData.matches,
        matchesCount: cloudData.matches?.length,
        lastSynced: cloudData.lastSynced
      });
      
      // Verifica conflitti se non Ã¨ un overwrite forzato
      if (!forceOverwrite) {
        console.log('ðŸ” Controllo conflitti (forceOverwrite=false)...');
        const hasLocalData = players.some(p => p.nome) || trainings.length > 0 || matches.length > 0;
        
        if (hasLocalData) {
          console.log('ðŸ“ Dati locali presenti, confronto date...');
          // Controlla se i dati locali sono piÃ¹ recenti
          const localLastSaved = lastSaved ? new Date(lastSaved) : new Date(0);
          const cloudLastSynced = cloudData.lastSynced ? new Date(cloudData.lastSynced) : new Date(0);
          
          console.log('   Locale:', localLastSaved);
          console.log('   Cloud:', cloudLastSynced);
          
          if (localLastSaved > cloudLastSynced) {
            console.log('âš ï¸ CONFLITTO: Dati locali piÃ¹ recenti! Mostro modal...');
            // Dati locali piÃ¹ recenti - mostra dialogo conflitto
            setSyncConflicts({
              local: { 
                players, 
                trainings, 
                matches, 
                squadreGirone,            // âœ… AGGIUNTO
                risultatiCampionato,      // âœ… AGGIUNTO
                lastSaved: localLastSaved 
              },
              cloud: { 
                players: cloudData.players, 
                trainings: cloudData.trainings, 
                matches: cloudData.matches,
                squadreGirone: cloudData.squadreGirone || [],              // âœ… AGGIUNTO
                risultatiCampionato: cloudData.risultatiCampionato || [],  // âœ… AGGIUNTO
                lastSynced: cloudLastSynced 
              }
            });
            setShowConflictModal(true);
            setSyncStatus('idle');
            return false;
          }
        }
      } else {
        console.log('âš¡ Overwrite forzato, skip controllo conflitti');
      }

      // Carica i dati dal cloud
      console.log('ðŸ“¥ Caricamento dati dal cloud in stato React...');
      
      // âœ… Normalizza giocatori con campo fuoriRosa
      let normalizedPlayers = [];
      if (cloudData.players) {
        console.log('   âœ… Carico Players:', cloudData.players.length);
        normalizedPlayers = cloudData.players.map(p => ({
          ...p,
          fuoriRosa: p.fuoriRosa || false
        }));
        setPlayers(normalizedPlayers);
      }
      
      if (cloudData.trainings) {
        console.log('   âœ… Carico Trainings:', cloudData.trainings.length);
        setTrainings(cloudData.trainings);
      }
      if (cloudData.matches) {
        console.log('   âœ… Carico Matches:', cloudData.matches.length);
        setMatches(cloudData.matches);
      }
      if (cloudData.appTitle) setAppTitle(cloudData.appTitle);
      if (cloudData.hasOwnProperty('teamName')) {
        console.log('   âœ… Carico Team Name:', cloudData.teamName || '(vuoto)');
        setTeamName(cloudData.teamName || '');
      }
      if (cloudData.teamLogo) setTeamLogo(cloudData.teamLogo);
      // if (cloudData.teamLogoStorageUrl) { // âš ï¸ RIMOSSO - Campo ridondante
      //   console.log('   âœ… Carico Team Logo Storage URL:', cloudData.teamLogoStorageUrl);
      //   setTeamLogoStorageUrl(cloudData.teamLogoStorageUrl);
      // }
      if (cloudData.injuries) {
        console.log('   âœ… Carico Injuries:', cloudData.injuries.length);
        setInjuries(cloudData.injuries);
      }
      if (cloudData.squadreGirone) {
        console.log('   âœ… Carico Squadre Girone:', cloudData.squadreGirone.length);
        setSquadreGirone(cloudData.squadreGirone);
      }
      if (cloudData.risultatiCampionato) {
        console.log('   âœ… Carico Risultati Campionato:', cloudData.risultatiCampionato.length);
        setRisultatiCampionato(cloudData.risultatiCampionato);
      }
      
      setLastSynced(new Date(cloudData.lastSynced));
      setSyncStatus('success');
      
      console.log('âœ… SCARICA COMPLETATO con successo!');
      
      // Toast di conferma con dettagli
      const totale = (cloudData.players?.length || 0) + 
                     (cloudData.trainings?.length || 0) + 
                     (cloudData.matches?.length || 0);
      showToast(
        `âœ… Dati scaricati dal cloud!\nðŸ“Š ${cloudData.players?.length || 0} giocatori, ${cloudData.trainings?.length || 0} allenamenti, ${cloudData.matches?.length || 0} partite`,
        'success',
        5000
      );
      
      // Salva anche in locale
      const dataToSave = {
        players: normalizedPlayers.length > 0 ? normalizedPlayers : cloudData.players,
        trainings: cloudData.trainings,
        matches: cloudData.matches,
        appTitle: cloudData.appTitle,
        teamLogo: cloudData.teamLogo,
        injuries: cloudData.injuries || [],
        squadreGirone: cloudData.squadreGirone || [],
        risultatiCampionato: cloudData.risultatiCampionato || [],
        lastSaved: new Date().toISOString()
      };
      await saveToIndexedDB('squadraRealDOR', dataToSave);
      setLastSaved(new Date()); // âœ… Aggiorna timestamp locale dopo download
      
      // Reset stato dopo 3 secondi
      setTimeout(() => setSyncStatus('idle'), 3000);
      
      // Redirect automatico alla dashboard dopo 2 secondi per vedere i dati
      setTimeout(() => {
        console.log('ðŸ”„ Redirect automatico alla dashboard...');
        setActiveTab('dashboard');
      }, 2000);
      
      return true;
    } catch (error) {
      console.error('Errore caricamento da cloud:', error);
      setSyncError('Errore durante il caricamento: ' + error.message);
      setSyncStatus('error');
      return false;
    }
  };

  /**
   * Sincronizzazione bidirezionale intelligente
   */
  const smartSync = async () => {
    if (!user) {
      setSyncError('Devi essere autenticato per sincronizzare');
      return false;
    }

    if (!teamId) {
      setSyncError('Team ID non trovato');
      return false;
    }

    try {
      setSyncStatus('syncing');
      setSyncError('');

      // PROTEZIONE: Conta dati locali
      const localPlayersCount = players.filter(p => p.nome).length;
      const localTrainingsCount = trainings.length;
      const localMatchesCount = matches.length;
      const hasLocalData = localPlayersCount > 0 || localTrainingsCount > 0 || localMatchesCount > 0;

      // Recupera dati dal cloud usando TEAMID
      const docRef = db.collection('teamData').doc(teamId);
      const doc = await docRef.get();

      if (!doc.exists) {
        // Nessun dato nel cloud
        if (hasLocalData) {
          // Abbiamo dati locali, possiamo uploadare
          await saveDataToCloud(true); // true = silent
          setSyncStatus('success');
          setLastSynced(new Date());
          setTimeout(() => setSyncStatus('idle'), 3000);
          return true;
        } else {
          // Nessun dato nÃ© locale nÃ© cloud
          setSyncError('Nessun dato disponibile. Inizia inserendo giocatori o partite.');
          setSyncStatus('error');
          return false;
        }
      }

      const cloudData = doc.data();
      const cloudPlayersCount = (cloudData.players || []).filter(p => p.nome).length;
      const cloudTrainingsCount = (cloudData.trainings || []).length;
      const cloudMatchesCount = (cloudData.matches || []).length;
      const hasCloudData = cloudPlayersCount > 0 || cloudTrainingsCount > 0 || cloudMatchesCount > 0;

      // PROTEZIONE CRITICA: Non sovrascrivere MAI cloud pieno con locale vuoto!
      if (hasCloudData && !hasLocalData) {
        console.log('âš ï¸ PROTEZIONE: Database locale vuoto, scarico da cloud invece di sovrascrivere!');
        showToast('â¬‡ï¸ Database locale vuoto, scaricando da cloud...', 'info');
        return await syncFromFirestore(true); // Force download
      }

      const cloudLastSynced = cloudData.timestamp || cloudData.lastSynced ? new Date(cloudData.timestamp || cloudData.lastSynced) : new Date(0);
      const localLastSaved = lastSaved ? new Date(lastSaved) : new Date(0);

      // PROTEZIONE: Se locale vuoto ma cloud pieno, SEMPRE scarica
      if (!hasLocalData && hasCloudData) {
        console.log('â¬‡ï¸ Database locale vuoto, scarico da cloud');
        return await syncFromFirestore(true);
      }

      // PROTEZIONE: Se dati molto diversi, chiedi conferma
      const dataDifferenceThreshold = 5; // Se differenza > 5 elementi, chiedi conferma
      const playersDiff = Math.abs(localPlayersCount - cloudPlayersCount);
      const trainingsDiff = Math.abs(localTrainingsCount - cloudTrainingsCount);
      const matchesDiff = Math.abs(localMatchesCount - cloudMatchesCount);
      
      if (playersDiff > dataDifferenceThreshold || trainingsDiff > dataDifferenceThreshold || matchesDiff > dataDifferenceThreshold) {
        // Grande differenza nei dati - mostra modal conflitto
        setSyncConflicts({
          local: { 
            players: players.filter(p => p.nome), 
            trainings, 
            matches, 
            lastSaved: localLastSaved 
          },
          cloud: { 
            players: cloudData.players || [], 
            trainings: cloudData.trainings || [], 
            matches: cloudData.matches || [], 
            lastSynced: cloudLastSynced 
          }
        });
        setShowConflictModal(true);
        setSyncStatus('idle');
        return false;
      }

      // Confronta timestamp (solo se dati simili)
      if (localLastSaved > cloudLastSynced) {
        // Locale piÃ¹ recente â†’ Upload
        await saveDataToCloud(true); // true = silent
        setSyncStatus('success');
        setLastSynced(new Date());
        setTimeout(() => setSyncStatus('idle'), 3000);
        return true;
      } else if (cloudLastSynced > localLastSaved) {
        // Cloud piÃ¹ recente â†’ Download
        return await syncFromFirestore(false);
      } else {
        // Stesso timestamp - giÃ  sincronizzato
        setSyncStatus('success');
        setLastSynced(new Date());
        setTimeout(() => setSyncStatus('idle'), 3000);
        return true;
      }
    } catch (error) {
      console.error('Errore smart sync:', error);
      setSyncError('Errore durante la sincronizzazione: ' + error.message);
      setSyncStatus('error');
      return false;
    }
  };

  /**
   * Risolvi conflitto - scegli quale versione mantenere
   */
  const resolveConflict = async (choice) => {
    try {
      setSyncStatus('syncing');
      
      if (choice === 'local') {
        // Mantieni locale e sovrascrivi cloud
        await saveDataToCloud(true); // true = silent
        setSyncStatus('success');
        setLastSynced(new Date());
        showToast('âœ… Dati locali salvati su cloud', 'success');
      } else if (choice === 'cloud') {
        // Mantieni cloud e sovrascrivi locale
        await syncFromFirestore(true);
      }
      
      setSyncConflicts(null);
      setShowConflictModal(false);
      setTimeout(() => setSyncStatus('idle'), 3000);
    } catch (error) {
      console.error('Errore risoluzione conflitto:', error);
      setSyncError('Errore: ' + error.message);
      setSyncStatus('error');
    }
  };

  // ========== GESTIONE UTENTI ADMIN ==========
  
  /**
   * Carica lista utenti da Firebase Auth e Firestore
   */
  const loadAllUsers = async () => {
    if (userRole !== 'admin') {
      showToast('â›” Solo gli admin possono gestire utenti', 'error');
      return;
    }

    setLoadingUsers(true);
    try {
      // Carica utenti da database cloud (contiene ruoli)
      const usersSnapshot = await db.collection('users').get();
      const usersData = [];
      
      usersSnapshot.forEach(doc => {
        usersData.push({
          uid: doc.id,
          ...doc.data()
        });
      });

      // Ordina per email
      usersData.sort((a, b) => (a.email || '').localeCompare(b.email || ''));
      
      setAllUsers(usersData);
      showToast(`âœ… Caricati ${usersData.length} utenti`, 'success');
    } catch (error) {
      console.error('Errore caricamento utenti:', error);
      showToast('âŒ Errore caricamento utenti: ' + error.message, 'error');
    } finally {
      setLoadingUsers(false);
    }
  };

  /**
   * Crea nuovo utente
   * NOTA: Questa operazione fa logout dell'admin temporaneamente
   */
  const createNewUser = async () => {
    if (!newUserEmail || !newUserPassword) {
      showToast('âš ï¸ Email e password sono obbligatori', 'error');
      return;
    }

    if (newUserPassword.length < 6) {
      showToast('âš ï¸ Password deve essere almeno 6 caratteri', 'error');
      return;
    }

    if (!window.confirm(`Creare nuovo utente?\n\nEmail: ${newUserEmail}\nRuolo: ${newUserRole}\n\nâš ï¸ ATTENZIONE: Questa operazione ti farÃ  logout temporaneamente. Dovrai rifare login come admin dopo.`)) {
      return;
    }

    setUserActionLoading(true);
    
    try {
      // IMPORTANTE: Salva UID admin PRIMA che cambi
      const currentAdminUid = user.uid;
      const currentAdminEmail = user.email;
      
      // Crea nuovo utente (questo fa logout dell'admin e login del nuovo utente!)
      const userCredential = await auth.createUserWithEmailAndPassword(newUserEmail, newUserPassword);
      const newUser = userCredential.user;

      // CRITICO: Ora sei loggato come il NUOVO utente, non piÃ¹ come admin!
      // Ma possiamo comunque scrivere perchÃ© usiamo l'UID che abbiamo appena creato
      
      // Salva ruolo nel database cloud
      await db.collection('users').doc(newUser.uid).set({
        email: newUserEmail,
        role: newUserRole,
        createdAt: new Date().toISOString(),
        createdBy: currentAdminUid  // â† Usa UID admin salvato prima!
      });

      showToast('âœ… Utente creato! Rifai login come admin...', 'success');
      
      // Logout del nuovo utente
      await auth.signOut();
      
      // Chiudi modal
      setShowCreateUserModal(false);
      setNewUserEmail('');
      setNewUserPassword('');
      setNewUserRole('user');
      
      // L'admin dovrÃ  rifare login manualmente
      
    } catch (error) {
      console.error('Errore creazione utente:', error);
      let errorMsg = 'Errore creazione utente';
      if (error.code === 'auth/email-already-in-use') {
        errorMsg = 'Email giÃ  in uso';
      } else if (error.code === 'auth/invalid-email') {
        errorMsg = 'Email non valida';
      } else if (error.code === 'auth/weak-password') {
        errorMsg = 'Password troppo debole';
      } else if (error.code === 'permission-denied') {
        errorMsg = 'Errore permessi database. Contatta l\'amministratore!';
      }
      showToast('âŒ ' + errorMsg, 'error');
    } finally {
      setUserActionLoading(false);
    }
  };

  /**
   * Cambia ruolo utente
   */
  const changeUserRole = async (userId, newRole) => {
    if (userRole !== 'admin') {
      showToast('â›” Solo gli admin possono cambiare ruoli', 'error');
      return;
    }

    if (userId === user.uid) {
      showToast('âš ï¸ Non puoi cambiare il tuo stesso ruolo', 'error');
      return;
    }

    if (!window.confirm(`Cambiare ruolo a ${newRole}?`)) {
      return;
    }

    setUserActionLoading(true);
    try {
      await db.collection('users').doc(userId).update({
        role: newRole,
        updatedAt: new Date().toISOString(),
        updatedBy: user.uid
      });

      showToast('âœ… Ruolo aggiornato!', 'success');
      
      // Ricarica lista utenti
      await loadAllUsers();
      
    } catch (error) {
      console.error('Errore cambio ruolo:', error);
      showToast('âŒ Errore cambio ruolo: ' + error.message, 'error');
    } finally {
      setUserActionLoading(false);
    }
  };

  /**
   * Invia email reset password a utente
   */
  const sendPasswordReset = async (userEmail) => {
    if (userRole !== 'admin') {
      showToast('â›” Solo gli admin possono resettare password', 'error');
      return;
    }

    if (!window.confirm(`Inviare email di reset password a:\n${userEmail}?`)) {
      return;
    }

    setUserActionLoading(true);
    try {
      await auth.sendPasswordResetEmail(userEmail);
      showToast(`âœ… Email inviata a ${userEmail}`, 'success');
    } catch (error) {
      console.error('Errore invio email:', error);
      showToast('âŒ Errore invio email: ' + error.message, 'error');
    } finally {
      setUserActionLoading(false);
    }
  };

  /**
   * Elimina utente
   * NOTA: Elimina solo da Firestore, non da Authentication
   * Per eliminare completamente serve Firebase Admin SDK (backend)
   */
  const deleteUser = async (userId, userEmail) => {
    if (userRole !== 'admin') {
      showToast('â›” Solo gli admin possono eliminare utenti', 'error');
      return;
    }

    if (userId === user.uid) {
      showToast('âš ï¸ Non puoi eliminare te stesso!', 'error');
      return;
    }

    if (!window.confirm(`âš ï¸ ATTENZIONE!\n\nEliminare utente?\nEmail: ${userEmail}\n\nQuesta azione rimuoverÃ  il ruolo dal database cloud.\nPer eliminare completamente l'account, contatta l'amministratore.`)) {
      return;
    }

    setUserActionLoading(true);
    try {
      // Elimina documento dal database cloud
      await db.collection('users').doc(userId).delete();

      showToast('âœ… Utente rimosso dal database', 'success');
      
      // Ricarica lista
      await loadAllUsers();
      
    } catch (error) {
      console.error('Errore eliminazione utente:', error);
      showToast('âŒ Errore: ' + error.message, 'error');
    } finally {
      setUserActionLoading(false);
    }
  };

  // ========== SINCRONIZZAZIONE AUTOMATICA ==========
  
  // NOTA: Sync al login RIMOSSO per sicurezza!
  // Era pericoloso perchÃ© poteva sovrascrivere cloud con database vuoto
  // Ora l'utente deve fare sync manuale cliccando "Scarica da Cloud"

  // ========== EXPORT PDF RISULTATI PARTITE ==========
  const exportResultsPDF = () => {
    if (matches.length === 0) {
      showToast('âš ï¸ Nessuna partita presente', 'warning');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Titolo
    doc.setFontSize(20);
    doc.text('RISULTATI PARTITE', 105, 20, { align: 'center' });
    doc.setFontSize(14);
    doc.text(appTitle, 105, 28, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Stagione 2024/2025', 105, 35, { align: 'center' });
    
    // Data generazione
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}`, 105, 41, { align: 'center' });
    doc.setTextColor(0, 0, 0);
    
    let yPosition = 50;
    
    // Prepara dati partite
    const matchesData = matches
      .filter(m => {
        const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        return golFatti > 0 || golSubiti > 0; // Solo partite completate
      })
      .sort((a, b) => new Date(a.data) - new Date(b.data)) // Ordina per data
      .map(m => {
        const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        const risultato = golFatti > golSubiti ? 'V' : golFatti === golSubiti ? 'P' : 'S';
        
        return {
          data: new Date(m.data).toLocaleDateString('it-IT'),
          avversario: m.squadraCasa && m.squadraTrasferta 
            ? `${m.squadraCasa} vs ${m.squadraTrasferta}`
            : m.avversario || m.squadraTrasferta || 'Avversario',
          risultatoText: `${golFatti}-${golSubiti}`,
          risultato: risultato,
          luogo: m.luogo || '-',
          punti: risultato === 'V' ? 3 : risultato === 'P' ? 1 : 0
        };
      });
    
    // Statistiche riepilogative
    const totalePartite = matchesData.length;
    const vittorie = matchesData.filter(m => m.risultato === 'V').length;
    const pareggi = matchesData.filter(m => m.risultato === 'P').length;
    const sconfitte = matchesData.filter(m => m.risultato === 'S').length;
    const puntiTotali = matchesData.reduce((sum, m) => sum + m.punti, 0);
    
    // Box statistiche
    doc.setFillColor(240, 240, 240);
    doc.rect(15, yPosition, 180, 25, 'F');
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('STATISTICHE STAGIONE', 20, yPosition + 7);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Partite: ${totalePartite}`, 20, yPosition + 14);
    doc.text(`Vittorie: ${vittorie}`, 60, yPosition + 14);
    doc.text(`Pareggi: ${pareggi}`, 95, yPosition + 14);
    doc.text(`Sconfitte: ${sconfitte}`, 130, yPosition + 14);
    doc.text(`Punti: ${puntiTotali}`, 170, yPosition + 14);
    
    doc.setFontSize(9);
    doc.text(`% Vittorie: ${totalePartite > 0 ? ((vittorie / totalePartite) * 100).toFixed(1) : 0}%`, 20, yPosition + 21);
    doc.text(`Media Punti/Partita: ${totalePartite > 0 ? (puntiTotali / totalePartite).toFixed(2) : 0}`, 95, yPosition + 21);
    
    yPosition += 32;
    
    // Tabella risultati
    const tableData = matchesData.map(m => [
      m.data,
      m.avversario,
      m.risultatoText,
      m.risultato,
      m.luogo
    ]);
    
    doc.autoTable({
      startY: yPosition,
      head: [['Data', 'Partita', 'Risultato', 'Esito', 'Luogo']],
      body: tableData,
      theme: 'grid',
      headStyles: { 
        fillColor: [59, 130, 246],
        fontSize: 10,
        fontStyle: 'bold',
        halign: 'center'
      },
      bodyStyles: { 
        fontSize: 9 
      },
      columnStyles: {
        0: { halign: 'center', cellWidth: 25 },
        1: { halign: 'left', cellWidth: 70 },
        2: { halign: 'center', cellWidth: 25, fontStyle: 'bold' },
        3: { halign: 'center', cellWidth: 20, fontStyle: 'bold' },
        4: { halign: 'left', cellWidth: 50 }
      },
      didParseCell: function(data) {
        // Colora l'esito (V/P/S)
        if (data.column.index === 3 && data.section === 'body') {
          const esito = data.cell.text[0];
          if (esito === 'V') {
            data.cell.styles.textColor = [16, 185, 129];
            data.cell.styles.fontStyle = 'bold';
          } else if (esito === 'P') {
            data.cell.styles.textColor = [245, 158, 11];
            data.cell.styles.fontStyle = 'bold';
          } else if (esito === 'S') {
            data.cell.styles.textColor = [239, 68, 68];
            data.cell.styles.fontStyle = 'bold';
          }
        }
      }
    });
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.text(`Pagina ${i} di ${pageCount}`, 105, 290, { align: 'center' });
      doc.text(`Generato da ${appTitle}`, 105, 285, { align: 'center' });
    }
    
    // Salva PDF
    doc.save(`Risultati_Partite_${new Date().toLocaleDateString('it-IT').replace(/\//g, '-')}.pdf`);
    showToast('âœ… PDF risultati generato!', 'success');
  };

  // ========== USE EFFECT PER GRAFICI DASHBOARD (CON RETRY LOGIC E RESPONSIVE MOBILE) ==========
  useEffect(() => {
    console.log('ðŸ“Š useEffect grafici dashboard triggered');
    console.log('   activeTab:', activeTab);
    console.log('   Chart defined?', typeof Chart !== 'undefined');
    
    if (activeTab === 'dashboard' && typeof Chart !== 'undefined') {
      console.log('âœ… Condizioni soddisfatte, creo grafici...');
      
      // Funzione per tentare la creazione del grafico con retry
      const tryCreateChart = (chartId, createFn, retries = 0) => {
        const maxRetries = 5; // Tenta fino a 5 volte
        const baseDelay = 300; // Parti da 300ms
        
        const attemptCreate = () => {
          const canvas = document.getElementById(chartId);
          
          if (canvas) {
            console.log(`âœ… Canvas ${chartId} trovato, creo grafico...`);
            // Distruggi grafico esistente se c'Ã¨
            const existingChart = Chart.getChart(canvas);
            if (existingChart) existingChart.destroy();
            
            createFn(canvas);
          } else if (retries < maxRetries) {
            console.log(`â° Canvas ${chartId} non trovato, retry ${retries + 1}/${maxRetries}...`);
            setTimeout(() => tryCreateChart(chartId, createFn, retries + 1), baseDelay * (retries + 1));
          } else {
            console.log(`âŒ Canvas ${chartId} non trovato dopo ${maxRetries} tentativi`);
          }
        };
        
        attemptCreate();
      };
      
      // Aspetta che il DOM sia pronto
      setTimeout(() => {
        console.log('â° Inizio creazione grafici...');
        
        // ============ GRAFICO GOL FATTI/SUBITI ============
        tryCreateChart('goalsChart', (ctx) => {
          const matchDates = matches.map(m => new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }));
          
          // Calcola totali cumulativi
          let totaleFatti = 0;
          let totaleSubiti = 0;
          const golFattiCumulativi = [];
          const golSubitiCumulativi = [];
          
          matches.forEach(m => {
            const fatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
            const subiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
            
            totaleFatti += fatti;
            totaleSubiti += subiti;
            
            golFattiCumulativi.push(totaleFatti);
            golSubitiCumulativi.push(totaleSubiti);
          });
          
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: matchDates,
              datasets: [
                {
                  label: 'Totale Gol Fatti',
                  data: golFattiCumulativi,
                  borderColor: '#10b981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3,
                  pointRadius: 5,
                  pointHoverRadius: 7
                },
                {
                  label: 'Totale Gol Subiti',
                  data: golSubitiCumulativi,
                  borderColor: '#ef4444',
                  backgroundColor: 'rgba(239, 68, 68, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3,
                  pointRadius: 5,
                  pointHoverRadius: 7
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: window.innerWidth < 768 ? 1.2 : 2, // Mobile piÃ¹ quadrato
              plugins: {
                legend: {
                  position: 'top',
                  labels: {
                    font: {
                      size: window.innerWidth < 768 ? 11 : 13, // Font piÃ¹ piccolo su mobile
                      weight: 'bold'
                    },
                    padding: window.innerWidth < 768 ? 8 : 15
                  }
                },
                tooltip: {
                  callbacks: {
                    title: function(context) {
                      return 'Dopo: ' + context[0].label;
                    },
                    afterLabel: function(context) {
                      const index = context.dataIndex;
                      if (index === 0) return '';
                      
                      const prevFatti = context.dataset.label.includes('Fatti') 
                        ? (index > 0 ? golFattiCumulativi[index - 1] : 0)
                        : (index > 0 ? golSubitiCumulativi[index - 1] : 0);
                      const current = context.parsed.y;
                      const diff = current - prevFatti;
                      
                      return `(${diff >= 0 ? '+' : ''}${diff} in questa partita)`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { 
                    stepSize: 5,
                    font: {
                      size: window.innerWidth < 768 ? 10 : 12,
                      weight: 'bold'
                    }
                  },
                  title: {
                    display: window.innerWidth >= 768, // Nascondi titolo asse su mobile
                    text: 'Totale Gol',
                    font: {
                      size: 14,
                      weight: 'bold'
                    }
                  }
                },
                x: {
                  ticks: {
                    font: {
                      size: window.innerWidth < 768 ? 9 : 11
                    },
                    maxRotation: 45,
                    minRotation: 0
                  }
                }
              }
            }
          });
        });

        // ============ GRAFICO RISULTATI ============
        tryCreateChart('resultsChart', (ctx) => {
          let vittorie = 0, pareggi = 0, sconfitte = 0;
          matches.forEach(m => {
            // âœ… FIX: Calcola sempre da golFatti e golSubiti invece del campo risultato
            const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
            const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
            
            // Considera solo partite completate (almeno un gol segnato o subito)
            if (golFatti === 0 && golSubiti === 0) return;
            
            if (golFatti > golSubiti) vittorie++;
            else if (golFatti === golSubiti) pareggi++;
            else sconfitte++;
          });
          
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: [`Vittorie (${vittorie})`, `Pareggi (${pareggi})`, `Sconfitte (${sconfitte})`],
              datasets: [{
                data: [vittorie, pareggi, sconfitte],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: window.innerWidth < 768 ? 1 : 1.5,
              plugins: {
                legend: {
                  position: window.innerWidth < 768 ? 'bottom' : 'bottom',
                  labels: {
                    font: {
                      size: window.innerWidth < 768 ? 11 : 14,
                      weight: 'bold'
                    },
                    padding: window.innerWidth < 768 ? 10 : 15
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.parsed || 0;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return `${label}: ${percentage}%`;
                    }
                  }
                }
              }
            }
          });
        });

        // ============ GRAFICO PRESENZE ALLENAMENTI ============
        tryCreateChart('attendanceChart', (ctx) => {
          const last10Trainings = trainings.slice(-10);
          const trainingDates = last10Trainings.map(t => new Date(t.data).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }));
          const presenze = last10Trainings.map(t => 
            Object.entries(t.presenze)
              .filter(([numero, presente]) => {
                if (!presente) return false;
                const player = players.find(p => p.numero === parseInt(numero));
                if (!player || !player.nome) return false;
                if (player.fuoriRosa) return false;
                if (player.dataCreazione && new Date(player.dataCreazione) > new Date(t.data)) return false;
                return true;
              })
              .length
          );
          
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: trainingDates,
              datasets: [{
                label: 'Presenze',
                data: presenze,
                backgroundColor: '#3b82f6',
                borderRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: window.innerWidth < 768 ? 1.2 : 2,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { 
                    stepSize: 1,
                    font: {
                      size: window.innerWidth < 768 ? 10 : 12
                    }
                  }
                },
                x: {
                  ticks: {
                    font: {
                      size: window.innerWidth < 768 ? 9 : 11
                    },
                    maxRotation: 45,
                    minRotation: 0
                  }
                }
              }
            }
          });
        });
        
      }, 500); // Timeout iniziale ridotto a 500ms, poi retry gestiti internamente

    }
  }, [activeTab, matches, trainings, players]);

  // ============================================
  // FINE FUNZIONI SINCRONIZZAZIONE
  // ============================================

  const calculateStats = () => {
    const stats = {};
    
    players.forEach(player => {
      if (!player.nome) return;
      
      stats[player.numero] = {
        nome: player.nome,
        ruolo: player.ruolo,
        dataCreazione: player.dataCreazione,
        allenamenti_presenze: 0,
        allenamenti_assenze: 0,
        infortuni: 0,
        partite_convocato: 0,
        partite_titolare: 0,
        minuti_totali: 0,
        gol: 0,
        assist: 0,
        gol_subiti: 0,
        gialli_gioco: 0,
        gialli_protesta: 0,
        rossi_gioco: 0,
        rossi_protesta: 0
      };
    });

    trainings.forEach(training => {
      Object.keys(training.presenze || {}).forEach(numero => {
        if (stats[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(training.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          if (training.presenze[numero] === true) {
            stats[numero].allenamenti_presenze++;
          } else if (training.presenze[numero] === false) {
            stats[numero].allenamenti_assenze++;
          }
        }
      });
      
      Object.keys(training.infortuni || {}).forEach(numero => {
        if (stats[numero] && training.infortuni[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(training.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].infortuni++;
        }
      });
    });

    matches.forEach(match => {
      Object.keys(match.convocati || {}).forEach(numero => {
        if (stats[numero] && match.convocati[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].partite_convocato++;
        }
      });
      
      Object.keys(match.titolari || {}).forEach(numero => {
        if (stats[numero] && match.titolari[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].partite_titolare++;
        }
      });
      
      Object.keys(match.sostituzioni || {}).forEach(numero => {
        if (stats[numero] && match.sostituzioni[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          if (!match.titolari[numero]) {
            stats[numero].partite_titolare++;
          }
        }
      });

      Object.keys(match.minutiGiocati || {}).forEach(numero => {
        if (stats[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].minuti_totali += parseInt(match.minutiGiocati[numero] || 0);
        }
      });

      ['golFatti', 'assist', 'golSubiti', 'gialli_gioco', 'gialli_protesta', 'rossi_gioco', 'rossi_protesta'].forEach(field => {
        const mappedField = field === 'golFatti' ? 'gol' : field === 'golSubiti' ? 'gol_subiti' : field;
        Object.keys(match[field] || {}).forEach(numero => {
          if (stats[numero]) {
            const playerDataCreazione = stats[numero].dataCreazione;
            if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
              return;
            }
            
            stats[numero][mappedField] += parseInt(match[field][numero] || 0);
          }
        });
      });
    });

    // Funzione helper per ordinamento per ruolo
    const getRuoloOrder = (ruolo) => {
      if (!ruolo) return 999;
      const r = ruolo.toLowerCase().trim();
      
      // 1. Portieri
      if (r.includes('portier') || r === 'por' || r === 'p') return 1;
      
      // 2. Difensori centrali
      if ((r.includes('difensor') && r.includes('central')) || 
          r === 'dc' || r === 'difensore centrale') return 2;
      
      // 3. Terzini
      if (r.includes('terzin') || r === 'td' || r === 'ts' || 
          r === 'terzino destro' || r === 'terzino sinistro') return 3;
      
      // 4. Centrocampisti centrali
      if ((r.includes('centroc') && r.includes('central')) || 
          r === 'cc' || r === 'centrocampista centrale' ||
          r.includes('mediano') || r.includes('regista')) return 4;
      
      // 5. Esterni alti (esterni di centrocampo)
      if ((r.includes('esterno') || r.includes('ala')) && 
          !r.includes('attacc') && !r.includes('trequart')) return 5;
      
      // 6. Trequartisti
      if (r.includes('trequart') || r === 'tq' || r === 'trequartista') return 6;
      
      // 7. Attaccanti
      if (r.includes('attacc') || r.includes('punta') || 
          r === 'at' || r === 'pc' || r === 'as' || r === 'ad') return 7;
      
      // Altri difensori (fallback)
      if (r.includes('difensor') || r.includes('libero')) return 2.5;
      
      // Altri centrocampisti (fallback)
      if (r.includes('centroc') || r.includes('mezzala')) return 4.5;
      
      return 999; // Ruoli non riconosciuti vanno alla fine
    };

    return Object.values(stats)
      .filter(s => s.nome)
      .sort((a, b) => {
        // Prima ordina per ruolo
        const ruoloA = getRuoloOrder(a.ruolo);
        const ruoloB = getRuoloOrder(b.ruolo);
        if (ruoloA !== ruoloB) return ruoloA - ruoloB;
        
        // Poi alfabeticamente per nome
        return a.nome.localeCompare(b.nome);
      });
  };

  const getNumeroAlfabetico = (nomeGiocatore) => {
    const giocatoriOrdinati = players
      .filter(p => p.nome)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    
    const index = giocatoriOrdinati.findIndex(p => p.nome === nomeGiocatore);
    return index >= 0 ? index + 1 : null;
  };

  // ========== FUNZIONE EXPORT ROSA PDF ==========
  
  const exportRosaPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const currentYear = new Date().getFullYear();
    
    // Helper per ordinamento ruoli (stesso di calculateStats)
    const getRuoloOrderPDF = (ruolo) => {
      if (!ruolo) return 999;
      const r = ruolo.toLowerCase().trim();
      
      if (r.includes('portier') || r === 'por' || r === 'p') return 1;
      if ((r.includes('difensor') && r.includes('central')) || r === 'dc' || r === 'difensore centrale') return 2;
      if (r.includes('terzin') || r === 'td' || r === 'ts' || r === 'terzino destro' || r === 'terzino sinistro') return 3;
      if ((r.includes('centroc') && r.includes('central')) || r === 'cc' || r === 'centrocampista centrale' || r.includes('mediano') || r.includes('regista')) return 4;
      if ((r.includes('esterno') || r.includes('ala')) && !r.includes('attacc') && !r.includes('trequart')) return 5;
      if (r.includes('trequart') || r === 'tq' || r === 'trequartista') return 6;
      if (r.includes('attacc') || r.includes('punta') || r === 'at' || r === 'pc' || r === 'as' || r === 'ad') return 7;
      if (r.includes('difensor') || r.includes('libero')) return 2.5;
      if (r.includes('centroc') || r.includes('mezzala')) return 4.5;
      return 999;
    };
    
    // Helper per ottenere categoria ruolo
    const getRuoloCategoria = (ruolo) => {
      const order = getRuoloOrderPDF(ruolo);
      if (order === 1) return 'Portieri';
      if (order >= 2 && order < 3) return 'Difensori Centrali';
      if (order === 3) return 'Terzini';
      if (order >= 4 && order < 5) return 'Centrocampisti Centrali';
      if (order === 5) return 'Esterni Alti';
      if (order === 6) return 'Trequartisti';
      if (order === 7) return 'Attaccanti';
      return 'Altri';
    };
    
    // Helper per colore ruolo
    const getRuoloColor = (categoria) => {
      const colors = {
        'Portieri': [255, 235, 59],           // Giallo
        'Difensori Centrali': [33, 150, 243], // Blu
        'Terzini': [100, 181, 246],           // Azzurro
        'Centrocampisti Centrali': [76, 175, 80], // Verde
        'Esterni Alti': [129, 199, 132],      // Verde chiaro
        'Trequartisti': [156, 39, 176],       // Viola
        'Attaccanti': [244, 67, 54],          // Rosso
        'Altri': [158, 158, 158]              // Grigio
      };
      return colors[categoria] || [200, 200, 200];
    };
    
    // Ordina giocatori per ruolo
    const giocatoriOrdinati = players
      .filter(p => p.nome)
      .sort((a, b) => {
        const ruoloA = getRuoloOrderPDF(a.ruolo);
        const ruoloB = getRuoloOrderPDF(b.ruolo);
        if (ruoloA !== ruoloB) return ruoloA - ruoloB;
        return a.nome.localeCompare(b.nome);
      });
    
    // Titolo - COMPATTO
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text(appTitle.toUpperCase(), 105, 15, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(`Rosa Stagione ${currentYear}`, 105, 22, { align: 'center' });
    
    // Sottotitolo - COMPATTO
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text(`Totale Giocatori: ${giocatoriOrdinati.length}`, 105, 28, { align: 'center' });
    
    // Linea separatore
    doc.setLineWidth(0.3);
    doc.line(20, 31, 190, 31);
    
    let yPosition = 36; // Posizione iniziale piÃ¹ alta
    let currentCategoria = '';
    let numero = 1;
    
    giocatoriOrdinati.forEach((player) => {
      const categoria = getRuoloCategoria(player.ruolo);
      
      // Nuova categoria - Header colorato COMPATTO
      if (categoria !== currentCategoria) {
        // Spazio prima della nuova categoria (ridotto)
        if (currentCategoria !== '') {
          yPosition += 2;
        }
        
        currentCategoria = categoria;
        const color = getRuoloColor(categoria);
        
        // Box colorato per categoria (ridotto)
        doc.setFillColor(color[0], color[1], color[2]);
        doc.rect(20, yPosition - 3.5, 170, 5, 'F');
        
        // Testo categoria (ridotto)
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(255, 255, 255);
        doc.text(categoria.toUpperCase(), 23, yPosition);
        
        doc.setTextColor(0, 0, 0);
        yPosition += 5.5;
      }
      
      // Giocatore - COMPATTO
      doc.setFontSize(8.5); // Font piÃ¹ piccolo
      doc.setFont(undefined, 'normal');
      
      // Numero progressivo
      doc.setFont(undefined, 'bold');
      doc.text(`${numero}.`, 23, yPosition);
      
      // Nome (troncato se troppo lungo)
      doc.setFont(undefined, 'bold');
      const nomeMax = player.nome.length > 30 ? player.nome.substring(0, 28) + '...' : player.nome;
      doc.text(nomeMax, 30, yPosition);
      
      // Ruolo specifico + Piede preferito
      doc.setFont(undefined, 'normal');
      doc.setTextColor(100, 100, 100);
      
      // Costruisci testo con ruolo e piede
      let infoText = player.ruolo || 'N/D';
      
      // Aggiungi piede se presente
      if (player.piede && player.piede !== 'Ambidestro') {
        const piedeText = player.piede === 'Destro' ? 'Piede dx' : 'Piede sx';
        infoText = `${infoText} - ${piedeText}`;
      } else if (player.piede === 'Ambidestro') {
        infoText = `${infoText} - Ambidestro`;
      }
      
      // Tronca se troppo lungo (max 50 caratteri)
      const infoMax = infoText.length > 50 ? infoText.substring(0, 47) + '...' : infoText;
      doc.text(`(${infoMax})`, 30 + doc.getTextWidth(nomeMax) + 2, yPosition);
      
      doc.setTextColor(0, 0, 0);
      
      yPosition += 5; // Spazio ridotto tra giocatori (era 7)
      numero++;
    });
    
    // Footer con data generazione
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')}`, 105, 285, { align: 'center' });
    
    // Salva PDF con nome dinamico basato su appTitle
    const fileName = `Rosa_${appTitle.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30)}_${currentYear}.pdf`;
    doc.save(fileName);
    showToast('PDF Rosa scaricato!', 'success');
  };

  // ========== MIGRAZIONE FOTO A FIREBASE STORAGE ==========
  
  const migratePhotosToStorage = async () => {
    if (!user) {
      alert('âŒ Devi essere autenticato per migrare le foto');
      return;
    }
    
    const playersWithBase64 = players.filter(p => p.foto && !p.foto.startsWith('https://'));
    
    if (playersWithBase64.length === 0) {
      showToast('âœ… Tutte le foto sono giÃ  su cloud!', 'success');
      return;
    }
    
    if (!window.confirm(`ðŸš€ Vuoi migrare ${playersWithBase64.length} foto su cloud?\n\nQuesta operazione:\nâœ… Libera spazio nel database\nâœ… Migliora le prestazioni\nâœ… Permette sync senza problemi\nâœ… Foto qualitÃ  migliore (300x300px)\n\nâš ï¸ Richiede connessione internet\nâš ï¸ Durata: ~1-2 minuti per 30 foto`)) {
      return;
    }
    
    let migrated = 0;
    let errors = 0;
    const totalPhotos = playersWithBase64.length;
    
    showToast(`ðŸš€ Migrazione ${totalPhotos} foto in corso...`, 'info', 3000);
    
    for (const player of playersWithBase64) {
      try {
        showToast(`ðŸ“¤ Migrazione ${player.nome}... (${migrated + 1}/${totalPhotos})`, 'info', 1000);
        
        // Converti base64 in blob
        const base64Data = player.foto.split(',')[1];
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'image/jpeg' });
        
        // Upload su Storage
        const storageRef = storage.ref();
        const fileName = `players/${user.uid}/${player.numero}_${Date.now()}.jpg`;
        const fileRef = storageRef.child(fileName);
        
        await fileRef.put(blob);
        const downloadURL = await fileRef.getDownloadURL();
        
        // Aggiorna player con URL
        updatePlayer(player.numero, 'foto', downloadURL);
        
        migrated++;
      } catch (error) {
        console.error(`Errore migrazione foto ${player.nome}:`, error);
        errors++;
      }
    }
    
    if (errors === 0) {
      showToast(
        `âœ… Migrazione completata!\nðŸš€ ${migrated} foto su cloud\nðŸ’¾ Database ora leggero!\nâ˜ï¸ Ora puoi sincronizzare senza problemi`,
        'success',
        8000
      );
    } else {
      showToast(
        `âš ï¸ Migrazione parziale:\nâœ… ${migrated} foto migrate\nâŒ ${errors} errori\n\nVerifica console per dettagli`,
        'warning',
        8000
      );
    }
  };

  // ========== FUNZIONI PER DIVISIONE SQUADRE ==========
  
  const mappaRuolo = (ruolo) => {
    if (!ruolo) return 'Altri';
    const ruoloLower = ruolo.toLowerCase();
    
    // Portieri
    if (ruoloLower.includes('portiere') || ruoloLower === 'p') return 'Portieri';
    
    // Difensori
    if (ruoloLower.includes('difens') || 
        ruoloLower.includes('terzin') || 
        ruoloLower.includes('libero') ||
        ruoloLower.includes('centrale') && ruoloLower.includes('dif') ||
        ['dc', 'td', 'ts', 'lb'].includes(ruoloLower)) return 'Difensori';
    
    // Centrocampisti
    if (ruoloLower.includes('centroc') || 
        ruoloLower.includes('mediano') || 
        ruoloLower.includes('esterno') && !ruoloLower.includes('attacc') ||
        ruoloLower.includes('mezzala') ||
        ruoloLower.includes('regista') ||
        ['cc', 'md', 'ed', 'es', 'mc'].includes(ruoloLower)) return 'Centrocampisti';
    
    // Attaccanti
    if (ruoloLower.includes('attacc') || 
        ruoloLower.includes('punta') || 
        ruoloLower.includes('trequart') ||
        ruoloLower.includes('ala') ||
        ruoloLower.includes('seconda punta') ||
        ['pc', 'ad', 'as', 'tq'].includes(ruoloLower)) return 'Attaccanti';
    
    return 'Altri';
  };

  const teamColors = [
    { bg: 'bg-red-600', text: 'text-red-600', name: 'A' },
    { bg: 'bg-blue-600', text: 'text-blue-600', name: 'B' },
    { bg: 'bg-green-600', text: 'text-green-600', name: 'C' },
    { bg: 'bg-purple-600', text: 'text-purple-600', name: 'D' },
    { bg: 'bg-orange-600', text: 'text-orange-600', name: 'E' },
    { bg: 'bg-pink-600', text: 'text-pink-600', name: 'F' }
  ];

  const toggleInfortunato = (nome) => {
    const newInfortunati = new Set(infortunati);
    if (newInfortunati.has(nome)) {
      newInfortunati.delete(nome);
    } else {
      newInfortunati.add(nome);
    }
    setInfortunati(newInfortunati);
  };

  const organizzaGiocatori = () => {
    console.log('ðŸ” organizzaGiocatori chiamato');
    console.log('   giocatoriSelezionati.size:', giocatoriSelezionati.size);
    console.log('   giocatoriSelezionati:', Array.from(giocatoriSelezionati));
    
    const ruoli = {
      'Portieri': [],
      'Difensori': [],
      'Centrocampisti': [],
      'Attaccanti': []
    };

    let includeCount = 0;
    let excludeCount = 0;

    players.forEach(player => {
      // Filtra per: nome esiste, non fuori rosa, non infortunato, E selezionato (se giocatoriSelezionati non Ã¨ vuoto)
      if (player.nome && !player.fuoriRosa && !infortunati.has(player.nome)) {
        // Se giocatoriSelezionati Ã¨ vuoto, include tutti (comportamento default)
        // Altrimenti include solo i selezionati
        if (giocatoriSelezionati.size === 0 || giocatoriSelezionati.has(player.nome)) {
          const ruolo = mappaRuolo(player.ruolo);
          if (ruolo !== 'Altri' && !(ruolo === 'Portieri' && !includiPortieri)) {
            ruoli[ruolo].push(player);
            includeCount++;
          }
        } else {
          excludeCount++;
          console.log('   âŒ ESCLUSO:', player.nome, '(non in giocatoriSelezionati)');
        }
      }
    });

    console.log('   âœ… Inclusi:', includeCount, 'âŒ Esclusi:', excludeCount);
    return ruoli;
  };

  const dividiSquadre = useMemo(() => {
    const ruoli = organizzaGiocatori();
    
    const squadre = Array.from({ length: numSquadre }, () => ({
      'Portieri': [],
      'Difensori': [],
      'Centrocampisti': [],
      'Attaccanti': [],
      totale: 0
    }));

    const ruoliDaDistribuire = includiPortieri 
      ? ['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti']
      : ['Difensori', 'Centrocampisti', 'Attaccanti'];

    const totaleGiocatori = ruoliDaDistribuire.reduce(
      (sum, ruolo) => sum + ruoli[ruolo].length, 
      0
    );

    const basePerSquadra = Math.floor(totaleGiocatori / numSquadre);
    const squadreConExtra = totaleGiocatori % numSquadre;
    
    const targetPerSquadra = squadre.map((_, i) => 
      basePerSquadra + (i < squadreConExtra ? 1 : 0)
    );

    const distribuisciRuoloEquilibrato = (giocatori, nomeRuolo) => {
      if (giocatori.length === 0) return;
      
      const giocatoriMescolati = [...giocatori].sort(() => Math.random() - 0.5);
      
      giocatoriMescolati.forEach(giocatore => {
        const minRuolo = Math.min(...squadre.map(s => s[nomeRuolo].length));
        const squadreConMinRuolo = squadre
          .map((s, i) => ({ squadra: s, index: i }))
          .filter(({ squadra }) => squadra[nomeRuolo].length === minRuolo);
        
        let sceltaIndex = squadreConMinRuolo[0].index;
        let maxDistanza = targetPerSquadra[sceltaIndex] - squadre[sceltaIndex].totale;
        
        squadreConMinRuolo.forEach(({ index }) => {
          const distanza = targetPerSquadra[index] - squadre[index].totale;
          if (distanza > maxDistanza) {
            maxDistanza = distanza;
            sceltaIndex = index;
          }
        });
        
        squadre[sceltaIndex][nomeRuolo].push(giocatore);
        squadre[sceltaIndex].totale++;
      });
    };

    ruoliDaDistribuire.forEach(ruoloNome => {
      distribuisciRuoloEquilibrato(ruoli[ruoloNome], ruoloNome);
    });

    squadre.forEach(squadra => delete squadra.totale);

    return squadre;
  }, [numSquadre, includiPortieri, infortunati, giocatoriSelezionati, regenerateKey, players]);

  const conteggioSquadre = useMemo(() => {
    return dividiSquadre.map(squadra => {
      const totale = Object.values(squadra).reduce((sum, giocatori) => sum + giocatori.length, 0);
      return {
        portieri: squadra.Portieri.length,
        difensori: squadra.Difensori.length,
        centrocampisti: squadra.Centrocampisti.length,
        attaccanti: squadra.Attaccanti.length,
        totale
      };
    });
  }, [dividiSquadre]);

  const giocatoriDisponibili = useMemo(() => {
    const ruoli = organizzaGiocatori();
    const ruoliDaContare = includiPortieri 
      ? ['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti']
      : ['Difensori', 'Centrocampisti', 'Attaccanti'];
    
    return ruoliDaContare.reduce((sum, ruolo) => sum + ruoli[ruolo].length, 0);
  }, [includiPortieri, infortunati, giocatoriSelezionati, players]);

  const differenzaSquadre = useMemo(() => {
    if (conteggioSquadre.length === 0) return 0;
    const totali = conteggioSquadre.map(s => s.totale);
    return Math.max(...totali) - Math.min(...totali);
  }, [conteggioSquadre]);

  const rigeneraDivisione = () => {
    setShowDivisioneResults(true);
    setRegenerateKey(prev => prev + 1);
  };

  const downloadDivisionePDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('DIVISIONE SQUADRE EQUILIBRATE', 105, 20, { align: 'center' });
    doc.setFontSize(12);
    doc.text(appTitle, 105, 30, { align: 'center' });
    
    if (infortunati.size > 0) {
      doc.setFontSize(10);
      doc.setTextColor(150, 0, 0);
      doc.text(`Infortunati esclusi: ${infortunati.size}`, 105, 38, { align: 'center' });
      doc.setTextColor(0, 0, 0);
    }

    let yPosition = infortunati.size > 0 ? 48 : 45;

    dividiSquadre.forEach((squadra, index) => {
      if (index > 0 && yPosition > 200) {
        doc.addPage();
        yPosition = 20;
      }

      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      const totaleSquadra = conteggioSquadre[index].totale;
      doc.text(`SQUADRA ${teamColors[index].name} (${totaleSquadra} giocatori)`, 15, yPosition);
      yPosition += 6;
      
      doc.setFontSize(10);
      let dettagli = '';
      if (includiPortieri) dettagli += `P: ${conteggioSquadre[index].portieri} â€¢ `;
      dettagli += `D: ${conteggioSquadre[index].difensori} â€¢ `;
      dettagli += `C: ${conteggioSquadre[index].centrocampisti} â€¢ `;
      dettagli += `A: ${conteggioSquadre[index].attaccanti}`;
      doc.text(dettagli, 15, yPosition);
      yPosition += 8;

      const tableData = [];
      let numero = 1;

      ['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti'].forEach(ruolo => {
        squadra[ruolo].forEach(player => {
          tableData.push([
            numero++,
            player.nome,
            player.ruolo,
            player.dataNascita ? new Date(player.dataNascita).toLocaleDateString('it-IT') : 'N/A',
            player.piede || 'N/A'
          ]);
        });
      });

      doc.autoTable({
        startY: yPosition,
        head: [['N.', 'Nome', 'Ruolo', 'Data Nascita', 'Piede']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [100, 100, 100], fontSize: 9 },
        bodyStyles: { fontSize: 8 },
        columnStyles: {
          0: { cellWidth: 10 },
          1: { cellWidth: 50 },
          2: { cellWidth: 40 },
          3: { cellWidth: 30 },
          4: { cellWidth: 20 }
        },
        margin: { left: 15, right: 15 }
      });

      yPosition = doc.lastAutoTable.finalY + 15;
    });

    doc.save('divisione_squadre_equilibrate.pdf');
  };

  // ========== FUNZIONI PER CONVOCAZIONI ==========

  const toggleConvocato = (nome) => {
    const newConvocati = new Set(convocati);
    if (newConvocati.has(nome)) {
      newConvocati.delete(nome);
    } else {
      if (newConvocati.size >= 20) {
        alert('Puoi convocare massimo 20 giocatori!');
        return;
      }
      newConvocati.add(nome);
    }
    setConvocati(newConvocati);
  };

  const downloadConvocazioni = () => {
    if (convocati.size === 0) {
      alert('Seleziona almeno un giocatore da convocare!');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('CONVOCAZIONE', 105, 18, { align: 'center' });
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    doc.text(appTitle, 105, 26, { align: 'center' });

    let yPos = 36;

    if (infoPartita.squadra1 && infoPartita.squadra2) {
      doc.setFontSize(15);
      doc.setFont(undefined, 'bold');
      doc.text(`${infoPartita.squadra1} VS ${infoPartita.squadra2}`, 105, yPos, { align: 'center' });
      yPos += 9;
    }

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    if (infoPartita.dataPartita) {
      const dataFormatted = new Date(infoPartita.dataPartita + 'T00:00:00').toLocaleDateString('it-IT', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      doc.text(`Data: ${dataFormatted}`, 105, yPos, { align: 'center' });
      yPos += 6;
    }

    if (infoPartita.oraRitrovo) {
      doc.text(`Ora ritrovo: ${infoPartita.oraRitrovo}`, 105, yPos, { align: 'center' });
      yPos += 6;
    }

    if (infoPartita.indirizzoCompo) {
      doc.setFontSize(9);
      doc.text(`Campo: ${infoPartita.indirizzoCompo}`, 105, yPos, { align: 'center' });
      yPos += 6;
    }

    yPos += 4;

    const giocatoriConvocati = players
      .filter(p => p.nome && convocati.has(p.nome))
      .sort((a, b) => a.nome.localeCompare(b.nome));

    doc.setFontSize(13);
    doc.setFont(undefined, 'bold');
    doc.text(`GIOCATORI CONVOCATI (${giocatoriConvocati.length})`, 105, yPos, { align: 'center' });
    yPos += 7;

    const tableData = giocatoriConvocati.map((player, idx) => [
      idx + 1,
      player.nome
    ]);

    doc.autoTable({
      startY: yPos,
      head: [['N.', 'Cognome e Nome']],
      body: tableData,
      theme: 'striped',
      headStyles: { 
        fillColor: [41, 128, 185],
        fontSize: 10,
        fontStyle: 'bold',
        halign: 'center',
        cellPadding: 2
      },
      bodyStyles: { 
        fontSize: 9,
        cellPadding: 2
      },
      columnStyles: {
        0: { cellWidth: 18, halign: 'center' },
        1: { cellWidth: 150 }
      },
      margin: { left: 20, right: 20 },
      alternateRowStyles: { fillColor: [245, 245, 245] }
    });

    const nomeFile = infoPartita.dataPartita 
      ? `convocazione_${infoPartita.dataPartita}.pdf`
      : `convocazione_${new Date().toISOString().split('T')[0]}.pdf`;
    
    doc.save(nomeFile);
  };

  // ========== FUNZIONE STAMPA LISTA PRESENZE ==========
  
  const stampaListaPresenze = () => {
    if (players.length === 0) {
      alert('Nessun giocatore nella rosa!');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 10;

    // Aggiungo logo se presente (molto piccolo)
    if (teamLogo) {
      try {
        doc.addImage(teamLogo, 'PNG', 15, 8, 12, 12);
      } catch (e) {
        console.log('Errore caricamento logo:', e);
      }
    }

    // Titolo compatto in linea con il logo
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text(`${appTitle} - Lista Presenze`, teamLogo ? 30 : 15, 15);
    
    yPos = 23;

    // Data e note in una riga
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text('Data: ______________', 15, yPos);
    doc.text('Note: _________________________________________________', 70, yPos);
    
    yPos += 6;

    // Ordino giocatori alfabeticamente (escludo fuori rosa)
    const giocatoriOrdinati = [...players]
      .filter(p => p.nome && !p.fuoriRosa)
      .sort((a, b) => a.nome.localeCompare(b.nome));

    // Preparo dati per la tabella
    const tableData = giocatoriOrdinati.map((player, idx) => [
      idx + 1,
      player.nome,
      player.ruolo || '',
      '', // Colonna Presente
      ''  // Colonna Assente
    ]);

    doc.autoTable({
      startY: yPos,
      head: [['N.', 'Cognome e Nome', 'Ruolo', 'P', 'A']],
      body: tableData,
      theme: 'grid',
      headStyles: { 
        fillColor: [34, 139, 34],
        fontSize: 9,
        fontStyle: 'bold',
        halign: 'center',
        cellPadding: 2
      },
      bodyStyles: { 
        fontSize: 8,
        cellPadding: 1.5,
        minCellHeight: 7
      },
      columnStyles: {
        0: { cellWidth: 10, halign: 'center' },
        1: { cellWidth: 85 },
        2: { cellWidth: 45 },
        3: { cellWidth: 12, halign: 'center', fillColor: [240, 255, 240] },
        4: { cellWidth: 12, halign: 'center', fillColor: [255, 240, 240] }
      },
      margin: { left: 15, right: 15, bottom: 20 },
      didDrawCell: (data) => {
        // Aggiungo checkbox nelle colonne P e A
        if (data.column.index === 3 || data.column.index === 4) {
          if (data.row.index >= 0) {
            const size = 5;
            const x = data.cell.x + (data.cell.width - size) / 2;
            const y = data.cell.y + (data.cell.height - size) / 2;
            doc.setDrawColor(100);
            doc.rect(x, y, size, size);
          }
        }
      }
    });

    // Footer con legenda
    const finalY = doc.lastAutoTable.finalY;
    doc.setFontSize(7);
    doc.setFont(undefined, 'italic');
    doc.setTextColor(100, 100, 100);
    doc.text('P = Presente | A = Assente', 15, finalY + 5);
    doc.text(`Tot: ${giocatoriOrdinati.length}`, 105, finalY + 5, { align: 'center' });
    doc.text(`${new Date().toLocaleDateString('it-IT')}`, 195, finalY + 5, { align: 'right' });

    doc.save(`lista_presenze_${new Date().toISOString().split('T')[0]}.pdf`);
  };

  // ========== NUOVE FUNZIONI ESPORTAZIONE AVANZATE ==========
  
  // Export Report Stagionale Completo
  const downloadSeasonReportPDF = async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
    
    // ========== CALCOLI STATISTICHE COMPLETE ==========
    const totalMatches = matches.length;
    const totalTrainings = trainings.length;
    const activePlayers = players.filter(p => p.nome && !p.fuoriRosa).length;
    const totalPlayers = players.filter(p => p.nome).length;
    
    // Partite
    const victories = matches.filter(m => {
      const our = parseInt(m.golFatti ? Object.values(m.golFatti).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0) : 0);
      const their = Object.values(m.golSubiti || {}).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
      return our > their;
    }).length;
    
    const draws = matches.filter(m => {
      const our = parseInt(m.golFatti ? Object.values(m.golFatti).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0) : 0);
      const their = Object.values(m.golSubiti || {}).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
      return our === their;
    }).length;
    
    const defeats = totalMatches - victories - draws;
    
    // Gol totali
    let totalGoalsScored = 0;
    let totalGoalsConceded = 0;
    matches.forEach(m => {
      totalGoalsScored += parseInt(m.golFatti ? Object.values(m.golFatti).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0) : 0);
      totalGoalsConceded += Object.values(m.golSubiti || {}).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
    });
    
    // MVP
    const mvpCounts = {};
    matches.forEach(m => {
      if (m.mvp) {
        mvpCounts[m.mvp] = (mvpCounts[m.mvp] || 0) + 1;
      }
    });
    
    // ========== PAGINA 1: HEADER E STATISTICHE GENERALI ==========
    let yPos = 15;
    
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('REPORT STAGIONALE COMPLETO', 148.5, yPos, { align: 'center' });
    yPos += 10;
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(80, 80, 80);
    doc.text(appTitle, 148.5, yPos, { align: 'center' });
    yPos += 6;
    
    doc.setFontSize(10);
    doc.setTextColor(120, 120, 120);
    doc.text(`Generato il: ${new Date().toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })}`, 148.5, yPos, { align: 'center' });
    yPos += 15;
    
    // ========== BOX STATISTICHE GENERALI ==========
    doc.setFillColor(240, 248, 255);
    doc.rect(15, yPos - 5, 267, 35, 'F');
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('STATISTICHE GENERALI', 20, yPos);
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    
    // Riga 1
    doc.text(`Giocatori attivi: ${activePlayers}`, 20, yPos);
    doc.text(`Giocatori totali stagione: ${totalPlayers}`, 100, yPos);
    doc.text(`Allenamenti svolti: ${totalTrainings}`, 200, yPos);
    yPos += 6;
    
    // Riga 2
    doc.text(`Partite giocate: ${totalMatches}`, 20, yPos);
    doc.text(`Vittorie: ${victories}`, 100, yPos);
    doc.text(`Pareggi: ${draws}`, 150, yPos);
    doc.text(`Sconfitte: ${defeats}`, 200, yPos);
    yPos += 6;
    
    // Riga 3
    doc.text(`Gol fatti: ${totalGoalsScored}`, 20, yPos);
    doc.text(`Gol subiti: ${totalGoalsConceded}`, 100, yPos);
    doc.text(`Differenza reti: ${totalGoalsScored - totalGoalsConceded >= 0 ? '+' : ''}${totalGoalsScored - totalGoalsConceded}`, 200, yPos);
    yPos += 10;
    
    // ========== FUNZIONE HELPER PER GRAFICI ==========
    const addChartToPDF = async (chartConfig, x, y, width, height, isCircular = false) => {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        // Per grafici circolari usa canvas quadrato, altrimenti rettangolare
        if (isCircular) {
          canvas.width = 600;
          canvas.height = 600;
        } else {
          canvas.width = 800;
          canvas.height = 400;
        }
        const ctx = canvas.getContext('2d');
        
        new Chart(ctx, chartConfig);
        
        setTimeout(() => {
          const imgData = canvas.toDataURL('image/png');
          doc.addImage(imgData, 'PNG', x, y, width, height);
          canvas.remove();
          resolve();
        }, 500);
      });
    };
    
    // ========== GRAFICO 1: GOL CUMULATIVI ==========
    if (matches.length > 0) {
      const matchDates = matches.map(m => new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }));
      let totaleFatti = 0, totaleSubiti = 0;
      const golFattiCumulativi = [];
      const golSubitiCumulativi = [];
      
      matches.forEach(m => {
        const fatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        const subiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        totaleFatti += fatti;
        totaleSubiti += subiti;
        golFattiCumulativi.push(totaleFatti);
        golSubitiCumulativi.push(totaleSubiti);
      });
      
      await addChartToPDF({
        type: 'line',
        data: {
          labels: matchDates,
          datasets: [
            {
              label: 'Gol Fatti',
              data: golFattiCumulativi,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              fill: true,
              borderWidth: 2
            },
            {
              label: 'Gol Subiti',
              data: golSubitiCumulativi,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.4,
              fill: true,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: false,
          plugins: {
            title: { display: true, text: 'ANDAMENTO GOL STAGIONALE', font: { size: 16, weight: 'bold' } },
            legend: { position: 'top' }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Totale Gol' } }
          }
        }
      }, 15, yPos, 120, 60);
      
      // ========== GRAFICO 2: RISULTATI ==========
      await addChartToPDF({
        type: 'doughnut',
        data: {
          labels: ['Vittorie', 'Pareggi', 'Sconfitte'],
          datasets: [{
            data: [victories, draws, defeats],
            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: true,
          aspectRatio: 1,
          plugins: {
            title: { display: true, text: 'RISULTATI', font: { size: 16, weight: 'bold' } },
            legend: { position: 'bottom' }
          }
        }
      }, 145, yPos, 60, 60, true); // true = canvas quadrato per grafico circolare
      
      // ========== GRAFICO 3: PRESENZA MEDIA MENSILE (STAGIONE CALCISTICA) ==========
      if (trainings.length > 0) {
        // Raggruppa allenamenti per mese (stagione calcistica: Luglio-Giugno)
        const monthlyData = {};
        const mesiStagione = ['Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno'];
        
        trainings.forEach(t => {
          const date = new Date(t.data);
          const month = date.getMonth(); // 0-11 (0=Gennaio, 11=Dicembre)
          // Converti mese calendario in indice stagione calcistica
          const stagioneMeseIdx = (month + 6) % 12; // Luglio=0, Agosto=1, ..., Giugno=11
          const monthName = mesiStagione[stagioneMeseIdx];
          
          if (!monthlyData[monthName]) {
            monthlyData[monthName] = { totPresenze: 0, count: 0 };
          }
          
          const presenze = Object.entries(t.presenze || {}).filter(([numero, presente]) => {
            if (!presente) return false;
            const player = players.find(p => p.numero === parseInt(numero));
            if (!player || !player.nome || player.fuoriRosa) return false;
            if (player.dataCreazione && new Date(player.dataCreazione) > new Date(t.data)) return false;
            return true;
          }).length;
          
          monthlyData[monthName].totPresenze += presenze;
          monthlyData[monthName].count++;
        });
        
        // Prepara dati per grafico (solo mesi con allenamenti, in ordine stagione calcistica)
        const mesiConDati = [];
        const mediaPresenze = [];
        
        mesiStagione.forEach(mese => {
          if (monthlyData[mese] && monthlyData[mese].count > 0) {
            mesiConDati.push(mese);
            mediaPresenze.push(Math.round(monthlyData[mese].totPresenze / monthlyData[mese].count));
          }
        });
        
        await addChartToPDF({
          type: 'bar',
          data: {
            labels: mesiConDati,
            datasets: [{
              label: 'Presenza Media',
              data: mediaPresenze,
              backgroundColor: '#3b82f6',
              borderRadius: 4
            }]
          },
          options: {
            responsive: false,
            plugins: {
              title: { display: true, text: 'PRESENZA MEDIA MENSILE', font: { size: 16, weight: 'bold' } },
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true, ticks: { stepSize: 2 }, title: { display: true, text: 'Giocatori' } }
            }
          }
        }, 215, yPos, 65, 60);
      }
    }
    
    // ========== NUOVA PAGINA: TABELLA GIOCATORI ==========
    doc.addPage();
    yPos = 15;
    
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('STATISTICHE COMPLETE GIOCATORI', 148.5, yPos, { align: 'center' });
    yPos += 10;
    
    // ========== CALCOLO STATISTICHE GIOCATORI ==========
    const playerStats = players
      .filter(p => p.nome)
      .map(p => {
        const playerTrainings = trainings.filter(t => !p.dataCreazione || new Date(t.data) >= new Date(p.dataCreazione));
        const presenzeAllen = playerTrainings.filter(t => t.presenze && t.presenze[p.numero]).length;
        const totAllen = playerTrainings.filter(t => t.presenze && (t.presenze[p.numero] !== undefined)).length;
        const percPresenze = totAllen > 0 ? Math.round((presenzeAllen / totAllen) * 100) : 0;
        
        const infortuni = trainings.filter(t => t.infortuni && t.infortuni[p.numero]).length;
        
        const playerMatches = matches.filter(m => !p.dataCreazione || new Date(m.data) >= new Date(p.dataCreazione));
        const convocato = playerMatches.filter(m => m.convocati && m.convocati[p.numero]).length;
        const titolare = playerMatches.filter(m => m.titolari && m.titolari[p.numero]).length;
        const percConvocazioni = playerMatches.length > 0 ? Math.round((convocato / playerMatches.length) * 100) : 0;
        
        let gol = 0, assist = 0, golSubiti = 0, minuti = 0, gialliTot = 0, rossiTot = 0;
        
        playerMatches.forEach(m => {
          gol += parseInt(m.golFatti?.[p.numero] || 0);
          assist += parseInt(m.assist?.[p.numero] || 0);
          golSubiti += parseInt(m.golSubiti?.[p.numero] || 0);
          minuti += parseInt(m.minutiGiocati?.[p.numero] || 0);
          gialliTot += parseInt(m.gialliGioco?.[p.numero] || 0) + parseInt(m.gialliProtesta?.[p.numero] || 0);
          rossiTot += parseInt(m.rossiGioco?.[p.numero] || 0) + parseInt(m.rossiProtesta?.[p.numero] || 0);
        });
        
        const mvp = mvpCounts[p.numero] || 0;
        
        return {
          numero: p.numero,
          nome: p.nome,
          ruolo: p.ruolo || '-',
          presenzeAllen,
          percPresenze,
          infortuni,
          convocato,
          percConvocazioni,
          titolare,
          minuti,
          gol,
          assist,
          golSubiti,
          gialliTot,
          rossiTot,
          mvp
        };
      })
      .sort((a, b) => a.numero - b.numero);
    
    // ========== TABELLA GIOCATORI CON ABBREVIAZIONI LEGGIBILI ==========
    const tableData = playerStats.map(p => [
      p.numero,
      p.nome,
      p.ruolo,
      p.presenzeAllen,
      p.percPresenze + '%',
      p.infortuni > 0 ? p.infortuni : '-',
      p.convocato,
      p.percConvocazioni + '%',
      p.titolare,
      p.minuti,
      p.gol > 0 ? p.gol : '-',
      p.assist > 0 ? p.assist : '-',
      p.golSubiti > 0 ? p.golSubiti : '-',
      p.gialliTot > 0 ? p.gialliTot : '-',
      p.rossiTot > 0 ? p.rossiTot : '-',
      p.mvp > 0 ? p.mvp : '-'
    ]);
    
    doc.autoTable({
      startY: yPos,
      head: [['NÂ°', 'Nome', 'Ruolo', 'Pres', '%', 'Inf', 'Conv', '%', 'Tit', 'Min', 'Gol', 'Ass', 'Gol Sub', 'Gialli', 'Rossi', 'MVP']],
      body: tableData,
      theme: 'striped',
      headStyles: { 
        fillColor: [0, 51, 153],
        fontSize: 9,
        fontStyle: 'bold',
        halign: 'center',
        textColor: [255, 255, 255]
      },
      bodyStyles: { 
        fontSize: 8,
        cellPadding: 2
      },
      columnStyles: {
        0: { cellWidth: 12, halign: 'center' },
        1: { cellWidth: 40 },
        2: { cellWidth: 30 },
        3: { cellWidth: 12, halign: 'center' },
        4: { cellWidth: 12, halign: 'center' },
        5: { cellWidth: 12, halign: 'center' },
        6: { cellWidth: 12, halign: 'center' },
        7: { cellWidth: 12, halign: 'center' },
        8: { cellWidth: 12, halign: 'center' },
        9: { cellWidth: 15, halign: 'center' },
        10: { cellWidth: 12, halign: 'center' },
        11: { cellWidth: 12, halign: 'center' },
        12: { cellWidth: 18, halign: 'center' },
        13: { cellWidth: 15, halign: 'center' },
        14: { cellWidth: 15, halign: 'center' },
        15: { cellWidth: 12, halign: 'center' }
      },
      margin: { left: 15, right: 15 }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
    
    // ========== LEGENDA ==========
    doc.setFontSize(8);
    doc.setFont(undefined, 'italic');
    doc.setTextColor(100, 100, 100);
    doc.text('Legenda: NÂ° = Numero maglia, Pres = Presenze allenamenti, % = Percentuale, Inf = Infortuni, Conv = Convocazioni partite, Tit = Titolare, Min = Minuti giocati,', 15, yPos);
    yPos += 4;
    doc.text('Gol = Gol segnati, Ass = Assist, Gol Sub = Gol subiti (portieri), Gialli = Cartellini gialli, Rossi = Cartellini rossi, MVP = Migliore in campo', 15, yPos);
    yPos += 10;
    
    // ========== NUOVA PAGINA: ELENCO RISULTATI PARTITE ==========
    if (matches.length > 0) {
      doc.addPage();
      yPos = 15;
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(0, 51, 153);
      doc.text('ELENCO RISULTATI PARTITE', 148.5, yPos, { align: 'center' });
      yPos += 10;
      
      // Prepara dati partite
      const matchResults = matches.map(m => {
        const date = new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        // Determina avversario
        let opponent = '';
        if (m.squadraCasa && m.squadraTrasferta) {
          opponent = `${m.squadraCasa} vs ${m.squadraTrasferta}`;
        } else if (m.avversario) {
          opponent = m.avversario;
        } else if (m.squadraTrasferta) {
          opponent = m.squadraTrasferta;
        } else {
          opponent = 'N/D';
        }
        
        // Calcola gol
        const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        
        // Determina risultato
        let risultato = '';
        let esito = '';
        if (golFatti > golSubiti) {
          risultato = `${golFatti}-${golSubiti}`;
          esito = 'V';
        } else if (golFatti === golSubiti) {
          risultato = `${golFatti}-${golSubiti}`;
          esito = 'P';
        } else {
          risultato = `${golFatti}-${golSubiti}`;
          esito = 'S';
        }
        
        // MVP
        const mvpPlayer = m.mvp ? players.find(p => p.numero === m.mvp) : null;
        const mvpName = mvpPlayer?.nome || '-';
        
        return [date, opponent, risultato, esito, mvpName];
      });
      
      // Tabella risultati
      doc.autoTable({
        startY: yPos,
        head: [['Data', 'Avversario', 'Risultato', 'Esito', 'MVP']],
        body: matchResults,
        theme: 'striped',
        headStyles: {
          fillColor: [0, 51, 153],
          fontSize: 10,
          fontStyle: 'bold',
          halign: 'center',
          textColor: [255, 255, 255]
        },
        bodyStyles: {
          fontSize: 9,
          cellPadding: 3
        },
        columnStyles: {
          0: { cellWidth: 30, halign: 'center' },
          1: { cellWidth: 120 },
          2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' },
          3: { cellWidth: 20, halign: 'center', fontStyle: 'bold' },
          4: { cellWidth: 60 }
        },
        didParseCell: function(data) {
          // Colora esito
          if (data.column.index === 3 && data.section === 'body') {
            const esito = data.cell.text[0];
            if (esito === 'V') {
              data.cell.styles.textColor = [16, 185, 129]; // Verde
              data.cell.styles.fontStyle = 'bold';
            } else if (esito === 'S') {
              data.cell.styles.textColor = [239, 68, 68]; // Rosso
              data.cell.styles.fontStyle = 'bold';
            } else if (esito === 'P') {
              data.cell.styles.textColor = [245, 158, 11]; // Giallo/Arancione
              data.cell.styles.fontStyle = 'bold';
            }
          }
        },
        margin: { left: 15, right: 15 }
      });
      
      // Legenda esiti
      yPos = doc.lastAutoTable.finalY + 8;
      doc.setFontSize(8);
      doc.setFont(undefined, 'italic');
      doc.setTextColor(100, 100, 100);
      doc.text('Legenda Esiti: V = Vittoria, P = Pareggio, S = Sconfitta', 15, yPos);
    }
    
    // ========== NUOVA PAGINA: GIOCATORI TOP (TOP 5 PER CATEGORIA) ==========
    doc.addPage();
    yPos = 15;
    
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('GIOCATORI TOP - CLASSIFICHE', 105, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(80, 80, 80);
    doc.text('I migliori 5 giocatori per ogni categoria', 105, yPos, { align: 'center' });
    yPos += 12;
    
    // ========== HELPER FUNZIONE PER MEDAGLIE ==========
    const getMedal = (position) => {
      const medals = ['(1Â°)', '(2Â°)', '(3Â°)', '(4Â°)', '(5Â°)'];
      return medals[position] || `(${position + 1}Â°)`;
    };
    
    // ========== INIZIALIZZA POSIZIONI COLONNE ==========
    let leftYPos = yPos;
    let rightYPos = yPos;
    
    // ========== COLONNA SINISTRA: TOP 5 PRESENZE ALLENAMENTI ==========
    const topPresenze = playerStats
      .sort((a, b) => b.presenzeAllen - a.presenzeAllen)
      .slice(0, 5);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 102, 204);
    doc.text('TOP 5 PRESENZE ALLENAMENTI', 15, leftYPos);
    leftYPos += 7;
    
    topPresenze.forEach((p, i) => {
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(0, 0, 0);
      doc.text(`${getMedal(i)} ${p.nome} - ${p.presenzeAllen} presenze (${p.percPresenze}%)`, 20, leftYPos);
      leftYPos += 6;
    });
    leftYPos += 8;
    
    // ========== COLONNA DESTRA: TOP 5 GOL ==========
    const topGol = playerStats
      .filter(p => p.gol > 0)
      .sort((a, b) => b.gol - a.gol)
      .slice(0, 5);
    
    if (topGol.length > 0) {
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(16, 185, 129);
      doc.text('TOP 5 GOL', 115, rightYPos);
      rightYPos += 7;
      
      topGol.forEach((p, i) => {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text(`${getMedal(i)} ${p.nome} - ${p.gol} gol`, 120, rightYPos);
        rightYPos += 6;
      });
      rightYPos += 8;
    }
    
    // ========== COLONNA SINISTRA: TOP 5 ASSIST ==========
    const topAssist = playerStats
      .filter(p => p.assist > 0)
      .sort((a, b) => b.assist - a.assist)
      .slice(0, 5);
    
    if (topAssist.length > 0) {
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(147, 51, 234);
      doc.text('TOP 5 ASSIST', 15, leftYPos);
      leftYPos += 7;
      
      topAssist.forEach((p, i) => {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text(`${getMedal(i)} ${p.nome} - ${p.assist} assist`, 20, leftYPos);
        leftYPos += 6;
      });
      leftYPos += 8;
    }
    
    // ========== COLONNA DESTRA: TOP 5 MVP ==========
    const topMVP = playerStats
      .filter(p => p.mvp > 0)
      .sort((a, b) => b.mvp - a.mvp)
      .slice(0, 5);
    
    if (topMVP.length > 0) {
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(245, 158, 11);
      doc.text('TOP 5 MVP', 115, rightYPos);
      rightYPos += 7;
      
      topMVP.forEach((p, i) => {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text(`${getMedal(i)} ${p.nome} - ${p.mvp} MVP`, 120, rightYPos);
        rightYPos += 6;
      });
      rightYPos += 8;
    }
    
    // ========== COLONNA SINISTRA: TOP 5 MINUTI GIOCATI ==========
    const topMinuti = playerStats
      .filter(p => p.minuti > 0)
      .sort((a, b) => b.minuti - a.minuti)
      .slice(0, 5);
    
    if (topMinuti.length > 0) {
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(99, 102, 241);
      doc.text('TOP 5 MINUTI GIOCATI', 15, leftYPos);
      leftYPos += 7;
      
      topMinuti.forEach((p, i) => {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text(`${getMedal(i)} ${p.nome} - ${p.minuti} minuti`, 20, leftYPos);
        leftYPos += 6;
      });
      leftYPos += 8;
    }
    
    // ========== COLONNA DESTRA: TOP 5 CARTELLINI GIALLI ==========
    const topGialli = playerStats
      .filter(p => p.gialliTot > 0)
      .sort((a, b) => b.gialliTot - a.gialliTot)
      .slice(0, 5);
    
    if (topGialli.length > 0) {
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(234, 179, 8);
      doc.text('TOP 5 CARTELLINI GIALLI', 115, rightYPos);
      rightYPos += 7;
      
      topGialli.forEach((p, i) => {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text(`${getMedal(i)} ${p.nome} - ${p.gialliTot} gialli`, 120, rightYPos);
        rightYPos += 6;
      });
      rightYPos += 8;
    }
    
    // ========== COLONNA SINISTRA: TOP 5 CARTELLINI ROSSI ==========
    const topRossi = playerStats
      .filter(p => p.rossiTot > 0)
      .sort((a, b) => b.rossiTot - a.rossiTot)
      .slice(0, 5);
    
    if (topRossi.length > 0) {
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(239, 68, 68);
      doc.text('TOP 5 CARTELLINI ROSSI', 15, leftYPos);
      leftYPos += 7;
      
      topRossi.forEach((p, i) => {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(0, 0, 0);
        doc.text(`${getMedal(i)} ${p.nome} - ${p.rossiTot} rossi`, 20, leftYPos);
        leftYPos += 6;
      });
    }
    
    // ========== FOOTER SU TUTTE LE PAGINE ==========
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.setFont(undefined, 'italic');
      doc.text(`${appTitle} - Report Stagionale - Pagina ${i} di ${pageCount}`, 148.5, 205, { align: 'center' });
    }
    
    // ========== SALVA E MOSTRA MESSAGGIO ==========
    const fileName = `report_stagionale_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    showToast('âœ… Report stagionale scaricato con successo!', 'success', 4000);
  };
    
  // Export Scheda Singolo Giocatore - REPORT COMPLETO
  const downloadPlayerCardPDF = (playerNum) => {
    const player = players.find(p => p.numero === playerNum);
    if (!player || !player.nome) {
      alert('Giocatore non valido!');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 15;
    
    // ========== HEADER CON FOTO ==========
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('REPORT GIOCATORE', 105, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(100, 100, 100);
    doc.text(appTitle, 105, yPos, { align: 'center' });
    yPos += 10;
    
    // Box header con foto
    doc.setDrawColor(0, 51, 153);
    doc.setLineWidth(0.5);
    doc.rect(15, yPos, 180, 45);
    
    // Foto se presente - MANTIENE PROPORZIONI ORIGINALI
    if (player.foto) {
      try {
        // Crea immagine temporanea per ottenere dimensioni originali
        const img = new Image();
        img.src = player.foto;
        
        // Calcola proporzioni mantenendo aspect ratio
        const maxWidth = 35;
        const maxHeight = 35;
        let finalWidth = maxWidth;
        let finalHeight = maxHeight;
        
        if (img.width && img.height) {
          const aspectRatio = img.width / img.height;
          
          if (aspectRatio > 1) {
            // Immagine orizzontale (piÃ¹ larga che alta)
            finalHeight = maxWidth / aspectRatio;
            finalWidth = maxWidth;
          } else {
            // Immagine verticale (piÃ¹ alta che larga)
            finalWidth = maxHeight * aspectRatio;
            finalHeight = maxHeight;
          }
        }
        
        // Centra l'immagine nel box 35x35
        const offsetX = (maxWidth - finalWidth) / 2;
        const offsetY = (maxHeight - finalHeight) / 2;
        
        doc.addImage(player.foto, 'JPEG', 20 + offsetX, yPos + 5 + offsetY, finalWidth, finalHeight);
      } catch (e) {
        console.log('Errore caricamento foto');
      }
    } else {
      doc.setFillColor(240, 240, 240);
      doc.rect(20, yPos + 5, 35, 35, 'F');
      doc.setFontSize(24);
      doc.setTextColor(150, 150, 150);
      doc.text(`#${player.numero}`, 37.5, yPos + 27, { align: 'center' });
    }
    
    // Dati anagrafici a destra della foto
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text(player.nome, 60, yPos + 12);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Ruolo: ${player.ruolo || 'N/A'}`, 60, yPos + 20);
    doc.text(`Numero Maglia: ${getNumeroAlfabetico(player.nome)}`, 60, yPos + 26);
    
    if (player.dataNascita) {
      const age = calculateAge(player.dataNascita);
      doc.text(`Eta: ${age} anni (${player.dataNascita})`, 60, yPos + 32);
    }
    if (player.piede) {
      doc.text(`Piede: ${player.piede}`, 60, yPos + 38);
    }
    
    yPos += 50;
    
    // ========== STATISTICHE ALLENAMENTI ==========
    const playerTrainings = trainings.filter(t => {
      if (!player.dataCreazione) return true;
      return new Date(t.data) >= new Date(player.dataCreazione);
    });
    
    const presenzeCount = playerTrainings.filter(t => t.presenze && t.presenze[player.numero]).length;
    const assenzeCount = playerTrainings.filter(t => t.presenze && !t.presenze[player.numero]).length;
    const totAllenamenti = presenzeCount + assenzeCount;
    const percPresenze = totAllenamenti > 0 ? ((presenzeCount / totAllenamenti) * 100).toFixed(1) : 0;
    
    const infortuniCount = trainings.filter(t => t.infortuni && t.infortuni[player.numero]).length;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('STATISTICHE ALLENAMENTI', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`Presenze: ${presenzeCount}/${totAllenamenti}`, 20, yPos);
    doc.text(`% Presenze: ${percPresenze}%`, 110, yPos);
    yPos += 6;
    doc.text(`Assenze: ${assenzeCount}`, 20, yPos);
    doc.text(`Infortuni: ${infortuniCount}`, 110, yPos);
    yPos += 10;
    
    // ========== STATISTICHE PARTITE ==========
    const playerMatches = matches.filter(m => {
      if (!player.dataCreazione) return true;
      return new Date(m.data) >= new Date(player.dataCreazione);
    });
    
    const convocato = playerMatches.filter(m => m.convocati && m.convocati[player.numero]).length;
    const titolare = playerMatches.filter(m => m.titolari && m.titolari[player.numero]).length;
    const percConvocazioni = playerMatches.length > 0 ? ((convocato / playerMatches.length) * 100).toFixed(1) : 0;
    const percTitolarita = playerMatches.length > 0 ? ((titolare / playerMatches.length) * 100).toFixed(1) : 0;
    
    let totalGoals = 0;
    let totalAssists = 0;
    let totalGolSubiti = 0;
    let gialliGioco = 0;
    let gialliProtesta = 0;
    let rossiGioco = 0;
    let rossiProtesta = 0;
    let totalMinutes = 0;
    
    playerMatches.forEach(match => {
      totalGoals += parseInt(match.golFatti?.[player.numero] || 0);
      totalAssists += parseInt(match.assist?.[player.numero] || 0);
      totalGolSubiti += parseInt(match.golSubiti?.[player.numero] || 0);
      gialliGioco += parseInt(match.gialliGioco?.[player.numero] || 0);
      gialliProtesta += parseInt(match.gialliProtesta?.[player.numero] || 0);
      rossiGioco += parseInt(match.rossiGioco?.[player.numero] || 0);
      rossiProtesta += parseInt(match.rossiProtesta?.[player.numero] || 0);
      totalMinutes += parseInt(match.minutiGiocati?.[player.numero] || 0);
    });
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('STATISTICHE PARTITE', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`Convocato: ${convocato}/${playerMatches.length}`, 20, yPos);
    doc.text(`% Convocazioni: ${percConvocazioni}%`, 110, yPos);
    yPos += 6;
    doc.text(`Titolare: ${titolare}/${playerMatches.length}`, 20, yPos);
    doc.text(`% Titolarita: ${percTitolarita}%`, 110, yPos);
    yPos += 6;
    doc.text(`Minuti giocati: ${totalMinutes}'`, 20, yPos);
    yPos += 10;
    
    // ========== STATISTICHE GIOCO ==========
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('STATISTICHE GIOCO', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`Gol: ${totalGoals}`, 20, yPos);
    doc.text(`Assist: ${totalAssists}`, 110, yPos);
    yPos += 6;
    if (totalGolSubiti > 0) {
      doc.text(`Gol Subiti: ${totalGolSubiti}`, 20, yPos);
      yPos += 6;
    }
    
    // Cartellini
    if (gialliGioco + gialliProtesta + rossiGioco + rossiProtesta > 0) {
      doc.text(`Giallo Gioco: ${gialliGioco}`, 20, yPos);
      doc.text(`Giallo Protesta: ${gialliProtesta}`, 110, yPos);
      yPos += 6;
      doc.text(`Rosso Gioco: ${rossiGioco}`, 20, yPos);
      doc.text(`Rosso Protesta: ${rossiProtesta}`, 110, yPos);
      yPos += 6;
    }
    yPos += 5;
    
    // ========== LISTA PARTITE DETTAGLIATA ==========
    if (yPos > 200) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('PARTITE GIOCATE', 15, yPos);
    yPos += 7;
    
    // Mostra TUTTE le partite, non solo quelle dove Ã¨ stato convocato
    const allMatches = playerMatches.sort((a, b) => new Date(b.data) - new Date(a.data));
    
    if (allMatches.length > 0) {
      const tableData = allMatches.slice(0, 20).map(m => {
        const data = new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const isConvocato = (m.convocati && m.convocati[player.numero]) || 
                           (m.titolari && m.titolari[player.numero]) ||
                           (m.minutiGiocati && m.minutiGiocati[player.numero] > 0);
        const isTitolare = m.titolari && m.titolari[player.numero];
        const minuti = m.minutiGiocati?.[player.numero] || 0;
        const gol = m.golFatti?.[player.numero] || 0;
        const assist = m.assist?.[player.numero] || 0;
        const risultato = m.risultato || '-';
        
        // Fix avversario: usa squadraCasa/squadraTrasferta se disponibili
        let avversario = 'N/A';
        if (m.squadraCasa && m.squadraTrasferta) {
          avversario = `${m.squadraCasa} vs ${m.squadraTrasferta}`;
        } else if (m.avversario) {
          avversario = m.avversario;
        } else if (m.squadraTrasferta) {
          avversario = m.squadraTrasferta;
        }
        
        // Cartellini
        const gialli = (m.gialliGioco?.[player.numero] || 0) + (m.gialliProtesta?.[player.numero] || 0);
        const rossi = (m.rossiGioco?.[player.numero] || 0) + (m.rossiProtesta?.[player.numero] || 0);
        
        return {
          data: [
            data,
            avversario,
            risultato,
            isConvocato ? (isTitolare ? 'Si' : 'No') : 'Non convocato',
            isConvocato ? (minuti + "'") : '-',
            isConvocato && gol > 0 ? gol : '-',
            isConvocato && assist > 0 ? assist : '-',
            isConvocato && gialli > 0 ? gialli : '-',
            isConvocato && rossi > 0 ? rossi : '-'
          ],
          isConvocato: isConvocato
        };
      });
      
      doc.autoTable({
        startY: yPos,
        head: [['Data', 'Avversario', 'Ris.', 'Tit.', 'Min', 'Gol', 'Assist', 'Gialli', 'Rossi']],
        body: tableData.map(item => item.data),
        theme: 'grid',
        headStyles: { 
          fillColor: [0, 51, 153],
          fontSize: 8,
          fontStyle: 'bold',
          halign: 'center'
        },
        bodyStyles: { 
          fontSize: 7,
          cellPadding: 1.5
        },
        columnStyles: {
          0: { cellWidth: 22 },
          1: { cellWidth: 42 },
          2: { cellWidth: 16, halign: 'center' },
          3: { cellWidth: 12, halign: 'center' },
          4: { cellWidth: 15, halign: 'center' },
          5: { cellWidth: 12, halign: 'center' },
          6: { cellWidth: 14, halign: 'center' },
          7: { cellWidth: 14, halign: 'center' },
          8: { cellWidth: 13, halign: 'center' }
        },
        didParseCell: function(data) {
          // Applica colore grigio alle righe dove NON Ã¨ stato convocato
          if (data.section === 'body') {
            const rowIndex = data.row.index;
            if (rowIndex < tableData.length && !tableData[rowIndex].isConvocato) {
              data.cell.styles.textColor = [180, 180, 180]; // Grigio chiaro
              data.cell.styles.fillColor = [245, 245, 245]; // Sfondo grigio molto chiaro
            }
          }
        },
        margin: { left: 15, right: 15 }
      });
      
      yPos = doc.lastAutoTable.finalY + 10;
      
      if (allMatches.length > 20) {
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`(Mostrate le ultime 20 partite su ${allMatches.length} totali)`, 15, yPos);
        yPos += 5;
      }
    } else {
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100);
      doc.setFont(undefined, 'italic');
      doc.text('Nessuna partita giocata', 20, yPos);
      yPos += 10;
    }
    
    // ========== MVP ==========
    const mvpCount = matches.filter(m => m.mvp === player.numero).length;
    if (mvpCount > 0) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(218, 165, 32);
      doc.text(`MVP: ${mvpCount} ${mvpCount === 1 ? 'volta' : 'volte'}`, 15, yPos);
      yPos += 8;
    }
    
    // ========== INFORTUNI ==========
    if (infortuniCount > 0) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(200, 0, 0);
      doc.text(`Infortuni: ${infortuniCount}`, 15, yPos);
      yPos += 8;
    }
    
    // ========== FOOTER ==========
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.setFont(undefined, 'italic');
    doc.text(`Report generato il ${new Date().toLocaleDateString('it-IT')} - ${appTitle}`, 105, 285, { align: 'center' });
    
    const fileName = `report_${player.nome.replace(/\s+/g, '_').toLowerCase()}.pdf`;
    doc.save(fileName);
    showToast(`Report PDF di ${player.nome} scaricato!`, 'success');
  };
  
  // Download Backup JSON - VERSIONE COMPLETA CON TUTTI I DATI
  const downloadBackupJSON = () => {
    const now = new Date().toISOString();
    
    // âœ… BACKUP COMPLETO - Include TUTTO
    const backupData = {
      version: '3.0', // â¬†ï¸ Versione aggiornata per backup completo
      exportDate: now,
      appTitle,
      teamName,
      teamLogo,
      players,
      trainings,
      matches,
      injuries, // âœ… AGGIUNTO: infortuni
      infoPartita,
      moduloTattico,
      formationPositions, // âœ… AGGIUNTO: posizioni formazioni salvate
      // Statistiche aggiuntive per verifica integritÃ 
      stats: {
        totalPlayers: players.filter(p => p.nome).length,
        totalTrainings: trainings.length,
        totalMatches: matches.length,
        totalInjuries: injuries.length
      }
    };
    
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `backup_gestionale_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    // âœ… Salva data ultimo backup
    setLastBackupDate(now);
    localStorage.setItem('lastBackupDate', now);
    
    showToast(`âœ… Backup completo scaricato! Include ${backupData.stats.totalPlayers} giocatori, ${backupData.stats.totalTrainings} allenamenti, ${backupData.stats.totalMatches} partite`, 'success');
  };

  // ========== NUOVE FUNZIONI SISTEMA BACKUP OTTIMIZZATO ==========

  // Rileva tipo di dispositivo
  const getDeviceType = () => {
    const ua = navigator.userAgent;
    const screenWidth = window.innerWidth;
    
    const isMobile = /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
    const isTablet = /iPad|Android/i.test(ua) && screenWidth >= 768;
    
    if (isMobile && screenWidth < 768) {
      return 'mobile';
    } else if (isTablet || (screenWidth >= 768 && screenWidth < 1024)) {
      return 'tablet';
    } else {
      return 'desktop';
    }
  };

  // Converti blob in base64
  const blobToBase64 = (blob) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  };

  // Converti base64 in blob
  const base64ToBlob = (base64) => {
    const parts = base64.split(';base64,');
    const contentType = parts[0].split(':')[1];
    const raw = window.atob(parts[1]);
    const rawLength = raw.length;
    const uInt8Array = new Uint8Array(rawLength);
    
    for (let i = 0; i < rawLength; ++i) {
      uInt8Array[i] = raw.charCodeAt(i);
    }
    
    return new Blob([uInt8Array], { type: contentType });
  };

  // Backup automatico giornaliero (solo JSON con URL)
  const createDailyBackup = async () => {
    if (!user || !teamId) {
      console.log('âš ï¸ Backup saltato: utente non autenticato');
      return;
    }

    console.log('ðŸ”„ Backup automatico giornaliero iniziato...');
    
    try {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0]; // 2026-01-28
      const timeStr = now.toISOString().split('T')[1].split('.')[0].replace(/:/g, '-'); // 15-30-45
      const fullTimestamp = `${dateStr}_${timeStr}`; // 2026-01-28_15-30-45
      
      const backupData = {
        version: '3.1',
        exportDate: now.toISOString(),
        appTitle,
        teamName,
        teamLogo, // Solo URL/path Storage
        players: players.map(p => ({
          ...p,
          foto: p.foto // Solo URL/path Storage
        })),
        trainings: trainings.map(t => ({
          ...t,
          foto: t.foto ? t.foto.map(f => ({
            ...f,
            url: f.url // Solo URL Storage
          })) : []
        })),
        matches: matches.map(m => ({
          ...m,
          foto: m.foto ? m.foto.map(f => ({
            ...f,
            url: f.url // Solo URL Storage
          })) : []
        })),
        injuries,
        squadreGirone,
        risultatiCampionato,
        infoPartita,
        moduloTattico,
        formationPositions,
        stats: {
          totalPlayers: players.filter(p => p.nome).length,
          totalTrainings: trainings.length,
          totalMatches: matches.length,
          totalInjuries: injuries.length
        }
      };
      
      const jsonString = JSON.stringify(backupData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const filename = `backups/firestore/daily/${fullTimestamp}.json`;
      
      // Upload su Firebase Storage
      const storageRef = storage.ref(filename);
      await storageRef.put(blob);
      
      console.log('âœ… Backup giornaliero creato:', filename);
      
      // Pulisci backup vecchi (mantieni ultimi 7 giorni)
      await cleanOldBackups();
      
      // Aggiorna data ultimo backup
      setLastBackupDate(now.toISOString());
      localStorage.setItem('lastBackupDate', now.toISOString());
      
      return true;
    } catch (error) {
      console.error('âŒ Errore backup giornaliero:', error);
      return false;
    }
  };

  // Pulisci backup piÃ¹ vecchi di 7 giorni
  const cleanOldBackups = async () => {
    try {
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      
      const backupsRef = storage.ref('backups/firestore/daily');
      const backupsList = await backupsRef.listAll();
      
      for (const backup of backupsList.items) {
        // Nome file: 2026-01-28_15-30-45.json
        const filename = backup.name.replace('.json', '');
        const datePart = filename.split('_')[0]; // 2026-01-28
        const backupDate = new Date(datePart);
        
        if (backupDate < sevenDaysAgo) {
          await backup.delete();
          console.log('ðŸ—‘ï¸ Backup vecchio eliminato:', backup.name);
        }
      }
    } catch (error) {
      console.error('âš ï¸ Errore pulizia backup vecchi:', error);
    }
  };

  // Carica lista backup disponibili
  const loadAvailableBackups = async () => {
    if (!user) return;
    
    setLoadingBackups(true);
    try {
      const backupsRef = storage.ref('backups/firestore/daily');
      const backupsList = await backupsRef.listAll();
      
      const backups = await Promise.all(
        backupsList.items.map(async (item) => {
          const metadata = await item.getMetadata();
          const url = await item.getDownloadURL();
          
          // Nome file: 2026-01-28_15-30-45.json
          const filename = item.name.replace('.json', '');
          const parts = filename.split('_');
          const dateStr = parts[0]; // 2026-01-28
          const timeStr = parts[1] ? parts[1].replace(/-/g, ':') : '00:00:00'; // 15:30:45
          
          return {
            name: item.name,
            date: dateStr,
            time: timeStr,
            fullTimestamp: `${dateStr} ${timeStr}`,
            size: metadata.size,
            url: url,
            created: metadata.timeCreated
          };
        })
      );
      
      // Ordina per data+ora (piÃ¹ recente prima)
      backups.sort((a, b) => new Date(b.fullTimestamp) - new Date(a.fullTimestamp));
      
      setAvailableBackups(backups);
      console.log('ðŸ“‹ Backup disponibili caricati:', backups.length);
    } catch (error) {
      console.error('âŒ Errore caricamento backup:', error);
      setAvailableBackups([]);
    } finally {
      setLoadingBackups(false);
    }
  };

  // Scarica singolo backup
  const downloadBackup = async (backupUrl, backupName) => {
    try {
      showLoadingWithProgress('ðŸ“¥ Download backup...', 0);
      
      const response = await fetch(backupUrl);
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = backupName;
      link.click();
      URL.revokeObjectURL(url);
      
      hideLoading();
      showToast('âœ… Backup scaricato!', 'success');
    } catch (error) {
      hideLoading();
      console.error('âŒ Errore download backup:', error);
      showToast('âŒ Errore download backup', 'error');
    }
  };

  // Ripristina da backup giornaliero
  const restoreDailyBackup = async (backupUrl, backupName) => {
    if (window.confirm(
      `âš ï¸ ATTENZIONE!\n\n` +
      `Vuoi ripristinare il backup del ${backupName.replace('.json', '')}?\n\n` +
      `Tutti i dati correnti verranno sostituiti con quelli del backup.\n\n` +
      `Questa azione NON puÃ² essere annullata!`
    )) {
      try {
        showLoadingWithProgress('ðŸ”„ Ripristino backup in corso...', 0);
        
        // Scarica backup
        const response = await fetch(backupUrl);
        const backup = await response.json();
        
        // Ripristina dati nell'app
        setPlayers(backup.players || []);
        setMatches(backup.matches || []);
        setTrainings(backup.trainings || []);
        setInjuries(backup.injuries || []);
        setSquadreGirone(backup.squadreGirone || []);
        setRisultatiCampionato(backup.risultatiCampionato || []);
        setTeamName(backup.teamName || '');
        setTeamLogo(backup.teamLogo || '');
        setAppTitle(backup.appTitle || 'Gestionale Calcio');
        setInfoPartita(backup.infoPartita || {});
        setModuloTattico(backup.moduloTattico || {});
        setFormationPositions(backup.formationPositions || {});
        
        // Salva su Firestore
        if (teamId) {
          await db.collection('teamData').doc(teamId).set({
            players: backup.players || [],
            matches: backup.matches || [],
            trainings: backup.trainings || [],
            injuries: backup.injuries || [],
            squadreGirone: backup.squadreGirone || [],
            risultatiCampionato: backup.risultatiCampionato || [],
            teamName: backup.teamName || '',
            teamLogo: backup.teamLogo || '',
            appTitle: backup.appTitle || 'Gestionale Calcio',
            infoPartita: backup.infoPartita || {},
            moduloTattico: backup.moduloTattico || {},
            formationPositions: backup.formationPositions || {},
            lastModified: new Date().toISOString()
          });
        }
        
        // Salva su IndexedDB
        await saveDataToIndexedDB();
        
        hideLoading();
        showToast(
          `âœ… Backup ripristinato!\n` +
          `ðŸ“¸ ${backup.stats?.totalPlayers || 0} giocatori\n` +
          `âš½ ${backup.stats?.totalMatches || 0} partite\n` +
          `ðŸƒ ${backup.stats?.totalTrainings || 0} allenamenti`,
          'success',
          5000
        );
        
        // Ricarica pagina per refreshare tutto
        setTimeout(() => {
          window.location.reload();
        }, 2000);
        
      } catch (error) {
        hideLoading();
        console.error('âŒ Errore ripristino backup:', error);
        showToast('âŒ Errore ripristino backup: ' + error.message, 'error');
      }
    }
  };

  // Download backup completo (usa funzione esistente)
  const downloadFullBackupWithPhotos = () => {
    // Il "backup completo" Ã¨ semplicemente il JSON con tutti i dati e URL foto
    // Le foto restano sempre su Firebase Storage (giÃ  protette)
    downloadBackupJSON();
    
    // Salva data ultimo backup completo
    setLastFullBackupDate(new Date().toISOString());
    localStorage.setItem('lastFullBackupDate', new Date().toISOString());
  };

  // Calcola statistiche storage (dimensione JSON backup, NON foto)
  const calculateStorageStats = () => {
    // Il backup completo Ã¨ un JSON con URL foto (non foto embedded)
    // Quindi la dimensione Ã¨ quella del JSON, non delle foto!
    
    const backupData = {
      version: '3.0',
      exportDate: new Date().toISOString(),
      appTitle,
      teamName,
      teamLogo,
      players,
      trainings,
      matches,
      injuries,
      infoPartita,
      moduloTattico,
      formationPositions,
      squadreGirone,
      risultatiCampionato,
      stats: {
        totalPlayers: players.filter(p => p.nome).length,
        totalTrainings: trainings.length,
        totalMatches: matches.length,
        totalInjuries: injuries.length
      }
    };
    
    const jsonString = JSON.stringify(backupData, null, 2);
    const jsonSize = jsonString.length; // Dimensione JSON in bytes
    
    return {
      used: jsonSize,
      total: 1024 * 1024 * 1024, // 1 GB free tier (per riferimento)
      percentage: Math.round((jsonSize / (1024 * 1024 * 1024)) * 100),
      jsonSizeMB: Math.round(jsonSize / 1024 / 1024 * 10) / 10 // MB con 1 decimale
    };
  };

  // Calcola dimensioni REALI foto su Firebase Storage
  const calculateRealStorageSize = async () => {
    if (!user) return null;
    
    try {
      console.log('ðŸ“Š Calcolo dimensioni reali Storage...');
      
      let totalSize = 0;
      const breakdown = {
        logo: 0,
        playerPhotos: 0,
        matchPhotos: 0,
        trainingPhotos: 0
      };
      
      // 1. Logo squadra
      if (teamLogo && teamLogo.startsWith('http')) {
        try {
          const logoRef = storage.refFromURL(teamLogo);
          const logoMetadata = await logoRef.getMetadata();
          breakdown.logo = logoMetadata.size;
          totalSize += logoMetadata.size;
        } catch (error) {
          console.warn('Logo metadata non disponibile:', error);
        }
      }
      
      // 2. Foto giocatori
      const playerPhotosRef = storage.ref(`player-photos/${user.uid}`);
      try {
        const playerPhotosList = await playerPhotosRef.listAll();
        for (const item of playerPhotosList.items) {
          try {
            const metadata = await item.getMetadata();
            breakdown.playerPhotos += metadata.size;
            totalSize += metadata.size;
          } catch (error) {
            console.warn('Metadata foto giocatore non disponibile:', error);
          }
        }
      } catch (error) {
        console.warn('Cartella player-photos non disponibile:', error);
      }
      
      // 3. Foto partite
      const matchPhotosRef = storage.ref(`match-photos/${user.uid}`);
      try {
        const matchPhotosList = await matchPhotosRef.listAll();
        for (const item of matchPhotosList.items) {
          try {
            const metadata = await item.getMetadata();
            breakdown.matchPhotos += metadata.size;
            totalSize += metadata.size;
          } catch (error) {
            console.warn('Metadata foto partita non disponibile:', error);
          }
        }
      } catch (error) {
        console.warn('Cartella match-photos non disponibile:', error);
      }
      
      // 4. Foto allenamenti
      const trainingPhotosRef = storage.ref(`training-photos/${user.uid}`);
      try {
        const trainingPhotosList = await trainingPhotosRef.listAll();
        for (const item of trainingPhotosList.items) {
          try {
            const metadata = await item.getMetadata();
            breakdown.trainingPhotos += metadata.size;
            totalSize += metadata.size;
          } catch (error) {
            console.warn('Metadata foto allenamento non disponibile:', error);
          }
        }
      } catch (error) {
        console.warn('Cartella training-photos non disponibile:', error);
      }
      
      console.log('âœ… Dimensioni reali calcolate:', {
        total: Math.round(totalSize / 1024 / 1024) + ' MB',
        breakdown: {
          logo: Math.round(breakdown.logo / 1024) + ' KB',
          playerPhotos: Math.round(breakdown.playerPhotos / 1024 / 1024) + ' MB',
          matchPhotos: Math.round(breakdown.matchPhotos / 1024 / 1024) + ' MB',
          trainingPhotos: Math.round(breakdown.trainingPhotos / 1024 / 1024) + ' MB'
        }
      });
      
      return {
        total: totalSize,
        breakdown: breakdown
      };
      
    } catch (error) {
      console.error('âŒ Errore calcolo dimensioni Storage:', error);
      return null;
    }
  };

  // Inizializza sistema backup
  useEffect(() => {
    // Rileva tipo dispositivo
    const deviceType = getDeviceType();
    setDeviceType(deviceType);
    console.log('ðŸ“± Tipo dispositivo rilevato:', deviceType);
    
    // Carica data ultimo backup
    const lastBackup = localStorage.getItem('lastBackupDate');
    if (lastBackup) {
      setLastBackupDate(lastBackup);
    }
    
    const lastFullBackup = localStorage.getItem('lastFullBackupDate');
    if (lastFullBackup) {
      setLastFullBackupDate(lastFullBackup);
    }
    
  }, []);

  // Ricalcola storage stats quando cambiano i dati
  useEffect(() => {
    const stats = calculateStorageStats();
    setStorageStats(stats);
    console.log('ðŸ“Š Storage stats aggiornate - Dimensione JSON backup:', stats.jsonSizeMB, 'MB');
  }, [players, matches, trainings]);

  // Carica lista backup quando user Ã¨ autenticato
  useEffect(() => {
    if (user && teamId) {
      loadAvailableBackups();
      
      // Carica dimensioni reali Storage (con delay per non bloccare)
      setTimeout(async () => {
        setLoadingStorageSize(true);
        const realSize = await calculateRealStorageSize();
        if (realSize) {
          setRealStorageSize(realSize);
        }
        setLoadingStorageSize(false);
      }, 2000);
    }
  }, [user, teamId]);

  // Backup automatico giornaliero alle 03:00 AM
  useEffect(() => {
    if (!user || !teamId) return;
    
    const checkAndRunDailyBackup = () => {
      const now = new Date();
      const lastBackup = localStorage.getItem('lastBackupDate');
      
      // Se non c'Ã¨ mai stato un backup, o l'ultimo Ã¨ di ieri, fai backup
      if (!lastBackup) {
        console.log('ðŸ”„ Primo backup mai fatto, eseguo backup...');
        createDailyBackup();
        return;
      }
      
      const lastBackupDate = new Date(lastBackup);
      const hoursSinceLastBackup = (now - lastBackupDate) / (1000 * 60 * 60);
      
      // Se sono passate piÃ¹ di 24 ore, fai backup
      if (hoursSinceLastBackup >= 24) {
        console.log('ðŸ”„ Sono passate 24h dall\'ultimo backup, eseguo backup...');
        createDailyBackup();
      }
    };
    
    // Check al mount
    checkAndRunDailyBackup();
    
    // Check ogni ora
    const interval = setInterval(checkAndRunDailyBackup, 60 * 60 * 1000);
    
    return () => clearInterval(interval);
  }, [user, teamId, players, matches, trainings]);

  // ========== FINE NUOVE FUNZIONI SISTEMA BACKUP ==========

  // ========== FUNZIONI PER ANALISI TATTICA ==========

  const moduliDisponibili = [
    { nome: '4-4-2', descrizione: 'Classico equilibrato' },
    { nome: '4-3-3', descrizione: 'Offensivo con ali' },
    { nome: '3-5-2', descrizione: 'Dominio centrocampo' },
    { nome: '4-2-3-1', descrizione: 'Moderno e versatile' },
    { nome: '3-4-3', descrizione: 'Ultra offensivo' },
    { nome: '5-3-2', descrizione: 'Difensivo e compatto' },
    { nome: '4-1-4-1', descrizione: 'Pressing alto' },
    { nome: '4-3-1-2', descrizione: 'Centrocampo folto' }
  ];

  const getPosizioniModulo = (modulo) => {
    const posizioni = {
      '4-4-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 20, y: 50, ruolo: 'E' }, { x: 40, y: 50, ruolo: 'CC' }, { x: 60, y: 50, ruolo: 'CC' }, { x: 80, y: 50, ruolo: 'E' },
        { x: 40, y: 25, ruolo: 'A' }, { x: 60, y: 25, ruolo: 'A' }
      ],
      '4-3-3': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 35, y: 55, ruolo: 'MC' }, { x: 50, y: 50, ruolo: 'CC' }, { x: 65, y: 55, ruolo: 'MC' },
        { x: 20, y: 25, ruolo: 'AD' }, { x: 50, y: 20, ruolo: 'PC' }, { x: 80, y: 25, ruolo: 'AS' }
      ],
      '3-5-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 30, y: 75, ruolo: 'DC' }, { x: 50, y: 75, ruolo: 'DC' }, { x: 70, y: 75, ruolo: 'DC' },
        { x: 15, y: 55, ruolo: 'E' }, { x: 35, y: 52, ruolo: 'MC' }, { x: 50, y: 50, ruolo: 'CC' }, { x: 65, y: 52, ruolo: 'MC' }, { x: 85, y: 55, ruolo: 'E' },
        { x: 40, y: 25, ruolo: 'A' }, { x: 60, y: 25, ruolo: 'A' }
      ],
      '4-2-3-1': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 40, y: 60, ruolo: 'MD' }, { x: 60, y: 60, ruolo: 'MD' },
        { x: 20, y: 38, ruolo: 'AE' }, { x: 50, y: 35, ruolo: 'TQ' }, { x: 80, y: 38, ruolo: 'AD' },
        { x: 50, y: 18, ruolo: 'PC' }
      ],
      '3-4-3': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 30, y: 75, ruolo: 'DC' }, { x: 50, y: 75, ruolo: 'DC' }, { x: 70, y: 75, ruolo: 'DC' },
        { x: 20, y: 55, ruolo: 'E' }, { x: 40, y: 52, ruolo: 'CC' }, { x: 60, y: 52, ruolo: 'CC' }, { x: 80, y: 55, ruolo: 'E' },
        { x: 20, y: 25, ruolo: 'AD' }, { x: 50, y: 20, ruolo: 'PC' }, { x: 80, y: 25, ruolo: 'AS' }
      ],
      '5-3-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 15, y: 75, ruolo: 'TD' }, { x: 32, y: 75, ruolo: 'DC' }, { x: 50, y: 75, ruolo: 'DC' }, { x: 68, y: 75, ruolo: 'DC' }, { x: 85, y: 75, ruolo: 'TS' },
        { x: 35, y: 52, ruolo: 'MC' }, { x: 50, y: 50, ruolo: 'CC' }, { x: 65, y: 52, ruolo: 'MC' },
        { x: 40, y: 25, ruolo: 'A' }, { x: 60, y: 25, ruolo: 'A' }
      ],
      '4-1-4-1': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 50, y: 62, ruolo: 'MD' },
        { x: 20, y: 48, ruolo: 'E' }, { x: 40, y: 45, ruolo: 'CC' }, { x: 60, y: 45, ruolo: 'CC' }, { x: 80, y: 48, ruolo: 'E' },
        { x: 50, y: 20, ruolo: 'PC' }
      ],
      '4-3-1-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 35, y: 55, ruolo: 'MC' }, { x: 50, y: 52, ruolo: 'CC' }, { x: 65, y: 55, ruolo: 'MC' },
        { x: 50, y: 35, ruolo: 'TQ' },
        { x: 40, y: 20, ruolo: 'A' }, { x: 60, y: 20, ruolo: 'A' }
      ]
    };
    return posizioni[modulo] || [];
  };

  const CampoTattico = ({ moduloNostro, moduloAvversario, evidenziaContrasto }) => {
    const posizioniNostre = getPosizioniModulo(moduloNostro);
    const posizioniAvversarie = getPosizioniModulo(moduloAvversario).map(pos => ({
      ...pos,
      y: 100 - pos.y
    }));

    const calcolaDistanza = (x1, y1, x2, y2) => {
      return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    };

    const sovrapposizioni = [];
    const giocatoriGiaUsati = new Set();
    
    posizioniNostre.forEach((posNostra, idxNostra) => {
      posizioniAvversarie.forEach((posAvversaria, idxAvversaria) => {
        const distanza = calcolaDistanza(posNostra.x, posNostra.y, posAvversaria.x, posAvversaria.y);
        const sogliaSovrapposizione = 2.5;
        
        if (distanza < sogliaSovrapposizione) {
          const keyNostra = `nost-${idxNostra}`;
          const keyAvversaria = `avv-${idxAvversaria}`;
          
          if (!giocatoriGiaUsati.has(keyNostra) && !giocatoriGiaUsati.has(keyAvversaria)) {
            sovrapposizioni.push({
              x: (posNostra.x + posAvversaria.x) / 2,
              y: (posNostra.y + posAvversaria.y) / 2,
              ruoloNostro: posNostra.ruolo,
              ruoloAvversario: posAvversaria.ruolo,
              indexNostra: idxNostra,
              indexAvversaria: idxAvversaria
            });
            giocatoriGiaUsati.add(keyNostra);
            giocatoriGiaUsati.add(keyAvversaria);
          }
        }
      });
    });

    const posizioniNostreFiltrate = posizioniNostre.filter((_, idx) => !giocatoriGiaUsati.has(`nost-${idx}`));
    const posizioniAvversarieFiltrate = posizioniAvversarie.filter((_, idx) => !giocatoriGiaUsati.has(`avv-${idx}`));

    return (
      <div className="bg-green-700 rounded-lg p-4 shadow-xl">
        <svg viewBox="0 0 100 100" className="w-full h-auto" style={{ maxHeight: '600px' }}>
          <rect width="100" height="100" fill="#2d7a3e" />
          
          <line x1="0" y1="50" x2="100" y2="50" stroke="white" strokeWidth="0.3" opacity="0.8" />
          <circle cx="50" cy="50" r="8" fill="none" stroke="white" strokeWidth="0.3" opacity="0.8" />
          <circle cx="50" cy="50" r="0.8" fill="white" opacity="0.8" />
          
          <rect x="30" y="0" width="40" height="15" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <rect x="42" y="0" width="16" height="8" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <circle cx="50" cy="10" r="0.6" fill="white" opacity="0.6" />
          
          <rect x="30" y="85" width="40" height="15" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <rect x="42" y="92" width="16" height="8" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <circle cx="50" cy="90" r="0.6" fill="white" opacity="0.6" />
          
          <rect x="0.5" y="0.5" width="99" height="99" fill="none" stroke="white" strokeWidth="0.5" opacity="0.8" />

          <text x="50" y="48" textAnchor="middle" fill="white" fontSize="3" opacity="0.5" fontWeight="bold">
            AVVERSARI
          </text>
          <text x="50" y="52" textAnchor="middle" fill="white" fontSize="3" opacity="0.5" fontWeight="bold">
            NOSTRA SQUADRA
          </text>

          <defs>
            <clipPath id="leftHalf">
              <rect x="-2.5" y="-2.5" width="2.5" height="5" />
            </clipPath>
            <clipPath id="rightHalf">
              <rect x="0" y="-2.5" width="2.5" height="5" />
            </clipPath>
          </defs>

          {posizioniAvversarieFiltrate.map((pos, idx) => (
            <g key={`avv-solo-${idx}`}>
              <circle 
                cx={pos.x} 
                cy={pos.y} 
                r="2.5" 
                fill="#ef4444" 
                stroke="white" 
                strokeWidth="0.3"
                opacity="0.9"
              />
              <text 
                x={pos.x} 
                y={pos.y + 0.8} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.8" 
                fontWeight="bold"
              >
                {pos.ruolo}
              </text>
            </g>
          ))}

          {posizioniNostreFiltrate.map((pos, idx) => (
            <g key={`nost-solo-${idx}`}>
              <circle 
                cx={pos.x} 
                cy={pos.y} 
                r="2.5" 
                fill="#3b82f6" 
                stroke="white" 
                strokeWidth="0.3"
                opacity="0.9"
              />
              <text 
                x={pos.x} 
                y={pos.y + 0.8} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.8" 
                fontWeight="bold"
              >
                {pos.ruolo}
              </text>
            </g>
          ))}

          {sovrapposizioni.map((sovr, idx) => (
            <g key={`sovr-${idx}`}>
              <g clipPath="url(#leftHalf)" transform={`translate(${sovr.x}, ${sovr.y})`}>
                <circle 
                  cx="0" 
                  cy="0" 
                  r="2.5" 
                  fill="#ef4444" 
                  opacity="0.95"
                />
              </g>
              
              <g clipPath="url(#rightHalf)" transform={`translate(${sovr.x}, ${sovr.y})`}>
                <circle 
                  cx="0" 
                  cy="0" 
                  r="2.5" 
                  fill="#3b82f6" 
                  opacity="0.95"
                />
              </g>
              
              <circle 
                cx={sovr.x} 
                cy={sovr.y} 
                r="2.5" 
                fill="none" 
                stroke="white" 
                strokeWidth="0.4"
              />
              
              <line 
                x1={sovr.x} 
                y1={sovr.y - 2.5} 
                x2={sovr.x} 
                y2={sovr.y + 2.5} 
                stroke="white" 
                strokeWidth="0.3"
              />
              
              <text 
                x={sovr.x} 
                y={sovr.y - 0.3} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.3" 
                fontWeight="bold"
              >
                {sovr.ruoloAvversario}
              </text>
              <text 
                x={sovr.x} 
                y={sovr.y + 1.3} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.3" 
                fontWeight="bold"
              >
                {sovr.ruoloNostro}
              </text>
            </g>
          ))}

          {evidenziaContrasto && (
            <>
              <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#fbbf24" />
                </marker>
              </defs>
            </>
          )}
        </svg>

        <div className="mt-4 flex flex-col gap-2">
          <div className="flex justify-center gap-6 text-white text-sm">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full bg-red-500 border-2 border-white"></div>
              <span className="font-semibold">Avversari ({moduloAvversario})</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full bg-blue-500 border-2 border-white"></div>
              <span className="font-semibold">Nostra Squadra ({moduloNostro})</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full border-2 border-white" style={{background: 'linear-gradient(90deg, #ef4444 50%, #3b82f6 50%)'}}>
              </div>
              <span className="font-semibold">Zona Contesa</span>
            </div>
          </div>
          {sovrapposizioni.length > 0 && (
            <div className="text-center text-white text-xs opacity-75">
              {sovrapposizioni.length} zone di contrasto diretto
            </div>
          )}
        </div>
      </div>
    );
  };

  const analizzaModuloAvversario = (modulo) => {
    const analisi = {
      '4-4-2': {
        puntiDeboli: [
          'Vulnerabile sulle fasce contro moduli a 3 punte',
          'Centrocampo puÃ² essere sopraffatto numericamente',
          'Spazi tra linee sfruttabili con trequartista'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Le tre punte sovraccaricano i due centrali avversari',
            vantaggi: ['SuperioritÃ  numerica in attacco', 'Ampiezza sulle fasce', 'Pressing sui mediani'],
            tattiche: ['Attaccare gli spazi tra terzino e centrale', 'Ali larghe per allargare la difesa', 'Centravanti mobile tra i due centrali'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Velocita esplosiva per puntare 1 contro 1', 'Dribbling superiore per saltare avversario', 'Capacita di cross preciso dal fondo', 'Resistenza per coprire tutta la fascia', 'Tecnica individuale eccellente'],
                importanza: 'FONDAMENTALE - Devono dominare i duelli con i terzini avversari'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Mobilita per muoversi tra i due centrali', 'Capacita di proteggere palla', 'Finalizzazione precisa', 'Senso della posizione', 'Fisicita per tenere i palloni'],
                importanza: 'ESSENZIALE - Deve occupare entrambi i centrali avversari'
              },
              {
                ruolo: 'REGISTA (Centrocampista Centrale)',
                caratteristiche: ['Visione di gioco superiore', 'Passaggio lungo preciso', 'Intelligenza tattica', 'Capacita di dettare i tempi', 'Buona tecnica di base'],
                importanza: 'CRITICO - Deve orchestrare il gioco e servire le punte'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Il trequartista trova spazio tra le linee avversarie',
            vantaggi: ['Trequartista libero tra centrocampo e difesa', 'SuperioritÃ  numerica a centrocampo', 'Transizioni veloci'],
            tattiche: ['Trequartista negli spazi tra linee', 'Esterni ad attaccare i terzini', 'Doppio mediano per controllare il gioco'],
            ruoliChiave: [
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita e imprevedibilita', 'Ottima visione di gioco', 'Tecnica sopraffina', 'Capacita di giocare tra le linee', 'Dribbling stretto e controllo di palla'],
                importanza: 'FONDAMENTALE - Fulcro del gioco tra centrocampo e attacco'
              },
              {
                ruolo: 'MEDIANI (Coppia)',
                caratteristiche: ['Intelligenza tattica elevata', 'Capacita di interdizione', 'Passaggio verticale preciso', 'Copertura reciproca', 'Lettura delle situazioni'],
                importanza: 'ESSENZIALE - Devono dominare centrocampo ed equilibrare'
              },
              {
                ruolo: 'ESTERNI OFFENSIVI',
                caratteristiche: ['Velocita nelle ripartenze', 'Capacita di attaccare la profondita', 'Dribbling efficace', 'Cross precisi', 'Rientri difensivi disciplinati'],
                importanza: 'IMPORTANTE - Creano ampiezza e attaccano gli spazi'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 85,
            motivo: 'SuperioritÃ  numerica a centrocampo (5 vs 4)',
            vantaggi: ['Dominio del centrocampo', 'Quinti che sovraccaricano le fasce', 'SoliditÃ  difensiva'],
            tattiche: ['Dominare il centrocampo numericamente', 'Quinti a creare superioritÃ  sulle fasce', 'Pressing sui mediani avversari'],
            ruoliChiave: [
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Resistenza straordinaria', 'Velocita per coprire 70+ metri', 'Capacita offensive e difensive bilanciate', 'Cross preciso', 'Intelligenza posizionale'],
                importanza: 'FONDAMENTALE - Devono dominare le fasce per 90 minuti'
              },
              {
                ruolo: 'REGISTA CENTRALE',
                caratteristiche: ['Visione di gioco panoramica', 'Passaggio lungo e corto di qualita', 'Posizionamento impeccabile', 'Capacita di verticalizzare', 'Calma sotto pressione'],
                importanza: 'ESSENZIALE - Deve orchestrare il gioco a centrocampo'
              },
              {
                ruolo: 'CENTRALE LIBERO',
                caratteristiche: ['Lettura del gioco eccellente', 'Capacita di impostare', 'Passaggio lungo preciso', 'Leadership difensiva', 'Posizionamento anticipatorio'],
                importanza: 'CRITICO - Deve dirigere la difesa a 3'
              }
            ]
          }
        ]
      },
      '4-3-3': {
        puntiDeboli: [
          'Terzini esposti in fase difensiva',
          'Due mediani centrali possono essere in inferioritÃ ',
          'Spazi centrali tra i centrocampisti'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-1-2',
            efficacia: 95,
            motivo: 'SuperioritÃ  numerica in mezzo al campo',
            vantaggi: ['3 centrocampisti vs 2 mediani avversari', 'Trequartista a disturbare il regista', 'SoliditÃ  centrale'],
            tattiche: ['Chiudere il centro del campo', 'Pressare i due mediani', 'Sfruttare gli spazi tra le linee'],
            ruoliChiave: [
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['SuperioritÃ  numerica sui due mediani', 'Capacita di chiudere gli spazi centrali', 'Pressione coordinata', 'Controllo del possesso', 'Mobilita per coprire il campo'],
                importanza: 'FONDAMENTALE - Devono soffocare i due mediani avversari'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Pressing sul regista avversario', 'Capacita di intercettare passaggi', 'Creativita negli spazi', 'Inserimenti negli spazi', 'Visione di gioco'],
                importanza: 'ESSENZIALE - Deve disturbare la costruzione e creare gioco'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti coordinati', 'Pressing sui difensori', 'Capacita di finalizzare contropiede', 'Gioco di sponda', 'Sfruttamento spazi tra le linee'],
                importanza: 'IMPORTANTE - Devono sfruttare la superioritÃ  a centrocampo'
              }
            ]
          },
          {
            modulo: '4-4-2',
            efficacia: 85,
            motivo: 'Equilibrio e compattezza difensiva',
            vantaggi: ['Quattro difensori contro tre attaccanti', 'Esterni bassi contro le ali', 'Compattezza difensiva'],
            tattiche: ['Esterni che rientrano sulle ali avversarie', 'Blocco basso compatto', 'Ripartenze in verticale'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Disciplina nel rientro difensivo', 'Marcatura stretta sulle ali', 'Capacita di duello 1vs1', 'Resistenza per doppia fase', 'Velocita nelle ripartenze'],
                importanza: 'FONDAMENTALE - Devono neutralizzare le ali avversarie'
              },
              {
                ruolo: 'DIFENSORI CENTRALI (Coppia)',
                caratteristiche: ['Compattezza e coperture reciproche', 'Marcatura sul centravanti', 'Anticipazione sui movimenti', 'Fisicita nei duelli', 'Comunicazione costante'],
                importanza: 'ESSENZIALE - Devono tenere il blocco compatto e basso'
              },
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Coppia)',
                caratteristiche: ['Copertura degli spazi centrali', 'Capacita di recupero palla', 'Passaggio verticale preciso', 'Disciplina posizionale', 'Supporto alle ripartenze'],
                importanza: 'CRITICO - Devono proteggere la difesa e innescare contropiede'
              }
            ]
          },
          {
            modulo: '5-3-2',
            efficacia: 80,
            motivo: 'Difesa a 5 per neutralizzare le tre punte',
            vantaggi: ['ParitÃ  numerica in difesa', 'Braccetti sui esterni avversari', 'SoliditÃ  difensiva'],
            tattiche: ['Difesa a 5 per coprire il fronte offensivo', 'Braccetti sulle ali avversarie', 'Ripartenze rapide'],
            ruoliChiave: [
              {
                ruolo: 'BRACCETTI (Difensori Laterali)',
                caratteristiche: ['Marcatura stretta sulle ali', 'Velocita per seguire gli attaccanti esterni', 'Capacita di duello 1vs1', 'Aggressivita nei contrasti', 'Copertura sulla fascia'],
                importanza: 'FONDAMENTALE - Devono annullare le ali avversarie'
              },
              {
                ruolo: 'CENTRALE LIBERO',
                caratteristiche: ['Lettura del gioco anticipatoria', 'Coperture sul centravanti', 'Leadership difensiva', 'Capacita di impostazione', 'Posizionamento impeccabile'],
                importanza: 'ESSENZIALE - Deve coordinare la linea a 5 e coprire il centro'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Capacita di tenere palla', 'Pressing coordinato', 'Finalizzazione nelle ripartenze', 'Movimenti per creare spazi', 'Resistenza fisica'],
                importanza: 'IMPORTANTE - Devono sfruttare le ripartenze rapide'
              }
            ]
          }
        ]
      },
      '3-5-2': {
        puntiDeboli: [
          'Tre difensori vulnerabili contro attacchi sulle fasce',
          'Quinti devono coprire molta fascia',
          'Spazi tra braccetti e centrale'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Ali larghe per attaccare i tre difensori centrali',
            vantaggi: ['SuperioritÃ  numerica in attacco (3 vs 3)', 'Ali larghe sfruttano gli spazi', 'Terzini per sovraccaricare le fasce'],
            tattiche: ['Ali molto larghe per allargare la difesa', 'Attaccare gli spazi laterali', 'Terzini alti per sovraccaricare i quinti'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Ampiezza massima per allargare i tre difensori', 'Velocita per attaccare gli spazi larghi', 'Dribbling per superare i braccetti', 'Movimenti dentro-fuori', 'Cross e finalizzazione'],
                importanza: 'FONDAMENTALE - Devono sfruttare l\'ampiezza e creare spazi'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni costanti sulle fasce', 'Capacita di creare 2vs1 contro i quinti', 'Cross dal fondo', 'Spinta offensiva continua', 'Sincronizzazione con le ali'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce e stancare i quinti'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Movimenti tra i tre difensori', 'Capacita di occupare il centrale', 'Finalizzazione precisa', 'Gioco aereo efficace', 'Attacco della profondita'],
                importanza: 'CRITICO - Deve impegnare i tre difensori centrali'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Esterni e terzini per attaccare le fasce',
            vantaggi: ['Quattro attaccanti sugli esterni', 'Centrocampo equilibrato', 'Ampiezza massima'],
            tattiche: ['Esterni larghi contro i braccetti', 'Terzini offensivi per sovraccarico', 'Attaccare gli spazi laterali'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Posizionamento largo contro i braccetti', 'Velocita per puntare 1vs1', 'Dribbling per superare l\'avversario', 'Capacita di tagliare dentro', 'Cross e finalizzazione'],
                importanza: 'FONDAMENTALE - Devono attaccare i braccetti e creare ampiezza'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni sincronizzate', 'Capacita di creare 2vs1 sui quinti', 'Cross dal fondo', 'Resistenza per spinta continua', 'Ampiezza offensiva massima'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con gli esterni'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita negli spazi centrali', 'Capacita di servire gli esterni', 'Visione per cambi di lato rapidi', 'Dribbling tra le linee', 'Inserimenti coordinati'],
                importanza: 'CRITICO - Deve orchestrare gli attacchi sulle fasce'
              }
            ]
          },
          {
            modulo: '3-4-3',
            efficacia: 85,
            motivo: 'Attacco speculare con maggiore offensivitÃ ',
            vantaggi: ['ParitÃ  difensiva ma piÃ¹ punte', 'Ali contro quinti', 'Pressing alto efficace'],
            tattiche: ['Pressing alto sui tre difensori', 'Ali contro quinti affaticati', 'Attacco costante sulle fasce'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Pressing aggressivo sui quinti', 'Velocita per sfruttare stanchezza avversaria', 'Dribbling per saltare l\'uomo', 'Ampiezza massima sulle fasce', 'Finalizzazione da posizione laterale'],
                importanza: 'FONDAMENTALE - Devono sfinire e superare i quinti avversari'
              },
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Supporto alle ali', 'Sovrapposizioni coordinate', 'Capacita di creare superioritÃ ', 'Cross e assistenza', 'Resistenza per doppia fase'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con le ali'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Pressing sul centrale libero', 'Movimenti per occupare i tre difensori', 'Capacita di finalizzazione', 'Gioco aereo efficace', 'Coordinazione con le ali'],
                importanza: 'CRITICO - Deve pressare e impegnare la difesa a tre'
              }
            ]
          }
        ]
      },
      '4-2-3-1': {
        puntiDeboli: [
          'Centrocampo puÃ² essere sovraccaricato',
          'Due mediani soli contro centrocampi numerosi',
          'Punta isolata se trequartista non sostiene'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 90,
            motivo: 'Tre centrocampisti vs due mediani avversari',
            vantaggi: ['SuperioritÃ  numerica in mezzo', 'Dominio del centrocampo', 'Triangolazioni centrali'],
            tattiche: ['Pressare i due mediani', 'Dominare il centrocampo centrale', 'Giro palla rapido per aprire spazi'],
            ruoliChiave: [
              {
                ruolo: 'REGISTA (Centrocampista Centrale)',
                caratteristiche: ['Visione di gioco superiore', 'Passaggio preciso sotto pressione', 'Capacita di dettare i tempi', 'Intelligenza posizionale', 'Tecnica di base eccellente'],
                importanza: 'FONDAMENTALE - Deve dominare il duello con i due mediani'
              },
              {
                ruolo: 'MEZZALI (Centrocampisti Interni)',
                caratteristiche: ['Inserimenti coordinati negli spazi', 'Capacita di pressione sui mediani', 'Dinamismo e resistenza', 'Passaggio verticale preciso', 'Senso tattico elevato'],
                importanza: 'ESSENZIALE - Devono creare superioritÃ  numerica costante'
              },
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Velocita per attaccare gli spazi', 'Dribbling per saltare i terzini', 'Capacita di tagliare dentro al campo', 'Finalizzazione precisa', 'Movimenti coordinati'],
                importanza: 'CRITICO - Devono sfruttare gli spazi creati dal centrocampo'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 85,
            motivo: 'Cinque centrocampisti dominano la zona centrale',
            vantaggi: ['SuperioritÃ  numerica totale a centrocampo', 'Quinti vs terzini', 'Controllo del gioco'],
            tattiche: ['Dominare il centrocampo', 'Pressione sui portatori di palla', 'Quinti per creare superioritÃ '],
            ruoliChiave: [
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Resistenza eccezionale per 90 minuti', 'Velocita nelle transizioni', 'Capacita offensive e difensive', 'Cross precisi', 'Disciplina tattica'],
                importanza: 'FONDAMENTALE - Devono sovraccarica re le fasce contro i terzini'
              },
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Trio)',
                caratteristiche: ['Dominio fisico e tecnico', 'Capacita di recupero palla', 'Passaggio verticale di qualita', 'Mobilita per coprire spazi', 'Intelligenza tattica superiore'],
                importanza: 'ESSENZIALE - Devono soffocare i due mediani avversari'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Mobilita per attaccare la profondita', 'Capacita di legare il gioco', 'Finalizzazione efficace', 'Movimenti coordinati', 'Pressing sui difensori'],
                importanza: 'IMPORTANTE - Devono sfruttare il dominio a centrocampo'
              }
            ]
          },
          {
            modulo: '4-1-4-1',
            efficacia: 80,
            motivo: 'Pressing ultra-aggressivo sul trequartista',
            vantaggi: ['Mediano sul trequartista avversario', 'Pressing alto coordinato', 'Recupero palla alto'],
            tattiche: ['Mediano che marca il trequartista', 'Pressing aggressivo sulla costruzione', 'Corto muso per recupero alto'],
            ruoliChiave: [
              {
                ruolo: 'MEDIANO (Davanti alla difesa)',
                caratteristiche: ['Marcatura asfissiante sul trequartista', 'Lettura preventiva dei passaggi', 'Aggressivita nel contrasto', 'Disciplina posizionale ferrea', 'Capacita di interdizione totale'],
                importanza: 'FONDAMENTALE - Deve annullare il trequartista avversario'
              },
              {
                ruolo: 'CENTROCAMPISTI (Quartetto)',
                caratteristiche: ['Pressing coordinato e aggressivo', 'Chiusura degli spazi centrali', 'Capacita di scaglionamento', 'Resistenza fisica elevata', 'Rapidita nelle transizioni'],
                importanza: 'ESSENZIALE - Devono recuperare palla nella meta campo avversaria'
              },
              {
                ruolo: 'PUNTA CENTRALE',
                caratteristiche: ['Pressing sui difensori centrali', 'Capacita di tenere palla', 'Finalizzazione nelle ripartenze', 'Intelligenza nei movimenti', 'Resistenza al gioco spalle alla porta'],
                importanza: 'IMPORTANTE - Deve essere il primo difensore e sfruttare le ripartenze'
              }
            ]
          }
        ]
      },
      '3-4-3': {
        puntiDeboli: [
          'Difesa esposta contro attacchi veloci',
          'Centrocampo in inferioritÃ  numerica',
          'Esterni devono correre molto'
        ],
        moduliConsigliati: [
          {
            modulo: '4-4-2',
            efficacia: 90,
            motivo: 'Quattro difensori contro tre punte, equilibrio totale',
            vantaggi: ['SoliditÃ  difensiva', 'Equilibrio in tutti i reparti', 'Blocco compatto'],
            tattiche: ['Difesa solida contro le tre punte', 'Esterni che rientrano', 'Ripartenze verticali veloci'],
            ruoliChiave: [
              {
                ruolo: 'DIFENSORI CENTRALI (Coppia)',
                caratteristiche: ['Marcatura stretta sul centravanti', 'Coperture reciproche perfette', 'Fisicita nei duelli aerei', 'Capacita di anticipazione', 'Leadership difensiva'],
                importanza: 'FONDAMENTALE - Devono neutralizzare la punta centrale avversaria'
              },
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Disciplina nel rientrare sulle ali', 'Capacita di duello 1vs1', 'Resistenza per doppia fase', 'Velocita nelle ripartenze', 'Intelligenza posizionale'],
                importanza: 'ESSENZIALE - Devono chiudere le fasce contro le ali avversarie'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Velocita esplosiva nelle ripartenze', 'Capacita di tenere palla', 'Finalizzazione precisa', 'Movimenti coordinati', 'Pressing sui tre difensori'],
                importanza: 'CRITICO - Devono punire le ripartenze verticali'
              }
            ]
          },
          {
            modulo: '5-3-2',
            efficacia: 85,
            motivo: 'Difesa a 5 per contenere l\'attacco avversario',
            vantaggi: ['SuperioritÃ  numerica difensiva', 'Coperture costanti', 'SoliditÃ  estrema'],
            tattiche: ['Difesa a cinque per contenere', 'Braccetti sulle ali avversarie', 'Assorbire la pressione e ripartire'],
            ruoliChiave: [
              {
                ruolo: 'BRACCETTI (Difensori Laterali)',
                caratteristiche: ['Marcatura asfissiante sulle ali', 'Velocita per inseguire gli attaccanti', 'Capacita di duello aereo', 'Aggressivita nei contrasti', 'Copertura sulla fascia'],
                importanza: 'FONDAMENTALE - Devono annullare le ali avversarie'
              },
              {
                ruolo: 'CENTRALE LIBERO',
                caratteristiche: ['Lettura anticipatoria del gioco', 'Coperture preventive', 'Capacita di impostazione', 'Leadership difensiva assoluta', 'Posizionamento impeccabile'],
                importanza: 'ESSENZIALE - Deve coordinare la linea a 5 e coprire'
              },
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Capacita di assorbire pressione', 'Qualita nel passaggio verticale', 'Resistenza fisica elevata', 'Intelligenza nelle ripartenze', 'Controllo del tempo di gioco'],
                importanza: 'CRITICO - Devono gestire le transizioni difesa-attacco'
              }
            ]
          },
          {
            modulo: '4-3-1-2',
            efficacia: 80,
            motivo: 'SuperioritÃ  numerica a centrocampo',
            vantaggi: ['Dominio del centrocampo', 'Controllo del possesso', 'Trequartista libero'],
            tattiche: ['Controllare il centrocampo', 'Possesso palla per stancare l\'avversario', 'Pressing coordinato'],
            ruoliChiave: [
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Controllo totale del possesso palla', 'Passaggio corto preciso', 'Mobilita per coprire il campo', 'Capacita di recupero', 'Intelligenza nel giro palla'],
                importanza: 'FONDAMENTALE - Devono dominare il centrocampo e stancare l\'avversario'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita tra le linee', 'Visione di gioco superiore', 'Tecnica individuale eccellente', 'Capacita di verticalizzare', 'Dribbling in spazi stretti'],
                importanza: 'ESSENZIALE - Deve essere la chiave per sbloccare la difesa'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti coordinati', 'Capacita di attaccare la profondita', 'Finalizzazione precisa', 'Pressing sui tre difensori', 'Gioco spalle alla porta'],
                importanza: 'IMPORTANTE - Devono sfruttare gli spazi creati dal possesso'
              }
            ]
          }
        ]
      },
      '5-3-2': {
        puntiDeboli: [
          'Rinuncia all\'ampiezza offensiva',
          'Solo due attaccanti, scarso peso offensivo',
          'Centrocampo puÃ² essere sopraffatto'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Attacco sulle fasce e superioritÃ  in mezzo',
            vantaggi: ['Ali contro braccetti difensivi', 'SuperioritÃ  a centrocampo', 'Possesso palla prolungato'],
            tattiche: ['Allargare il gioco sulle fasce', 'Dominare il centrocampo', 'Possesso per far uscire l\'avversario'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Velocita per attaccare gli spazi larghi', 'Dribbling per superare i braccetti', 'Capacita di cross dal fondo', 'Movimenti dentro-fuori', 'Finalizzazione da posizione defilata'],
                importanza: 'FONDAMENTALE - Devono sfruttare l\'ampiezza e attaccare i braccetti'
              },
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Controllo del possesso palla', 'Passaggio preciso per allargare', 'Mobilita per coprire il campo', 'Capacita di verticalizzazione', 'Intelligenza nel giro palla'],
                importanza: 'ESSENZIALE - Devono dominare il centrocampo e servire le ali'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Spinta costante sulla fascia', 'Sovrapposizioni coordinate', 'Cross precisi', 'Capacita di creare superioritÃ ', 'Resistenza per doppia fase'],
                importanza: 'CRITICO - Devono sovraccaricare le fasce con le ali'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Quattro attaccanti per scardinare il blocco difensivo',
            vantaggi: ['Attacco a cinque con terzini', 'SuperioritÃ  offensiva', 'Trequartista libero'],
            tattiche: ['Attaccare sulle fasce costantemente', 'Possesso prolungato', 'Terzini sempre alti'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Ampiezza massima sulle fasce', 'Dribbling per saltare i braccetti', 'Movimenti dentro-fuori coordinati', 'Cross precisi', 'Capacita di finalizzazione'],
                importanza: 'FONDAMENTALE - Devono allargare la difesa a 5 avversaria'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita negli spazi centrali', 'Capacita di combinazioni rapide', 'Visione di gioco superiore', 'Dribbling in spazi stretti', 'Inserimenti negli spazi'],
                importanza: 'ESSENZIALE - Deve trovare varchi nella difesa compatta'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni costanti', 'Resistenza per fase offensiva prolungata', 'Cross dal fondo', 'Capacita di creare superioritÃ ', 'Sincronia con gli esterni'],
                importanza: 'CRITICO - Devono sovraccaricare le fasce costantemente'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 80,
            motivo: 'Cinque centrocampisti per dominare il gioco',
            vantaggi: ['SuperioritÃ  a centrocampo', 'Controllo del possesso', 'Quinti offensivi'],
            tattiche: ['Dominare il centrocampo', 'Possesso palla lungo', 'Quinti che attaccano costantemente'],
            ruoliChiave: [
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Spinta offensiva continua', 'Resistenza per 90 minuti di fase attiva', 'Cross dal fondo', 'Capacita di creare superioritÃ  numerica', 'Dribbling sulla fascia'],
                importanza: 'FONDAMENTALE - Devono attaccare costantemente le fasce'
              },
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Trio)',
                caratteristiche: ['Controllo del possesso prolungato', 'Passaggio preciso per cambiare gioco', 'Pazienza nel giro palla', 'Capacita di verticalizzare al momento giusto', 'Mobilita per aprire linee di passaggio'],
                importanza: 'ESSENZIALE - Devono dominare il possesso e stancare l\'avversario'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti per attaccare la profondita', 'Capacita di finalizzare occasioni', 'Gioco di sponda', 'Inserimenti coordinati', 'Pressing sui difensori'],
                importanza: 'IMPORTANTE - Devono sfruttare gli spazi creati dal possesso'
              }
            ]
          }
        ]
      },
      '4-1-4-1': {
        puntiDeboli: [
          'Punta molto isolata',
          'Distanze tra i reparti se non coordinati',
          'Dipendenza dal mediano davanti alla difesa'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-1-2',
            efficacia: 90,
            motivo: 'Due punte contro difesa a quattro e trequartista sul mediano',
            vantaggi: ['SuperioritÃ  in attacco', 'Trequartista sul mediano avversario', 'Peso offensivo maggiore'],
            tattiche: ['Due punte per impegnare i centrali', 'Trequartista a pressare il mediano', 'Centrocampisti che inseriscono'],
            ruoliChiave: [
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti complementari tra loro', 'Capacita di attaccare i due centrali', 'Finalizzazione precisa', 'Gioco di sponda efficace', 'Pressing coordinato'],
                importanza: 'FONDAMENTALE - Devono impegnare costantemente i due centrali'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Pressing asfissiante sul mediano', 'Capacita di inserimento', 'Creativita negli spazi', 'Visione di gioco', 'Tecnica individuale superiore'],
                importanza: 'ESSENZIALE - Deve annullare il mediano e creare gioco'
              },
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Inserimenti negli spazi', 'Supporto alle punte', 'Capacita di finalizzazione da fuori', 'Equilibrio tra fase difensiva e offensiva', 'Mobilita costante'],
                importanza: 'CRITICO - Devono creare superioritÃ  numerica in attacco'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 85,
            motivo: 'Quattro trequartisti per superare il pressing',
            vantaggi: ['SuperioritÃ  nella trequarti', 'Esterni mobili', 'Triangolazioni rapide'],
            tattiche: ['Giro palla veloce per superare il pressing', 'Esterni che attaccano gli spazi', 'Combinazioni strette'],
            ruoliChiave: [
              {
                ruolo: 'TREQUARTISTA CENTRALE',
                caratteristiche: ['Tecnica sopraffina sotto pressione', 'Capacita di giocate nello stretto', 'Visione per combinazioni rapide', 'Mobilita per sfuggire al mediano', 'Dribbling in spazi ridotti'],
                importanza: 'FONDAMENTALE - Deve battere il pressing del mediano avversario'
              },
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Velocita per attaccare gli spazi', 'Capacita di venire incontro', 'Triangolazioni con trequartista', 'Dribbling per saltare l\'uomo', 'Ampiezza e profondita'],
                importanza: 'ESSENZIALE - Devono allargare il pressing e creare superioritÃ '
              },
              {
                ruolo: 'MEDIANI (Coppia)',
                caratteristiche: ['Controllo del possesso', 'Passaggio veloce e preciso', 'Capacita di cambiare gioco', 'Mobilita per aprire linee', 'Copertura reciproca'],
                importanza: 'IMPORTANTE - Devono far girare palla velocemente per battere il pressing'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 80,
            motivo: 'SuperioritÃ  numerica a centrocampo',
            vantaggi: ['Cinque contro quattro in mezzo', 'Quinti offensivi', 'Controllo del gioco'],
            tattiche: ['Dominare il centrocampo', 'Quinti per creare superioritÃ ', 'Possesso palla prolungato'],
            ruoliChiave: [
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Trio)',
                caratteristiche: ['SuperioritÃ  numerica sul quartetto avversario', 'Controllo del possesso', 'Capacita di verticalizzare', 'Mobilita per aprire spazi', 'Passaggio preciso'],
                importanza: 'FONDAMENTALE - Devono dominare il centrocampo con superioritÃ '
              },
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Ampiezza sulle fasce', 'Capacita di creare superioritÃ  numerica', 'Cross dal fondo', 'Resistenza per fase attiva prolungata', 'Spinta offensiva costante'],
                importanza: 'ESSENZIALE - Devono allargare il campo e sovraccaricare le fasce'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti per attaccare la profondita', 'Capacita di finalizzare', 'Gioco di sponda', 'Pressing sulla costruzione', 'Coordinazione nei movimenti'],
                importanza: 'IMPORTANTE - Devono sfruttare il dominio a centrocampo'
              }
            ]
          }
        ]
      },
      '4-3-1-2': {
        puntiDeboli: [
          'Mancanza di ampiezza, niente esterni',
          'Fasce scoperte in fase difensiva',
          'Terzini soli contro ali avversarie'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Ali larghe per sfruttare le fasce scoperte',
            vantaggi: ['Ali libere sulle fasce', 'Terzini soli da attaccare', 'Ampiezza massima'],
            tattiche: ['Ali larghe contro terzini isolati', 'Attaccare costantemente le fasce', 'Cross dalle fasce'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Ampiezza massima sulle fasce', 'Velocita per puntare i terzini isolati', 'Dribbling superiore 1vs1', 'Cross precisi dal fondo', 'Capacita di finalizzazione'],
                importanza: 'FONDAMENTALE - Devono dominare i duelli con i terzini isolati'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni costanti', 'Sincronizzazione con le ali', 'Capacita di creare 2vs1', 'Cross dalla linea di fondo', 'Spinta offensiva continua'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con le ali'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Movimenti per attaccare gli spazi centrali', 'Capacita di finalizzare i cross', 'Gioco aereo efficace', 'Senso della posizione', 'Fisicita nei duelli'],
                importanza: 'CRITICO - Deve sfruttare i cross dalle fasce'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Tre trequartisti sulle fasce per sovraccarico',
            vantaggi: ['Esterni che attaccano le fasce', 'Ampiezza offensiva', 'Terzini offensivi'],
            tattiche: ['Esterni larghi sulle fasce', 'Terzini che sovraccaricare', 'Attacco sugli spazi laterali'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Posizionamento largo sulle fasce', 'Velocita per attaccare i terzini', 'Capacita di tagliare dentro al campo', 'Dribbling efficace', 'Cross e finalizzazione'],
                importanza: 'FONDAMENTALE - Devono attaccare costantemente le fasce scoperte'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni sincronizzate', 'Capacita di creare 2vs1', 'Resistenza per spinta continua', 'Cross dal fondo', 'Ampiezza offensiva'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con gli esterni'
              },
              {
                ruolo: 'TREQUARTISTA CENTRALE',
                caratteristiche: ['Creativita negli spazi centrali', 'Capacita di servire gli esterni', 'Visione di gioco per cambi di lato', 'Dribbling tra le linee', 'Inserimenti coordinati'],
                importanza: 'IMPORTANTE - Deve orchestrare gli attacchi sulle fasce'
              }
            ]
          },
          {
            modulo: '3-4-3',
            efficacia: 85,
            motivo: 'Ali e esterni per dominare le fasce',
            vantaggi: ['Sei giocatori sulle fasce', 'Ampiezza totale', 'Sovraccarichi laterali'],
            tattiche: ['Attacco costante sulle fasce', 'Ali e quinti insieme', 'Cross e sovrapposizioni'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Posizionamento largo massimo', 'Velocita per puntare i terzini', 'Dribbling superiore 1vs1', 'Finalizzazione da posizione laterale', 'Movimenti dentro-fuori'],
                importanza: 'FONDAMENTALE - Devono dominare le fasce esterne'
              },
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Sovrapposizioni coordinate con le ali', 'Resistenza per doppia fase', 'Cross dal fondo', 'Capacita di creare 2vs1 o 3vs2', 'Spinta offensiva costante'],
                importanza: 'ESSENZIALE - Devono creare superioritÃ  numerica sulle fasce'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Punto di riferimento in area', 'Capacita di finalizzare cross', 'Gioco aereo dominante', 'Movimenti per liberare spazio', 'Fisicita nei duelli'],
                importanza: 'CRITICO - Deve capitalizzare i cross dalle fasce'
              }
            ]
          }
        ]
      }
    };

    return analisi[modulo] || null;
  };

  // Render condizionale autenticazione
  if (authLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-600 to-blue-900 flex items-center justify-center">
        <div className="text-center">
          <div className="text-7xl mb-4 animate-bounce">âš½</div>
          <p className="text-white text-xl">Caricamento...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return <LoginScreen />;
  }

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center">
        <div className="text-center animate-scale-up">
          <div className="text-6xl mb-6 animate-bounce">âš½</div>
          <div className="spinner mx-auto mb-4"></div>
          <div className="text-2xl font-bold text-gray-800 mb-2 animate-pulse">Caricamento dati...</div>
          <div className="text-gray-600 text-sm">Attendere prego</div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
      {/* ========== BADGE CARICAMENTO DATI (Solo durante caricamento iniziale) ========== */}
      {loadingData && (
        <div className="fixed top-4 right-4 z-40 animate-fade-in">
          <div className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
            <div className="spinner-small"></div>
            <span className="text-sm font-medium">ðŸ”„ Caricamento dati...</span>
          </div>
        </div>
      )}
      
      {/* ========== MODAL SELEZIONE DISPOSITIVO ========== */}
      {/* ========== MODAL BLOCCO ACCESSO ADMIN ========== */}
      {showAdminBlockModal && otherAdminActive && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full animate-scale-up">
            {/* Header */}
            <div className="bg-gradient-to-r from-red-600 to-red-700 p-6 rounded-t-xl">
              <div className="flex items-center gap-4">
                <div className="text-5xl">ðŸ”’</div>
                <div>
                  <h3 className="text-2xl font-bold text-white">Accesso Bloccato</h3>
                  <p className="text-red-100 text-sm mt-1">
                    Un altro admin sta lavorando
                  </p>
                </div>
              </div>
            </div>
            
            {/* Body */}
            <div className="p-6">
              {/* Info Admin Attivo */}
              <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                <div className="flex items-start gap-3">
                  <div className="text-3xl">ðŸ‘¤</div>
                  <div className="flex-1">
                    <div className="font-bold text-gray-800 text-lg mb-2">
                      {otherAdminActive.displayName || otherAdminActive.email}
                    </div>
                    <div className="space-y-1 text-sm text-gray-700">
                      <div className="flex items-center gap-2">
                        <span className="font-semibold">ðŸ“§ Email:</span>
                        <span>{otherAdminActive.email}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="font-semibold">ðŸ’» Dispositivo:</span>
                        <span>{otherAdminActive.deviceName}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="font-semibold">ðŸ• Ultimo accesso:</span>
                        <span>
                          {new Date(otherAdminActive.lastSeen).toLocaleString('it-IT', {
                            day: '2-digit',
                            month: 'short',
                            hour: '2-digit',
                            minute: '2-digit'
                          })}
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="font-semibold">â±ï¸ Attivo da:</span>
                        <span>
                          {Math.round((new Date() - new Date(otherAdminActive.lastSeen)) / 60000)} minuti fa
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Messaggio */}
              <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
                <div className="flex gap-3">
                  <div className="text-blue-600 text-2xl">â„¹ï¸</div>
                  <div className="flex-1 text-sm text-blue-900">
                    <p className="font-semibold mb-2">PerchÃ© questo blocco?</p>
                    <p>
                      Per evitare conflitti e perdita di dati, <strong>solo un admin alla volta</strong> puÃ² 
                      modificare i dati della squadra. Quando l'altro admin termina, potrai accedere automaticamente.
                    </p>
                  </div>
                </div>
              </div>
              
              {/* Opzioni */}
              <div className="space-y-3">
                {/* Attendi */}
                <button
                  onClick={handleBlockedAdminExit}
                  className="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-4 px-6 rounded-lg font-semibold transition-all hover:scale-102 shadow-lg"
                >
                  <div className="flex items-center justify-center gap-3">
                    <span className="text-2xl">ðŸ‘‹</span>
                    <span>OK, Torno PiÃ¹ Tardi (Logout)</span>
                  </div>
                </button>
                
                {/* Forza Disconnessione */}
                <button
                  onClick={forceDisconnectPreviousAdmin}
                  className="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-4 px-6 rounded-lg font-semibold transition-all hover:scale-102"
                >
                  <div className="flex items-center justify-center gap-3">
                    <span className="text-2xl">âš ï¸</span>
                    <span>Forza Disconnessione (SOLO SE SEI SICURO)</span>
                  </div>
                </button>
                
                <p className="text-xs text-center text-gray-500 mt-2">
                  âš ï¸ Usa "Forza Disconnessione" solo se sei certo che l'altro admin non sta piÃ¹ lavorando!
                </p>
              </div>
            </div>
          </div>
        </div>
      )}

      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-lg shadow-xl p-3 md:p-6 mb-6 animate-fade-in card-modern mobile-header">
          <div className="flex flex-wrap items-start gap-2 md:gap-4 mb-2">
            <div className="flex items-center gap-2 md:gap-4 flex-1 min-w-0">
              <div className="relative flex-shrink-0">
                {teamLogo ? (
                  <div className="relative group">
                    <img 
                      src={teamLogo} 
                      alt="Logo squadra" 
                      className="w-20 h-20 md:w-32 md:h-32 object-contain rounded-lg"
                    />
                    {userRole === 'admin' && (
                      <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-lg transition-all flex items-center justify-center gap-1">
                        <label className="opacity-0 group-hover:opacity-100 cursor-pointer bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition-all">
                          <input
                            type="file"
                            accept="image/*"
                            onChange={handleLogoUpload}
                            className="hidden"
                          />
                          âœï¸
                        </label>
                        <button
                          onClick={removeLogo}
                          className="opacity-0 group-hover:opacity-100 bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-all"
                        >
                          ðŸ—‘ï¸
                        </button>
                      </div>
                    )}
                  </div>
                ) : (
                  userRole === 'admin' ? (
                    <label className="w-20 h-20 md:w-32 md:h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all group">
                      <input
                        type="file"
                        accept="image/*"
                        onChange={handleLogoUpload}
                        className="hidden"
                      />
                      <div className="text-center">
                        <div className="text-2xl md:text-4xl group-hover:scale-110 transition-transform">ðŸ–¼ï¸</div>
                        <div className="text-xs text-gray-500 mt-1 hidden md:block">Logo</div>
                      </div>
                    </label>
                  ) : (
                    <div className="w-20 h-20 md:w-32 md:h-32 border-2 border-gray-300 rounded-lg flex items-center justify-center bg-gray-50">
                      <div className="text-2xl md:text-4xl text-gray-400">ðŸ–¼ï¸</div>
                    </div>
                  )
                )}
              </div>

              <div className="flex-1 min-w-0">
                {isEditingTitle ? (
                  <input
                    type="text"
                    value={appTitle}
                    onChange={(e) => setAppTitle(e.target.value)}
                    onBlur={() => setIsEditingTitle(false)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') setIsEditingTitle(false);
                    }}
                    className="text-xl md:text-3xl font-bold text-gray-800 border-2 border-blue-500 rounded px-2 py-1 w-full"
                    autoFocus
                  />
                ) : (
                  <h1 className="text-2xl md:text-4xl font-bold text-gray-800 break-words">{appTitle}</h1>
                )}
                
                {/* Campo Nome Squadra - Solo Admin */}
                {userRole === 'admin' && (
                  <div className="mt-3">
                    <label className="text-xs md:text-sm text-gray-600 mb-1 block font-semibold">
                      âš½ Scegli la tua squadra (Obbl. per calcoli corretti)
                    </label>
                    <input
                      type="text"
                      list="squadre-girone-list"
                      value={teamName}
                      onChange={(e) => setTeamName(e.target.value)}
                      placeholder="Seleziona o digita il nome della tua squadra..."
                      className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-base md:text-lg font-bold focus:border-blue-500 focus:outline-none"
                    />
                    <datalist id="squadre-girone-list">
                      {squadreGirone.map((squadra, idx) => (
                        <option key={idx} value={squadra.nome} />
                      ))}
                    </datalist>
                    
                    {/* Validazione Live */}
                    {teamName && (
                      <div className="mt-1 text-xs md:text-sm">
                        {squadreGirone.some(s => s.nome === teamName) ? (
                          <span className="text-green-600 font-semibold">âœ… Trovata in campionato</span>
                        ) : (
                          (() => {
                            // Trova match parziale intelligente
                            const teamLower = teamName.toLowerCase().trim();
                            const suggestions = squadreGirone.filter(s => {
                              const squadraLower = s.nome.toLowerCase().trim();
                              return squadraLower.includes(teamLower) || teamLower.includes(squadraLower);
                            });
                            
                            if (suggestions.length > 0) {
                              return (
                                <span className="text-orange-600">
                                  âš ï¸ Non trovata. Intendevi:{' '}
                                  {suggestions.map((s, idx) => (
                                    <button
                                      key={idx}
                                      onClick={() => setTeamName(s.nome)}
                                      className="text-blue-600 hover:underline font-semibold ml-1"
                                    >
                                      "{s.nome}"
                                    </button>
                                  ))}
                                  ?
                                </span>
                              );
                            } else {
                              return (
                                <span className="text-red-600">
                                  âŒ Non trovata nel campionato. Aggiungi prima la squadra nel girone.
                                </span>
                              );
                            }
                          })()
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>

            {/* Badge Stato Sync - Tutti gli Admin */}
            {userRole === 'admin' && (
              <div className="w-full md:w-auto mt-2 md:mt-0">
                <div className="bg-green-100 border-2 border-green-400 text-green-800 px-3 py-1 rounded-full text-xs md:text-sm font-semibold flex items-center gap-2 justify-center md:justify-start">
                  <span className="text-base md:text-lg">ðŸ”„</span>
                  <span className="hidden sm:inline">Auto-Sync Attivo</span>
                  <span className="sm:hidden">Auto</span>
                </div>
              </div>
            )}

            <div className="flex flex-wrap items-center gap-2 md:gap-3 w-full md:w-auto">
              <div className="flex flex-col gap-1 md:gap-2">
                {userRole === 'admin' && (
                  <button
                    onClick={() => setIsEditingTitle(true)}
                    className="px-2 md:px-4 py-1.5 md:py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-xs md:text-sm flex items-center gap-1 whitespace-nowrap"
                    title="Modifica titolo"
                  >
                    âœï¸ <span className="text-xs">Modifica</span>
                  </button>
                )}
                <button
                  onClick={() => setShowInstructionsModal(true)}
                  className="px-2 md:px-4 py-1.5 md:py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold whitespace-nowrap text-xs md:text-sm"
                >
                  ðŸ“– <span className="text-xs">Istruzioni</span>
                </button>
              </div>

              {/* Badge Ruolo, Logout e Chiudi App */}
              <div className="flex flex-col gap-1 md:gap-2">
                <div className={`px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold text-xs md:text-sm text-center ${
                  userRole === 'admin' 
                    ? 'bg-yellow-400 text-yellow-900' 
                    : 'bg-blue-200 text-blue-900'
                }`}>
                  {userRole === 'admin' ? 'ðŸ‘‘ ADMIN' : 'ðŸ‘ï¸ VISUALIZZATORE'}
                </div>
                
                {/* USER: Solo Logout */}
                {userRole === 'user' && (
                  <button
                    onClick={async () => {
                      try {
                        await auth.signOut();
                      } catch (error) {
                        console.error('Errore logout:', error);
                        showToast('âŒ Errore logout', 'error');
                      }
                    }}
                    className="flex items-center justify-center gap-1 md:gap-2 px-2 md:px-4 py-1.5 md:py-2 bg-orange-500 hover:bg-orange-600 rounded-lg transition-colors font-semibold text-white whitespace-nowrap text-xs md:text-sm"
                    title="Cambia utente"
                  >
                    <LogOut className="w-4 h-4 md:w-5 md:h-5" />
                    <span>Logout</span>
                  </button>
                )}
                
                {/* ADMIN: Logout + Chiudi */}
                {userRole === 'admin' && (
                  <div className="flex gap-1 md:gap-2">
                    <button
                      onClick={async () => {
                        try {
                          await auth.signOut();
                        } catch (error) {
                          console.error('Errore logout:', error);
                          showToast('âŒ Errore logout', 'error');
                        }
                      }}
                      className="flex-1 flex items-center justify-center gap-1 px-2 md:px-3 py-1.5 md:py-2 bg-orange-500 hover:bg-orange-600 rounded-lg transition-colors font-semibold text-white whitespace-nowrap text-xs md:text-sm"
                      title="Cambia utente"
                    >
                      <LogOut className="w-4 h-4" />
                      <span className="text-xs">Logout</span>
                    </button>
                    <button
                      onClick={handleLogout}
                      className="flex-1 flex items-center justify-center gap-1 px-2 md:px-3 py-1.5 md:py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors font-semibold text-white whitespace-nowrap text-xs md:text-sm"
                      title="Chiudi applicazione"
                    >
                      <span className="text-base">âœ•</span>
                      <span className="text-xs">Chiudi</span>
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
          {/* Informazioni App - Visibile anche su mobile */}
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mt-2">
            <div className="flex flex-wrap items-center gap-2">
              <p className="text-xs sm:text-sm text-gray-600">Sistema di tracciamento allenamenti, partite e statistiche</p>
              {lastSaved && (
                <span className="text-xs text-gray-500">
                  â€¢ Ultimo salvataggio: {lastSaved.toLocaleTimeString('it-IT')}
                </span>
              )}
              {/* Promemoria Backup - SOLO ADMIN */}
              {userRole === 'admin' && (() => {
                if (!lastBackupDate) {
                  return (
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ðŸ”˜ Click badge backup header - vai a export');
                        setActiveTab('backup');
                        setTimeout(() => {
                          window.scrollTo({ top: 0, behavior: 'smooth' });
                        }, 100);
                      }}
                      className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold hover:bg-orange-200 transition-colors"
                      title="Clicca per creare un backup"
                    >
                      ðŸ’¾ Consigliato: crea un backup locale
                    </button>
                  );
                }
                
                const daysSinceBackup = Math.floor((new Date() - new Date(lastBackupDate)) / (1000 * 60 * 60 * 24));
                
                if (daysSinceBackup > 7) {
                  return (
                    <button
                      onClick={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ðŸ”˜ Click badge backup header - vai a export');
                        setActiveTab('backup');
                        setTimeout(() => {
                          window.scrollTo({ top: 0, behavior: 'smooth' });
                        }, 100);
                      }}
                      className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-semibold hover:bg-yellow-200 transition-colors"
                      title={`Ultimo backup: ${daysSinceBackup} giorni fa`}
                    >
                      ðŸ’¾ Backup consigliato ogni 7gg (ultimo: {daysSinceBackup}gg fa)
                    </button>
                  );
                }
                
                return (
                  <span className="text-xs text-gray-500" title={`Ultimo backup JSON: ${new Date(lastBackupDate).toLocaleString('it-IT')}`}>
                    ðŸ’¾ Ultimo Backup locale (json): {new Date(lastBackupDate).toLocaleDateString('it-IT')} {new Date(lastBackupDate).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}
                  </span>
                );
              })()}
            </div>
          </div>
        </div>

        {/* Banner Aggiornamenti Disponibili (Compatto - Solo ADMIN) */}

        {/* Banner Sola Lettura (Compatto) */}
        {userRole === 'user' && (
          <div className="bg-blue-50 border border-blue-300 rounded-lg p-3 mb-4 animate-fade-in">
            <div className="flex items-center gap-2">
              <span className="text-blue-600 text-xl">ðŸ‘ï¸</span>
              <p className="text-sm text-blue-800 flex-1">
                <strong>ModalitÃ  Sola Lettura:</strong> Puoi vedere i dati ma non modificare
              </p>
            </div>
          </div>
        )}

        {/* Banner Promemoria Backup (Compatto - Solo ADMIN) */}
        {userRole === 'admin' && (() => {
          if (!lastBackupDate) {
            // Nessun backup mai fatto
            return (
              <div className="bg-orange-50 border border-orange-300 rounded-lg p-3 mb-4 animate-fade-in">
                <div className="flex items-center gap-2">
                  <span className="text-orange-600 text-xl flex-shrink-0">ðŸ’¾</span>
                  <p className="text-sm text-orange-800 flex-1">
                    <strong>Backup consigliato:</strong> Oltre al salvataggio automatico, crea un backup locale ogni 7gg
                  </p>
                  <button
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      console.log('ðŸ”˜ Click banner backup - vai a export');
                      setActiveTab('backup');
                      setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                      }, 100);
                    }}
                    className="text-sm md:text-xs bg-orange-600 hover:bg-orange-700 active:bg-orange-800 text-white px-4 py-2 md:px-3 md:py-1.5 rounded-lg font-semibold transition-colors whitespace-nowrap flex-shrink-0 min-h-[44px] md:min-h-0"
                    style={{ WebkitTapHighlightColor: 'transparent' }}
                  >
                    Crea â†’
                  </button>
                </div>
              </div>
            );
          }
          
          const daysSinceBackup = Math.floor((new Date() - new Date(lastBackupDate)) / (1000 * 60 * 60 * 24));
          
          if (daysSinceBackup > 7) {
            // Backup vecchio > 7 giorni
            return (
              <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mb-4 animate-fade-in">
                <div className="flex items-center gap-2">
                  <span className="text-yellow-600 text-xl flex-shrink-0">ðŸ’¾</span>
                  <p className="text-sm text-yellow-800 flex-1">
                    <strong>Backup datato:</strong> Ultimo backup {daysSinceBackup} giorni fa - consigliato ogni 7gg
                  </p>
                  <button
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      console.log('ðŸ”˜ Click banner backup - vai a export');
                      setActiveTab('backup');
                      setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                      }, 100);
                    }}
                    className="text-sm md:text-xs bg-yellow-600 hover:bg-yellow-700 active:bg-yellow-800 text-white px-4 py-2 md:px-3 md:py-1.5 rounded-lg font-semibold transition-colors whitespace-nowrap flex-shrink-0 min-h-[44px] md:min-h-0"
                    style={{ WebkitTapHighlightColor: 'transparent' }}
                  >
                    Aggiorna â†’
                  </button>
                </div>
              </div>
            );
          }
          
          // Backup OK - non mostrare nulla per non disturbare
          return null;
        })()}

        <div className="bg-white rounded-lg shadow-xl p-3 md:p-6 mb-6 animate-fade-in card-modern">
          <div className="flex gap-2 mb-4 md:mb-6 border-b overflow-x-auto tab-container">
            {[
              'dashboard', 'classifica', 'top', 'stats', 
              'trainings',
              ...(userRole === 'admin' ? ['divisione'] : []),
              ...(userRole === 'admin' ? ['matches', 'convocazioni', 'tattica'] : []),
              'calendar', 'injuries', 'roster',
              ...(userRole === 'admin' ? ['report', 'backup', 'admin', 'reset'] : [])
            ].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-3 sm:px-6 py-3 font-semibold whitespace-nowrap ripple rounded-t-lg text-sm sm:text-base flex-shrink-0 ${
                  activeTab === tab
                    ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                    : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'
                }`}
              >
                {tab === 'trainings' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ‹ï¸ Allenamenti ({trainings.length})</span>
                    <span className="tab-icon-only sm:hidden">ðŸ‹ï¸ {trainings.length}</span>
                  </>
                )}
                {tab === 'matches' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">âš½ Partite ({matches.length})</span>
                    <span className="tab-icon-only sm:hidden">âš½ {matches.length}</span>
                  </>
                )}
                {tab === 'stats' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ“Š Statistiche</span>
                    <span className="tab-icon-only sm:hidden">ðŸ“Š</span>
                  </>
                )}
                {tab === 'top' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ† Giocatori TOP</span>
                    <span className="tab-icon-only sm:hidden">ðŸ†</span>
                  </>
                )}
                {tab === 'tattica' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸŽ¯ Analisi Tattica</span>
                    <span className="tab-icon-only sm:hidden">ðŸŽ¯</span>
                  </>
                )}
                {tab === 'divisione' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">âš–ï¸ Divisione Squadre</span>
                    <span className="tab-icon-only sm:hidden">âš–ï¸</span>
                  </>
                )}
                {tab === 'convocazioni' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ“‹ Convocazioni</span>
                    <span className="tab-icon-only sm:hidden">ðŸ“‹</span>
                  </>
                )}
                {tab === 'roster' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ‘¥ Gestione Rosa</span>
                    <span className="tab-icon-only sm:hidden">ðŸ‘¥</span>
                  </>
                )}
                {tab === 'report' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ“„ Report</span>
                    <span className="tab-icon-only sm:hidden">ðŸ“„</span>
                  </>
                )}
                {tab === 'dashboard' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ“Š Dashboard</span>
                    <span className="tab-icon-only sm:hidden">ðŸ“Š</span>
                  </>
                )}
                {tab === 'classifica' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ¥‡ Classifica</span>
                    <span className="tab-icon-only sm:hidden">ðŸ¥‡</span>
                  </>
                )}
                {tab === 'injuries' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ¤• Infortuni</span>
                    <span className="tab-icon-only sm:hidden">ðŸ¤•</span>
                  </>
                )}
                {tab === 'calendar' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ“… Calendario</span>
                    <span className="tab-icon-only sm:hidden">ðŸ“…</span>
                  </>
                )}
                {tab === 'backup' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">â˜ï¸ Backup e Sync</span>
                    <span className="tab-icon-only sm:hidden">â˜ï¸</span>
                  </>
                )}
                {tab === 'admin' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ‘‘ Gestione Utenti</span>
                    <span className="tab-icon-only sm:hidden">ðŸ‘‘</span>
                  </>
                )}
                {tab === 'reset' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ðŸ”´ Reset Database</span>
                    <span className="tab-icon-only sm:hidden">ðŸ”´</span>
                  </>
                )}
              </button>
            ))}
          </div>

          {/* ============================================ */}
          {/* TAB DASHBOARD - NUOVO */}
          {/* ============================================ */}
          {activeTab === 'dashboard' && (
            <div className="animate-fade-in">
              <div className="mb-6">
                <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ“Š Dashboard Stagionale</h2>
                <p className="text-gray-600">Panoramica completa delle statistiche e andamento della stagione</p>
              </div>

              {/* Quick Stats Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-6 border-2 border-blue-200 animate-scale-up">
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl">âš½</div>
                    <div className="text-3xl font-bold text-blue-600">{matches.length}</div>
                  </div>
                  <div className="text-gray-700 font-semibold">Partite Giocate</div>
                  <div className="text-sm text-gray-600 mt-1">
                    {matches.filter(m => {
                      const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                      const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                      return golFatti > 0 || golSubiti > 0;
                    }).length} completate
                  </div>
                  <button
                    onClick={() => setShowResultsModal(true)}
                    className="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                  >
                    ðŸ“‹ Elenco Risultati
                  </button>
                </div>

                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200 animate-scale-up" style={{animationDelay: '0.1s'}}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl">ðŸƒ</div>
                    <div className="text-3xl font-bold text-green-600">{trainings.length}</div>
                  </div>
                  <div className="text-gray-700 font-semibold">Allenamenti</div>
                  <div className="text-sm text-gray-600 mt-1">
                    Media presenze: {trainings.length > 0 ? Math.round((trainings.reduce((acc, t) => {
                      const presentiCount = Object.entries(t.presenze)
                        .filter(([numero, presente]) => {
                          if (!presente) return false;
                          const player = players.find(p => p.numero === parseInt(numero));
                          if (!player || !player.nome) return false;
                          if (player.fuoriRosa) return false;
                          if (player.dataCreazione && new Date(player.dataCreazione) > new Date(t.data)) return false;
                          return true;
                        })
                        .length;
                      return acc + presentiCount;
                    }, 0) / trainings.length)) : 0}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow-lg p-6 border-2 border-yellow-200 animate-scale-up" style={{animationDelay: '0.2s'}}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl relative">
                      <span>ðŸ¥…</span>
                      <span className="absolute" style={{fontSize: '0.6em', left: '50%', top: '50%', transform: 'translate(-50%, -50%)'}}>âš½</span>
                    </div>
                    <div className="text-3xl font-bold text-yellow-600">
                      {matches.reduce((sum, m) => {
                        if (!m.golFatti) return sum;
                        return sum + Object.values(m.golFatti).reduce((s, g) => s + (parseInt(g) || 0), 0);
                      }, 0)}
                    </div>
                  </div>
                  <div className="text-gray-700 font-semibold">Gol Fatti</div>
                  <div className="text-sm text-gray-600 mt-1">
                    Media: {matches.length > 0 ? (matches.reduce((sum, m) => sum + Object.values(m.golFatti || {}).reduce((s, g) => s + (parseInt(g) || 0), 0), 0) / matches.length).toFixed(1) : 0} per partita
                  </div>
                </div>

                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-lg p-6 border-2 border-purple-200 animate-scale-up" style={{animationDelay: '0.3s'}}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl relative">
                      <span>ðŸ¥…</span>
                      <span className="absolute" style={{fontSize: '0.7em', left: '50%', top: '50%', transform: 'translate(-50%, -50%)', color: '#ef4444'}}>âŒ</span>
                    </div>
                    <div className="text-3xl font-bold text-purple-600">
                      {matches.reduce((sum, m) => {
                        if (!m.golSubiti) return sum;
                        return sum + Object.values(m.golSubiti).reduce((s, g) => s + (parseInt(g) || 0), 0);
                      }, 0)}
                    </div>
                  </div>
                  <div className="text-gray-700 font-semibold">Gol Subiti</div>
                  <div className="text-sm text-gray-600 mt-1">
                    Media: {matches.length > 0 ? (matches.reduce((sum, m) => sum + Object.values(m.golSubiti || {}).reduce((s, g) => s + (parseInt(g) || 0), 0), 0) / matches.length).toFixed(1) : 0} per partita
                  </div>
                </div>
              </div>

              {/* Grafici */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* Grafico Gol Fatti/Subiti */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“ˆ Andamento Gol</h3>
                  <canvas id="goalsChart" className="w-full" style={{maxHeight: '300px'}}></canvas>
                </div>

                {/* Grafico Risultati */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ† Risultati Partite</h3>
                  <canvas id="resultsChart" className="w-full" style={{maxHeight: '300px'}}></canvas>
                </div>

                {/* Grafico Presenze Allenamenti */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“Š Presenze Allenamenti</h3>
                  <canvas id="attendanceChart" className="w-full" style={{maxHeight: '300px'}}></canvas>
                </div>

                {/* Top Marcatori Quick View */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">âš½ Top 5 Marcatori</h3>
                  <div className="space-y-3">
                    {players
                      .map(p => ({
                        ...p,
                        gol: matches.reduce((sum, m) => sum + (parseInt(m.golFatti?.[p.numero]) || 0), 0)
                      }))
                      .filter(p => p.gol > 0)
                      .sort((a, b) => b.gol - a.gol)
                      .slice(0, 5)
                      .map((p, idx) => (
                        <div key={p.numero} className="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                          <div className="flex items-center gap-3">
                            <div className={`text-2xl font-bold ${idx === 0 ? 'text-yellow-500' : idx === 1 ? 'text-gray-400' : idx === 2 ? 'text-orange-600' : 'text-gray-600'}`}>
                              {idx + 1}Â°
                            </div>
                            {p.foto && (
                              <img src={p.foto} alt={p.nome} className="w-10 h-10 rounded-full object-cover" />
                            )}
                            <div>
                              <div className="font-semibold text-gray-800">{p.nome}</div>
                              <div className="text-sm text-gray-600">#{p.numero}</div>
                            </div>
                          </div>
                          <div className="text-2xl font-bold text-blue-600">{p.gol}</div>
                        </div>
                      ))}
                  </div>
                </div>
              </div>

              {/* Report Mensile Automatico */}
              <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">
                <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“‹ Report Mensile Automatico</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-sm text-gray-600 mb-2">Partite del Mese</div>
                    <div className="text-3xl font-bold text-gray-800">
                      {matches.filter(m => {
                        const matchDate = new Date(m.data);
                        const now = new Date();
                        return matchDate.getMonth() === now.getMonth() && matchDate.getFullYear() === now.getFullYear();
                      }).length}
                    </div>
                  </div>
                  <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-sm text-gray-600 mb-2">Allenamenti del Mese</div>
                    <div className="text-3xl font-bold text-gray-800">
                      {trainings.filter(t => {
                        const trainDate = new Date(t.data);
                        const now = new Date();
                        return trainDate.getMonth() === now.getMonth() && trainDate.getFullYear() === now.getFullYear();
                      }).length}
                    </div>
                  </div>
                  <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-sm text-gray-600 mb-2">Gol del Mese</div>
                    <div className="text-3xl font-bold text-gray-800">
                      {matches
                        .filter(m => {
                          const matchDate = new Date(m.data);
                          const now = new Date();
                          return matchDate.getMonth() === now.getMonth() && matchDate.getFullYear() === now.getFullYear();
                        })
                        .reduce((sum, m) => sum + Object.values(m.golFatti || {}).reduce((s, g) => s + (parseInt(g) || 0), 0), 0)}
                    </div>
                  </div>
                </div>
              </div>

              {/* Classifica MVP (Man of the Match) */}
              <div className="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg shadow-lg p-6 border-2 border-yellow-200 mt-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                      ðŸ† Man of the Match - Classifica Stagionale
                    </h3>
                    <p className="text-sm text-gray-600 mt-1">
                      I giocatori che hanno vinto piÃ¹ volte il premio MVP
                    </p>
                  </div>
                  <div className="text-3xl">â­</div>
                </div>
                
                {(() => {
                  const leaderboard = getMVPLeaderboard();
                  
                  if (leaderboard.length === 0) {
                    return (
                      <div className="text-center py-8 text-gray-500">
                        <div className="text-4xl mb-2">ðŸ†</div>
                        <p>Nessun MVP assegnato ancora</p>
                        <p className="text-sm mt-2">Vota il migliore in campo dopo ogni partita!</p>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="space-y-3">
                      {leaderboard.map((entry, idx) => (
                        <div 
                          key={entry.playerNum}
                          className={`flex items-center justify-between rounded-lg p-4 transition-all hover:scale-102 ${
                            idx === 0 
                              ? 'bg-gradient-to-r from-yellow-100 to-amber-100 border-2 border-yellow-400 shadow-md'
                              : idx === 1
                              ? 'bg-gradient-to-r from-gray-100 to-slate-100 border-2 border-gray-300'
                              : idx === 2
                              ? 'bg-gradient-to-r from-orange-100 to-amber-100 border-2 border-orange-300'
                              : 'bg-white border-2 border-gray-200'
                          }`}
                        >
                          <div className="flex items-center gap-4">
                            <div className={`text-3xl font-bold ${
                              idx === 0 ? 'text-yellow-600' : 
                              idx === 1 ? 'text-gray-500' : 
                              idx === 2 ? 'text-orange-600' : 
                              'text-gray-600'
                            }`}>
                              {idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : `${idx + 1}Â°`}
                            </div>
                            
                            {entry.playerPhoto ? (
                              <img 
                                src={entry.playerPhoto} 
                                alt={entry.playerName}
                                className="w-16 h-16 rounded-full object-cover border-2 border-white shadow-md"
                              />
                            ) : (
                              <div className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center border-2 border-white shadow-md">
                                <span className="text-2xl font-bold text-gray-500">
                                  {entry.playerNum}
                                </span>
                              </div>
                            )}
                            
                            <div>
                              <div className="font-bold text-gray-800 text-lg">
                                {entry.playerName}
                              </div>
                              <div className="text-sm text-gray-600">
                                #{entry.playerNum}
                              </div>
                            </div>
                          </div>
                          
                          <div className="flex items-center gap-3">
                            <div className="text-right">
                              <div className="text-3xl font-bold text-yellow-600">
                                {entry.mvpCount}
                              </div>
                              <div className="text-sm text-gray-600">
                                {entry.mvpCount === 1 ? 'MVP' : 'MVP'}
                              </div>
                            </div>
                            <div className="text-3xl">
                              {idx === 0 ? 'ðŸŒŸ' : 'â­'}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  );
                })()}
              </div>
            </div>
          )}

          {/* ========== SEZIONE CLASSIFICA CAMPIONATO ========== */}
          {activeTab === 'classifica' && (
            <div className="animate-fade-in">
              <div className="mb-6">
                <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ¥‡ Classifica Campionato</h2>
                <p className="text-gray-600">Gestisci squadre, risultati e visualizza la classifica del girone</p>
              </div>

              {/* Quick Stats */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow p-4 border-2 border-blue-200">
                  <div className="text-3xl font-bold text-blue-600">{squadreGirone.length}</div>
                  <div className="text-sm text-gray-700 font-semibold">Squadre</div>
                </div>
                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow p-4 border-2 border-green-200">
                  <div className="text-3xl font-bold text-green-600">
                    {risultatiCampionato.reduce((sum, g) => sum + g.partite.filter(p => p.giocata).length, 0)}
                  </div>
                  <div className="text-sm text-gray-700 font-semibold">Partite Giocate</div>
                </div>
                <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow p-4 border-2 border-yellow-200">
                  <div className="text-3xl font-bold text-yellow-600">
                    {risultatiCampionato.reduce((sum, g) => sum + g.partite.reduce((s, p) => 
                      s + (p.giocata ? (parseInt(p.golCasa) || 0) + (parseInt(p.golTrasferta) || 0) : 0), 0), 0)}
                  </div>
                  <div className="text-sm text-gray-700 font-semibold">Gol Totali</div>
                </div>
                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow p-4 border-2 border-purple-200">
                  <div className="text-3xl font-bold text-purple-600">{risultatiCampionato.length}</div>
                  <div className="text-sm text-gray-700 font-semibold">Giornate</div>
                </div>
              </div>

              {/* Sub-tabs */}
              <div className="flex gap-2 mb-6 border-b">
                <button
                  onClick={() => setClassificaTab('classifica')}
                  className={`px-6 py-3 font-semibold ${
                    classificaTab === 'classifica'
                      ? 'text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:text-blue-600'
                  }`}
                >
                  ðŸ“Š Classifica
                </button>
                <button
                  onClick={() => setClassificaTab('statistiche')}
                  className={`px-6 py-3 font-semibold ${
                    classificaTab === 'statistiche'
                      ? 'text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:text-blue-600'
                  }`}
                >
                  ðŸ“ˆ Statistiche
                </button>
                <button
                  onClick={() => setClassificaTab('risultati')}
                  className={`px-6 py-3 font-semibold ${
                    classificaTab === 'risultati'
                      ? 'text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:text-blue-600'
                  }`}
                >
                  âš½ Risultati
                </button>
                <button
                  onClick={() => setClassificaTab('squadre')}
                  className={`px-6 py-3 font-semibold ${
                    classificaTab === 'squadre'
                      ? 'text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:text-blue-600'
                  }`}
                >
                  ðŸ‘¥ Squadre
                </button>
              </div>

              {/* FINE PARTE 1 - Continua nella prossima sostituzione */}

              {/* TAB CLASSIFICA */}
              {classificaTab === 'classifica' && (
                <div className="bg-white rounded-lg shadow-lg p-6">
                  {/* Bottone Export PDF */}
                  {squadreGirone.length > 0 && (
                    <div className="mb-4 flex justify-end">
                      <button
                        onClick={() => {
                          // Funzione export PDF - implementata dopo
                          exportClassificaPDF();
                        }}
                        className="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 flex items-center gap-2"
                      >
                        ðŸ“„ Esporta PDF
                      </button>
                    </div>
                  )}
                  
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b-2">
                          <th className="p-3 text-left">Pos</th>
                          <th className="p-3 text-left">Squadra</th>
                          <th className="p-3 text-center">Pt</th>
                          <th className="p-3 text-center hidden md:table-cell classifica-col-giocate">G</th>
                          <th className="p-3 text-center classifica-col-risultati">V</th>
                          <th className="p-3 text-center classifica-col-risultati">P</th>
                          <th className="p-3 text-center classifica-col-risultati">S</th>
                          <th className="p-3 text-center classifica-col-gol">GF</th>
                          <th className="p-3 text-center classifica-col-gol">GS</th>
                          <th className="p-3 text-center classifica-col-gol">DR</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(() => {
                          // Calcolo classifica
                          const classifica = squadreGirone.map(sq => {
                            let punti = 0, giocate = 0, vinte = 0, pareggiate = 0, perse = 0, golFatti = 0, golSubiti = 0;
                            
                            risultatiCampionato.forEach(giornata => {
                              giornata.partite.forEach(partita => {
                                if (!partita.giocata) return;  // Solo partite giocate
                                
                                const golCasa = parseInt(partita.golCasa) || 0;
                                const golTrasferta = parseInt(partita.golTrasferta) || 0;
                                
                                if (partita.squadraCasa === sq.nome) {
                                  giocate++;
                                  golFatti += golCasa;
                                  golSubiti += golTrasferta;
                                  if (golCasa > golTrasferta) {
                                    punti += 3;
                                    vinte++;
                                  } else if (golCasa === golTrasferta) {
                                    punti += 1;
                                    pareggiate++;
                                  } else {
                                    perse++;
                                  }
                                } else if (partita.squadraTrasferta === sq.nome) {
                                  giocate++;
                                  golFatti += golTrasferta;
                                  golSubiti += golCasa;
                                  if (golTrasferta > golCasa) {
                                    punti += 3;
                                    vinte++;
                                  } else if (golTrasferta === golCasa) {
                                    punti += 1;
                                    pareggiate++;
                                  } else {
                                    perse++;
                                  }
                                }
                              });
                            });
                            
                            return { ...sq, punti, giocate, vinte, pareggiate, perse, golFatti, golSubiti, diffReti: golFatti - golSubiti };
                          }).sort((a, b) => {
                            if (b.punti !== a.punti) return b.punti - a.punti;
                            if (b.diffReti !== a.diffReti) return b.diffReti - a.diffReti;
                            return b.golFatti - a.golFatti;
                          });
                          
                          if (classifica.length === 0) {
                            return (
                              <tr>
                                <td colSpan="10" className="p-8 text-center text-gray-500">
                                  <div className="text-4xl mb-2">ðŸ†</div>
                                  <p>Nessuna squadra inserita</p>
                                  <p className="text-sm mt-2">Vai su "ðŸ‘¥ Squadre" per aggiungere le squadre del girone</p>
                                </td>
                              </tr>
                            );
                          }
                          
                          return classifica.map((sq, idx) => (
                            <tr key={sq.id} className={`border-b hover:bg-gray-50 ${idx === 0 ? 'bg-yellow-50' : idx <= 2 ? 'bg-blue-50' : idx >= classifica.length - 2 ? 'bg-red-50' : ''}`}>
                              <td className="p-3 font-bold">
                                {idx === 0 && 'ðŸ¥‡'}
                                {idx === 1 && 'ðŸ¥ˆ'}
                                {idx === 2 && 'ðŸ¥‰'}
                                {idx >= 3 && (idx + 1)}
                              </td>
                              <td className="p-3 font-semibold">{sq.nome}</td>
                              <td className="p-3 text-center font-bold text-lg">{sq.punti}</td>
                              <td className="p-3 text-center hidden md:table-cell classifica-col-giocate">{sq.giocate}</td>
                              <td className="p-3 text-center classifica-col-risultati">{sq.vinte}</td>
                              <td className="p-3 text-center classifica-col-risultati">{sq.pareggiate}</td>
                              <td className="p-3 text-center classifica-col-risultati">{sq.perse}</td>
                              <td className="p-3 text-center classifica-col-gol">{sq.golFatti}</td>
                              <td className="p-3 text-center classifica-col-gol">{sq.golSubiti}</td>
                              <td className="p-3 text-center font-semibold classifica-col-gol">{sq.diffReti > 0 ? '+' : ''}{sq.diffReti}</td>
                            </tr>
                          ));
                        })()}
                      </tbody>
                    </table>
                  </div>
                  
                  {squadreGirone.length > 0 && (
                    <div className="mt-4 text-sm text-gray-600">
                      <p><strong>Legenda:</strong></p>
                      <p>Pt = Punti | G = Giocate | V = Vittorie | P = Pareggi | S = Sconfitte</p>
                      <p>GF = Gol Fatti | GS = Gol Subiti | DR = Differenza Reti</p>
                      <p className="mt-2">ðŸ¥‡ Primo | ðŸ¥ˆðŸ¥‰ Podio | ðŸ”´ Zona retrocessione</p>
                    </div>
                  )}
                </div>
              )}

              {/* TAB STATISTICHE */}
              {classificaTab === 'statistiche' && (
                <div className="bg-white rounded-lg shadow-lg p-6">
                  {squadreGirone.length === 0 || !risultatiCampionato.some(g => g.partite.some(p => p.giocata)) ? (
                    <div className="text-center py-12">
                      <div className="text-6xl mb-4">ðŸ“Š</div>
                      <h3 className="text-xl font-bold text-gray-800 mb-2">Nessuna statistica disponibile</h3>
                      <p className="text-gray-600">Inserisci squadre e risultati per vedere le statistiche</p>
                    </div>
                  ) : (
                    <>
                      {/* Sub-sub-tabs Statistiche */}
                      <div className="flex gap-2 mb-6 border-b">
                        <button
                          onClick={() => setStatsSubTab('overview')}
                          className={`px-4 py-2 font-semibold text-sm ${
                            statsSubTab === 'overview'
                              ? 'text-blue-600 border-b-2 border-blue-600'
                              : 'text-gray-600 hover:text-blue-600'
                          }`}
                        >
                          ðŸ“Š Overview
                        </button>
                        <button
                          onClick={() => setStatsSubTab('dettagli')}
                          className={`px-4 py-2 font-semibold text-sm ${
                            statsSubTab === 'dettagli'
                              ? 'text-blue-600 border-b-2 border-blue-600'
                              : 'text-gray-600 hover:text-blue-600'
                          }`}
                        >
                          ðŸ“ˆ Dettagli
                        </button>
                        <button
                          onClick={() => setStatsSubTab('record')}
                          className={`px-4 py-2 font-semibold text-sm ${
                            statsSubTab === 'record'
                              ? 'text-blue-600 border-b-2 border-blue-600'
                              : 'text-gray-600 hover:text-blue-600'
                          }`}
                        >
                          ðŸ† Record
                        </button>
                      </div>

                      {/* OVERVIEW - 4 card esistenti */}
                      {statsSubTab === 'overview' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg p-4 border-2 border-yellow-200">
                        <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                          âš½ Miglior Attacco
                        </h4>
                        {(() => {
                          // Calcola gol per squadra
                          const golPerSquadra = {};
                          risultatiCampionato.forEach(giornata => {
                            giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                                            if (!golPerSquadra[partita.squadraCasa]) golPerSquadra[partita.squadraCasa] = 0;
                              if (!golPerSquadra[partita.squadraTrasferta]) golPerSquadra[partita.squadraTrasferta] = 0;
                              golPerSquadra[partita.squadraCasa] += partita.golCasa;
                              golPerSquadra[partita.squadraTrasferta] += partita.golTrasferta;
                            });
                          });
                          
                          const topScorer = Object.entries(golPerSquadra)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3);
                          
                          return (
                            <div className="space-y-2">
                              {topScorer.map(([squadra, gol], idx) => (
                                <div key={squadra} className="flex justify-between items-center">
                                  <span className="font-semibold">
                                    {idx === 0 && 'ðŸ¥‡ '}
                                    {idx === 1 && 'ðŸ¥ˆ '}
                                    {idx === 2 && 'ðŸ¥‰ '}
                                    {squadra}
                                  </span>
                                  <span className="text-2xl font-bold text-yellow-600">{gol} gol</span>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                      
                      <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-200">
                        <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                          ðŸ›¡ï¸ Miglior Difesa
                        </h4>
                        {(() => {
                          // Calcola gol subiti per squadra
                          const golSubitiPerSquadra = {};
                          risultatiCampionato.forEach(giornata => {
                            giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                                            if (!golSubitiPerSquadra[partita.squadraCasa]) golSubitiPerSquadra[partita.squadraCasa] = 0;
                              if (!golSubitiPerSquadra[partita.squadraTrasferta]) golSubitiPerSquadra[partita.squadraTrasferta] = 0;
                              golSubitiPerSquadra[partita.squadraCasa] += partita.golTrasferta;
                              golSubitiPerSquadra[partita.squadraTrasferta] += partita.golCasa;
                            });
                          });
                          
                          const bestDefense = Object.entries(golSubitiPerSquadra)
                            .sort((a, b) => a[1] - b[1])
                            .slice(0, 3);
                          
                          return (
                            <div className="space-y-2">
                              {bestDefense.map(([squadra, gol], idx) => (
                                <div key={squadra} className="flex justify-between items-center">
                                  <span className="font-semibold">
                                    {idx === 0 && 'ðŸ¥‡ '}
                                    {idx === 1 && 'ðŸ¥ˆ '}
                                    {idx === 2 && 'ðŸ¥‰ '}
                                    {squadra}
                                  </span>
                                  <span className="text-2xl font-bold text-green-600">{gol} subiti</span>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                      
                      <div className="bg-gradient-to-br from-blue-50 to-sky-50 rounded-lg p-4 border-2 border-blue-200">
                        <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                          ðŸ  Rendimento Casa
                        </h4>
                        {(() => {
                          // Calcola punti in casa per squadra
                          const puntiCasa = {};
                          risultatiCampionato.forEach(giornata => {
                            giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                                            if (!puntiCasa[partita.squadraCasa]) puntiCasa[partita.squadraCasa] = 0;
                              if (partita.golCasa > partita.golTrasferta) puntiCasa[partita.squadraCasa] += 3;
                              else if (partita.golCasa === partita.golTrasferta) puntiCasa[partita.squadraCasa] += 1;
                            });
                          });
                          
                          const topCasa = Object.entries(puntiCasa)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3);
                          
                          return (
                            <div className="space-y-2">
                              {topCasa.map(([squadra, punti], idx) => (
                                <div key={squadra} className="flex justify-between items-center">
                                  <span className="font-semibold">
                                    {idx === 0 && 'ðŸ¥‡ '}
                                    {idx === 1 && 'ðŸ¥ˆ '}
                                    {idx === 2 && 'ðŸ¥‰ '}
                                    {squadra}
                                  </span>
                                  <span className="text-2xl font-bold text-blue-600">{punti} pt</span>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                      
                      <div className="bg-gradient-to-br from-purple-50 to-violet-50 rounded-lg p-4 border-2 border-purple-200">
                        <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                          ðŸšŒ Rendimento Trasferta
                        </h4>
                        {(() => {
                          // Calcola punti in trasferta per squadra
                          const puntiTrasferta = {};
                          risultatiCampionato.forEach(giornata => {
                            giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                                            if (!puntiTrasferta[partita.squadraTrasferta]) puntiTrasferta[partita.squadraTrasferta] = 0;
                              if (partita.golTrasferta > partita.golCasa) puntiTrasferta[partita.squadraTrasferta] += 3;
                              else if (partita.golTrasferta === partita.golCasa) puntiTrasferta[partita.squadraTrasferta] += 1;
                            });
                          });
                          
                          const topTrasferta = Object.entries(puntiTrasferta)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3);
                          
                          return (
                            <div className="space-y-2">
                              {topTrasferta.map(([squadra, punti], idx) => (
                                <div key={squadra} className="flex justify-between items-center">
                                  <span className="font-semibold">
                                    {idx === 0 && 'ðŸ¥‡ '}
                                    {idx === 1 && 'ðŸ¥ˆ '}
                                    {idx === 2 && 'ðŸ¥‰ '}
                                    {squadra}
                                  </span>
                                  <span className="text-2xl font-bold text-purple-600">{punti} pt</span>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  )}

              {/* DETTAGLI - Form ultimi 5 + Clean sheet */}
              {statsSubTab === 'dettagli' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  {/* CARD 1: FORM ULTIMI 5 MATCH */}
                  <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border-2 border-blue-200">
                    <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                      ðŸ”¥ Form Ultimi 5 Match
                    </h4>
                    {(() => {
                      // Calcola classifica completa per prendere Real DOR
                      const classifica = squadreGirone.map(sq => {
                        let punti = 0, vinte = 0, pareggiate = 0, perse = 0;
                        const risultati = [];
                        
                        risultatiCampionato.forEach(giornata => {
                          giornata.partite.forEach(partita => {
                            if (!partita.giocata) return;
                            
                            const golCasa = parseInt(partita.golCasa) || 0;
                            const golTrasferta = parseInt(partita.golTrasferta) || 0;
                            
                            if (partita.squadraCasa === sq.nome) {
                              if (golCasa > golTrasferta) {
                                punti += 3;
                                vinte++;
                                risultati.push('V');
                              } else if (golCasa === golTrasferta) {
                                punti += 1;
                                pareggiate++;
                                risultati.push('P');
                              } else {
                                perse++;
                                risultati.push('S');
                              }
                            } else if (partita.squadraTrasferta === sq.nome) {
                              if (golTrasferta > golCasa) {
                                punti += 3;
                                vinte++;
                                risultati.push('V');
                              } else if (golTrasferta === golCasa) {
                                punti += 1;
                                pareggiate++;
                                risultati.push('P');
                              } else {
                                perse++;
                                risultati.push('S');
                              }
                            }
                          });
                        });
                        
                        return { ...sq, punti, vinte, pareggiate, perse, risultati };
                      }).sort((a, b) => b.punti - a.punti);
                      
                      // Prendi le prime 3 squadre
                      const top3 = classifica.slice(0, 3);
                      
                      return (
                        <div className="space-y-3">
                          {top3.map((squadra) => {
                            const ultimi5 = squadra.risultati.slice(-5);
                            const puntiUltimi5 = ultimi5.reduce((sum, r) => 
                              sum + (r === 'V' ? 3 : r === 'P' ? 1 : 0), 0
                            );
                            
                            // Calcola trend
                            let trend = 'â†’';
                            let trendColor = 'text-gray-600';
                            if (puntiUltimi5 >= 12) {
                              trend = 'ðŸ“ˆ';
                              trendColor = 'text-green-600';
                            } else if (puntiUltimi5 <= 6) {
                              trend = 'ðŸ“‰';
                              trendColor = 'text-red-600';
                            }
                            
                            // Calcola serie attuale
                            let serieAttuale = 0;
                            let tipoSerie = '';
                            if (ultimi5.length > 0) {
                              const ultimo = ultimi5[ultimi5.length - 1];
                              for (let i = ultimi5.length - 1; i >= 0; i--) {
                                if (ultimi5[i] === ultimo) {
                                  serieAttuale++;
                                } else break;
                              }
                              tipoSerie = ultimo === 'V' ? 'vittorie' : ultimo === 'P' ? 'pareggi' : 'sconfitte';
                            }
                            
                            return (
                              <div key={squadra.id} className="bg-white rounded p-3 border border-blue-200">
                                <div className="font-semibold text-gray-800 mb-2">{squadra.nome}</div>
                                <div className="flex items-center gap-2 mb-2">
                                  {ultimi5.map((r, idx) => (
                                    <span
                                      key={idx}
                                      className={`w-8 h-8 flex items-center justify-center rounded font-bold text-sm ${
                                        r === 'V' ? 'bg-green-500 text-white' :
                                        r === 'P' ? 'bg-yellow-500 text-white' :
                                        'bg-red-500 text-white'
                                      }`}
                                    >
                                      {r}
                                    </span>
                                  ))}
                                  <span className={`text-2xl ml-2 ${trendColor}`}>{trend}</span>
                                </div>
                                <div className="text-xs text-gray-600">
                                  <div>Ultimi 5: {ultimi5.filter(r => r === 'V').length}V {ultimi5.filter(r => r === 'P').length}P {ultimi5.filter(r => r === 'S').length}S ({puntiUltimi5} punti)</div>
                                  {serieAttuale > 1 && (
                                    <div className="font-semibold text-blue-600 mt-1">
                                      Serie attuale: {serieAttuale} {tipoSerie} {serieAttuale >= 3 ? 'ðŸ”¥' : ''}
                                    </div>
                                  )}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      );
                    })()}
                  </div>
                  
                  {/* CARD 2: CLEAN SHEET & MEDIE */}
                  <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-200">
                    <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                      ðŸ›¡ï¸ Clean Sheet & Medie
                    </h4>
                    {(() => {
                      // Calcola statistiche dettagliate per ogni squadra
                      const stats = squadreGirone.map(sq => {
                        let giocate = 0, golFatti = 0, golSubiti = 0, cleanSheet = 0;
                        
                        risultatiCampionato.forEach(giornata => {
                          giornata.partite.forEach(partita => {
                            if (!partita.giocata) return;
                            
                            const golCasa = parseInt(partita.golCasa) || 0;
                            const golTrasferta = parseInt(partita.golTrasferta) || 0;
                            
                            if (partita.squadraCasa === sq.nome) {
                              giocate++;
                              golFatti += golCasa;
                              golSubiti += golTrasferta;
                              if (golTrasferta === 0) cleanSheet++;
                            } else if (partita.squadraTrasferta === sq.nome) {
                              giocate++;
                              golFatti += golTrasferta;
                              golSubiti += golCasa;
                              if (golCasa === 0) cleanSheet++;
                            }
                          });
                        });
                        
                        return {
                          nome: sq.nome,
                          giocate,
                          golFatti,
                          golSubiti,
                          cleanSheet,
                          mediaGolFatti: giocate > 0 ? (golFatti / giocate).toFixed(1) : 0,
                          mediaGolSubiti: giocate > 0 ? (golSubiti / giocate).toFixed(1) : 0,
                          cleanSheetPerc: giocate > 0 ? ((cleanSheet / giocate) * 100).toFixed(0) : 0,
                          diffReti: golFatti - golSubiti
                        };
                      }).sort((a, b) => b.diffReti - a.diffReti);
                      
                      const top3 = stats.slice(0, 3);
                      
                      return (
                        <div className="space-y-3">
                          {top3.map((squadra, idx) => (
                            <div key={squadra.nome} className="bg-white rounded p-3 border border-green-200">
                              <div className="flex items-center justify-between mb-2">
                                <span className="font-semibold text-gray-800">
                                  {idx === 0 && 'ðŸ¥‡ '}
                                  {idx === 1 && 'ðŸ¥ˆ '}
                                  {idx === 2 && 'ðŸ¥‰ '}
                                  {squadra.nome}
                                </span>
                              </div>
                              <div className="grid grid-cols-2 gap-2 text-xs">
                                <div className="bg-green-100 rounded p-2">
                                  <div className="text-gray-600">Porte inviolate</div>
                                  <div className="font-bold text-green-600">
                                    {squadra.cleanSheet}/{squadra.giocate} ({squadra.cleanSheetPerc}%)
                                  </div>
                                </div>
                                <div className="bg-blue-100 rounded p-2">
                                  <div className="text-gray-600">Media gol fatti</div>
                                  <div className="font-bold text-blue-600">{squadra.mediaGolFatti}/partita</div>
                                </div>
                                <div className="bg-yellow-100 rounded p-2">
                                  <div className="text-gray-600">Media gol subiti</div>
                                  <div className="font-bold text-yellow-600">{squadra.mediaGolSubiti}/partita</div>
                                </div>
                                <div className="bg-purple-100 rounded p-2">
                                  <div className="text-gray-600">Goal difference</div>
                                  <div className="font-bold text-purple-600">
                                    {squadra.diffReti > 0 ? '+' : ''}{squadra.diffReti}
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      );
                    })()}
                  </div>
                  
                </div>
              )}

              {/* RECORD - Record & Primati + Grafico */}
              {statsSubTab === 'record' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  {/* CARD 3: RECORD & PRIMATI */}
                  <div className="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg p-4 border-2 border-yellow-200">
                    <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                      ðŸ† Record & Primati
                    </h4>
                    {(() => {
                      // Calcola record del campionato
                      let vittoriaPiuLarga = { squadra: '', margine: 0, risultato: '' };
                      let piuGolInPartita = { squadra: '', gol: 0, risultato: '' };
                      let capocannoniere = {};
                      
                      risultatiCampionato.forEach(giornata => {
                        giornata.partite.forEach(partita => {
                          if (!partita.giocata) return;
                          
                          const golCasa = parseInt(partita.golCasa) || 0;
                          const golTrasferta = parseInt(partita.golTrasferta) || 0;
                          
                          // Vittoria piÃ¹ larga (SOLO VITTORIE, non sconfitte)
                          const margineCasa = golCasa - golTrasferta;
                          const margineTrasferta = golTrasferta - golCasa;
                          
                          if (margineCasa > 0 && margineCasa > vittoriaPiuLarga.margine) {
                            vittoriaPiuLarga = {
                              squadra: partita.squadraCasa,
                              margine: margineCasa,
                              risultato: `${golCasa}-${golTrasferta} vs ${partita.squadraTrasferta}`
                            };
                          }
                          if (margineTrasferta > 0 && margineTrasferta > vittoriaPiuLarga.margine) {
                            vittoriaPiuLarga = {
                              squadra: partita.squadraTrasferta,
                              margine: margineTrasferta,
                              risultato: `${golTrasferta}-${golCasa} vs ${partita.squadraCasa}`
                            };
                          }
                          
                          // PiÃ¹ gol in partita (singola squadra)
                          if (golCasa > piuGolInPartita.gol) {
                            piuGolInPartita = {
                              squadra: partita.squadraCasa,
                              gol: golCasa,
                              risultato: `${golCasa}-${golTrasferta} vs ${partita.squadraTrasferta}`
                            };
                          }
                          if (golTrasferta > piuGolInPartita.gol) {
                            piuGolInPartita = {
                              squadra: partita.squadraTrasferta,
                              gol: golTrasferta,
                              risultato: `${golTrasferta}-${golCasa} vs ${partita.squadraCasa}`
                            };
                          }
                          
                          // Capocannoniere squadre
                          if (!capocannoniere[partita.squadraCasa]) capocannoniere[partita.squadraCasa] = 0;
                          if (!capocannoniere[partita.squadraTrasferta]) capocannoniere[partita.squadraTrasferta] = 0;
                          capocannoniere[partita.squadraCasa] += golCasa;
                          capocannoniere[partita.squadraTrasferta] += golTrasferta;
                        });
                      });
                      
                      // Serie migliore (piÃ¹ vittorie consecutive)
                      // METODO CORRETTO: crea array cronologico per ogni squadra
                      let serieMigliore = { squadra: '', vittorie: 0 };
                      
                      squadreGirone.forEach(sq => {
                        // Raccogli TUTTE le partite della squadra in ordine cronologico
                        const partiteSquadra = [];
                        
                        risultatiCampionato.forEach(giornata => {
                          giornata.partite.forEach(partita => {
                            if (!partita.giocata) return;
                            
                            const golCasa = parseInt(partita.golCasa) || 0;
                            const golTrasferta = parseInt(partita.golTrasferta) || 0;
                            
                            if (partita.squadraCasa === sq.nome) {
                              partiteSquadra.push({
                                giornata: giornata.giornata,
                                vinto: golCasa > golTrasferta,
                                pareggio: golCasa === golTrasferta,
                                perso: golCasa < golTrasferta
                              });
                            } else if (partita.squadraTrasferta === sq.nome) {
                              partiteSquadra.push({
                                giornata: giornata.giornata,
                                vinto: golTrasferta > golCasa,
                                pareggio: golTrasferta === golCasa,
                                perso: golTrasferta < golCasa
                              });
                            }
                          });
                        });
                        
                        // Ora conta le vittorie consecutive sull'array ordinato
                        let serieCorrente = 0;
                        let serieMax = 0;
                        
                        partiteSquadra.forEach(partita => {
                          if (partita.vinto) {
                            serieCorrente++;
                            if (serieCorrente > serieMax) {
                              serieMax = serieCorrente;
                            }
                          } else {
                            serieCorrente = 0;
                          }
                        });
                        
                        if (serieMax > serieMigliore.vittorie) {
                          serieMigliore = { squadra: sq.nome, vittorie: serieMax };
                        }
                      });
                      
                      const topGoleador = Object.entries(capocannoniere)
                        .sort((a, b) => b[1] - a[1])[0];
                      
                      return (
                        <div className="space-y-3">
                          <div className="bg-white rounded p-3 border border-yellow-200">
                            <div className="text-xs text-gray-600 mb-1">ðŸŽ¯ Vittoria piÃ¹ larga</div>
                            <div className="font-bold text-gray-800">{vittoriaPiuLarga.squadra}</div>
                            <div className="text-sm text-gray-600">{vittoriaPiuLarga.risultato}</div>
                          </div>
                          
                          <div className="bg-white rounded p-3 border border-yellow-200">
                            <div className="text-xs text-gray-600 mb-1">âš½ PiÃ¹ gol in una partita</div>
                            <div className="font-bold text-gray-800">{piuGolInPartita.squadra} - {piuGolInPartita.gol} gol</div>
                            <div className="text-sm text-gray-600">{piuGolInPartita.risultato}</div>
                          </div>
                          
                          <div className="bg-white rounded p-3 border border-yellow-200">
                            <div className="text-xs text-gray-600 mb-1">ðŸ”¥ Miglior serie di vittorie</div>
                            <div className="font-bold text-gray-800">{serieMigliore.squadra}</div>
                            <div className="text-sm text-gray-600">{serieMigliore.vittorie} vittorie consecutive</div>
                          </div>
                          
                          {topGoleador && (
                            <div className="bg-white rounded p-3 border border-yellow-200">
                              <div className="text-xs text-gray-600 mb-1">ðŸ‘Ÿ Squadra piÃ¹ prolifica</div>
                              <div className="font-bold text-gray-800">{topGoleador[0]}</div>
                              <div className="text-sm text-gray-600">{topGoleador[1]} gol totali</div>
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                  
                  {/* CARD 4: GRAFICO ANDAMENTO PUNTI */}
                  <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-4 border-2 border-purple-200">
                    <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                      ðŸ“ˆ Andamento Punti
                    </h4>
                    {(() => {
                      // Calcola andamento punti per le prime 3 squadre
                      const classifica = squadreGirone.map(sq => {
                        let puntiTotali = 0;
                        const andamento = [];
                        
                        risultatiCampionato.forEach(giornata => {
                          let puntiGiornata = 0;
                          
                          giornata.partite.forEach(partita => {
                            if (!partita.giocata) return;
                            
                            const golCasa = parseInt(partita.golCasa) || 0;
                            const golTrasferta = parseInt(partita.golTrasferta) || 0;
                            
                            if (partita.squadraCasa === sq.nome) {
                              if (golCasa > golTrasferta) puntiGiornata += 3;
                              else if (golCasa === golTrasferta) puntiGiornata += 1;
                            } else if (partita.squadraTrasferta === sq.nome) {
                              if (golTrasferta > golCasa) puntiGiornata += 3;
                              else if (golTrasferta === golCasa) puntiGiornata += 1;
                            }
                          });
                          
                          if (puntiGiornata > 0 || giornata.partite.some(p => 
                            p.giocata && (p.squadraCasa === sq.nome || p.squadraTrasferta === sq.nome)
                          )) {
                            puntiTotali += puntiGiornata;
                            andamento.push({ giornata: giornata.giornata, punti: puntiTotali });
                          }
                        });
                        
                        return { nome: sq.nome, andamento, puntiTotali };
                      }).sort((a, b) => b.puntiTotali - a.puntiTotali);
                      
                      const top3 = classifica.slice(0, 3);
                      const maxPunti = Math.max(...top3.flatMap(s => s.andamento.map(a => a.punti)));
                      const colors = ['#3b82f6', '#10b981', '#f59e0b'];
                      
                      // Calcola trend (ultimi 3 vs primi 3 giornate)
                      const getTrend = (andamento) => {
                        if (andamento.length < 6) return { text: 'â†’', color: 'text-gray-600' };
                        const primi3 = andamento.slice(0, 3).reduce((sum, a, i, arr) => 
                          sum + (i > 0 ? a.punti - arr[i-1].punti : a.punti), 0
                        );
                        const ultimi3 = andamento.slice(-3).reduce((sum, a, i, arr) => 
                          sum + (i > 0 ? a.punti - arr[i-1].punti : 0), 0
                        );
                        
                        if (ultimi3 > primi3 + 2) return { text: 'ðŸ“ˆ In crescita', color: 'text-green-600' };
                        if (ultimi3 < primi3 - 2) return { text: 'ðŸ“‰ In calo', color: 'text-red-600' };
                        return { text: 'â†’ Stabile', color: 'text-gray-600' };
                      };
                      
                      return (
                        <div className="space-y-4">
                          {/* Grafico a linee ASCII-style */}
                          <div className="bg-white rounded p-3 border border-purple-200">
                            <div className="font-mono text-xs overflow-x-auto">
                              {top3.map((squadra, sIdx) => (
                                <div key={squadra.nome} className="mb-3">
                                  <div className="font-bold mb-1" style={{ color: colors[sIdx] }}>
                                    {squadra.nome}
                                  </div>
                                  <div className="flex items-center gap-1">
                                    {squadra.andamento.map((punto, idx) => {
                                      const height = Math.round((punto.punti / maxPunti) * 10);
                                      return (
                                        <div key={idx} className="flex flex-col items-center">
                                          <div 
                                            className="w-2 rounded-t"
                                            style={{ 
                                              height: `${height * 4}px`,
                                              backgroundColor: colors[sIdx]
                                            }}
                                            title={`G${punto.giornata}: ${punto.punti} pt`}
                                          />
                                          <div className="text-[8px] mt-1">{punto.giornata}</div>
                                        </div>
                                      );
                                    })}
                                    <div className="ml-2 font-bold" style={{ color: colors[sIdx] }}>
                                      {squadra.puntiTotali} pt
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                          
                          {/* Trend */}
                          <div className="space-y-2">
                            {top3.map((squadra) => {
                              const trend = getTrend(squadra.andamento);
                              return (
                                <div key={squadra.nome} className="bg-white rounded p-2 border border-purple-200 flex justify-between items-center">
                                  <span className="text-sm font-semibold text-gray-800">{squadra.nome}</span>
                                  <span className={`text-xs font-semibold ${trend.color}`}>{trend.text}</span>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                  
                </div>
              )}
                    </>
                  )}
                </div>
              )}

              {/* TAB SQUADRE */}
              {classificaTab === 'squadre' && (
                <div>
                  <div className="mb-4">
                    <button
                      onClick={() => setShowAddSquadraModal(true)}
                      disabled={userRole !== 'admin'}
                      className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50"
                    >
                      + Aggiungi Squadra
                    </button>
                  </div>
                  
                  {squadreGirone.length === 0 ? (
                    <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                      <div className="text-6xl mb-4">ðŸ‘¥</div>
                      <h3 className="text-xl font-bold text-gray-800 mb-2">Nessuna squadra inserita</h3>
                      <p className="text-gray-600 mb-4">Aggiungi le squadre del girone per iniziare</p>
                    </div>
                  ) : (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                      <div className="space-y-3">
                        {squadreGirone.map((sq, idx) => (
                          <div key={sq.id} className="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50">
                            <div className="flex items-center gap-4">
                              <div className="text-2xl font-bold text-gray-400">{idx + 1}</div>
                              <div>
                                <div className="font-bold text-lg">{sq.nome}</div>
                                <div className="text-sm text-gray-500">Aggiunta il {new Date(sq.dataAggiunta).toLocaleDateString('it-IT')}</div>
                              </div>
                            </div>
                            {userRole === 'admin' && (
                              <div className="flex gap-2">
                                <button
                                  onClick={() => {
                                    setEditingSquadra(sq);
                                    setShowAddSquadraModal(true);
                                  }}
                                  className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                >
                                  âœï¸ Modifica
                                </button>
                                <button
                                  onClick={() => {
                                    if (window.confirm(`Eliminare "${sq.nome}"?`)) {
                                      setSquadreGirone(squadreGirone.filter(s => s.id !== sq.id));
                                      showToast('Squadra eliminata', 'success');
                                    }
                                  }}
                                  className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                                >
                                  ðŸ—‘ï¸
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* TAB RISULTATI - Continua nella parte 3 */}
              {classificaTab === 'risultati' && (
                <div>
                  {squadreGirone.length < 2 ? (
                    <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 text-center">
                      <div className="text-4xl mb-2">âš ï¸</div>
                      <p className="font-semibold">Aggiungi almeno 2 squadre per inserire risultati</p>
                    </div>
                  ) : (
                    <div>
                      <div className="flex gap-4 mb-4 items-center flex-wrap">
                        <select
                          value={selectedGiornata}
                          onChange={(e) => setSelectedGiornata(parseInt(e.target.value))}
                          className="p-3 border-2 border-gray-300 rounded-lg"
                        >
                          {[...Array(Math.max(1, (squadreGirone.length * 2) - 2))].map((_, i) => (
                            <option key={i + 1} value={i + 1}>Giornata {i + 1}</option>
                          ))}
                        </select>
                        {userRole === 'admin' && (
                          <button
                            onClick={() => {
                              const giornata = risultatiCampionato.find(g => g.giornata === selectedGiornata);
                              if (!giornata) {
                                setRisultatiCampionato([...risultatiCampionato, {
                                  giornata: selectedGiornata,
                                  data: new Date().toISOString().split('T')[0],
                                  partite: []
                                }]);
                              }
                              showToast('Giornata creata', 'success');
                            }}
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700"
                          >
                            + Nuova Giornata
                          </button>
                        )}
                      </div>
                      
                      {(() => {
                        const giornata = risultatiCampionato.find(g => g.giornata === selectedGiornata);
                        
                        if (!giornata) {
                          return (
                            <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                              <div className="text-6xl mb-4">âš½</div>
                              <p className="text-gray-600">Nessun risultato per questa giornata</p>
                            </div>
                          );
                        }
                        
                        return (
                          <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="space-y-4">
                              {giornata.partite.map((partita, idx) => {
                                // Calcola squadre giÃ  usate nelle partite precedenti di questa giornata
                                const squadreGiaUsate = giornata.partite
                                  .slice(0, idx) // Solo partite PRECEDENTI a questa
                                  .flatMap(p => [p.squadraCasa, p.squadraTrasferta])
                                  .filter(Boolean); // Rimuovi valori vuoti/undefined
                                
                                // Filtra squadre disponibili per squadraCasa
                                const squadreDisponibiliCasa = squadreGirone.filter(sq => 
                                  !squadreGiaUsate.includes(sq.nome) || sq.nome === partita.squadraCasa
                                );
                                
                                // Filtra squadre disponibili per squadraTrasferta (escludi anche squadraCasa corrente)
                                const squadreDisponibiliTrasferta = squadreGirone.filter(sq => 
                                  (!squadreGiaUsate.includes(sq.nome) && sq.nome !== partita.squadraCasa) || 
                                  sq.nome === partita.squadraTrasferta
                                );
                                
                                return (
                                <div key={idx} className="border rounded-lg p-3 flex items-center gap-3">
                                  <select
                                    value={partita.squadraCasa}
                                    onChange={(e) => {
                                      const newRisultati = [...risultatiCampionato];
                                      const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                      g.partite[idx].squadraCasa = e.target.value;
                                      setRisultatiCampionato(newRisultati);
                                    }}
                                    disabled={userRole !== 'admin'}
                                    className="flex-1 p-2 border-2 rounded font-semibold"
                                  >
                                    {squadreDisponibiliCasa.map(sq => (
                                      <option key={sq.id} value={sq.nome}>{sq.nome}</option>
                                    ))}
                                  </select>
                                  
                                  <input
                                    type="number"
                                    min="0"
                                    placeholder="0"
                                    value={partita.golCasa === '' ? '' : partita.golCasa}
                                    onChange={(e) => {
                                      const newRisultati = [...risultatiCampionato];
                                      const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                      const value = e.target.value === '' ? '' : parseInt(e.target.value) || 0;
                                      g.partite[idx].golCasa = value;
                                      // Imposta giocata=true solo se entrambi i gol sono inseriti
                                      if (value !== '' && g.partite[idx].golTrasferta !== '') {
                                        g.partite[idx].giocata = true;
                                      } else {
                                        g.partite[idx].giocata = false;
                                      }
                                      setRisultatiCampionato(newRisultati);
                                    }}
                                    disabled={userRole !== 'admin'}
                                    className="w-16 p-2 border-2 text-center text-lg font-bold rounded"
                                  />
                                  
                                  <div className="text-gray-400 font-bold">-</div>
                                  
                                  <input
                                    type="number"
                                    min="0"
                                    placeholder="0"
                                    value={partita.golTrasferta === '' ? '' : partita.golTrasferta}
                                    onChange={(e) => {
                                      const newRisultati = [...risultatiCampionato];
                                      const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                      const value = e.target.value === '' ? '' : parseInt(e.target.value) || 0;
                                      g.partite[idx].golTrasferta = value;
                                      // Imposta giocata=true solo se entrambi i gol sono inseriti
                                      if (value !== '' && g.partite[idx].golCasa !== '') {
                                        g.partite[idx].giocata = true;
                                      } else {
                                        g.partite[idx].giocata = false;
                                      }
                                      setRisultatiCampionato(newRisultati);
                                    }}
                                    disabled={userRole !== 'admin'}
                                    className="w-16 p-2 border-2 text-center text-lg font-bold rounded"
                                  />
                                  
                                  <select
                                    value={partita.squadraTrasferta}
                                    onChange={(e) => {
                                      const newRisultati = [...risultatiCampionato];
                                      const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                      g.partite[idx].squadraTrasferta = e.target.value;
                                      setRisultatiCampionato(newRisultati);
                                    }}
                                    disabled={userRole !== 'admin'}
                                    className="flex-1 p-2 border-2 rounded font-semibold"
                                  >
                                    {squadreDisponibiliTrasferta.map(sq => (
                                      <option key={sq.id} value={sq.nome}>{sq.nome}</option>
                                    ))}
                                  </select>
                                  
                                  {userRole === 'admin' && (
                                    <button
                                      onClick={() => {
                                        if (window.confirm(`Eliminare questa partita?\n${partita.squadraCasa} vs ${partita.squadraTrasferta}`)) {
                                          const newRisultati = [...risultatiCampionato];
                                          const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                          g.partite.splice(idx, 1);
                                          setRisultatiCampionato(newRisultati);
                                          showToast('Partita eliminata', 'success');
                                        }
                                      }}
                                      className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold flex-shrink-0"
                                    >
                                      ðŸ—‘ï¸
                                    </button>
                                  )}
                                </div>
                              )})}
                              
                              
                              {userRole === 'admin' && (
                                <button
                                  onClick={() => {
                                    const newRisultati = [...risultatiCampionato];
                                    const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                    
                                    // Calcola squadre giÃ  usate in questa giornata
                                    const squadreGiaUsate = g.partite
                                      .flatMap(p => [p.squadraCasa, p.squadraTrasferta])
                                      .filter(Boolean);
                                    
                                    // Trova le prime 2 squadre NON ancora usate
                                    const squadreDisponibili = squadreGirone.filter(sq => 
                                      !squadreGiaUsate.includes(sq.nome)
                                    );
                                    
                                    g.partite.push({
                                      id: Date.now(),
                                      squadraCasa: squadreDisponibili[0]?.nome || '',
                                      squadraTrasferta: squadreDisponibili[1]?.nome || '',
                                      golCasa: '',
                                      golTrasferta: '',
                                      giocata: false
                                    });
                                    setRisultatiCampionato(newRisultati);
                                  }}
                                  className="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50"
                                >
                                  + Aggiungi Partita
                                </button>
                              )}
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  )}
                </div>
              )}

              {/* Modal Aggiungi/Modifica Squadra */}
              {showAddSquadraModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                    <h3 className="text-xl font-bold mb-4">{editingSquadra ? 'Modifica Squadra' : 'Aggiungi Squadra'}</h3>
                    <input
                      type="text"
                      placeholder="Nome squadra"
                      defaultValue={editingSquadra?.nome || ''}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          const nome = e.target.value.trim();
                          if (!nome) {
                            alert('Inserisci un nome');
                            return;
                          }
                          if (editingSquadra) {
                            setSquadreGirone(squadreGirone.map(s => s.id === editingSquadra.id ? {...s, nome} : s));
                            showToast('Squadra modificata', 'success');
                          } else {
                            setSquadreGirone([...squadreGirone, {
                              id: Date.now(),
                              nome,
                              dataAggiunta: new Date().toISOString()
                            }]);
                            showToast('Squadra aggiunta', 'success');
                          }
                          setShowAddSquadraModal(false);
                          setEditingSquadra(null);
                        }
                      }}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg mb-4"
                      autoFocus
                    />
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          const input = document.querySelector('input[placeholder="Nome squadra"]');
                          const nome = input.value.trim();
                          if (!nome) {
                            alert('Inserisci un nome');
                            return;
                          }
                          if (editingSquadra) {
                            setSquadreGirone(squadreGirone.map(s => s.id === editingSquadra.id ? {...s, nome} : s));
                            showToast('Squadra modificata', 'success');
                          } else {
                            setSquadreGirone([...squadreGirone, {
                              id: Date.now(),
                              nome,
                              dataAggiunta: new Date().toISOString()
                            }]);
                            showToast('Squadra aggiunta', 'success');
                          }
                          setShowAddSquadraModal(false);
                          setEditingSquadra(null);
                        }}
                        className="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700"
                      >
                        ðŸ’¾ Salva
                      </button>
                      <button
                        onClick={() => {
                          setShowAddSquadraModal(false);
                          setEditingSquadra(null);
                        }}
                        className="flex-1 bg-gray-400 text-white py-2 rounded-lg font-bold hover:bg-gray-500"
                      >
                        âŒ Annulla
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === 'trainings' && (
            <div>
              <div className="flex justify-between items-center mb-4 flex-wrap gap-3">
                <h2 className="text-2xl font-bold text-gray-800">Allenamenti</h2>
                <div className="flex gap-3">
                  <button
                    onClick={stampaListaPresenze}
                    className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                  >
                    <Download size={20} />
                    ðŸ“‹ Stampa Lista Presenze
                  </button>
                  <button
                    onClick={addTraining}
                    disabled={userRole !== 'admin'}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${
                      userRole === 'admin'
                        ? 'bg-blue-600 text-white hover:bg-blue-700'
                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                    }`}
                    title={userRole !== 'admin' ? 'Solo Admin puÃ² aggiungere' : ''}
                  >
                    <Plus size={20} />
                    Aggiungi Nuovo Allenamento
                  </button>
                </div>
              </div>

              {trainings.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-lg">Nessun allenamento registrato</p>
                  <p className="text-sm mt-2">Clicca su "Aggiungi Nuovo Allenamento" per iniziare</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {getSortedTrainings().map(training => (
                    <div key={training.id} className="border rounded-lg bg-gray-50">
                      <div 
                        className="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-100 transition-colors"
                        onClick={() => toggleTraining(training.id)}
                      >
                        <div className="flex items-center gap-4 flex-1">
                          <span className="text-2xl">{expandedTrainings[training.id] ? 'â–¼' : 'â–¶'}</span>
                          <div className="flex items-center gap-4">
                            <input
                              type="date"
                              value={training.data}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateTraining(training.id, 'data', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg font-semibold"
                            />
                            <div>
                              <span className="font-semibold text-lg">Allenamento</span>
                              <span className="text-sm text-gray-600 ml-4">
                                Presenti: {
                                  Object.entries(training.presenze)
                                    .filter(([numero, presente]) => {
                                      if (presente !== true) return false;
                                      const player = players.find(p => p.numero === parseInt(numero));
                                      if (!player || !player.nome) return false;
                                      if (player.fuoriRosa) return false;
                                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                                      return true;
                                    })
                                    .length
                                } | 
                                Assenti: {
                                  Object.entries(training.presenze)
                                    .filter(([numero, presente]) => {
                                      if (presente !== false) return false;
                                      const player = players.find(p => p.numero === parseInt(numero));
                                      if (!player || !player.nome) return false;
                                      if (player.fuoriRosa) return false;
                                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                                      return true;
                                    })
                                    .length
                                } | 
                                Infortuni: {
                                  Object.entries(training.infortuni)
                                    .filter(([numero, infortunato]) => {
                                      if (!infortunato) return false;
                                      const player = players.find(p => p.numero === parseInt(numero));
                                      if (!player || !player.nome) return false;
                                      if (player.fuoriRosa) return false;
                                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                                      return true;
                                    })
                                    .length
                                }
                                {training.esercizi && training.esercizi.length > 0 && (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      console.log('ðŸ”µ Click su esercizi!', training.id);
                                      console.log('Training object:', training);
                                      setExerciseModalTraining(training);
                                      console.log('âœ… exerciseModalTraining settato');
                                    }}
                                    className="ml-3 text-blue-600 font-semibold hover:text-blue-800 hover:underline transition-all cursor-pointer"
                                  >
                                    â±ï¸ {training.esercizi.length} esercizi - {calcolaTotaleMinuti(training.esercizi)} min
                                  </button>
                                )}
                                {training.foto && training.foto.length > 0 && (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      setPhotoModalTraining(training);
                                    }}
                                    className="ml-3 text-blue-600 font-semibold hover:text-blue-800 hover:underline transition-all cursor-pointer"
                                  >
                                    ðŸ“· {training.foto.length} foto
                                  </button>
                                )}
                              </span>
                            </div>
                          </div>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            if (userRole === 'admin') {
                              // Prepara dati per conferma
                              const dataAllenamento = training.data 
                                ? new Date(training.data).toLocaleDateString('it-IT', {
                                    weekday: 'short',
                                    day: '2-digit',
                                    month: 'short',
                                    year: 'numeric'
                                  })
                                : 'Data non specificata';
                              
                              const tipoAllenamento = training.tipo || 'Allenamento';
                              const noteAllenamento = training.note || 'Nessuna nota';
                              
                              if (window.confirm(
                                `âš ï¸ ATTENZIONE!\n\n` +
                                `Eliminare definitivamente questo allenamento?\n\n` +
                                `ðŸ“… Data: ${dataAllenamento}\n` +
                                `ðŸ‹ï¸ Tipo: ${tipoAllenamento}\n` +
                                `ðŸ“ Note: ${noteAllenamento}\n` +
                                `ðŸ“¸ Foto: ${training.foto?.length || 0}\n\n` +
                                `Questa azione NON puÃ² essere annullata!`
                              )) {
                                deleteTraining(training.id);
                                showToast('ðŸ—‘ï¸ Allenamento eliminato', 'success');
                              }
                            }
                          }}
                          disabled={userRole !== 'admin'}
                          className={`p-2 ${
                            userRole === 'admin'
                              ? 'text-red-600 hover:text-red-700'
                              : 'text-gray-400 cursor-not-allowed'
                          }`}
                          title={userRole !== 'admin' ? 'Solo Admin puÃ² eliminare' : ''}
                        >
                          <Trash2 size={20} />
                        </button>
                      </div>

                      {expandedTrainings[training.id] && (
                        <div className="border-t bg-white">
                          {/* TAB NAVIGATION */}
                          <div className="flex border-b">
                            <button
                              onClick={() => setTrainingTabActive({...trainingTabActive, [training.id]: 'presenze'})}
                              className={`flex-1 px-6 py-3 font-semibold transition-colors ${
                                (trainingTabActive[training.id] || 'presenze') === 'presenze'
                                  ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                                  : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'
                              }`}
                            >
                              ðŸ‘¥ Presenze
                            </button>
                            <button
                              onClick={() => setTrainingTabActive({...trainingTabActive, [training.id]: 'esercizi'})}
                              className={`flex-1 px-6 py-3 font-semibold transition-colors ${
                                trainingTabActive[training.id] === 'esercizi'
                                  ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                                  : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'
                              }`}
                            >
                              ðŸ“ Esercizi ({training.esercizi?.length || 0})
                            </button>
                            <button
                              onClick={() => setTrainingTabActive({...trainingTabActive, [training.id]: 'foto'})}
                              className={`flex-1 px-6 py-3 font-semibold transition-colors ${
                                trainingTabActive[training.id] === 'foto'
                                  ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                                  : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'
                              }`}
                            >
                              ðŸ“· Foto ({training.foto?.length || 0}/3)
                            </button>
                          </div>

                          {/* TAB CONTENT - PRESENZE */}
                          {(trainingTabActive[training.id] || 'presenze') === 'presenze' && (
                            <div 
                              className="p-4"
                              style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.7} : {}}
                            >
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                {players.filter(p => {
                                  if (!p.nome) return false;
                                  if (p.fuoriRosa) return false; // âœ… Escludi giocatori fuori rosa
                                  if (!p.dataCreazione) return true;
                                  return new Date(p.dataCreazione) <= new Date(training.data);
                                }).map(player => (
                              <div key={player.numero} className="flex items-center gap-2 bg-white p-2 rounded">
                                <span className="font-bold text-gray-700 w-8">{player.numero}</span>
                                <span className="flex-1 text-sm">{player.nome}</span>
                                <label className="flex items-center gap-1">
                                  <input
                                    type="checkbox"
                                    checked={training.presenze[player.numero] === true}
                                    onChange={(e) => {
                                      const newPresenze = { ...training.presenze, [player.numero]: e.target.checked ? true : undefined };
                                      const newInfortuni = { ...training.infortuni };
                                      
                                      // Se spunta presente, togli automaticamente infortunato
                                      if (e.target.checked) {
                                        newInfortuni[player.numero] = false;
                                      }
                                      
                                      // Aggiorna entrambi
                                      setTrainings(trainings.map(t => 
                                        t.id === training.id 
                                          ? { ...t, presenze: newPresenze, infortuni: newInfortuni }
                                          : t
                                      ));
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-xs text-green-600">P</span>
                                </label>
                                <label className="flex items-center gap-1">
                                  <input
                                    type="checkbox"
                                    checked={training.presenze[player.numero] === false}
                                    onChange={(e) => {
                                      const newPresenze = { ...training.presenze, [player.numero]: e.target.checked ? false : undefined };
                                      updateTraining(training.id, 'presenze', newPresenze);
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-xs text-orange-600">A</span>
                                </label>
                                <label className="flex items-center gap-1">
                                  <input
                                    type="checkbox"
                                    checked={training.infortuni[player.numero] || false}
                                    onChange={(e) => {
                                      const newInfortuni = { ...training.infortuni, [player.numero]: e.target.checked };
                                      const newPresenze = { ...training.presenze };
                                      
                                      // Se spunta infortunato, togli automaticamente presente
                                      if (e.target.checked) {
                                        newPresenze[player.numero] = false;
                                      }
                                      
                                      // Aggiorna entrambi
                                      setTrainings(trainings.map(t => 
                                        t.id === training.id 
                                          ? { ...t, infortuni: newInfortuni, presenze: newPresenze }
                                          : t
                                      ));
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-xs text-red-600">I</span>
                                </label>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* TAB CONTENT - ESERCIZI */}
                      {trainingTabActive[training.id] === 'esercizi' && (
                        <div className="p-4">
                          {/* FORM AGGIUNGI ESERCIZIO */}
                          <div className="bg-gray-50 rounded-lg p-4 mb-4 border-2 border-gray-200">
                            <h4 className="font-bold text-lg mb-3">âž• Aggiungi Esercizio</h4>
                            
                            {/* Template Dropdown */}
                            <div className="mb-3">
                              <label className="block text-sm font-semibold text-gray-700 mb-1">
                                Template (opzionale)
                              </label>
                              <select
                                value={(newEsercizio[training.id] || {}).template || ''}
                                onChange={(e) => {
                                  const template = templateEsercizi.find(t => t.nome === e.target.value);
                                  if (template) {
                                    setNewEsercizio({
                                      ...newEsercizio,
                                      [training.id]: {
                                        ...(newEsercizio[training.id] || {}),
                                        template: template.nome,
                                        nome: template.nome === 'Personalizzato' ? '' : template.nome,
                                        durata: template.durata.toString(),
                                        descrizione: template.descrizione
                                      }
                                    });
                                  }
                                }}
                                className="w-full p-2 border-2 border-gray-300 rounded-lg"
                              >
                                <option value="">Seleziona template o inserisci manualmente</option>
                                {templateEsercizi.map(t => (
                                  <option key={t.nome} value={t.nome}>
                                    {t.nome} {t.durata > 0 ? `(${t.durata} min)` : ''}
                                  </option>
                                ))}
                              </select>
                            </div>

                            {/* Nome */}
                            <div className="mb-3">
                              <label className="block text-sm font-semibold text-gray-700 mb-1">
                                Nome Esercizio *
                              </label>
                              <input
                                type="text"
                                value={(newEsercizio[training.id] || {}).nome || ''}
                                onChange={(e) => setNewEsercizio({
                                  ...newEsercizio,
                                  [training.id]: {
                                    ...(newEsercizio[training.id] || {}),
                                    nome: e.target.value
                                  }
                                })}
                                placeholder="es: Possesso palla 4v4"
                                className="w-full p-2 border-2 border-gray-300 rounded-lg"
                              />
                            </div>

                            {/* Durata */}
                            <div className="mb-3">
                              <label className="block text-sm font-semibold text-gray-700 mb-1">
                                Durata (minuti) *
                              </label>
                              <input
                                type="number"
                                value={(newEsercizio[training.id] || {}).durata || ''}
                                onChange={(e) => setNewEsercizio({
                                  ...newEsercizio,
                                  [training.id]: {
                                    ...(newEsercizio[training.id] || {}),
                                    durata: e.target.value
                                  }
                                })}
                                placeholder="es: 20"
                                min="0"
                                className="w-full p-2 border-2 border-gray-300 rounded-lg"
                              />
                            </div>

                            {/* Descrizione */}
                            <div className="mb-3">
                              <label className="block text-sm font-semibold text-gray-700 mb-1">
                                Descrizione (opzionale)
                              </label>
                              <textarea
                                value={(newEsercizio[training.id] || {}).descrizione || ''}
                                onChange={(e) => setNewEsercizio({
                                  ...newEsercizio,
                                  [training.id]: {
                                    ...(newEsercizio[training.id] || {}),
                                    descrizione: e.target.value
                                  }
                                })}
                                placeholder="es: Mantenimento palla in spazi stretti"
                                rows="2"
                                className="w-full p-2 border-2 border-gray-300 rounded-lg"
                              />
                            </div>

                            {/* Valutazione */}
                            <div className="mb-4">
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Valutazione (opzionale)
                              </label>
                              <div className="flex gap-4">
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="radio"
                                    name={`val-${training.id}`}
                                    value="Scarso"
                                    checked={((newEsercizio[training.id] || {}).valutazione || '') === 'Scarso'}
                                    onChange={(e) => setNewEsercizio({
                                      ...newEsercizio,
                                      [training.id]: {
                                        ...(newEsercizio[training.id] || {}),
                                        valutazione: e.target.value
                                      }
                                    })}
                                    className="w-4 h-4"
                                  />
                                  <span className={`${((newEsercizio[training.id] || {}).valutazione || '') === 'Scarso' ? 'text-red-600 font-bold' : 'text-gray-600'}`}>
                                    ðŸ”´ Scarso
                                  </span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="radio"
                                    name={`val-${training.id}`}
                                    value="Medio"
                                    checked={((newEsercizio[training.id] || {}).valutazione || '') === 'Medio'}
                                    onChange={(e) => setNewEsercizio({
                                      ...newEsercizio,
                                      [training.id]: {
                                        ...(newEsercizio[training.id] || {}),
                                        valutazione: e.target.value
                                      }
                                    })}
                                    className="w-4 h-4"
                                  />
                                  <span className={`${((newEsercizio[training.id] || {}).valutazione || '') === 'Medio' ? 'text-yellow-600 font-bold' : 'text-gray-600'}`}>
                                    ðŸŸ¡ Medio
                                  </span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="radio"
                                    name={`val-${training.id}`}
                                    value="Buono"
                                    checked={((newEsercizio[training.id] || {}).valutazione || '') === 'Buono'}
                                    onChange={(e) => setNewEsercizio({
                                      ...newEsercizio,
                                      [training.id]: {
                                        ...(newEsercizio[training.id] || {}),
                                        valutazione: e.target.value
                                      }
                                    })}
                                    className="w-4 h-4"
                                  />
                                  <span className={`${((newEsercizio[training.id] || {}).valutazione || '') === 'Buono' ? 'text-green-600 font-bold' : 'text-gray-600'}`}>
                                    ðŸŸ¢ Buono
                                  </span>
                                </label>
                              </div>
                            </div>

                            {/* Bottone Aggiungi */}
                            <button
                              onClick={() => {
                                const form = newEsercizio[training.id] || {};
                                if (!form.nome || !form.durata) {
                                  showToast('âš ï¸ Nome e durata sono obbligatori', 'warning');
                                  return;
                                }
                                addEsercizio(training.id, form);
                                setNewEsercizio({
                                  ...newEsercizio,
                                  [training.id]: {
                                    template: '',
                                    nome: '',
                                    durata: '',
                                    descrizione: '',
                                    valutazione: ''
                                  }
                                });
                                showToast('âœ… Esercizio aggiunto!', 'success');
                              }}
                              className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                            >
                              âœ… Aggiungi Esercizio
                            </button>
                          </div>

                          {/* LISTA ESERCIZI */}
                          {training.esercizi && training.esercizi.length > 0 ? (
                            <div className="space-y-3">
                              <h4 className="font-bold text-lg mb-3">ðŸ“‹ Esercizi Inseriti</h4>
                              
                              {training.esercizi.map((esercizio, idx) => (
                                <div key={esercizio.id} className="bg-white rounded-lg p-4 border-2 border-gray-200 hover:border-blue-300 transition-colors">
                                  <div className="flex justify-between items-start mb-2">
                                    <div className="flex-1">
                                      <div className="flex items-center gap-2 mb-1">
                                        <span className="font-bold text-gray-800 text-lg">{idx + 1}. {esercizio.nome}</span>
                                        {esercizio.valutazione && (
                                          <span className={`text-sm font-semibold ${
                                            esercizio.valutazione === 'Scarso' ? 'text-red-600' :
                                            esercizio.valutazione === 'Medio' ? 'text-yellow-600' :
                                            'text-green-600'
                                          }`}>
                                            {esercizio.valutazione === 'Scarso' ? 'ðŸ”´' :
                                             esercizio.valutazione === 'Medio' ? 'ðŸŸ¡' : 'ðŸŸ¢'} {esercizio.valutazione}
                                          </span>
                                        )}
                                      </div>
                                      <div className="text-sm text-gray-600">
                                        â±ï¸ {esercizio.durata} minuti
                                      </div>
                                      {esercizio.descrizione && (
                                        <div className="text-sm text-gray-600 mt-1">
                                          ðŸ’¬ {esercizio.descrizione}
                                        </div>
                                      )}
                                    </div>
                                    <div className="flex gap-2">
                                      <button
                                        onClick={() => {
                                          setEditingEsercizio({
                                            trainingId: training.id,
                                            esercizioId: esercizio.id,
                                            nome: esercizio.nome,
                                            durata: esercizio.durata,
                                            descrizione: esercizio.descrizione || '',
                                            valutazione: esercizio.valutazione || ''
                                          });
                                        }}
                                        className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                        title="Modifica"
                                      >
                                        âœï¸
                                      </button>
                                      <button
                                        onClick={() => {
                                          if (window.confirm(`Eliminare "${esercizio.nome}"?`)) {
                                            deleteEsercizio(training.id, esercizio.id);
                                            showToast('ðŸ—‘ï¸ Esercizio eliminato', 'success');
                                          }
                                        }}
                                        className="p-2 text-red-600 hover:bg-red-50 rounded"
                                        title="Elimina"
                                      >
                                        ðŸ—‘ï¸
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              ))}

                              {/* TOTALE MINUTI */}
                              <div className="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
                                <div className="flex justify-between items-center">
                                  <span className="font-bold text-lg text-gray-800">â±ï¸ TOTALE:</span>
                                  <span className="font-bold text-2xl text-blue-600">
                                    {calcolaTotaleMinuti(training.esercizi)} minuti
                                  </span>
                                </div>
                              </div>
                            </div>
                          ) : (
                            <div className="text-center py-8 text-gray-500">
                              <p className="text-lg">Nessun esercizio inserito</p>
                              <p className="text-sm mt-2">Aggiungi il primo esercizio usando il form sopra</p>
                            </div>
                          )}

                          {/* DUPLICA DA ALTRO ALLENAMENTO */}
                          {trainings.filter(t => t.id !== training.id && t.esercizi && t.esercizi.length > 0).length > 0 && (
                            <div className="mt-4 bg-purple-50 rounded-lg p-4 border-2 border-purple-200">
                              <h4 className="font-bold text-lg mb-3">ðŸ“‹ Duplica Esercizi</h4>
                              <div className="flex gap-2">
                                <select
                                  id={`duplicate-${training.id}`}
                                  className="flex-1 p-2 border-2 border-gray-300 rounded-lg"
                                  defaultValue=""
                                >
                                  <option value="" disabled>Seleziona allenamento...</option>
                                  {trainings
                                    .filter(t => t.id !== training.id && t.esercizi && t.esercizi.length > 0)
                                    .sort((a, b) => new Date(b.data) - new Date(a.data))
                                    .map(t => (
                                      <option key={t.id} value={t.id}>
                                        {t.data} - {t.esercizi.length} esercizi ({calcolaTotaleMinuti(t.esercizi)} min)
                                      </option>
                                    ))}
                                </select>
                                <button
                                  onClick={() => {
                                    const select = document.getElementById(`duplicate-${training.id}`);
                                    const sourceId = parseInt(select.value);
                                    if (sourceId) {
                                      duplicaEserciziDaAllenamento(training.id, sourceId);
                                      select.value = '';
                                    } else {
                                      showToast('âš ï¸ Seleziona un allenamento', 'warning');
                                    }
                                  }}
                                  className="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors whitespace-nowrap"
                                >
                                  ðŸ“‹ Duplica
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      )}

                      {/* TAB CONTENT - FOTO */}
                      {trainingTabActive[training.id] === 'foto' && (
                        <div className="p-6 bg-gray-50">
                          <div className="mb-6">
                            <h4 className="font-bold text-lg text-gray-800 mb-3">ðŸ“· Foto Allenamento</h4>
                            <p className="text-sm text-gray-600 mb-4">
                              Carica fino a 3 foto per ricordare i momenti salienti di questo allenamento (max 500KB per foto)
                            </p>

                            {/* Upload foto */}
                            {(!training.foto || training.foto.length < 3) && userRole === 'admin' && (
                              <div className="mb-6">
                                <label className="flex items-center justify-center gap-3 p-6 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors bg-white">
                                  <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                  </svg>
                                  <span className="font-semibold text-blue-600">Aggiungi Foto ({training.foto?.length || 0}/3)</span>
                                  <input
                                    type="file"
                                    accept="image/*"
                                    onChange={(e) => handleAddTrainingPhoto(e, training.id)}
                                    className="hidden"
                                  />
                                </label>
                              </div>
                            )}

                            {/* Griglia foto */}
                            {training.foto && training.foto.length > 0 ? (
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {training.foto.map((foto) => (
                                  <div key={foto.id} className="relative group">
                                    <img
                                      src={foto.url || foto.data}
                                      alt="Foto allenamento"
                                      className="w-full h-48 object-cover rounded-lg shadow-lg cursor-pointer hover:opacity-90 transition-opacity"
                                      onClick={() => setEnlargedPhoto(foto.url || foto.data)}
                                    />
                                    <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                      {userRole === 'admin' && (
                                        <button
                                          onClick={() => handleRemoveTrainingPhoto(training.id, foto.id)}
                                          className="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 shadow-lg"
                                          title="Elimina foto"
                                        >
                                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                          </svg>
                                        </button>
                                      )}
                                    </div>
                                    <div className="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                      {new Date(foto.timestamp).toLocaleDateString('it-IT')}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div className="text-center py-12 bg-white rounded-lg border-2 border-dashed border-gray-300">
                                <div className="text-6xl mb-3">ðŸ“·</div>
                                <p className="text-gray-600">Nessuna foto caricata</p>
                                <p className="text-sm text-gray-500 mt-1">Aggiungi foto per ricordare questo allenamento</p>
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* MODAL MODIFICA ESERCIZIO */}
          {editingEsercizio && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-2xl font-bold mb-4 text-gray-800">âœï¸ Modifica Esercizio</h3>
                
                {/* Nome */}
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Nome Esercizio *
                  </label>
                  <input
                    type="text"
                    value={editingEsercizio.nome}
                    onChange={(e) => setEditingEsercizio({...editingEsercizio, nome: e.target.value})}
                    placeholder="es: Possesso palla 4v4"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg"
                  />
                </div>

                {/* Durata */}
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Durata (minuti) *
                  </label>
                  <input
                    type="number"
                    value={editingEsercizio.durata}
                    onChange={(e) => setEditingEsercizio({...editingEsercizio, durata: e.target.value})}
                    placeholder="es: 20"
                    min="0"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg"
                  />
                </div>

                {/* Descrizione */}
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Descrizione (opzionale)
                  </label>
                  <textarea
                    value={editingEsercizio.descrizione}
                    onChange={(e) => setEditingEsercizio({...editingEsercizio, descrizione: e.target.value})}
                    placeholder="es: Mantenimento palla in spazi stretti"
                    rows="3"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg"
                  />
                </div>

                {/* Valutazione */}
                <div className="mb-6">
                  <label className="block text-sm font-semibold text-gray-700 mb-3">
                    Valutazione
                  </label>
                  <div className="flex flex-wrap gap-4">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="edit-valutazione"
                        value=""
                        checked={editingEsercizio.valutazione === ''}
                        onChange={(e) => setEditingEsercizio({...editingEsercizio, valutazione: ''})}
                        className="w-5 h-5"
                      />
                      <span className={`text-lg ${editingEsercizio.valutazione === '' ? 'font-bold' : ''}`}>
                        Nessuna
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="edit-valutazione"
                        value="Scarso"
                        checked={editingEsercizio.valutazione === 'Scarso'}
                        onChange={(e) => setEditingEsercizio({...editingEsercizio, valutazione: e.target.value})}
                        className="w-5 h-5"
                      />
                      <span className={`text-lg ${editingEsercizio.valutazione === 'Scarso' ? 'text-red-600 font-bold' : 'text-gray-600'}`}>
                        ðŸ”´ Scarso
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="edit-valutazione"
                        value="Medio"
                        checked={editingEsercizio.valutazione === 'Medio'}
                        onChange={(e) => setEditingEsercizio({...editingEsercizio, valutazione: e.target.value})}
                        className="w-5 h-5"
                      />
                      <span className={`text-lg ${editingEsercizio.valutazione === 'Medio' ? 'text-yellow-600 font-bold' : 'text-gray-600'}`}>
                        ðŸŸ¡ Medio
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="edit-valutazione"
                        value="Buono"
                        checked={editingEsercizio.valutazione === 'Buono'}
                        onChange={(e) => setEditingEsercizio({...editingEsercizio, valutazione: e.target.value})}
                        className="w-5 h-5"
                      />
                      <span className={`text-lg ${editingEsercizio.valutazione === 'Buono' ? 'text-green-600 font-bold' : 'text-gray-600'}`}>
                        ðŸŸ¢ Buono
                      </span>
                    </label>
                  </div>
                </div>

                {/* Bottoni */}
                <div className="flex gap-3 justify-end">
                  <button
                    onClick={() => setEditingEsercizio(null)}
                    className="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
                  >
                    âŒ Annulla
                  </button>
                  <button
                    onClick={() => {
                      if (!editingEsercizio.nome || !editingEsercizio.durata) {
                        showToast('âš ï¸ Nome e durata sono obbligatori', 'warning');
                        return;
                      }
                      
                      // Aggiorna l'esercizio completo in un'unica operazione
                      setTrainings(trainings.map(t => {
                        if (t.id === editingEsercizio.trainingId) {
                          return {
                            ...t,
                            esercizi: (t.esercizi || []).map(e => 
                              e.id === editingEsercizio.esercizioId 
                                ? {
                                    ...e,
                                    nome: editingEsercizio.nome,
                                    durata: parseInt(editingEsercizio.durata) || 0,
                                    descrizione: editingEsercizio.descrizione,
                                    valutazione: editingEsercizio.valutazione
                                  }
                                : e
                            )
                          };
                        }
                        return t;
                      }));
                      
                      setEditingEsercizio(null);
                      showToast('âœ… Esercizio modificato!', 'success');
                    }}
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                  >
                    âœ… Salva Modifiche
                  </button>
                </div>
              </div>
            </div>
          )}

{activeTab === 'matches' && (
            <div>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold text-gray-800">Partite</h2>
                <button
                  onClick={addMatch}
                  disabled={userRole !== 'admin'}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${
                    userRole === 'admin'
                      ? 'bg-blue-600 text-white hover:bg-blue-700'
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                  title={userRole !== 'admin' ? 'Solo Admin puÃ² aggiungere' : ''}
                >
                  <Plus size={20} />
                  Aggiungi Nuova Partita
                </button>
              </div>

              {matches.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-lg">Nessuna partita registrata</p>
                  <p className="text-sm mt-2">Clicca su "Aggiungi Nuova Partita" per iniziare</p>
                </div>
              ) : (
                <div className="space-y-6">
                  {getSortedMatches().map(match => (
                    <div key={match.id} className="border rounded-lg bg-gray-50">
                      <div 
                        className={`flex justify-between items-center p-4 cursor-pointer hover:bg-gray-100 transition-colors ${expandedMatches[match.id] ? 'sticky top-0 z-20 bg-gray-100 border-b-2 border-blue-300' : ''}`}
                        onClick={() => toggleMatch(match.id)}
                      >
                        <div className="flex items-center gap-4 flex-1">
                          <span className="text-2xl">{expandedMatches[match.id] ? 'â–¼' : 'â–¶'}</span>
                          <div className="flex gap-4 flex-wrap flex-1">
                            <input
                              type="date"
                              value={match.data}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'data', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg font-semibold"
                            />
                            <input
                              type="text"
                              placeholder="Squadra Casa"
                              value={match.squadraCasa}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'squadraCasa', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg"
                            />
                            <input
                              type="text"
                              placeholder="Squadra Trasferta"
                              value={match.squadraTrasferta}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'squadraTrasferta', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg"
                            />
                            <input
                              type="text"
                              placeholder="Risultato (es: 2-1)"
                              value={match.risultato}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'risultato', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg w-32"
                            />
                          </div>
                        </div>
                        <div className="flex gap-2 flex-wrap">
                          {/* Pulsante MVP */}
                          {match.risultato && match.risultato.includes('-') && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                openMVPVoting(match.id);
                              }}
                              className={`px-4 py-2 rounded-lg transition-colors font-semibold flex items-center gap-2 ${
                                match.mvp 
                                  ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white hover:from-yellow-600 hover:to-yellow-700'
                                  : 'bg-yellow-100 text-yellow-700 border-2 border-yellow-400 hover:bg-yellow-200'
                              }`}
                            >
                              {match.mvp ? (
                                <>
                                  <span>ðŸ†</span>
                                  <span className="hidden sm:inline">
                                    MVP: {players.find(p => p.numero === match.mvp)?.nome.split(' ')[0] || `#${match.mvp}`}
                                  </span>
                                </>
                              ) : (
                                <>
                                  <span>â­</span>
                                  <span className="hidden sm:inline">Vota MVP</span>
                                </>
                              )}
                            </button>
                          )}
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setPhotoModalMatch(match);
                            }}
                            className={`px-4 py-2 rounded-lg transition-colors font-semibold flex items-center gap-2 ${
                              match.foto && match.foto.length > 0
                                ? 'bg-purple-600 text-white hover:bg-purple-700'
                                : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                            }`}
                          >
                            <span>ðŸ“·</span>
                            <span className="hidden sm:inline">Foto{match.foto && match.foto.length > 0 ? ` (${match.foto.length})` : ''}</span>
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setShowModuloModal(match.id);
                            }}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                          >
                            âš½ Modulo
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              startLiveMatch(match.id);
                            }}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold"
                          >
                            âš¡ Live
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              if (userRole === 'admin') {
                                const dataPartita = new Date(match.data).toLocaleDateString('it-IT', { 
                                  day: '2-digit', 
                                  month: 'long', 
                                  year: 'numeric' 
                                });
                                const nomePartita = match.squadraCasa && match.squadraTrasferta 
                                  ? `${match.squadraCasa} vs ${match.squadraTrasferta}`
                                  : match.avversario || 'Partita';
                                
                                if (window.confirm(
                                  `âš ï¸ ATTENZIONE!\n\n` +
                                  `Eliminare definitivamente questa partita?\n\n` +
                                  `ðŸ“… Data: ${dataPartita}\n` +
                                  `âš½ Partita: ${nomePartita}\n` +
                                  `ðŸ“ Luogo: ${match.luogo || 'Non specificato'}\n\n` +
                                  `Questa azione NON puÃ² essere annullata!`
                                )) {
                                  deleteMatch(match.id);
                                  showToast('ðŸ—‘ï¸ Partita eliminata', 'success');
                                }
                              }
                            }}
                            disabled={userRole !== 'admin'}
                            className={`p-2 ${
                              userRole === 'admin'
                                ? 'text-red-600 hover:text-red-700'
                                : 'text-gray-400 cursor-not-allowed'
                            }`}
                            title={userRole !== 'admin' ? 'Solo Admin puÃ² eliminare' : 'Elimina partita'}
                          >
                            <Trash2 size={20} />
                          </button>
                        </div>
                      </div>

                      {expandedMatches[match.id] && (
                        <div 
                          className="border-t"
                          style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.7} : {}}
                        >
                          {/* Hint mobile */}
                          <div className="md:hidden bg-blue-50 p-2 text-xs text-center text-blue-700 border-b">
                            ðŸ‘ˆ Scorri a destra per vedere tutte le colonne â†’
                          </div>
                          <div className="overflow-x-auto overflow-y-auto max-h-[600px]">
                            <table className="w-full text-xs">
                              <thead className="bg-blue-100 sticky top-0 z-10">
                                <tr>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">NÂ° Maglia</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Giocatore</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Conv.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Tit.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Sost.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Entr.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Min.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Gol</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Ass.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">G.Sub</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">ðŸŸ¨ Gio</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">ðŸŸ¨ Pro</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">ðŸŸ¥ Gio</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">ðŸŸ¥ Pro</th>
                                </tr>
                              </thead>
                            <tbody className="bg-white">
                              {players.filter(p => {
                                if (!p.nome) return false;
                                if (p.fuoriRosa) return false; // âœ… Escludi giocatori fuori rosa
                                if (!p.dataCreazione) return true;
                                return new Date(p.dataCreazione) <= new Date(match.data);
                              }).sort((a, b) => {
                                const ordineDistinta = match.ordineDistinta || {};
                                const ordineA = parseInt(ordineDistinta[a.numero] || 999);
                                const ordineB = parseInt(ordineDistinta[b.numero] || 999);
                                if (ordineA === ordineB) return a.numero - b.numero;
                                return ordineA - ordineB;
                              }).map(player => (
                                <tr key={player.numero} className="border-b hover:bg-gray-50">
                                  <td className="p-1">
                                    <input
                                      type="number"
                                      min="1"
                                      max="99"
                                      value={(match.ordineDistinta || {})[player.numero] || ''}
                                      onChange={(e) => {
                                        const ordineDistinta = match.ordineDistinta || {};
                                        updateMatch(match.id, 'ordineDistinta', { ...ordineDistinta, [player.numero]: e.target.value });
                                      }}
                                      onBlur={(e) => {
                                        const newValue = e.target.value;
                                        const ordineDistinta = match.ordineDistinta || {};
                                        
                                        const isDuplicate = Object.entries(ordineDistinta).some(
                                          ([numero, valore]) => numero !== player.numero.toString() && valore === newValue && newValue !== ''
                                        );
                                        
                                        if (isDuplicate) {
                                          alert(`âš ï¸ Il numero ${newValue} Ã¨ giÃ  assegnato ad un altro giocatore nella distinta!`);
                                          updateMatch(match.id, 'ordineDistinta', { ...ordineDistinta, [player.numero]: '' });
                                        }
                                      }}
                                      className={`w-12 px-2 py-1 border rounded text-center font-bold transition-colors ${
                                        match.convocati[player.numero] && (match.ordineDistinta || {})[player.numero]
                                          ? 'bg-green-100 border-green-400'
                                          : match.convocati[player.numero] && !(match.ordineDistinta || {})[player.numero]
                                          ? 'bg-orange-200 border-orange-400 animate-pulse-fast'
                                          : ''
                                      }`}
                                      placeholder={player.numero}
                                    />
                                  </td>
                                  <td className="p-1 text-sm font-bold">{player.nome}</td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.convocati[player.numero] || false}
                                      onChange={(e) => updateMatch(match.id, 'convocati', { ...match.convocati, [player.numero]: e.target.checked })}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.titolari[player.numero] || false}
                                      onChange={(e) => {
                                        const newTit = { ...match.titolari, [player.numero]: e.target.checked };
                                        const newMin = { ...match.minutiGiocati };
                                        if (e.target.checked) newMin[player.numero] = '90';
                                        setMatches(matches.map(m => m.id === match.id ? { ...m, titolari: newTit, minutiGiocati: newMin } : m));
                                      }}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.sostituzioni[player.numero] || false}
                                      onChange={(e) => updateMatch(match.id, 'sostituzioni', { ...match.sostituzioni, [player.numero]: e.target.checked })}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.entrati[player.numero] || false}
                                      onChange={(e) => updateMatch(match.id, 'entrati', { ...match.entrati, [player.numero]: e.target.checked })}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      max="90"
                                      value={match.minutiGiocati[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'minutiGiocati', { ...match.minutiGiocati, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-12">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.golFatti[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'golFatti', { ...match.golFatti, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-12">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.assist[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'assist', { ...match.assist, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    {player.ruolo.includes('Portiere') && (
                                      <input
                                        type="number"
                                        min="0"
                                        value={match.golSubiti[player.numero] || ''}
                                        onChange={(e) => updateMatch(match.id, 'golSubiti', { ...match.golSubiti, [player.numero]: e.target.value })}
                                        className="w-full px-2 py-1 border rounded text-center"
                                      />
                                    )}
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.gialli_gioco[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'gialli_gioco', { ...match.gialli_gioco, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.gialli_protesta[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'gialli_protesta', { ...match.gialli_protesta, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.rossi_gioco[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'rossi_gioco', { ...match.rossi_gioco, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.rossi_protesta[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'rossi_protesta', { ...match.rossi_protesta, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                          </div>
                          <div className="text-xs px-4 pb-2 mt-2 flex items-center gap-4 flex-wrap">
                            <div className="flex items-center gap-2 px-3 py-1.5 bg-blue-100 border border-blue-300 rounded-lg">
                              <span className="font-semibold text-blue-900">
                                Convocati: {Object.values(match.convocati || {}).filter(Boolean).length}/20
                              </span>
                              {Object.values(match.convocati || {}).filter(Boolean).length < 20 ? (
                                <span className="text-blue-700 text-xs">
                                  (ancora {20 - Object.values(match.convocati || {}).filter(Boolean).length})
                                </span>
                              ) : (
                                <span className="text-green-700 text-xs font-semibold">
                                  âœ… Max raggiunto
                                </span>
                              )}
                            </div>
                            <div className="text-gray-600">
                              ðŸ’¡ Inserisci il numero di maglia nell'ordine della distinta ufficiale (es: 1 per il primo, 12 per il portiere in panchina, ecc.)
                            </div>
                          </div>
                          
                          {/* STEP 2: Cronologia Eventi Partita */}
                          {match.timeline && match.timeline.length > 0 && (
                            <div className="border-t mt-4 pt-4 px-4 pb-4 bg-gradient-to-br from-blue-50 to-blue-100">
                              <h4 className="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <span className="text-2xl">ðŸ“‹</span>
                                Cronologia Eventi Partita
                              </h4>
                              
                              <div className="space-y-2">
                                {match.timeline
                                  .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                                  .map((evento, idx) => {
                                    const time = new Date(evento.timestamp);
                                    const orario = time.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                                    
                                    // STEP 3: Mostra minuto se disponibile, altrimenti orario
                                    const displayTime = evento.minuto !== null && evento.minuto !== undefined 
                                      ? `${evento.minuto}'` 
                                      : orario;
                                    
                                    let icon = 'ðŸ“Œ';
                                    let bgColor = 'bg-gray-100';
                                    let textColor = 'text-gray-800';
                                    let label = evento.tipo;
                                    
                                    if (evento.tipo === 'gol') {
                                      icon = 'âš½';
                                      bgColor = 'bg-green-100';
                                      textColor = 'text-green-800';
                                      label = 'GOL';
                                    } else if (evento.tipo === 'golsubito') {
                                      icon = 'ðŸ”´';
                                      bgColor = 'bg-red-100';
                                      textColor = 'text-red-800';
                                      label = 'GOL SUBITO';
                                    } else if (evento.tipo === 'assist') {
                                      icon = 'ðŸŽ¯';
                                      bgColor = 'bg-blue-100';
                                      textColor = 'text-blue-800';
                                      label = 'ASSIST';
                                    } else if (evento.tipo === 'giallo') {
                                      icon = 'ðŸŸ¨';
                                      bgColor = 'bg-yellow-100';
                                      textColor = 'text-yellow-800';
                                      label = evento.sottotipo === 'gioco' ? 'GIALLO (gioco)' : 'GIALLO (proteste)';
                                    } else if (evento.tipo === 'rosso') {
                                      icon = 'ðŸŸ¥';
                                      bgColor = 'bg-red-100';
                                      textColor = 'text-red-800';
                                      label = evento.sottotipo === 'gioco' ? 'ROSSO (gioco)' : 'ROSSO (proteste)';
                                    }
                                    
                                    return (
                                      <div 
                                        key={evento.id || idx} 
                                        className={`${bgColor} rounded-lg p-3 flex items-center justify-between animate-fade-in hover:shadow-md transition-shadow`}
                                      >
                                        <div className="flex items-center gap-3 flex-1">
                                          <span className="text-3xl">{icon}</span>
                                          <div className="flex-1">
                                            <div className={`font-bold ${textColor} text-sm`}>{label}</div>
                                            <div className="text-gray-700 font-semibold">
                                              {evento.playerNome} 
                                              <span className="text-gray-600 text-xs ml-1">(#{evento.playerNum})</span>
                                            </div>
                                          </div>
                                        </div>
                                        
                                        <div className="flex items-center gap-3">
                                          <span className="text-gray-600 font-mono text-sm">{displayTime}</span>
                                          
                                          {/* Pulsante Rimuovi Evento */}
                                          <button
                                            onClick={() => {
                                              if (confirm(`Rimuovere evento: ${label} di ${evento.playerNome}?`)) {
                                                const newTimeline = match.timeline.filter((e, i) => (e.id || i) !== (evento.id || idx));
                                                updateMatch(match.id, 'timeline', newTimeline);
                                                showToast('ðŸ—‘ï¸ Evento rimosso', 'info');
                                              }
                                            }}
                                            className="text-red-600 hover:text-red-800 hover:bg-red-200 p-2 rounded-lg transition-colors"
                                            title="Rimuovi evento"
                                          >
                                            ðŸ—‘ï¸
                                          </button>
                                        </div>
                                      </div>
                                    );
                                  })}
                              </div>
                              
                              <div className="mt-3 text-xs text-gray-600 flex items-center gap-2">
                                <span>â„¹ï¸</span>
                                <span>Gli eventi vengono registrati automaticamente quando usi i pulsanti quick-add durante la partita</span>
                              </div>
                            </div>
                          )}

                          {/* SEZIONE FOTO PARTITA */}
                          <div className="p-6 bg-gray-50 border-t">
                            <h4 className="font-bold text-lg text-gray-800 mb-3">ðŸ“· Foto Partita</h4>
                            <p className="text-sm text-gray-600 mb-4">
                              Carica fino a 3 foto per ricordare i momenti salienti di questa partita (max 500KB per foto)
                            </p>

                            {/* Upload foto */}
                            {(!match.foto || match.foto.length < 3) && userRole === 'admin' && (
                              <div className="mb-6">
                                <label className="flex items-center justify-center gap-3 p-6 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors bg-white">
                                  <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                  </svg>
                                  <span className="font-semibold text-blue-600">Aggiungi Foto ({match.foto?.length || 0}/3)</span>
                                  <input
                                    type="file"
                                    accept="image/*"
                                    onChange={(e) => handleAddMatchPhoto(e, match.id)}
                                    className="hidden"
                                  />
                                </label>
                              </div>
                            )}

                            {/* Griglia foto */}
                            {match.foto && match.foto.length > 0 ? (
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {match.foto.map((foto) => (
                                  <div key={foto.id} className="relative group">
                                    <img
                                      src={foto.url || foto.data}
                                      alt="Foto partita"
                                      className="w-full h-48 object-cover rounded-lg shadow-lg cursor-pointer hover:opacity-90 transition-opacity"
                                      onClick={() => setEnlargedPhoto(foto.url || foto.data)}
                                    />
                                    <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                      {userRole === 'admin' && (
                                        <button
                                          onClick={() => handleRemoveMatchPhoto(match.id, foto.id)}
                                          className="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 shadow-lg"
                                          title="Elimina foto"
                                        >
                                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                          </svg>
                                        </button>
                                      )}
                                    </div>
                                    <div className="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                      {new Date(foto.timestamp).toLocaleDateString('it-IT')}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div className="text-center py-12 bg-white rounded-lg border-2 border-dashed border-gray-300">
                                <div className="text-6xl mb-3">ðŸ“·</div>
                                <p className="text-gray-600">Nessuna foto caricata</p>
                                <p className="text-sm text-gray-500 mt-1">Aggiungi foto per ricordare questa partita</p>
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

{showModuloModal && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowModuloModal(null)}>
    <div className="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
      {(() => {
        const match = matches.find(m => m.id === showModuloModal);
        const titolari = players.filter(p => match.titolari[p.numero]);
        
        const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
        const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
        const posizioniModuloCorrente = (matchModulo.moduli[moduloCorrente] || {}).posizioni || {};
        const currentModulo = { modulo: moduloCorrente, posizioni: posizioniModuloCorrente };
        
        const moduli = {
          '4-4-2': { nome: '4-4-2', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'ED', 'CC1', 'CC2', 'ES', 'PC1', 'PC2'] },
          '4-3-3': { nome: '4-3-3', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MC1', 'CC', 'MC2', 'AD', 'PC', 'AS'] },
          '3-5-2': { nome: '3-5-2', posizioni: ['P', 'DC1', 'DC2', 'DC3', 'ED', 'MC1', 'CC', 'MC2', 'ES', 'PC1', 'PC2'] },
          '4-2-3-1': { nome: '4-2-3-1', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MD1', 'MD2', 'AE', 'TQ', 'AD', 'PC'] },
          '3-4-3': { nome: '3-4-3', posizioni: ['P', 'DC1', 'DC2', 'DC3', 'ED', 'CC1', 'CC2', 'ES', 'AD', 'PC', 'AS'] },
          '5-3-2': { nome: '5-3-2', posizioni: ['P', 'TD', 'DC1', 'DC2', 'DC3', 'TS', 'MC1', 'CC', 'MC2', 'PC1', 'PC2'] },
          '4-1-4-1': { nome: '4-1-4-1', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MD', 'ED', 'CC1', 'CC2', 'ES', 'PC'] },
          '4-3-1-2': { nome: '4-3-1-2', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MC1', 'CC', 'MC2', 'TQ', 'PC1', 'PC2'] },
          '4-1-2-2-1': { nome: '4-1-2-2-1', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MD', 'CC1', 'CC2', 'AE', 'AD', 'PC'] }
        };
        
        const layoutPosizioni = {
          '4-4-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'ED', top: '50%', left: '85%' },
            { pos: 'CC1', top: '50%', left: '60%' },
            { pos: 'CC2', top: '50%', left: '40%' },
            { pos: 'ES', top: '50%', left: '15%' },
            { pos: 'PC1', top: '20%', left: '60%' },
            { pos: 'PC2', top: '20%', left: '40%' }
          ],
          '4-3-3': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MC1', top: '50%', left: '75%' },
            { pos: 'CC', top: '50%', left: '50%' },
            { pos: 'MC2', top: '50%', left: '25%' },
            { pos: 'AD', top: '20%', left: '75%' },
            { pos: 'PC', top: '20%', left: '50%' },
            { pos: 'AS', top: '20%', left: '25%' }
          ],
          '3-5-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'DC1', top: '75%', left: '70%' },
            { pos: 'DC2', top: '75%', left: '50%' },
            { pos: 'DC3', top: '75%', left: '30%' },
            { pos: 'ED', top: '55%', left: '90%' },
            { pos: 'MC1', top: '55%', left: '65%' },
            { pos: 'CC', top: '55%', left: '50%' },
            { pos: 'MC2', top: '55%', left: '35%' },
            { pos: 'ES', top: '55%', left: '10%' },
            { pos: 'PC1', top: '20%', left: '60%' },
            { pos: 'PC2', top: '20%', left: '40%' }
          ],
          '4-2-3-1': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MD1', top: '60%', left: '60%' },
            { pos: 'MD2', top: '60%', left: '40%' },
            { pos: 'AE', top: '35%', left: '80%' },
            { pos: 'TQ', top: '35%', left: '50%' },
            { pos: 'AD', top: '35%', left: '20%' },
            { pos: 'PC', top: '15%', left: '50%' }
          ],
          '3-4-3': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'DC1', top: '75%', left: '70%' },
            { pos: 'DC2', top: '75%', left: '50%' },
            { pos: 'DC3', top: '75%', left: '30%' },
            { pos: 'ED', top: '55%', left: '85%' },
            { pos: 'CC1', top: '55%', left: '60%' },
            { pos: 'CC2', top: '55%', left: '40%' },
            { pos: 'ES', top: '55%', left: '15%' },
            { pos: 'AD', top: '20%', left: '75%' },
            { pos: 'PC', top: '20%', left: '50%' },
            { pos: 'AS', top: '20%', left: '25%' }
          ],
          '5-3-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '90%' },
            { pos: 'DC1', top: '75%', left: '70%' },
            { pos: 'DC2', top: '75%', left: '50%' },
            { pos: 'DC3', top: '75%', left: '30%' },
            { pos: 'TS', top: '75%', left: '10%' },
            { pos: 'MC1', top: '50%', left: '70%' },
            { pos: 'CC', top: '50%', left: '50%' },
            { pos: 'MC2', top: '50%', left: '30%' },
            { pos: 'PC1', top: '20%', left: '60%' },
            { pos: 'PC2', top: '20%', left: '40%' }
          ],
          '4-1-4-1': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MD', top: '60%', left: '50%' },
            { pos: 'ED', top: '45%', left: '85%' },
            { pos: 'CC1', top: '45%', left: '60%' },
            { pos: 'CC2', top: '45%', left: '40%' },
            { pos: 'ES', top: '45%', left: '15%' },
            { pos: 'PC', top: '15%', left: '50%' }
          ],
          '4-3-1-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MC1', top: '55%', left: '70%' },
            { pos: 'CC', top: '55%', left: '50%' },
            { pos: 'MC2', top: '55%', left: '30%' },
            { pos: 'TQ', top: '35%', left: '50%' },
            { pos: 'PC1', top: '15%', left: '60%' },
            { pos: 'PC2', top: '15%', left: '40%' }
          ],
          '4-1-2-2-1': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MD', top: '60%', left: '50%' },
            { pos: 'CC1', top: '45%', left: '60%' },
            { pos: 'CC2', top: '45%', left: '40%' },
            { pos: 'AE', top: '25%', left: '75%' },
            { pos: 'AD', top: '25%', left: '25%' },
            { pos: 'PC', top: '10%', left: '50%' }
          ]
        };
        
        const layoutCorrente = layoutPosizioni[currentModulo.modulo];
        
        return (
          <>
            <div className="p-6 border-b sticky top-0 bg-white z-10">
              <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-blue-800">âš½ Modulo Tattico - {match.squadraCasa} vs {match.squadraTrasferta}</h2>
                <button onClick={() => setShowModuloModal(null)} className="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
              </div>
            </div>
            
            <div className="p-6">
              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">Seleziona Modulo:</label>
                <div className="grid grid-cols-4 gap-2">
                {Object.keys(moduli).map(mod => (
                  <button
                    key={mod}
                    onClick={() => {
                      const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                      setModuloTattico({
                        ...moduloTattico, 
                        [match.id]: { 
                          moduloCorrente: mod,
                          moduli: matchModulo.moduli
                        }
                      });
                    }}
                    className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                      currentModulo.modulo === mod 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    {mod}
                  </button>
                ))}
              </div>
            </div>
              
              
              {titolari.length !== 11 && (
                <div className="mb-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg">
                  âš ï¸ Attenzione: Hai selezionato {titolari.length} titolari. Seleziona esattamente 11 giocatori come titolari per visualizzare il modulo.
                </div>
              )}
              
              {titolari.length === 11 && (
                <div>
                  <div className="relative w-full rounded-lg overflow-hidden mb-12" style={{ 
                    paddingBottom: '85%', 
                    maxWidth: '455px', 
                    margin: '0 auto',
                    background: 'linear-gradient(180deg, #2d5016 0%, #1a3d0f 100%)',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
                  }}>
                    <div className="absolute inset-0">
                      <div className="absolute top-0 left-0 right-0 h-0.5 bg-white opacity-90"></div>
                      <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-white opacity-90"></div>
                      <div className="absolute top-0 bottom-0 left-0 w-0.5 bg-white opacity-90"></div>
                      <div className="absolute top-0 bottom-0 right-0 w-0.5 bg-white opacity-90"></div>
                      
                      <div className="absolute top-0 left-1/2 w-20 h-1 bg-white opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute top-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(-40px)' }}></div>
                      <div className="absolute top-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(40px)' }}></div>
                      
                      <div className="absolute top-0 left-1/2 w-36 h-20 border-2 border-white border-t-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute top-0 left-1/2 w-24 h-10 border-2 border-white border-t-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute left-1/2 w-16 h-16 border-2 border-white opacity-90 rounded-full border-t-0 border-l-0 border-r-0" style={{ top: '48px', transform: 'translateX(-50%) scaleY(0.5)' }}></div>
                      <div className="absolute left-1/2 w-2 h-2 bg-white opacity-90 rounded-full" style={{ top: '70px', transform: 'translateX(-50%)' }}></div>
                      
                      <div className="absolute top-1/2 left-0 right-0 h-0.5 bg-white opacity-90" style={{ transform: 'translateY(-50%)' }}></div>
                      
                      <div className="absolute top-1/2 left-1/2 w-24 h-24 border-2 border-white opacity-90 rounded-full" style={{ transform: 'translate(-50%, -50%)' }}></div>
                      <div className="absolute top-1/2 left-1/2 w-2 h-2 bg-white opacity-90 rounded-full" style={{ transform: 'translate(-50%, -50%)' }}></div>
                      
                      <div className="absolute bottom-0 left-1/2 w-36 h-20 border-2 border-white border-b-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute bottom-0 left-1/2 w-24 h-10 border-2 border-white border-b-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute left-1/2 w-16 h-16 border-2 border-white opacity-90 rounded-full border-b-0 border-l-0 border-r-0" style={{ bottom: '48px', transform: 'translateX(-50%) scaleY(0.5)' }}></div>
                      <div className="absolute left-1/2 w-2 h-2 bg-white opacity-90 rounded-full" style={{ bottom: '70px', transform: 'translateX(-50%)' }}></div>
                      
                      <div className="absolute bottom-0 left-1/2 w-20 h-1 bg-white opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute bottom-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(-40px)' }}></div>
                      <div className="absolute bottom-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(40px)' }}></div>
                      
                      <div className="absolute top-0 left-0 w-6 h-6 border-2 border-white opacity-90 rounded-br-full border-t-0 border-l-0"></div>
                      <div className="absolute top-0 left-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute top-0 left-0 w-2.5 h-2 bg-yellow-400 opacity-90"></div>
                      
                      <div className="absolute top-0 right-0 w-6 h-6 border-2 border-white opacity-90 rounded-bl-full border-t-0 border-r-0"></div>
                      <div className="absolute top-0 right-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute top-0 right-0 w-2.5 h-2 bg-yellow-400 opacity-90" style={{ transform: 'translateX(-2.5px)' }}></div>
                      
                      <div className="absolute bottom-0 left-0 w-6 h-6 border-2 border-white opacity-90 rounded-tr-full border-b-0 border-l-0"></div>
                      <div className="absolute bottom-0 left-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute bottom-0 left-0 w-2.5 h-2 bg-yellow-400 opacity-90"></div>
                      
                      <div className="absolute bottom-0 right-0 w-6 h-6 border-2 border-white opacity-90 rounded-tl-full border-b-0 border-r-0"></div>
                      <div className="absolute bottom-0 right-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute bottom-0 right-0 w-2.5 h-2 bg-yellow-400 opacity-90" style={{ transform: 'translateX(-2.5px)' }}></div>
                      
                      <div className="absolute inset-0 opacity-10" style={{
                        backgroundImage: 'repeating-linear-gradient(90deg, transparent, transparent 8%, rgba(255,255,255,0.1) 8%, rgba(255,255,255,0.1) 16%)'
                      }}></div>
                    </div>
                    
                    {layoutCorrente.map((pos, idx) => {
                      const giocatoreAssegnato = currentModulo.posizioni[pos.pos];
                      const giocatore = giocatoreAssegnato ? players.find(p => p.numero === giocatoreAssegnato) : null;
                      
                      // Ottieni offset salvato per questa posizione
                      const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                      const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                      const offsets = matchModulo.moduli?.[moduloCorrente]?.offsets || {};
                      const offset = offsets[pos.pos] || { x: 0, y: 0 };
                      
                      // Calcola posizione finale con offset
                      const finalTop = `calc(${pos.top} + ${offset.y}px)`;
                      const finalLeft = `calc(${pos.left} + ${offset.x}px)`;
                      
                      return (
                        <div
                          key={pos.pos}
                          className="absolute"
                          style={{ 
                            top: finalTop, 
                            left: finalLeft, 
                            transform: 'translate(-50%, -50%)'
                          }}
                          onDragOver={(e) => {
                            e.preventDefault();
                          }}
                        >
                          {giocatore ? (
                            <div 
                              className="relative group" 
                              draggable="true"
                              onDragStart={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                const campoRect = e.currentTarget.closest('.relative.w-full').getBoundingClientRect();
                                
                                setDragState({
                                  matchId: match.id,
                                  pos: pos.pos,
                                  startX: e.clientX,
                                  startY: e.clientY,
                                  campoRect: {
                                    width: campoRect.width,
                                    height: campoRect.height,
                                    left: campoRect.left,
                                    top: campoRect.top
                                  }
                                });
                                
                                e.dataTransfer.effectAllowed = 'move';
                              }}
                              onDragEnd={(e) => {
                                if (!dragState || dragState.matchId !== match.id || dragState.pos !== pos.pos) {
                                  setDragState(null);
                                  return;
                                }
                                
                                // Calcola quanto Ã¨ stato trascinato
                                const deltaX = e.clientX - dragState.startX;
                                const deltaY = e.clientY - dragState.startY;
                                
                                // Se movimento minimo, ignora (click accidentale)
                                if (Math.abs(deltaX) < 5 && Math.abs(deltaY) < 5) {
                                  setDragState(null);
                                  return;
                                }
                                
                                // Salva offset
                                const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                                const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                                const moduliAggiornati = { ...matchModulo.moduli };
                                
                                if (!moduliAggiornati[moduloCorrente]) {
                                  moduliAggiornati[moduloCorrente] = { posizioni: {}, offsets: {} };
                                }
                                
                                const currentOffsets = { ...(moduliAggiornati[moduloCorrente].offsets || {}) };
                                const existingOffset = currentOffsets[pos.pos] || { x: 0, y: 0 };
                                
                                // Aggiungi il nuovo offset a quello esistente
                                currentOffsets[pos.pos] = { 
                                  x: Math.round(existingOffset.x + deltaX), 
                                  y: Math.round(existingOffset.y + deltaY) 
                                };
                                
                                moduliAggiornati[moduloCorrente] = {
                                  ...moduliAggiornati[moduloCorrente],
                                  offsets: currentOffsets
                                };
                                
                                setModuloTattico({
                                  ...moduloTattico,
                                  [match.id]: {
                                    moduloCorrente: moduloCorrente,
                                    moduli: moduliAggiornati
                                  }
                                });
                                
                                setDragState(null);
                              }}
                              style={{ cursor: 'move' }}
                            >
                              <div className="relative" style={{ width: '39px', height: '49px' }}>
                                <div className="absolute -bottom-1 left-1/2 w-12 h-2.5 bg-black opacity-30 rounded-full blur-sm" style={{ transform: 'translateX(-50%)' }}></div>
                                
                                <svg viewBox="0 0 40 50" className="w-full h-full drop-shadow-md">
                                  <rect x="14" y="32" width="4" height="12" fill="#FF6B35" rx="2"/>
                                  <rect x="22" y="32" width="4" height="12" fill="#FF6B35" rx="2"/>
                                  <rect x="14" y="42" width="4" height="6" fill="#1a1a1a" rx="1"/>
                                  <rect x="22" y="42" width="4" height="6" fill="#1a1a1a" rx="1"/>
                                  
                                  <rect x="12" y="18" width="16" height="16" fill="#FF6B35" rx="3"/>
                                  <rect x="14" y="20" width="12" height="2" fill="#FF8C42" opacity="0.6"/>
                                  
                                  <rect x="8" y="20" width="4" height="10" fill="#FF6B35" rx="2"/>
                                  <rect x="28" y="20" width="4" height="10" fill="#FF6B35" rx="2"/>
                                  
                                  <circle cx="20" cy="12" r="6" fill="#FFD4B2"/>
                                  
                                  <path d="M 14 10 Q 14 6 20 6 Q 26 6 26 10" fill="#3d2817"/>
                                </svg>
                                
                                <div className="absolute top-4 left-1/2 transform -translate-x-1/2 text-white font-bold" style={{ fontSize: '16px', textShadow: '1px 1px 2px rgba(0,0,0,0.8)' }}>
                                  {(match.ordineDistinta && match.ordineDistinta[giocatore.numero]) || giocatore.numero}
                                </div>
                              </div>
                              
                              <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-center whitespace-nowrap">
                                <div className="bg-white px-1 py-0.5 rounded shadow-sm border border-gray-300">
                                  <div className="font-bold text-gray-900" style={{ fontSize: '8px' }}>
                                    {giocatore.nome}
                                  </div>
                                  <div className="text-blue-600 font-semibold" style={{ fontSize: '7px' }}>{pos.pos}</div>
                                </div>
                              </div>
                              
                              <button
                                onClick={() => {
                                  const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                                  const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                                  const moduliAggiornati = { ...matchModulo.moduli };
                                  
                                  const newPosizioni = { ...(moduliAggiornati[moduloCorrente]?.posizioni || {}) };
                                  delete newPosizioni[pos.pos];
                                  
                                  moduliAggiornati[moduloCorrente] = {
                                    ...moduliAggiornati[moduloCorrente],
                                    posizioni: newPosizioni
                                  };
                                  
                                  setModuloTattico({
                                    ...moduloTattico, 
                                    [match.id]: { 
                                      moduloCorrente: moduloCorrente,
                                      moduli: moduliAggiornati 
                                    }
                                  });
                                }}
                                className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 text-white rounded-full font-normal hover:bg-red-600 shadow-sm opacity-40 hover:opacity-100"
                                style={{ zIndex: 10, fontSize: '6px' }}
                              >
                                âœ•
                              </button>
                              
                              {offset.x !== 0 || offset.y !== 0 ? (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                                    const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                                    const moduliAggiornati = { ...matchModulo.moduli };
                                    
                                    const currentOffsets = { ...(moduliAggiornati[moduloCorrente]?.offsets || {}) };
                                    delete currentOffsets[pos.pos];
                                    
                                    moduliAggiornati[moduloCorrente] = {
                                      ...moduliAggiornati[moduloCorrente],
                                      offsets: currentOffsets
                                    };
                                    
                                    setModuloTattico({
                                      ...moduloTattico,
                                      [match.id]: {
                                        moduloCorrente: moduloCorrente,
                                        moduli: moduliAggiornati
                                      }
                                    });
                                  }}
                                  className="absolute -top-1 -left-1 w-3 h-3 bg-blue-500 text-white rounded-full font-normal hover:bg-blue-600 shadow-sm opacity-40 hover:opacity-100"
                                  style={{ zIndex: 10, fontSize: '6px' }}
                                  title="Reset posizione"
                                >
                                  â†º
                                </button>
                              ) : null}
                            </div>
                          ) : (
                            <button
                              onClick={() => {
                                setPlayerSelectionModal({ matchId: match.id, posizione: pos.pos });
                              }}
                              className="relative hover:opacity-100 transition-opacity cursor-pointer"
                              style={{ width: '34px', height: '43px' }}
                            >
                              <svg viewBox="0 0 40 50" className="w-full h-full opacity-40 hover:opacity-60">
                                <rect x="14" y="32" width="4" height="12" fill="#999" rx="2"/>
                                <rect x="22" y="32" width="4" height="12" fill="#999" rx="2"/>
                                <rect x="12" y="18" width="16" height="16" fill="#999" rx="3"/>
                                <rect x="8" y="20" width="4" height="10" fill="#999" rx="2"/>
                                <rect x="28" y="20" width="4" height="10" fill="#999" rx="2"/>
                                <circle cx="20" cy="12" r="6" fill="#999"/>
                                <circle cx="20" cy="25" r="8" fill="#4CAF50" opacity="0.8"/>
                                <text x="20" y="30" textAnchor="middle" fill="white" fontSize="14" fontWeight="bold">+</text>
                              </svg>
                              <div className="absolute -bottom-7 left-1/2 transform -translate-x-1/2 text-center">
                                <div className="bg-gray-400 text-white px-1 py-0.5 rounded font-semibold" style={{ fontSize: '7px' }}>
                                  {pos.pos}
                                </div>
                              </div>
                            </button>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  
                  <div className="mt-20">
                    <h3 className="text-lg font-bold text-gray-800 mb-3">Giocatori da Assegnare:</h3>
                    <div className="grid grid-cols-2 gap-3">
                      {titolari.filter(p => !Object.values(currentModulo.posizioni).includes(p.numero)).sort((a, b) => {
                        const numA = parseInt((match.ordineDistinta && match.ordineDistinta[a.numero]) || a.numero);
                        const numB = parseInt((match.ordineDistinta && match.ordineDistinta[b.numero]) || b.numero);
                        return numA - numB;
                      }).map(player => (
                        <div key={player.numero} className="border rounded-lg p-3 bg-gray-50">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">
                              {(match.ordineDistinta && match.ordineDistinta[player.numero]) || player.numero}
                            </div>
                            <div className="flex-1">
                              <div className="font-bold text-sm">{player.nome}</div>
                              <div className="text-xs text-gray-600">{player.ruolo}</div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {Object.keys(currentModulo.posizioni).length === 11 && (
                    <div className="mt-6 p-4 bg-green-100 border border-green-400 rounded-lg text-center">
                      âœ… Modulo completo! Tutti i giocatori sono stati assegnati.
                    </div>
                  )}
                </div>
              )}
              
              <div className="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 className="font-bold text-sm mb-2">ðŸ“‹ Legenda Posizioni:</h4>
                <div className="grid grid-cols-4 gap-2 text-xs">
                  <div><strong>P:</strong> Portiere</div>
                  <div><strong>TD:</strong> Terzino Dx</div>
                  <div><strong>TS:</strong> Terzino Sx</div>
                  <div><strong>DC:</strong> Difensore Centrale</div>
                  <div><strong>ED:</strong> Esterno Dx</div>
                  <div><strong>ES:</strong> Esterno Sx</div>
                  <div><strong>CC:</strong> Centrocampista Centrale</div>
                  <div><strong>MC:</strong> Mezzala Centrale</div>
                  <div><strong>MD:</strong> Mediano</div>
                  <div><strong>TQ:</strong> Trequartista</div>
                  <div><strong>AD:</strong> Attaccante Dx</div>
                  <div><strong>AS:</strong> Attaccante Sx</div>
                  <div><strong>PC:</strong> Punta Centrale</div>
                  <div><strong>AE:</strong> Ala Esterna</div>
                </div>
              </div>
            </div>
          </>
        );
      })()}
    </div>
  </div>
)}

{playerSelectionModal && (() => {
  const match = matches.find(m => m.id === playerSelectionModal.matchId);
  const titolari = players.filter(p => match.titolari[p.numero]);
  const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
  const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
  const posizioniModuloCorrente = (matchModulo.moduli[moduloCorrente] || {}).posizioni || {};
  
  const giocatoriDisponibili = titolari.filter(p => 
    !Object.values(posizioniModuloCorrente).includes(p.numero)
  ).sort((a, b) => {
    const numA = parseInt((match.ordineDistinta && match.ordineDistinta[a.numero]) || a.numero);
    const numB = parseInt((match.ordineDistinta && match.ordineDistinta[b.numero]) || b.numero);
    return numA - numB;
  });
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setPlayerSelectionModal(null)}>
      <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={(e) => e.stopPropagation()}>
        <div className="p-4 border-b bg-blue-600 text-white rounded-t-lg">
          <div className="flex justify-between items-center">
            <h3 className="text-xl font-bold">Seleziona Giocatore per {playerSelectionModal.posizione}</h3>
            <button onClick={() => setPlayerSelectionModal(null)} className="text-white hover:text-gray-200 text-2xl">âœ•</button>
          </div>
        </div>
        
        <div className="p-4 max-h-[60vh] overflow-y-auto">
          {giocatoriDisponibili.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              <p className="text-lg font-semibold">Nessun giocatore disponibile</p>
              <p className="text-sm mt-2">Tutti i giocatori sono giÃ  assegnati</p>
            </div>
          ) : (
            <div className="space-y-2">
              {giocatoriDisponibili.map(player => (
                <button
                  key={player.numero}
                  onClick={() => {
                    const moduliAggiornati = { ...matchModulo.moduli };
                    
                    moduliAggiornati[moduloCorrente] = {
                      ...moduliAggiornati[moduloCorrente],
                      posizioni: { 
                        ...(moduliAggiornati[moduloCorrente]?.posizioni || {}), 
                        [playerSelectionModal.posizione]: player.numero 
                      }
                    };
                    
                    setModuloTattico({
                      ...moduloTattico,
                      [match.id]: {
                        moduloCorrente: moduloCorrente,
                        moduli: moduliAggiornati
                      }
                    });
                    
                    setPlayerSelectionModal(null);
                  }}
                  className="w-full flex items-center gap-4 p-3 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors border-2 border-transparent hover:border-blue-500"
                >
                  <div className="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg flex-shrink-0">
                    {(match.ordineDistinta && match.ordineDistinta[player.numero]) || player.numero}
                  </div>
                  <div className="text-left flex-1">
                    <div className="font-bold text-gray-900 text-lg">{player.nome}</div>
                    <div className="text-sm text-gray-600">{player.ruolo}</div>
                  </div>
                  <div className="text-blue-600 font-bold text-xl">â†’</div>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
})()}

{activeTab === 'stats' && (
            <div className="flex flex-col h-[calc(100vh-280px)] stats-container-mobile">
              {/* Header con Mini Stats - FISSO */}
              <div className="flex-shrink-0 mb-2">
                <h2 className="text-2xl md:text-2xl font-bold text-gray-800 mb-2 md:mb-3">ðŸ“Š Statistiche Giocatori</h2>
                
                {/* Mini Stats Cards - Desktop: Grid 4 col */}
                <div className="hidden md:grid md:grid-cols-4 gap-2 mb-3">
                  <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-3 text-white shadow-md">
                    <div className="text-xs opacity-90">Giocatori</div>
                    <div className="flex items-baseline gap-2">
                      <div className="text-2xl font-bold">
                        {calculateStats().filter(s => {
                          const player = players.find(p => p.nome === s.nome);
                          return player && !player.fuoriRosa;
                        }).length}
                      </div>
                      <div className="text-sm opacity-90">Attivi</div>
                    </div>
                    <div className="text-sm opacity-90 mt-1">
                      {calculateStats().length} Stagione
                    </div>
                  </div>
                  <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-3 text-white shadow-md">
                    <div className="text-xs opacity-90">Gol Totali</div>
                    <div className="text-2xl font-bold">{calculateStats().reduce((sum, s) => sum + s.gol, 0)}</div>
                  </div>
                  <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-3 text-white shadow-md">
                    <div className="text-xs opacity-90">Assist Totali</div>
                    <div className="text-2xl font-bold">{calculateStats().reduce((sum, s) => sum + s.assist, 0)}</div>
                  </div>
                  <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-3 text-white shadow-md">
                    <div className="text-xs opacity-90">% Presenze Media</div>
                    <div className="text-2xl font-bold">
                      {calculateStats().length > 0 
                        ? (() => {
                            const allStats = calculateStats();
                            const avgPerc = allStats.reduce((sum, s) => {
                              const tot = s.allenamenti_presenze + s.allenamenti_assenze;
                              return sum + (tot > 0 ? (s.allenamenti_presenze / tot) * 100 : 0);
                            }, 0) / allStats.length;
                            return Math.round(avgPerc);
                          })()
                        : 0}%
                    </div>
                  </div>
                </div>
                
                {/* Mobile Portrait: UNA RIGA compatta */}
                <div className="block sm:hidden stats-mobile-portrait">
                  <div className="flex items-center justify-between gap-2 text-[10px] mb-2 px-1">
                    <div className="flex flex-col items-center">
                      <span className="text-blue-600 font-bold text-lg">
                        {calculateStats().filter(s => {
                          const player = players.find(p => p.nome === s.nome);
                          return player && !player.fuoriRosa;
                        }).length}
                      </span>
                      <span className="text-gray-600">Attivi</span>
                    </div>
                    <div className="flex flex-col items-center">
                      <span className="text-gray-600 font-bold text-lg">{calculateStats().length}</span>
                      <span className="text-gray-600">Stagione</span>
                    </div>
                    <div className="flex flex-col items-center">
                      <span className="text-green-600 font-bold text-lg">{calculateStats().reduce((sum, s) => sum + s.gol, 0)}</span>
                      <span className="text-gray-600">Gol</span>
                    </div>
                    <div className="flex flex-col items-center">
                      <span className="text-purple-600 font-bold text-lg">{calculateStats().reduce((sum, s) => sum + s.assist, 0)}</span>
                      <span className="text-gray-600">Assist</span>
                    </div>
                    <div className="flex flex-col items-center">
                      <span className="text-orange-600 font-bold text-lg">
                        {calculateStats().length > 0 
                          ? (() => {
                              const allStats = calculateStats();
                              const avgPerc = allStats.reduce((sum, s) => {
                                const tot = s.allenamenti_presenze + s.allenamenti_assenze;
                                return sum + (tot > 0 ? (s.allenamenti_presenze / tot) * 100 : 0);
                              }, 0) / allStats.length;
                              return Math.round(avgPerc);
                            })()
                          : 0}%
                      </span>
                      <span className="text-gray-600">Pres</span>
                    </div>
                  </div>
                </div>
                
                {/* Mobile Landscape: NASCOSTI (troppo spazio occupato) */}
                <style>{`
                  @media (max-width: 640px) and (orientation: landscape) {
                    .stats-mobile-portrait {
                      display: none !important;
                    }
                  }
                `}</style>
              </div>
              
              {/* Layout DESKTOP - Tabella Moderna - SCROLLABILE */}
              <div className="hidden md:block flex-1 overflow-y-auto">
                <div className="bg-white rounded-lg shadow-lg">
                  <table className="w-full text-xs">
                    <thead className="bg-gradient-to-r from-blue-600 to-blue-700 text-white sticky top-0">
                      <tr>
                        <th className="p-3 text-left font-bold">NÂ°</th>
                        <th className="p-3 text-left font-bold">Nome</th>
                        <th className="p-3 text-left font-bold">Ruolo</th>
                        <th className="p-3 text-center font-bold">Presenze</th>
                        <th className="p-3 text-center font-bold">% Pres.</th>
                        <th className="p-3 text-center font-bold">Infortuni</th>
                        <th className="p-3 text-center font-bold">Convocato</th>
                        <th className="p-3 text-center font-bold">% Conv.</th>
                        <th className="p-3 text-center font-bold">Titolare</th>
                        <th className="p-3 text-center font-bold">Minuti</th>
                        <th className="p-3 text-center font-bold">Gol/Sub</th>
                        <th className="p-3 text-center font-bold">Assist</th>
                        <th className="p-3 text-center font-bold">Gialli</th>
                        <th className="p-3 text-center font-bold">Rossi</th>
                      </tr>
                    </thead>
                    <tbody>
                      {calculateStats().map((stat, index) => {
                        const totAllenamenti = stat.allenamenti_presenze + stat.allenamenti_assenze;
                        const percPresenze = totAllenamenti > 0 ? ((stat.allenamenti_presenze / totAllenamenti) * 100).toFixed(0) : 0;
                        const totPartite = matches.length;
                        const percConvocazioni = totPartite > 0 ? ((stat.partite_convocato / totPartite) * 100).toFixed(0) : 0;
                        const totGialli = stat.gialli_gioco + stat.gialli_protesta;
                        const totRossi = stat.rossi_gioco + stat.rossi_protesta;
                        
                        // Find top 3 for highlighting
                        const allStats = calculateStats();
                        const topGol = [...allStats].sort((a, b) => b.gol - a.gol).slice(0, 3).map(s => s.nome);
                        const topAssist = [...allStats].sort((a, b) => b.assist - a.assist).slice(0, 3).map(s => s.nome);
                        const topMinuti = [...allStats].sort((a, b) => b.minuti_totali - a.minuti_totali).slice(0, 3).map(s => s.nome);
                        
                        return (
                          <tr 
                            key={stat.nome} 
                            className={`
                              ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}
                              hover:bg-blue-50 transition-colors cursor-pointer
                            `}
                          >
                            <td className="p-3">
                              <div className="w-8 h-8 rounded-full bg-gradient-to-br from-gray-600 to-gray-700 text-white flex items-center justify-center font-bold">
                                {index + 1}
                              </div>
                            </td>
                            <td className="p-3 font-semibold text-gray-800">{stat.nome}</td>
                            <td className="p-3">
                              <span className={`
                                px-3 py-1 rounded-full text-xs font-semibold
                                ${stat.ruolo === 'Portiere' ? 'bg-yellow-100 text-yellow-700' : ''}
                                ${stat.ruolo === 'Difensore' ? 'bg-blue-100 text-blue-700' : ''}
                                ${stat.ruolo === 'Centrocampista' ? 'bg-green-100 text-green-700' : ''}
                                ${stat.ruolo === 'Attaccante' ? 'bg-red-100 text-red-700' : ''}
                              `}>
                                {stat.ruolo}
                              </span>
                            </td>
                            <td className="p-3 text-center font-semibold">{stat.allenamenti_presenze}</td>
                            <td className="p-3 text-center">
                              <span className={`
                                px-3 py-1 rounded-full font-bold text-xs
                                ${percPresenze >= 80 ? 'bg-green-100 text-green-700' : ''}
                                ${percPresenze >= 60 && percPresenze < 80 ? 'bg-yellow-100 text-yellow-700' : ''}
                                ${percPresenze < 60 ? 'bg-red-100 text-red-700' : ''}
                              `}>
                                {percPresenze}%
                              </span>
                            </td>
                            <td className="p-3 text-center">
                              {stat.infortuni > 0 ? (
                                <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full font-bold text-xs">
                                  {stat.infortuni}
                                </span>
                              ) : (
                                <span className="text-gray-400">-</span>
                              )}
                            </td>
                            <td className="p-3 text-center font-semibold">{stat.partite_convocato}</td>
                            <td className="p-3 text-center">
                              <span className={`
                                px-3 py-1 rounded-full font-bold text-xs
                                ${percConvocazioni >= 70 ? 'bg-blue-100 text-blue-700' : ''}
                                ${percConvocazioni >= 40 && percConvocazioni < 70 ? 'bg-gray-100 text-gray-700' : ''}
                                ${percConvocazioni < 40 ? 'bg-red-100 text-red-600' : ''}
                              `}>
                                {percConvocazioni}%
                              </span>
                            </td>
                            <td className="p-3 text-center font-semibold text-purple-600">{stat.partite_titolare}</td>
                            <td className="p-3 text-center">
                              <span className={`
                                font-bold text-sm
                                ${topMinuti.includes(stat.nome) ? 'text-indigo-600' : 'text-gray-700'}
                              `}>
                                {stat.minuti_totali}
                              </span>
                            </td>
                            <td className="p-3 text-center">
                              {stat.ruolo === 'Portiere' ? (
                                // PORTIERE: Mostra GOL SUBITI
                                stat.gol_subiti > 0 ? (
                                  <div className="inline-flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm bg-red-100 text-red-700">
                                    {stat.gol_subiti}
                                  </div>
                                ) : (
                                  <span className="text-gray-400">-</span>
                                )
                              ) : (
                                // ALTRI RUOLI: Mostra GOL FATTI
                                stat.gol > 0 ? (
                                  <div className={`
                                    inline-flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm
                                    ${topGol.includes(stat.nome) ? 'bg-gradient-to-br from-green-500 to-green-600 text-white shadow-md' : 'bg-green-100 text-green-700'}
                                  `}>
                                    {stat.gol}
                                  </div>
                                ) : (
                                  <span className="text-gray-400">-</span>
                                )
                              )}
                            </td>
                            <td className="p-3 text-center">
                              {stat.assist > 0 ? (
                                <div className={`
                                  inline-flex items-center justify-center w-10 h-10 rounded-full font-bold text-sm
                                  ${topAssist.includes(stat.nome) ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md' : 'bg-blue-100 text-blue-700'}
                                `}>
                                  {stat.assist}
                                </div>
                              ) : (
                                <span className="text-gray-400">-</span>
                              )}
                            </td>
                            <td className="p-3 text-center">
                              {totGialli > 0 ? (
                                <span className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full font-bold text-xs">
                                  {totGialli}
                                </span>
                              ) : (
                                <span className="text-gray-400">-</span>
                              )}
                            </td>
                            <td className="p-3 text-center">
                              {totRossi > 0 ? (
                                <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full font-bold text-xs">
                                  {totRossi}
                                </span>
                              ) : (
                                <span className="text-gray-400">-</span>
                              )}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
              
              {/* Layout MOBILE - Card Moderne - SCROLLABILE */}
              <div className="block md:hidden flex-1 overflow-y-auto">
                <div className="w-full space-y-4 pb-4">
                  {calculateStats().map((stat, index) => {
                    const totAllenamenti = stat.allenamenti_presenze + stat.allenamenti_assenze;
                    const percPresenze = totAllenamenti > 0 ? ((stat.allenamenti_presenze / totAllenamenti) * 100).toFixed(0) : 0;
                    const totPartite = matches.length;
                    const percConvocazioni = totPartite > 0 ? ((stat.partite_convocato / totPartite) * 100).toFixed(0) : 0;
                    const percTitolarita = totPartite > 0 ? ((stat.partite_titolare / totPartite) * 100).toFixed(0) : 0;
                    const totGialli = stat.gialli_gioco + stat.gialli_protesta;
                    const totRossi = stat.rossi_gioco + stat.rossi_protesta;
                    
                    return (
                      <div key={stat.nome} className="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
                        {/* Header Card con Gradient */}
                        <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4">
                          <div className="flex items-center gap-3">
                            <div className="w-12 h-12 rounded-full bg-white bg-opacity-20 flex items-center justify-center font-bold text-xl">
                              {index + 1}
                            </div>
                            <div className="flex-1">
                              <div className="font-bold text-lg">{stat.nome}</div>
                              <div className="text-xs opacity-90">{stat.ruolo}</div>
                            </div>
                          </div>
                        </div>
                        
                        <div className="p-4 space-y-4">
                          {/* Allenamenti con Progress Bar */}
                          <div>
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-sm font-bold text-gray-700">Allenamenti</span>
                              <span className={`
                                px-3 py-1 rounded-full font-bold text-xs
                                ${percPresenze >= 80 ? 'bg-green-100 text-green-700' : ''}
                                ${percPresenze >= 60 && percPresenze < 80 ? 'bg-yellow-100 text-yellow-700' : ''}
                                ${percPresenze < 60 ? 'bg-red-100 text-red-700' : ''}
                              `}>
                                {percPresenze}%
                              </span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                              <div 
                                className={`
                                  h-full rounded-full transition-all duration-500
                                  ${percPresenze >= 80 ? 'bg-gradient-to-r from-green-500 to-green-600' : ''}
                                  ${percPresenze >= 60 && percPresenze < 80 ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' : ''}
                                  ${percPresenze < 60 ? 'bg-gradient-to-r from-red-500 to-red-600' : ''}
                                `}
                                style={{ width: `${percPresenze}%` }}
                              ></div>
                            </div>
                            <div className="flex justify-between mt-1 text-xs text-gray-600">
                              <span>Presenze: {stat.allenamenti_presenze}</span>
                              <span>Assenze: {stat.allenamenti_assenze}</span>
                            </div>
                          </div>
                          
                          {/* Stats Principali - Grid 3 colonne */}
                          <div className="grid grid-cols-3 gap-3">
                            {/* Gol o Gol Subiti (per portieri) */}
                            {stat.ruolo === 'Portiere' ? (
                              <div className="text-center bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-3 border border-red-200">
                                <div className="text-xs text-red-700 font-semibold mb-1">Gol Sub</div>
                                <div className="text-3xl font-bold text-red-600">{stat.gol_subiti}</div>
                              </div>
                            ) : (
                              <div className="text-center bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-3 border border-green-200">
                                <div className="text-xs text-green-700 font-semibold mb-1">Gol</div>
                                <div className="text-3xl font-bold text-green-600">{stat.gol}</div>
                              </div>
                            )}
                            
                            {/* Assist */}
                            <div className="text-center bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-3 border border-blue-200">
                              <div className="text-xs text-blue-700 font-semibold mb-1">Assist</div>
                              <div className="text-3xl font-bold text-blue-600">{stat.assist}</div>
                            </div>
                            
                            {/* Minuti */}
                            <div className="text-center bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-3 border border-purple-200">
                              <div className="text-xs text-purple-700 font-semibold mb-1">Minuti</div>
                              <div className="text-2xl font-bold text-purple-600">{stat.minuti_totali}</div>
                            </div>
                          </div>
                          
                          {/* Partite Info */}
                          <div className="grid grid-cols-2 gap-3">
                            <div className="bg-gray-50 rounded-lg p-3">
                              <div className="text-xs text-gray-600 mb-1">Convocazioni</div>
                              <div className="flex items-center justify-between">
                                <span className="font-bold text-gray-800">{stat.partite_convocato}</span>
                                <span className="text-xs font-semibold text-blue-600">{percConvocazioni}%</span>
                              </div>
                            </div>
                            <div className="bg-gray-50 rounded-lg p-3">
                              <div className="text-xs text-gray-600 mb-1">Titolare</div>
                              <div className="flex items-center justify-between">
                                <span className="font-bold text-gray-800">{stat.partite_titolare}</span>
                                <span className="text-xs font-semibold text-purple-600">{percTitolarita}%</span>
                              </div>
                            </div>
                          </div>
                          
                          {/* Footer con Badge */}
                          <div className="flex items-center justify-between pt-3 border-t">
                            {stat.infortuni > 0 && (
                              <span className="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-bold">
                                {stat.infortuni} Infortuni
                              </span>
                            )}
                            <div className="flex gap-2 ml-auto">
                              {totGialli > 0 && (
                                <span className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold">
                                  {totGialli} Gialli
                                </span>
                              )}
                              {totRossi > 0 && (
                                <span className="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-bold">
                                  {totRossi} Rossi
                                </span>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
              
              {/* Pulsante Export PDF - Visibile su Desktop e Mobile */}
              <div className="flex-shrink-0 mt-4 pt-4 border-t border-gray-200">
                <button
                  onClick={exportStatsPDF}
                  className="w-full md:w-auto px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition-all font-semibold shadow-md hover:shadow-lg flex items-center justify-center gap-2"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                  </svg>
                  Esporta Statistiche in PDF
                </button>
              </div>
            </div>
          )}

{activeTab === 'top' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">ðŸ† Giocatori TOP</h2>
              <p className="text-gray-600 mb-4">I migliori 3 giocatori per ogni categoria</p>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border-2 border-blue-300">
                  <h3 className="text-lg font-bold text-blue-800 mb-3">ðŸŽ¯ Top Presenze Allenamenti</h3>
                  <div className="space-y-2">
                    {calculateStats().sort((a, b) => b.allenamenti_presenze - a.allenamenti_presenze).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-blue-600">{p.allenamenti_presenze}</div>
                          <div className="text-xs text-gray-500">presenze</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border-2 border-green-300">
                  <h3 className="text-lg font-bold text-green-800 mb-3">âš½ Top Gol</h3>
                  <div className="space-y-2">
                    {calculateStats().filter(p => p.gol > 0).sort((a, b) => b.gol - a.gol).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-green-600">{p.gol}</div>
                          <div className="text-xs text-gray-500">gol</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => p.gol > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun gol segnato</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border-2 border-purple-300">
                  <h3 className="text-lg font-bold text-purple-800 mb-3">ðŸŽ¯ Top Assist</h3>
                  <div className="space-y-2">
                    {calculateStats().filter(p => p.assist > 0).sort((a, b) => b.assist - a.assist).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-purple-600">{p.assist}</div>
                          <div className="text-xs text-gray-500">assist</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => p.assist > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun assist</div>
                    )}
                  </div>
                </div>

                {/* ========== TOP MVP ========== */}
                <div className="bg-gradient-to-br from-amber-50 to-yellow-100 rounded-lg p-4 border-2 border-amber-300">
                  <h3 className="text-lg font-bold text-amber-800 mb-3">ðŸ† Top MVP</h3>
                  <div className="space-y-2">
                    {(() => {
                      const leaderboard = getMVPLeaderboard().slice(0, 3);
                      
                      if (leaderboard.length === 0) {
                        return (
                          <div className="text-center text-gray-500 py-4">Nessun MVP assegnato</div>
                        );
                      }
                      
                      return leaderboard.map((entry, i) => (
                        <div key={entry.playerNum} className="bg-white rounded-lg p-3 flex items-center gap-3">
                          <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                            {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                          </div>
                          <div className="flex-1">
                            <div className="font-semibold">{entry.playerName}</div>
                            <div className="text-xs text-gray-600">#{entry.playerNum}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-2xl font-bold text-amber-600">{entry.mvpCount}</div>
                            <div className="text-xs text-gray-500">MVP</div>
                          </div>
                        </div>
                      ));
                    })()}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border-2 border-yellow-300">
                  <h3 className="text-lg font-bold text-yellow-800 mb-3">ðŸŸ¨ Top Cartellini Gialli</h3>
                  <div className="space-y-2">
                    {calculateStats().map(p => ({...p, totGialli: p.gialli_gioco + p.gialli_protesta})).filter(p => p.totGialli > 0).sort((a, b) => b.totGialli - a.totGialli).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-yellow-600">{p.totGialli}</div>
                          <div className="text-xs text-gray-500">gialli</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => (p.gialli_gioco + p.gialli_protesta) > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun cartellino giallo</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border-2 border-red-300">
                  <h3 className="text-lg font-bold text-red-800 mb-3">ðŸŸ¥ Top Cartellini Rossi</h3>
                  <div className="space-y-2">
                    {calculateStats().map(p => ({...p, totRossi: p.rossi_gioco + p.rossi_protesta})).filter(p => p.totRossi > 0).sort((a, b) => b.totRossi - a.totRossi).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-red-600">{p.totRossi}</div>
                          <div className="text-xs text-gray-500">rossi</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => (p.rossi_gioco + p.rossi_protesta) > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun cartellino rosso</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 border-2 border-indigo-300">
                  <h3 className="text-lg font-bold text-indigo-800 mb-3">â±ï¸ Top Minuti Giocati</h3>
                  <div className="space-y-2">
                    {calculateStats().filter(p => p.minuti_totali > 0).sort((a, b) => b.minuti_totali - a.minuti_totali).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-indigo-600">{p.minuti_totali}</div>
                          <div className="text-xs text-gray-500">minuti</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => p.minuti_totali > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun minuto giocato</div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}

{activeTab === 'roster' && (
            <div>
              <div className="flex flex-wrap justify-between items-center gap-3 mb-4">
                <h2 className="text-2xl font-bold text-gray-800">Gestione Rosa</h2>
                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={exportRosaPDF}
                    className="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-md hover:shadow-lg flex items-center gap-2"
                  >
                    <span>ðŸ“‹</span>
                    <span className="hidden sm:inline">Stampa Rosa</span>
                    <span className="sm:hidden">Stampa</span>
                  </button>
                </div>
              </div>
              <div className="space-y-4">
                {players
                  .slice()
                  .sort((a, b) => {
                    if (!a.nome && !b.nome) return a.numero - b.numero;
                    if (!a.nome) return 1;
                    if (!b.nome) return -1;
                    return a.nome.localeCompare(b.nome);
                  })
                  .map((player, index) => (
                  <div key={player.numero} className={`bg-white border rounded-lg p-4 card-hover animate-fade-in roster-player-card ${player.fuoriRosa ? 'opacity-50 border-red-300 bg-red-50' : ''}`} style={{animationDelay: `${index * 0.05}s`}}>
                    <div className="flex gap-4">
                      <div className="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0 relative roster-player-photo">
                        {player.foto ? (
                          <img 
                            src={player.foto} 
                            alt={player.nome} 
                            className="w-full h-full object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity" 
                            onClick={() => setEnlargedPhoto({ foto: player.foto, nome: player.nome })}
                            title="Clicca per ingrandire"
                          />
                        ) : (
                          <div className="text-gray-400 text-center">
                            <div className="text-3xl font-bold">{player.nome ? index + 1 : player.numero}</div>
                          </div>
                        )}
                        {editingPlayer === player.numero && (
                          <label className="absolute bottom-0 right-0 bg-blue-600 text-white p-1 rounded-tl rounded-br cursor-pointer hover:bg-blue-700">
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageUpload(player.numero, e)}
                              className="hidden"
                            />
                            <span className="text-xs">ðŸ“·</span>
                          </label>
                        )}
                      </div>
                      <div className="flex-1">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 roster-player-info">
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Numero</label>
                            <div className="text-xl font-bold text-blue-600 roster-player-number">{player.nome ? index + 1 : player.numero}</div>
                          </div>
                          <div className="md:col-span-2">
                            <label className="text-xs font-semibold text-gray-600">Nome Completo</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="text"
                                value={player.nome}
                                onChange={(e) => updatePlayer(player.numero, 'nome', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                                placeholder="Nome e Cognome"
                              />
                            ) : (
                              <div className="flex items-center gap-2">
                                <div className={player.nome ? 'font-semibold' : 'text-gray-400 italic'}>{player.nome || 'Slot libero'}</div>
                                {player.nome && (
                                  <>
                                    {getPlayerInjury(player.numero) ? (
                                      <span className="injury-badge active" title="Infortunato">ðŸ¤•</span>
                                    ) : (
                                      <span className="injury-badge recovered" title="Disponibile">âœ…</span>
                                    )}
                                  </>
                                )}
                              </div>
                            )}
                          </div>
                          
                          {/* Quick Stats - Solo se giocatore attivo */}
                          {player.nome && editingPlayer !== player.numero && (
                            <div className="md:col-span-3 mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                              <div className="grid grid-cols-5 gap-4 text-center roster-quick-stats">
                                <div>
                                  <div className="text-2xl font-bold text-blue-600">
                                    {matches.reduce((sum, m) => sum + (parseInt(m.golFatti?.[player.numero]) || 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Gol</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-green-600">
                                    {matches.reduce((sum, m) => sum + (parseInt(m.assist?.[player.numero]) || 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Assist</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-purple-600">
                                    {trainings.reduce((sum, t) => sum + (t.presenze[player.numero] ? 1 : 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Allenamenti</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-orange-600">
                                    {matches.reduce((sum, m) => sum + (m.convocati?.[player.numero] ? 1 : 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Convocazioni</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-yellow-600">
                                    {getPlayerMVPCount(player.numero)}
                                  </div>
                                  <div className="text-xs text-gray-600">MVP ðŸ†</div>
                                </div>
                              </div>
                            </div>
                          )}
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Ruolo</label>
                            {editingPlayer === player.numero ? (
                              <select
                                value={player.ruolo}
                                onChange={(e) => updatePlayer(player.numero, 'ruolo', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              >
                                <option value="">Seleziona...</option>
                                <option value="Portiere">Portiere</option>
                                <option value="Difensore centrale">Difensore centrale</option>
                                <option value="Terzino dx">Terzino dx</option>
                                <option value="Terzino sx">Terzino sx</option>
                                <option value="Mediano">Mediano</option>
                                <option value="Centrocampista centrale">Centrocampista centrale</option>
                                <option value="Esterno alto dx">Esterno alto dx</option>
                                <option value="Esterno alto sx">Esterno alto sx</option>
                                <option value="Trequartista">Trequartista</option>
                                <option value="Attaccante">Attaccante</option>
                              </select>
                            ) : (
                              <div className={player.ruolo ? '' : 'text-gray-400 italic'}>{player.ruolo || '-'}</div>
                            )}
                          </div>
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Data di Nascita</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="date"
                                value={player.dataNascita}
                                onChange={(e) => updatePlayer(player.numero, 'dataNascita', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            ) : (
                              <div className={player.dataNascita ? '' : 'text-gray-400 italic'}>
                                {player.dataNascita ? `${player.dataNascita} (${calculateAge(player.dataNascita)} anni)` : '-'}
                              </div>
                            )}
                          </div>
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Piede Preferito</label>
                            {editingPlayer === player.numero ? (
                              <select
                                value={player.piede}
                                onChange={(e) => updatePlayer(player.numero, 'piede', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              >
                                <option value="">Seleziona...</option>
                                <option value="Destro">Destro</option>
                                <option value="Sinistro">Sinistro</option>
                                <option value="Ambidestro">Ambidestro</option>
                              </select>
                            ) : (
                              <div className={player.piede ? '' : 'text-gray-400 italic'}>{player.piede || '-'}</div>
                            )}
                          </div>
                          <div className="md:col-span-2 lg:col-span-3">
                            <label className="text-xs font-semibold text-gray-600">Telefono</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="tel"
                                value={player.telefono}
                                onChange={(e) => updatePlayer(player.numero, 'telefono', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                                placeholder="Numero di telefono"
                              />
                            ) : (
                              <div className={player.telefono ? '' : 'text-gray-400 italic'}>{player.telefono || '-'}</div>
                            )}
                          </div>
                          <div className="md:col-span-2 lg:col-span-3">
                            <label className="text-xs font-semibold text-gray-600">ðŸ“… Data Creazione in Rosa</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="date"
                                value={player.dataCreazione}
                                onChange={(e) => updatePlayer(player.numero, 'dataCreazione', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            ) : (
                              <div className={player.dataCreazione ? 'text-sm' : 'text-gray-400 italic'}>
                                {player.dataCreazione ? `Dal ${new Date(player.dataCreazione).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })}` : 'Non impostata'}
                              </div>
                            )}
                            <div className="text-xs text-gray-500 mt-1">Il giocatore apparirÃ  solo negli allenamenti e partite dalla data indicata</div>
                          </div>
                          <div className="md:col-span-2 lg:col-span-3">
                            <label className="text-xs font-semibold text-gray-600">â›” Stato Giocatore</label>
                            {editingPlayer === player.numero ? (
                              <div className="flex items-center gap-3 mt-1">
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={player.fuoriRosa || false}
                                    onChange={(e) => updatePlayer(player.numero, 'fuoriRosa', e.target.checked)}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-sm">Fuori Rosa</span>
                                </label>
                              </div>
                            ) : (
                              <div className="mt-1">
                                {player.fuoriRosa ? (
                                  <span className="inline-block px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold border-2 border-red-300">
                                    â›” FUORI ROSA
                                  </span>
                                ) : (
                                  <span className="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold border-2 border-green-300">
                                    âœ… IN ROSA
                                  </span>
                                )}
                              </div>
                            )}
                            <div className="text-xs text-gray-500 mt-1">I giocatori fuori rosa non appaiono negli elenchi operativi</div>
                          </div>
                        </div>
                      </div>
                      <div className="flex flex-row md:flex-col gap-2 items-start">
                        {editingPlayer === player.numero ? (
                          <>
                            <button 
                              onClick={() => {
                                setEditingPlayer(null);
                                showToast(`âœ… Giocatore ${player.nome || '#' + player.numero} salvato!`, 'success');
                              }} 
                              className="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 flex items-center gap-1"
                            >
                              <Save size={14} /> Salva
                            </button>
                            <button onClick={() => clearPlayer(player.numero)} className="px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                              Cancella
                            </button>
                          </>
                        ) : (
                          <>
                            <button 
                              onClick={() => setEditingPlayer(player.numero)} 
                              disabled={userRole !== 'admin'}
                              className={`px-3 py-2 rounded text-sm flex-1 md:flex-none ${
                                userRole === 'admin'
                                  ? 'bg-blue-600 text-white hover:bg-blue-700'
                                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                              }`}
                              title={userRole !== 'admin' ? 'Solo Admin puÃ² modificare' : ''}
                            >
                              Modifica
                            </button>
                            {player.nome && (
                              <button 
                                onClick={() => downloadPlayerCardPDF(player.numero)} 
                                className="px-3 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 flex items-center justify-center gap-1 flex-1 md:flex-none"
                                title="Genera Report PDF"
                              >
                                Report
                              </button>
                            )}
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* ========== SEZIONE ANALISI TATTICA ========== */}
          {activeTab === 'tattica' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">ðŸŽ¯ Analisi Tattica Avversari</h2>
              
              <div className="mb-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg">
                <div className="flex items-start gap-3">
                  <div className="text-purple-600 text-3xl">âš½</div>
                  <div>
                    <p className="font-semibold text-purple-900 mb-2">Analisi Tattica Intelligente</p>
                    <p className="text-sm text-purple-800">
                      Seleziona il modulo di gioco degli avversari e ricevi suggerimenti tattici personalizzati 
                      su quale modulo utilizzare per contrastarli efficacemente, con strategie dettagliate e punti chiave.
                    </p>
                  </div>
                </div>
              </div>

              <div className="mb-8">
                <label className="block text-lg font-bold text-gray-800 mb-3">
                  Seleziona il Modulo degli Avversari
                </label>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {moduliDisponibili.map(modulo => (
                    <button
                      key={modulo.nome}
                      onClick={() => setModuloAvversario(modulo.nome)}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        moduloAvversario === modulo.nome
                          ? 'bg-purple-600 text-white border-purple-600 shadow-lg transform scale-105'
                          : 'bg-white text-gray-800 border-gray-300 hover:border-purple-400 hover:shadow'
                      }`}
                    >
                      <div className="text-2xl font-bold mb-1">{modulo.nome}</div>
                      <div className="text-xs opacity-80">{modulo.descrizione}</div>
                    </button>
                  ))}
                </div>
              </div>

              {moduloAvversario && (() => {
                const analisi = analizzaModuloAvversario(moduloAvversario);
                if (!analisi) return null;

                return (
                  <div className="space-y-6">
                    {/* Punti deboli dell'avversario */}
                    <div className="bg-red-50 border-2 border-red-300 rounded-lg p-6">
                      <h3 className="text-xl font-bold text-red-900 mb-4 flex items-center gap-2">
                        <span className="text-2xl">âš ï¸</span>
                        Punti Deboli del {moduloAvversario}
                      </h3>
                      <ul className="space-y-2">
                        {analisi.puntiDeboli.map((punto, idx) => (
                          <li key={idx} className="flex items-start gap-2">
                            <span className="text-red-600 font-bold mt-1">â€¢</span>
                            <span className="text-red-900">{punto}</span>
                          </li>
                        ))}
                      </ul>
                    </div>

                    {/* Moduli consigliati */}
                    <div>
                      <h3 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span className="text-3xl">ðŸ’¡</span>
                        Moduli Consigliati per Contrastarli
                      </h3>
                      
                      <div className="space-y-6">
                        {analisi.moduliConsigliati.map((consiglio, idx) => (
                          <div 
                            key={idx}
                            className="bg-white border-2 rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-shadow"
                            style={{
                              borderColor: idx === 0 ? '#10b981' : idx === 1 ? '#3b82f6' : '#8b5cf6'
                            }}
                          >
                            {/* Header con efficacia */}
                            <div 
                              className="p-4 text-white"
                              style={{
                                backgroundColor: idx === 0 ? '#10b981' : idx === 1 ? '#3b82f6' : '#8b5cf6'
                              }}
                            >
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                  <span className="text-3xl">
                                    {idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                                  </span>
                                  <div>
                                    <div className="text-2xl font-bold">{consiglio.modulo}</div>
                                    <div className="text-sm opacity-90">
                                      {idx === 0 ? 'Scelta Ottimale' : idx === 1 ? 'Alternativa Valida' : 'Opzione Tattica'}
                                    </div>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className="text-3xl font-bold">{consiglio.efficacia}%</div>
                                  <div className="text-xs opacity-90">Efficacia</div>
                                </div>
                              </div>
                            </div>

                            {/* Contenuto */}
                            <div className="p-6">
                              {/* Motivo principale */}
                              <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <div className="font-semibold text-blue-900 mb-1">ðŸ“‹ PerchÃ© funziona:</div>
                                <div className="text-blue-800">{consiglio.motivo}</div>
                              </div>

                              {/* Vantaggi */}
                              <div className="mb-4">
                                <div className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                  <span className="text-green-600">âœ“</span>
                                  Vantaggi Chiave:
                                </div>
                                <div className="grid md:grid-cols-2 gap-2">
                                  {consiglio.vantaggi.map((vantaggio, vIdx) => (
                                    <div key={vIdx} className="flex items-start gap-2 bg-green-50 p-2 rounded border border-green-200">
                                      <span className="text-green-600 font-bold">âœ“</span>
                                      <span className="text-green-900 text-sm">{vantaggio}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {/* Tattiche specifiche */}
                              <div>
                                <div className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                  <span className="text-purple-600">âš¡</span>
                                  Indicazioni Tattiche:
                                </div>
                                <div className="space-y-2">
                                  {consiglio.tattiche.map((tattica, tIdx) => (
                                    <div key={tIdx} className="flex items-start gap-2 bg-purple-50 p-3 rounded border border-purple-200">
                                      <span className="text-purple-600 font-bold text-lg">{tIdx + 1}.</span>
                                      <span className="text-purple-900">{tattica}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {consiglio.ruoliChiave && consiglio.ruoliChiave.length > 0 && (
                                <div className="mt-6">
                                  <div className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <span className="text-orange-600 text-xl">ðŸ‘¤</span>
                                    Ruoli Chiave - Giocatori Indispensabili:
                                  </div>
                                  <div className="space-y-3">
                                    {consiglio.ruoliChiave.map((ruolo, rIdx) => (
                                      <div key={rIdx} className="bg-gradient-to-r from-orange-50 to-yellow-50 p-4 rounded-lg border-2 border-orange-300">
                                        <div className="flex items-start gap-3 mb-2">
                                          <div className="flex-shrink-0 w-7 h-7 rounded-full bg-orange-600 text-white flex items-center justify-center font-bold text-sm">
                                            {rIdx + 1}
                                          </div>
                                          <div className="flex-1">
                                            <div className="font-bold text-base text-orange-900">{ruolo.ruolo}</div>
                                            <div className="text-xs text-orange-700 font-semibold mt-1">
                                              {ruolo.importanza}
                                            </div>
                                          </div>
                                        </div>
                                        <div className="ml-10">
                                          <div className="text-xs font-semibold text-gray-700 mb-1">Caratteristiche:</div>
                                          <div className="space-y-1">
                                            {ruolo.caratteristiche.map((car, cIdx) => (
                                              <div key={cIdx} className="flex items-start gap-2 text-xs">
                                                <span className="text-orange-600 font-bold">â€¢</span>
                                                <span className="text-gray-800">{car}</span>
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                  <div className="mt-3 p-2 bg-orange-100 rounded border border-orange-300">
                                    <div className="text-xs text-orange-900">
                                      <span className="font-bold">Nota:</span> Per rendere al massimo con questo modulo, assicurati di avere giocatori forti in questi ruoli specifici.
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Rappresentazione tattica su campo */}
                              <div className="mt-6 pt-6 border-t-2 border-gray-200">
                                <div className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                  <span className="text-green-600 text-xl">âš½</span>
                                  Rappresentazione Tattica:
                                </div>
                                <CampoTattico 
                                  moduloNostro={consiglio.modulo} 
                                  moduloAvversario={moduloAvversario}
                                  evidenziaContrasto={true}
                                />
                                <div className="mt-3 p-3 bg-green-50 rounded border border-green-200">
                                  <div className="text-sm text-green-900">
                                    <span className="font-bold">ðŸ’¡ Come leggere il campo:</span> I giocatori in rosso rappresentano gli avversari, 
                                    quelli in blu la tua squadra. Osserva come il tuo modulo {consiglio.modulo} crea superioritÃ  numerica 
                                    nelle zone chiave rispetto al loro {moduloAvversario}.
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Nota finale */}
                    <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">ðŸ’¡</span>
                        <div className="text-sm text-yellow-900">
                          <span className="font-bold">Nota Tattica:</span> Questi suggerimenti sono basati su principi tattici consolidati. 
                          Ricorda di adattare la strategia alle caratteristiche specifiche dei tuoi giocatori e alle condizioni della partita. 
                          La migliore tattica Ã¨ quella che i tuoi giocatori sanno eseguire al meglio!
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}

              {!moduloAvversario && (
                <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                  <div className="text-6xl mb-4">ðŸŽ¯</div>
                  <div className="text-xl font-semibold text-gray-600 mb-2">
                    Seleziona un modulo per iniziare l'analisi
                  </div>
                  <div className="text-gray-500">
                    Scegli il modulo tattico degli avversari per ricevere suggerimenti personalizzati
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ========== SEZIONE DIVISIONE SQUADRE ========== */}
          {activeTab === 'divisione' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">âš–ï¸ Divisione Squadre Equilibrate</h2>
              
              <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="flex items-start gap-3">
                  <div className="text-blue-600 text-2xl">â„¹ï¸</div>
                  <div>
                    <p className="font-semibold text-blue-900 mb-1">Come funziona</p>
                    <p className="text-sm text-blue-800">
                      Il sistema divide automaticamente i giocatori disponibili in squadre equilibrate per ruolo.
                      Ogni squadra avrÃ  un numero simile di portieri, difensori, centrocampisti e attaccanti.
                    </p>
                  </div>
                </div>
              </div>

              {/* ========== IMPORTA PRESENTI DA ALLENAMENTO ========== */}
              <div className="mb-6 bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-lg p-6">
                <div className="flex items-start gap-3 mb-4">
                  <div className="text-green-600 text-3xl">ðŸ“‹</div>
                  <div>
                    <h3 className="font-bold text-green-900 text-lg mb-1">Importa Presenti da Allenamento</h3>
                    <p className="text-sm text-green-800">
                      Seleziona un allenamento per caricare automaticamente solo i giocatori presenti
                    </p>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Seleziona Allenamento
                    </label>
                    <select
                      value={selectedTrainingForDivision}
                      onChange={(e) => {
                        console.log('ðŸ” Dropdown onChange:', e.target.value);
                        setSelectedTrainingForDivision(e.target.value);
                        console.log('âœ… selectedTrainingForDivision settato a:', e.target.value);
                      }}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-white"
                    >
                      <option value="">-- Seleziona un allenamento --</option>
                      {trainings
                        .filter(t => Object.values(t.presenze).some(p => p === true))
                        .sort((a, b) => new Date(b.data) - new Date(a.data))
                        .map(training => {
                          const presentiCount = Object.entries(training.presenze)
                            .filter(([numero, presente]) => {
                              if (presente !== true) return false;
                              const player = players.find(p => p.numero === parseInt(numero));
                              if (!player || !player.nome) return false;
                              if (player.fuoriRosa) return false;
                              if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                              return true;
                            })
                            .length;
                          return (
                            <option key={training.id} value={training.id}>
                              {new Date(training.data).toLocaleDateString('it-IT')} - {presentiCount} presenti
                            </option>
                          );
                        })}
                    </select>
                  </div>

                  <div className="flex items-end gap-2">
                    <button
                      onClick={() => {
                        console.log('ðŸ”˜ BOTTONE CLICCATO!');
                        console.log('   selectedTrainingForDivision:', selectedTrainingForDivision);
                        console.log('   userRole:', userRole);
                        
                        if (!selectedTrainingForDivision) {
                          alert('âš ï¸ Seleziona prima un allenamento');
                          return;
                        }
                        
                        // Converti in numero per il confronto
                        const trainingId = parseInt(selectedTrainingForDivision);
                        console.log('   ðŸ” Cerco training con ID:', trainingId);
                        
                        const training = trainings.find(t => t.id === trainingId);
                        console.log('   ðŸ” Training trovato?', training ? 'SÃŒ' : 'NO');
                        
                        if (!training) {
                          alert('âŒ Allenamento non trovato!');
                          return;
                        }
                        
                        // Le presenze sono salvate per NUMERO, non per nome
                        // training.presenze = { 1: true, 2: false, 3: true, ... }
                        const numeriPresenti = Object.entries(training.presenze)
                          .filter(([_, presente]) => presente === true)
                          .map(([numero, _]) => parseInt(numero));
                        
                        console.log('Numeri presenti nell\'allenamento:', numeriPresenti);
                        
                        // Seleziona solo giocatori con numero presente E non fuori rosa
                        const nuoviSelezionati = new Set();
                        players.forEach(player => {
                          if (player.nome && !player.fuoriRosa && numeriPresenti.includes(player.numero)) {
                            nuoviSelezionati.add(player.nome);
                          }
                        });
                        
                        console.log('Giocatori da selezionare:', Array.from(nuoviSelezionati));
                        console.log('Totale selezionati:', nuoviSelezionati.size);
                        console.log('Set dopo setGiocatoriSelezionati:', nuoviSelezionati);
                        
                        setGiocatoriSelezionati(nuoviSelezionati);
                        
                        // Toast feedback
                        showToast(`âœ… Caricati ${nuoviSelezionati.size} giocatori presenti!`, 'success');
                      }}
                      disabled={!selectedTrainingForDivision || userRole !== 'admin'}
                      className={`flex-1 px-6 py-3 rounded-lg font-bold transition-colors ${
                        selectedTrainingForDivision && userRole === 'admin'
                          ? 'bg-green-600 text-white hover:bg-green-700'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      â¬‡ï¸ Carica Presenti
                    </button>
                    
                    <button
                      onClick={() => {
                        setGiocatoriSelezionati(new Set());
                        console.log('Reset selezione: tutti i giocatori saranno inclusi');
                        showToast('âœ… Selezione resettata: tutti i giocatori inclusi!', 'success');
                      }}
                      disabled={userRole !== 'admin'}
                      className={`px-6 py-3 rounded-lg font-bold transition-colors whitespace-nowrap ${
                        userRole === 'admin'
                          ? 'bg-blue-600 text-white hover:bg-blue-700'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      ðŸ”„ Reset
                    </button>
                  </div>
                </div>

                {selectedTrainingForDivision && (() => {
                  const training = trainings.find(t => t.id === selectedTrainingForDivision);
                  if (!training) return null;
                  
                  const presentiCount = Object.entries(training.presenze)
                    .filter(([numero, presente]) => {
                      if (presente !== true) return false;
                      const player = players.find(p => p.numero === parseInt(numero));
                      if (!player || !player.nome) return false;
                      if (player.fuoriRosa) return false;
                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                      return true;
                    })
                    .length;
                  const assentiCount = Object.entries(training.presenze)
                    .filter(([numero, presente]) => {
                      if (presente !== false) return false;
                      const player = players.find(p => p.numero === parseInt(numero));
                      if (!player || !player.nome) return false;
                      if (player.fuoriRosa) return false;
                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                      return true;
                    })
                    .length;
                  
                  return (
                    <div className="mt-4 p-3 bg-white border-2 border-green-200 rounded-lg">
                      <div className="text-sm text-gray-700">
                        <strong>Allenamento del {new Date(training.data).toLocaleDateString('it-IT')}:</strong>
                        <span className="ml-2">âœ… {presentiCount} presenti</span>
                        <span className="ml-2">âŒ {assentiCount} assenti</span>
                      </div>
                    </div>
                  );
                })()}
              </div>

              <div className="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Numero di squadre
                  </label>
                  <select 
                    value={numSquadre}
                    onChange={(e) => setNumSquadre(Number(e.target.value))}
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value={2}>2 squadre</option>
                    <option value={3}>3 squadre</option>
                    <option value={4}>4 squadre</option>
                    <option value={5}>5 squadre</option>
                    <option value={6}>6 squadre</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Portieri
                  </label>
                  <div className="flex items-center space-x-4 p-3 border border-gray-300 rounded-lg">
                    <label className="flex items-center cursor-pointer">
                      <input
                        type="radio"
                        checked={includiPortieri}
                        onChange={() => setIncludiPortieri(true)}
                        className="mr-2 h-4 w-4"
                      />
                      <span>Includi portieri</span>
                    </label>
                    <label className="flex items-center cursor-pointer">
                      <input
                        type="radio"
                        checked={!includiPortieri}
                        onChange={() => setIncludiPortieri(false)}
                        className="mr-2 h-4 w-4"
                      />
                      <span>Escludi portieri</span>
                    </label>
                  </div>
                </div>
              </div>

              {/* ========== LISTA VISIVA CONTROLLO SELEZIONE ========== */}
              <div className="mb-6 bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-4">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-bold text-gray-800 text-lg">
                    ðŸ‘¥ Controllo Selezione Giocatori
                  </h3>
                  <div className="flex gap-4 text-sm">
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 bg-green-400 rounded-full"></span>
                      <span className="font-medium">Selezionati: {giocatoriSelezionati.size || players.filter(p => p.nome && !p.fuoriRosa).length}</span>
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 bg-gray-400 rounded-full"></span>
                      <span className="font-medium">Esclusi: {players.filter(p => p.nome && !p.fuoriRosa).length - (giocatoriSelezionati.size || players.filter(p => p.nome && !p.fuoriRosa).length)}</span>
                    </span>
                  </div>
                </div>
                <p className="text-sm text-gray-600 mb-3">
                  {giocatoriSelezionati.size > 0 
                    ? 'âœ… Importati dall\'allenamento selezionato'
                    : 'â„¹ï¸ Nessun allenamento importato - tutti i giocatori sono inclusi'}
                </p>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 max-h-96 overflow-y-auto">
                  {players
                    .filter(p => p.nome)
                    .sort((a, b) => {
                      // Ordina per: selezionati prima, poi per numero
                      const aSelected = giocatoriSelezionati.size === 0 || giocatoriSelezionati.has(a.nome);
                      const bSelected = giocatoriSelezionati.size === 0 || giocatoriSelezionati.has(b.nome);
                      if (aSelected === bSelected) return a.numero - b.numero;
                      return bSelected ? 1 : -1;
                    })
                    .map(player => {
                      const isSelected = giocatoriSelezionati.size === 0 || giocatoriSelezionati.has(player.nome);
                      const isInjured = infortunati.has(player.nome);
                      
                      return (
                        <div
                          key={player.numero}
                          className={`flex items-center gap-2 p-2 rounded-lg border-2 transition-all ${
                            isSelected
                              ? 'bg-green-50 border-green-400'
                              : 'bg-gray-100 border-gray-300 opacity-60'
                          }`}
                        >
                          <span className={`text-lg ${isSelected ? '' : 'grayscale'}`}>
                            {isSelected ? 'âœ…' : 'âŒ'}
                          </span>
                          <div className="flex-1 min-w-0">
                            <div className={`text-sm font-medium truncate ${isSelected ? 'text-gray-900' : 'text-gray-500'}`}>
                              {player.nome}
                            </div>
                            <div className="text-xs text-gray-500">
                              #{player.numero} â€¢ {player.ruolo}
                              {isInjured && <span className="ml-1 text-red-600">ðŸ¤•</span>}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                </div>
              </div>

              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p className="font-semibold text-blue-900 mb-1">ðŸ“Š Informazioni distribuzione</p>
                <p className="text-sm text-blue-800">
                  <span className="font-medium">Giocatori disponibili:</span> <span className="font-bold">{giocatoriDisponibili}</span>
                  <br />
                  <span className="font-medium">Giocatori per squadra:</span> <span className="font-bold">
                    {Math.floor(giocatoriDisponibili / numSquadre)}
                    {giocatoriDisponibili % numSquadre > 0 && ` - ${Math.ceil(giocatoriDisponibili / numSquadre)}`}
                  </span>
                  {showDivisioneResults && (
                    <>
                      <br />
                      <span className={differenzaSquadre <= 1 ? 'text-green-700 font-semibold' : 'text-orange-700 font-semibold'}>
                        âš–ï¸ Totali squadre: {conteggioSquadre.map(s => s.totale).join(', ')}
                        {differenzaSquadre <= 1 ? ' âœ“ PERFETTO' : ' âš ï¸ NON BILANCIATO'}
                      </span>
                    </>
                  )}
                </p>
              </div>

              <div className="flex gap-4 mb-6">
                <button
                  onClick={rigeneraDivisione}
                  className="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition"
                >
                  {showDivisioneResults ? 'ðŸ”„ Rigenera Divisione' : 'âš½ Genera Divisione'}
                </button>
                {showDivisioneResults && (
                  <button
                    onClick={downloadDivisionePDF}
                    className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition"
                  >
                    ðŸ“¥ Scarica PDF Divisione
                  </button>
                )}
              </div>

              {showDivisioneResults && (
                <div className="space-y-6">
                  {dividiSquadre.map((squadra, index) => (
                    <div key={index} className="bg-white rounded-lg shadow-lg overflow-hidden border-2">
                      <div className={`${teamColors[index].bg} text-white p-4`}>
                        <h3 className="text-xl font-bold">
                          SQUADRA {teamColors[index].name} ({conteggioSquadre[index].totale} giocatori)
                        </h3>
                        <div className="mt-2 text-sm flex flex-wrap gap-x-4">
                          {includiPortieri && (
                            <span><span className="font-medium">Portieri:</span> {conteggioSquadre[index].portieri}</span>
                          )}
                          <span><span className="font-medium">Difensori:</span> {conteggioSquadre[index].difensori}</span>
                          <span><span className="font-medium">Centrocampisti:</span> {conteggioSquadre[index].centrocampisti}</span>
                          <span><span className="font-medium">Attaccanti:</span> {conteggioSquadre[index].attaccanti}</span>
                        </div>
                      </div>
                      
                      <div className="p-4">
                        {['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti'].map(ruolo => {
                          if (squadra[ruolo].length === 0) return null;
                          return (
                            <div key={ruolo} className="mb-4">
                              <h4 className="font-bold text-gray-700 mb-2">{ruolo} ({squadra[ruolo].length})</h4>
                              <div className="grid md:grid-cols-2 gap-2">
                                {squadra[ruolo].map(player => (
                                  <div key={player.numero} className="bg-gray-50 p-2 rounded border">
                                    <div className="font-medium">{player.nome}</div>
                                    <div className="text-sm text-gray-600">{player.ruolo}</div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* ========== SEZIONE CONVOCAZIONI ========== */}
          {activeTab === 'convocazioni' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">ðŸ“‹ Convocazioni Partita</h2>
              
              <div className="mb-6 p-4 bg-cyan-50 border border-cyan-200 rounded-lg">
                <div className="flex items-start gap-3">
                  <div className="text-cyan-600 text-2xl">â„¹ï¸</div>
                  <div>
                    <p className="font-semibold text-cyan-900 mb-1">Crea la lista convocati</p>
                    <p className="text-sm text-cyan-800">
                      Seleziona i giocatori da convocare per la prossima partita (max 20) e genera un PDF con la lista ufficiale.
                      Inserisci le informazioni della partita per un documento completo.
                    </p>
                  </div>
                </div>
              </div>

              {/* ========== IMPORTA CONVOCATI DA PARTITA ========== */}
              <div className="mb-6 bg-gradient-to-r from-purple-50 to-purple-100 border-2 border-purple-300 rounded-lg p-6">
                <div className="flex items-start gap-3 mb-4">
                  <div className="text-purple-600 text-3xl">âš½</div>
                  <div>
                    <h3 className="font-bold text-purple-900 text-lg mb-1">Importa Convocati da Partita</h3>
                    <p className="text-sm text-purple-800">
                      Seleziona una partita per caricare automaticamente i convocati giÃ  registrati
                    </p>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Seleziona Partita
                    </label>
                    <select
                      value={selectedMatchForConvocazioni}
                      onChange={(e) => setSelectedMatchForConvocazioni(e.target.value)}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                    >
                      <option value="">-- Seleziona una partita --</option>
                      {matches
                        .filter(m => m.convocati && Object.keys(m.convocati).some(key => m.convocati[key] === true))
                        .sort((a, b) => new Date(b.data) - new Date(a.data))
                        .map(match => {
                          const convocatiCount = Object.values(match.convocati).filter(v => v === true).length;
                          return (
                            <option key={match.id} value={match.id}>
                              {new Date(match.data).toLocaleDateString('it-IT')} - {match.squadraCasa || 'Casa'} vs {match.avversario || match.squadraTrasferta || 'Trasferta'} - {convocatiCount} convocati
                            </option>
                          );
                        })}
                    </select>
                  </div>

                  <div className="flex items-end">
                    <button
                      onClick={() => {
                        console.log('ðŸ”˜ CARICA CONVOCATI - Click!');
                        console.log('   selectedMatchForConvocazioni:', selectedMatchForConvocazioni);
                        console.log('   tipo:', typeof selectedMatchForConvocazioni);
                        
                        if (!selectedMatchForConvocazioni) {
                          alert('âš ï¸ Seleziona prima una partita');
                          return;
                        }
                        
                        // CRITICAL: Converti in numero prima del confronto
                        const matchId = parseInt(selectedMatchForConvocazioni);
                        console.log('   matchId convertito:', matchId);
                        
                        const match = matches.find(m => m.id === matchId);
                        console.log('   match trovato?', match ? 'SÃŒ' : 'NO');
                        
                        if (!match) {
                          alert('âŒ Partita non trovata!');
                          return;
                        }
                        
                        console.log('   Convocati nella partita:', match.convocati);
                        
                        // CRITICAL: Convocati sono salvati come NUMERI, ma il Set usa NOMI!
                        // Converti numeri in nomi (come per Importa Presenti)
                        
                        // 1. Estrai numeri dei giocatori convocati
                        const numeriConvocati = Object.entries(match.convocati || {})
                          .filter(([_, convocato]) => convocato === true)
                          .map(([num, _]) => parseInt(num));
                        
                        console.log('   Numeri convocati nella partita:', numeriConvocati);
                        
                        // 2. Converti numeri in nomi usando array players
                        const convocatiNomi = players
                          .filter(p => numeriConvocati.includes(p.numero))
                          .map(p => p.nome);
                        
                        console.log('   Nomi convocati trovati:', convocatiNomi);
                        console.log('   Totale convocati:', convocatiNomi.length);
                        
                        const nuoviConvocati = new Set(convocatiNomi);
                        setConvocati(nuoviConvocati);
                        
                        // Determina se la partita Ã¨ in casa o trasferta usando funzione helper
                        const siamoInCasa = isTeamPlayingHome(match);
                        
                        console.log('   Squadra in casa?', siamoInCasa);
                        
                        // Pre-compila info partita con automazione casa/trasferta
                        if (siamoInCasa) {
                          console.log('   âš½ PARTITA IN CASA - Pre-compilazione automatica');
                          setInfoPartita({
                            squadra1: match.squadraCasa || appTitle,
                            squadra2: match.avversario || match.squadraTrasferta || '',
                            dataPartita: match.data || '',
                            oraRitrovo: match.oraRitrovo || '',  // Da compilare manualmente
                            indirizzoCompo: match.campo || ''  // Da compilare manualmente
                          });
                        } else {
                          console.log('   ðŸšŒ PARTITA IN TRASFERTA - Pre-compilazione parziale');
                          setInfoPartita({
                            squadra1: match.squadraCasa || '',
                            squadra2: match.avversario || match.squadraTrasferta || appTitle,
                            dataPartita: match.data || '',
                            oraRitrovo: match.oraRitrovo || '',  // Da compilare manualmente
                            indirizzoCompo: match.campo || ''  // Da compilare manualmente
                          });
                        }
                        
                        // Toast feedback
                        const tipoPartita = siamoInCasa ? 'ðŸ  Casa' : 'ðŸšŒ Trasferta';
                        showToast(`âœ… Caricati ${nuoviConvocati.size} convocati! ${tipoPartita}`, 'success');
                      }}
                      disabled={!selectedMatchForConvocazioni || userRole !== 'admin'}
                      className={`w-full px-6 py-3 rounded-lg font-bold transition-colors ${
                        selectedMatchForConvocazioni && userRole === 'admin'
                          ? 'bg-purple-600 text-white hover:bg-purple-700'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      â¬‡ï¸ Carica Convocati
                    </button>
                  </div>
                </div>

                {selectedMatchForConvocazioni && (() => {
                  const match = matches.find(m => m.id === selectedMatchForConvocazioni);
                  if (!match) return null;
                  
                  const convocatiCount = Object.values(match.convocati || {}).filter(v => v === true).length;
                  
                  return (
                    <div className="mt-4 p-3 bg-white border-2 border-purple-200 rounded-lg">
                      <div className="text-sm text-gray-700">
                        <strong>Partita del {new Date(match.data).toLocaleDateString('it-IT')} - {match.squadraCasa || 'Casa'} vs {match.avversario || match.squadraTrasferta || 'Trasferta'}:</strong>
                        <span className="ml-2">ðŸ‘¥ {convocatiCount} convocati</span>
                        <span className="ml-2">ðŸ“ {match.campo || 'Campo non specificato'}</span>
                      </div>
                    </div>
                  );
                })()}
              </div>

              <div 
                className="mb-6 bg-white border rounded-lg p-4"
                style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.7} : {}}
              >
                <h3 className="font-bold text-gray-800 mb-4">Informazioni Partita</h3>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Squadra Casa</label>
                    <input
                      type="text"
                      value={infoPartita.squadra1}
                      onChange={(e) => setInfoPartita({...infoPartita, squadra1: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                      placeholder="Nome squadra casa"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Squadra Ospite</label>
                    <input
                      type="text"
                      value={infoPartita.squadra2}
                      onChange={(e) => setInfoPartita({...infoPartita, squadra2: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                      placeholder="Es: Avversari"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Data Partita</label>
                    <input
                      type="date"
                      value={infoPartita.dataPartita}
                      onChange={(e) => setInfoPartita({...infoPartita, dataPartita: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Ora Ritrovo</label>
                    <input
                      type="time"
                      value={infoPartita.oraRitrovo}
                      onChange={(e) => setInfoPartita({...infoPartita, oraRitrovo: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Indirizzo Campo</label>
                    <input
                      type="text"
                      value={infoPartita.indirizzoCompo}
                      onChange={(e) => setInfoPartita({...infoPartita, indirizzoCompo: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                      placeholder="Es: Via dello Sport 123, CittÃ "
                    />
                  </div>
                </div>
              </div>

              <div style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.7} : {}}>
              {['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti', 'Altri'].map(categoria => {
                const giocatori = players.filter(p => 
                  p.nome && mappaRuolo(p.ruolo) === categoria
                );
                if (giocatori.length === 0) return null;
                
                return (
                  <div key={categoria} className="mb-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-3 border-b pb-2">
                      {categoria} ({giocatori.filter(p => convocati.has(p.nome)).length}/{giocatori.length})
                    </h3>
                    <div className="grid md:grid-cols-2 gap-2">
                      {giocatori.map(player => {
                        const isInfortunato = infortunati.has(player.nome);
                        return (
                        <label 
                          key={player.numero}
                          className={`flex items-center p-3 rounded-lg cursor-pointer transition ${
                            convocati.has(player.nome) 
                              ? 'bg-cyan-50 border-2 border-cyan-400' 
                              : 'bg-gray-50 border-2 border-transparent hover:bg-gray-100'
                          } ${isInfortunato ? 'opacity-75' : ''}`}
                        >
                          <input
                            type="checkbox"
                            checked={convocati.has(player.nome)}
                            onChange={() => toggleConvocato(player.nome)}
                            className="mr-3 h-5 w-5 text-cyan-600 rounded"
                          />
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <span className="font-medium text-gray-900">{player.nome}</span>
                              {isInfortunato && (
                                <span className="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full font-semibold">
                                  ðŸ¤• INFORTUNATO
                                </span>
                              )}
                            </div>
                            <div className="text-sm text-gray-500">{player.ruolo}</div>
                          </div>
                        </label>
                      )})}
                    </div>
                  </div>
                );
              })}
              </div>

              <div className="sticky bottom-0 bg-white border-t-2 border-gray-200 p-4 -mx-6 -mb-6 mt-6">
                <div className="flex justify-between items-center">
                  <span className="text-gray-700 font-medium text-lg">
                    {convocati.size} / 20 giocatori convocati
                  </span>
                  <button
                    onClick={downloadConvocazioni}
                    disabled={convocati.size === 0}
                    className={`py-3 px-8 rounded-lg font-semibold transition ${
                      convocati.size === 0
                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        : 'bg-cyan-600 text-white hover:bg-cyan-700'
                    }`}
                  >
                    ðŸ“¥ Scarica PDF Convocazione
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* ========== MODAL CHIUSURA APP ========== */}
        {showExitModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full animate-scale-up">
              {/* Header */}
              <div className="bg-gradient-to-r from-red-500 to-red-600 text-white p-6 rounded-t-lg">
                <div className="flex items-center gap-3">
                  <div className="text-4xl">ðŸ’¾</div>
                  <div>
                    <h3 className="text-2xl font-bold">Chiusura Applicazione</h3>
                    <p className="text-red-100 text-sm mt-1">
                      Salvare le modifiche prima di chiudere?
                    </p>
                  </div>
                </div>
              </div>
              
              {/* Body */}
              <div className="p-6">
                <p className="text-gray-700 mb-6">
                  Sei il <strong>dispositivo principale</strong>. Al prossimo accesso sarai ancora loggato, ma ti consiglio di salvare le modifiche sul cloud.
                </p>
                
                {/* Opzioni */}
                <div className="space-y-3">
                  {/* Salva e Chiudi */}
                  <button
                    onClick={handleExitWithSave}
                    className="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-4 rounded-lg transition-all hover:scale-102 shadow-lg flex items-center gap-3"
                  >
                    <div className="text-3xl">ðŸ’¾</div>
                    <div className="text-left flex-1">
                      <div className="font-bold">Salva e Chiudi</div>
                      <div className="text-xs text-green-100">Sincronizza i dati sul cloud e chiudi la finestra</div>
                    </div>
                  </button>
                  
                  {/* Chiudi Senza Salvare */}
                  <button
                    onClick={handleExitWithoutSave}
                    className="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-4 rounded-lg transition-all hover:scale-102 shadow-lg flex items-center gap-3"
                  >
                    <div className="text-3xl">âœ•</div>
                    <div className="text-left flex-1">
                      <div className="font-bold">Chiudi Senza Salvare</div>
                      <div className="text-xs text-orange-100">Chiudi senza sincronizzare (modifiche solo locali)</div>
                    </div>
                  </button>
                  
                  {/* Annulla */}
                  <button
                    onClick={handleCancelExit}
                    className="w-full bg-gray-500 hover:bg-gray-600 text-white p-4 rounded-lg transition-all hover:scale-102 shadow-lg flex items-center gap-3"
                  >
                    <div className="text-3xl">â†©ï¸</div>
                    <div className="text-left flex-1">
                      <div className="font-bold">Annulla</div>
                      <div className="text-xs text-gray-100">Torna all'applicazione</div>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {showInstructionsModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div className="p-6 border-b sticky top-0 bg-white z-10">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold text-gray-800">ðŸ“– Guida Completa - Gestionale Calcio</h3>
                  <button
                    onClick={() => setShowInstructionsModal(false)}
                    className="text-gray-600 hover:text-gray-800 text-2xl"
                  >
                    âœ•
                  </button>
                </div>
              </div>
              
              <div className="p-6 space-y-6">
                <div className="bg-green-50 border-2 border-green-400 rounded-lg p-4">
                  <h4 className="font-bold text-green-800 mb-2">âœ… SALVATAGGIO AUTOMATICO ATTIVO</h4>
                  <p className="text-green-900 text-sm">
                    Tutti i dati vengono salvati automaticamente in locale ogni volta che apporti modifiche. L'app funziona anche offline. Gli ADMIN possono sincronizzare su cloud Firebase per condividere con altri utenti.
                  </p>
                </div>

                <div className="bg-blue-50 border-2 border-blue-400 rounded-lg p-4">
                  <h4 className="font-bold text-blue-800 mb-2">âš½ IMPORTANTE: NOME SQUADRA</h4>
                  <p className="text-blue-900 text-sm mb-2">
                    <strong>Per visualizzare correttamente i risultati casa/trasferta</strong>, imposta il "Nome Squadra" nell'header in alto.
                  </p>
                  <ul className="list-disc ml-6 text-sm text-blue-900 space-y-1">
                    <li><strong>Il nome DEVE coincidere</strong> con quello inserito nella Classifica Campionato</li>
                    <li>Esempio: se nel girone hai "Real DOR Brescia", usa esattamente "Real DOR Brescia"</li>
                    <li>L'app ti suggerirÃ  automaticamente i nomi disponibili mentre digiti</li>
                    <li>Validazione live: âœ… Verde = trovato, âš ï¸ Arancione = suggerimento, âŒ Rosso = non trovato</li>
                  </ul>
                </div>

                <div className="border-l-4 border-blue-500 pl-4">
                  <h4 className="font-bold text-blue-800 mb-3 text-lg">ðŸ“Š 1. DASHBOARD</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Panoramica stagione:</strong> Vedi subito partite giocate, allenamenti, gol fatti/subiti</li>
                    <li><strong>Grafici interattivi:</strong> Andamento gol, risultati partite, presenze allenamenti</li>
                    <li><strong>Top 5 marcatori:</strong> Classifica veloce dei migliori goleador</li>
                    <li><strong>Report mensile:</strong> Statistiche automatiche del mese corrente</li>
                    <li><strong>Avviso backup:</strong> (Solo ADMIN) Promemoria se backup non fatto da 7+ giorni</li>
                  </ul>
                </div>

                <div className="border-l-4 border-yellow-500 pl-4">
                  <h4 className="font-bold text-yellow-800 mb-3 text-lg">ðŸ¥‡ 2. CLASSIFICA CAMPIONATO</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Gestione girone:</strong> Aggiungi tutte le squadre del campionato (inclusa la tua squadra!)</li>
                    <li><strong>Risultati giornata:</strong> Inserisci i risultati per ogni giornata</li>
                    <li><strong>Classifica automatica:</strong> Punteggi, differenza reti, vittorie/pareggi/sconfitte</li>
                    <li><strong>Import veloce:</strong> Importa risultati dalle tue partite salvate</li>
                  </ul>
                </div>

                <div className="border-l-4 border-cyan-500 pl-4">
                  <h4 className="font-bold text-cyan-800 mb-3 text-lg">ðŸ“… 3. CALENDARIO</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Vista mensile:</strong> Visualizza allenamenti e partite in calendario</li>
                    <li><strong>Indicatori colorati:</strong> Verde = allenamento, Rosso = partita</li>
                    <li><strong>Navigazione rapida:</strong> Cambia mese/anno facilmente</li>
                    <li><strong>Click su data:</strong> Vedi dettagli eventi del giorno selezionato</li>
                  </ul>
                </div>

                <div className="border-l-4 border-indigo-500 pl-4">
                  <h4 className="font-bold text-indigo-800 mb-3 text-lg">ðŸ‘¥ 4. GESTIONE ROSA</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Aggiungi giocatori:</strong> Nome, cognome, data nascita, ruolo, numero maglia, altezza, peso, piede</li>
                    <li><strong>Foto giocatore:</strong> Upload foto con crop automatico (aspect ratio 3:4)</li>
                    <li><strong>Fuori rosa:</strong> Segna giocatori temporaneamente non disponibili</li>
                    <li><strong>Filtri e ricerca:</strong> Filtra per ruolo, cerca per nome, ordina per numero/etÃ /alfabetico</li>
                    <li><strong>Vista card/lista:</strong> Scegli la visualizzazione che preferisci</li>
                    <li><strong>Logo squadra:</strong> Clicca sul logo in alto per personalizzarlo</li>
                  </ul>
                </div>

                <div className="border-l-4 border-green-500 pl-4">
                  <h4 className="font-bold text-green-800 mb-3 text-lg">ðŸ‹ï¸ 5. ALLENAMENTI</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Crea allenamento:</strong> Seleziona data (gli infortunati sono pre-segnati come assenti)</li>
                    <li><strong>Presenze:</strong> Toggle ON/OFF per ogni giocatore (verde = presente)</li>
                    <li><strong>Esercizi dettagliati:</strong> Aggiungi nome, durata, descrizione di ogni esercizio</li>
                    <li><strong>Template predefiniti:</strong> Riscaldamento, Possesso palla, Partitella, ecc.</li>
                    <li><strong>Duplica esercizi:</strong> Copia esercizi da allenamenti precedenti</li>
                    <li><strong>PDF esercizi:</strong> Stampa il piano allenamento completo</li>
                    <li><strong>Calendario mensile:</strong> Vista allenamenti del mese con totale presenze</li>
                  </ul>
                </div>

                <div className="border-l-4 border-purple-500 pl-4">
                  <h4 className="font-bold text-purple-800 mb-3 text-lg">âš–ï¸ 6. DIVISIONE SQUADRE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Importa presenze:</strong> Seleziona un allenamento per caricare i presenti</li>
                    <li><strong>Selezione giocatori:</strong> Scegli chi dividere (anche manualmente)</li>
                    <li><strong>Numero squadre:</strong> Da 2 a 6 squadre (con/senza portieri)</li>
                    <li><strong>Algoritmo bilanciato:</strong> Divisione equa automatica</li>
                    <li><strong>PDF stampabile:</strong> Porta il foglio con le squadre in campo</li>
                  </ul>
                </div>

                <div className="border-l-4 border-red-500 pl-4">
                  <h4 className="font-bold text-red-800 mb-3 text-lg">âš½ 7. PARTITE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Crea partita:</strong> Data, avversario, casa/trasferta</li>
                    <li><strong>Eventi live:</strong> âš½ Gol, ðŸ…°ï¸ Assist, ðŸŸ¨ Giallo, ðŸŸ¥ Rosso con minuto esatto</li>
                    <li><strong>Timeline eventi:</strong> Cronologia completa con possibilitÃ  di cancellare</li>
                    <li><strong>Votazione MVP:</strong> Al termine seleziona Top 3 (Oro 3pt, Argento 2pt, Bronzo 1pt)</li>
                    <li><strong>Statistiche automatiche:</strong> Gol, assist, cartellini contati in tempo reale</li>
                    <li><strong>PDF dettaglio partita:</strong> Report completo con tutti gli eventi</li>
                  </ul>
                </div>

                <div className="border-l-4 border-teal-500 pl-4">
                  <h4 className="font-bold text-teal-800 mb-3 text-lg">ðŸ“‹ 8. CONVOCAZIONI</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Seleziona convocati:</strong> Fino a 20 giocatori per partita</li>
                    <li><strong>Info partita:</strong> Squadre, data, ora ritrovo, indirizzo campo</li>
                    <li><strong>Infortunati evidenziati:</strong> Badge rosso per giocatori con infortunio attivo</li>
                    <li><strong>PDF professionale:</strong> Foglio convocazione ufficiale da stampare</li>
                  </ul>
                </div>

                <div className="border-l-4 border-orange-500 pl-4">
                  <h4 className="font-bold text-orange-800 mb-3 text-lg">ðŸŽ¯ 9. ANALISI TATTICA</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Modulo avversario:</strong> Inserisci il modulo della squadra avversaria</li>
                    <li><strong>3 moduli consigliati:</strong> Sistema calcola i migliori contro-moduli con % efficacia</li>
                    <li><strong>Tattiche dettagliate:</strong> Vantaggi, strategie, contromosse, ruoli chiave</li>
                    <li><strong>8 moduli disponibili:</strong> 4-4-2, 4-3-3, 3-5-2, 4-2-3-1, 3-4-3, 5-3-2, 4-1-4-1, 4-3-1-2</li>
                  </ul>
                </div>

                <div className="border-l-4 border-pink-500 pl-4">
                  <h4 className="font-bold text-pink-800 mb-3 text-lg">ðŸŽ¨ 10. FORMAZIONI TATTICHE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Drag & Drop:</strong> Trascina giocatori sulle posizioni del campo</li>
                    <li><strong>Moduli tattici:</strong> Scegli tra 5 moduli predefiniti</li>
                    <li><strong>Visualizzazione grafica:</strong> Campo da calcio con posizioni giocatori</li>
                    <li><strong>Salvataggio formazioni:</strong> Salva piÃ¹ formazioni per diverse partite</li>
                    <li><strong>PDF formazione:</strong> Stampa lo schema tattico</li>
                  </ul>
                </div>

                <div className="border-l-4 border-red-600 pl-4">
                  <h4 className="font-bold text-red-700 mb-3 text-lg">ðŸ¤• 11. INFORTUNI</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Registra infortunio:</strong> Giocatore, tipo, data, gravitÃ  (lieve/media/grave), note</li>
                    <li><strong>Monitoraggio recupero:</strong> Aggiungi aggiornamenti progressi con data e note</li>
                    <li><strong>Timeline completa:</strong> Vedi storico di tutti gli aggiornamenti</li>
                    <li><strong>Stato attivo/recuperato:</strong> Segna quando il giocatore torna disponibile</li>
                    <li><strong>Statistiche:</strong> Infortuni per tipo, giocatori piÃ¹ colpiti</li>
                    <li><strong>PDF storico:</strong> Report completo infortuni stagione</li>
                  </ul>
                </div>

                <div className="border-l-4 border-blue-600 pl-4">
                  <h4 className="font-bold text-blue-700 mb-3 text-lg">ðŸ“Š 12. STATISTICHE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Overview completa:</strong> Tutti i dati di ogni giocatore in una tabella</li>
                    <li><strong>Metriche:</strong> Presenze, partite, minuti, gol, assist, cartellini, MVP</li>
                    <li><strong>Percentuali:</strong> % presenze allenamenti, media gol/partita</li>
                    <li><strong>Ordinamento:</strong> Clicca su colonne per ordinare</li>
                    <li><strong>Aggiornamento automatico:</strong> Calcolo in tempo reale</li>
                  </ul>
                </div>

                <div className="border-l-4 border-yellow-600 pl-4">
                  <h4 className="font-bold text-yellow-700 mb-3 text-lg">ðŸ† 13. GIOCATORI TOP</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Top 10 automatiche:</strong> Classifiche per ogni categoria</li>
                    <li><strong>Categorie:</strong> Presenze allenamenti, minuti giocati, gol, assist, MVP</li>
                    <li><strong>Medaglie visive:</strong> Oro, argento, bronzo per i primi 3</li>
                    <li><strong>Motivazione squadra:</strong> Usa per premiare e stimolare giocatori</li>
                  </ul>
                </div>

                <div className="border-l-4 border-green-600 pl-4">
                  <h4 className="font-bold text-green-700 mb-3 text-lg">ðŸ“„ 14. REPORT PDF (Solo ADMIN)</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Report Stagionale:</strong> PDF completo con tutte le statistiche stagione</li>
                    <li><strong>Scheda Giocatore:</strong> PDF individuale con foto, dati e statistiche personali</li>
                    <li><strong>QualitÃ  professionale:</strong> Report ideali per presentazioni o archivio</li>
                  </ul>
                </div>

                <div className="border-l-4 border-purple-600 pl-4">
                  <h4 className="font-bold text-purple-700 mb-3 text-lg">ðŸ’¾ 15. ESPORTAZIONI E BACKUP (Solo ADMIN)</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Backup completo JSON:</strong> Include TUTTI i dati (giocatori, partite, allenamenti, infortuni, formazioni)</li>
                    <li><strong>Import JSON:</strong> Carica backup per ripristinare o trasferire dati</li>
                    <li><strong>Versione 3.0:</strong> Backup con statistiche integritÃ  incorporate</li>
                    <li><strong>Promemoria automatico:</strong> Avviso ogni 7 giorni se backup non fatto</li>
                    <li><strong>Cloud storage:</strong> Salva su Google Drive/Dropbox per sicurezza extra</li>
                  </ul>
                </div>

                <div className="border-l-4 border-cyan-600 pl-4">
                  <h4 className="font-bold text-cyan-700 mb-3 text-lg">â˜ï¸ 16. SINCRONIZZAZIONE CLOUD (Solo ADMIN)</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Database Cloud:</strong> Salva dati su cloud per condividerli</li>
                    <li><strong>Scarica da Cloud:</strong> Sincronizza dati dal database cloud</li>
                    <li><strong>Carica su Cloud:</strong> Invia modifiche locali al cloud</li>
                    <li><strong>Gestione conflitti:</strong> Sistema risoluzione automatica con timestamp</li>
                    <li><strong>Sync automatico:</strong> Opzionale ogni 5 minuti (disabilitato di default per sicurezza)</li>
                  </ul>
                </div>

                <div className="border-l-4 border-indigo-600 pl-4">
                  <h4 className="font-bold text-indigo-700 mb-3 text-lg">ðŸ‘‘ 17. GESTIONE UTENTI (Solo ADMIN)</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Ruoli utente:</strong> ADMIN (gestione completa) e USER (sola lettura)</li>
                    <li><strong>Crea utenti:</strong> Admin puÃ² creare account per allenatori/staff</li>
                    <li><strong>USER auto-sync:</strong> Utenti USER scaricano automaticamente dati aggiornati al login</li>
                    <li><strong>Visualizzazione dati:</strong> USER vedono tutto ma non possono modificare</li>
                    <li><strong>Banner distintivi:</strong> USER vedono "ModalitÃ  Sola Lettura"</li>
                  </ul>
                </div>

                <div className="border-l-4 border-red-700 pl-4">
                  <h4 className="font-bold text-red-800 mb-3 text-lg">ðŸ”„ 18. RESET DATABASE (Solo ADMIN)</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Reset Stagione:</strong> Cancella allenamenti/partite MA mantiene rosa giocatori e logo</li>
                    <li><strong>Reset Completo:</strong> Cancella TUTTO (usa con estrema cautela!)</li>
                    <li><strong>Procedura consigliata:</strong> Backup â†’ Reset Stagione â†’ Riparti con stessa squadra</li>
                    <li><strong>Triple conferme:</strong> Protezione da cancellazioni accidentali</li>
                  </ul>
                </div>

                <div className="bg-blue-50 border-2 border-blue-400 rounded-lg p-4 mt-6">
                  <h4 className="font-bold text-blue-800 mb-2">ðŸ’¡ CONSIGLI PRATICI</h4>
                  <ul className="list-disc ml-6 text-sm text-blue-900 space-y-1">
                    <li>Controlla la Dashboard all'inizio di ogni sessione per panoramica veloce</li>
                    <li>Usa il Calendario per pianificare allenamenti e partite in anticipo</li>
                    <li>Registra presenze allenamenti subito per statistiche accurate</li>
                    <li>Durante partite usa gli Eventi Live per cronaca dettagliata</li>
                    <li>Vota MVP dopo ogni partita per classifica motivazionale</li>
                    <li>Monitora infortuni costantemente per gestione rosa ottimale</li>
                    <li><strong>ADMIN:</strong> Fai backup JSON ogni 7 giorni per sicurezza</li>
                    <li><strong>ADMIN:</strong> Sincronizza su cloud per condividere con staff</li>
                    <li>A fine stagione: Backup â†’ Reset Stagione â†’ Continua con stessa rosa</li>
                  </ul>
                </div>

                <div className="bg-purple-50 border-2 border-purple-400 rounded-lg p-4">
                  <h4 className="font-bold text-purple-800 mb-2">ðŸ“± COMPATIBILITÃ€</h4>
                  <p className="text-purple-900 text-sm">
                    <strong>Desktop:</strong> Chrome, Firefox, Edge, Safari (consigliato Chrome)<br/>
                    <strong>Mobile:</strong> Android, iOS, iPad (ottimizzato per tablet)<br/>
                    <strong>PWA:</strong> Installabile come app su tutti i dispositivi<br/>
                    <strong>Offline:</strong> Funziona senza internet (sync richiede connessione)<br/>
                    <strong>Risoluzione:</strong> Da smartphone a desktop 4K
                  </p>
                </div>

                <div className="bg-green-50 border-2 border-green-400 rounded-lg p-4">
                  <h4 className="font-bold text-green-800 mb-2">ðŸŽ¯ WORKFLOW CONSIGLIATO</h4>
                  <p className="text-green-900 text-sm mb-2"><strong>Setup iniziale (ADMIN):</strong></p>
                  <ol className="list-decimal ml-6 text-sm text-green-900 space-y-1">
                    <li>Aggiungi tutti i giocatori nella Rosa con foto</li>
                    <li>Carica logo squadra personalizzato</li>
                    <li>Crea utenti USER per staff (opzionale)</li>
                    <li>Configura sincronizzazione cloud (opzionale)</li>
                  </ol>
                  <p className="text-green-900 text-sm mt-3 mb-2"><strong>Durante la stagione:</strong></p>
                  <ol className="list-decimal ml-6 text-sm text-green-900 space-y-1">
                    <li>Registra presenze ad ogni allenamento + esercizi svolti</li>
                    <li>Gestisci infortuni appena accadono</li>
                    <li>Registra eventi durante le partite + vota MVP</li>
                    <li>Controlla Dashboard e Statistiche regolarmente</li>
                    <li>Fai backup ogni 7 giorni</li>
                  </ol>
                  <p className="text-green-900 text-sm mt-3 mb-2"><strong>Fine stagione:</strong></p>
                  <ol className="list-decimal ml-6 text-sm text-green-900 space-y-1">
                    <li>Genera Report Stagionale PDF per archivio</li>
                    <li>Scarica Backup JSON completo</li>
                    <li>Reset Stagione (mantiene rosa)</li>
                    <li>Ricomincia con stessa squadra!</li>
                  </ol>
                </div>
              </div>

              <div className="p-6 border-t bg-gray-50">
                <button
                  onClick={() => setShowInstructionsModal(false)}
                  className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg"
                >
                  âœ… Perfetto, ho capito tutto!
                </button>
              </div>
            </div>
          </div>
        )}

        {/* ========== MODAL ELENCO RISULTATI PARTITE ========== */}
        {showResultsModal && (
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[110] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-5xl w-full p-6 animate-scale-up max-h-[90vh] overflow-y-auto">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">ðŸ“‹</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Elenco Risultati Partite</h2>
                <p className="text-gray-600">{appTitle} - Stagione {new Date().getFullYear()}/{new Date().getFullYear() + 1}</p>
              </div>

              {/* Statistiche Riepilogative */}
              {(() => {
                const partiteCompletate = matches.filter(m => {
                  const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  return golFatti > 0 || golSubiti > 0;
                });
                
                const vittorie = partiteCompletate.filter(m => {
                  const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  return golFatti > golSubiti;
                }).length;
                
                const pareggi = partiteCompletate.filter(m => {
                  const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  return golFatti === golSubiti;
                }).length;
                
                const sconfitte = partiteCompletate.filter(m => {
                  const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  return golFatti < golSubiti;
                }).length;
                
                const puntiTotali = vittorie * 3 + pareggi * 1;
                
                return (
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow p-4 border-2 border-blue-200">
                      <div className="text-3xl font-bold text-blue-600">{partiteCompletate.length}</div>
                      <div className="text-sm text-gray-700 font-semibold">Partite</div>
                    </div>
                    <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow p-4 border-2 border-green-200">
                      <div className="text-3xl font-bold text-green-600">{vittorie}</div>
                      <div className="text-sm text-gray-700 font-semibold">Vittorie</div>
                    </div>
                    <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow p-4 border-2 border-yellow-200">
                      <div className="text-3xl font-bold text-yellow-600">{pareggi}</div>
                      <div className="text-sm text-gray-700 font-semibold">Pareggi</div>
                    </div>
                    <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg shadow p-4 border-2 border-red-200">
                      <div className="text-3xl font-bold text-red-600">{sconfitte}</div>
                      <div className="text-sm text-gray-700 font-semibold">Sconfitte</div>
                    </div>
                    <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow p-4 border-2 border-purple-200">
                      <div className="text-3xl font-bold text-purple-600">{puntiTotali}</div>
                      <div className="text-sm text-gray-700 font-semibold">Punti</div>
                    </div>
                  </div>
                );
              })()}

              {/* Tabella Risultati */}
              <div className="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-blue-600 text-white">
                      <tr>
                        <th className="p-3 text-left">Data</th>
                        <th className="p-3 text-left">Partita</th>
                        <th className="p-3 text-center">Risultato</th>
                        <th className="p-3 text-center">Esito</th>
                        <th className="p-3 text-left hidden md:table-cell">Luogo</th>
                      </tr>
                    </thead>
                    <tbody>
                      {matches
                        .filter(m => {
                          const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                          const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                          return golFatti > 0 || golSubiti > 0;
                        })
                        .sort((a, b) => new Date(b.data) - new Date(a.data)) // PiÃ¹ recenti prima
                        .map((m, idx) => {
                          const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                          const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                          
                          // Determina se siamo casa o trasferta usando funzione helper
                          const siamoInCasa = isTeamPlayingHome(m);
                          
                          // Calcola esito basandosi sulla nostra prospettiva
                          // golFatti = nostri gol, golSubiti = gol avversario (giÃ  salvati correttamente)
                          const risultato = golFatti > golSubiti ? 'Vittoria' : golFatti === golSubiti ? 'Pareggio' : 'Sconfitta';
                          const esitoColor = risultato === 'Vittoria' ? 'bg-green-50 text-green-700' : risultato === 'Pareggio' ? 'bg-yellow-50 text-yellow-700' : 'bg-red-50 text-red-700';
                          const esitoIcon = risultato === 'Vittoria' ? 'âœ…' : risultato === 'Pareggio' ? 'ðŸŸ¡' : 'âŒ';
                          
                          return (
                            <tr key={m.id || idx} className="border-b hover:bg-gray-50">
                              <td className="p-3 font-semibold">
                                {new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' })}
                              </td>
                              <td className="p-3">
                                <div className="font-semibold text-gray-800">
                                  {(() => {
                                    if (m.squadraCasa && m.squadraTrasferta) {
                                      // Funzione helper per evidenziare il nome squadra
                                      const highlightTeamName = (squadraNome) => {
                                        if (!teamName || !teamName.trim()) return squadraNome;
                                        
                                        const teamLower = teamName.toLowerCase().trim();
                                        const squadraLower = squadraNome.toLowerCase().trim();
                                        
                                        // Match esatto
                                        if (squadraLower === teamLower) {
                                          return <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">{squadraNome}</span>;
                                        }
                                        
                                        // Match parziale (almeno 2 parole in comune)
                                        const teamWords = teamLower.split(/\s+/).filter(w => w.length > 2);
                                        const squadraWords = squadraLower.split(/\s+/).filter(w => w.length > 2);
                                        const commonWords = teamWords.filter(tw => 
                                          squadraWords.some(sw => sw.includes(tw) || tw.includes(sw))
                                        );
                                        
                                        if (commonWords.length >= 2) {
                                          return <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">{squadraNome}</span>;
                                        }
                                        
                                        return squadraNome;
                                      };
                                      
                                      return (
                                        <span>
                                          {highlightTeamName(m.squadraCasa)} vs {highlightTeamName(m.squadraTrasferta)}
                                        </span>
                                      );
                                    }
                                    
                                    return m.avversario || m.squadraTrasferta || 'Avversario';
                                  })()}
                                </div>
                              </td>
                              <td className="p-3 text-center">
                                <span className="text-lg font-bold text-gray-800">
                                  {(() => {
                                    // Calcola gol casa e trasferta per visualizzazione
                                    const golCasa = siamoInCasa ? golFatti : golSubiti;
                                    const golTrasferta = siamoInCasa ? golSubiti : golFatti;
                                    
                                    return `${golCasa} - ${golTrasferta}`;
                                  })()}
                                </span>
                              </td>
                              <td className="p-3 text-center">
                                <span className={`inline-block px-3 py-1 rounded-full text-sm font-bold ${esitoColor}`}>
                                  {esitoIcon} {risultato}
                                </span>
                              </td>
                              <td className="p-3 text-gray-600 hidden md:table-cell">{m.luogo || '-'}</td>
                            </tr>
                          );
                        })}
                      {matches.filter(m => {
                        const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                        const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                        return golFatti > 0 || golSubiti > 0;
                      }).length === 0 && (
                        <tr>
                          <td colSpan="5" className="p-8 text-center text-gray-500">
                            <div className="text-4xl mb-2">âš½</div>
                            <p>Nessuna partita completata</p>
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Pulsanti Azione */}
              <div className="flex flex-col sm:flex-row gap-3">
                <button
                  onClick={() => {
                    exportResultsPDF();
                  }}
                  className="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold flex items-center justify-center gap-2"
                >
                  ðŸ“„ Esporta PDF
                </button>
                <button
                  onClick={() => setShowResultsModal(false)}
                  className="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
                >
                  âœ• Chiudi
                </button>
              </div>
            </div>
          </div>
        )}

        {liveMatchMode && (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
            <div className="min-h-screen flex items-start justify-center p-4">
              <div className="bg-white rounded-lg shadow-2xl max-w-6xl w-full my-8 max-h-[calc(100vh-4rem)] flex flex-col">
                {(() => {
                  const match = matches.find(m => m.id === liveMatchMode);
                  
                  const sortByDistinta = (players) => {
                    return players.sort((a, b) => {
                      const posizioni = match.posizioneVisualizzazione || {};
                      const ordineDistinta = match.ordineDistinta || {};
                      
                      let ordineA = parseInt(posizioni[a.numero]);
                      if (!ordineA || isNaN(ordineA)) {
                        if (match.entrati && match.entrati[a.numero]) {
                          const dettaglio = (match.sostituzioniDettaglio || {})[a.numero];
                          if (dettaglio && dettaglio.alPostoDi) {
                            ordineA = parseInt(posizioni[dettaglio.alPostoDi]);
                          }
                        }
                        
                        if (!ordineA || isNaN(ordineA)) {
                          ordineA = parseInt(ordineDistinta[a.numero] || a.numero);
                        }
                      }
                      
                      let ordineB = parseInt(posizioni[b.numero]);
                      if (!ordineB || isNaN(ordineB)) {
                        if (match.entrati && match.entrati[b.numero]) {
                          const dettaglio = (match.sostituzioniDettaglio || {})[b.numero];
                          if (dettaglio && dettaglio.alPostoDi) {
                            ordineB = parseInt(posizioni[dettaglio.alPostoDi]);
                          }
                        }
                        
                        if (!ordineB || isNaN(ordineB)) {
                          ordineB = parseInt(ordineDistinta[b.numero] || b.numero);
                        }
                      }
                      
                      if (ordineA === ordineB) return a.numero - b.numero;
                      return ordineA - ordineB;
                    });
                  };
                  
                  // âœ… CORREZIONE BUG: I giocatori sostituiti ora appaiono in panchina
                  const inCampo = sortByDistinta(players.filter(p => 
                    (match.titolari[p.numero] || match.entrati[p.numero]) && !match.sostituzioni[p.numero]
                  ));
                  
                  const panchina = sortByDistinta(players.filter(p => 
                    ((match.convocati[p.numero] && !match.titolari[p.numero] && !match.entrati[p.numero]) ||
                     match.sostituzioni[p.numero]) &&
                    !match.rossi_gioco[p.numero] &&
                    !match.rossi_protesta[p.numero]
                  ));
                  
                  return (
                    <>
                      <div className="flex-shrink-0 sticky top-0 z-20">
                        <div className="p-4 border-b bg-gradient-to-r from-green-600 to-blue-600 text-white">
                          <div className="flex justify-between items-center">
                            <div>
                              <h3 className="text-2xl font-bold">âš¡ MODALITÃ€ LIVE</h3>
                              <p className="text-sm">{match.squadraCasa} vs {match.squadraTrasferta}</p>
                              <div className="flex items-center gap-6 mt-2">
                                <div className="text-4xl font-bold">
                                  ðŸ“Š {(() => {
                                    const golFatti = Object.values(match.golFatti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                    const golSubiti = Object.values(match.golSubiti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                    const siamoInCasa = isTeamPlayingHome(match);
                                    const golCasa = siamoInCasa ? golFatti : golSubiti;
                                    const golTrasferta = siamoInCasa ? golSubiti : golFatti;
                                    return `${golCasa} - ${golTrasferta}`;
                                  })()}
                                </div>
                                <div className={`px-4 py-2 rounded-lg font-bold text-lg ${
                                  (() => {
                                    const numSost = Object.values(match.sostituzioni || {}).filter(v => v === true).length;
                                    if (numSost >= 5) return 'bg-red-600 animate-pulse';
                                    if (numSost === 4) return 'bg-yellow-600 animate-pulse';
                                    return 'bg-blue-600';
                                  })()
                                }`}>
                                  ðŸ”„ Sostituzioni: {Object.values(match.sostituzioni || {}).filter(v => v === true).length}/5
                                </div>
                              </div>
                            </div>
                            <div className="flex gap-2">
                              {matchEnded && (() => {
                                const golFatti = Object.values(match.golFatti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                const golSubiti = Object.values(match.golSubiti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                const siamoInCasa = isTeamPlayingHome(match);
                                const golCasa = siamoInCasa ? golFatti : golSubiti;
                                const golTrasferta = siamoInCasa ? golSubiti : golFatti;
                                const abbiamovinto = golCasa > golTrasferta;
                                
                                if (abbiamovinto) {
                                  return (
                                    <button 
                                      onClick={() => setShowVictoryCelebration(true)} 
                                      className="px-6 py-3 bg-yellow-400 text-black rounded-lg hover:bg-yellow-500 font-black text-lg animate-pulse shadow-lg border-4 border-yellow-600"
                                    >
                                      ðŸŽ‰ VITTORIA! ðŸŽ‰
                                    </button>
                                  );
                                }
                                return null;
                              })()}
                              <button onClick={closeLiveMatch} className="px-4 py-2 bg-white text-gray-800 rounded-lg hover:bg-gray-100 font-semibold">
                                âœ• Chiudi
                              </button>
                            </div>
                          </div>
                        </div>

                        <div className="p-2 bg-gray-900 text-white shadow-xl border-b border-gray-700">
                        <div className="flex items-center justify-center gap-4">
                          <div className="flex items-center gap-3">
                            <div className="flex flex-col items-center gap-1">
                              <div className="flex items-center gap-2">
                                <div className={`px-3 py-1 rounded-lg font-bold text-sm ${halfTime === 1 ? 'bg-green-600' : 'bg-gray-600'}`}>
                                  1Â° TEMPO
                                </div>
                                <div className={`px-3 py-1 rounded-lg font-bold text-sm ${halfTime === 2 ? 'bg-green-600' : 'bg-gray-600'}`}>
                                  2Â° TEMPO
                                </div>
                              </div>
                              <div className="text-xs font-semibold opacity-70">TEMPO REGOLAMENTARE</div>
                              <div className="text-4xl font-bold font-mono">{formatTime(matchTimer)}</div>
                              {!matchEnded && (
                                <div className="flex gap-2">
                                  {!isTimerRunning ? (
                                    <button 
                                      onClick={startTimer} 
                                      disabled={(halfTime === 1 && matchTimer >= 2700) || (halfTime === 2 && matchTimer >= 5400)} 
                                      className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                      â–¶ Start
                                    </button>
                                  ) : (
                                    <button onClick={pauseTimer} className="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold">
                                      â¸ Pausa
                                    </button>
                                  )}
                                </div>
                              )}
                            </div>
                            {!matchEnded && (
                              <div className="flex flex-col gap-1">
                                <button onClick={addMinute} className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xl">â–²</button>
                                <button onClick={removeMinute} className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xl">â–¼</button>
                              </div>
                            )}
                          </div>

                          <div className="flex items-center gap-4 border-l-2 border-white pl-6">
                            <div className="flex flex-col items-center gap-2">
                              <div className="text-sm font-semibold opacity-70">RECUPERO</div>
                              <div className={`text-4xl font-bold font-mono ${
                                (matchTimer >= 2700 && halfTime === 1) || (matchTimer >= 5400 && halfTime === 2) 
                                  ? 'text-yellow-400' 
                                  : 'text-gray-600'
                              }`}>
                                +{formatTime(recoveryTime)}
                              </div>
                              {((matchTimer >= 2700 && halfTime === 1) || (matchTimer >= 5400 && halfTime === 2)) && (
                                <div className="flex items-center gap-2">
                                  <label className="text-xs opacity-70">Min previsti:</label>
                                  <input
                                    type="number"
                                    min="0"
                                    max="15"
                                    value={recoveryMinutes}
                                    onChange={(e) => setRecoveryMinutes(e.target.value)}
                                    placeholder="Min"
                                    className="w-12 px-2 py-1 bg-gray-800 border border-gray-600 rounded text-center text-white placeholder-gray-500"
                                  />
                                </div>
                              )}
                              {!matchEnded && isRecoveryRunning && (
                                <button onClick={() => setIsRecoveryRunning(false)} className="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold text-sm">
                                  â¸ Pausa
                                </button>
                              )}
                              {!matchEnded && !isRecoveryRunning && ((matchTimer >= 2700 && halfTime === 1) || (matchTimer >= 5400 && halfTime === 2)) && (
                                <button onClick={() => setIsRecoveryRunning(true)} className="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold text-sm">
                                  â–¶ Riprendi
                                </button>
                              )}
                            </div>
                            {!matchEnded && matchTimer >= 2700 && (
                              <div className="flex flex-col gap-1">
                                <button onClick={addRecoveryMinute} className="px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-xl">â–²</button>
                                <button onClick={removeRecoveryMinute} className="px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-xl">â–¼</button>
                              </div>
                            )}
                          </div>

                          {!matchEnded && (
                            <div className="border-l-2 border-white pl-6 flex flex-col gap-2">
                              {halfTime === 1 && matchTimer >= 2700 && (
                                <button onClick={() => {
                                  showConfirm('â±ï¸ PASSA AL 2Â° TEMPO\n\nVuoi passare al secondo tempo?\nIl recupero del 1Â° tempo verrÃ  azzerato.\n\nConfermi?', () => {
                                    setHalfTime(2);
                                    setMatchTimer(2700);
                                    setRecoveryTime(0);
                                    setRecoveryMinutes('');
                                    setIsRecoveryRunning(false);
                                    setIsTimerRunning(false);
                                  });
                                }} className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm">
                                  â© 2Â° TEMPO
                                </button>
                              )}
                              <button onClick={() => {
                                showConfirm('â±ï¸ AZZERA TIMER\n\nIl timer verrÃ  resettato a 0:00 (inizio 1Â° tempo).\n\nConfermi?', () => {
                                  setMatchTimer(0);
                                  setIsTimerRunning(false);
                                  setRecoveryTime(0);
                                  setIsRecoveryRunning(false);
                                  setHalfTime(1);
                                  setRecoveryMinutes('');
                                  setMatchEnded(false);
                                });
                              }} className="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold text-sm">
                                â±ï¸ AZZERA
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                      </div>

                        {/* ========== TIMELINE EVENTI PARTITA ========== */}
                        <div className="p-1 bg-white border-b border-gray-200">
                          <h4 className="text-xs font-bold text-gray-800 mb-0.5">â±ï¸ Timeline Eventi</h4>
                          <div className="relative">
                            {/* Linea temporale */}
                            <div className="absolute left-0 right-0 top-3 h-1 bg-gray-300 rounded"></div>
                            <div className="absolute left-0 top-3 h-1 bg-green-500 rounded" style={{ width: `${(matchTimer / 5400) * 100}%` }}></div>
                            
                            {/* Eventi sulla timeline */}
                            <div className="relative pt-3 min-h-[100px]">
                              {/* Marker inizio e fine */}
                              <div className="absolute left-0 top-0 flex flex-col items-center">
                                <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                <div className="text-xs text-gray-600 mt-1">0'</div>
                              </div>
                              <div className="absolute right-0 top-0 flex flex-col items-center">
                                <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                <div className="text-xs text-gray-600 mt-1">90'</div>
                              </div>
                              
                              {/* STEP 4: Eventi da match.timeline */}
                              {(match.timeline || []).map((evento, idx) => {
                                // Calcola posizione basata su minuto
                                let position = 5; // default all'inizio
                                
                                if (evento.minuto !== null && evento.minuto !== undefined) {
                                  // Usa minuto esatto se disponibile
                                  position = (parseInt(evento.minuto) / 90) * 100;
                                } else {
                                  // Altrimenti distribuzione uniforme
                                  const allEvents = match.timeline || [];
                                  const eventIndex = allEvents.findIndex(e => e.id === evento.id);
                                  position = ((eventIndex + 1) / (allEvents.length + 1)) * 100;
                                }
                                
                                // FIX: Calcola offset verticale per eventi allo stesso minuto
                                const eventsAtSameMinute = (match.timeline || []).filter((e, i) => {
                                  if (evento.minuto !== null && evento.minuto !== undefined) {
                                    return e.minuto === evento.minuto && i <= idx;
                                  }
                                  return false;
                                });
                                const verticalOffset = (eventsAtSameMinute.length - 1) * 28; // 28px di offset per ogni evento
                                
                                // Determina icona e colore
                                let icon = 'ðŸ“Œ';
                                let bgColor = 'bg-gray-500';
                                
                                if (evento.tipo === 'gol') {
                                  icon = 'âš½';
                                  bgColor = 'bg-green-500';
                                } else if (evento.tipo === 'golsubito') {
                                  icon = 'ðŸ”´';
                                  bgColor = 'bg-red-600';
                                } else if (evento.tipo === 'assist') {
                                  icon = 'ðŸŽ¯';
                                  bgColor = 'bg-blue-500';
                                } else if (evento.tipo === 'giallo') {
                                  icon = 'ðŸŸ¨';
                                  bgColor = 'bg-yellow-400';
                                } else if (evento.tipo === 'rosso') {
                                  icon = 'ðŸŸ¥';
                                  bgColor = 'bg-red-500';
                                } else {
                                  return null; // Non mostrare eventi sconosciuti
                                }
                                
                                return (
                                  <div 
                                    key={evento.id || `evento-${idx}`}
                                    className="absolute flex flex-col items-center"
                                    style={{ 
                                      left: `${Math.min(position, 95)}%`,
                                      top: `${verticalOffset}px`
                                    }}
                                    title={`${evento.playerNome} (${evento.tipo})`}
                                  >
                                    <div className={`w-4 h-4 ${bgColor} rounded-full flex items-center justify-center text-white text-xs font-bold`}>
                                      {icon}
                                    </div>
                                    <div className="text-xs text-gray-800 mt-1 whitespace-nowrap font-semibold">
                                      {evento.playerNome.split(' ')[0]}
                                    </div>
                                  </div>
                                );
                              })}
                              
                              {/* Sostituzioni sulla timeline */}
                              {Object.entries(match.sostituzioniDettaglio || {}).map(([playerNum, dettaglio]) => {
                                if (!dettaglio.minuto) return null;
                                
                                // Mostra solo per chi esce (sostituito), non duplicare per chi entra
                                if (!dettaglio.sostituito) return null;
                                
                                const position = (parseInt(dettaglio.minuto) / 90) * 100;
                                
                                // Trova giocatori
                                const playerOut = players.find(p => p.numero === parseInt(playerNum));
                                const playerIn = players.find(p => p.numero === dettaglio.sostituitoreDa);
                                
                                if (!playerOut || !playerIn) return null;
                                
                                // Estrai cognomi
                                const cognomeOut = playerOut.nome.split(' ')[0];
                                const cognomeIn = playerIn.nome.split(' ')[0];
                                
                                return (
                                  <div 
                                    key={`sost-${playerNum}`}
                                    className="absolute top-0 flex flex-col items-center"
                                    style={{ left: `${Math.min(position, 95)}%` }}
                                  >
                                    <div className="w-4 h-4 bg-yellow-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                      ðŸ”„
                                    </div>
                                    <div className="text-xs mt-1 whitespace-nowrap font-semibold">
                                      <div className="text-red-600">{cognomeOut}</div>
                                      <div className="text-green-600">{cognomeIn}</div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                          
                          {/* Legenda Timeline */}
                          <div className="flex items-center gap-2 justify-center mt-1 text-xs flex-wrap pb-1">
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                              <span>Gol</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                              <span>Assist</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-red-600 rounded-full"></div>
                              <span>Gol Subiti</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-yellow-400 rounded"></div>
                              <span>Gialli</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-red-500 rounded"></div>
                              <span>Rossi</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
                              <span>Sostituzioni</span>
                            </div>
                          </div>
                        </div>

                      <div className="flex-1 overflow-y-auto">
                        <div className="p-4">
                        {substitutionMode && (
                          <div className="mb-4 p-4 bg-orange-100 border-2 border-orange-400 rounded-lg">
                            <div className="flex justify-between">
                              <div>
                                <h5 className="font-bold text-orange-800">ðŸ”„ SOSTITUZIONE IN CORSO</h5>
                                <p className="text-sm text-orange-700">Esce: #{substitutionMode} - {players.find(p => p.numero === substitutionMode)?.nome}</p>
                              </div>
                              <button onClick={cancelSubstitution} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                                âœ• Annulla
                              </button>
                            </div>
                          </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                          <div>
                            <h4 className="text-lg font-bold mb-3 text-green-700">âš½ IN CAMPO ({inCampo.length}/11)</h4>
                            <div className="space-y-2">
                              {inCampo.map(player => {
                                const isExpelled = (match.rossi_gioco[player.numero] > 0 || match.rossi_protesta[player.numero] > 0);
                                return (
                                <div key={player.numero} className={`border-2 rounded-lg p-3 relative ${
                                  isExpelled ? 'bg-gray-200 border-gray-400 opacity-40' :
                                  match.sostituzioni[player.numero] ? 'bg-red-200 border-red-500' : 
                                  substitutionMode === player.numero ? 'bg-orange-200 border-orange-600' : 
                                  match.entrati[player.numero] ? 'bg-blue-400 border-blue-700' : 'bg-green-100 border-green-400'
                                }`}
                                  style={isExpelled ? { pointerEvents: 'none' } : {}}
                                >
                                  {isExpelled && (
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30">
                                      <div className="bg-red-600 text-white font-black text-4xl px-6 py-3 rounded-lg shadow-2xl border-4 border-red-800" style={{textShadow: '2px 2px 4px rgba(0,0,0,0.8)'}}>
                                        ESPULSO
                                      </div>
                                    </div>
                                  )}
                                  <div className="flex justify-between mb-2 relative z-20">
                                    <div className="flex items-center gap-2">
                                      <span className="text-xl font-bold">#{(match.ordineDistinta || {})[player.numero] || player.numero}</span>
                                      <span className="font-semibold">{player.nome}</span>
                                      {match.entrati[player.numero] && (() => {
                                        const dettaglio = (match.sostituzioniDettaglio || {})[player.numero];
                                        if (dettaglio && dettaglio.alPostoDi) {
                                          const sostituito = players.find(p => p.numero === dettaglio.alPostoDi);
                                          return (
                                            <span className="px-2 py-1 bg-green-700 text-white rounded font-bold text-xs">
                                              â†‘ ENTRATO al posto di #{dettaglio.alPostoDi} {sostituito ? sostituito.nome : ''}
                                            </span>
                                          );
                                        }
                                        return <span className="px-2 py-1 bg-green-700 text-white rounded font-bold text-xs">â†‘ ENTRATO</span>;
                                      })()}
                                      {match.sostituzioni[player.numero] && (() => {
                                        const dettaglio = (match.sostituzioniDettaglio || {})[player.numero];
                                        if (dettaglio && dettaglio.sostituitoreDa) {
                                          const sostitutore = players.find(p => p.numero === dettaglio.sostituitoreDa);
                                          return (
                                            <span className="px-2 py-1 bg-red-700 text-white rounded font-bold text-xs">
                                              â†“ SOSTITUITO da #{dettaglio.sostituitoreDa} {sostitutore ? sostitutore.nome : ''}
                                            </span>
                                          );
                                        }
                                        return null;
                                      })()}
                                      {(match.gialli_gioco[player.numero] > 0 || match.gialli_protesta[player.numero] > 0) && !match.rossi_gioco[player.numero] && !match.rossi_protesta[player.numero] && (
                                        <span className="px-2 py-1 bg-yellow-400 text-black rounded font-bold animate-pulse text-xs">âš ï¸ AMMONITO</span>
                                      )}
                                    </div>
                                    <div className="flex gap-1 text-xs">
                                      {player.ruolo === 'Portiere' ? (
                                        <span className="px-2 py-1 bg-red-600 text-white rounded font-bold">âš½ Subiti: {match.golSubiti[player.numero] || 0}</span>
                                      ) : (
                                        <>
                                          <span className="px-2 py-1 bg-green-600 text-white rounded">âš½ {match.golFatti[player.numero] || 0}</span>
                                          <span className="px-2 py-1 bg-blue-600 text-white rounded">ðŸŽ¯ {match.assist[player.numero] || 0}</span>
                                        </>
                                      )}
                                    </div>
                                  </div>
                                  {!substitutionMode && (
                                    <div className="flex gap-2 flex-wrap relative z-20">
                                      {player.ruolo === 'Portiere' ? (
                                        <>
                                          <button onClick={() => quickAddGoalConceded(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="flex-1 px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">
                                            âš½ GOL SUBITO
                                          </button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">ðŸŸ¨</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">ðŸŸ¥</button>
                                        </>
                                      ) : (
                                        <>
                                          <button onClick={() => quickAddGoal(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold text-sm">âš½ GOL</button>
                                          <button onClick={() => quickAddAssist(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold text-sm">ðŸŽ¯ ASSIST</button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">ðŸŸ¨</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">ðŸŸ¥</button>
                                        </>
                                      )}
                                    </div>
                                  )}
                                  {!match.sostituzioni[player.numero] && !substitutionMode && (
                                    <button onClick={() => initiateSubstitution(player.numero)} className="w-full mt-2 px-3 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 font-semibold text-sm relative z-20">
                                      ðŸ”„ SOSTITUISCI
                                    </button>
                                  )}
                                </div>
                              );})}
                            </div>
                          </div>

                          <div>
                            <h4 className="text-lg font-bold mb-3 text-gray-700">ðŸª‘ PANCHINA</h4>
                            <div className="space-y-2">
                              {panchina.map(player => {
                                const isExpelled = (match.rossi_gioco[player.numero] > 0 || match.rossi_protesta[player.numero] > 0);
                                const isSubstituted = match.sostituzioni[player.numero];
                                return (
                                <div key={player.numero} className={`border-2 rounded-lg p-3 relative ${
                                  isExpelled || isSubstituted ? 'bg-gray-200 border-gray-400 opacity-40' :
                                  match.entrati[player.numero] ? 'bg-blue-400 border-blue-700' : 
                                  substitutionMode ? 'bg-yellow-100 border-yellow-400 cursor-pointer hover:border-yellow-600' : 'bg-gray-100 border-gray-300'
                                }`}
                                  onClick={() => {
                                    if (substitutionMode && !match.entrati[player.numero] && !isSubstituted && !isExpelled) {
                                      completeSubstitution(liveMatchMode, substitutionMode, player.numero);
                                    }
                                  }}
                                  style={(isSubstituted || isExpelled) ? { pointerEvents: 'none' } : {}}
                                >
                                  {isExpelled && (
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30">
                                      <div className="bg-red-600 text-white font-black text-3xl px-4 py-2 rounded-lg shadow-2xl border-4 border-red-800" style={{textShadow: '2px 2px 4px rgba(0,0,0,0.8)'}}>
                                        ESPULSO
                                      </div>
                                    </div>
                                  )}
                                  <div className="flex justify-between mb-2 relative z-20">
                                    <div className="flex items-center gap-2">
                                      <span className="text-xl font-bold">#{(match.ordineDistinta || {})[player.numero] || player.numero}</span>
                                      <span className="font-semibold">{player.nome}</span>
                                      {match.sostituzioni[player.numero] && (() => {
                                        const dettaglio = (match.sostituzioniDettaglio || {})[player.numero];
                                        if (dettaglio && dettaglio.sostituitoreDa) {
                                          const sostitutore = players.find(p => p.numero === dettaglio.sostituitoreDa);
                                          return (
                                            <span className="px-2 py-1 bg-red-700 text-white rounded font-bold text-xs">
                                              â†“ SOSTITUITO da #{dettaglio.sostituitoreDa} {sostitutore ? sostitutore.nome : ''}
                                            </span>
                                          );
                                        }
                                        return <span className="px-2 py-1 bg-red-600 text-white rounded font-bold text-xs">â†“ SOSTITUITO</span>;
                                      })()}
                                      {match.entrati[player.numero] && (match.gialli_gioco[player.numero] > 0 || match.gialli_protesta[player.numero] > 0) && !match.rossi_gioco[player.numero] && (
                                        <span className="px-2 py-1 bg-yellow-400 text-black rounded font-bold animate-pulse text-xs">âš ï¸ AMMONITO</span>
                                      )}
                                    </div>
                                    {match.entrati[player.numero] && !match.sostituzioni[player.numero] && (
                                      <div className="flex gap-1 text-xs">
                                        <span className="px-2 py-1 bg-green-700 text-white rounded font-semibold">â†‘ ENTRATO</span>
                                        {player.ruolo === 'Portiere' ? (
                                          <span className="px-2 py-1 bg-red-600 text-white rounded font-bold">âš½ Subiti: {match.golSubiti[player.numero] || 0}</span>
                                        ) : (
                                          <>
                                            <span className="px-2 py-1 bg-green-600 text-white rounded">âš½ {match.golFatti[player.numero] || 0}</span>
                                            <span className="px-2 py-1 bg-blue-600 text-white rounded">ðŸŽ¯ {match.assist[player.numero] || 0}</span>
                                          </>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                  {!match.entrati[player.numero] && !substitutionMode && (
                                    <button 
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        showConfirm(`â–¶ Confermi l'INGRESSO IN CAMPO di ${player.nome} (#${player.numero})?`, () => {
                                          updateMatch(liveMatchMode, 'entrati', { ...match.entrati, [player.numero]: true });
                                        });
                                      }} 
                                      className="w-full px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold text-sm relative z-20"
                                    >
                                      â–¶ ENTRA IN CAMPO
                                    </button>
                                  )}
                                  {match.entrati[player.numero] && !substitutionMode && (
                                    <div className="flex gap-2 flex-wrap mt-2 relative z-20">
                                      {player.ruolo === 'Portiere' ? (
                                        <>
                                          <button onClick={() => quickAddGoalConceded(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="flex-1 px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">âš½ GOL SUBITO</button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">ðŸŸ¨</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">ðŸŸ¥</button>
                                        </>
                                      ) : (
                                        <>
                                          <button onClick={() => quickAddGoal(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold text-sm">âš½ GOL</button>
                                          <button onClick={() => quickAddAssist(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold text-sm">ðŸŽ¯ ASSIST</button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">ðŸŸ¨</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">ðŸŸ¥</button>
                                        </>
                                      )}
                                    </div>
                                  )}
                                </div>
                              );})}
                            </div>
                          </div>
                        </div>
                      </div>
                      </div>
                    </>
                  );
                })()}
              </div>
            </div>
          </div>
        )}

        {/* ============================================ */}
        {/* TAB CALENDARIO - NUOVO */}
        {/* ============================================ */}
        {activeTab === 'calendar' && (
          <div className="animate-fade-in">
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ“… Calendario Eventi</h2>
              <p className="text-gray-600">Vista mensile di allenamenti e partite programmate</p>
            </div>

            {/* Controlli Mese/Anno */}
            <div className="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6 border-2 border-gray-200">
              <div className="flex items-center justify-between gap-2 mb-4">
                <button
                  onClick={() => {
                    if (selectedMonth === 0) {
                      setSelectedMonth(11);
                      setSelectedYear(selectedYear - 1);
                    } else {
                      setSelectedMonth(selectedMonth - 1);
                    }
                  }}
                  className="px-2 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs md:text-base whitespace-nowrap"
                >
                  <span className="hidden md:inline">â† Mese Prec.</span>
                  <span className="md:hidden">â†</span>
                </button>
                <h3 className="text-base md:text-2xl font-bold text-gray-800 text-center flex-1 min-w-0 px-2">
                  {new Date(selectedYear, selectedMonth).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}
                </h3>
                <button
                  onClick={() => {
                    if (selectedMonth === 11) {
                      setSelectedMonth(0);
                      setSelectedYear(selectedYear + 1);
                    } else {
                      setSelectedMonth(selectedMonth + 1);
                    }
                  }}
                  className="px-2 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs md:text-base whitespace-nowrap"
                >
                  <span className="hidden md:inline">Mese Succ. â†’</span>
                  <span className="md:hidden">â†’</span>
                </button>
              </div>

              {/* Calendario Grid */}
              <div className="calendar-grid mb-4">
                {['L', 'M', 'M', 'G', 'V', 'S', 'D'].map((day, idx) => (
                  <div key={idx} className="text-center font-bold text-gray-600 p-2">
                    {day}
                  </div>
                ))}
                
                {/* Giorni vuoti iniziali */}
                {Array.from({ length: getFirstDayOfMonth(selectedMonth, selectedYear) === 0 ? 6 : getFirstDayOfMonth(selectedMonth, selectedYear) - 1 }).map((_, idx) => (
                  <div key={`empty-${idx}`} className="calendar-day opacity-0"></div>
                ))}
                
                {/* Giorni del mese */}
                {Array.from({ length: getDaysInMonth(selectedMonth, selectedYear) }).map((_, idx) => {
                  const day = idx + 1;
                  const date = new Date(selectedYear, selectedMonth, day);
                  const dateStr = date.toISOString().split('T')[0];
                  const events = getEventsForDate(date);
                  const isToday = new Date().toDateString() === date.toDateString();
                  const hasTrainings = events.trainings.length > 0;
                  const hasMatches = events.matches.length > 0;
                  const hasEvents = hasTrainings || hasMatches;
                  
                  // Determina classe evento
                  let eventClass = '';
                  if (hasTrainings && hasMatches) {
                    eventClass = 'has-both';
                  } else if (hasTrainings) {
                    eventClass = 'has-training';
                  } else if (hasMatches) {
                    eventClass = 'has-match';
                  }
                  
                  return (
                    <div
                      key={day}
                      className={`calendar-day ${isToday ? 'today' : ''} ${eventClass}`}
                      onClick={() => {
                        if (hasEvents) {
                          setSelectedDate(date);
                          setShowEventModal(true);
                        }
                      }}
                    >
                      <div className="font-semibold mb-1">{day}</div>
                      <div className="space-y-1 hidden md:block">
                        {events.trainings.length > 0 && (
                          <div className="text-xs bg-blue-200 text-blue-800 rounded px-1">
                            ðŸƒ {events.trainings.length}
                          </div>
                        )}
                        {events.matches.length > 0 && (
                          <div className="text-xs bg-green-200 text-green-800 rounded px-1">
                            âš½ {events.matches.length}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Legenda */}
              <div className="flex flex-wrap items-center gap-2 md:gap-4 justify-center text-xs md:text-sm">
                <div className="flex items-center gap-1 md:gap-2">
                  <div className="w-3 h-3 md:w-4 md:h-4 bg-blue-200 rounded"></div>
                  <span>ðŸƒ Allenamento</span>
                </div>
                <div className="flex items-center gap-1 md:gap-2">
                  <div className="w-3 h-3 md:w-4 md:h-4 bg-green-200 rounded"></div>
                  <span>âš½ Partita</span>
                </div>
                <div className="flex items-center gap-1 md:gap-2">
                  <div className="w-3 h-3 md:w-4 md:h-4 bg-blue-100 border-2 border-blue-600 rounded"></div>
                  <span>ðŸ“… Oggi</span>
                </div>
              </div>
            </div>

            {/* Prossimi Eventi */}
            <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
              <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“‹ Prossimi Eventi</h3>
              <div className="space-y-3">
                {[...trainings, ...matches]
                  .filter(e => new Date(e.data) >= new Date())
                  .sort((a, b) => new Date(a.data) - new Date(b.data))
                  .slice(0, 5)
                  .map((event, idx) => {
                    const isMatch = event.squadraCasa !== undefined;
                    return (
                      <div key={idx} className={`flex items-center justify-between p-3 rounded-lg ${isMatch ? 'bg-green-50 border-2 border-green-200' : 'bg-blue-50 border-2 border-blue-200'}`}>
                        <div className="flex items-center gap-3">
                          <div className="text-3xl">{isMatch ? 'âš½' : 'ðŸƒ'}</div>
                          <div>
                            <div className="font-semibold text-gray-800">
                              {isMatch ? `${event.squadraCasa} vs ${event.squadraTrasferta}` : 'Allenamento'}
                            </div>
                            <div className="text-sm text-gray-600">
                              {new Date(event.data).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}
                            </div>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm font-semibold text-gray-700">
                            {Math.ceil((new Date(event.data) - new Date()) / (1000 * 60 * 60 * 24))} giorni
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>
          </div>
        )}

        {/* Modal Eventi Giorno */}
        {showEventModal && selectedDate && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto animate-scale-up">
              <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold">
                    ðŸ“… {selectedDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                  </h3>
                  <button
                    onClick={() => setShowEventModal(false)}
                    className="text-white hover:text-gray-200 text-3xl font-bold"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6">
                {(() => {
                  const events = getEventsForDate(selectedDate);
                  return (
                    <div className="space-y-4">
                      {events.trainings.length > 0 && (
                        <div>
                          <h4 className="text-lg font-bold text-gray-800 mb-3">ðŸƒ Allenamenti ({events.trainings.length})</h4>
                          {events.trainings.map(t => {
                            const presenti = players.filter(p => p.nome && t.presenze && t.presenze[p.nome] === true);
                            const assenti = players.filter(p => p.nome && t.presenze && t.presenze[p.nome] === false);
                            
                            return (
                              <div key={t.id} className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <div className="font-semibold text-gray-800 mb-3">
                                  Presenze: {presenti.length}/{players.filter(p => p.nome).length}
                                </div>
                                
                                {presenti.length > 0 && (
                                  <div className="mb-3">
                                    <div className="text-sm font-bold text-green-700 mb-1">âœ… Presenti ({presenti.length}):</div>
                                    <div className="flex flex-wrap gap-1">
                                      {presenti.map(p => (
                                        <span key={p.nome} className="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                                          {p.nome}
                                        </span>
                                      ))}
                                    </div>
                                  </div>
                                )}
                                
                                {assenti.length > 0 && (
                                  <div>
                                    <div className="text-sm font-bold text-red-700 mb-1">âŒ Assenti ({assenti.length}):</div>
                                    <div className="flex flex-wrap gap-1">
                                      {assenti.map(p => (
                                        <span key={p.nome} className="inline-block bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-medium">
                                          {p.nome}
                                        </span>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      )}
                      
                      {events.matches.length > 0 && (
                        <div>
                          <h4 className="text-lg font-bold text-gray-800 mb-3">âš½ Partite ({events.matches.length})</h4>
                          {events.matches.map(m => (
                            <div key={m.id} className="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                              <div className="font-bold text-xl text-gray-800 mb-2 text-center">
                                {m.squadraCasa || 'Casa'} vs {m.squadraTrasferta || m.avversario || 'Trasferta'}
                              </div>
                              {m.risultato ? (
                                <div className="text-center">
                                  <div className="text-3xl font-bold text-green-600 mb-1">{m.risultato}</div>
                                  <div className="text-sm text-gray-600">Risultato Finale</div>
                                </div>
                              ) : (
                                <div className="text-center text-gray-500 text-sm">
                                  Partita da giocare
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {events.trainings.length === 0 && events.matches.length === 0 && (
                        <div className="text-center text-gray-500 py-8">
                          Nessun evento in questa data
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
            </div>
          </div>
        )}

        {/* ============================================ */}
        {/* TAB GESTIONE INFORTUNI - NUOVO */}
        {/* ============================================ */}
        {activeTab === 'injuries' && (
          <div className="animate-fade-in">
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ¤• Gestione Infortuni</h2>
              <p className="text-gray-600">Traccia e gestisci gli infortuni dei giocatori</p>
            </div>

            {/* Pulsante Nuovo Infortunio */}
            <div className="mb-6">
              <button
                onClick={() => setShowInjuryModal(true)}
                disabled={userRole !== 'admin'}
                className={`flex items-center gap-2 px-6 py-3 rounded-lg transition-colors font-semibold ${
                  userRole === 'admin'
                    ? 'bg-red-600 text-white hover:bg-red-700'
                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                }`}
                title={userRole !== 'admin' ? 'Solo Admin puÃ² registrare infortuni' : ''}
              >
                <Plus size={20} />
                Registra Nuovo Infortunio
              </button>
            </div>

            {/* Statistiche Infortuni */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg shadow-lg p-6 border-2 border-red-200">
                <div className="text-4xl mb-2">ðŸ¤•</div>
                <div className="text-3xl font-bold text-red-600">{getActiveInjuries().length}</div>
                <div className="text-gray-700 font-semibold">Infortuni Attivi</div>
              </div>
              
              <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow-lg p-6 border-2 border-yellow-200">
                <div className="text-4xl mb-2">ðŸ“ˆ</div>
                <div className="text-3xl font-bold text-yellow-600">
                  {injuries.filter(i => i.status === 'recovering').length}
                </div>
                <div className="text-gray-700 font-semibold">In Recupero</div>
              </div>
              
              <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200">
                <div className="text-4xl mb-2">âœ…</div>
                <div className="text-3xl font-bold text-green-600">
                  {injuries.filter(i => i.status === 'recovered').length}
                </div>
                <div className="text-gray-700 font-semibold">Recuperati</div>
              </div>
            </div>

            {/* Lista Infortuni Attivi */}
            {getActiveInjuries().length > 0 && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6 border-2 border-red-200">
                <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸš¨ Infortuni Attivi</h3>
                <div className="space-y-4">
                  {getActiveInjuries().map(injury => {
                    const daysSince = Math.floor((new Date() - new Date(injury.startDate)) / (1000 * 60 * 60 * 24));
                    const daysUntil = Math.ceil((new Date(injury.estimatedReturn) - new Date()) / (1000 * 60 * 60 * 24));
                    const totalDays = Math.ceil((new Date(injury.estimatedReturn) - new Date(injury.startDate)) / (1000 * 60 * 60 * 24));
                    const progress = Math.min(100, Math.max(0, (daysSince / totalDays) * 100));
                    
                    return (
                      <div key={injury.id} className="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                              <h4 className="text-lg font-bold text-gray-800">{injury.playerName}</h4>
                              <span className="text-sm text-gray-600">#{injury.playerNum}</span>
                            </div>
                            <div className="space-y-1 text-sm text-gray-700">
                              <div><strong>Tipo:</strong> {injury.type}</div>
                              <div><strong>Dal:</strong> {new Date(injury.startDate).toLocaleDateString('it-IT')}</div>
                              <div><strong>Rientro stimato:</strong> {new Date(injury.estimatedReturn).toLocaleDateString('it-IT')} 
                                <span className="ml-2 font-semibold text-red-600">
                                  ({daysUntil > 0 ? `${daysUntil} giorni` : 'Oggi o passato'})
                                </span>
                              </div>
                              {injury.notes && <div><strong>Note:</strong> {injury.notes}</div>}
                            </div>
                          </div>
                          <div 
                            className="flex gap-2"
                            style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.5} : {}}
                          >
                            <button
                              onClick={() => updateInjuryStatus(injury.id, 'recovering')}
                              className="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm"
                              title="Segna come in recupero"
                            >
                              ðŸ“ˆ
                            </button>
                            <button
                              onClick={() => updateInjuryStatus(injury.id, 'recovered')}
                              className="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm"
                              title="Segna come recuperato"
                            >
                              âœ…
                            </button>
                            <button
                              onClick={() => removeInjury(injury.id)}
                              className="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm"
                              title="Rimuovi"
                            >
                              ðŸ—‘ï¸
                            </button>
                          </div>
                        </div>
                        
                        {/* Progress Bar Recupero */}
                        <div className="mt-3">
                          <div className="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Progresso recupero</span>
                            <span>{progress.toFixed(0)}%</span>
                          </div>
                          <div className="progress-bar">
                            <div 
                              className="progress-bar-fill"
                              style={{
                                width: `${progress}%`,
                                background: progress < 33 ? '#ef4444' : progress < 66 ? '#f59e0b' : '#10b981'
                              }}
                            ></div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Tutti gli Infortuni (con filtro stato) */}
            <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
              <h3 className="text-xl font-bold text-gray-800 mb-4">ðŸ“‹ Storico Completo</h3>
              {injuries.length === 0 ? (
                <div className="text-center text-gray-500 py-8">
                  Nessun infortunio registrato
                </div>
              ) : (
                <div className="space-y-3">
                  {injuries.map(injury => (
                    <div key={injury.id} className={`rounded-lg p-4 border-2 ${
                      injury.status === 'active' ? 'bg-red-50 border-red-200' :
                      injury.status === 'recovering' ? 'bg-yellow-50 border-yellow-200' :
                      'bg-green-50 border-green-200'
                    }`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3 flex-1">
                          <span className={`injury-badge ${injury.status}`}>
                            {injury.status === 'active' ? 'ðŸ¤• Attivo' :
                             injury.status === 'recovering' ? 'ðŸ“ˆ Recupero' :
                             'âœ… Recuperato'}
                          </span>
                          <div>
                            <div className="font-semibold text-gray-800">{injury.playerName} #{injury.playerNum}</div>
                            <div className="text-sm text-gray-600">{injury.type}</div>
                          </div>
                        </div>
                        <div className="flex items-center gap-4">
                          <div className="text-sm text-gray-600">
                            {new Date(injury.startDate).toLocaleDateString('it-IT')} â†’ {new Date(injury.estimatedReturn).toLocaleDateString('it-IT')}
                          </div>
                          {userRole === 'admin' && (
                            <div className="flex gap-2">
                              <button
                                onClick={() => {
                                  setEditingInjury(injury);
                                  setShowEditInjuryModal(true);
                                }}
                                className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm font-semibold"
                                title="Modifica infortunio"
                              >
                                âœï¸
                              </button>
                              <button
                                onClick={() => removeInjury(injury.id)}
                                className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm font-semibold"
                                title="Elimina infortunio"
                              >
                                ðŸ—‘ï¸
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Modal Nuovo Infortunio */}
        {showInjuryModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full animate-scale-up">
              <div className="bg-gradient-to-r from-red-600 to-red-800 text-white p-6 rounded-t-lg">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold">ðŸ¤• Registra Nuovo Infortunio</h3>
                  <button
                    onClick={() => {
                      setShowInjuryModal(false);
                      setSelectedPlayerForInjury(null);
                    }}
                    className="text-white hover:text-gray-200 text-3xl font-bold"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6">
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Giocatore</label>
                    <select
                      value={selectedPlayerForInjury || ''}
                      onChange={(e) => setSelectedPlayerForInjury(parseInt(e.target.value))}
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    >
                      <option value="">Seleziona giocatore...</option>
                      {players.filter(p => p.nome).map(p => (
                        <option key={p.numero} value={p.numero}>
                          #{p.numero} - {p.nome}
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Tipo di Infortunio</label>
                    <input
                      type="text"
                      id="injuryType"
                      placeholder="Es: Distorsione caviglia, Stiramento muscolare..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    />
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Data Inizio</label>
                      <input
                        type="date"
                        id="injuryStartDate"
                        defaultValue={new Date().toISOString().split('T')[0]}
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Rientro Stimato</label>
                      <input
                        type="date"
                        id="injuryReturnDate"
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Note (opzionale)</label>
                    <textarea
                      id="injuryNotes"
                      rows="3"
                      placeholder="Descrizione, trattamenti, raccomandazioni..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    ></textarea>
                  </div>
                  
                  <button
                    onClick={() => {
                      if (!selectedPlayerForInjury) {
                        showToast('Seleziona un giocatore!', 'warning');
                        return;
                      }
                      
                      const type = document.getElementById('injuryType').value;
                      const startDate = document.getElementById('injuryStartDate').value;
                      const returnDate = document.getElementById('injuryReturnDate').value;
                      const notes = document.getElementById('injuryNotes').value;
                      
                      if (!type || !returnDate) {
                        showToast('Compila tutti i campi obbligatori!', 'warning');
                        return;
                      }
                      
                      addInjury(selectedPlayerForInjury, {
                        type,
                        startDate,
                        estimatedReturn: returnDate,
                        notes
                      });
                      
                      setShowInjuryModal(false);
                      setSelectedPlayerForInjury(null);
                    }}
                    className="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold"
                  >
                    Registra Infortunio
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Modifica Infortunio */}
        {showEditInjuryModal && editingInjury && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full animate-scale-up">
              <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold">âœï¸ Modifica Infortunio</h3>
                  <button
                    onClick={() => {
                      setShowEditInjuryModal(false);
                      setEditingInjury(null);
                    }}
                    className="text-white hover:text-gray-200 text-3xl font-bold"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              
              <div className="p-6">
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Giocatore</label>
                    <div className="w-full px-4 py-2 bg-gray-100 border-2 border-gray-300 rounded-lg">
                      #{editingInjury.playerNum} - {editingInjury.playerName}
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Tipo di Infortunio</label>
                    <input
                      type="text"
                      id="editInjuryType"
                      defaultValue={editingInjury.type}
                      placeholder="Es: Distorsione caviglia, Stiramento muscolare..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Stato</label>
                    <select
                      id="editInjuryStatus"
                      defaultValue={editingInjury.status}
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    >
                      <option value="active">ðŸ¤• Attivo</option>
                      <option value="recovering">ðŸ“ˆ In Recupero</option>
                      <option value="recovered">âœ… Recuperato</option>
                    </select>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Data Inizio</label>
                      <input
                        type="date"
                        id="editInjuryStartDate"
                        defaultValue={editingInjury.startDate}
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Rientro Stimato</label>
                      <input
                        type="date"
                        id="editInjuryReturnDate"
                        defaultValue={editingInjury.estimatedReturn}
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Note (opzionale)</label>
                    <textarea
                      id="editInjuryNotes"
                      rows="3"
                      defaultValue={editingInjury.notes || ''}
                      placeholder="Descrizione, trattamenti, raccomandazioni..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    ></textarea>
                  </div>
                  
                  <button
                    onClick={() => {
                      const type = document.getElementById('editInjuryType').value;
                      const status = document.getElementById('editInjuryStatus').value;
                      const startDate = document.getElementById('editInjuryStartDate').value;
                      const returnDate = document.getElementById('editInjuryReturnDate').value;
                      const notes = document.getElementById('editInjuryNotes').value;
                      
                      if (!type || !returnDate) {
                        showToast('Compila tutti i campi obbligatori!', 'warning');
                        return;
                      }
                      
                      // Aggiorna l'infortunio
                      setInjuries(injuries.map(inj => 
                        inj.id === editingInjury.id 
                          ? {
                              ...inj,
                              type,
                              status,
                              startDate,
                              estimatedReturn: returnDate,
                              notes
                            }
                          : inj
                      ));
                      
                      showToast('Infortunio aggiornato!', 'success');
                      setShowEditInjuryModal(false);
                      setEditingInjury(null);
                    }}
                    className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                  >
                    Salva Modifiche
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Votazione MVP */}
        {showMVPModal && selectedMatchForMVP && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-3xl w-full animate-scale-up max-h-[90vh] overflow-y-auto">
              {(() => {
                const match = matches.find(m => m.id === selectedMatchForMVP);
                if (!match) return null;
                
                const convocati = players.filter(p => match.convocati[p.numero]);
                
                return (
                  <>
                    <div className="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-6 rounded-t-lg sticky top-0 z-10">
                      <div className="flex justify-between items-center">
                        <div>
                          <h3 className="text-2xl font-bold">ðŸ† Man of the Match</h3>
                          <p className="text-yellow-100 mt-1">
                            {match.squadraCasa} vs {match.squadraTrasferta}
                          </p>
                        </div>
                        <button
                          onClick={() => {
                            setShowMVPModal(false);
                            setSelectedMatchForMVP(null);
                          }}
                          className="text-white hover:text-yellow-200 text-3xl font-bold"
                        >
                          Ã—
                        </button>
                      </div>
                    </div>
                    
                    <div className="p-6">
                      <div className="mb-4">
                        <p className="text-gray-600 text-center">
                          Chi Ã¨ stato il migliore in campo? â­
                        </p>
                      </div>
                      
                      {convocati.length === 0 ? (
                        <div className="text-center py-8 text-gray-500">
                          Nessun giocatore convocato per questa partita
                        </div>
                      ) : (
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                          {convocati.map(player => {
                            const isCurrentMVP = match.mvp === player.numero;
                            const gol = match.golFatti[player.numero] || 0;
                            const assist = match.assist[player.numero] || 0;
                            
                            return (
                              <button
                                key={player.numero}
                                onClick={() => assignMVP(match.id, player.numero)}
                                className={`relative p-4 rounded-lg border-2 transition-all hover:scale-105 ${
                                  isCurrentMVP
                                    ? 'bg-gradient-to-br from-yellow-100 to-yellow-200 border-yellow-500 shadow-lg'
                                    : 'bg-white border-gray-200 hover:border-yellow-400 hover:shadow-md'
                                }`}
                              >
                                {isCurrentMVP && (
                                  <div className="absolute -top-2 -right-2 bg-yellow-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg animate-pulse-slow">
                                    ðŸ†
                                  </div>
                                )}
                                
                                <div className="flex flex-col items-center">
                                  {player.foto ? (
                                    <img
                                      src={player.foto}
                                      alt={player.nome}
                                      className="w-16 h-16 rounded-full object-cover mb-2 border-2 border-gray-200"
                                    />
                                  ) : (
                                    <div className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mb-2 border-2 border-gray-300">
                                      <span className="text-2xl font-bold text-gray-500">
                                        {player.numero}
                                      </span>
                                    </div>
                                  )}
                                  
                                  <div className="text-center">
                                    <p className="font-bold text-sm text-gray-800 mb-1">
                                      {player.nome.split(' ')[0]}
                                    </p>
                                    <p className="text-xs text-gray-600 mb-2 line-clamp-2">
                                      {player.nome}
                                    </p>
                                    
                                    {(gol > 0 || assist > 0) && (
                                      <div className="flex justify-center gap-2 text-xs">
                                        {gol > 0 && (
                                          <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded">
                                            âš½ {gol}
                                          </span>
                                        )}
                                        {assist > 0 && (
                                          <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                                            ðŸŽ¯ {assist}
                                          </span>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      )}
                      
                      {match.mvp && (
                        <div className="mt-6 pt-6 border-t border-gray-200">
                          <button
                            onClick={() => {
                              removeMVP(match.id);
                              setShowMVPModal(false);
                              setSelectedMatchForMVP(null);
                            }}
                            className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg transition-colors font-semibold"
                          >
                            ðŸ”„ Rimuovi MVP
                          </button>
                        </div>
                      )}
                    </div>
                  </>
                );
              })()}
            </div>
          </div>
        )}

        {/* ============================================ */}
        {/* TAB REPORT */}
        {/* ============================================ */}
        {activeTab === 'report' && (
          <div className="animate-fade-in">
            {userRole !== 'admin' ? (
              // Accesso negato per user
              <div className="bg-red-50 border-2 border-red-300 rounded-lg p-12 text-center animate-fade-in">
                <div className="text-6xl mb-4">ðŸ”’</div>
                <h2 className="text-2xl font-bold text-red-900 mb-2">Accesso Negato</h2>
                <p className="text-red-700 mb-4">
                  Solo gli amministratori possono accedere ai report.
                </p>
                <button
                  onClick={() => setActiveTab('dashboard')}
                  className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                >
                  â† Torna alla Dashboard
                </button>
              </div>
            ) : (
              // Contenuto normale per admin
              <div>
                <div className="mb-6">
                  <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ“„ Report PDF</h2>
                  <p className="text-gray-600">Genera report professionali in formato PDF</p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-6 border-2 border-blue-200">
                    <div className="text-4xl mb-4">ðŸ“Š</div>
                    <h3 className="text-xl font-bold text-gray-800 mb-2">Report Stagionale</h3>
                    <p className="text-gray-600 text-sm mb-4">
                      Esporta un report completo con tutte le statistiche della stagione in PDF
                    </p>
                    <button
                      onClick={downloadSeasonReportPDF}
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                    >
                      Scarica Report PDF
                    </button>
                  </div>
                  
                  <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200">
                    <div className="text-4xl mb-4">ðŸ‘¤</div>
                    <h3 className="text-xl font-bold text-gray-800 mb-2">Scheda Giocatore</h3>
                    <p className="text-gray-600 text-sm mb-4">
                      Esporta la scheda dettagliata di un singolo giocatore con tutte le sue statistiche
                    </p>
                    <select 
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-3"
                      id="playerSelect"
                    >
                      <option value="">Seleziona giocatore...</option>
                      {players.filter(p => p.nome).map(p => (
                        <option key={p.numero} value={p.numero}>#{p.numero} - {p.nome}</option>
                      ))}
                    </select>
                    <button
                      onClick={() => {
                        const select = document.getElementById('playerSelect');
                        const playerNum = parseInt(select.value);
                        if (playerNum) {
                          downloadPlayerCardPDF(playerNum);
                        } else {
                          showToast('âš ï¸ Seleziona un giocatore!', 'warning');
                        }
                      }}
                      className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                    >
                      Scarica Scheda PDF
                    </button>
                  </div>
                </div>
                
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                  <div className="flex items-start gap-3">
                    <div className="text-2xl">â„¹ï¸</div>
                    <div>
                      <h4 className="font-bold text-gray-800 mb-2">Informazioni sui Report:</h4>
                      <ul className="text-sm text-gray-700 space-y-1">
                        <li>â€¢ Il <strong>Report Stagionale</strong> include statistiche generali, top marcatori, assist e rosa completa</li>
                        <li>â€¢ La <strong>Scheda Giocatore</strong> contiene foto, dati anagrafici e statistiche dettagliate individuali</li>
                        <li>â€¢ I report sono ideali per presentazioni, archivio storico o condivisione con societÃ /genitori</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* ============================================ */}
        {/* TAB BACKUP E SINCRONIZZAZIONE */}
        {/* ============================================ */}
        {activeTab === 'backup' && (
          <div className="animate-fade-in">
            {userRole !== 'admin' ? (
              // Accesso negato per user
              <div className="bg-red-50 border-2 border-red-300 rounded-lg p-12 text-center animate-fade-in">
                <div className="text-6xl mb-4">ðŸ”’</div>
                <h2 className="text-2xl font-bold text-red-900 mb-2">Accesso Negato</h2>
                <p className="text-red-700 mb-4">
                  Solo gli amministratori possono gestire backup, sincronizzazione e import/export dati.
                </p>
                <button
                  onClick={() => setActiveTab('dashboard')}
                  className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                >
                  â† Torna alla Dashboard
                </button>
              </div>
            ) : (
              // Contenuto normale per admin
              <div>
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">â˜ï¸ Backup e Sincronizzazione</h2>
              <p className="text-gray-600">Gestisci backup automatici, sincronizzazione cloud e import/export dati</p>
            </div>

            {/* Status Card */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 mb-6 border-2 border-blue-200">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-gray-800">Stato Sincronizzazione</h3>
                {syncStatus === 'syncing' && (
                  <div className="spinner"></div>
                )}
                {syncStatus === 'success' && (
                  <span className="text-green-600 text-2xl animate-pulse">âœ…</span>
                )}
                {syncStatus === 'error' && (
                  <span className="text-red-600 text-2xl animate-shake">âŒ</span>
                )}
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-sm text-gray-600 mb-1">Ultimo Salvataggio Locale</div>
                  <div className="text-lg font-bold text-gray-800">
                    {lastSaved ? lastSaved.toLocaleString('it-IT') : 'Mai salvato'}
                  </div>
                </div>
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-sm text-gray-600 mb-1">Ultima Sincronizzazione Cloud</div>
                  <div className="text-lg font-bold text-gray-800">
                    {lastSynced ? lastSynced.toLocaleString('it-IT') : 'Mai sincronizzato'}
                  </div>
                </div>
              </div>

              {syncError && (
                <div className="bg-red-100 border-2 border-red-300 rounded-lg p-4 mb-4">
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">âš ï¸</span>
                    <div>
                      <div className="font-bold text-red-800 mb-1">Errore di Sincronizzazione</div>
                      <div className="text-sm text-red-700">{syncError}</div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Azioni di Sincronizzazione */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              
              {/* Upload Cloud */}
              <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200">
                <div className="text-4xl mb-4">â˜ï¸â†‘</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Carica su Cloud</h3>
                <p className="text-gray-600 text-sm mb-4">
                  Carica forzatamente i dati locali sul cloud, sovrascrivendo quelli presenti
                </p>
                <button
                  onClick={async () => {
                    if (window.confirm('âš ï¸ Questa operazione sovrascriverÃ  i dati nel cloud con quelli locali.\n\nSei sicuro?')) {
                      try {
                        setSyncStatus('syncing');
                        await saveDataToCloud(false); // false = mostra toast
                        setSyncStatus('success');
                        setTimeout(() => setSyncStatus('idle'), 3000);
                      } catch (error) {
                        console.error('Errore sync:', error);
                        setSyncStatus('error');
                        setSyncError(error.message);
                        setTimeout(() => setSyncStatus('idle'), 5000);
                      }
                    }
                  }}
                  disabled={syncStatus === 'syncing'}
                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {syncStatus === 'syncing' ? 'â³ Caricamento...' : 'â˜ï¸ Carica su Cloud'}
                </button>
              </div>

              {/* Download Cloud */}
              <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg shadow-lg p-6 border-2 border-orange-200">
                <div className="text-4xl mb-4">â˜ï¸â†“</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Scarica da Cloud</h3>
                <p className="text-gray-600 text-sm mb-4">
                  Scarica forzatamente i dati dal cloud, sovrascrivendo quelli locali
                </p>
                <button
                  onClick={() => {
                    console.log('ðŸ”˜ BOTTONE SCARICA CLICCATO!');
                    console.log('   User:', user?.email);
                    console.log('   syncStatus:', syncStatus);
                    console.log('   disabled:', syncStatus === 'syncing');
                    
                    if (window.confirm('âš ï¸ Questa operazione sovrascriverÃ  i dati locali con quelli del cloud.\n\nSei sicuro?')) {
                      console.log('âœ… Confermato! Chiamo syncFromFirestore(true)...');
                      syncFromFirestore(true);
                    } else {
                      console.log('âŒ Annullato dall\'utente');
                    }
                  }}
                  disabled={syncStatus === 'syncing'}
                  className="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {syncStatus === 'syncing' ? 'â³ Scaricamento...' : 'â˜ï¸ Scarica da Cloud'}
                </button>
              </div>

              {/* Statistiche Dati */}
              <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-lg p-6 border-2 border-purple-200">
                <div className="text-4xl mb-4">ðŸ“Š</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Statistiche Dati</h3>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-gray-600">Giocatori in rosa:</span>
                    <span className="font-bold text-gray-800">{players.filter(p => p.nome).length}/30</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Allenamenti registrati:</span>
                    <span className="font-bold text-gray-800">{trainings.length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Partite registrate:</span>
                    <span className="font-bold text-gray-800">{matches.length}</span>
                  </div>
                  <div className="flex justify-between pt-2 border-t">
                    <span className="text-gray-600">Utente connesso:</span>
                    <span className="font-bold text-gray-800 truncate max-w-[200px]" title={user?.email}>
                      {user?.email || 'N/A'}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            {/* Info Box */}
            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
              <div className="flex items-start gap-3">
                <div className="text-2xl">â„¹ï¸</div>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">Come Funziona la Sincronizzazione</h4>
                  <ul className="text-sm text-gray-700 space-y-2">
                    <li>
                      <strong>â˜ï¸â†‘ Carica su Cloud:</strong> Salva i dati locali sul cloud Firebase. Usa questa opzione quando hai fatto modifiche importanti che vuoi conservare nel cloud come backup.
                    </li>
                    <li>
                      <strong>â˜ï¸â†“ Scarica da Cloud:</strong> Scarica i dati dal cloud e sostituisce quelli locali. Usa questa opzione quando hai modificato i dati da un altro dispositivo e vuoi aggiornarli su questo dispositivo.
                    </li>
                    <li>
                      <strong>ðŸ’¾ Backup Locale:</strong> I dati sono SEMPRE salvati automaticamente in locale (IndexedDB) ad ogni modifica. La sincronizzazione cloud Ã¨ un backup aggiuntivo che devi gestire manualmente.
                    </li>
                    <li>
                      <strong>âš ï¸ Attenzione:</strong> Le operazioni di carica/scarica SOVRASCRIVONO i dati. Usa sempre la conferma per evitare perdite accidentali. In caso di dubbio, esporta prima un backup JSON dalla sezione Esportazioni.
                    </li>
                    <li>
                      <strong>ðŸ”’ Privacy:</strong> I tuoi dati sono privati. Solo tu puoi accedere ai dati del tuo account. Ogni utente ha il suo spazio cloud separato.
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            {/* CompatibilitÃ  Export/Import */}
            <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6 mt-6">
              <div className="flex items-start gap-3">
                <div className="text-2xl">âœ…</div>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">CompatibilitÃ  con Export/Import JSON</h4>
                  <p className="text-sm text-gray-700 mb-2">
                    La sincronizzazione cloud NON sostituisce le funzioni di export/import JSON! Puoi sempre:
                  </p>
                  <ul className="text-sm text-gray-700 space-y-1 ml-4">
                    <li>â€¢ Esportare i dati in JSON come backup manuale</li>
                    <li>â€¢ Importare JSON per ripristinare o migrare dati</li>
                    <li>â€¢ Utilizzare JSON per trasferire dati tra account diversi</li>
                    <li>â€¢ Creare backup offline dei dati</li>
                  </ul>
                  <p className="text-sm text-gray-700 mt-2">
                    <strong>ðŸ’¡ Consiglio:</strong> Usa la sincronizzazione cloud per l'accesso multi-dispositivo quotidiano, e l'export JSON per backup di sicurezza periodici!
                  </p>
                </div>
              </div>
            </div>

            {/* ============================================ */}
            {/* SEZIONE SISTEMA BACKUP AVANZATO */}
            {/* ============================================ */}
            <div className="bg-white rounded-lg shadow-lg p-6 mt-8">
              <h3 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <span>ðŸ’¾</span>
                <span>Sistema Backup</span>
              </h3>

              {/* Backup Automatici */}
              <div className="mb-8">
                <div className="flex items-center justify-between mb-4">
                  <h4 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <span>ðŸ¤–</span>
                    <span>Backup Automatici (Cloud)</span>
                  </h4>
                  <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    âœ… Attivo
                  </span>
                </div>
                
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                  <div className="space-y-2 text-sm">
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ“… Frequenza:</span>
                      <span className="font-semibold text-gray-900">Giornaliero (ogni 24h)</span>
                    </p>
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ’¾ Ultimo backup:</span>
                      <span className="font-semibold text-gray-900">
                        {lastBackupDate ? new Date(lastBackupDate).toLocaleString('it-IT') : 'Mai eseguito'}
                      </span>
                    </p>
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ”„ Rotazione:</span>
                      <span className="font-semibold text-gray-900">Ultimi 7 giorni</span>
                    </p>
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ“¦ Dimensione:</span>
                      <span className="font-semibold text-gray-900">~2 MB (solo dati)</span>
                    </p>
                  </div>
                </div>

                {/* Lista Backup Disponibili */}
                <div className="bg-gray-50 rounded-lg p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h5 className="font-semibold text-gray-800">ðŸ“‹ Backup Disponibili ({availableBackups.length})</h5>
                    <button
                      onClick={loadAvailableBackups}
                      disabled={loadingBackups}
                      className="text-sm px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors disabled:opacity-50"
                    >
                      {loadingBackups ? 'â³' : 'ðŸ”„'} Aggiorna
                    </button>
                  </div>
                  
                  {loadingBackups ? (
                    <div className="text-center py-4 text-gray-600">
                      <div className="spinner inline-block mr-2"></div>
                      Caricamento...
                    </div>
                  ) : availableBackups.length === 0 ? (
                    <div className="text-center py-4 text-gray-600">
                      Nessun backup disponibile. Il primo backup verrÃ  creato automaticamente nelle prossime 24 ore.
                    </div>
                  ) : (
                    <div className="space-y-2 max-h-80 overflow-y-auto">
                      {availableBackups.map((backup, index) => (
                        <div key={backup.name} className="bg-white rounded-lg p-3 border border-gray-200 hover:shadow-md transition-shadow">
                          <div className="flex items-center justify-between">
                            <div className="flex-1">
                              <p className="font-medium text-gray-800">
                                ðŸ“… {new Date(backup.fullTimestamp).toLocaleDateString('it-IT', {
                                  weekday: 'short',
                                  day: '2-digit',
                                  month: 'short',
                                  year: 'numeric'
                                })}
                              </p>
                              <p className="text-sm text-gray-600">
                                ðŸ• {backup.time} â€¢ {(backup.size / 1024).toFixed(0)} KB
                                {index === 0 && <span className="ml-2 text-green-600 font-semibold">(PiÃ¹ recente)</span>}
                              </p>
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={() => downloadBackup(backup.url, backup.name)}
                                className="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm font-medium"
                                title="Scarica backup"
                              >
                                ðŸ“¥ Scarica
                              </button>
                              <button
                                onClick={() => restoreDailyBackup(backup.url, backup.name)}
                                className="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-medium"
                                title="Ripristina questo backup"
                              >
                                â™»ï¸ Ripristina
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Azione Manuale Backup */}
                <div className="mt-4">
                  <button
                    onClick={async () => {
                      if (window.confirm('Vuoi creare un backup manuale adesso?\n\nQuesta operazione salverÃ  tutti i dati correnti.')) {
                        showLoadingWithProgress('ðŸ”„ Creazione backup manuale...', 0);
                        const success = await createDailyBackup();
                        hideLoading();
                        if (success) {
                          showToast('âœ… Backup manuale creato!', 'success');
                          await loadAvailableBackups();
                        } else {
                          showToast('âŒ Errore creazione backup', 'error');
                        }
                      }
                    }}
                    className="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold"
                  >
                    ðŸ”§ Crea Backup Manuale Ora
                  </button>
                </div>
              </div>

              {/* Divider */}
              <div className="border-t border-gray-200 my-8"></div>

              {/* Backup Completo PC */}
              <div>
                <h4 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <span>ðŸ’»</span>
                  <span>Backup Completo (Download)</span>
                </h4>
                
                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                  <div className="space-y-2 text-sm">
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ“¦ Tipo:</span>
                      <span className="font-semibold text-gray-900">JSON completo (tutti i dati + URL foto)</span>
                    </p>
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ’¾ Dimensione stimata:</span>
                      <span className="font-semibold text-gray-900">~{storageStats.jsonSizeMB || 2} MB</span>
                    </p>
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ“¸ Foto:</span>
                      <span className="font-semibold text-gray-900">URL/path (non embedded)</span>
                    </p>
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ›¡ï¸ Protezione:</span>
                      <span className="font-semibold text-gray-900">Dati completi (foto in archivio)</span>
                    </p>
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ“… Ultimo backup:</span>
                      <span className="font-semibold text-gray-900">
                        {lastFullBackupDate ? new Date(lastFullBackupDate).toLocaleDateString('it-IT') : 'Mai eseguito'}
                      </span>
                    </p>
                    <p className="flex items-center justify-between">
                      <span className="text-gray-700">ðŸ“… Consiglio:</span>
                      <span className="font-semibold text-gray-900">1 volta al mese</span>
                    </p>
                  </div>
                </div>

                <div className="flex gap-4">
                  <button
                    onClick={downloadFullBackupWithPhotos}
                    className="flex-1 px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-semibold flex items-center justify-center gap-2"
                  >
                    <span>ðŸ“¥</span>
                    <span>Scarica Backup Completo</span>
                  </button>
                </div>
              </div>

              {/* Info Box */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
                <div className="flex items-start gap-3">
                  <span className="text-xl">ðŸ’¡</span>
                  <div className="text-sm text-gray-700 space-y-2">
                    <p className="font-semibold text-gray-800">Come Funziona il Sistema Backup</p>
                    <ul className="space-y-1 ml-4">
                      <li>â€¢ <strong>Backup Automatici:</strong> Salvati su cloud ogni 24h, contengono tutti i dati + URL foto (~2 MB)</li>
                      <li>â€¢ <strong>Backup Completo:</strong> Download sul PC con tutti i dati + URL foto (~2 MB)</li>
                      <li>â€¢ <strong>Foto NON Embedded:</strong> Le foto restano SEMPRE nell'archivio cloud (giÃ  protette)</li>
                      <li>â€¢ <strong>Storage Locale:</strong> IndexedDB mantiene copia locale per funzionamento offline</li>
                      <li>â€¢ <strong>Protezione:</strong> L'archivio cloud ha ridondanza geografica e recupero file eliminati (30 giorni)</li>
                    </ul>
                    <p className="text-xs text-gray-600 mt-2 pt-2 border-t border-blue-200">
                      ðŸ’° Costo: â‚¬0,00/mese - Tutto incluso (Foto + Backup = ~363 MB)
                    </p>
                  </div>
                </div>
              </div>

              {/* Divider */}
              <div className="border-t border-gray-200 my-8"></div>

              {/* Import Locale */}
              <div>
                <h4 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <span>ðŸ“¥</span>
                  <span>Import Dati da File</span>
                </h4>
                
                <div className="bg-green-50 border-2 border-green-400 rounded-lg p-4 mb-4">
                  <p className="font-bold text-green-800 mb-2">âœ… I tuoi dati sono salvati automaticamente sul dispositivo</p>
                  <p className="text-sm text-green-900">
                    Usa questa funzione solo se vuoi:
                  </p>
                  <ul className="list-disc ml-6 mt-2 text-sm text-green-900">
                    <li><strong>Trasferire i dati</strong> su un altro dispositivo</li>
                    <li><strong>Ripristinare</strong> dati da un file di backup precedente</li>
                    <li><strong>Importare</strong> dati salvati sul tuo computer</li>
                  </ul>
                </div>
                
                <label className="flex items-center justify-center gap-2 bg-blue-600 text-white px-6 py-4 rounded-lg hover:bg-blue-700 transition-colors cursor-pointer w-full">
                  <Download size={20} className="rotate-180" />
                  <span className="font-semibold">ðŸ“± Importa da File JSON</span>
                  <input
                    type="file"
                    accept=".json,application/json,text/plain"
                    onChange={handleFileImport}
                    className="hidden"
                    multiple={false}
                  />
                </label>
              </div>

              {/* Statistiche Archivio */}
              <div className="bg-gray-50 rounded-lg p-4 mt-6">
                <div className="flex items-center justify-between mb-3">
                  <h5 className="font-semibold text-gray-800">ðŸ“Š Statistiche Archivio</h5>
                  <button
                    onClick={async () => {
                      setLoadingStorageSize(true);
                      const realSize = await calculateRealStorageSize();
                      if (realSize) {
                        setRealStorageSize(realSize);
                        showToast('âœ… Dimensioni Storage aggiornate!', 'success');
                      } else {
                        showToast('âš ï¸ Impossibile calcolare dimensioni', 'warning');
                      }
                      setLoadingStorageSize(false);
                    }}
                    disabled={loadingStorageSize}
                    className="text-sm px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors disabled:opacity-50"
                    title="Ricalcola dimensioni reali"
                  >
                    {loadingStorageSize ? 'â³' : 'ðŸ”„'} Aggiorna
                  </button>
                </div>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between items-center">
                    <span className="text-gray-700">Dimensione backup JSON:</span>
                    <span className="font-semibold text-gray-900">~{storageStats.jsonSizeMB || 2} MB</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-gray-700">Backup automatici (7 giorni):</span>
                    <span className="font-semibold text-gray-900">~14 MB</span>
                  </div>
                  
                  {loadingStorageSize ? (
                    <div className="flex justify-between items-center py-2">
                      <span className="text-gray-700">Foto archiviate:</span>
                      <span className="text-gray-600 italic">
                        <div className="spinner inline-block mr-2" style={{width: '12px', height: '12px'}}></div>
                        Calcolo...
                      </span>
                    </div>
                  ) : realStorageSize ? (
                    <>
                      <div className="flex justify-between items-center">
                        <span className="text-gray-700">Foto archiviate:</span>
                        <span className="font-semibold text-green-600">
                          {Math.round(realStorageSize.total / 1024 / 1024)} MB
                        </span>
                      </div>
                      <div className="ml-4 space-y-1 text-xs text-gray-600">
                        <div className="flex justify-between">
                          <span>â€¢ Logo:</span>
                          <span>{Math.round(realStorageSize.breakdown.logo / 1024)} KB</span>
                        </div>
                        <div className="flex justify-between">
                          <span>â€¢ Foto giocatori:</span>
                          <span>{Math.round(realStorageSize.breakdown.playerPhotos / 1024 / 1024)} MB</span>
                        </div>
                        <div className="flex justify-between">
                          <span>â€¢ Foto partite:</span>
                          <span>{Math.round(realStorageSize.breakdown.matchPhotos / 1024 / 1024)} MB</span>
                        </div>
                        <div className="flex justify-between">
                          <span>â€¢ Foto allenamenti:</span>
                          <span>{Math.round(realStorageSize.breakdown.trainingPhotos / 1024 / 1024)} MB</span>
                        </div>
                      </div>
                    </>
                  ) : (
                    <div className="flex justify-between items-center">
                      <span className="text-gray-700">Foto archiviate (stima):</span>
                      <span className="font-semibold text-gray-900">~350 MB</span>
                    </div>
                  )}
                  
                  <div className="flex justify-between items-center pt-2 border-t font-semibold">
                    <span className="text-gray-700">Totale archivio cloud:</span>
                    <span className="text-gray-900">
                      {realStorageSize 
                        ? `${Math.round((realStorageSize.total + 14 * 1024 * 1024) / 1024 / 1024)} MB`
                        : '~365 MB'
                      }
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-gray-700">Spazio disponibile:</span>
                    <span className="text-gray-900">1,024 MB (1 GB)</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div 
                      className="bg-green-600 h-2 rounded-full transition-all duration-300"
                      style={{ 
                        width: realStorageSize 
                          ? `${Math.min(Math.round(((realStorageSize.total + 14 * 1024 * 1024) / (1024 * 1024 * 1024)) * 100), 100)}%`
                          : '36%'
                      }}
                      title={realStorageSize 
                        ? `~${Math.round(((realStorageSize.total + 14 * 1024 * 1024) / (1024 * 1024 * 1024)) * 100)}% usato`
                        : '~36% usato (stima)'
                      }
                    ></div>
                  </div>
                  <div className="flex justify-between items-center pt-2 border-t">
                    <span className="text-gray-700">Dispositivo rilevato:</span>
                    <span className="font-semibold text-gray-900 capitalize">
                      {deviceType === 'mobile' && 'ðŸ“± Mobile'}
                      {deviceType === 'tablet' && 'ðŸ“Ÿ Tablet'}
                      {deviceType === 'desktop' && 'ðŸ’» Desktop'}
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-gray-700">Costo mensile:</span>
                    <span className="font-semibold text-green-600">â‚¬0,00</span>
                  </div>
                </div>
              </div>
            </div>

            </div>
            )}
          </div>
        )}

        {/* ============================================ */}
        {/* TAB GESTIONE UTENTI ADMIN */}
        {/* ============================================ */}
        {activeTab === 'admin' && userRole === 'admin' && (
          <div className="animate-fade-in">
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ‘‘ Gestione Utenti</h2>
              <p className="text-gray-600">Gestisci account utenti e permessi (Solo Admin)</p>
            </div>

            {/* Azioni Rapide */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <button
                onClick={loadAllUsers}
                disabled={loadingUsers}
                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {loadingUsers ? (
                  <>
                    <div className="spinner"></div>
                    <span>Caricamento...</span>
                  </>
                ) : (
                  <>
                    <span className="text-2xl">ðŸ”„</span>
                    <span>Carica Lista Utenti</span>
                  </>
                )}
              </button>

              <button
                onClick={() => setShowCreateUserModal(true)}
                className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
              >
                <span className="text-2xl">âž•</span>
                <span>Crea Nuovo Utente</span>
              </button>
            </div>

            {/* Avviso Importante */}
            <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
              <div className="flex items-start gap-3">
                <span className="text-2xl">âš ï¸</span>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">Note Importanti</h4>
                  <ul className="text-sm text-gray-700 space-y-1">
                    <li>â€¢ <strong>Crea Utente:</strong> Ti farÃ  logout temporaneamente. Dovrai rifare login come admin.</li>
                    <li>â€¢ <strong>Reset Password:</strong> Invia email all'utente con link per cambiare password.</li>
                    <li>â€¢ <strong>Elimina Utente:</strong> Rimuove dal database. Per eliminare completamente, contatta l'amministratore.</li>
                    <li>â€¢ <strong>Cambio Email:</strong> Per cambiare email, contatta l'amministratore.</li>
                  </ul>
                </div>
              </div>
            </div>

            {/* Lista Utenti */}
            {allUsers.length > 0 && (
              <div className="bg-white border-2 border-gray-200 rounded-lg overflow-hidden">
                <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-4">
                  <h3 className="text-xl font-bold text-white">ðŸ“‹ Utenti Registrati ({allUsers.length})</h3>
                </div>

                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-4 py-3 text-left text-sm font-bold text-gray-700">Email</th>
                        <th className="px-4 py-3 text-left text-sm font-bold text-gray-700">Ruolo</th>
                        <th className="px-4 py-3 text-left text-sm font-bold text-gray-700">Creato</th>
                        <th className="px-4 py-3 text-center text-sm font-bold text-gray-700">Azioni</th>
                      </tr>
                    </thead>
                    <tbody>
                      {allUsers.map((usr, index) => (
                        <tr key={usr.uid} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                          <td className="px-4 py-3 text-sm">
                            <div className="flex items-center gap-2">
                              <span className="text-lg">{usr.role === 'admin' ? 'ðŸ‘‘' : 'ðŸ‘ï¸'}</span>
                              <span className="font-medium">{usr.email || usr.uid}</span>
                              {usr.uid === user.uid && (
                                <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded">TU</span>
                              )}
                            </div>
                          </td>
                          <td className="px-4 py-3">
                            <select
                              value={usr.role || 'user'}
                              onChange={(e) => changeUserRole(usr.uid, e.target.value)}
                              disabled={usr.uid === user.uid || userActionLoading}
                              className={`px-3 py-1 rounded-lg text-sm font-bold ${
                                usr.role === 'admin'
                                  ? 'bg-yellow-100 text-yellow-800'
                                  : 'bg-blue-100 text-blue-800'
                              } disabled:opacity-50`}
                            >
                              <option value="admin">ðŸ‘‘ Admin</option>
                              <option value="user">ðŸ‘ï¸ User</option>
                            </select>
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-600">
                            {usr.createdAt ? new Date(usr.createdAt).toLocaleDateString('it-IT') : 'N/A'}
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex items-center justify-center gap-2">
                              <button
                                onClick={() => sendPasswordReset(usr.email)}
                                disabled={userActionLoading || !usr.email}
                                className="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                title="Invia email reset password"
                              >
                                ðŸ”‘ Reset
                              </button>
                              <button
                                onClick={() => deleteUser(usr.uid, usr.email)}
                                disabled={usr.uid === user.uid || userActionLoading}
                                className="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs font-bold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                title="Elimina utente"
                              >
                                ðŸ—‘ï¸
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {allUsers.length === 0 && !loadingUsers && (
              <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-12 text-center">
                <div className="text-6xl mb-4">ðŸ‘¥</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Nessun Utente Caricato</h3>
                <p className="text-gray-600 mb-4">Clicca "Carica Lista Utenti" per vedere tutti gli account</p>
              </div>
            )}

            {/* Guida Firebase Console */}
            <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-6 mt-6">
              <div className="flex items-start gap-3">
                <span className="text-2xl">ðŸ’¡</span>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">Per Gestione Avanzata</h4>
                  <p className="text-sm text-gray-700 mb-2">
                    Per operazioni avanzate come cambio email, elimina account o altre modifiche, contatta l'amministratore del sistema.
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ============================================ */}
        {/* TAB RESET DATABASE */}
        {/* ============================================ */}
        {activeTab === 'reset' && (
          <div className="space-y-6 animate-fade-in">
            {userRole !== 'admin' ? (
              // Accesso negato per user
              <div className="bg-red-50 border-2 border-red-300 rounded-lg p-12 text-center animate-fade-in">
                <div className="text-6xl mb-4">ðŸ”’</div>
                <h2 className="text-2xl font-bold text-red-900 mb-2">Accesso Negato</h2>
                <p className="text-red-700 mb-4">
                  Solo gli amministratori possono accedere alle funzioni di reset del database.
                </p>
                <button
                  onClick={() => setActiveTab('dashboard')}
                  className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                >
                  â† Torna alla Dashboard
                </button>
              </div>
            ) : (
              // Contenuto normale per admin
              <div>
                <div className="mb-6">
                  <h2 className="text-3xl font-bold text-gray-800 mb-2">ðŸ”´ Reset Database</h2>
                  <p className="text-gray-600">Operazioni avanzate per reset stagione o completo del database</p>
                </div>

                {/* Warning Principale */}
                <div className="bg-red-50 border-2 border-red-300 rounded-lg p-6 mb-6">
                  <div className="flex items-start gap-3">
                    <span className="text-3xl">âš ï¸</span>
                    <div>
                      <p className="font-bold text-red-800 mb-2 text-lg">ATTENZIONE: Operazioni Permanenti</p>
                      <p className="text-sm text-red-900 mb-2">
                        Usa queste funzioni solo quando devi iniziare una nuova stagione o resettare completamente l'app.
                      </p>
                      <p className="text-sm text-red-900 font-bold">
                        ðŸ’¡ CONSIGLIO IMPORTANTE: Vai su "Backup e Sync" e crea un backup completo PRIMA di procedere!
                      </p>
                    </div>
                  </div>
                </div>

                {/* Reset Stagione */}
                <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
                  <div className="p-4 bg-orange-50 border-2 border-orange-300 rounded-lg">
                    <h3 className="font-bold text-orange-900 mb-3 text-xl flex items-center gap-2">
                      <span>ðŸ”„</span>
                      <span>Reset Stagione (consigliato)</span>
                    </h3>
                    <p className="text-sm text-orange-800 mb-4">
                      Cancella allenamenti, partite e statistiche ma <strong>mantiene la rosa giocatori</strong> e il logo.
                      Ideale per iniziare una nuova stagione con la stessa squadra.
                    </p>
                    <div className="bg-orange-100 border border-orange-300 rounded p-3 mb-4">
                      <p className="text-xs text-orange-900 font-semibold mb-2">âœ… Cosa viene MANTENUTO:</p>
                      <ul className="text-xs text-orange-900 space-y-1 ml-4">
                        <li>â€¢ Rosa giocatori completa</li>
                        <li>â€¢ Logo squadra</li>
                        <li>â€¢ Configurazione account</li>
                      </ul>
                      <p className="text-xs text-orange-900 font-semibold mt-3 mb-2">âŒ Cosa viene CANCELLATO:</p>
                      <ul className="text-xs text-orange-900 space-y-1 ml-4">
                        <li>â€¢ Tutti gli allenamenti</li>
                        <li>â€¢ Tutte le partite</li>
                        <li>â€¢ Tutte le statistiche</li>
                        <li>â€¢ Formazioni tattiche</li>
                      </ul>
                    </div>
                    <button
                      onClick={resetStagione}
                      className="w-full flex items-center justify-center gap-2 bg-orange-600 text-white px-6 py-4 rounded-lg hover:bg-orange-700 transition-colors font-semibold text-lg"
                    >
                      ðŸ”„ Reset Stagione (mantieni rosa)
                    </button>
                  </div>
                </div>

                {/* Reset Completo */}
                <div className="bg-white rounded-lg shadow-xl p-6 border-2 border-red-300">
                  <div className="p-4 bg-red-50 border-2 border-red-400 rounded-lg">
                    <h3 className="font-bold text-red-900 mb-3 text-xl flex items-center gap-2">
                      <span>ðŸ”´</span>
                      <span>Reset Completo (pericoloso)</span>
                    </h3>
                    <p className="text-sm text-red-800 mb-4">
                      Cancella <strong>TUTTO</strong>: giocatori, allenamenti, partite, statistiche, logo.
                      L'app tornerÃ  come nuova. Usa solo se vuoi ricominciare da zero.
                    </p>
                    <div className="bg-red-100 border border-red-400 rounded p-3 mb-4">
                      <p className="text-xs text-red-900 font-semibold mb-2">ðŸ”´ Cosa viene CANCELLATO:</p>
                      <ul className="text-xs text-red-900 space-y-1 ml-4">
                        <li>â€¢ <strong>TUTTI</strong> i giocatori</li>
                        <li>â€¢ <strong>TUTTI</strong> gli allenamenti</li>
                        <li>â€¢ <strong>TUTTE</strong> le partite</li>
                        <li>â€¢ <strong>TUTTE</strong> le statistiche</li>
                        <li>â€¢ Logo squadra</li>
                        <li>â€¢ Formazioni tattiche</li>
                        <li>â€¢ Ogni dato dell'app</li>
                      </ul>
                      <p className="text-xs text-red-900 font-bold mt-3">
                        âš ï¸ Questa operazione NON puÃ² essere annullata!
                      </p>
                    </div>
                    <button
                      onClick={resetCompleto}
                      className="w-full flex items-center justify-center gap-2 bg-red-700 text-white px-6 py-4 rounded-lg hover:bg-red-800 transition-colors font-semibold text-lg"
                    >
                      ðŸ”´ Reset Completo (cancella tutto)
                    </button>
                  </div>
                </div>

                {/* Info Finale */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
                  <div className="flex items-start gap-2">
                    <span className="text-xl">ðŸ’¡</span>
                    <div className="text-sm text-gray-700">
                      <p className="font-semibold mb-2">Consigli per un reset sicuro:</p>
                      <ul className="space-y-1 ml-4">
                        <li>1. Vai su <strong>"Backup e Sync"</strong></li>
                        <li>2. Clicca <strong>"Scarica Backup Completo"</strong></li>
                        <li>3. Salva il file in un luogo sicuro</li>
                        <li>4. Solo dopo torna qui ed esegui il reset</li>
                      </ul>
                      <p className="mt-2 text-xs text-gray-600">
                        â„¹ï¸ Con un backup potrai sempre ripristinare i dati in caso di errore
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Modal Crea Nuovo Utente */}
        {showCreateUserModal && (
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[110] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6 animate-scale-up">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">âž•</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Crea Nuovo Utente</h2>
              </div>

              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-2">Email</label>
                  <input
                    type="email"
                    value={newUserEmail}
                    onChange={(e) => setNewUserEmail(e.target.value)}
                    placeholder="utente@example.com"
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    disabled={userActionLoading}
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-2">Password</label>
                  <input
                    type="password"
                    value={newUserPassword}
                    onChange={(e) => setNewUserPassword(e.target.value)}
                    placeholder="Minimo 6 caratteri"
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    disabled={userActionLoading}
                  />
                  <p className="text-xs text-gray-500 mt-1">Minimo 6 caratteri</p>
                </div>

                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-2">Ruolo</label>
                  <select
                    value={newUserRole}
                    onChange={(e) => setNewUserRole(e.target.value)}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    disabled={userActionLoading}
                  >
                    <option value="user">ðŸ‘ï¸ Visualizzatore (User)</option>
                    <option value="admin">ðŸ‘‘ Amministratore (Admin)</option>
                  </select>
                </div>
              </div>

              <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                <div className="flex items-start gap-2">
                  <span className="text-xl">âš ï¸</span>
                  <p className="text-sm text-gray-700">
                    <strong>ATTENZIONE:</strong> Questa operazione ti farÃ  logout temporaneamente. Dovrai rifare login come admin dopo la creazione.
                  </p>
                </div>
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowCreateUserModal(false);
                    setNewUserEmail('');
                    setNewUserPassword('');
                    setNewUserRole('user');
                  }}
                  disabled={userActionLoading}
                  className="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50"
                >
                  Annulla
                </button>
                <button
                  onClick={createNewUser}
                  disabled={userActionLoading || !newUserEmail || !newUserPassword}
                  className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {userActionLoading ? 'Creazione...' : 'âœ… Crea'}
                </button>
              </div>
            </div>
          </div>
        )}

        {confirmDialog.show && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6 animate-scale-up">
              <div className="text-lg font-semibold text-gray-800 mb-4 whitespace-pre-line">
                {confirmDialog.message}
              </div>
              <div className="flex gap-3 justify-end">
                <button
                  onClick={handleCancel}
                  className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
                >
                  Annulla
                </button>
                <button
                  onClick={handleConfirm}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                >
                  Conferma
                </button>
              </div>
            </div>
          </div>
        )}

        {cardTypeDialog.show && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">
                  {cardTypeDialog.cardType === 'yellow' ? 'ðŸŸ¨' : 'ðŸŸ¥'}
                </div>
                <div className="text-xl font-bold text-gray-800 mb-2">
                  Cartellino {cardTypeDialog.cardType === 'yellow' ? 'GIALLO' : 'ROSSO'}
                </div>
                <div className="text-lg text-gray-700">
                  {cardTypeDialog.playerName} (#{cardTypeDialog.playerNum})
                </div>
              </div>
              
              <div className="text-center text-gray-700 font-semibold mb-4">
                Per quale motivo?
              </div>
              
              <div className="flex flex-col gap-3">
                <button
                  onClick={() => assignCard('gioco')}
                  className="px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-bold text-lg shadow-lg"
                >
                  âš½ Per GIOCO
                </button>
                <button
                  onClick={() => assignCard('protesta')}
                  className="px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-bold text-lg shadow-lg"
                >
                  ðŸ—£ï¸ Per PROTESTA
                </button>
                <button
                  onClick={() => setCardTypeDialog({ show: false, cardType: '', playerNum: 0, matchId: null, playerName: '', minuto: null })}
                  className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
                >
                  Annulla
                </button>
              </div>
            </div>
          </div>
        )}

        {enlargedPhoto && (
          <div 
            className="fixed inset-0 bg-black bg-opacity-95 flex flex-col items-center justify-center z-[99999] p-4"
            onClick={() => setEnlargedPhoto(null)}
          >
            {/* Header con bottone chiudi e nome (se presente) */}
            <div className="w-full max-w-6xl flex justify-between items-center mb-4 px-4">
              {/* Nome giocatore (solo per foto profilo) */}
              {typeof enlargedPhoto === 'object' && enlargedPhoto.nome ? (
                <div className="text-white text-2xl font-bold">
                  {enlargedPhoto.nome}
                </div>
              ) : (
                <div></div>
              )}
              
              {/* Bottone chiudi */}
              <button 
                onClick={() => setEnlargedPhoto(null)}
                className="text-white text-5xl font-bold hover:text-gray-300 transition-colors leading-none"
                title="Chiudi"
              >
                âœ•
              </button>
            </div>
            
            {/* Immagine ingrandita */}
            <div className="relative w-full max-w-6xl max-h-[85vh] flex items-center justify-center">
              <img 
                src={typeof enlargedPhoto === 'string' ? enlargedPhoto : enlargedPhoto.foto} 
                alt={typeof enlargedPhoto === 'object' && enlargedPhoto.nome ? enlargedPhoto.nome : 'Foto'} 
                className="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl"
                onClick={(e) => e.stopPropagation()}
              />
            </div>
            
            {/* Footer con istruzioni */}
            <div className="mt-4 text-white text-sm opacity-70">
              Click fuori dall'immagine o sulla âœ• per chiudere
            </div>
          </div>
        )}

        {showVictoryCelebration && (
          <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[110]">
            <div className="relative w-full h-full flex items-center justify-center">
              <div className="absolute inset-0 overflow-hidden pointer-events-none">
                {[...Array(50)].map((_, i) => (
                  <div
                    key={i}
                    className="absolute animate-confetti"
                    style={{
                      left: `${Math.random() * 100}%`,
                      top: `-${Math.random() * 20}%`,
                      width: '10px',
                      height: '10px',
                      backgroundColor: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'][Math.floor(Math.random() * 6)],
                      animationDelay: `${Math.random() * 3}s`,
                      animationDuration: `${3 + Math.random() * 2}s`,
                      transform: `rotate(${Math.random() * 360}deg)`
                    }}
                  />
                ))}
              </div>
              
              <div className="relative z-10 text-center px-4">
                <div className="text-8xl md:text-9xl font-black text-yellow-400 animate-bounce mb-4" style={{textShadow: '4px 4px 8px rgba(0,0,0,0.8), 0 0 40px rgba(255,215,0,0.8)'}}>
                  ðŸ† VITTORIA! ðŸ†
                </div>
                <div className="text-7xl md:text-8xl font-black text-white animate-pulse" style={{textShadow: '4px 4px 10px rgba(0,0,0,0.9), 0 0 30px rgba(255,255,255,0.5)'}}>
                  Volevano Vincere!!
                </div>
                <div className="text-7xl md:text-8xl font-black text-white animate-pulse mt-2" style={{textShadow: '4px 4px 10px rgba(0,0,0,0.9), 0 0 30px rgba(255,255,255,0.5)', animationDelay: '0.3s'}}>
                  Volevano Vincere!!
                </div>
                
                <div className="flex justify-center gap-4 mt-6 text-5xl">
                  <span className="animate-bounce" style={{animationDelay: '0s'}}>ðŸŽµ</span>
                  <span className="animate-bounce" style={{animationDelay: '0.2s'}}>ðŸŽ¶</span>
                  <span className="animate-bounce" style={{animationDelay: '0.4s'}}>ðŸŽµ</span>
                  <span className="animate-bounce" style={{animationDelay: '0.6s'}}>ðŸŽ¶</span>
                  <span className="animate-bounce" style={{animationDelay: '0.8s'}}>ðŸŽµ</span>
                </div>
                
                <button 
                  onClick={() => setShowVictoryCelebration(false)}
                  className="mt-8 px-4 py-2 bg-yellow-400 text-black rounded-lg hover:bg-yellow-500 font-bold text-sm shadow-lg border-2 border-yellow-600"
                >
                  âœ• Chiudi Festeggiamento
                </button>
              </div>
            </div>
          </div>
        )}
        
        {/* Modal Risoluzione Conflitti Sincronizzazione */}
        {showConflictModal && syncConflicts && (
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[110] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full p-6 animate-scale-up max-h-[90vh] overflow-y-auto">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">âš ï¸</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Conflitto di Sincronizzazione</h2>
                <p className="text-gray-600">Sono stati trovati dati sia in locale che nel cloud. Scegli quale versione mantenere:</p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                {/* Dati Locali */}
                <div className="border-2 border-blue-300 rounded-lg p-4 bg-blue-50">
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-3xl">ðŸ’¾</span>
                    <h3 className="text-xl font-bold text-gray-800">Dati Locali (Questo Dispositivo)</h3>
                  </div>
                  <div className="space-y-2 text-sm mb-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giocatori:</span>
                      <span className="font-bold">{syncConflicts.local.players.filter(p => p.nome).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Allenamenti:</span>
                      <span className="font-bold">{syncConflicts.local.trainings.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Partite:</span>
                      <span className="font-bold">{syncConflicts.local.matches.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Squadre Girone:</span>
                      <span className="font-bold">{(syncConflicts.local.squadreGirone || []).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giornate Campionato:</span>
                      <span className="font-bold">{(syncConflicts.local.risultatiCampionato || []).length}</span>
                    </div>
                    <div className="flex justify-between pt-2 border-t">
                      <span className="text-gray-600">Ultima modifica:</span>
                      <span className="font-bold">{syncConflicts.local.lastSaved.toLocaleString('it-IT')}</span>
                    </div>
                  </div>
                  <button
                    onClick={() => resolveConflict('local')}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    âœ… Mantieni Dati Locali
                  </button>
                  <p className="text-xs text-gray-600 mt-2 text-center">
                    SovrascriverÃ  i dati nel cloud
                  </p>
                </div>

                {/* Dati Cloud */}
                <div className="border-2 border-green-300 rounded-lg p-4 bg-green-50">
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-3xl">â˜ï¸</span>
                    <h3 className="text-xl font-bold text-gray-800">Dati Cloud</h3>
                  </div>
                  <div className="space-y-2 text-sm mb-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giocatori:</span>
                      <span className="font-bold">{syncConflicts.cloud.players.filter(p => p.nome).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Allenamenti:</span>
                      <span className="font-bold">{syncConflicts.cloud.trainings.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Partite:</span>
                      <span className="font-bold">{syncConflicts.cloud.matches.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Squadre Girone:</span>
                      <span className="font-bold">{(syncConflicts.cloud.squadreGirone || []).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giornate Campionato:</span>
                      <span className="font-bold">{(syncConflicts.cloud.risultatiCampionato || []).length}</span>
                    </div>
                    <div className="flex justify-between pt-2 border-t">
                      <span className="text-gray-600">Ultima sincronizzazione:</span>
                      <span className="font-bold">{syncConflicts.cloud.lastSynced.toLocaleString('it-IT')}</span>
                    </div>
                  </div>
                  <button
                    onClick={() => resolveConflict('cloud')}
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    âœ… Mantieni Dati Cloud
                  </button>
                  <p className="text-xs text-gray-600 mt-2 text-center">
                    SovrascriverÃ  i dati locali
                  </p>
                </div>
              </div>

              <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                <div className="flex items-start gap-3">
                  <span className="text-2xl">âš ï¸</span>
                  <div>
                    <h4 className="font-bold text-gray-800 mb-2">Attenzione!</h4>
                    <p className="text-sm text-gray-700">
                      Scegliendo una versione, l'altra verrÃ  <strong>completamente sovrascritta</strong>. 
                      Assicurati di scegliere la versione con i dati piÃ¹ aggiornati e completi.
                    </p>
                    {(syncConflicts.local.players.filter(p => p.nome).length === 0 || 
                      syncConflicts.cloud.players.filter(p => p.nome).length === 0) && (
                      <p className="text-sm font-bold text-red-600 mt-2">
                        ðŸš¨ ATTENZIONE: Una delle versioni Ã¨ VUOTA! Non sovrascrivere dati pieni con dati vuoti!
                      </p>
                    )}
                    <p className="text-sm text-gray-700 mt-2">
                      <strong>ðŸ’¡ Suggerimento:</strong> Se non sei sicuro, esporta prima un backup JSON dal tab Esportazioni!
                    </p>
                  </div>
                </div>
              </div>

              <button
                onClick={() => {
                  setSyncConflicts(null);
                  setShowConflictModal(false);
                }}
                className="w-full px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
              >
                â† Annulla
              </button>
            </div>
          </div>
        )}
        
        <style>{`
          @keyframes confetti {
            0% {
              transform: translateY(0) rotate(0deg);
              opacity: 1;
            }
            100% {
              transform: translateY(100vh) rotate(720deg);
              opacity: 0;
            }
          }
          
          .animate-confetti {
            animation: confetti linear infinite;
          }
        `}</style>
        
        {/* ========== MODAL ESERCIZI RAPIDO (ROOT LEVEL) ========== */}
        {exerciseModalTraining && (() => {
          console.log('ðŸŽ¨ðŸŽ¨ðŸŽ¨ MODAL STA RENDERIZZANDO! Training ID:', exerciseModalTraining.id);
          console.log('ðŸŽ¨ exerciseModalTraining:', exerciseModalTraining);
          return (
          <div 
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              zIndex: 9999,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              backgroundColor: 'rgba(0, 0, 0, 0.5)'
            }}
            onClick={() => {
              console.log('ðŸšª Click overlay - chiudo modal');
              setExerciseModalTraining(null);
            }}
          >
            <div 
              className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden"
              style={{ position: 'relative', zIndex: 10000 }}
              onClick={(e) => {
                console.log('ðŸ›‘ Click modal content - non chiudo');
                e.stopPropagation();
              }}
            >
              {/* Header */}
              <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 flex justify-between items-center">
                <div>
                  <h3 className="text-xl font-bold">Esercizi Allenamento</h3>
                  <p className="text-sm text-blue-100 mt-1">
                    {new Date(exerciseModalTraining.data).toLocaleDateString('it-IT', { 
                      weekday: 'long', 
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric' 
                    })}
                  </p>
                </div>
                <button
                  onClick={() => setExerciseModalTraining(null)}
                  className="text-white hover:bg-blue-800 rounded-full p-2 transition-colors text-2xl font-bold"
                  title="Chiudi"
                >
                  âœ•
                </button>
              </div>
              
              {/* Body */}
              <div className="p-6 overflow-y-auto max-h-[calc(80vh-120px)]">
                {exerciseModalTraining.esercizi && exerciseModalTraining.esercizi.length > 0 ? (
                  <div className="space-y-4">
                    {/* Riepilogo totale */}
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
                      <div className="flex items-center justify-between">
                        <div>
                          <span className="text-3xl font-bold text-blue-700">
                            {exerciseModalTraining.esercizi.length}
                          </span>
                          <span className="text-gray-700 ml-2">esercizi totali</span>
                        </div>
                        <div>
                          <span className="text-3xl font-bold text-blue-700">
                            {calcolaTotaleMinuti(exerciseModalTraining.esercizi)}
                          </span>
                          <span className="text-gray-700 ml-2">minuti totali</span>
                        </div>
                      </div>
                    </div>
                    
                    {/* Lista esercizi */}
                    {exerciseModalTraining.esercizi.map((esercizio, idx) => (
                      <div 
                        key={idx}
                        className="bg-white border-2 border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                      >
                        <div className="flex items-start gap-3">
                          <div className="flex-shrink-0 w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-lg">
                            {idx + 1}
                          </div>
                          <div className="flex-1">
                            <div className="flex items-center gap-3 mb-2">
                              <h4 className="text-lg font-bold text-gray-800">
                                {esercizio.nome}
                              </h4>
                              <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
                                {esercizio.durata} min
                              </span>
                            </div>
                            {esercizio.descrizione && (
                              <p className="text-gray-600 text-sm whitespace-pre-wrap">
                                {esercizio.descrizione}
                              </p>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <p className="text-lg">Nessun esercizio registrato</p>
                  </div>
                )}
              </div>
              
              {/* Footer */}
              <div className="bg-gray-50 p-4 flex justify-between items-center border-t gap-3">
                <button
                  onClick={() => exportEserciziPDF(exerciseModalTraining)}
                  className="flex items-center gap-2 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                  </svg>
                  Esporta PDF
                </button>
                <button
                  onClick={() => setExerciseModalTraining(null)}
                  className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                >
                  Chiudi
                </button>
              </div>
            </div>
          </div>
          );
        })()}
        
        {/* ========== MODAL FOTO ALLENAMENTO ========== */}
        {photoModalTraining && (
          <div 
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[9999]"
            onClick={() => setPhotoModalTraining(null)}
          >
            <div 
              className="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden"
              onClick={(e) => e.stopPropagation()}
            >
              {/* Header */}
              <div className="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-4 flex justify-between items-center">
                <div>
                  <h3 className="text-xl font-bold">ðŸ“· Foto Allenamento</h3>
                  <p className="text-sm text-purple-100 mt-1">
                    {new Date(photoModalTraining.data).toLocaleDateString('it-IT', { 
                      weekday: 'long', 
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric' 
                    })}
                  </p>
                </div>
                <button
                  onClick={() => setPhotoModalTraining(null)}
                  className="text-white hover:bg-purple-800 rounded-full p-2 transition-colors text-2xl font-bold"
                  title="Chiudi"
                >
                  âœ•
                </button>
              </div>
              
              {/* Body */}
              <div className="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                {photoModalTraining.foto && photoModalTraining.foto.length > 0 ? (
                  <div>
                    {/* Counter */}
                    <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-6">
                      <div className="flex items-center justify-center gap-2">
                        <span className="text-3xl font-bold text-purple-700">
                          {photoModalTraining.foto.length}
                        </span>
                        <span className="text-gray-700 text-lg">
                          {photoModalTraining.foto.length === 1 ? 'foto caricata' : 'foto caricate'}
                        </span>
                      </div>
                    </div>
                    
                    {/* Griglia foto */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {photoModalTraining.foto.map((foto) => (
                        <div key={foto.id} className="relative group">
                          <img
                            src={foto.url || foto.data}
                            alt="Foto allenamento"
                            className="w-full h-64 object-cover rounded-lg shadow-lg cursor-pointer hover:opacity-90 transition-opacity"
                            onClick={() => setEnlargedPhoto(foto.url || foto.data)}
                          />
                          <div className="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white text-sm px-3 py-1 rounded">
                            {new Date(foto.timestamp).toLocaleDateString('it-IT', {
                              day: 'numeric',
                              month: 'short',
                              hour: '2-digit',
                              minute: '2-digit'
                            })}
                          </div>
                          {/* Bottoni azione - Sempre visibili su mobile, hover su desktop */}
                          <div className="absolute top-2 right-2 flex gap-2 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                            {userRole === 'admin' && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleRemoveTrainingPhoto(photoModalTraining.id, foto.id);
                                }}
                                className="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 shadow-lg"
                                title="Elimina foto"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                              </button>
                            )}
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setEnlargedPhoto(foto.url || foto.data);
                              }}
                              className="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 shadow-lg"
                              title="Ingrandisci"
                            >
                              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" />
                              </svg>
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <div className="text-6xl mb-3">ðŸ“·</div>
                    <p className="text-lg">Nessuna foto per questo allenamento</p>
                  </div>
                )}
              </div>
              
              {/* Footer */}
              <div className="bg-gray-50 p-4 flex justify-end items-center border-t">
                <button
                  onClick={() => setPhotoModalTraining(null)}
                  className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold"
                >
                  Chiudi
                </button>
              </div>
            </div>
          </div>
        )}
        
        {/* ========== MODAL FOTO PARTITA ========== */}
        {photoModalMatch && (
          <div 
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[9999]"
            onClick={() => setPhotoModalMatch(null)}
          >
            <div 
              className="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden"
              onClick={(e) => e.stopPropagation()}
            >
              {/* Header */}
              <div className="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-4 flex justify-between items-center">
                <div>
                  <h3 className="text-xl font-bold">ðŸ“· Foto Partita</h3>
                  <p className="text-sm text-purple-100 mt-1">
                    {photoModalMatch.squadraCasa && photoModalMatch.squadraTrasferta 
                      ? `${photoModalMatch.squadraCasa} vs ${photoModalMatch.squadraTrasferta}`
                      : new Date(photoModalMatch.data).toLocaleDateString('it-IT', { 
                          weekday: 'long', 
                          year: 'numeric', 
                          month: 'long', 
                          day: 'numeric' 
                        })
                    }
                  </p>
                </div>
                <button
                  onClick={() => setPhotoModalMatch(null)}
                  className="text-white hover:bg-purple-800 rounded-full p-2 transition-colors text-2xl font-bold"
                  title="Chiudi"
                >
                  âœ•
                </button>
              </div>
              
              {/* Body */}
              <div className="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                {photoModalMatch.foto && photoModalMatch.foto.length > 0 ? (
                  <div>
                    {/* Counter */}
                    <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-6">
                      <div className="flex items-center justify-center gap-2">
                        <span className="text-3xl font-bold text-purple-700">
                          {photoModalMatch.foto.length}
                        </span>
                        <span className="text-gray-700 text-lg">
                          {photoModalMatch.foto.length === 1 ? 'foto caricata' : 'foto caricate'}
                        </span>
                      </div>
                    </div>
                    
                    {/* Griglia foto */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {photoModalMatch.foto.map((foto) => (
                        <div key={foto.id} className="relative group">
                          <img
                            src={foto.url || foto.data}
                            alt="Foto partita"
                            className="w-full h-64 object-cover rounded-lg shadow-lg cursor-pointer hover:opacity-90 transition-opacity"
                            onClick={() => setEnlargedPhoto(foto.url || foto.data)}
                          />
                          <div className="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white text-sm px-3 py-1 rounded">
                            {new Date(foto.timestamp).toLocaleDateString('it-IT', {
                              day: 'numeric',
                              month: 'short',
                              hour: '2-digit',
                              minute: '2-digit'
                            })}
                          </div>
                          {/* Bottoni azione - Sempre visibili su mobile, hover su desktop */}
                          <div className="absolute top-2 right-2 flex gap-2 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                            {userRole === 'admin' && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleRemoveMatchPhoto(photoModalMatch.id, foto.id);
                                }}
                                className="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 shadow-lg"
                                title="Elimina foto"
                              >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                              </button>
                            )}
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setEnlargedPhoto(foto.url || foto.data);
                              }}
                              className="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 shadow-lg"
                              title="Ingrandisci"
                            >
                              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" />
                              </svg>
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <div className="text-6xl mb-3">ðŸ“·</div>
                    <p className="text-lg">Nessuna foto per questa partita</p>
                  </div>
                )}
              </div>
              
              {/* Footer */}
              <div className="bg-gray-50 p-4 flex justify-end items-center border-t">
                <button
                  onClick={() => setPhotoModalMatch(null)}
                  className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold"
                >
                  Chiudi
                </button>
              </div>
            </div>
          </div>
        )}
        
        {/* ========== TOAST NOTIFICATIONS ========== */}
        <div className="toast-container">
          {toasts.map(toast => (
            <div
              key={toast.id}
              className={`toast toast-${toast.type} ${toast.exiting ? 'toast-exit' : ''}`}
            >
              <div className="text-2xl">
                {toast.type === 'success' && 'âœ…'}
                {toast.type === 'error' && 'âŒ'}
                {toast.type === 'warning' && 'âš ï¸'}
                {toast.type === 'info' && 'â„¹ï¸'}
              </div>
              <div className="flex-1">
                <div className="font-semibold text-gray-800">{toast.message}</div>
              </div>
              <button
                onClick={() => setToasts(prev => prev.filter(t => t.id !== toast.id))}
                className="text-gray-400 hover:text-gray-600 text-xl font-bold"
              >
                Ã—
              </button>
            </div>
          ))}
        </div>

        {/* ========== LOADING OVERLAY MIGLIORATO ========== */}
        {showLoading && (
          <div className="loading-overlay">
            <div className="loading-content">
              <div className="text-6xl mb-4 animate-pulse">âš½</div>
              <div className="text-xl font-bold text-gray-800 mb-2">{loadingMessage}</div>
              {loadingProgress > 0 && (
                <>
                  <div className="progress-bar">
                    <div 
                      className="progress-bar-fill"
                      style={{ width: `${loadingProgress}%` }}
                    ></div>
                  </div>
                  <div className="text-sm text-gray-600 mt-2">{loadingProgress}%</div>
                </>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<SoccerTeamTracker />);

// ðŸ”´ INIZIO SCRIPT PRELOADER - PER RIMUOVERLO CANCELLA DA QUI...
// Nascondi preloader quando React Ã¨ montato
setTimeout(() => {
  const preloader = document.getElementById('preloader');
  if (preloader) {
    preloader.classList.add('fade-out');
    setTimeout(() => {
      preloader.style.display = 'none';
      // Reset background body (torna trasparente quando app Ã¨ caricata)
      document.body.style.background = '';
    }, 500);
  }
}, 100);
// ðŸ”´ ...FINO A QUI
  </script>
  
  <script>
    // ========== FIX RIDIMENSIONAMENTO ORIENTAMENTO MOBILE ==========
    if (window.matchMedia("(max-width: 640px)").matches) {
      let resizeTimeout;
      
      // Gestione cambio orientamento
      window.addEventListener('orientationchange', function() {
        // Forza ridimensionamento dopo cambio orientamento
        setTimeout(function() {
          // Forza reflow
          document.body.style.height = window.innerHeight + 'px';
          setTimeout(function() {
            document.body.style.height = '';
          }, 100);
        }, 100);
      });
      
      // Gestione resize window per zoom corretto
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          // Aggiusta viewport se necessario
          const viewport = document.querySelector('meta[name=viewport]');
          if (viewport) {
            viewport.setAttribute('content', 
              'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes'
            );
          }
        }, 250);
      });
      
      // Fix iniziale
      window.addEventListener('load', function() {
        setTimeout(function() {
          window.scrollTo(0, 0);
        }, 100);
      });
    }
  </script>
</body>
</html>
