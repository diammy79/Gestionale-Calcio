<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>‚öΩ Moreschi Gestionale Calcio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: system-ui, -apple-system, sans-serif;
      scroll-behavior: smooth;
    }
    
    /* ========== ANIMAZIONI E TRANSIZIONI ========== */
    
    /* Fade in generale */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Slide in da sinistra */
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* Slide in da destra */
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* Scale up */
    @keyframes scaleUp {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    /* Pulse */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Shake */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    /* Applicazione animazioni */
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    .animate-slide-in-left {
      animation: slideInLeft 0.5s ease-out;
    }
    
    .animate-slide-in-right {
      animation: slideInRight 0.5s ease-out;
    }
    
    .animate-scale-up {
      animation: scaleUp 0.3s ease-out;
    }
    
    .animate-pulse-slow {
      animation: pulse 2s ease-in-out infinite;
    }
    
    .animate-shake {
      animation: shake 0.5s ease-in-out;
    }
    
    /* ========== TRANSIZIONI SMOOTH ========== */
    
    * {
      transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
      transition-duration: 200ms;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    button, a, input, select, textarea {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* ========== HOVER EFFECTS MIGLIORATI ========== */
    
    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    button:not(:disabled):active {
      transform: translateY(0);
    }
    
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* ========== LOADING STATES ========== */
    
    /* Skeleton loader */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }
    
    /* Spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-left-color: #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    /* ========== RESPONSIVE MOBILE ========== */
    
    /* Miglioramenti touch */
    @media (hover: none) and (pointer: coarse) {
      button, a, input, select {
        min-height: 44px; /* Apple guidelines */
        min-width: 44px;
      }
      
      /* Disabilita hover su touch */
      button:hover {
        transform: none;
      }
    }
    
    /* Tablet e mobile */
    @media (max-width: 768px) {
      /* Font pi√π grandi su mobile */
      body {
        font-size: 16px;
      }
      
      /* Padding ridotto */
      .mobile-compact {
        padding: 0.5rem !important;
      }
      
      /* Nascondi testo su mobile, mostra solo icone */
      .hide-text-mobile span {
        display: none;
      }
      
      /* Tab scrollabile */
      .tab-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin; /* Mostra scrollbar sottile su Firefox */
        scrollbar-color: #cbd5e0 transparent; /* Colore scrollbar */
      }
      
      .tab-container::-webkit-scrollbar {
        height: 4px; /* Scrollbar sottile su Chrome/Safari */
      }
      
      .tab-container::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .tab-container::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 2px;
      }
      
      .tab-container::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
      }
      
      /* Su mobile nascondi completamente lo scrollbar */
      @media (max-width: 768px) {
        .tab-container {
          scrollbar-width: none;
        }
        
        .tab-container::-webkit-scrollbar {
          display: none;
        }
      }
    }
    
    /* Solo mobile piccolo */
    @media (max-width: 480px) {
      /* Stack su mobile */
      .mobile-stack {
        flex-direction: column !important;
      }
      
      /* Full width su mobile */
      .mobile-full {
        width: 100% !important;
      }
    }
    
    /* ========== MIGLIORAMENTI SCROLL ========== */
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* ========== FOCUS STATES ========== */
    
    button:focus, input:focus, select:focus, textarea:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }
    
    /* ========== GLASSMORPHISM (opzionale) ========== */
    
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* ========== GRADIENT TEXT ========== */
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* ========== BADGE PULSE ========== */
    
    @keyframes badge-pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.1);
      }
    }
    
    .badge-animated {
      animation: badge-pulse 2s ease-in-out infinite;
    }
    
    /* ========== CARD IMPROVEMENTS ========== */
    
    .card-modern {
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .card-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
    }
    
    /* ========== RIPPLE EFFECT ========== */
    
    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
    
    .ripple {
      position: relative;
      overflow: hidden;
    }
    
    .ripple::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transform: scale(0);
      opacity: 0;
    }
    
    .ripple:active::after {
      animation: ripple 0.6s ease-out;
    }
    
    /* ========== PRINT STYLES ========== */
    
    @media print {
      button, .no-print {
        display: none !important;
      }
    }
    
    /* ========== TOAST NOTIFICATIONS ========== */
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    
    .toast {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: start;
      gap: 12px;
      animation: slideInRight 0.3s ease-out;
      min-width: 300px;
    }
    
    .toast.toast-success {
      border-left: 4px solid #10b981;
    }
    
    .toast.toast-error {
      border-left: 4px solid #ef4444;
    }
    
    .toast.toast-warning {
      border-left: 4px solid #f59e0b;
    }
    
    .toast.toast-info {
      border-left: 4px solid #3b82f6;
    }
    
    .toast.toast-exit {
      animation: slideOutRight 0.3s ease-in;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    
    /* ========== PULSE VELOCE PER CONVOCATI ========== */
    
    @keyframes pulse-fast {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    .animate-pulse-fast {
      animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* ========== LOADING SPINNER ENHANCED ========== */
    
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-center;
      z-index: 9998;
      backdrop-filter: blur(4px);
    }
    
    .loading-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: scaleUp 0.3s ease-out;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 16px;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    /* ========== DRAG & DROP STYLES ========== */
    
    .draggable {
      cursor: move;
      transition: all 0.2s ease;
    }
    
    .draggable:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .draggable.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .drop-zone {
      min-height: 60px;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .drop-zone.drag-over {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    /* ========== CALENDAR STYLES ========== */
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    
    @media (min-width: 640px) {
      .calendar-grid {
        gap: 4px;
      }
    }
    
    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 2px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    
    @media (min-width: 640px) {
      .calendar-day {
        border-radius: 8px;
        padding: 4px;
        font-size: 14px;
      }
    }
    
    .calendar-day:hover {
      background: #f3f4f6;
      border-color: #3b82f6;
    }
    
    .calendar-day.today {
      background: #dbeafe;
      border-color: #3b82f6;
      font-weight: bold;
    }
    
    /* Allenamenti - Azzurro */
    .calendar-day.has-training {
      background: #dbeafe;
      border-color: #60a5fa;
    }
    
    .calendar-day.has-training::after {
      content: 'üèÉ';
      position: absolute;
      bottom: 1px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      line-height: 1;
    }
    
    @media (min-width: 640px) {
      .calendar-day.has-training::after {
        bottom: 2px;
        font-size: 14px;
      }
    }
    
    /* Partite - Verde */
    .calendar-day.has-match {
      background: #d1fae5;
      border-color: #34d399;
    }
    
    .calendar-day.has-match::after {
      content: '‚öΩ';
      position: absolute;
      bottom: 1px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      line-height: 1;
    }
    
    @media (min-width: 640px) {
      .calendar-day.has-match::after {
        bottom: 2px;
        font-size: 14px;
      }
    }
    
    /* Entrambi - Combinato */
    .calendar-day.has-both {
      background: linear-gradient(135deg, #dbeafe 50%, #d1fae5 50%);
      border-color: #60a5fa;
    }
    
    .calendar-day.has-both::after {
      content: 'üèÉ‚öΩ';
      position: absolute;
      bottom: 1px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      line-height: 1;
      letter-spacing: -2px;
    }
    
    @media (min-width: 640px) {
      .calendar-day.has-both::after {
        bottom: 2px;
        font-size: 12px;
      }
    }
    
    /* Rimuovo vecchio stile has-event */
    
    /* ========== INJURY STATUS BADGES ========== */
    
    .injury-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .injury-badge.active {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .injury-badge.recovering {
      background: #fef3c7;
      color: #92400e;
    }
    
    .injury-badge.recovered {
      background: #d1fae5;
      color: #065f46;
    }

    /* ========== OTTIMIZZAZIONI MOBILE - MIGLIORE LEGGIBILIT√Ä ========== */
    /* ========== OTTIMIZZAZIONE SMARTPHONE (max-width: 640px) ========== */
    @media (max-width: 640px) {
      /* ===== TITOLI E TESTI - RIDOTTI PER EVITARE OVERFLOW ===== */
      
      /* Titolo principale app - ridotto */
      h1, .text-3xl {
        font-size: 1.25rem !important; /* Ridotto da 1.875rem */
        line-height: 1.3 !important;
        word-break: break-word !important;
      }
      
      /* Titoli sezioni - ridotti */
      h2, .text-2xl {
        font-size: 1.125rem !important; /* Ridotto da 1.5rem */
        line-height: 1.3 !important;
        word-break: break-word !important;
      }
      
      /* Sottotitoli - ridotti */
      h3, .text-xl {
        font-size: 1rem !important; /* Ridotto da 1.25rem */
        line-height: 1.3 !important;
      }
      
      /* Testi grandi - ridotti */
      .text-lg {
        font-size: 0.95rem !important;
      }
      
      /* Testi normali - mantieni leggibili */
      .text-base, p {
        font-size: 0.875rem !important;
        line-height: 1.4 !important;
      }
      
      /* Testi piccoli - leggibili */
      .text-sm {
        font-size: 0.8125rem !important;
      }
      
      .text-xs {
        font-size: 0.75rem !important;
      }
      
      /* ===== NUMERI STATS - RIDOTTI ===== */
      .text-4xl {
        font-size: 1.75rem !important; /* Ridotto da 2.25rem */
      }
      
      .text-5xl {
        font-size: 2rem !important; /* Ridotto da 3rem */
      }
      
      .text-6xl {
        font-size: 2.25rem !important;
      }
      
      /* ===== HEADER E NAVIGATION - COMPATTO ===== */
      
      /* Header principale - ridotto padding */
      .bg-white.rounded-lg.shadow-xl:first-of-type {
        padding: 0.5rem !important;
      }
      
      /* Tab navigation - compatta */
      .tab-container button {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.8125rem !important;
        min-height: 40px !important;
        white-space: nowrap !important;
      }
      
      /* Badge ruolo - compatto */
      .bg-yellow-400, .bg-blue-200 {
        padding: 0.375rem 0.625rem !important;
        font-size: 0.75rem !important;
      }
      
      /* ===== BOTTONI - TOUCH FRIENDLY ===== */
      button, .btn, a.btn {
        min-height: 44px !important; /* Minimo Apple HIG */
        padding: 0.625rem 0.875rem !important;
        font-size: 0.875rem !important;
      }
      
      /* Bottoni piccoli (icone) */
      button.px-2, button.px-3 {
        padding: 0.5rem !important;
        min-width: 44px !important;
      }
      
      /* ===== CARDS E CONTAINER - SPAZIATURE RIDOTTE ===== */
      .card-modern, .bg-white.rounded-lg {
        padding: 0.75rem !important;
      }
      
      .p-4 {
        padding: 0.75rem !important;
      }
      
      .p-6 {
        padding: 1rem !important;
      }
      
      .px-4 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      .py-3, .py-4 {
        padding-top: 0.625rem !important;
        padding-bottom: 0.625rem !important;
      }
      
      /* ===== MARGINI - RIDOTTI ===== */
      .mb-2 {
        margin-bottom: 0.375rem !important;
      }
      
      .mb-3, .mb-4 {
        margin-bottom: 0.625rem !important;
      }
      
      .mb-6 {
        margin-bottom: 1rem !important;
      }
      
      /* ===== GAP - RIDOTTI ===== */
      .gap-2 {
        gap: 0.375rem !important;
      }
      
      .gap-3, .gap-4 {
        gap: 0.5rem !important;
      }
      
      /* ===== FORM ELEMENTS - COMPATTI ===== */
      input, select, textarea {
        min-height: 42px !important;
        padding: 0.5rem 0.625rem !important;
        font-size: 0.875rem !important;
      }
      
      label {
        font-size: 0.8125rem !important;
        margin-bottom: 0.25rem !important;
      }
      
      /* ===== TABELLE - RESPONSIVE ===== */
      table {
        font-size: 0.8125rem !important;
      }
      
      th, td {
        padding: 0.5rem 0.375rem !important;
      }
      
      /* ===== MODAL - OTTIMIZZATI ===== */
      .modal-content, .bg-white.rounded-lg.shadow-2xl {
        padding: 1rem !important;
        max-height: 85vh !important;
        overflow-y: auto !important;
      }
      
      /* Titoli modal - ridotti */
      .modal-content h3, .bg-white.rounded-lg.shadow-2xl h3 {
        font-size: 1.125rem !important;
      }
      
      /* ===== GESTIONE OVERFLOW - ANTI-SOVRAPPOSIZIONE ===== */
      
      /* Impedisci overflow orizzontale */
      * {
        max-width: 100%;
        box-sizing: border-box;
      }
      
      /* Titoli lunghi - ellipsis o wrap */
      h1, h2, h3, .font-bold {
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
        hyphens: auto !important;
      }
      
      /* Container principale */
      .min-h-screen {
        padding: 0.5rem !important;
      }
      
      /* ===== GRID LAYOUT - OTTIMIZZATO ===== */
      
      /* Grid stats - singola colonna su mobile molto piccolo */
      .grid.grid-cols-2 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.5rem !important;
      }
      
      .grid.grid-cols-3 {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .grid.grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      /* ===== STATISTICHE CARDS - COMPATTE ===== */
      .bg-gradient-to-br {
        padding: 0.75rem !important;
      }
      
      /* Numeri grandi stats - ridotti */
      .bg-gradient-to-br .text-3xl {
        font-size: 1.5rem !important;
      }
      
      /* ===== BADGE E PILLS - COMPATTI ===== */
      .badge-animated, .rounded-full {
        font-size: 0.75rem !important;
        padding: 0.25rem 0.5rem !important;
      }
      
      /* ===== LOGO - RIDOTTO ===== */
      img[alt*="Logo"], .w-16, .h-16 {
        width: 2.5rem !important;
        height: 2.5rem !important;
        min-width: 2.5rem !important;
        min-height: 2.5rem !important;
      }
      
      /* ===== ICONE - PROPORZIONATE ===== */
      svg, .lucide {
        width: 1.125rem !important;
        height: 1.125rem !important;
      }
      
      /* ===== TOAST - COMPATTI ===== */
      .toast {
        font-size: 0.875rem !important;
        padding: 0.75rem 1rem !important;
        min-width: 85% !important;
      }
      
      /* ===== LISTA GIOCATORI - COMPATTA ===== */
      .space-y-2 > * {
        margin-top: 0.375rem !important;
      }
      
      .space-y-3 > * {
        margin-top: 0.5rem !important;
      }
      
      /* ===== FORMAZIONE CAMPO - LEGGIBILE ===== */
      .field-position {
        font-size: 0.7rem !important;
        padding: 0.375rem !important;
      }
      
      /* ===== CHECKBOX E RADIO - TOUCH FRIENDLY ===== */
      input[type="checkbox"], input[type="radio"] {
        width: 20px !important;
        height: 20px !important;
      }
      
      /* ===== SCROLL ORIZZONTALE - SMOOTH ===== */
      .overflow-x-auto {
        -webkit-overflow-scrolling: touch !important;
        scroll-behavior: smooth !important;
      }
      
      /* ===== FLEX LAYOUTS - ANTI-OVERFLOW ===== */
      .flex {
        flex-wrap: wrap !important;
      }
      
      .flex.gap-2 {
        gap: 0.375rem !important;
      }
      
      /* ===== BANNER INFORMATIVI - COMPATTI ===== */
      .bg-yellow-50, .bg-blue-50, .bg-green-50 {
        padding: 0.625rem !important;
        font-size: 0.8125rem !important;
      }
      
      /* ===== DIVIDERS - VISIBILI MA SOTTILI ===== */
      hr, .border-b, .border-t {
        border-width: 1px !important;
      }
    }
    
    /* ========== OTTIMIZZAZIONE SMARTPHONE PORTRAIT (max-width: 480px) ========== */
    @media (max-width: 480px) {
      /* Ulteriore riduzione per schermi molto piccoli */
      
      h1, .text-3xl {
        font-size: 1.125rem !important;
      }
      
      .tab-container button {
        padding: 0.5rem 0.625rem !important;
        font-size: 0.75rem !important;
      }
      
      .grid.grid-cols-2 {
        grid-template-columns: 1fr !important;
      }
      
      /* Bottoni fullwidth su schermi molto piccoli */
      .flex.gap-2 > button {
        flex: 1 1 100% !important;
      }
    }
    
    /* ========== OTTIMIZZAZIONE SMARTPHONE (max-width: 640px) ========== */
    @media (max-width: 640px) {
      /* Riduzione dimensioni titoli per evitare overflow */
      h1, .text-3xl {
        font-size: 1.5rem !important; /* Da 3xl a xl */
        line-height: 2rem !important;
      }
      
      h2, .text-2xl {
        font-size: 1.25rem !important; /* Da 2xl a lg */
        line-height: 1.75rem !important;
      }
      
      h3, .text-xl {
        font-size: 1.125rem !important; /* Da xl a lg */
        line-height: 1.75rem !important;
      }
      
      /* Riduzione padding generale per guadagnare spazio */
      .p-4 {
        padding: 0.75rem !important;
      }
      
      .p-6 {
        padding: 1rem !important;
      }
      
      .px-4 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      .px-6 {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
      }
      
      .py-4 {
        padding-top: 0.75rem !important;
        padding-bottom: 0.75rem !important;
      }
      
      .py-6 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
      }
      
      /* Header compatto */
      .mobile-header h1 {
        font-size: 1.25rem !important;
        line-height: 1.5rem !important;
      }
      
      /* Tab navbar: testo pi√π piccolo e compatto */
      .tab-container button {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
        font-size: 0.75rem !important;
        white-space: nowrap;
      }
      
      /* Card statistiche: numeri e testi pi√π compatti */
      .text-4xl {
        font-size: 1.875rem !important; /* Da 4xl a 2xl */
      }
      
      .text-5xl {
        font-size: 2.25rem !important; /* Da 5xl a 3xl */
      }
      
      /* Badge e bottoni pi√π compatti */
      button {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.875rem !important;
      }
      
      button.text-xs {
        padding: 0.375rem 0.5rem !important;
        font-size: 0.75rem !important;
      }
      
      /* Modal: massimizza spazio disponibile */
      .modal-content {
        max-width: 100% !important;
        margin: 0.5rem !important;
        max-height: calc(100vh - 1rem) !important;
      }
      
      /* Tabelle: scroll orizzontale fluido */
      table {
        font-size: 0.8rem !important;
      }
      
      table th, table td {
        padding: 0.5rem !important;
      }
      
      /* Input e select pi√π grandi per touch */
      input:not([type="checkbox"]):not([type="radio"]),
      select,
      textarea {
        font-size: 16px !important; /* Evita zoom automatico iOS */
        padding: 0.625rem !important;
      }
      
      /* Checkbox e radio pi√π grandi per touch */
      input[type="checkbox"],
      input[type="radio"] {
        width: 20px !important;
        height: 20px !important;
        margin: 0.25rem !important;
      }
      
      /* Icone dimensionate correttamente */
      svg {
        flex-shrink: 0;
      }
      
      /* Gap ridotti per evitare sprechi di spazio */
      .gap-4 {
        gap: 0.75rem !important;
      }
      
      .gap-6 {
        gap: 1rem !important;
      }
      
      /* Grid pi√π compatto */
      .grid {
        gap: 0.75rem !important;
      }
      
      /* Evita overflow di testo lungo */
      .break-words {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
      }
      
      /* Container full-width su mobile */
      .container {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      /* Toast pi√π compatto */
      .toast {
        min-width: auto !important;
        width: calc(100vw - 2rem) !important;
      }
      
      .toast-container {
        right: 1rem !important;
        left: 1rem !important;
        top: 1rem !important;
      }
      
      /* Badge ruolo pi√π compatto */
      .badge-ruolo {
        font-size: 0.7rem !important;
        padding: 0.25rem 0.5rem !important;
      }
      
      /* Nascondo testo ridondante su mobile */
      .mobile-hide-text {
        display: none !important;
      }
      
      /* Logo squadra pi√π piccolo */
      img[alt*="Logo"] {
        max-width: 48px !important;
        max-height: 48px !important;
      }
      
      /* Pulsanti floating pi√π accessibili */
      .fixed {
        bottom: 1rem !important;
        right: 1rem !important;
      }
      
      /* Prevenzione overflow generale */
      * {
        max-width: 100%;
      }
      
      /* Migliora rendering orientamento */
      @supports (-webkit-touch-callout: none) {
        /* iOS Safari specifico */
        body {
          -webkit-text-size-adjust: 100%;
        }
      }
    }
    
    /* ========== GESTIONE TESTO TAB PORTRAIT/LANDSCAPE ========== */
    
    /* Portrait mobile: mostra testo completo, nascondi solo icone */
    @media (max-width: 640px) and (orientation: portrait) {
      .tab-text-portrait {
        display: inline !important;
        font-size: 0.75rem !important;
      }
      
      .tab-icon-only {
        display: none !important;
      }
      
      /* Tab navbar: aumenta padding per testo */
      .tab-container button {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
    }
    
    /* Landscape mobile: nascondi testo, mostra solo icone */
    @media (max-width: 640px) and (orientation: landscape) {
      .tab-text-portrait {
        display: none !important;
      }
      
      .tab-icon-only {
        display: inline !important;
      }
      
      /* Tab navbar: padding ridotto per solo icone */
      .tab-container button {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
      }
    }
    
    /* ========== CLASSIFICA RESPONSIVE MOBILE ========== */
    
    /* Mobile Portrait: Nascondi G, GF, GS, DR - Mostra solo V, P, S */
    @media (max-width: 640px) and (orientation: portrait) {
      .classifica-col-giocate,
      .classifica-col-gol {
        display: none !important;
      }
      
      .classifica-col-risultati {
        display: table-cell !important;
      }
    }
    
    /* Mobile Landscape: Nascondi G - Mostra V, P, S, GF, GS, DR */
    @media (max-width: 640px) and (orientation: landscape) {
      .classifica-col-giocate {
        display: none !important;
      }
      
      .classifica-col-risultati,
      .classifica-col-gol {
        display: table-cell !important;
      }
    }
    
    /* ========== STATISTICHE GIOCATORI LANDSCAPE MOBILE ========== */
    
    /* Landscape mobile: titolo e container ottimizzati */
    @media (max-width: 640px) and (orientation: landscape) {
      .stats-container-mobile {
        height: calc(100vh - 120px) !important; /* Riduce spazio header */
      }
      
      .stats-title-mobile {
        font-size: 1rem !important;
        margin-bottom: 0.5rem !important;
        padding: 0.25rem 0 !important;
        line-height: 1.25rem !important;
      }
      
      /* Card statistiche pi√π compatte */
      .stats-container-mobile .bg-white.rounded-lg {
        padding: 0.75rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      /* Grid pi√π compatto */
      .stats-container-mobile .grid {
        gap: 0.5rem !important;
      }
      
      /* Font pi√π piccoli nelle card */
      .stats-container-mobile .text-xs {
        font-size: 0.7rem !important;
      }
      
      .stats-container-mobile .text-2xl {
        font-size: 1.25rem !important;
      }
    }
    
    /* ========== GESTIONE ROSA PORTRAIT MOBILE ========== */
    @media (max-width: 640px) and (orientation: portrait) {
      /* Layout verticale: foto sopra, info sotto */
      .roster-player-card > .flex {
        flex-direction: column !important;
        align-items: center !important;
        gap: 1rem !important;
      }
      
      /* Quick Stats: da 5 colonne a 3 per evitare sovrapposizioni */
      .roster-quick-stats {
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
        gap: 0.5rem !important;
      }
      
      /* Numeri statistiche pi√π compatti */
      .roster-quick-stats .text-2xl {
        font-size: 1.25rem !important;
      }
      
      /* Testo etichette pi√π piccolo */
      .roster-quick-stats .text-xs {
        font-size: 0.65rem !important;
        line-height: 1rem !important;
      }
      
      /* Foto giocatore centrata */
      .roster-player-photo {
        width: 80px !important;
        height: 80px !important;
      }
      
      /* Padding card pi√π compatto */
      .roster-player-card {
        padding: 1rem !important;
      }
      
      /* Container info: full width */
      .roster-player-card .flex-1 {
        width: 100% !important;
      }
      
      /* Grid info giocatore: 2 colonne simmetriche */
      .roster-player-info {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 0.75rem !important;
        width: 100% !important;
      }
      
      /* Campi che devono occupare 2 colonne */
      .roster-player-info > div.md\:col-span-2,
      .roster-player-info > div.md\:col-span-3,
      .roster-player-info > div.lg\:col-span-3 {
        grid-column: span 2 / span 2 !important;
      }
      
      /* Numero giocatore leggibile */
      .roster-player-number {
        font-size: 1.5rem !important;
      }
      
      /* Labels pi√π visibili */
      .roster-player-info label {
        font-size: 0.7rem !important;
        margin-bottom: 0.25rem !important;
        display: block !important;
      }
      
      /* Valori info pi√π grandi */
      .roster-player-info > div > div:not(label):not(input):not(select) {
        font-size: 0.875rem !important;
        line-height: 1.25rem !important;
      }
    }
    
    /* ========== FIX RIDIMENSIONAMENTO ORIENTAMENTO MOBILE ========== */
    @media (max-width: 640px) and (orientation: landscape) {
      /* Landscape: massimizza spazio verticale */
      .mobile-header {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
      }
      
      h1, .text-3xl {
        font-size: 1.25rem !important;
      }
      
      .tab-container button {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
      }
    }
  </style>
  <meta name="theme-color" content="#1a56db">
  <meta name="description" content="Moreschi Gestionale Calcio - Gestione Squadra Completa">
  <link rel="manifest" href="manifest.json">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useMemo } = React;

// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyBKMsg16kzFnY529eR03DUjGoOO-XZonZc",
  authDomain: "gestionale-calcio-59318.firebaseapp.com",
  projectId: "gestionale-calcio-59318",
  storageBucket: "gestionale-calcio-59318.firebasestorage.app",
  messagingSenderId: "573513891203",
  appId: "1:573513891203:web:a7ae4934de0913b6120ab6"
};

let firebaseApp, auth, db, storage;
try {
  firebaseApp = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  storage = firebase.storage();
  db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
    console.log('Persistenza:', err.code);
  });
} catch (error) {
  console.error('Errore inizializzazione Firebase:', error);
}

// ============================================
// COMPONENTE LOGIN
// ============================================
const LoginScreen = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
      setError('Email o password non validi');
      console.error('Errore login:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-600 via-blue-700 to-blue-900 flex items-center justify-center p-4">
      <div className="max-w-md w-full">
        <div className="text-center mb-8">
          <div className="text-7xl mb-4 animate-bounce">‚öΩ</div>
          <h1 className="text-5xl font-black text-white mb-2" style={{textShadow: '3px 3px 6px rgba(0,0,0,0.4)'}}>
            Moreschi Gestionale Calcio
          </h1>
          <p className="text-blue-200 text-lg">Gestione Squadra Completa</p>
        </div>

        <div className="bg-white rounded-2xl shadow-2xl p-8">
          <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Accedi</h2>
          
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                placeholder="example@domain.com"
                required
                disabled={loading}
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
                disabled={loading}
              />
            </div>

            {error && (
              <div className="bg-red-50 border-2 border-red-300 text-red-700 px-4 py-3 rounded-lg text-sm">
                {error}
              </div>
            )}

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
              {loading ? 'Accesso in corso...' : 'Accedi'}
            </button>
          </form>

        </div>

        <div className="text-center mt-6">
          <p className="text-blue-200 text-sm">
            Moreschi Gestionale Calcio ¬© 2025 - Mister Roberto
          </p>
        </div>
      </div>
    </div>
  );
};

const LogOut = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
    <polyline points="16 17 21 12 16 7"/>
    <line x1="21" y1="12" x2="9" y2="12"/>
  </svg>
);



// Definizione icone SVG
const Download = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
    <polyline points="7 10 12 15 17 10"/>
    <line x1="12" y1="15" x2="12" y2="3"/>
  </svg>
);

const Plus = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <line x1="12" y1="5" x2="12" y2="19"/>
    <line x1="5" y1="12" x2="19" y2="12"/>
  </svg>
);

const Trash2 = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <polyline points="3 6 5 6 21 6"/>
    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
    <line x1="10" y1="11" x2="10" y2="17"/>
    <line x1="14" y1="11" x2="14" y2="17"/>
  </svg>
);

const Save = (props) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
    <polyline points="17 21 17 13 7 13 7 21"/>
    <polyline points="7 3 7 8 15 8"/>
  </svg>
);


// IndexedDB wrapper per salvataggio automatico affidabile
const DB_NAME = 'RealDORDatabase';
const DB_VERSION = 1;
const STORE_NAME = 'teamData';

const initDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME);
      }
    };
  });
};

const saveToIndexedDB = async (key, data) => {
  try {
    const db = await initDB();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    store.put(data, key);
    return new Promise((resolve, reject) => {
      transaction.oncomplete = () => resolve(true);
      transaction.onerror = () => reject(transaction.error);
    });
  } catch (error) {
    console.error('Errore salvataggio IndexedDB:', error);
    return false;
  }
};

const loadFromIndexedDB = async (key) => {
  try {
    const db = await initDB();
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(key);
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (error) {
    console.error('Errore caricamento IndexedDB:', error);
    return null;
  }
};

const SoccerTeamTracker = () => {
    // Stati autenticazione
  const [user, setUser] = useState(null);
  const [teamId, setTeamId] = useState(null); // Team ID condiviso tra ADMIN e USER
  const [userRole, setUserRole] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);

  const [isLoading, setIsLoading] = useState(true);
  const [lastSaved, setLastSaved] = useState(null);
  const [recoveryMinutes, setRecoveryMinutes] = useState('');
  const [players, setPlayers] = useState([
    { numero: 1, nome: "Frassine Lorenzo", ruolo: "Portiere", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 2, nome: "Boudene Anis", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 3, nome: "Adu Gyamfi Kyei Ofori", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 4, nome: "Scotti Filippo", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 5, nome: "Zucca Diego", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 6, nome: "Esposito Riccardo", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 7, nome: "Eddikh Aslam", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 8, nome: "Tinubu Ryan Olufemi", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 9, nome: "Medeghini Nicolas", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 10, nome: "Paloschi Riccardo", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 11, nome: "Ekoma Prince Aseosa", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 12, nome: "Venturelli Nicola", ruolo: "Portiere", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 13, nome: "Gabusi Francesco", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 14, nome: "Leone", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 15, nome: "Pupino Lorenzo", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 16, nome: "Testaverde Simone", ruolo: "Difensore centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 17, nome: "Ayari Youssef", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 18, nome: "Bevilacqua Matteo", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 19, nome: "Bentalha Omar Elfarouk", ruolo: "Centrocampista centrale", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 20, nome: "Hepaj Aron", ruolo: "Attaccante", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "2025-08-01" },
    { numero: 21, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 22, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 23, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 24, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 25, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 26, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 27, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 28, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 29, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" },
    { numero: 30, nome: "", ruolo: "", dataNascita: "", telefono: "", foto: "", piede: "", dataCreazione: "" }
  ]);

  const [trainings, setTrainings] = useState([]);
  const [matches, setMatches] = useState([]);
  const [activeTab, setActiveTab] = useState('dashboard'); // Apre sulla dashboard
  const [exerciseModalTraining, setExerciseModalTraining] = useState(null); // Modal esercizi rapido
  
  // Reset modal esercizi quando cambio tab
  useEffect(() => {
    console.log('üîÑ activeTab changed to:', activeTab);
    setExerciseModalTraining(null);
  }, [activeTab]);
  
  // Log quando exerciseModalTraining cambia
  useEffect(() => {
    console.log('üìä exerciseModalTraining changed:', exerciseModalTraining);
    if (exerciseModalTraining) {
      console.log('‚úÖ Modal dovrebbe essere visibile!');
      console.log('üìã Training data:', exerciseModalTraining.data);
      console.log('üìã Esercizi count:', exerciseModalTraining.esercizi?.length);
      console.log('üé® activeTab corrente:', activeTab);
      console.log('üîç exerciseModalTraining object completo:', JSON.stringify(exerciseModalTraining, null, 2));
    } else {
      console.log('‚ùå Modal chiuso');
    }
  }, [exerciseModalTraining]);
  
  const [editingPlayer, setEditingPlayer] = useState(null);
  const [showInstructionsModal, setShowInstructionsModal] = useState(false);
  const [showResultsModal, setShowResultsModal] = useState(false);  // ‚úÖ Modal elenco risultati
  const [showExitModal, setShowExitModal] = useState(false);  // ‚úÖ Modal chiusura app
  const [expandedTrainings, setExpandedTrainings] = useState({});
  const [trainingTabActive, setTrainingTabActive] = useState({}); // 'presenze' o 'esercizi' per ogni training
  const [newEsercizio, setNewEsercizio] = useState({}); // Form nuovo esercizio per ogni training
  const [editingEsercizio, setEditingEsercizio] = useState(null); // {trainingId, esercizioId}
  const [expandedMatches, setExpandedMatches] = useState({});
  const [matchTimer, setMatchTimer] = useState(0);
  const [isTimerRunning, setIsTimerRunning] = useState(false);
  const [timerInterval, setTimerInterval] = useState(null);
  const [liveMatchMode, setLiveMatchMode] = useState(null);
  const [substitutionMode, setSubstitutionMode] = useState(null);
  const [recoveryTime, setRecoveryTime] = useState(0);
  const [isRecoveryRunning, setIsRecoveryRunning] = useState(false);
  const [recoveryInterval, setRecoveryInterval] = useState(null);
  const [showModuloModal, setShowModuloModal] = useState(null);
  const [moduloTattico, setModuloTattico] = useState({});
  const [playerSelectionModal, setPlayerSelectionModal] = useState(null);
  const [dragState, setDragState] = useState(null); // Per tracciare drag offset
  const [matchEnded, setMatchEnded] = useState(false);
  const [appTitle, setAppTitle] = useState('Moreschi Roberto - Gestione squadra Real DOR Under 18');
  const [isEditingTitle, setIsEditingTitle] = useState(false);
  const [enlargedPhoto, setEnlargedPhoto] = useState(null);
  const [halfTime, setHalfTime] = useState(1);
  const [showVictoryCelebration, setShowVictoryCelebration] = useState(false);
  const [teamLogo, setTeamLogo] = useState('');
  const [showManualImport, setShowManualImport] = useState(false);
  const [manualImportData, setManualImportData] = useState('');
  const [confirmDialog, setConfirmDialog] = useState({ show: false, message: '', onConfirm: null });
  const [cardTypeDialog, setCardTypeDialog] = useState({ show: false, cardType: '', playerNum: 0, matchId: null, playerName: '', minuto: null });
  
  // State per Divisione Squadre
  const [numSquadre, setNumSquadre] = useState(2);
  const [includiPortieri, setIncludiPortieri] = useState(true);
  const [selectedTrainingForDivision, setSelectedTrainingForDivision] = useState('');
  const [showDivisioneResults, setShowDivisioneResults] = useState(false);
  const [infortunati, setInfortunati] = useState(new Set());
  const [giocatoriSelezionati, setGiocatoriSelezionati] = useState(new Set());  // Per divisione squadre
  const [regenerateKey, setRegenerateKey] = useState(0);
  
  // State per Convocazioni
  const [convocati, setConvocati] = useState(new Set());
  const [showConvocazioniModal, setShowConvocazioniModal] = useState(false);
  const [selectedMatchForConvocazioni, setSelectedMatchForConvocazioni] = useState('');
  const [infoPartita, setInfoPartita] = useState({
    squadra1: '',
    squadra2: '',
    dataPartita: '',
    oraRitrovo: '',
    indirizzoCompo: ''
  });
  
  // State per Analisi Tattica
  const [moduloAvversario, setModuloAvversario] = useState('');
  
  // ========== STATE PER CLASSIFICA CAMPIONATO ==========
  const [squadreGirone, setSquadreGirone] = useState([]); // Lista squadre del girone
  const [risultatiCampionato, setRisultatiCampionato] = useState([]); // Risultati per giornata
  const [classificaTab, setClassificaTab] = useState('classifica'); // 'squadre', 'risultati', 'classifica'
  const [statsSubTab, setStatsSubTab] = useState('overview'); // 'overview', 'dettagli', 'record'
  const [editingSquadra, setEditingSquadra] = useState(null);
  const [showAddSquadraModal, setShowAddSquadraModal] = useState(false);
  const [selectedGiornata, setSelectedGiornata] = useState(1);
  const [showImportMatchModal, setShowImportMatchModal] = useState(null); // Per import da partite Real DOR
  
  // ========== STATE PER SINCRONIZZAZIONE CLOUD ==========
  const [syncStatus, setSyncStatus] = useState('idle'); // 'idle', 'syncing', 'success', 'error'
  const [lastSynced, setLastSynced] = useState(null);
  const [syncError, setSyncError] = useState('');
  const [autoSyncEnabled, setAutoSyncEnabled] = useState(false); // DISABILITATO per sicurezza
  const [syncConflicts, setSyncConflicts] = useState(null);
  const [showConflictModal, setShowConflictModal] = useState(false);
  
  // ========== STATE PER GESTIONE UTENTI ADMIN ==========
  const [allUsers, setAllUsers] = useState([]);
  const [loadingUsers, setLoadingUsers] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [showUserModal, setShowUserModal] = useState(false);
  const [showCreateUserModal, setShowCreateUserModal] = useState(false);
  const [newUserEmail, setNewUserEmail] = useState('');
  const [newUserPassword, setNewUserPassword] = useState('');
  const [newUserRole, setNewUserRole] = useState('user');
  const [userActionLoading, setUserActionLoading] = useState(false);
  
  // ========== STATE PER NUOVE FEATURE ==========
  // Toast Notifications
  const [toasts, setToasts] = useState([]);
  
  // Loading States
  const [loadingMessage, setLoadingMessage] = useState('');
  const [loadingProgress, setLoadingProgress] = useState(0);
  const [showLoading, setShowLoading] = useState(false);
  
  // Gestione Infortuni
  const [injuries, setInjuries] = useState([]);
  const [showInjuryModal, setShowInjuryModal] = useState(false);
  const [selectedPlayerForInjury, setSelectedPlayerForInjury] = useState(null);
  const [showEditInjuryModal, setShowEditInjuryModal] = useState(false);
  const [editingInjury, setEditingInjury] = useState(null);
  
  // Calendario
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [showEventModal, setShowEventModal] = useState(false);
  const [selectedDate, setSelectedDate] = useState(null);
  
  // Drag & Drop
  const [draggedPlayer, setDraggedPlayer] = useState(null);
  const [formationPositions, setFormationPositions] = useState({});
  
  // Sistema MVP
  const [showMVPModal, setShowMVPModal] = useState(false);
  const [selectedMatchForMVP, setSelectedMatchForMVP] = useState(null);

  // ========== GESTIONE DISPOSITIVI E AUTO-SYNC ==========
  const [deviceRole, setDeviceRole] = useState(null); // 'primary' | 'secondary' | null
  const [showDeviceModal, setShowDeviceModal] = useState(false);
  const [lastSyncInfo, setLastSyncInfo] = useState(null);
  const [autoSyncInterval, setAutoSyncInterval] = useState(null);

  // Gestione autenticazione
  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (user) => {
      if (user) {
        setUser(user);
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            const role = userData.role || 'user';
            const userTeamId = userData.teamId || user.uid; // Usa teamId se esiste, altrimenti user.uid
            
            setUserRole(role);
            setTeamId(userTeamId);
            
            console.log('üë§ Utente autenticato:', {
              email: user.email,
              role: role,
              teamId: userTeamId,
              sameAsUid: userTeamId === user.uid
            });
            
            // ‚úÖ AUTO-SYNC per utenti USER al login
            if (role === 'user') {
              console.log('üîÑ Utente USER rilevato - Avvio auto-sync da cloud...');
              // Piccolo delay per assicurarsi che tutto sia pronto
              setTimeout(async () => {
                try {
                  console.log('‚è∞ Inizio loadDataFromCloud per USER...');
                  // Passa user e teamId esplicitamente
                  await loadDataFromCloud(true, user, userTeamId);
                  console.log('‚úÖ Auto-sync completato per USER');
                  showToast('‚úÖ Dati sincronizzati automaticamente dal cloud', 'success');
                } catch (error) {
                  console.error('‚ùå Errore auto-sync USER:', error);
                  console.error('Dettagli errore:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                  });
                  showToast('‚ö†Ô∏è Errore durante la sincronizzazione automatica', 'error');
                }
              }, 1500);
            }
          } else {
            setUserRole('user');
          }
        } catch (error) {
          console.error('Errore recupero ruolo:', error);
          setUserRole('user');
        }
      } else {
        setUser(null);
        setUserRole(null);
      }
      setAuthLoading(false);
    });

    return () => unsubscribe();
  }, []);

  useEffect(() => {
    const loadData = async () => {
      try {
        const savedData = await loadFromIndexedDB('squadraRealDOR');
        if (savedData) {
          let loadedPlayers = savedData.players || players;
          
          loadedPlayers = loadedPlayers.map(p => ({
            ...p,
            dataCreazione: p.dataCreazione || (p.nome ? "2025-08-01" : ""),
            fuoriRosa: p.fuoriRosa || false // ‚úÖ Normalizza fuoriRosa
          }));
          
          if (loadedPlayers.length < 30) {
            const currentLength = loadedPlayers.length;
            for (let i = currentLength + 1; i <= 30; i++) {
              loadedPlayers.push({ 
                numero: i, 
                nome: "", 
                ruolo: "", 
                dataNascita: "", 
                telefono: "", 
                foto: "", 
                piede: "",
                dataCreazione: "",
                fuoriRosa: false // ‚úÖ Default false per nuovi slot
              });
            }
          }
          
          setPlayers(loadedPlayers);
          setTrainings(savedData.trainings || []);
          setMatches(savedData.matches || []);
          setAppTitle(savedData.appTitle || appTitle);
          setTeamLogo(savedData.teamLogo || '');
          setInjuries(savedData.injuries || []);
          setSquadreGirone(savedData.squadreGirone || []);
          setRisultatiCampionato(savedData.risultatiCampionato || []);
          setLastSaved(savedData.lastSaved ? new Date(savedData.lastSaved) : null);
        }
      } catch (error) {
        console.error('Errore caricamento dati:', error);
      } finally {
        setIsLoading(false);
      }
    };
    loadData();
  }, []);

  // ========== CHECK DEVICE CONFIG ALL'AVVIO ==========
  useEffect(() => {
    if (!user) return;
    
    const config = loadDeviceConfig();
    
    if (!config) {
      // Prima volta oggi o mai configurato
      setShowDeviceModal(true);
    } else {
      // Configurazione esistente
      setDeviceRole(config.deviceRole);
      
      if (config.deviceRole === 'primary' && config.autoSyncEnabled) {
        startAutoSync();
      }
      
      // Carica info ultimo sync
      loadLastSyncInfo();
    }
    
    // Cleanup interval on unmount
    return () => {
      if (autoSyncInterval) {
        clearInterval(autoSyncInterval);
      }
    };
  }, [user]);

  // NOTA: giocatoriSelezionati parte vuoto (size=0), quindi organizzaGiocatori 
  // includer√† tutti i giocatori per default. Quando si importa da allenamento,
  // viene popolato solo con i presenti.

  // Salvataggio AUTOMATICO
  useEffect(() => {
    if (isLoading) return;
    
    const saveData = async () => {
      const dataToSave = {
        players,
        trainings,
        matches,
        appTitle,
        teamLogo,
        injuries,
        squadreGirone,
        risultatiCampionato,
        lastSaved: new Date().toISOString()
      };
      
      const success = await saveToIndexedDB('squadraRealDOR', dataToSave);
      if (success) {
        setLastSaved(new Date());
      }
    };
    
    saveData();
  }, [players, trainings, matches, appTitle, teamLogo, injuries, squadreGirone, risultatiCampionato, isLoading]);

  useEffect(() => {
    if (isTimerRunning) {
      const interval = setInterval(() => {
        setMatchTimer(prev => {
          const newTime = prev + 1;
          
          if (newTime === 2700 && halfTime === 1) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 4; i++) {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 550;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
              }, i * 1000);
            }
            
            setIsTimerRunning(false);
            setIsRecoveryRunning(true);
            setRecoveryTime(0);
          }
          
          if (newTime === 5400 && halfTime === 2) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 4; i++) {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 550;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
              }, i * 1000);
            }
            
            setIsTimerRunning(false);
            setIsRecoveryRunning(true);
            setRecoveryTime(0);
          }
          
          return newTime;
        });
      }, 1000);
      setTimerInterval(interval);
      return () => clearInterval(interval);
    } else if (timerInterval) {
      clearInterval(timerInterval);
      setTimerInterval(null);
    }
  }, [isTimerRunning, halfTime]);

  useEffect(() => {
    if (isRecoveryRunning) {
      const interval = setInterval(() => {
        setRecoveryTime(prev => {
          const newTime = prev + 1;
          if (recoveryMinutes && parseInt(recoveryMinutes) > 0 && newTime === parseInt(recoveryMinutes) * 60) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 4; i++) {
              setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 550;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
              }, i * 1000);
            }
            
            setIsRecoveryRunning(false);
            
            if (halfTime === 1) {
              setHalfTime(2);
              setMatchTimer(2700);
              setRecoveryTime(0);
              setRecoveryMinutes('');
            } else {
              setMatchEnded(true);
            }
          }
          return newTime;
        });
      }, 1000);
      setRecoveryInterval(interval);
      return () => clearInterval(interval);
    } else if (recoveryInterval) {
      clearInterval(recoveryInterval);
      setRecoveryInterval(null);
    }
  }, [isRecoveryRunning, recoveryMinutes, halfTime]);

  const startTimer = () => setIsTimerRunning(true);
  const pauseTimer = () => setIsTimerRunning(false);

  const addMinute = () => {
    setMatchTimer(prev => {
      const maxTime = halfTime === 1 ? 2700 : 5400;
      return Math.min(prev + 60, maxTime);
    });
  };

  const removeMinute = () => {
    setMatchTimer(prev => {
      const minTime = halfTime === 1 ? 0 : 2700;
      return Math.max(prev - 60, minTime);
    });
  };

  const addRecoveryMinute = () => {
    setRecoveryTime(prev => prev + 60);
  };

  const removeRecoveryMinute = () => {
    setRecoveryTime(prev => Math.max(prev - 60, 0));
  };

  const endMatch = () => {
    setIsTimerRunning(false);
    setIsRecoveryRunning(false);
    setMatchEnded(true);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const startLiveMatch = (matchId) => {
    setLiveMatchMode(matchId);
    setMatchTimer(0);
    setIsTimerRunning(false);
    setSubstitutionMode(null);
    setRecoveryTime(0);
    setIsRecoveryRunning(false);
    setMatchEnded(false);
    setRecoveryMinutes('');
  };

  const closeLiveMatch = () => {
    setLiveMatchMode(null);
    setIsTimerRunning(false);
    setMatchTimer(0);
    setSubstitutionMode(null);
    setRecoveryTime(0);
    setIsRecoveryRunning(false);
    setMatchEnded(false);
    setRecoveryMinutes('');
  };

  const initiateSubstitution = (playerOut) => {
    const match = matches.find(m => m.id === liveMatchMode);
    const player = players.find(p => p.numero === playerOut);
    
    if (match && player) {
      const numSostituzioni = Object.values(match.sostituzioni || {}).filter(v => v === true).length;
      
      if (numSostituzioni >= 5) {
        showConfirm(`üö´ SOSTITUZIONE NON CONSENTITA!\n\n‚ö†Ô∏è HAI GI√Ä EFFETTUATO 5 SOSTITUZIONI\n\nNon √® possibile effettuare la 6¬∞ sostituzione.\nIl regolamento consente un massimo di 5 sostituzioni per partita.`, () => {});
        return;
      }
      
      if (numSostituzioni === 4) {
        showConfirm(`‚ö†Ô∏è ATTENZIONE - ULTIMA SOSTITUZIONE!\n\nQuesta sar√† la tua 5¬∞ e ULTIMA sostituzione possibile.\n\nESCE: ${player.nome} (#${playerOut})\n\nConfermi?`, () => {
          setSubstitutionMode(playerOut);
        });
      } else {
        showConfirm(`üîÑ Confermi la SOSTITUZIONE di ${player.nome} (#${playerOut})?\n\nDopo aver confermato, clicca sul giocatore che entra dalla panchina.\n\nSostituzioni effettuate: ${numSostituzioni}/5`, () => {
          setSubstitutionMode(playerOut);
        });
      }
    }
  };

  const completeSubstitution = (matchId, playerOut, playerIn) => {
    const match = matches.find(m => m.id === matchId);
    const playerOutData = players.find(p => p.numero === playerOut);
    const playerInData = players.find(p => p.numero === playerIn);
    
    if (match && playerOutData && playerInData) {
      let minutiAttuali;
      if (halfTime === 1) {
        minutiAttuali = Math.floor(matchTimer / 60);
      } else {
        minutiAttuali = Math.floor(matchTimer / 60);
      }
      
      const ordineDistinta = match.ordineDistinta || {};
      const magliaOut = ordineDistinta[playerOut] || playerOut;
      const magliaIn = ordineDistinta[playerIn] || playerIn;
      
      showConfirm(`üîÑ CONFERMA SOSTITUZIONE:\n\nESCE: ${playerOutData.nome} (#${magliaOut})\nENTRA: ${playerInData.nome} (#${magliaIn})\n\nMinuto: ${minutiAttuali}'`, () => {
        const minutiGiocatiOut = minutiAttuali;
        const minutiGiocatiIn = 90 - minutiAttuali;
        
        const newSost = { ...match.sostituzioni, [playerOut]: true };
        const newEntr = { ...match.entrati, [playerIn]: true };
        const newMin = { 
          ...match.minutiGiocati, 
          [playerOut]: minutiGiocatiOut.toString(),
          [playerIn]: minutiGiocatiIn.toString()
        };
        
        const ordineDistinta = match.ordineDistinta || {};
        const newOrdineDistinta = { ...ordineDistinta };
        
        let posizioneVisualizzazione = match.posizioneVisualizzazione;
        if (!posizioneVisualizzazione) {
          posizioneVisualizzazione = {};
          
          const titolariArray = Object.keys(match.titolari)
            .filter(num => match.titolari[num])
            .map(num => parseInt(num));
          
          const hasOrdineDistinta = titolariArray.some(num => ordineDistinta[num] && ordineDistinta[num] !== num.toString());
          
          if (hasOrdineDistinta) {
            titolariArray.sort((a, b) => {
              const ordA = parseInt(ordineDistinta[a] || 999);
              const ordB = parseInt(ordineDistinta[b] || 999);
              if (ordA === ordB) return a - b;
              return ordA - ordB;
            });
          } else {
            titolariArray.sort((a, b) => a - b);
          }
          
          titolariArray.forEach((numero, index) => {
            posizioneVisualizzazione[numero] = index + 1;
          });
        }
        const newPosizioneVisualizzazione = { ...posizioneVisualizzazione };
        
        let posizioneDelSostituito = newPosizioneVisualizzazione[playerOut];
        let posizioneDelSubentrante = newPosizioneVisualizzazione[playerIn];
        
        if (!posizioneDelSubentrante) {
          const maxPos = Math.max(...Object.values(newPosizioneVisualizzazione).filter(v => !isNaN(v)));
          posizioneDelSubentrante = maxPos + 1;
        }
        
        if (!posizioneDelSostituito) {
          const titolariArray = Object.keys(match.titolari)
            .filter(num => match.titolari[num])
            .map(num => parseInt(num));
          
          const hasOrdineDistinta = titolariArray.some(num => ordineDistinta[num] && ordineDistinta[num] !== num.toString());
          
          if (hasOrdineDistinta) {
            titolariArray.sort((a, b) => {
              const ordA = parseInt(ordineDistinta[a] || 999);
              const ordB = parseInt(ordineDistinta[b] || 999);
              if (ordA === ordB) return a - b;
              return ordA - ordB;
            });
          } else {
            titolariArray.sort((a, b) => a - b);
          }
          
          const index = titolariArray.indexOf(playerOut);
          if (index !== -1) {
            posizioneDelSostituito = index + 1;
          }
        }
        
        if (posizioneDelSostituito) {
          newPosizioneVisualizzazione[playerIn] = posizioneDelSostituito;
          newPosizioneVisualizzazione[playerOut] = posizioneDelSubentrante;
        }
        
        const sostituzioniDettaglio = match.sostituzioniDettaglio || {};
        const newSostituzioniDettaglio = {
          ...sostituzioniDettaglio,
          [playerOut]: { sostituito: true, sostituitoreDa: playerIn, minuto: minutiAttuali },
          [playerIn]: { entrato: true, alPostoDi: playerOut, minuto: minutiAttuali }
        };
        
        setMatches(matches.map(m => 
          m.id === matchId ? { 
            ...m,
            sostituzioni: newSost, 
            entrati: newEntr,
            minutiGiocati: newMin,
            ordineDistinta: newOrdineDistinta,
            posizioneVisualizzazione: newPosizioneVisualizzazione,
            sostituzioniDettaglio: newSostituzioniDettaglio
          } : m
        ));
        
        setSubstitutionMode(null);
      });
    }
  };

  const cancelSubstitution = () => {
    setSubstitutionMode(null);
  };

  const showConfirm = (message, onConfirm) => {
    setConfirmDialog({ show: true, message, onConfirm });
  };

  const handleConfirm = () => {
    if (confirmDialog.onConfirm) {
      confirmDialog.onConfirm();
    }
    setConfirmDialog({ show: false, message: '', onConfirm: null });
  };

  const handleCancel = () => {
    setConfirmDialog({ show: false, message: '', onConfirm: null });
  };

  // ========== FUNZIONI TOAST NOTIFICATIONS ==========
  const showToast = (message, type = 'info', duration = 3000) => {
    const id = Date.now();
    const toast = { id, message, type };
    
    setToasts(prev => [...prev, toast]);
    
    setTimeout(() => {
      setToasts(prev => prev.map(t => t.id === id ? { ...t, exiting: true } : t));
      setTimeout(() => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, 300);
    }, duration);
  };
  
  const showLoadingWithProgress = (message, duration = 0) => {
    setLoadingMessage(message);
    setLoadingProgress(0);
    setShowLoading(true);
    
    if (duration > 0) {
      const steps = 100;
      const interval = duration / steps;
      let current = 0;
      
      const progressInterval = setInterval(() => {
        current += 1;
        setLoadingProgress(current);
        
        if (current >= 100) {
          clearInterval(progressInterval);
          setTimeout(() => setShowLoading(false), 500);
        }
      }, interval);
    }
  };
  
  const hideLoading = () => {
    setShowLoading(false);
    setLoadingProgress(0);
  };
  
  // ========== FUNZIONI GESTIONE INFORTUNI ==========
  const addInjury = (playerNum, injuryData) => {
    const newInjury = {
      id: Date.now(),
      playerNum,
      playerName: players.find(p => p.numero === playerNum)?.nome || '',
      type: injuryData.type,
      startDate: injuryData.startDate || new Date().toISOString().split('T')[0],
      estimatedReturn: injuryData.estimatedReturn,
      notes: injuryData.notes || '',
      status: 'active'
    };
    
    setInjuries(prev => [...prev, newInjury]);
    showToast(`ü§ï Infortunio registrato per ${newInjury.playerName}`, 'warning');
  };
  
  const updateInjuryStatus = (injuryId, newStatus) => {
    setInjuries(prev => prev.map(inj => 
      inj.id === injuryId ? { ...inj, status: newStatus } : inj
    ));
    
    const injury = injuries.find(i => i.id === injuryId);
    if (injury) {
      const statusMessages = {
        'active': 'ü§ï Infortunio attivo',
        'recovering': 'üìà In recupero',
        'recovered': '‚úÖ Recuperato'
      };
      showToast(`${statusMessages[newStatus]}: ${injury.playerName}`, 'success');
    }
  };
  
  const removeInjury = (injuryId) => {
    setInjuries(prev => prev.filter(inj => inj.id !== injuryId));
    showToast('Infortunio rimosso', 'info');
  };
  
  const getActiveInjuries = () => {
    return injuries.filter(inj => inj.status === 'active');
  };
  
  const getPlayerInjury = (playerNum) => {
    return injuries.find(inj => inj.playerNum === playerNum && inj.status === 'active');
  };
  
  // ========== FUNZIONI CALENDARIO ==========
  const getDaysInMonth = (month, year) => {
    return new Date(year, month + 1, 0).getDate();
  };
  
  const getFirstDayOfMonth = (month, year) => {
    return new Date(year, month, 1).getDay();
  };
  
  const getEventsForDate = (date) => {
    const dateStr = date.toISOString().split('T')[0];
    const dayTrainings = trainings.filter(t => t.data === dateStr);
    const dayMatches = matches.filter(m => m.data === dateStr);
    return { trainings: dayTrainings, matches: dayMatches };
  };
  
  // ========== FUNZIONI DRAG & DROP ==========
  const handleDragStart = (e, playerNum) => {
    setDraggedPlayer(playerNum);
    e.dataTransfer.effectAllowed = 'move';
  };
  
  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };
  
  const handleDrop = (e, position) => {
    e.preventDefault();
    if (draggedPlayer !== null) {
      setFormationPositions(prev => ({
        ...prev,
        [position]: draggedPlayer
      }));
      setDraggedPlayer(null);
    }
  };
  
  const clearPosition = (position) => {
    setFormationPositions(prev => {
      const newPositions = { ...prev };
      delete newPositions[position];
      return newPositions;
    });
  };

  // Gestione logout
  const handleLogout = async () => {
    // ‚úÖ Solo ADMIN con dispositivo PRIMARY ‚Üí Mostra modal
    if (userRole === 'admin' && deviceRole === 'primary') {
      setShowExitModal(true);
      return;
    }
    
    // Per USER o SECONDARY ‚Üí Chiude direttamente la finestra
    window.close();
  };

  // ========== FUNZIONI MODAL CHIUSURA APP ==========
  
  const handleExitWithSave = async () => {
    try {
      setShowExitModal(false);
      showToast('‚òÅÔ∏è Preparazione dati per il salvataggio...', 'info');
      
      // ‚ö†Ô∏è CRITICO: Delay per assicurare che tutti gli state siano aggiornati
      // React aggiorna gli state in modo asincrono, quindi aspettiamo che
      // eventuali modifiche recenti (fuoriRosa, injuries) siano completate
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Log dettagliato PRIMA del salvataggio
      console.log('üîç State PRIMA del salvataggio cloud:', {
        players: players.length,
        injuries: injuries.length,
        injuriesData: injuries,
        playersWithFuoriRosa: players.filter(p => p.fuoriRosa).length,
        fuoriRosaData: players.filter(p => p.fuoriRosa).map(p => ({ numero: p.numero, nome: p.nome, fuoriRosa: p.fuoriRosa }))
      });
      
      showToast('‚òÅÔ∏è Salvataggio su cloud in corso...', 'info');
      await saveDataToCloud(true); // silent = true per non mostrare toast doppio
      
      // Log DOPO il salvataggio
      console.log('‚úÖ Salvataggio cloud completato');
      
      showToast('‚úÖ Dati salvati! A presto!', 'success');
      // Piccolo delay per far vedere il toast
      await new Promise(resolve => setTimeout(resolve, 1500));
      window.close(); // Chiude solo la finestra, NON fa logout
    } catch (error) {
      console.error('‚ùå Errore salvataggio:', error);
      showToast('‚ùå Errore: ' + error.message, 'error');
      // Non chiudere se c'√® errore
    }
  };

  const handleExitWithoutSave = () => {
    setShowExitModal(false);
    showToast('üëã A presto!', 'info');
    setTimeout(() => {
      window.close(); // Chiude solo la finestra, NON fa logout
    }, 500);
  };

  const handleCancelExit = () => {
    setShowExitModal(false);
  };

  const quickAddGoal = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      showConfirm(`‚öΩ Confermi il GOL di ${player.nome} (#${playerNum})?`, () => {
        const newGol = { ...match.golFatti, [playerNum]: (parseInt(match.golFatti[playerNum] || 0) + 1).toString() };
        
        // Salva evento in timeline
        const timeline = match.timeline || [];
        const newEvent = {
          id: Date.now(),
          tipo: 'gol',
          playerNum: playerNum,
          playerNome: player.nome,
          timestamp: new Date().toISOString(),
          minuto: minuto  // STEP 3: Aggiungi minuto
        };
        
        // Update atomico - aggiorna tutto insieme
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, golFatti: newGol, timeline: [...timeline, newEvent] }
            : m
        ));
      });
    }
  };

  const quickAddAssist = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      showConfirm(`üéØ Confermi l'ASSIST di ${player.nome} (#${playerNum})?`, () => {
        const newAss = { ...match.assist, [playerNum]: (parseInt(match.assist[playerNum] || 0) + 1).toString() };
        
        // Salva evento in timeline
        const timeline = match.timeline || [];
        const newEvent = {
          id: Date.now(),
          tipo: 'assist',
          playerNum: playerNum,
          playerNome: player.nome,
          timestamp: new Date().toISOString(),
          minuto: minuto  // STEP 3: Aggiungi minuto
        };
        
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, assist: newAss, timeline: [...timeline, newEvent] }
            : m
        ));
      });
    }
  };

  const quickAddGoalConceded = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      showConfirm(`‚öΩ Confermi il GOL SUBITO da ${player.nome} (#${playerNum})?`, () => {
        const newGS = { ...match.golSubiti, [playerNum]: (parseInt(match.golSubiti[playerNum] || 0) + 1).toString() };
        
        // Salva evento in timeline
        const timeline = match.timeline || [];
        const newEvent = {
          id: Date.now(),
          tipo: 'golsubito',
          playerNum: playerNum,
          playerNome: player.nome,
          timestamp: new Date().toISOString(),
          minuto: minuto  // STEP 3: Aggiungi minuto
        };
        
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, golSubiti: newGS, timeline: [...timeline, newEvent] }
            : m
        ));
      });
    }
  };

  const quickAddYellowCard = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      setCardTypeDialog({
        show: true,
        cardType: 'yellow',
        playerNum: playerNum,
        matchId: matchId,
        playerName: player.nome,
        minuto: minuto  // STEP 3: Aggiungi minuto
      });
    }
  };

  const quickAddRedCard = (matchId, playerNum, minuto = null) => {
    const match = matches.find(m => m.id === matchId);
    const player = players.find(p => p.numero === playerNum);
    if (match && player) {
      setCardTypeDialog({
        show: true,
        cardType: 'red',
        playerNum: playerNum,
        matchId: matchId,
        playerName: player.nome,
        minuto: minuto  // STEP 3: Aggiungi minuto
      });
    }
  };
  
  const assignCard = (type) => {
    const { cardType, playerNum, matchId, playerName, minuto } = cardTypeDialog;
    const match = matches.find(m => m.id === matchId);
    
    if (!match) return;
    
    if (cardType === 'yellow') {
      const timeline = match.timeline || [];
      const newEvent = {
        id: Date.now(),
        tipo: 'giallo',
        sottotipo: type,
        playerNum: playerNum,
        playerNome: playerName,
        timestamp: new Date().toISOString(),
        minuto: minuto  // STEP 3: Aggiungi minuto
      };
      
      if (type === 'gioco') {
        const newGG = { ...match.gialli_gioco, [playerNum]: (parseInt(match.gialli_gioco[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, gialli_gioco: newGG, timeline: [...timeline, newEvent] }
            : m
        ));
      } else {
        const newGP = { ...match.gialli_protesta, [playerNum]: (parseInt(match.gialli_protesta[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, gialli_protesta: newGP, timeline: [...timeline, newEvent] }
            : m
        ));
      }
      
    } else if (cardType === 'red') {
      const timeline = match.timeline || [];
      const newEvent = {
        id: Date.now(),
        tipo: 'rosso',
        sottotipo: type,
        playerNum: playerNum,
        playerNome: playerName,
        timestamp: new Date().toISOString(),
        minuto: minuto  // STEP 3: Aggiungi minuto
      };
      
      if (type === 'gioco') {
        const newRG = { ...match.rossi_gioco, [playerNum]: (parseInt(match.rossi_gioco[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, rossi_gioco: newRG, timeline: [...timeline, newEvent] }
            : m
        ));
      } else {
        const newRP = { ...match.rossi_protesta, [playerNum]: (parseInt(match.rossi_protesta[playerNum] || 0) + 1).toString() };
        // Update atomico
        setMatches(matches.map(m => 
          m.id === matchId 
            ? { ...m, rossi_protesta: newRP, timeline: [...timeline, newEvent] }
            : m
        ));
      }
    }
    
    setCardTypeDialog({ show: false, cardType: '', playerNum: 0, matchId: null, playerName: '', minuto: null });
  };

  const toggleTraining = (id) => {
    setExpandedTrainings(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const toggleMatch = (id) => {
    setExpandedMatches(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  const getSortedTrainings = () => {
    return [...trainings].sort((a, b) => new Date(b.data) - new Date(a.data));
  };

  const getSortedMatches = () => {
    return [...matches].sort((a, b) => new Date(b.data) - new Date(a.data));
  };

  const updatePlayer = (numero, field, value) => {
    setPlayers(players.map(p => 
      p.numero === numero ? { ...p, [field]: value } : p
    ));
  };

  const clearPlayer = (numero) => {
    setPlayers(players.map(p => 
      p.numero === numero ? { ...p, nome: '', ruolo: '', dataNascita: '', telefono: '', foto: '', piede: '' } : p
    ));
  };

  const handleImageUpload = async (numero, e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('‚ùå Seleziona un file immagine valido (JPG, PNG, ecc.)');
      e.target.value = '';
      return;
    }

    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      alert(`‚ùå File troppo grande (${(file.size / 1024 / 1024).toFixed(1)}MB). Max 5MB.`);
      e.target.value = '';
      return;
    }

    if (!user) {
      alert('‚ùå Devi essere autenticato per caricare foto su Firebase Storage');
      e.target.value = '';
      return;
    }

    showToast('üì§ Caricamento foto su cloud...', 'info', 2000);

    try {
      // Comprimi immagine prima dell'upload
      const compressedBlob = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            // Ridimensiona a 300x300 per qualit√† migliore
            const maxWidth = 300;
            const maxHeight = 300;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(
              (blob) => resolve(blob),
              'image/jpeg',
              0.85 // Qualit√† 85%
            );
          };
          img.onerror = () => reject(new Error('Errore caricamento immagine'));
          img.src = event.target.result;
        };
        reader.onerror = () => reject(new Error('Errore lettura file'));
        reader.readAsDataURL(file);
      });

      // Upload su Firebase Storage
      const storageRef = storage.ref();
      const fileName = `players/${user.uid}/${numero}_${Date.now()}.jpg`;
      const fileRef = storageRef.child(fileName);
      
      const uploadTask = await fileRef.put(compressedBlob);
      const downloadURL = await fileRef.getDownloadURL();
      
      // Elimina vecchia foto se presente
      const player = players.find(p => p.numero === numero);
      if (player?.foto && player.foto.startsWith('https://firebasestorage')) {
        try {
          const oldRef = storage.refFromURL(player.foto);
          await oldRef.delete();
        } catch (err) {
          console.log('Vecchia foto non trovata o gi√† eliminata');
        }
      }
      
      // Salva URL nel player
      updatePlayer(numero, 'foto', downloadURL);
      
      const sizeKB = Math.round((uploadTask.bytesTransferred || 0) / 1024);
      showToast(`‚úÖ Foto caricata su cloud! (${sizeKB}KB)`, 'success');
      
      e.target.value = '';
    } catch (error) {
      console.error('Errore upload foto:', error);
      showToast('‚ùå Errore caricamento foto: ' + error.message, 'error', 5000);
      e.target.value = '';
    }
  };

  const handleLogoUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('‚ùå Per favore seleziona un file immagine valido (JPG, PNG, ecc.)');
      e.target.value = '';
      return;
    }

    const maxSize = 500 * 1024;
    if (file.size > maxSize) {
      alert(`‚ùå Il file √® troppo grande (${(file.size / 1024).toFixed(0)}KB). Dimensione massima: 500KB.\n\nüí° Prova a ridimensionare l'immagine prima di caricarla.`);
      e.target.value = '';
      return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        const maxWidth = 200;
        const maxHeight = 200;
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width = (width * maxHeight) / height;
            height = maxHeight;
          }
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
        
        const finalSize = resizedDataUrl.length;
        if (finalSize > 100 * 1024) {
          alert('‚ùå Impossibile ridurre sufficientemente l\'immagine. Prova con un\'immagine pi√π piccola.');
          e.target.value = '';
          return;
        }

        setTeamLogo(resizedDataUrl);
        alert('‚úÖ Logo caricato con successo!');
      };
      img.onerror = () => {
        alert('‚ùå Errore nel caricamento dell\'immagine. Prova con un altro file.');
        e.target.value = '';
      };
      img.src = event.target.result;
    };
    reader.onerror = () => {
      alert('‚ùå Errore nella lettura del file.');
      e.target.value = '';
    };
    reader.readAsDataURL(file);
  };

  const removeLogo = () => {
    if (window.confirm('Sei sicuro di voler rimuovere il logo?')) {
      setTeamLogo('');
      alert('‚úÖ Logo rimosso!');
    }
  };

  const calculateAge = (dataNascita) => {
    if (!dataNascita) return '';
    const today = new Date();
    const birthDate = new Date(dataNascita);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    return age;
  };

  const addTraining = () => {
    // Pre-compila infortuni dai giocatori con injury attivo
    const infortuniPrecompilati = {};
    injuries.forEach(injury => {
      if (injury.status === 'active') {
        infortuniPrecompilati[injury.playerNum] = true;
      }
    });
    
    // Pre-compila presenze: tutti true TRANNE gli infortunati
    const presenzePrecompilate = {};
    players.forEach(p => {
      presenzePrecompilate[p.numero] = !infortuniPrecompilati[p.numero]; // false se infortunato, true altrimenti
    });
    
    const newTraining = {
      id: Date.now(),
      data: new Date().toISOString().split('T')[0],
      presenze: presenzePrecompilate,
      infortuni: infortuniPrecompilati,
      esercizi: []  // NUOVO CAMPO per esercizi
    };
    setTrainings([...trainings, newTraining]);
  };

  const addMatch = () => {
    const newMatch = {
      id: Date.now(),
      data: new Date().toISOString().split('T')[0],
      squadraCasa: '',
      squadraTrasferta: '',
      risultato: '',
      convocati: {},
      titolari: {},
      entrati: {},
      sostituzioni: {},
      minutiGiocati: {},
      golFatti: {},
      assist: {},
      golSubiti: {},
      gialli_gioco: {},
      gialli_protesta: {},
      rossi_gioco: {},
      rossi_protesta: {},
      ordineDistinta: {},
      mvp: null // Numero del giocatore MVP
    };
    setMatches([...matches, newMatch]);
  };

  const updateTraining = (trainingId, field, value) => {
    setTrainings(trainings.map(t => 
      t.id === trainingId ? { ...t, [field]: value } : t
    ));
  };

  const updateMatch = (matchId, field, value) => {
    setMatches(matches.map(m => 
      m.id === matchId ? { ...m, [field]: value } : m
    ));
  };

  const deleteTraining = (id) => {
    setTrainings(trainings.filter(t => t.id !== id));
  };

  // ========== TEMPLATE ESERCIZI PREDEFINITI ==========
  
  const templateEsercizi = [
    { nome: "Riscaldamento", durata: 15, descrizione: "Corsa leggera e stretching dinamico" },
    { nome: "Possesso palla 4v4", durata: 20, descrizione: "Mantenimento palla in quadrato 20x20m" },
    { nome: "Possesso palla 6v6", durata: 25, descrizione: "Mantenimento palla campo ridotto" },
    { nome: "Esercitazione passaggi", durata: 20, descrizione: "Triangolazioni e movimenti senza palla" },
    { nome: "Tiri in porta", durata: 15, descrizione: "Serie di tiri da diverse posizioni" },
    { nome: "Partitella 7v7", durata: 30, descrizione: "Partita tattica su campo ridotto" },
    { nome: "Partitella 11v11", durata: 40, descrizione: "Partita tattica su campo intero" },
    { nome: "Lavoro atletico", durata: 20, descrizione: "Circuito forza e resistenza" },
    { nome: "Portieri specifico", durata: 20, descrizione: "Lavoro tecnico portieri" },
    { nome: "Defaticamento", durata: 10, descrizione: "Stretching statico e recupero" },
    { nome: "Personalizzato", durata: 0, descrizione: "" }
  ];

  // ========== FUNZIONI GESTIONE ESERCIZI ==========
  
  const addEsercizio = (trainingId) => {
    const esercizio = newEsercizio[trainingId] || {};
    
    if (!esercizio.nome || !esercizio.durata) {
      alert('‚ùå Inserisci nome e durata dell\'esercizio');
      return;
    }
    
    const nuovoEsercizio = {
      id: Date.now(),
      nome: esercizio.nome,
      durata: parseInt(esercizio.durata) || 0,
      descrizione: esercizio.descrizione || '',
      valutazione: esercizio.valutazione || ''
    };
    
    setTrainings(trainings.map(t => {
      if (t.id === trainingId) {
        return {
          ...t,
          esercizi: [...(t.esercizi || []), nuovoEsercizio]
        };
      }
      return t;
    }));
    
    // Reset form
    setNewEsercizio({ ...newEsercizio, [trainingId]: {} });
    showToast('‚úÖ Esercizio aggiunto!', 'success');
  };
  
  const updateEsercizio = (trainingId, esercizioId, field, value) => {
    setTrainings(trainings.map(t => {
      if (t.id === trainingId) {
        return {
          ...t,
          esercizi: (t.esercizi || []).map(e => 
            e.id === esercizioId ? { ...e, [field]: value } : e
          )
        };
      }
      return t;
    }));
  };
  
  const deleteEsercizio = (trainingId, esercizioId) => {
    if (!window.confirm('üóëÔ∏è Vuoi eliminare questo esercizio?')) return;
    
    setTrainings(trainings.map(t => {
      if (t.id === trainingId) {
        return {
          ...t,
          esercizi: (t.esercizi || []).filter(e => e.id !== esercizioId)
        };
      }
      return t;
    }));
    
    showToast('‚úÖ Esercizio eliminato', 'success');
  };
  
  const caricaTemplateEsercizio = (trainingId, template) => {
    setNewEsercizio({
      ...newEsercizio,
      [trainingId]: {
        nome: template.nome,
        durata: template.durata,
        descrizione: template.descrizione,
        valutazione: ''
      }
    });
  };
  
  const duplicaEserciziDaAllenamento = (targetTrainingId, sourceTrainingId) => {
    const sourceTraining = trainings.find(t => t.id === parseInt(sourceTrainingId));
    if (!sourceTraining || !sourceTraining.esercizi || sourceTraining.esercizi.length === 0) {
      alert('‚ùå L\'allenamento selezionato non ha esercizi');
      return;
    }
    
    if (!window.confirm(`üìã Vuoi copiare ${sourceTraining.esercizi.length} esercizi dall'allenamento del ${sourceTraining.data}?`)) {
      return;
    }
    
    const eserciziCopiati = sourceTraining.esercizi.map(e => ({
      ...e,
      id: Date.now() + Math.random(), // Nuovo ID
      valutazione: '' // Reset valutazione
    }));
    
    setTrainings(trainings.map(t => {
      if (t.id === targetTrainingId) {
        return {
          ...t,
          esercizi: [...(t.esercizi || []), ...eserciziCopiati]
        };
      }
      return t;
    }));
    
    showToast(`‚úÖ ${eserciziCopiati.length} esercizi copiati!`, 'success');
  };
  
  const calcolaTotaleMinuti = (esercizi) => {
    if (!esercizi || esercizi.length === 0) return 0;
    return esercizi.reduce((tot, e) => tot + (parseInt(e.durata) || 0), 0);
  };

  // Esporta esercizi allenamento in PDF
  const exportEserciziPDF = (training) => {
    if (!training || !training.esercizi || training.esercizi.length === 0) {
      alert('Nessun esercizio da esportare!');
      return;
    }
    
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      let yPos = 15;
      
      // Logo se presente
      if (teamLogo) {
        try {
          doc.addImage(teamLogo, 'PNG', 15, 10, 15, 15);
        } catch (e) {
          console.log('Errore caricamento logo:', e);
        }
      }
      
      // Titolo
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text('ESERCIZI ALLENAMENTO', teamLogo ? 35 : 15, 20);
      yPos = 30;
      
      // Data allenamento
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      const dataFormatted = new Date(training.data).toLocaleDateString('it-IT', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      doc.text(dataFormatted, 15, yPos);
      yPos += 10;
      
      // Box riepilogo
      doc.setFillColor(240, 248, 255);
      doc.rect(15, yPos, 180, 20, 'F');
      doc.setDrawColor(59, 130, 246);
      doc.rect(15, yPos, 180, 20);
      
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text(`Totale: ${training.esercizi.length} esercizi`, 20, yPos + 7);
      doc.text(`Durata: ${calcolaTotaleMinuti(training.esercizi)} minuti`, 20, yPos + 14);
      yPos += 28;
      
      // Lista esercizi
      training.esercizi.forEach((esercizio, idx) => {
        // Check spazio pagina
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        
        // Numero esercizio
        doc.setFillColor(59, 130, 246);
        doc.circle(22, yPos + 3, 4, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`${idx + 1}`, 22, yPos + 4.5, { align: 'center' });
        
        // Nome esercizio
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(esercizio.nome, 30, yPos + 4);
        
        // Durata (senza icona)
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(59, 130, 246);
        const durataText = `${esercizio.durata} min`;
        const durataWidth = doc.getTextWidth(durataText);
        doc.text(durataText, 195 - durataWidth, yPos + 4);
        
        yPos += 8;
        
        // Descrizione
        if (esercizio.descrizione) {
          doc.setTextColor(80, 80, 80);
          doc.setFontSize(9);
          doc.setFont(undefined, 'normal');
          
          const lines = doc.splitTextToSize(esercizio.descrizione, 165);
          lines.forEach(line => {
            if (yPos > 280) {
              doc.addPage();
              yPos = 20;
            }
            doc.text(line, 30, yPos);
            yPos += 5;
          });
        }
        
        yPos += 5;
        
        // Linea separatore
        if (idx < training.esercizi.length - 1) {
          doc.setDrawColor(200, 200, 200);
          doc.line(15, yPos, 195, yPos);
          yPos += 8;
        }
      });
      
      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`Real D.O.R. Under 18 - Pagina ${i} di ${pageCount}`, 105, 290, { align: 'center' });
      }
      
      // Salva PDF
      const fileName = `Esercizi_${training.data}.pdf`;
      doc.save(fileName);
      showToast('‚úÖ PDF esercizi esportato!', 'success');
      
    } catch (error) {
      console.error('Errore export PDF esercizi:', error);
      showToast('‚ùå Errore export PDF: ' + error.message, 'error');
    }
  };

  const deleteMatch = (id) => {
    setMatches(matches.filter(m => m.id !== id));
  };

  // ========== FUNZIONI SISTEMA MVP ==========
  
  /**
   * Apre il modal per votare l'MVP di una partita
   */
  const openMVPVoting = (matchId) => {
    const match = matches.find(m => m.id === matchId);
    if (!match) return;
    
    // Verifica che ci siano convocati
    const convocatiCount = Object.values(match.convocati || {}).filter(Boolean).length;
    if (convocatiCount === 0) {
      showToast('‚ö†Ô∏è Nessun giocatore convocato per questa partita', 'warning');
      return;
    }
    
    setSelectedMatchForMVP(matchId);
    setShowMVPModal(true);
  };
  
  /**
   * Assegna l'MVP a un giocatore per una partita
   */
  const assignMVP = (matchId, playerNum) => {
    const match = matches.find(m => m.id === matchId);
    if (!match) return;
    
    const player = players.find(p => p.numero === playerNum);
    if (!player || !player.nome) {
      showToast('‚ùå Giocatore non valido', 'error');
      return;
    }
    
    // Verifica che il giocatore fosse convocato
    if (!match.convocati[playerNum]) {
      showToast('‚ö†Ô∏è Il giocatore non era convocato per questa partita', 'warning');
      return;
    }
    
    // Aggiorna il match con l'MVP
    setMatches(matches.map(m => 
      m.id === matchId ? { ...m, mvp: playerNum } : m
    ));
    
    showToast(`üèÜ ${player.nome} nominato Man of the Match!`, 'success');
    setShowMVPModal(false);
    setSelectedMatchForMVP(null);
  };
  
  /**
   * Rimuove l'MVP da una partita
   */
  const removeMVP = (matchId) => {
    setMatches(matches.map(m => 
      m.id === matchId ? { ...m, mvp: null } : m
    ));
    showToast('üîÑ MVP rimosso', 'info');
  };
  
  /**
   * Ottiene la classifica MVP della stagione
   */
  const getMVPLeaderboard = () => {
    const mvpCount = {};
    
    // Conta quante volte ogni giocatore √® stato MVP
    matches.forEach(match => {
      if (match.mvp && match.risultato) { // Solo partite con risultato
        mvpCount[match.mvp] = (mvpCount[match.mvp] || 0) + 1;
      }
    });
    
    // Converti in array e ordina
    return Object.entries(mvpCount)
      .map(([playerNum, count]) => {
        const player = players.find(p => p.numero === parseInt(playerNum));
        return {
          playerNum: parseInt(playerNum),
          playerName: player?.nome || 'Sconosciuto',
          playerPhoto: player?.foto || '',
          mvpCount: count
        };
      })
      .sort((a, b) => b.mvpCount - a.mvpCount);
  };
  
  /**
   * Ottiene il numero di MVP per un giocatore specifico
   */
  const getPlayerMVPCount = (playerNum) => {
    return matches.filter(m => m.mvp === playerNum && m.risultato).length;
  };

  /**
   * Esporta la classifica campionato in PDF
   */
  const exportClassificaPDF = () => {
    if (squadreGirone.length === 0) {
      alert('Nessuna squadra presente nella classifica');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Titolo
    doc.setFontSize(20);
    doc.text('CLASSIFICA CAMPIONATO', 105, 20, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Stagione 2024/2025', 105, 28, { align: 'center' });
    
    // Data generazione
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}`, 105, 34, { align: 'center' });
    doc.setTextColor(0, 0, 0);
    
    let yPosition = 42;
    
    // Calcola classifica
    const classifica = squadreGirone.map(sq => {
      let punti = 0, giocate = 0, vinte = 0, pareggiate = 0, perse = 0, golFatti = 0, golSubiti = 0;
      
      risultatiCampionato.forEach(giornata => {
        giornata.partite.forEach(partita => {
          if (!partita.giocata) return;  // Solo partite giocate
          
          if (partita.squadraCasa === sq.nome) {
            giocate++;
            golFatti += partita.golCasa;
            golSubiti += partita.golTrasferta;
            if (partita.golCasa > partita.golTrasferta) {
              punti += 3;
              vinte++;
            } else if (partita.golCasa === partita.golTrasferta) {
              punti += 1;
              pareggiate++;
            } else {
              perse++;
            }
          } else if (partita.squadraTrasferta === sq.nome) {
            giocate++;
            golFatti += partita.golTrasferta;
            golSubiti += partita.golCasa;
            if (partita.golTrasferta > partita.golCasa) {
              punti += 3;
              vinte++;
            } else if (partita.golTrasferta === partita.golCasa) {
              punti += 1;
              pareggiate++;
            } else {
              perse++;
            }
          }
        });
      });
      
      return { 
        nome: sq.nome, 
        punti, 
        giocate, 
        vinte, 
        pareggiate, 
        perse, 
        golFatti, 
        golSubiti, 
        diffReti: golFatti - golSubiti 
      };
    }).sort((a, b) => {
      if (b.punti !== a.punti) return b.punti - a.punti;
      if (b.diffReti !== a.diffReti) return b.diffReti - a.diffReti;
      return b.golFatti - a.golFatti;
    });
    
    // Tabella classifica
    const tableData = classifica.map((sq, idx) => {
      const pos = (idx + 1).toString();
      
      return [
        pos,
        sq.nome,
        sq.punti,
        sq.giocate,
        sq.vinte,
        sq.pareggiate,
        sq.perse,
        sq.golFatti,
        sq.golSubiti,
        (sq.diffReti > 0 ? '+' : '') + sq.diffReti
      ];
    });
    
    doc.autoTable({
      startY: yPosition,
      head: [['Pos', 'Squadra', 'Pt', 'G', 'V', 'P', 'S', 'GF', 'GS', 'DR']],
      body: tableData,
      theme: 'grid',
      headStyles: { 
        fillColor: [59, 130, 246],
        fontSize: 10,
        fontStyle: 'bold',
        halign: 'center'
      },
      bodyStyles: { 
        fontSize: 9 
      },
      columnStyles: {
        0: { halign: 'center', cellWidth: 15 },
        1: { halign: 'left', cellWidth: 60 },
        2: { halign: 'center', fontStyle: 'bold', cellWidth: 12 },
        3: { halign: 'center', cellWidth: 10 },
        4: { halign: 'center', cellWidth: 10 },
        5: { halign: 'center', cellWidth: 10 },
        6: { halign: 'center', cellWidth: 10 },
        7: { halign: 'center', cellWidth: 12 },
        8: { halign: 'center', cellWidth: 12 },
        9: { halign: 'center', cellWidth: 15 }
      },
      didParseCell: function(data) {
        if (data.section === 'body') {
          // Evidenzia primo posto
          if (data.row.index === 0) {
            data.cell.styles.fillColor = [254, 243, 199]; // giallo chiaro
          }
          // Evidenzia podio
          else if (data.row.index <= 2) {
            data.cell.styles.fillColor = [219, 234, 254]; // azzurro chiaro
          }
          // Evidenzia zona retrocessione
          else if (data.row.index >= classifica.length - 2) {
            data.cell.styles.fillColor = [254, 226, 226]; // rosso chiaro
          }
        }
      }
    });
    
    yPosition = doc.lastAutoTable.finalY + 10;
    
    // Statistiche Aggregate
    if (risultatiCampionato.some(g => g.partite.some(p => p.giocata))) {
      doc.setFontSize(14);
      doc.text('STATISTICHE CAMPIONATO', 15, yPosition);
      yPosition += 8;
      
      // Capocannoniere
      const golPerSquadra = {};
      risultatiCampionato.forEach(giornata => {
        giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                        if (!golPerSquadra[partita.squadraCasa]) golPerSquadra[partita.squadraCasa] = 0;
          if (!golPerSquadra[partita.squadraTrasferta]) golPerSquadra[partita.squadraTrasferta] = 0;
          golPerSquadra[partita.squadraCasa] += partita.golCasa;
          golPerSquadra[partita.squadraTrasferta] += partita.golTrasferta;
        });
      });
      
      const topScorer = Object.entries(golPerSquadra)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
      
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text('MIGLIOR ATTACCO:', 15, yPosition);
      doc.setFont(undefined, 'normal');
      yPosition += 5;
      
      topScorer.forEach(([squadra, gol], idx) => {
        doc.setFontSize(9);
        const pos = `${idx + 1}¬∞`;
        doc.text(`${pos} ${squadra}: ${gol} gol`, 20, yPosition);
        yPosition += 5;
      });
      
      yPosition += 3;
      
      // Miglior difesa
      const golSubitiPerSquadra = {};
      risultatiCampionato.forEach(giornata => {
        giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                        if (!golSubitiPerSquadra[partita.squadraCasa]) golSubitiPerSquadra[partita.squadraCasa] = 0;
          if (!golSubitiPerSquadra[partita.squadraTrasferta]) golSubitiPerSquadra[partita.squadraTrasferta] = 0;
          golSubitiPerSquadra[partita.squadraCasa] += partita.golTrasferta;
          golSubitiPerSquadra[partita.squadraTrasferta] += partita.golCasa;
        });
      });
      
      const bestDefense = Object.entries(golSubitiPerSquadra)
        .sort((a, b) => a[1] - b[1])
        .slice(0, 3);
      
      doc.setFont(undefined, 'bold');
      doc.text('MIGLIOR DIFESA:', 15, yPosition);
      doc.setFont(undefined, 'normal');
      yPosition += 5;
      
      bestDefense.forEach(([squadra, gol], idx) => {
        doc.setFontSize(9);
        const pos = `${idx + 1}¬∞`;
        doc.text(`${pos} ${squadra}: ${gol} gol subiti`, 20, yPosition);
        yPosition += 5;
      });
      
      // Se c'√® spazio, aggiungi rendimento casa/trasferta
      if (yPosition < 240) {
        yPosition += 3;
        
        // Rendimento casa
        const puntiCasa = {};
        risultatiCampionato.forEach(giornata => {
          giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                          if (!puntiCasa[partita.squadraCasa]) puntiCasa[partita.squadraCasa] = 0;
            if (partita.golCasa > partita.golTrasferta) puntiCasa[partita.squadraCasa] += 3;
            else if (partita.golCasa === partita.golTrasferta) puntiCasa[partita.squadraCasa] += 1;
          });
        });
        
        const topCasa = Object.entries(puntiCasa)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3);
        
        doc.setFont(undefined, 'bold');
        doc.text('RENDIMENTO CASA:', 15, yPosition);
        doc.setFont(undefined, 'normal');
        yPosition += 5;
        
        topCasa.forEach(([squadra, punti], idx) => {
          doc.setFontSize(9);
          const pos = `${idx + 1}¬∞`;
          doc.text(`${pos} ${squadra}: ${punti} punti`, 20, yPosition);
          yPosition += 5;
        });
        
        yPosition += 3;
        
        // Rendimento trasferta
        const puntiTrasferta = {};
        risultatiCampionato.forEach(giornata => {
          giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                          if (!puntiTrasferta[partita.squadraTrasferta]) puntiTrasferta[partita.squadraTrasferta] = 0;
            if (partita.golTrasferta > partita.golCasa) puntiTrasferta[partita.squadraTrasferta] += 3;
            else if (partita.golTrasferta === partita.golCasa) puntiTrasferta[partita.squadraTrasferta] += 1;
          });
        });
        
        const topTrasferta = Object.entries(puntiTrasferta)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3);
        
        doc.setFont(undefined, 'bold');
        doc.text('RENDIMENTO TRASFERTA:', 15, yPosition);
        doc.setFont(undefined, 'normal');
        yPosition += 5;
        
        topTrasferta.forEach(([squadra, punti], idx) => {
          doc.setFontSize(9);
          const pos = `${idx + 1}¬∞`;
          doc.text(`${pos} ${squadra}: ${punti} punti`, 20, yPosition);
          yPosition += 5;
        });
      }
    }
    
    // Aggiungi footer
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.text(`Pagina ${i} di ${pageCount}`, 105, 290, { align: 'center' });
      doc.text('Generato da Moreschi Roberto Gestionale Calcio', 105, 285, { align: 'center' });
    }
    
    // Salva PDF
    doc.save(`Classifica_Campionato_${new Date().toLocaleDateString('it-IT').replace(/\//g, '-')}.pdf`);
    showToast('PDF classifica generato!', 'success');
  };

  // ========== GESTIONE DISPOSITIVI E AUTO-SYNC ==========
  
  /**
   * Genera ID univoco dispositivo
   */
  const generateDeviceId = () => {
    let id = localStorage.getItem('uniqueDeviceId');
    if (!id) {
      id = 'device-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('uniqueDeviceId', id);
    }
    return id;
  };

  /**
   * Rileva nome dispositivo dal user agent
   */
  const getDeviceName = () => {
    const ua = navigator.userAgent;
    if (ua.match(/iPad/i) || ua.match(/Android.*Tablet/i)) return "Tablet";
    if (ua.match(/Mobile|iPhone|Android/i)) return "Mobile";
    return "PC";
  };

  /**
   * Salva configurazione dispositivo
   */
  const saveDeviceConfig = (role) => {
    const config = {
      deviceId: generateDeviceId(),
      deviceName: getDeviceName(),
      deviceRole: role,
      autoSyncEnabled: false, // SEMPRE disabilitato per sicurezza - l'utente pu√≤ abilitarlo manualmente
      lastAskedDate: new Date().toISOString().split('T')[0],
      createdAt: new Date().toISOString()
    };
    
    localStorage.setItem('deviceConfig', JSON.stringify(config));
    setDeviceRole(role);
    
    if (role === 'primary') {
      startAutoSync();
      showToast('‚úÖ Dispositivo configurato come Principale - Auto-sync attivo', 'success');
    } else {
      showToast('‚úÖ Dispositivo configurato come Secondario - Sync manuale', 'info');
    }
  };

  /**
   * Carica configurazione dispositivo
   */
  const loadDeviceConfig = () => {
    const stored = localStorage.getItem('deviceConfig');
    if (!stored) return null;
    
    const config = JSON.parse(stored);
    
    // Check se chiesto oggi
    const today = new Date().toISOString().split('T')[0];
    if (config.lastAskedDate !== today) {
      return null; // Richiedi conferma ogni giorno
    }
    
    return config;
  };

  /**
   * Avvia auto-sync ogni 2 minuti
   */
  const startAutoSync = () => {
    // Clear esistente se presente
    if (autoSyncInterval) {
      clearInterval(autoSyncInterval);
    }
    
    // Primo sync immediato
    performAutoSync();
    
    // Poi ogni 2 minuti (120000 ms)
    const interval = setInterval(() => {
      performAutoSync();
    }, 120000);
    
    setAutoSyncInterval(interval);
  };

  /**
   * Stop auto-sync
   */
  const stopAutoSync = () => {
    if (autoSyncInterval) {
      clearInterval(autoSyncInterval);
      setAutoSyncInterval(null);
      showToast('‚è∏Ô∏è Auto-sync disattivato', 'info');
    }
  };

  /**
   * Esegui sync automatico (silenzioso)
   */
  const performAutoSync = async () => {
    if (!user || userRole !== 'admin') return;
    
    try {
      // Backup locale prima del sync
      await createLocalBackup();
      
      // Salva su cloud
      await saveDataToCloud(true); // true = silent mode
      
      // Aggiorna timestamp
      updateLastSyncInfo('auto');
      
    } catch (error) {
      console.error('Auto-sync error:', error);
      // Non mostrare toast per errori auto-sync (troppo invasivo)
    }
  };

  /**
   * Pulisce ricorsivamente tutti i campi undefined da un oggetto
   * Firestore non accetta undefined, solo null o valori definiti
   */
  const cleanUndefinedFields = (obj) => {
    if (obj === null || obj === undefined) return null;
    
    if (Array.isArray(obj)) {
      return obj.map(item => cleanUndefinedFields(item));
    }
    
    if (typeof obj === 'object') {
      const cleaned = {};
      Object.keys(obj).forEach(key => {
        const value = obj[key];
        if (value !== undefined) {
          cleaned[key] = cleanUndefinedFields(value);
        }
      });
      return cleaned;
    }
    
    return obj;
  };

  /**
   * Salva dati su cloud Firebase
   */
  const saveDataToCloud = async (silent = false) => {
    if (!user) {
      console.error('‚ùå saveDataToCloud: user non presente');
      return;
    }
    
    if (!teamId) {
      console.error('‚ùå saveDataToCloud: teamId non presente');
      return;
    }
    
    try {
      console.log('üì§ Inizio preparazione dati per Firebase...', {
        userId: user.uid,
        teamId: teamId,
        saveLocation: `teamData/${teamId}`
      });
      
      // ‚úÖ Assicura che tutti i giocatori abbiano il campo fuoriRosa
      const playersWithFuoriRosa = players.map(p => ({
        ...p,
        fuoriRosa: p.fuoriRosa || false // Default false se undefined
      }));
      
      const data = {
        players: playersWithFuoriRosa,
        trainings,
        matches,
        injuries,
        squadreGirone,        // ‚úÖ AGGIUNTO: Squadre del girone
        risultatiCampionato,  // ‚úÖ AGGIUNTO: Risultati campionato
        timestamp: new Date().toISOString(),
        deviceId: generateDeviceId(),
        deviceName: getDeviceName(),
        deviceRole: deviceRole
      };
      
      // Log dettagliato per debug
      console.log('üíæ Salvataggio su cloud:', {
        players: playersWithFuoriRosa.length,
        trainings: trainings.length,
        matches: matches.length,
        injuries: injuries.length,
        squadreGirone: squadreGirone.length,
        risultatiCampionato: risultatiCampionato.length,
        fuoriRosa: playersWithFuoriRosa.filter(p => p.fuoriRosa).length,
        timestamp: data.timestamp
      });
      
      // CRITICAL: Pulisci tutti gli undefined prima di salvare su Firestore
      const cleanedData = cleanUndefinedFields(data);
      
      console.log('üßπ Dati puliti, invio a Firebase...');
      // ‚ö†Ô∏è USA TEAMID invece di user.uid
      await db.collection('teamData').doc(teamId).set(cleanedData);
      console.log('‚úÖ Firebase set() completato con successo!');
      
      if (!silent) {
        showToast('‚úÖ Dati salvati su cloud!', 'success');
      }
      
      updateLastSyncInfo('manual');
      
    } catch (error) {
      console.error('‚ùå ERRORE SALVATAGGIO CLOUD:', error);
      console.error('Dettagli errore:', {
        message: error.message,
        code: error.code,
        stack: error.stack
      });
      if (!silent) {
        showToast('‚ùå Errore salvataggio: ' + error.message, 'error');
      }
      throw error; // Rilancia per gestione in handleExitWithSave
    }
  };

  /**
   * Carica dati da cloud Firebase
   */
  const loadDataFromCloud = async (skipConfirm = false, explicitUser = null, explicitTeamId = null) => {
    const userToUse = explicitUser || user;
    const teamIdToUse = explicitTeamId || teamId;
    
    if (!userToUse) {
      console.error('‚ùå loadDataFromCloud: user non presente');
      return;
    }
    
    if (!teamIdToUse) {
      console.error('‚ùå loadDataFromCloud: teamId non presente');
      return;
    }
    
    try {
      console.log('üì° Inizio caricamento da Firebase...', {
        userId: userToUse.uid,
        teamId: teamIdToUse,
        loadLocation: `teamData/${teamIdToUse}`,
        skipConfirm: skipConfirm,
        userSource: explicitUser ? 'explicit' : 'state'
      });
      
      // ‚ö†Ô∏è USA TEAMID invece di user.uid
      const doc = await db.collection('teamData').doc(teamIdToUse).get();
      
      console.log('üìÑ Documento Firebase ricevuto:', {
        exists: doc.exists,
        id: doc.id
      });
      
      if (!doc.exists) {
        console.warn('‚ö†Ô∏è NESSUN DOCUMENTO SU FIREBASE!');
        showToast('‚ÑπÔ∏è Nessun dato nel cloud', 'info');
        return;
      }
      
      const data = doc.data();
      
      // Log dettagliato per debug
      console.log('üì• Caricamento da cloud:', {
        players: (data.players || []).length,
        trainings: (data.trainings || []).length,
        matches: (data.matches || []).length,
        injuries: (data.injuries || []).length,
        squadreGirone: (data.squadreGirone || []).length,
        risultatiCampionato: (data.risultatiCampionato || []).length,
        fuoriRosa: (data.players || []).filter(p => p.fuoriRosa).length,
        timestamp: data.timestamp,
        deviceId: data.deviceId,
        deviceName: data.deviceName
      });
      
      // Warning se sync da altro dispositivo recente (SOLO se non skipConfirm)
      if (!skipConfirm && data.deviceId && data.deviceId !== generateDeviceId()) {
        const timeDiff = Math.abs(new Date() - new Date(data.timestamp));
        const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
        
        const confirm = window.confirm(
          `‚ö†Ô∏è ATTENZIONE\n\n` +
          `Ultimo sync da: ${data.deviceName || 'Altro dispositivo'}\n` +
          `Quando: ${new Date(data.timestamp).toLocaleString('it-IT')} (${hoursDiff}h fa)\n\n` +
          `Scaricare questi dati?\n` +
          `(Sovrascriver√† eventuali modifiche locali non salvate)`
        );
        
        if (!confirm) return;
      }
      
      // Backup prima di sovrascrivere
      await createLocalBackup();
      
      // ‚úÖ Normalizza giocatori con campo fuoriRosa
      const normalizedPlayers = (data.players || []).map(p => ({
        ...p,
        fuoriRosa: p.fuoriRosa || false
      }));
      
      // Carica dati
      if (data.players) setPlayers(normalizedPlayers);
      if (data.trainings) setTrainings(data.trainings);
      if (data.matches) setMatches(data.matches);
      if (data.injuries) setInjuries(data.injuries);
      if (data.squadreGirone) setSquadreGirone(data.squadreGirone);              // ‚úÖ AGGIUNTO
      if (data.risultatiCampionato) setRisultatiCampionato(data.risultatiCampionato);  // ‚úÖ AGGIUNTO
      
      // Log DOPO aver settato gli state
      console.log('‚úÖ State AGGIORNATI dopo caricamento cloud:', {
        players: normalizedPlayers.length,
        injuries: (data.injuries || []).length,
        injuriesData: data.injuries || [],
        playersWithFuoriRosa: normalizedPlayers.filter(p => p.fuoriRosa).length,
        fuoriRosaData: normalizedPlayers.filter(p => p.fuoriRosa).map(p => ({ numero: p.numero, nome: p.nome, fuoriRosa: p.fuoriRosa }))
      });
      
      // Salva anche in IndexedDB
      await saveToIndexedDB('teamData', {
        players: normalizedPlayers,
        trainings: data.trainings || [],
        matches: data.matches || [],
        injuries: data.injuries || [],
        squadreGirone: data.squadreGirone || [],              // ‚úÖ AGGIUNTO
        risultatiCampionato: data.risultatiCampionato || []   // ‚úÖ AGGIUNTO
      });
      
      showToast('‚úÖ Dati caricati da cloud!', 'success');
      updateLastSyncInfo(skipConfirm ? 'auto' : 'manual');
      
    } catch (error) {
      console.error('Errore caricamento cloud:', error);
      showToast('‚ùå Errore caricamento: ' + error.message, 'error');
    }
  };

  /**
   * Aggiorna info ultimo sync
   */
  const updateLastSyncInfo = (type) => {
    const info = {
      timestamp: new Date().toISOString(),
      type: type, // 'auto' | 'manual'
      deviceId: generateDeviceId(),
      deviceName: getDeviceName()
    };
    
    setLastSyncInfo(info);
    localStorage.setItem('lastSyncInfo', JSON.stringify(info));
  };

  /**
   * Carica info ultimo sync
   */
  const loadLastSyncInfo = () => {
    const stored = localStorage.getItem('lastSyncInfo');
    if (stored) {
      setLastSyncInfo(JSON.parse(stored));
    }
  };

  /**
   * Crea backup locale
   */
  const createLocalBackup = async () => {
    const backup = {
      players,
      trainings,
      matches,
      injuries,
      timestamp: new Date().toISOString()
    };
    
    // Salva in localStorage (max 5 backup)
    let backups = JSON.parse(localStorage.getItem('localBackups') || '[]');
    backups.unshift(backup);
    backups = backups.slice(0, 5); // Keep only last 5
    
    localStorage.setItem('localBackups', JSON.stringify(backups));
  };

  const exportToJSON = () => {
    const data = {
      players,
      trainings,
      matches,
      appTitle,
      teamLogo,
      exportDate: new Date().toISOString()
    };
    const jsonString = JSON.stringify(data, null, 2);
    
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `real-dor-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    alert('‚úÖ File JSON scaricato con successo! Conservalo come backup di sicurezza.');
  };

  const handleFileImport = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        
        if (!data.players || !data.trainings || !data.matches) {
          alert('‚ùå File JSON non valido! Assicurati di aver selezionato il file corretto.');
          return;
        }
        
        setPlayers(data.players);
        setTrainings(data.trainings);
        setMatches(data.matches);
        if (data.appTitle) setAppTitle(data.appTitle);
        if (data.teamLogo) setTeamLogo(data.teamLogo);
        
        alert('‚úÖ Dati importati con successo!');
        event.target.value = '';
      } catch (error) {
        alert('‚ùå Errore nel caricamento del file! Verifica che sia un file JSON valido.');
        event.target.value = '';
      }
    };
    reader.onerror = () => {
      alert('‚ùå Errore nella lettura del file. Riprova.');
      event.target.value = '';
    };
    reader.readAsText(file);
  };

  const handleManualImport = () => {
    try {
      const data = JSON.parse(manualImportData);
      
      if (!data.players || !data.trainings || !data.matches) {
        alert('‚ùå File JSON non valido! Assicurati di aver copiato tutto il contenuto correttamente.');
        return;
      }
      
      setPlayers(data.players);
      setTrainings(data.trainings);
      setMatches(data.matches);
      if (data.appTitle) setAppTitle(data.appTitle);
      if (data.teamLogo) setTeamLogo(data.teamLogo);
      
      setShowManualImport(false);
      setManualImportData('');
      alert('‚úÖ Dati importati con successo!');
    } catch (error) {
      alert('‚ùå Errore nel parsing del JSON! Verifica che il formato sia corretto.');
    }
  };

  // ========== FUNZIONI DI RESET DATABASE ==========
  
  const resetStagione = async () => {
    const conferma1 = window.confirm('‚ö†Ô∏è ATTENZIONE! Questa operazione canceller√†:\n\n‚úì Tutti gli allenamenti\n‚úì Tutte le partite\n‚úì Tutte le statistiche\n\n‚úÖ MA manterr√†:\n‚úì La rosa giocatori\n‚úì Il logo della squadra\n\nVuoi continuare?');
    
    if (!conferma1) return;
    
    const conferma2 = window.confirm('üî¥ ULTIMA CONFERMA!\n\nSei sicuro di voler resettare la stagione?\nQuesta azione NON pu√≤ essere annullata!');
    
    if (!conferma2) return;
    
    try {
      // Cancello solo allenamenti e partite
      setTrainings([]);
      setMatches([]);
      setExpandedTrainings({});
      setModuloTattico({});
      setModuloAvversarioState({});
      setAnalisiSelezionata({});
      setConvocati(new Set());
      
      // Salvo i dati resettati
      await saveToIndexedDB('trainings', []);
      await saveToIndexedDB('matches', []);
      
      alert('‚úÖ Stagione resettata con successo!\n\nLa rosa giocatori √® stata mantenuta.');
    } catch (error) {
      console.error('Errore durante il reset:', error);
      alert('‚ùå Errore durante il reset. Riprova.');
    }
  };
  
  const resetCompleto = async () => {
    const conferma1 = window.confirm('üî¥ ATTENZIONE! RESET COMPLETO!\n\nQuesta operazione canceller√† TUTTO:\n\n‚úì Tutti i giocatori\n‚úì Tutti gli allenamenti\n‚úì Tutte le partite\n‚úì Tutte le statistiche\n‚úì Il logo della squadra\n‚úì Tutti i dati dell\'app\n\nVuoi continuare?');
    
    if (!conferma1) return;
    
    const conferma2 = window.confirm('üî¥üî¥ ULTIMA CONFERMA! üî¥üî¥\n\nSei ASSOLUTAMENTE SICURO?\nQuesta azione NON pu√≤ essere annullata!\n\nTUTTO verr√† cancellato!');
    
    if (!conferma2) return;
    
    const conferma3 = window.confirm('Scrivi OK per confermare il reset completo\n\n(Annulla per tornare indietro)');
    
    if (!conferma3) return;
    
    try {
      // Cancello tutto
      setPlayers([]);
      setTrainings([]);
      setMatches([]);
      setTeamLogo(null);
      setInfortunati(new Set());
      setExpandedTrainings({});
      setModuloTattico({});
      setModuloAvversarioState({});
      setAnalisiSelezionata({});
      setConvocati(new Set());
      
      // Cancello dal database
      const db = await initDB();
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const store = transaction.objectStore(STORE_NAME);
      await store.clear();
      
      alert('‚úÖ Database resettato completamente!\n\nL\'applicazione √® ora come nuova.');
      
      // Ricarico la pagina per stato pulito
      window.location.reload();
    } catch (error) {
      console.error('Errore durante il reset completo:', error);
      alert('‚ùå Errore durante il reset completo. Riprova.');
    }
  };

  // ============================================
  // FUNZIONI DI SINCRONIZZAZIONE CLOUD
  // ============================================
  
  /**
   * Sincronizza i dati LOCALI ‚Üí CLOUD (Upload)
   */
  const syncToFirestore = async () => {
    if (!user) {
      setSyncError('Devi essere autenticato per sincronizzare');
      return false;
    }

    try {
      setSyncStatus('syncing');
      setSyncError('');

      // ‚úÖ Assicura che tutti i giocatori abbiano il campo fuoriRosa
      const playersWithFuoriRosa = players.map(p => ({
        ...p,
        fuoriRosa: p.fuoriRosa || false // Default false se undefined
      }));

      const dataToSync = {
        players: playersWithFuoriRosa,
        trainings,
        matches,
        appTitle,
        teamLogo,
        injuries,
        squadreGirone,
        risultatiCampionato,
        lastSynced: new Date().toISOString(),
        userId: user.uid
      };

      // CRITICAL: Pulisci tutti gli undefined prima di salvare su Firestore
      const cleanedData = cleanUndefinedFields(dataToSync);

      // Salva su Firestore (con Storage, le foto sono URL quindi documento leggero)
      await db.collection('teamData').doc(user.uid).set(cleanedData, { merge: true });
      
      setLastSynced(new Date());
      setSyncStatus('success');
      
      // Toast di conferma con dettagli
      const totale = (players?.length || 0) + (trainings?.length || 0) + (matches?.length || 0);
      const playersWithPhotos = players.filter(p => p.foto).length;
      const photosOnStorage = players.filter(p => p.foto && p.foto.startsWith('https://')).length;
      showToast(
        `‚úÖ Dati caricati sul cloud!\nüìä ${players?.length || 0} giocatori (${playersWithPhotos} con foto, ${photosOnStorage} su Storage), ${trainings?.length || 0} allenamenti, ${matches?.length || 0} partite`,
        'success',
        5000
      );
      
      // Reset stato dopo 3 secondi
      setTimeout(() => setSyncStatus('idle'), 3000);
      
      return true;
    } catch (error) {
      console.error('Errore sincronizzazione su cloud:', error);
      setSyncError('Errore durante la sincronizzazione: ' + error.message);
      setSyncStatus('error');
      return false;
    }
  };

  /**
   * Carica i dati CLOUD ‚Üí LOCALE (Download)
   */
  const syncFromFirestore = async (forceOverwrite = false) => {
    console.log('üîΩ SCARICA DA CLOUD - Inizio');
    console.log('   User:', user?.email);
    console.log('   User UID:', user?.uid);
    console.log('   Force Overwrite:', forceOverwrite);
    
    if (!user) {
      console.log('‚ùå ERRORE: Nessun user autenticato');
      setSyncError('Devi essere autenticato per sincronizzare');
      return false;
    }

    try {
      setSyncStatus('syncing');
      setSyncError('');
      
      console.log('üì° Connessione a Firestore...');
      const docRef = db.collection('teamData').doc(user.uid);
      const doc = await docRef.get();
      
      console.log('üìÑ Documento esistente?', doc.exists);

      if (!doc.exists) {
        console.log('‚ùå ERRORE: Nessun dato nel cloud');
        setSyncError('Nessun dato trovato nel cloud. Effettua prima un upload.');
        setSyncStatus('error');
        return false;
    }

      const cloudData = doc.data();
      console.log('‚òÅÔ∏è Dati cloud ricevuti:', {
        hasPlayers: !!cloudData.players,
        playersCount: cloudData.players?.length,
        hasTrainings: !!cloudData.trainings,
        trainingsCount: cloudData.trainings?.length,
        hasMatches: !!cloudData.matches,
        matchesCount: cloudData.matches?.length,
        lastSynced: cloudData.lastSynced
      });
      
      // Verifica conflitti se non √® un overwrite forzato
      if (!forceOverwrite) {
        console.log('üîç Controllo conflitti (forceOverwrite=false)...');
        const hasLocalData = players.some(p => p.nome) || trainings.length > 0 || matches.length > 0;
        
        if (hasLocalData) {
          console.log('üìÅ Dati locali presenti, confronto date...');
          // Controlla se i dati locali sono pi√π recenti
          const localLastSaved = lastSaved ? new Date(lastSaved) : new Date(0);
          const cloudLastSynced = cloudData.lastSynced ? new Date(cloudData.lastSynced) : new Date(0);
          
          console.log('   Locale:', localLastSaved);
          console.log('   Cloud:', cloudLastSynced);
          
          if (localLastSaved > cloudLastSynced) {
            console.log('‚ö†Ô∏è CONFLITTO: Dati locali pi√π recenti! Mostro modal...');
            // Dati locali pi√π recenti - mostra dialogo conflitto
            setSyncConflicts({
              local: { 
                players, 
                trainings, 
                matches, 
                squadreGirone,            // ‚úÖ AGGIUNTO
                risultatiCampionato,      // ‚úÖ AGGIUNTO
                lastSaved: localLastSaved 
              },
              cloud: { 
                players: cloudData.players, 
                trainings: cloudData.trainings, 
                matches: cloudData.matches,
                squadreGirone: cloudData.squadreGirone || [],              // ‚úÖ AGGIUNTO
                risultatiCampionato: cloudData.risultatiCampionato || [],  // ‚úÖ AGGIUNTO
                lastSynced: cloudLastSynced 
              }
            });
            setShowConflictModal(true);
            setSyncStatus('idle');
            return false;
          }
        }
      } else {
        console.log('‚ö° Overwrite forzato, skip controllo conflitti');
      }

      // Carica i dati dal cloud
      console.log('üì• Caricamento dati dal cloud in stato React...');
      
      // ‚úÖ Normalizza giocatori con campo fuoriRosa
      let normalizedPlayers = [];
      if (cloudData.players) {
        console.log('   ‚úÖ Carico Players:', cloudData.players.length);
        normalizedPlayers = cloudData.players.map(p => ({
          ...p,
          fuoriRosa: p.fuoriRosa || false
        }));
        setPlayers(normalizedPlayers);
      }
      
      if (cloudData.trainings) {
        console.log('   ‚úÖ Carico Trainings:', cloudData.trainings.length);
        setTrainings(cloudData.trainings);
      }
      if (cloudData.matches) {
        console.log('   ‚úÖ Carico Matches:', cloudData.matches.length);
        setMatches(cloudData.matches);
      }
      if (cloudData.appTitle) setAppTitle(cloudData.appTitle);
      if (cloudData.teamLogo) setTeamLogo(cloudData.teamLogo);
      if (cloudData.injuries) {
        console.log('   ‚úÖ Carico Injuries:', cloudData.injuries.length);
        setInjuries(cloudData.injuries);
      }
      if (cloudData.squadreGirone) {
        console.log('   ‚úÖ Carico Squadre Girone:', cloudData.squadreGirone.length);
        setSquadreGirone(cloudData.squadreGirone);
      }
      if (cloudData.risultatiCampionato) {
        console.log('   ‚úÖ Carico Risultati Campionato:', cloudData.risultatiCampionato.length);
        setRisultatiCampionato(cloudData.risultatiCampionato);
      }
      
      setLastSynced(new Date(cloudData.lastSynced));
      setSyncStatus('success');
      
      console.log('‚úÖ SCARICA COMPLETATO con successo!');
      
      // Toast di conferma con dettagli
      const totale = (cloudData.players?.length || 0) + 
                     (cloudData.trainings?.length || 0) + 
                     (cloudData.matches?.length || 0);
      showToast(
        `‚úÖ Dati scaricati dal cloud!\nüìä ${cloudData.players?.length || 0} giocatori, ${cloudData.trainings?.length || 0} allenamenti, ${cloudData.matches?.length || 0} partite`,
        'success',
        5000
      );
      
      // Salva anche in locale
      const dataToSave = {
        players: normalizedPlayers.length > 0 ? normalizedPlayers : cloudData.players,
        trainings: cloudData.trainings,
        matches: cloudData.matches,
        appTitle: cloudData.appTitle,
        teamLogo: cloudData.teamLogo,
        injuries: cloudData.injuries || [],
        squadreGirone: cloudData.squadreGirone || [],
        risultatiCampionato: cloudData.risultatiCampionato || [],
        lastSaved: new Date().toISOString()
      };
      await saveToIndexedDB('squadraRealDOR', dataToSave);
      
      // Reset stato dopo 3 secondi
      setTimeout(() => setSyncStatus('idle'), 3000);
      
      // Redirect automatico alla dashboard dopo 2 secondi per vedere i dati
      setTimeout(() => {
        console.log('üîÑ Redirect automatico alla dashboard...');
        setActiveTab('dashboard');
      }, 2000);
      
      return true;
    } catch (error) {
      console.error('Errore caricamento da cloud:', error);
      setSyncError('Errore durante il caricamento: ' + error.message);
      setSyncStatus('error');
      return false;
    }
  };

  /**
   * Sincronizzazione bidirezionale intelligente
   */
  const smartSync = async () => {
    if (!user) {
      setSyncError('Devi essere autenticato per sincronizzare');
      return false;
    }

    try {
      setSyncStatus('syncing');
      setSyncError('');

      // PROTEZIONE: Conta dati locali
      const localPlayersCount = players.filter(p => p.nome).length;
      const localTrainingsCount = trainings.length;
      const localMatchesCount = matches.length;
      const hasLocalData = localPlayersCount > 0 || localTrainingsCount > 0 || localMatchesCount > 0;

      // Recupera dati dal cloud
      const docRef = db.collection('teamData').doc(user.uid);
      const doc = await docRef.get();

      if (!doc.exists) {
        // Nessun dato nel cloud
        if (hasLocalData) {
          // Abbiamo dati locali, possiamo uploadare
          return await syncToFirestore();
        } else {
          // Nessun dato n√© locale n√© cloud
          setSyncError('Nessun dato disponibile. Inizia inserendo giocatori o partite.');
          setSyncStatus('error');
          return false;
        }
      }

      const cloudData = doc.data();
      const cloudPlayersCount = (cloudData.players || []).filter(p => p.nome).length;
      const cloudTrainingsCount = (cloudData.trainings || []).length;
      const cloudMatchesCount = (cloudData.matches || []).length;
      const hasCloudData = cloudPlayersCount > 0 || cloudTrainingsCount > 0 || cloudMatchesCount > 0;

      // PROTEZIONE CRITICA: Non sovrascrivere MAI cloud pieno con locale vuoto!
      if (hasCloudData && !hasLocalData) {
        console.log('‚ö†Ô∏è PROTEZIONE: Database locale vuoto, scarico da cloud invece di sovrascrivere!');
        showToast('‚¨áÔ∏è Database locale vuoto, scaricando da cloud...', 'info');
        return await syncFromFirestore(true); // Force download
      }

      const cloudLastSynced = cloudData.lastSynced ? new Date(cloudData.lastSynced) : new Date(0);
      const localLastSaved = lastSaved ? new Date(lastSaved) : new Date(0);

      // PROTEZIONE: Se locale vuoto ma cloud pieno, SEMPRE scarica
      if (!hasLocalData && hasCloudData) {
        console.log('‚¨áÔ∏è Database locale vuoto, scarico da cloud');
        return await syncFromFirestore(true);
      }

      // PROTEZIONE: Se dati molto diversi, chiedi conferma
      const dataDifferenceThreshold = 5; // Se differenza > 5 elementi, chiedi conferma
      const playersDiff = Math.abs(localPlayersCount - cloudPlayersCount);
      const trainingsDiff = Math.abs(localTrainingsCount - cloudTrainingsCount);
      const matchesDiff = Math.abs(localMatchesCount - cloudMatchesCount);
      
      if (playersDiff > dataDifferenceThreshold || trainingsDiff > dataDifferenceThreshold || matchesDiff > dataDifferenceThreshold) {
        // Grande differenza nei dati - mostra modal conflitto
        setSyncConflicts({
          local: { 
            players: players.filter(p => p.nome), 
            trainings, 
            matches, 
            lastSaved: localLastSaved 
          },
          cloud: { 
            players: cloudData.players || [], 
            trainings: cloudData.trainings || [], 
            matches: cloudData.matches || [], 
            lastSynced: cloudLastSynced 
          }
        });
        setShowConflictModal(true);
        setSyncStatus('idle');
        return false;
      }

      // Confronta timestamp (solo se dati simili)
      if (localLastSaved > cloudLastSynced) {
        // Locale pi√π recente ‚Üí Upload
        return await syncToFirestore();
      } else if (cloudLastSynced > localLastSaved) {
        // Cloud pi√π recente ‚Üí Download
        return await syncFromFirestore(false);
      } else {
        // Stesso timestamp - gi√† sincronizzato
        setSyncStatus('success');
        setLastSynced(new Date());
        setTimeout(() => setSyncStatus('idle'), 3000);
        return true;
      }
    } catch (error) {
      console.error('Errore smart sync:', error);
      setSyncError('Errore durante la sincronizzazione: ' + error.message);
      setSyncStatus('error');
      return false;
    }
  };

  /**
   * Risolvi conflitto - scegli quale versione mantenere
   */
  const resolveConflict = async (choice) => {
    if (choice === 'local') {
      // Mantieni locale e sovrascrivi cloud
      await syncToFirestore();
    } else if (choice === 'cloud') {
      // Mantieni cloud e sovrascrivi locale
      await syncFromFirestore(true);
    }
    
    setSyncConflicts(null);
    setShowConflictModal(false);
  };

  // ========== GESTIONE UTENTI ADMIN ==========
  
  /**
   * Carica lista utenti da Firebase Auth e Firestore
   */
  const loadAllUsers = async () => {
    if (userRole !== 'admin') {
      showToast('‚õî Solo gli admin possono gestire utenti', 'error');
      return;
    }

    setLoadingUsers(true);
    try {
      // Carica utenti da Firestore (contiene ruoli)
      const usersSnapshot = await db.collection('users').get();
      const usersData = [];
      
      usersSnapshot.forEach(doc => {
        usersData.push({
          uid: doc.id,
          ...doc.data()
        });
      });

      // Ordina per email
      usersData.sort((a, b) => (a.email || '').localeCompare(b.email || ''));
      
      setAllUsers(usersData);
      showToast(`‚úÖ Caricati ${usersData.length} utenti`, 'success');
    } catch (error) {
      console.error('Errore caricamento utenti:', error);
      showToast('‚ùå Errore caricamento utenti: ' + error.message, 'error');
    } finally {
      setLoadingUsers(false);
    }
  };

  /**
   * Crea nuovo utente
   * NOTA: Questa operazione fa logout dell'admin temporaneamente
   */
  const createNewUser = async () => {
    if (!newUserEmail || !newUserPassword) {
      showToast('‚ö†Ô∏è Email e password sono obbligatori', 'error');
      return;
    }

    if (newUserPassword.length < 6) {
      showToast('‚ö†Ô∏è Password deve essere almeno 6 caratteri', 'error');
      return;
    }

    if (!window.confirm(`Creare nuovo utente?\n\nEmail: ${newUserEmail}\nRuolo: ${newUserRole}\n\n‚ö†Ô∏è ATTENZIONE: Questa operazione ti far√† logout temporaneamente. Dovrai rifare login come admin dopo.`)) {
      return;
    }

    setUserActionLoading(true);
    
    try {
      // IMPORTANTE: Salva UID admin PRIMA che cambi
      const currentAdminUid = user.uid;
      const currentAdminEmail = user.email;
      
      // Crea nuovo utente (questo fa logout dell'admin e login del nuovo utente!)
      const userCredential = await auth.createUserWithEmailAndPassword(newUserEmail, newUserPassword);
      const newUser = userCredential.user;

      // CRITICO: Ora sei loggato come il NUOVO utente, non pi√π come admin!
      // Ma possiamo comunque scrivere perch√© usiamo l'UID che abbiamo appena creato
      
      // Salva ruolo in Firestore
      await db.collection('users').doc(newUser.uid).set({
        email: newUserEmail,
        role: newUserRole,
        createdAt: new Date().toISOString(),
        createdBy: currentAdminUid  // ‚Üê Usa UID admin salvato prima!
      });

      showToast('‚úÖ Utente creato! Rifai login come admin...', 'success');
      
      // Logout del nuovo utente
      await auth.signOut();
      
      // Chiudi modal
      setShowCreateUserModal(false);
      setNewUserEmail('');
      setNewUserPassword('');
      setNewUserRole('user');
      
      // L'admin dovr√† rifare login manualmente
      
    } catch (error) {
      console.error('Errore creazione utente:', error);
      let errorMsg = 'Errore creazione utente';
      if (error.code === 'auth/email-already-in-use') {
        errorMsg = 'Email gi√† in uso';
      } else if (error.code === 'auth/invalid-email') {
        errorMsg = 'Email non valida';
      } else if (error.code === 'auth/weak-password') {
        errorMsg = 'Password troppo debole';
      } else if (error.code === 'permission-denied') {
        errorMsg = 'Errore permessi Firestore. Controlla le regole!';
      }
      showToast('‚ùå ' + errorMsg, 'error');
    } finally {
      setUserActionLoading(false);
    }
  };

  /**
   * Cambia ruolo utente
   */
  const changeUserRole = async (userId, newRole) => {
    if (userRole !== 'admin') {
      showToast('‚õî Solo gli admin possono cambiare ruoli', 'error');
      return;
    }

    if (userId === user.uid) {
      showToast('‚ö†Ô∏è Non puoi cambiare il tuo stesso ruolo', 'error');
      return;
    }

    if (!window.confirm(`Cambiare ruolo a ${newRole}?`)) {
      return;
    }

    setUserActionLoading(true);
    try {
      await db.collection('users').doc(userId).update({
        role: newRole,
        updatedAt: new Date().toISOString(),
        updatedBy: user.uid
      });

      showToast('‚úÖ Ruolo aggiornato!', 'success');
      
      // Ricarica lista utenti
      await loadAllUsers();
      
    } catch (error) {
      console.error('Errore cambio ruolo:', error);
      showToast('‚ùå Errore cambio ruolo: ' + error.message, 'error');
    } finally {
      setUserActionLoading(false);
    }
  };

  /**
   * Invia email reset password a utente
   */
  const sendPasswordReset = async (userEmail) => {
    if (userRole !== 'admin') {
      showToast('‚õî Solo gli admin possono resettare password', 'error');
      return;
    }

    if (!window.confirm(`Inviare email di reset password a:\n${userEmail}?`)) {
      return;
    }

    setUserActionLoading(true);
    try {
      await auth.sendPasswordResetEmail(userEmail);
      showToast(`‚úÖ Email inviata a ${userEmail}`, 'success');
    } catch (error) {
      console.error('Errore invio email:', error);
      showToast('‚ùå Errore invio email: ' + error.message, 'error');
    } finally {
      setUserActionLoading(false);
    }
  };

  /**
   * Elimina utente
   * NOTA: Elimina solo da Firestore, non da Authentication
   * Per eliminare completamente serve Firebase Admin SDK (backend)
   */
  const deleteUser = async (userId, userEmail) => {
    if (userRole !== 'admin') {
      showToast('‚õî Solo gli admin possono eliminare utenti', 'error');
      return;
    }

    if (userId === user.uid) {
      showToast('‚ö†Ô∏è Non puoi eliminare te stesso!', 'error');
      return;
    }

    if (!window.confirm(`‚ö†Ô∏è ATTENZIONE!\n\nEliminare utente?\nEmail: ${userEmail}\n\nQuesta azione rimuover√† il ruolo da Firestore.\nPer eliminare completamente l'account, vai su Firebase Console ‚Üí Authentication.`)) {
      return;
    }

    setUserActionLoading(true);
    try {
      // Elimina documento da Firestore
      await db.collection('users').doc(userId).delete();

      showToast('‚úÖ Utente rimosso da Firestore', 'success');
      
      // Ricarica lista
      await loadAllUsers();
      
    } catch (error) {
      console.error('Errore eliminazione utente:', error);
      showToast('‚ùå Errore: ' + error.message, 'error');
    } finally {
      setUserActionLoading(false);
    }
  };

  // ========== SINCRONIZZAZIONE AUTOMATICA ==========
  
  // Sync automatico ogni 5 minuti se abilitato
  useEffect(() => {
    if (!autoSyncEnabled || !user) return;
    
    const interval = setInterval(async () => {
      console.log('üîÑ Sincronizzazione automatica...');
      await smartSync();
    }, 5 * 60 * 1000); // 5 minuti

    return () => clearInterval(interval);
  }, [autoSyncEnabled, user, players, trainings, matches, appTitle, teamLogo]);

  // NOTA: Sync al login RIMOSSO per sicurezza!
  // Era pericoloso perch√© poteva sovrascrivere cloud con database vuoto
  // Ora l'utente deve fare sync manuale cliccando "Scarica da Cloud"

  // ========== EXPORT PDF RISULTATI PARTITE ==========
  const exportResultsPDF = () => {
    if (matches.length === 0) {
      showToast('‚ö†Ô∏è Nessuna partita presente', 'warning');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Titolo
    doc.setFontSize(20);
    doc.text('RISULTATI PARTITE', 105, 20, { align: 'center' });
    doc.setFontSize(14);
    doc.text('Real DOR Under 18', 105, 28, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Stagione 2024/2025', 105, 35, { align: 'center' });
    
    // Data generazione
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')} alle ${new Date().toLocaleTimeString('it-IT')}`, 105, 41, { align: 'center' });
    doc.setTextColor(0, 0, 0);
    
    let yPosition = 50;
    
    // Prepara dati partite
    const matchesData = matches
      .filter(m => {
        const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        return golFatti > 0 || golSubiti > 0; // Solo partite completate
      })
      .sort((a, b) => new Date(a.data) - new Date(b.data)) // Ordina per data
      .map(m => {
        const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
        const risultato = golFatti > golSubiti ? 'V' : golFatti === golSubiti ? 'P' : 'S';
        
        return {
          data: new Date(m.data).toLocaleDateString('it-IT'),
          avversario: m.squadraCasa && m.squadraTrasferta 
            ? `${m.squadraCasa} vs ${m.squadraTrasferta}`
            : m.avversario || m.squadraTrasferta || 'Avversario',
          risultatoText: `${golFatti}-${golSubiti}`,
          risultato: risultato,
          luogo: m.luogo || '-',
          punti: risultato === 'V' ? 3 : risultato === 'P' ? 1 : 0
        };
      });
    
    // Statistiche riepilogative
    const totalePartite = matchesData.length;
    const vittorie = matchesData.filter(m => m.risultato === 'V').length;
    const pareggi = matchesData.filter(m => m.risultato === 'P').length;
    const sconfitte = matchesData.filter(m => m.risultato === 'S').length;
    const puntiTotali = matchesData.reduce((sum, m) => sum + m.punti, 0);
    
    // Box statistiche
    doc.setFillColor(240, 240, 240);
    doc.rect(15, yPosition, 180, 25, 'F');
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('STATISTICHE STAGIONE', 20, yPosition + 7);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Partite: ${totalePartite}`, 20, yPosition + 14);
    doc.text(`Vittorie: ${vittorie}`, 60, yPosition + 14);
    doc.text(`Pareggi: ${pareggi}`, 95, yPosition + 14);
    doc.text(`Sconfitte: ${sconfitte}`, 130, yPosition + 14);
    doc.text(`Punti: ${puntiTotali}`, 170, yPosition + 14);
    
    doc.setFontSize(9);
    doc.text(`% Vittorie: ${totalePartite > 0 ? ((vittorie / totalePartite) * 100).toFixed(1) : 0}%`, 20, yPosition + 21);
    doc.text(`Media Punti/Partita: ${totalePartite > 0 ? (puntiTotali / totalePartite).toFixed(2) : 0}`, 95, yPosition + 21);
    
    yPosition += 32;
    
    // Tabella risultati
    const tableData = matchesData.map(m => [
      m.data,
      m.avversario,
      m.risultatoText,
      m.risultato,
      m.luogo
    ]);
    
    doc.autoTable({
      startY: yPosition,
      head: [['Data', 'Partita', 'Risultato', 'Esito', 'Luogo']],
      body: tableData,
      theme: 'grid',
      headStyles: { 
        fillColor: [59, 130, 246],
        fontSize: 10,
        fontStyle: 'bold',
        halign: 'center'
      },
      bodyStyles: { 
        fontSize: 9 
      },
      columnStyles: {
        0: { halign: 'center', cellWidth: 25 },
        1: { halign: 'left', cellWidth: 70 },
        2: { halign: 'center', cellWidth: 25, fontStyle: 'bold' },
        3: { halign: 'center', cellWidth: 20, fontStyle: 'bold' },
        4: { halign: 'left', cellWidth: 50 }
      },
      didParseCell: function(data) {
        // Colora l'esito (V/P/S)
        if (data.column.index === 3 && data.section === 'body') {
          const esito = data.cell.text[0];
          if (esito === 'V') {
            data.cell.styles.textColor = [16, 185, 129];
            data.cell.styles.fontStyle = 'bold';
          } else if (esito === 'P') {
            data.cell.styles.textColor = [245, 158, 11];
            data.cell.styles.fontStyle = 'bold';
          } else if (esito === 'S') {
            data.cell.styles.textColor = [239, 68, 68];
            data.cell.styles.fontStyle = 'bold';
          }
        }
      }
    });
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.text(`Pagina ${i} di ${pageCount}`, 105, 290, { align: 'center' });
      doc.text('Generato da Moreschi Roberto Gestionale Calcio', 105, 285, { align: 'center' });
    }
    
    // Salva PDF
    doc.save(`Risultati_Partite_${new Date().toLocaleDateString('it-IT').replace(/\//g, '-')}.pdf`);
    showToast('‚úÖ PDF risultati generato!', 'success');
  };

  // ========== USE EFFECT PER GRAFICI DASHBOARD (CON RETRY LOGIC E RESPONSIVE MOBILE) ==========
  useEffect(() => {
    console.log('üìä useEffect grafici dashboard triggered');
    console.log('   activeTab:', activeTab);
    console.log('   Chart defined?', typeof Chart !== 'undefined');
    
    if (activeTab === 'dashboard' && typeof Chart !== 'undefined') {
      console.log('‚úÖ Condizioni soddisfatte, creo grafici...');
      
      // Funzione per tentare la creazione del grafico con retry
      const tryCreateChart = (chartId, createFn, retries = 0) => {
        const maxRetries = 5; // Tenta fino a 5 volte
        const baseDelay = 300; // Parti da 300ms
        
        const attemptCreate = () => {
          const canvas = document.getElementById(chartId);
          
          if (canvas) {
            console.log(`‚úÖ Canvas ${chartId} trovato, creo grafico...`);
            // Distruggi grafico esistente se c'√®
            const existingChart = Chart.getChart(canvas);
            if (existingChart) existingChart.destroy();
            
            createFn(canvas);
          } else if (retries < maxRetries) {
            console.log(`‚è∞ Canvas ${chartId} non trovato, retry ${retries + 1}/${maxRetries}...`);
            setTimeout(() => tryCreateChart(chartId, createFn, retries + 1), baseDelay * (retries + 1));
          } else {
            console.log(`‚ùå Canvas ${chartId} non trovato dopo ${maxRetries} tentativi`);
          }
        };
        
        attemptCreate();
      };
      
      // Aspetta che il DOM sia pronto
      setTimeout(() => {
        console.log('‚è∞ Inizio creazione grafici...');
        
        // ============ GRAFICO GOL FATTI/SUBITI ============
        tryCreateChart('goalsChart', (ctx) => {
          const matchDates = matches.map(m => new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }));
          
          // Calcola totali cumulativi
          let totaleFatti = 0;
          let totaleSubiti = 0;
          const golFattiCumulativi = [];
          const golSubitiCumulativi = [];
          
          matches.forEach(m => {
            const fatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
            const subiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
            
            totaleFatti += fatti;
            totaleSubiti += subiti;
            
            golFattiCumulativi.push(totaleFatti);
            golSubitiCumulativi.push(totaleSubiti);
          });
          
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: matchDates,
              datasets: [
                {
                  label: 'Totale Gol Fatti',
                  data: golFattiCumulativi,
                  borderColor: '#10b981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3,
                  pointRadius: 5,
                  pointHoverRadius: 7
                },
                {
                  label: 'Totale Gol Subiti',
                  data: golSubitiCumulativi,
                  borderColor: '#ef4444',
                  backgroundColor: 'rgba(239, 68, 68, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3,
                  pointRadius: 5,
                  pointHoverRadius: 7
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: window.innerWidth < 768 ? 1.2 : 2, // Mobile pi√π quadrato
              plugins: {
                legend: {
                  position: 'top',
                  labels: {
                    font: {
                      size: window.innerWidth < 768 ? 11 : 13, // Font pi√π piccolo su mobile
                      weight: 'bold'
                    },
                    padding: window.innerWidth < 768 ? 8 : 15
                  }
                },
                tooltip: {
                  callbacks: {
                    title: function(context) {
                      return 'Dopo: ' + context[0].label;
                    },
                    afterLabel: function(context) {
                      const index = context.dataIndex;
                      if (index === 0) return '';
                      
                      const prevFatti = context.dataset.label.includes('Fatti') 
                        ? (index > 0 ? golFattiCumulativi[index - 1] : 0)
                        : (index > 0 ? golSubitiCumulativi[index - 1] : 0);
                      const current = context.parsed.y;
                      const diff = current - prevFatti;
                      
                      return `(${diff >= 0 ? '+' : ''}${diff} in questa partita)`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { 
                    stepSize: 5,
                    font: {
                      size: window.innerWidth < 768 ? 10 : 12,
                      weight: 'bold'
                    }
                  },
                  title: {
                    display: window.innerWidth >= 768, // Nascondi titolo asse su mobile
                    text: 'Totale Gol',
                    font: {
                      size: 14,
                      weight: 'bold'
                    }
                  }
                },
                x: {
                  ticks: {
                    font: {
                      size: window.innerWidth < 768 ? 9 : 11
                    },
                    maxRotation: 45,
                    minRotation: 0
                  }
                }
              }
            }
          });
        });

        // ============ GRAFICO RISULTATI ============
        tryCreateChart('resultsChart', (ctx) => {
          let vittorie = 0, pareggi = 0, sconfitte = 0;
          matches.forEach(m => {
            // ‚úÖ FIX: Calcola sempre da golFatti e golSubiti invece del campo risultato
            const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
            const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
            
            // Considera solo partite completate (almeno un gol segnato o subito)
            if (golFatti === 0 && golSubiti === 0) return;
            
            if (golFatti > golSubiti) vittorie++;
            else if (golFatti === golSubiti) pareggi++;
            else sconfitte++;
          });
          
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: [`Vittorie (${vittorie})`, `Pareggi (${pareggi})`, `Sconfitte (${sconfitte})`],
              datasets: [{
                data: [vittorie, pareggi, sconfitte],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: window.innerWidth < 768 ? 1 : 1.5,
              plugins: {
                legend: {
                  position: window.innerWidth < 768 ? 'bottom' : 'bottom',
                  labels: {
                    font: {
                      size: window.innerWidth < 768 ? 11 : 14,
                      weight: 'bold'
                    },
                    padding: window.innerWidth < 768 ? 10 : 15
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.parsed || 0;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return `${label}: ${percentage}%`;
                    }
                  }
                }
              }
            }
          });
        });

        // ============ GRAFICO PRESENZE ALLENAMENTI ============
        tryCreateChart('attendanceChart', (ctx) => {
          const last10Trainings = trainings.slice(-10);
          const trainingDates = last10Trainings.map(t => new Date(t.data).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }));
          const presenze = last10Trainings.map(t => 
            Object.entries(t.presenze)
              .filter(([numero, presente]) => {
                if (!presente) return false;
                const player = players.find(p => p.numero === parseInt(numero));
                if (!player || !player.nome) return false;
                if (player.fuoriRosa) return false;
                if (player.dataCreazione && new Date(player.dataCreazione) > new Date(t.data)) return false;
                return true;
              })
              .length
          );
          
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: trainingDates,
              datasets: [{
                label: 'Presenze',
                data: presenze,
                backgroundColor: '#3b82f6',
                borderRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: window.innerWidth < 768 ? 1.2 : 2,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { 
                    stepSize: 1,
                    font: {
                      size: window.innerWidth < 768 ? 10 : 12
                    }
                  }
                },
                x: {
                  ticks: {
                    font: {
                      size: window.innerWidth < 768 ? 9 : 11
                    },
                    maxRotation: 45,
                    minRotation: 0
                  }
                }
              }
            }
          });
        });
        
      }, 500); // Timeout iniziale ridotto a 500ms, poi retry gestiti internamente

    }
  }, [activeTab, matches, trainings, players]);

  const toggleAutoSync = () => {
    setAutoSyncEnabled(!autoSyncEnabled);
    if (!autoSyncEnabled) {
      showToast('‚úÖ Sincronizzazione automatica ATTIVATA - Sync ogni 5 minuti', 'success');
    } else {
      showToast('‚è∏Ô∏è Sincronizzazione automatica DISATTIVATA - Solo sync manuale', 'info');
    }
  };

  // ============================================
  // FINE FUNZIONI SINCRONIZZAZIONE
  // ============================================

  const calculateStats = () => {
    const stats = {};
    
    players.forEach(player => {
      if (!player.nome) return;
      
      stats[player.numero] = {
        nome: player.nome,
        ruolo: player.ruolo,
        dataCreazione: player.dataCreazione,
        allenamenti_presenze: 0,
        allenamenti_assenze: 0,
        infortuni: 0,
        partite_convocato: 0,
        partite_titolare: 0,
        minuti_totali: 0,
        gol: 0,
        assist: 0,
        gol_subiti: 0,
        gialli_gioco: 0,
        gialli_protesta: 0,
        rossi_gioco: 0,
        rossi_protesta: 0
      };
    });

    trainings.forEach(training => {
      Object.keys(training.presenze || {}).forEach(numero => {
        if (stats[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(training.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          if (training.presenze[numero] === true) {
            stats[numero].allenamenti_presenze++;
          } else if (training.presenze[numero] === false) {
            stats[numero].allenamenti_assenze++;
          }
        }
      });
      
      Object.keys(training.infortuni || {}).forEach(numero => {
        if (stats[numero] && training.infortuni[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(training.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].infortuni++;
        }
      });
    });

    matches.forEach(match => {
      Object.keys(match.convocati || {}).forEach(numero => {
        if (stats[numero] && match.convocati[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].partite_convocato++;
        }
      });
      
      Object.keys(match.titolari || {}).forEach(numero => {
        if (stats[numero] && match.titolari[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].partite_titolare++;
        }
      });
      
      Object.keys(match.sostituzioni || {}).forEach(numero => {
        if (stats[numero] && match.sostituzioni[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          if (!match.titolari[numero]) {
            stats[numero].partite_titolare++;
          }
        }
      });

      Object.keys(match.minutiGiocati || {}).forEach(numero => {
        if (stats[numero]) {
          const playerDataCreazione = stats[numero].dataCreazione;
          if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
            return;
          }
          
          stats[numero].minuti_totali += parseInt(match.minutiGiocati[numero] || 0);
        }
      });

      ['golFatti', 'assist', 'golSubiti', 'gialli_gioco', 'gialli_protesta', 'rossi_gioco', 'rossi_protesta'].forEach(field => {
        const mappedField = field === 'golFatti' ? 'gol' : field === 'golSubiti' ? 'gol_subiti' : field;
        Object.keys(match[field] || {}).forEach(numero => {
          if (stats[numero]) {
            const playerDataCreazione = stats[numero].dataCreazione;
            if (playerDataCreazione && new Date(match.data) < new Date(playerDataCreazione)) {
              return;
            }
            
            stats[numero][mappedField] += parseInt(match[field][numero] || 0);
          }
        });
      });
    });

    // Funzione helper per ordinamento per ruolo
    const getRuoloOrder = (ruolo) => {
      if (!ruolo) return 999;
      const r = ruolo.toLowerCase().trim();
      
      // 1. Portieri
      if (r.includes('portier') || r === 'por' || r === 'p') return 1;
      
      // 2. Difensori centrali
      if ((r.includes('difensor') && r.includes('central')) || 
          r === 'dc' || r === 'difensore centrale') return 2;
      
      // 3. Terzini
      if (r.includes('terzin') || r === 'td' || r === 'ts' || 
          r === 'terzino destro' || r === 'terzino sinistro') return 3;
      
      // 4. Centrocampisti centrali
      if ((r.includes('centroc') && r.includes('central')) || 
          r === 'cc' || r === 'centrocampista centrale' ||
          r.includes('mediano') || r.includes('regista')) return 4;
      
      // 5. Esterni alti (esterni di centrocampo)
      if ((r.includes('esterno') || r.includes('ala')) && 
          !r.includes('attacc') && !r.includes('trequart')) return 5;
      
      // 6. Trequartisti
      if (r.includes('trequart') || r === 'tq' || r === 'trequartista') return 6;
      
      // 7. Attaccanti
      if (r.includes('attacc') || r.includes('punta') || 
          r === 'at' || r === 'pc' || r === 'as' || r === 'ad') return 7;
      
      // Altri difensori (fallback)
      if (r.includes('difensor') || r.includes('libero')) return 2.5;
      
      // Altri centrocampisti (fallback)
      if (r.includes('centroc') || r.includes('mezzala')) return 4.5;
      
      return 999; // Ruoli non riconosciuti vanno alla fine
    };

    return Object.values(stats)
      .filter(s => s.nome)
      .sort((a, b) => {
        // Prima ordina per ruolo
        const ruoloA = getRuoloOrder(a.ruolo);
        const ruoloB = getRuoloOrder(b.ruolo);
        if (ruoloA !== ruoloB) return ruoloA - ruoloB;
        
        // Poi alfabeticamente per nome
        return a.nome.localeCompare(b.nome);
      });
  };

  const getNumeroAlfabetico = (nomeGiocatore) => {
    const giocatoriOrdinati = players
      .filter(p => p.nome)
      .sort((a, b) => a.nome.localeCompare(b.nome));
    
    const index = giocatoriOrdinati.findIndex(p => p.nome === nomeGiocatore);
    return index >= 0 ? index + 1 : null;
  };

  // ========== FUNZIONE EXPORT ROSA PDF ==========
  
  const exportRosaPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const currentYear = new Date().getFullYear();
    
    // Helper per ordinamento ruoli (stesso di calculateStats)
    const getRuoloOrderPDF = (ruolo) => {
      if (!ruolo) return 999;
      const r = ruolo.toLowerCase().trim();
      
      if (r.includes('portier') || r === 'por' || r === 'p') return 1;
      if ((r.includes('difensor') && r.includes('central')) || r === 'dc' || r === 'difensore centrale') return 2;
      if (r.includes('terzin') || r === 'td' || r === 'ts' || r === 'terzino destro' || r === 'terzino sinistro') return 3;
      if ((r.includes('centroc') && r.includes('central')) || r === 'cc' || r === 'centrocampista centrale' || r.includes('mediano') || r.includes('regista')) return 4;
      if ((r.includes('esterno') || r.includes('ala')) && !r.includes('attacc') && !r.includes('trequart')) return 5;
      if (r.includes('trequart') || r === 'tq' || r === 'trequartista') return 6;
      if (r.includes('attacc') || r.includes('punta') || r === 'at' || r === 'pc' || r === 'as' || r === 'ad') return 7;
      if (r.includes('difensor') || r.includes('libero')) return 2.5;
      if (r.includes('centroc') || r.includes('mezzala')) return 4.5;
      return 999;
    };
    
    // Helper per ottenere categoria ruolo
    const getRuoloCategoria = (ruolo) => {
      const order = getRuoloOrderPDF(ruolo);
      if (order === 1) return 'Portieri';
      if (order >= 2 && order < 3) return 'Difensori Centrali';
      if (order === 3) return 'Terzini';
      if (order >= 4 && order < 5) return 'Centrocampisti Centrali';
      if (order === 5) return 'Esterni Alti';
      if (order === 6) return 'Trequartisti';
      if (order === 7) return 'Attaccanti';
      return 'Altri';
    };
    
    // Helper per colore ruolo
    const getRuoloColor = (categoria) => {
      const colors = {
        'Portieri': [255, 235, 59],           // Giallo
        'Difensori Centrali': [33, 150, 243], // Blu
        'Terzini': [100, 181, 246],           // Azzurro
        'Centrocampisti Centrali': [76, 175, 80], // Verde
        'Esterni Alti': [129, 199, 132],      // Verde chiaro
        'Trequartisti': [156, 39, 176],       // Viola
        'Attaccanti': [244, 67, 54],          // Rosso
        'Altri': [158, 158, 158]              // Grigio
      };
      return colors[categoria] || [200, 200, 200];
    };
    
    // Ordina giocatori per ruolo
    const giocatoriOrdinati = players
      .filter(p => p.nome)
      .sort((a, b) => {
        const ruoloA = getRuoloOrderPDF(a.ruolo);
        const ruoloB = getRuoloOrderPDF(b.ruolo);
        if (ruoloA !== ruoloB) return ruoloA - ruoloB;
        return a.nome.localeCompare(b.nome);
      });
    
    // Titolo - COMPATTO
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('REAL D.O.R. UNDER 18', 105, 15, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(`Rosa Stagione ${currentYear}`, 105, 22, { align: 'center' });
    
    // Sottotitolo - COMPATTO
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text(`Totale Giocatori: ${giocatoriOrdinati.length}`, 105, 28, { align: 'center' });
    
    // Linea separatore
    doc.setLineWidth(0.3);
    doc.line(20, 31, 190, 31);
    
    let yPosition = 36; // Posizione iniziale pi√π alta
    let currentCategoria = '';
    let numero = 1;
    
    giocatoriOrdinati.forEach((player) => {
      const categoria = getRuoloCategoria(player.ruolo);
      
      // Nuova categoria - Header colorato COMPATTO
      if (categoria !== currentCategoria) {
        // Spazio prima della nuova categoria (ridotto)
        if (currentCategoria !== '') {
          yPosition += 2;
        }
        
        currentCategoria = categoria;
        const color = getRuoloColor(categoria);
        
        // Box colorato per categoria (ridotto)
        doc.setFillColor(color[0], color[1], color[2]);
        doc.rect(20, yPosition - 3.5, 170, 5, 'F');
        
        // Testo categoria (ridotto)
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(255, 255, 255);
        doc.text(categoria.toUpperCase(), 23, yPosition);
        
        doc.setTextColor(0, 0, 0);
        yPosition += 5.5;
      }
      
      // Giocatore - COMPATTO
      doc.setFontSize(8.5); // Font pi√π piccolo
      doc.setFont(undefined, 'normal');
      
      // Numero progressivo
      doc.setFont(undefined, 'bold');
      doc.text(`${numero}.`, 23, yPosition);
      
      // Nome (troncato se troppo lungo)
      doc.setFont(undefined, 'bold');
      const nomeMax = player.nome.length > 30 ? player.nome.substring(0, 28) + '...' : player.nome;
      doc.text(nomeMax, 30, yPosition);
      
      // Ruolo specifico
      doc.setFont(undefined, 'normal');
      doc.setTextColor(100, 100, 100);
      const ruoloText = player.ruolo || 'N/D';
      const ruoloMax = ruoloText.length > 20 ? ruoloText.substring(0, 18) + '...' : ruoloText;
      doc.text(`(${ruoloMax})`, 30 + doc.getTextWidth(nomeMax) + 2, yPosition);
      
      // Numero maglia (se presente)
      if (player.numero) {
        doc.setTextColor(33, 150, 243);
        doc.setFont(undefined, 'bold');
        doc.text(`#${player.numero}`, 185, yPosition, { align: 'right' });
      }
      
      doc.setTextColor(0, 0, 0);
      
      yPosition += 5; // Spazio ridotto tra giocatori (era 7)
      numero++;
    });
    
    // Footer con data generazione
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text(`Generato il ${new Date().toLocaleDateString('it-IT')}`, 105, 285, { align: 'center' });
    
    // Salva PDF
    doc.save(`Rosa_Real_DOR_${currentYear}.pdf`);
    showToast('PDF Rosa scaricato!', 'success');
  };

  // ========== MIGRAZIONE FOTO A FIREBASE STORAGE ==========
  
  const migratePhotosToStorage = async () => {
    if (!user) {
      alert('‚ùå Devi essere autenticato per migrare le foto');
      return;
    }
    
    const playersWithBase64 = players.filter(p => p.foto && !p.foto.startsWith('https://'));
    
    if (playersWithBase64.length === 0) {
      showToast('‚úÖ Tutte le foto sono gi√† su Firebase Storage!', 'success');
      return;
    }
    
    if (!window.confirm(`üöÄ Vuoi migrare ${playersWithBase64.length} foto su Firebase Storage?\n\nQuesta operazione:\n‚úÖ Libera spazio nel database Firestore\n‚úÖ Migliora le prestazioni\n‚úÖ Permette sync senza problemi limite 1MB\n‚úÖ Foto qualit√† migliore (300x300px)\n\n‚ö†Ô∏è Richiede connessione internet\n‚ö†Ô∏è Durata: ~1-2 minuti per 30 foto`)) {
      return;
    }
    
    let migrated = 0;
    let errors = 0;
    const totalPhotos = playersWithBase64.length;
    
    showToast(`üöÄ Migrazione ${totalPhotos} foto in corso...`, 'info', 3000);
    
    for (const player of playersWithBase64) {
      try {
        showToast(`üì§ Migrazione ${player.nome}... (${migrated + 1}/${totalPhotos})`, 'info', 1000);
        
        // Converti base64 in blob
        const base64Data = player.foto.split(',')[1];
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'image/jpeg' });
        
        // Upload su Storage
        const storageRef = storage.ref();
        const fileName = `players/${user.uid}/${player.numero}_${Date.now()}.jpg`;
        const fileRef = storageRef.child(fileName);
        
        await fileRef.put(blob);
        const downloadURL = await fileRef.getDownloadURL();
        
        // Aggiorna player con URL
        updatePlayer(player.numero, 'foto', downloadURL);
        
        migrated++;
      } catch (error) {
        console.error(`Errore migrazione foto ${player.nome}:`, error);
        errors++;
      }
    }
    
    if (errors === 0) {
      showToast(
        `‚úÖ Migrazione completata!\nüöÄ ${migrated} foto su Firebase Storage\nüíæ Database Firestore ora leggero!\n‚òÅÔ∏è Ora puoi sincronizzare senza problemi`,
        'success',
        8000
      );
    } else {
      showToast(
        `‚ö†Ô∏è Migrazione parziale:\n‚úÖ ${migrated} foto migrate\n‚ùå ${errors} errori\n\nVerifica console per dettagli`,
        'warning',
        8000
      );
    }
  };

  // ========== FUNZIONI PER DIVISIONE SQUADRE ==========
  
  const mappaRuolo = (ruolo) => {
    if (!ruolo) return 'Altri';
    const ruoloLower = ruolo.toLowerCase();
    
    // Portieri
    if (ruoloLower.includes('portiere') || ruoloLower === 'p') return 'Portieri';
    
    // Difensori
    if (ruoloLower.includes('difens') || 
        ruoloLower.includes('terzin') || 
        ruoloLower.includes('libero') ||
        ruoloLower.includes('centrale') && ruoloLower.includes('dif') ||
        ['dc', 'td', 'ts', 'lb'].includes(ruoloLower)) return 'Difensori';
    
    // Centrocampisti
    if (ruoloLower.includes('centroc') || 
        ruoloLower.includes('mediano') || 
        ruoloLower.includes('esterno') && !ruoloLower.includes('attacc') ||
        ruoloLower.includes('mezzala') ||
        ruoloLower.includes('regista') ||
        ['cc', 'md', 'ed', 'es', 'mc'].includes(ruoloLower)) return 'Centrocampisti';
    
    // Attaccanti
    if (ruoloLower.includes('attacc') || 
        ruoloLower.includes('punta') || 
        ruoloLower.includes('trequart') ||
        ruoloLower.includes('ala') ||
        ruoloLower.includes('seconda punta') ||
        ['pc', 'ad', 'as', 'tq'].includes(ruoloLower)) return 'Attaccanti';
    
    return 'Altri';
  };

  const teamColors = [
    { bg: 'bg-red-600', text: 'text-red-600', name: 'A' },
    { bg: 'bg-blue-600', text: 'text-blue-600', name: 'B' },
    { bg: 'bg-green-600', text: 'text-green-600', name: 'C' },
    { bg: 'bg-purple-600', text: 'text-purple-600', name: 'D' },
    { bg: 'bg-orange-600', text: 'text-orange-600', name: 'E' },
    { bg: 'bg-pink-600', text: 'text-pink-600', name: 'F' }
  ];

  const toggleInfortunato = (nome) => {
    const newInfortunati = new Set(infortunati);
    if (newInfortunati.has(nome)) {
      newInfortunati.delete(nome);
    } else {
      newInfortunati.add(nome);
    }
    setInfortunati(newInfortunati);
  };

  const organizzaGiocatori = () => {
    console.log('üîç organizzaGiocatori chiamato');
    console.log('   giocatoriSelezionati.size:', giocatoriSelezionati.size);
    console.log('   giocatoriSelezionati:', Array.from(giocatoriSelezionati));
    
    const ruoli = {
      'Portieri': [],
      'Difensori': [],
      'Centrocampisti': [],
      'Attaccanti': []
    };

    let includeCount = 0;
    let excludeCount = 0;

    players.forEach(player => {
      // Filtra per: nome esiste, non fuori rosa, non infortunato, E selezionato (se giocatoriSelezionati non √® vuoto)
      if (player.nome && !player.fuoriRosa && !infortunati.has(player.nome)) {
        // Se giocatoriSelezionati √® vuoto, include tutti (comportamento default)
        // Altrimenti include solo i selezionati
        if (giocatoriSelezionati.size === 0 || giocatoriSelezionati.has(player.nome)) {
          const ruolo = mappaRuolo(player.ruolo);
          if (ruolo !== 'Altri' && !(ruolo === 'Portieri' && !includiPortieri)) {
            ruoli[ruolo].push(player);
            includeCount++;
          }
        } else {
          excludeCount++;
          console.log('   ‚ùå ESCLUSO:', player.nome, '(non in giocatoriSelezionati)');
        }
      }
    });

    console.log('   ‚úÖ Inclusi:', includeCount, '‚ùå Esclusi:', excludeCount);
    return ruoli;
  };

  const dividiSquadre = useMemo(() => {
    const ruoli = organizzaGiocatori();
    
    const squadre = Array.from({ length: numSquadre }, () => ({
      'Portieri': [],
      'Difensori': [],
      'Centrocampisti': [],
      'Attaccanti': [],
      totale: 0
    }));

    const ruoliDaDistribuire = includiPortieri 
      ? ['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti']
      : ['Difensori', 'Centrocampisti', 'Attaccanti'];

    const totaleGiocatori = ruoliDaDistribuire.reduce(
      (sum, ruolo) => sum + ruoli[ruolo].length, 
      0
    );

    const basePerSquadra = Math.floor(totaleGiocatori / numSquadre);
    const squadreConExtra = totaleGiocatori % numSquadre;
    
    const targetPerSquadra = squadre.map((_, i) => 
      basePerSquadra + (i < squadreConExtra ? 1 : 0)
    );

    const distribuisciRuoloEquilibrato = (giocatori, nomeRuolo) => {
      if (giocatori.length === 0) return;
      
      const giocatoriMescolati = [...giocatori].sort(() => Math.random() - 0.5);
      
      giocatoriMescolati.forEach(giocatore => {
        const minRuolo = Math.min(...squadre.map(s => s[nomeRuolo].length));
        const squadreConMinRuolo = squadre
          .map((s, i) => ({ squadra: s, index: i }))
          .filter(({ squadra }) => squadra[nomeRuolo].length === minRuolo);
        
        let sceltaIndex = squadreConMinRuolo[0].index;
        let maxDistanza = targetPerSquadra[sceltaIndex] - squadre[sceltaIndex].totale;
        
        squadreConMinRuolo.forEach(({ index }) => {
          const distanza = targetPerSquadra[index] - squadre[index].totale;
          if (distanza > maxDistanza) {
            maxDistanza = distanza;
            sceltaIndex = index;
          }
        });
        
        squadre[sceltaIndex][nomeRuolo].push(giocatore);
        squadre[sceltaIndex].totale++;
      });
    };

    ruoliDaDistribuire.forEach(ruoloNome => {
      distribuisciRuoloEquilibrato(ruoli[ruoloNome], ruoloNome);
    });

    squadre.forEach(squadra => delete squadra.totale);

    return squadre;
  }, [numSquadre, includiPortieri, infortunati, giocatoriSelezionati, regenerateKey, players]);

  const conteggioSquadre = useMemo(() => {
    return dividiSquadre.map(squadra => {
      const totale = Object.values(squadra).reduce((sum, giocatori) => sum + giocatori.length, 0);
      return {
        portieri: squadra.Portieri.length,
        difensori: squadra.Difensori.length,
        centrocampisti: squadra.Centrocampisti.length,
        attaccanti: squadra.Attaccanti.length,
        totale
      };
    });
  }, [dividiSquadre]);

  const giocatoriDisponibili = useMemo(() => {
    const ruoli = organizzaGiocatori();
    const ruoliDaContare = includiPortieri 
      ? ['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti']
      : ['Difensori', 'Centrocampisti', 'Attaccanti'];
    
    return ruoliDaContare.reduce((sum, ruolo) => sum + ruoli[ruolo].length, 0);
  }, [includiPortieri, infortunati, giocatoriSelezionati, players]);

  const differenzaSquadre = useMemo(() => {
    if (conteggioSquadre.length === 0) return 0;
    const totali = conteggioSquadre.map(s => s.totale);
    return Math.max(...totali) - Math.min(...totali);
  }, [conteggioSquadre]);

  const rigeneraDivisione = () => {
    setShowDivisioneResults(true);
    setRegenerateKey(prev => prev + 1);
  };

  const downloadDivisionePDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('DIVISIONE SQUADRE EQUILIBRATE', 105, 20, { align: 'center' });
    doc.setFontSize(12);
    doc.text('Real DOR Under 18', 105, 30, { align: 'center' });
    
    if (infortunati.size > 0) {
      doc.setFontSize(10);
      doc.setTextColor(150, 0, 0);
      doc.text(`Infortunati esclusi: ${infortunati.size}`, 105, 38, { align: 'center' });
      doc.setTextColor(0, 0, 0);
    }

    let yPosition = infortunati.size > 0 ? 48 : 45;

    dividiSquadre.forEach((squadra, index) => {
      if (index > 0 && yPosition > 200) {
        doc.addPage();
        yPosition = 20;
      }

      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      const totaleSquadra = conteggioSquadre[index].totale;
      doc.text(`SQUADRA ${teamColors[index].name} (${totaleSquadra} giocatori)`, 15, yPosition);
      yPosition += 6;
      
      doc.setFontSize(10);
      let dettagli = '';
      if (includiPortieri) dettagli += `P: ${conteggioSquadre[index].portieri} ‚Ä¢ `;
      dettagli += `D: ${conteggioSquadre[index].difensori} ‚Ä¢ `;
      dettagli += `C: ${conteggioSquadre[index].centrocampisti} ‚Ä¢ `;
      dettagli += `A: ${conteggioSquadre[index].attaccanti}`;
      doc.text(dettagli, 15, yPosition);
      yPosition += 8;

      const tableData = [];
      let numero = 1;

      ['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti'].forEach(ruolo => {
        squadra[ruolo].forEach(player => {
          tableData.push([
            numero++,
            player.nome,
            player.ruolo,
            player.dataNascita ? new Date(player.dataNascita).toLocaleDateString('it-IT') : 'N/A',
            player.piede || 'N/A'
          ]);
        });
      });

      doc.autoTable({
        startY: yPosition,
        head: [['N.', 'Nome', 'Ruolo', 'Data Nascita', 'Piede']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [100, 100, 100], fontSize: 9 },
        bodyStyles: { fontSize: 8 },
        columnStyles: {
          0: { cellWidth: 10 },
          1: { cellWidth: 50 },
          2: { cellWidth: 40 },
          3: { cellWidth: 30 },
          4: { cellWidth: 20 }
        },
        margin: { left: 15, right: 15 }
      });

      yPosition = doc.lastAutoTable.finalY + 15;
    });

    doc.save('divisione_squadre_equilibrate.pdf');
  };

  // ========== FUNZIONI PER CONVOCAZIONI ==========

  const toggleConvocato = (nome) => {
    const newConvocati = new Set(convocati);
    if (newConvocati.has(nome)) {
      newConvocati.delete(nome);
    } else {
      if (newConvocati.size >= 20) {
        alert('Puoi convocare massimo 20 giocatori!');
        return;
      }
      newConvocati.add(nome);
    }
    setConvocati(newConvocati);
  };

  const downloadConvocazioni = () => {
    if (convocati.size === 0) {
      alert('Seleziona almeno un giocatore da convocare!');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('CONVOCAZIONE', 105, 18, { align: 'center' });
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    doc.text('Real DOR Under 18', 105, 26, { align: 'center' });

    let yPos = 36;

    if (infoPartita.squadra1 && infoPartita.squadra2) {
      doc.setFontSize(15);
      doc.setFont(undefined, 'bold');
      doc.text(`${infoPartita.squadra1} VS ${infoPartita.squadra2}`, 105, yPos, { align: 'center' });
      yPos += 9;
    }

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    if (infoPartita.dataPartita) {
      const dataFormatted = new Date(infoPartita.dataPartita + 'T00:00:00').toLocaleDateString('it-IT', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      doc.text(`Data: ${dataFormatted}`, 105, yPos, { align: 'center' });
      yPos += 6;
    }

    if (infoPartita.oraRitrovo) {
      doc.text(`Ora ritrovo: ${infoPartita.oraRitrovo}`, 105, yPos, { align: 'center' });
      yPos += 6;
    }

    if (infoPartita.indirizzoCompo) {
      doc.setFontSize(9);
      doc.text(`Campo: ${infoPartita.indirizzoCompo}`, 105, yPos, { align: 'center' });
      yPos += 6;
    }

    yPos += 4;

    const giocatoriConvocati = players
      .filter(p => p.nome && convocati.has(p.nome))
      .sort((a, b) => a.nome.localeCompare(b.nome));

    doc.setFontSize(13);
    doc.setFont(undefined, 'bold');
    doc.text(`GIOCATORI CONVOCATI (${giocatoriConvocati.length})`, 105, yPos, { align: 'center' });
    yPos += 7;

    const tableData = giocatoriConvocati.map((player, idx) => [
      idx + 1,
      player.nome
    ]);

    doc.autoTable({
      startY: yPos,
      head: [['N.', 'Cognome e Nome']],
      body: tableData,
      theme: 'striped',
      headStyles: { 
        fillColor: [41, 128, 185],
        fontSize: 10,
        fontStyle: 'bold',
        halign: 'center',
        cellPadding: 2
      },
      bodyStyles: { 
        fontSize: 9,
        cellPadding: 2
      },
      columnStyles: {
        0: { cellWidth: 18, halign: 'center' },
        1: { cellWidth: 150 }
      },
      margin: { left: 20, right: 20 },
      alternateRowStyles: { fillColor: [245, 245, 245] }
    });

    const nomeFile = infoPartita.dataPartita 
      ? `convocazione_${infoPartita.dataPartita}.pdf`
      : `convocazione_${new Date().toISOString().split('T')[0]}.pdf`;
    
    doc.save(nomeFile);
  };

  // ========== FUNZIONE STAMPA LISTA PRESENZE ==========
  
  const stampaListaPresenze = () => {
    if (players.length === 0) {
      alert('Nessun giocatore nella rosa!');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 10;

    // Aggiungo logo se presente (molto piccolo)
    if (teamLogo) {
      try {
        doc.addImage(teamLogo, 'PNG', 15, 8, 12, 12);
      } catch (e) {
        console.log('Errore caricamento logo:', e);
      }
    }

    // Titolo compatto in linea con il logo
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Real D.O.R. - Lista Presenze', teamLogo ? 30 : 15, 15);
    
    yPos = 23;

    // Data e note in una riga
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text('Data: ______________', 15, yPos);
    doc.text('Note: _________________________________________________', 70, yPos);
    
    yPos += 6;

    // Ordino giocatori alfabeticamente (escludo fuori rosa)
    const giocatoriOrdinati = [...players]
      .filter(p => p.nome && !p.fuoriRosa)
      .sort((a, b) => a.nome.localeCompare(b.nome));

    // Preparo dati per la tabella
    const tableData = giocatoriOrdinati.map((player, idx) => [
      idx + 1,
      player.nome,
      player.ruolo || '',
      '', // Colonna Presente
      ''  // Colonna Assente
    ]);

    doc.autoTable({
      startY: yPos,
      head: [['N.', 'Cognome e Nome', 'Ruolo', 'P', 'A']],
      body: tableData,
      theme: 'grid',
      headStyles: { 
        fillColor: [34, 139, 34],
        fontSize: 9,
        fontStyle: 'bold',
        halign: 'center',
        cellPadding: 2
      },
      bodyStyles: { 
        fontSize: 8,
        cellPadding: 1.5,
        minCellHeight: 7
      },
      columnStyles: {
        0: { cellWidth: 10, halign: 'center' },
        1: { cellWidth: 85 },
        2: { cellWidth: 45 },
        3: { cellWidth: 12, halign: 'center', fillColor: [240, 255, 240] },
        4: { cellWidth: 12, halign: 'center', fillColor: [255, 240, 240] }
      },
      margin: { left: 15, right: 15, bottom: 20 },
      didDrawCell: (data) => {
        // Aggiungo checkbox nelle colonne P e A
        if (data.column.index === 3 || data.column.index === 4) {
          if (data.row.index >= 0) {
            const size = 5;
            const x = data.cell.x + (data.cell.width - size) / 2;
            const y = data.cell.y + (data.cell.height - size) / 2;
            doc.setDrawColor(100);
            doc.rect(x, y, size, size);
          }
        }
      }
    });

    // Footer con legenda
    const finalY = doc.lastAutoTable.finalY;
    doc.setFontSize(7);
    doc.setFont(undefined, 'italic');
    doc.setTextColor(100, 100, 100);
    doc.text('P = Presente | A = Assente', 15, finalY + 5);
    doc.text(`Tot: ${giocatoriOrdinati.length}`, 105, finalY + 5, { align: 'center' });
    doc.text(`${new Date().toLocaleDateString('it-IT')}`, 195, finalY + 5, { align: 'right' });

    doc.save(`lista_presenze_${new Date().toISOString().split('T')[0]}.pdf`);
  };

  // ========== NUOVE FUNZIONI ESPORTAZIONE AVANZATE ==========
  
  // Export Report Stagionale Completo
  const downloadSeasonReportPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    
    // Header
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.text('üìä REPORT STAGIONALE COMPLETO', 105, yPos, { align: 'center' });
    yPos += 10;
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'normal');
    doc.text(appTitle, 105, yPos, { align: 'center' });
    yPos += 5;
    
    doc.setFontSize(10);
    doc.text(`Generato il: ${new Date().toLocaleDateString('it-IT')}`, 105, yPos, { align: 'center' });
    yPos += 15;
    
    // Statistiche Generali
    const totalMatches = matches.length;
    const totalTrainings = trainings.length;
    const activePlayers = players.filter(p => p.nome).length;
    
    const victories = matches.filter(m => {
      const our = parseInt(m.golFatti ? Object.values(m.golFatti).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0) : 0);
      const their = Object.values(m.golSubiti || {}).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
      return our > their;
    }).length;
    
    const draws = matches.filter(m => {
      const our = parseInt(m.golFatti ? Object.values(m.golFatti).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0) : 0);
      const their = Object.values(m.golSubiti || {}).reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
      return our === their;
    }).length;
    
    const defeats = totalMatches - victories - draws;
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('STATISTICHE GENERALI', 15, yPos);
    yPos += 8;
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    doc.text(`‚Ä¢ Giocatori in rosa: ${activePlayers}`, 20, yPos);
    yPos += 6;
    doc.text(`‚Ä¢ Partite giocate: ${totalMatches} (V: ${victories}, P: ${draws}, S: ${defeats})`, 20, yPos);
    yPos += 6;
    doc.text(`‚Ä¢ Allenamenti svolti: ${totalTrainings}`, 20, yPos);
    yPos += 12;
    
    // Top 5 Marcatori
    const goalScorers = {};
    matches.forEach(match => {
      if (match.golFatti) {
        Object.entries(match.golFatti).forEach(([num, gol]) => {
          const goals = parseInt(gol || 0);
          if (goals > 0) {
            goalScorers[num] = (goalScorers[num] || 0) + goals;
          }
        });
      }
    });
    
    const topScorers = Object.entries(goalScorers)
      .map(([num, gol]) => {
        const player = players.find(p => p.numero === parseInt(num));
        return { nome: player?.nome || `#${num}`, gol };
      })
      .sort((a, b) => b.gol - a.gol)
      .slice(0, 5);
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('üèÜ TOP 5 MARCATORI', 15, yPos);
    yPos += 8;
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    topScorers.forEach((scorer, i) => {
      doc.text(`${i + 1}. ${scorer.nome}: ${scorer.gol} gol`, 20, yPos);
      yPos += 6;
    });
    yPos += 8;
    
    // Top 5 Assist
    const assistProviders = {};
    matches.forEach(match => {
      if (match.assist) {
        Object.entries(match.assist).forEach(([num, assists]) => {
          const count = parseInt(assists || 0);
          if (count > 0) {
            assistProviders[num] = (assistProviders[num] || 0) + count;
          }
        });
      }
    });
    
    const topAssisters = Object.entries(assistProviders)
      .map(([num, assists]) => {
        const player = players.find(p => p.numero === parseInt(num));
        return { nome: player?.nome || `#${num}`, assists };
      })
      .sort((a, b) => b.assists - a.assists)
      .slice(0, 5);
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('üëü TOP 5 ASSIST', 15, yPos);
    yPos += 8;
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    topAssisters.forEach((assister, i) => {
      doc.text(`${i + 1}. ${assister.nome}: ${assister.assists} assist`, 20, yPos);
      yPos += 6;
    });
    
    // Nuova pagina per lista completa giocatori
    doc.addPage();
    yPos = 20;
    
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('ROSA COMPLETA', 105, yPos, { align: 'center' });
    yPos += 12;
    
    const playersData = players
      .filter(p => p.nome)
      .map(p => {
        const goals = goalScorers[p.numero] || 0;
        const assists = assistProviders[p.numero] || 0;
        return [
          p.numero,
          p.nome,
          p.ruolo,
          goals,
          assists
        ];
      });
    
    doc.autoTable({
      startY: yPos,
      head: [['#', 'Nome', 'Ruolo', 'Gol', 'Assist']],
      body: playersData,
      theme: 'grid',
      headStyles: { fillColor: [26, 86, 219], fontSize: 10, fontStyle: 'bold' },
      bodyStyles: { fontSize: 9 },
      columnStyles: {
        0: { cellWidth: 15, halign: 'center' },
        1: { cellWidth: 70 },
        2: { cellWidth: 55 },
        3: { cellWidth: 20, halign: 'center' },
        4: { cellWidth: 20, halign: 'center' }
      }
    });
    
    doc.save(`report_stagionale_${new Date().toISOString().split('T')[0]}.pdf`);
  };
  
  // Export Scheda Singolo Giocatore - REPORT COMPLETO
  const downloadPlayerCardPDF = (playerNum) => {
    const player = players.find(p => p.numero === playerNum);
    if (!player || !player.nome) {
      alert('Giocatore non valido!');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 15;
    
    // ========== HEADER CON FOTO ==========
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('‚öΩ REPORT GIOCATORE', 105, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(100, 100, 100);
    doc.text(appTitle, 105, yPos, { align: 'center' });
    yPos += 10;
    
    // Box header con foto
    doc.setDrawColor(0, 51, 153);
    doc.setLineWidth(0.5);
    doc.rect(15, yPos, 180, 45);
    
    // Foto se presente
    if (player.foto) {
      try {
        doc.addImage(player.foto, 'JPEG', 20, yPos + 5, 35, 35);
      } catch (e) {
        console.log('Errore caricamento foto');
      }
    } else {
      doc.setFillColor(240, 240, 240);
      doc.rect(20, yPos + 5, 35, 35, 'F');
      doc.setFontSize(24);
      doc.setTextColor(150, 150, 150);
      doc.text(`#${player.numero}`, 37.5, yPos + 27, { align: 'center' });
    }
    
    // Dati anagrafici a destra della foto
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text(player.nome, 60, yPos + 12);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Ruolo: ${player.ruolo || 'N/A'}`, 60, yPos + 20);
    doc.text(`Numero Maglia: ${getNumeroAlfabetico(player.nome)}`, 60, yPos + 26);
    
    if (player.dataNascita) {
      const age = calculateAge(player.dataNascita);
      doc.text(`Et√†: ${age} anni (${player.dataNascita})`, 60, yPos + 32);
    }
    if (player.piede) {
      doc.text(`Piede: ${player.piede}`, 60, yPos + 38);
    }
    
    yPos += 50;
    
    // ========== STATISTICHE ALLENAMENTI ==========
    const playerTrainings = trainings.filter(t => {
      if (!player.dataCreazione) return true;
      return new Date(t.data) >= new Date(player.dataCreazione);
    });
    
    const presenzeCount = playerTrainings.filter(t => t.presenze && t.presenze[player.numero]).length;
    const assenzeCount = playerTrainings.filter(t => t.presenze && !t.presenze[player.numero]).length;
    const totAllenamenti = presenzeCount + assenzeCount;
    const percPresenze = totAllenamenti > 0 ? ((presenzeCount / totAllenamenti) * 100).toFixed(1) : 0;
    
    const infortuniCount = trainings.filter(t => t.infortuni && t.infortuni[player.numero]).length;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('üèãÔ∏è STATISTICHE ALLENAMENTI', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`‚Ä¢ Presenze: ${presenzeCount}/${totAllenamenti}`, 20, yPos);
    doc.text(`‚Ä¢ % Presenze: ${percPresenze}%`, 110, yPos);
    yPos += 6;
    doc.text(`‚Ä¢ Assenze: ${assenzeCount}`, 20, yPos);
    doc.text(`‚Ä¢ Infortuni: ${infortuniCount}`, 110, yPos);
    yPos += 10;
    
    // ========== STATISTICHE PARTITE ==========
    const playerMatches = matches.filter(m => {
      if (!player.dataCreazione) return true;
      return new Date(m.data) >= new Date(player.dataCreazione);
    });
    
    const convocato = playerMatches.filter(m => m.convocati && m.convocati[player.numero]).length;
    const titolare = playerMatches.filter(m => m.titolari && m.titolari[player.numero]).length;
    const percConvocazioni = playerMatches.length > 0 ? ((convocato / playerMatches.length) * 100).toFixed(1) : 0;
    const percTitolarita = playerMatches.length > 0 ? ((titolare / playerMatches.length) * 100).toFixed(1) : 0;
    
    let totalGoals = 0;
    let totalAssists = 0;
    let totalGolSubiti = 0;
    let gialliGioco = 0;
    let gialliProtesta = 0;
    let rossiGioco = 0;
    let rossiProtesta = 0;
    let totalMinutes = 0;
    
    playerMatches.forEach(match => {
      totalGoals += parseInt(match.golFatti?.[player.numero] || 0);
      totalAssists += parseInt(match.assist?.[player.numero] || 0);
      totalGolSubiti += parseInt(match.golSubiti?.[player.numero] || 0);
      gialliGioco += parseInt(match.gialliGioco?.[player.numero] || 0);
      gialliProtesta += parseInt(match.gialliProtesta?.[player.numero] || 0);
      rossiGioco += parseInt(match.rossiGioco?.[player.numero] || 0);
      rossiProtesta += parseInt(match.rossiProtesta?.[player.numero] || 0);
      totalMinutes += parseInt(match.minutiGiocati?.[player.numero] || 0);
    });
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('‚öΩ STATISTICHE PARTITE', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`‚Ä¢ Convocato: ${convocato}/${playerMatches.length}`, 20, yPos);
    doc.text(`‚Ä¢ % Convocazioni: ${percConvocazioni}%`, 110, yPos);
    yPos += 6;
    doc.text(`‚Ä¢ Titolare: ${titolare}/${playerMatches.length}`, 20, yPos);
    doc.text(`‚Ä¢ % Titolarit√†: ${percTitolarita}%`, 110, yPos);
    yPos += 6;
    doc.text(`‚Ä¢ Minuti giocati: ${totalMinutes}'`, 20, yPos);
    yPos += 10;
    
    // ========== STATISTICHE GIOCO ==========
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('üìä STATISTICHE GIOCO', 15, yPos);
    yPos += 7;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    doc.text(`‚Ä¢ Gol: ${totalGoals}`, 20, yPos);
    doc.text(`‚Ä¢ Assist: ${totalAssists}`, 110, yPos);
    yPos += 6;
    if (totalGolSubiti > 0) {
      doc.text(`‚Ä¢ Gol Subiti: ${totalGolSubiti}`, 20, yPos);
      yPos += 6;
    }
    
    // Cartellini
    if (gialliGioco + gialliProtesta + rossiGioco + rossiProtesta > 0) {
      doc.text(`‚Ä¢ üü® Giallo Gioco: ${gialliGioco}`, 20, yPos);
      doc.text(`‚Ä¢ üü® Giallo Protesta: ${gialliProtesta}`, 110, yPos);
      yPos += 6;
      doc.text(`‚Ä¢ üü• Rosso Gioco: ${rossiGioco}`, 20, yPos);
      doc.text(`‚Ä¢ üü• Rosso Protesta: ${rossiProtesta}`, 110, yPos);
      yPos += 6;
    }
    yPos += 5;
    
    // ========== LISTA PARTITE DETTAGLIATA ==========
    if (yPos > 200) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 51, 153);
    doc.text('üìã PARTITE GIOCATE', 15, yPos);
    yPos += 7;
    
    const matchesWithPlayer = playerMatches.filter(m => 
      (m.convocati && m.convocati[player.numero]) || 
      (m.titolari && m.titolari[player.numero]) ||
      (m.minutiGiocati && m.minutiGiocati[player.numero] > 0)
    ).sort((a, b) => new Date(b.data) - new Date(a.data));
    
    if (matchesWithPlayer.length > 0) {
      const tableData = matchesWithPlayer.slice(0, 15).map(m => {
        const data = new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
        const isTitolare = m.titolari && m.titolari[player.numero];
        const minuti = m.minutiGiocati?.[player.numero] || 0;
        const gol = m.golFatti?.[player.numero] || 0;
        const assist = m.assist?.[player.numero] || 0;
        const risultato = m.risultato || '-';
        
        return [
          data,
          m.avversario || 'N/A',
          risultato,
          isTitolare ? '‚úì' : '-',
          minuti + "'",
          gol > 0 ? gol : '-',
          assist > 0 ? assist : '-'
        ];
      });
      
      doc.autoTable({
        startY: yPos,
        head: [['Data', 'Avversario', 'Ris.', 'Tit.', 'Min', 'G', 'A']],
        body: tableData,
        theme: 'grid',
        headStyles: { 
          fillColor: [0, 51, 153],
          fontSize: 8,
          fontStyle: 'bold',
          halign: 'center'
        },
        bodyStyles: { 
          fontSize: 7,
          cellPadding: 1.5
        },
        columnStyles: {
          0: { cellWidth: 18 },
          1: { cellWidth: 50 },
          2: { cellWidth: 18, halign: 'center' },
          3: { cellWidth: 12, halign: 'center' },
          4: { cellWidth: 15, halign: 'center' },
          5: { cellWidth: 10, halign: 'center' },
          6: { cellWidth: 10, halign: 'center' }
        },
        margin: { left: 15, right: 15 }
      });
      
      yPos = doc.lastAutoTable.finalY + 10;
      
      if (matchesWithPlayer.length > 15) {
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`(Mostrate le ultime 15 partite su ${matchesWithPlayer.length} totali)`, 15, yPos);
        yPos += 5;
      }
    } else {
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100);
      doc.setFont(undefined, 'italic');
      doc.text('Nessuna partita giocata', 20, yPos);
      yPos += 10;
    }
    
    // ========== MVP ==========
    const mvpCount = matches.filter(m => m.mvp === player.numero).length;
    if (mvpCount > 0) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(218, 165, 32);
      doc.text(`üèÜ MVP: ${mvpCount} ${mvpCount === 1 ? 'volta' : 'volte'}`, 15, yPos);
      yPos += 8;
    }
    
    // ========== INFORTUNI ==========
    if (infortuniCount > 0) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(200, 0, 0);
      doc.text(`ü§ï Infortuni: ${infortuniCount}`, 15, yPos);
      yPos += 8;
    }
    
    // ========== FOOTER ==========
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.setFont(undefined, 'italic');
    doc.text(`Report generato il ${new Date().toLocaleDateString('it-IT')} - ${appTitle}`, 105, 285, { align: 'center' });
    
    const fileName = `report_${player.nome.replace(/\s+/g, '_').toLowerCase()}.pdf`;
    doc.save(fileName);
    showToast(`üìÑ Report PDF di ${player.nome} scaricato!`, 'success');
  };
  
  // Download Backup JSON
  const downloadBackupJSON = () => {
    const backupData = {
      version: '2.0',
      exportDate: new Date().toISOString(),
      appTitle,
      teamLogo,
      players,
      trainings,
      matches,
      infoPartita,
      moduloTattico
    };
    
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `backup_gestionale_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    alert('‚úÖ Backup completato! File salvato.');
  };

  // ========== FUNZIONI PER ANALISI TATTICA ==========

  const moduliDisponibili = [
    { nome: '4-4-2', descrizione: 'Classico equilibrato' },
    { nome: '4-3-3', descrizione: 'Offensivo con ali' },
    { nome: '3-5-2', descrizione: 'Dominio centrocampo' },
    { nome: '4-2-3-1', descrizione: 'Moderno e versatile' },
    { nome: '3-4-3', descrizione: 'Ultra offensivo' },
    { nome: '5-3-2', descrizione: 'Difensivo e compatto' },
    { nome: '4-1-4-1', descrizione: 'Pressing alto' },
    { nome: '4-3-1-2', descrizione: 'Centrocampo folto' }
  ];

  const getPosizioniModulo = (modulo) => {
    const posizioni = {
      '4-4-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 20, y: 50, ruolo: 'E' }, { x: 40, y: 50, ruolo: 'CC' }, { x: 60, y: 50, ruolo: 'CC' }, { x: 80, y: 50, ruolo: 'E' },
        { x: 40, y: 25, ruolo: 'A' }, { x: 60, y: 25, ruolo: 'A' }
      ],
      '4-3-3': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 35, y: 55, ruolo: 'MC' }, { x: 50, y: 50, ruolo: 'CC' }, { x: 65, y: 55, ruolo: 'MC' },
        { x: 20, y: 25, ruolo: 'AD' }, { x: 50, y: 20, ruolo: 'PC' }, { x: 80, y: 25, ruolo: 'AS' }
      ],
      '3-5-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 30, y: 75, ruolo: 'DC' }, { x: 50, y: 75, ruolo: 'DC' }, { x: 70, y: 75, ruolo: 'DC' },
        { x: 15, y: 55, ruolo: 'E' }, { x: 35, y: 52, ruolo: 'MC' }, { x: 50, y: 50, ruolo: 'CC' }, { x: 65, y: 52, ruolo: 'MC' }, { x: 85, y: 55, ruolo: 'E' },
        { x: 40, y: 25, ruolo: 'A' }, { x: 60, y: 25, ruolo: 'A' }
      ],
      '4-2-3-1': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 40, y: 60, ruolo: 'MD' }, { x: 60, y: 60, ruolo: 'MD' },
        { x: 20, y: 38, ruolo: 'AE' }, { x: 50, y: 35, ruolo: 'TQ' }, { x: 80, y: 38, ruolo: 'AD' },
        { x: 50, y: 18, ruolo: 'PC' }
      ],
      '3-4-3': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 30, y: 75, ruolo: 'DC' }, { x: 50, y: 75, ruolo: 'DC' }, { x: 70, y: 75, ruolo: 'DC' },
        { x: 20, y: 55, ruolo: 'E' }, { x: 40, y: 52, ruolo: 'CC' }, { x: 60, y: 52, ruolo: 'CC' }, { x: 80, y: 55, ruolo: 'E' },
        { x: 20, y: 25, ruolo: 'AD' }, { x: 50, y: 20, ruolo: 'PC' }, { x: 80, y: 25, ruolo: 'AS' }
      ],
      '5-3-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 15, y: 75, ruolo: 'TD' }, { x: 32, y: 75, ruolo: 'DC' }, { x: 50, y: 75, ruolo: 'DC' }, { x: 68, y: 75, ruolo: 'DC' }, { x: 85, y: 75, ruolo: 'TS' },
        { x: 35, y: 52, ruolo: 'MC' }, { x: 50, y: 50, ruolo: 'CC' }, { x: 65, y: 52, ruolo: 'MC' },
        { x: 40, y: 25, ruolo: 'A' }, { x: 60, y: 25, ruolo: 'A' }
      ],
      '4-1-4-1': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 50, y: 62, ruolo: 'MD' },
        { x: 20, y: 48, ruolo: 'E' }, { x: 40, y: 45, ruolo: 'CC' }, { x: 60, y: 45, ruolo: 'CC' }, { x: 80, y: 48, ruolo: 'E' },
        { x: 50, y: 20, ruolo: 'PC' }
      ],
      '4-3-1-2': [
        { x: 50, y: 90, ruolo: 'P' },
        { x: 20, y: 75, ruolo: 'TD' }, { x: 40, y: 75, ruolo: 'DC' }, { x: 60, y: 75, ruolo: 'DC' }, { x: 80, y: 75, ruolo: 'TS' },
        { x: 35, y: 55, ruolo: 'MC' }, { x: 50, y: 52, ruolo: 'CC' }, { x: 65, y: 55, ruolo: 'MC' },
        { x: 50, y: 35, ruolo: 'TQ' },
        { x: 40, y: 20, ruolo: 'A' }, { x: 60, y: 20, ruolo: 'A' }
      ]
    };
    return posizioni[modulo] || [];
  };

  const CampoTattico = ({ moduloNostro, moduloAvversario, evidenziaContrasto }) => {
    const posizioniNostre = getPosizioniModulo(moduloNostro);
    const posizioniAvversarie = getPosizioniModulo(moduloAvversario).map(pos => ({
      ...pos,
      y: 100 - pos.y
    }));

    const calcolaDistanza = (x1, y1, x2, y2) => {
      return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    };

    const sovrapposizioni = [];
    const giocatoriGiaUsati = new Set();
    
    posizioniNostre.forEach((posNostra, idxNostra) => {
      posizioniAvversarie.forEach((posAvversaria, idxAvversaria) => {
        const distanza = calcolaDistanza(posNostra.x, posNostra.y, posAvversaria.x, posAvversaria.y);
        const sogliaSovrapposizione = 2.5;
        
        if (distanza < sogliaSovrapposizione) {
          const keyNostra = `nost-${idxNostra}`;
          const keyAvversaria = `avv-${idxAvversaria}`;
          
          if (!giocatoriGiaUsati.has(keyNostra) && !giocatoriGiaUsati.has(keyAvversaria)) {
            sovrapposizioni.push({
              x: (posNostra.x + posAvversaria.x) / 2,
              y: (posNostra.y + posAvversaria.y) / 2,
              ruoloNostro: posNostra.ruolo,
              ruoloAvversario: posAvversaria.ruolo,
              indexNostra: idxNostra,
              indexAvversaria: idxAvversaria
            });
            giocatoriGiaUsati.add(keyNostra);
            giocatoriGiaUsati.add(keyAvversaria);
          }
        }
      });
    });

    const posizioniNostreFiltrate = posizioniNostre.filter((_, idx) => !giocatoriGiaUsati.has(`nost-${idx}`));
    const posizioniAvversarieFiltrate = posizioniAvversarie.filter((_, idx) => !giocatoriGiaUsati.has(`avv-${idx}`));

    return (
      <div className="bg-green-700 rounded-lg p-4 shadow-xl">
        <svg viewBox="0 0 100 100" className="w-full h-auto" style={{ maxHeight: '600px' }}>
          <rect width="100" height="100" fill="#2d7a3e" />
          
          <line x1="0" y1="50" x2="100" y2="50" stroke="white" strokeWidth="0.3" opacity="0.8" />
          <circle cx="50" cy="50" r="8" fill="none" stroke="white" strokeWidth="0.3" opacity="0.8" />
          <circle cx="50" cy="50" r="0.8" fill="white" opacity="0.8" />
          
          <rect x="30" y="0" width="40" height="15" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <rect x="42" y="0" width="16" height="8" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <circle cx="50" cy="10" r="0.6" fill="white" opacity="0.6" />
          
          <rect x="30" y="85" width="40" height="15" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <rect x="42" y="92" width="16" height="8" fill="none" stroke="white" strokeWidth="0.3" opacity="0.6" />
          <circle cx="50" cy="90" r="0.6" fill="white" opacity="0.6" />
          
          <rect x="0.5" y="0.5" width="99" height="99" fill="none" stroke="white" strokeWidth="0.5" opacity="0.8" />

          <text x="50" y="48" textAnchor="middle" fill="white" fontSize="3" opacity="0.5" fontWeight="bold">
            AVVERSARI
          </text>
          <text x="50" y="52" textAnchor="middle" fill="white" fontSize="3" opacity="0.5" fontWeight="bold">
            NOSTRA SQUADRA
          </text>

          <defs>
            <clipPath id="leftHalf">
              <rect x="-2.5" y="-2.5" width="2.5" height="5" />
            </clipPath>
            <clipPath id="rightHalf">
              <rect x="0" y="-2.5" width="2.5" height="5" />
            </clipPath>
          </defs>

          {posizioniAvversarieFiltrate.map((pos, idx) => (
            <g key={`avv-solo-${idx}`}>
              <circle 
                cx={pos.x} 
                cy={pos.y} 
                r="2.5" 
                fill="#ef4444" 
                stroke="white" 
                strokeWidth="0.3"
                opacity="0.9"
              />
              <text 
                x={pos.x} 
                y={pos.y + 0.8} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.8" 
                fontWeight="bold"
              >
                {pos.ruolo}
              </text>
            </g>
          ))}

          {posizioniNostreFiltrate.map((pos, idx) => (
            <g key={`nost-solo-${idx}`}>
              <circle 
                cx={pos.x} 
                cy={pos.y} 
                r="2.5" 
                fill="#3b82f6" 
                stroke="white" 
                strokeWidth="0.3"
                opacity="0.9"
              />
              <text 
                x={pos.x} 
                y={pos.y + 0.8} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.8" 
                fontWeight="bold"
              >
                {pos.ruolo}
              </text>
            </g>
          ))}

          {sovrapposizioni.map((sovr, idx) => (
            <g key={`sovr-${idx}`}>
              <g clipPath="url(#leftHalf)" transform={`translate(${sovr.x}, ${sovr.y})`}>
                <circle 
                  cx="0" 
                  cy="0" 
                  r="2.5" 
                  fill="#ef4444" 
                  opacity="0.95"
                />
              </g>
              
              <g clipPath="url(#rightHalf)" transform={`translate(${sovr.x}, ${sovr.y})`}>
                <circle 
                  cx="0" 
                  cy="0" 
                  r="2.5" 
                  fill="#3b82f6" 
                  opacity="0.95"
                />
              </g>
              
              <circle 
                cx={sovr.x} 
                cy={sovr.y} 
                r="2.5" 
                fill="none" 
                stroke="white" 
                strokeWidth="0.4"
              />
              
              <line 
                x1={sovr.x} 
                y1={sovr.y - 2.5} 
                x2={sovr.x} 
                y2={sovr.y + 2.5} 
                stroke="white" 
                strokeWidth="0.3"
              />
              
              <text 
                x={sovr.x} 
                y={sovr.y - 0.3} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.3" 
                fontWeight="bold"
              >
                {sovr.ruoloAvversario}
              </text>
              <text 
                x={sovr.x} 
                y={sovr.y + 1.3} 
                textAnchor="middle" 
                fill="white" 
                fontSize="1.3" 
                fontWeight="bold"
              >
                {sovr.ruoloNostro}
              </text>
            </g>
          ))}

          {evidenziaContrasto && (
            <>
              <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#fbbf24" />
                </marker>
              </defs>
            </>
          )}
        </svg>

        <div className="mt-4 flex flex-col gap-2">
          <div className="flex justify-center gap-6 text-white text-sm">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full bg-red-500 border-2 border-white"></div>
              <span className="font-semibold">Avversari ({moduloAvversario})</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full bg-blue-500 border-2 border-white"></div>
              <span className="font-semibold">Nostra Squadra ({moduloNostro})</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full border-2 border-white" style={{background: 'linear-gradient(90deg, #ef4444 50%, #3b82f6 50%)'}}>
              </div>
              <span className="font-semibold">Zona Contesa</span>
            </div>
          </div>
          {sovrapposizioni.length > 0 && (
            <div className="text-center text-white text-xs opacity-75">
              {sovrapposizioni.length} zone di contrasto diretto
            </div>
          )}
        </div>
      </div>
    );
  };

  const analizzaModuloAvversario = (modulo) => {
    const analisi = {
      '4-4-2': {
        puntiDeboli: [
          'Vulnerabile sulle fasce contro moduli a 3 punte',
          'Centrocampo pu√≤ essere sopraffatto numericamente',
          'Spazi tra linee sfruttabili con trequartista'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Le tre punte sovraccaricano i due centrali avversari',
            vantaggi: ['Superiorit√† numerica in attacco', 'Ampiezza sulle fasce', 'Pressing sui mediani'],
            tattiche: ['Attaccare gli spazi tra terzino e centrale', 'Ali larghe per allargare la difesa', 'Centravanti mobile tra i due centrali'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Velocita esplosiva per puntare 1 contro 1', 'Dribbling superiore per saltare avversario', 'Capacita di cross preciso dal fondo', 'Resistenza per coprire tutta la fascia', 'Tecnica individuale eccellente'],
                importanza: 'FONDAMENTALE - Devono dominare i duelli con i terzini avversari'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Mobilita per muoversi tra i due centrali', 'Capacita di proteggere palla', 'Finalizzazione precisa', 'Senso della posizione', 'Fisicita per tenere i palloni'],
                importanza: 'ESSENZIALE - Deve occupare entrambi i centrali avversari'
              },
              {
                ruolo: 'REGISTA (Centrocampista Centrale)',
                caratteristiche: ['Visione di gioco superiore', 'Passaggio lungo preciso', 'Intelligenza tattica', 'Capacita di dettare i tempi', 'Buona tecnica di base'],
                importanza: 'CRITICO - Deve orchestrare il gioco e servire le punte'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Il trequartista trova spazio tra le linee avversarie',
            vantaggi: ['Trequartista libero tra centrocampo e difesa', 'Superiorit√† numerica a centrocampo', 'Transizioni veloci'],
            tattiche: ['Trequartista negli spazi tra linee', 'Esterni ad attaccare i terzini', 'Doppio mediano per controllare il gioco'],
            ruoliChiave: [
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita e imprevedibilita', 'Ottima visione di gioco', 'Tecnica sopraffina', 'Capacita di giocare tra le linee', 'Dribbling stretto e controllo di palla'],
                importanza: 'FONDAMENTALE - Fulcro del gioco tra centrocampo e attacco'
              },
              {
                ruolo: 'MEDIANI (Coppia)',
                caratteristiche: ['Intelligenza tattica elevata', 'Capacita di interdizione', 'Passaggio verticale preciso', 'Copertura reciproca', 'Lettura delle situazioni'],
                importanza: 'ESSENZIALE - Devono dominare centrocampo ed equilibrare'
              },
              {
                ruolo: 'ESTERNI OFFENSIVI',
                caratteristiche: ['Velocita nelle ripartenze', 'Capacita di attaccare la profondita', 'Dribbling efficace', 'Cross precisi', 'Rientri difensivi disciplinati'],
                importanza: 'IMPORTANTE - Creano ampiezza e attaccano gli spazi'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 85,
            motivo: 'Superiorit√† numerica a centrocampo (5 vs 4)',
            vantaggi: ['Dominio del centrocampo', 'Quinti che sovraccaricano le fasce', 'Solidit√† difensiva'],
            tattiche: ['Dominare il centrocampo numericamente', 'Quinti a creare superiorit√† sulle fasce', 'Pressing sui mediani avversari'],
            ruoliChiave: [
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Resistenza straordinaria', 'Velocita per coprire 70+ metri', 'Capacita offensive e difensive bilanciate', 'Cross preciso', 'Intelligenza posizionale'],
                importanza: 'FONDAMENTALE - Devono dominare le fasce per 90 minuti'
              },
              {
                ruolo: 'REGISTA CENTRALE',
                caratteristiche: ['Visione di gioco panoramica', 'Passaggio lungo e corto di qualita', 'Posizionamento impeccabile', 'Capacita di verticalizzare', 'Calma sotto pressione'],
                importanza: 'ESSENZIALE - Deve orchestrare il gioco a centrocampo'
              },
              {
                ruolo: 'CENTRALE LIBERO',
                caratteristiche: ['Lettura del gioco eccellente', 'Capacita di impostare', 'Passaggio lungo preciso', 'Leadership difensiva', 'Posizionamento anticipatorio'],
                importanza: 'CRITICO - Deve dirigere la difesa a 3'
              }
            ]
          }
        ]
      },
      '4-3-3': {
        puntiDeboli: [
          'Terzini esposti in fase difensiva',
          'Due mediani centrali possono essere in inferiorit√†',
          'Spazi centrali tra i centrocampisti'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-1-2',
            efficacia: 95,
            motivo: 'Superiorit√† numerica in mezzo al campo',
            vantaggi: ['3 centrocampisti vs 2 mediani avversari', 'Trequartista a disturbare il regista', 'Solidit√† centrale'],
            tattiche: ['Chiudere il centro del campo', 'Pressare i due mediani', 'Sfruttare gli spazi tra le linee'],
            ruoliChiave: [
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Superiorit√† numerica sui due mediani', 'Capacita di chiudere gli spazi centrali', 'Pressione coordinata', 'Controllo del possesso', 'Mobilita per coprire il campo'],
                importanza: 'FONDAMENTALE - Devono soffocare i due mediani avversari'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Pressing sul regista avversario', 'Capacita di intercettare passaggi', 'Creativita negli spazi', 'Inserimenti negli spazi', 'Visione di gioco'],
                importanza: 'ESSENZIALE - Deve disturbare la costruzione e creare gioco'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti coordinati', 'Pressing sui difensori', 'Capacita di finalizzare contropiede', 'Gioco di sponda', 'Sfruttamento spazi tra le linee'],
                importanza: 'IMPORTANTE - Devono sfruttare la superiorit√† a centrocampo'
              }
            ]
          },
          {
            modulo: '4-4-2',
            efficacia: 85,
            motivo: 'Equilibrio e compattezza difensiva',
            vantaggi: ['Quattro difensori contro tre attaccanti', 'Esterni bassi contro le ali', 'Compattezza difensiva'],
            tattiche: ['Esterni che rientrano sulle ali avversarie', 'Blocco basso compatto', 'Ripartenze in verticale'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Disciplina nel rientro difensivo', 'Marcatura stretta sulle ali', 'Capacita di duello 1vs1', 'Resistenza per doppia fase', 'Velocita nelle ripartenze'],
                importanza: 'FONDAMENTALE - Devono neutralizzare le ali avversarie'
              },
              {
                ruolo: 'DIFENSORI CENTRALI (Coppia)',
                caratteristiche: ['Compattezza e coperture reciproche', 'Marcatura sul centravanti', 'Anticipazione sui movimenti', 'Fisicita nei duelli', 'Comunicazione costante'],
                importanza: 'ESSENZIALE - Devono tenere il blocco compatto e basso'
              },
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Coppia)',
                caratteristiche: ['Copertura degli spazi centrali', 'Capacita di recupero palla', 'Passaggio verticale preciso', 'Disciplina posizionale', 'Supporto alle ripartenze'],
                importanza: 'CRITICO - Devono proteggere la difesa e innescare contropiede'
              }
            ]
          },
          {
            modulo: '5-3-2',
            efficacia: 80,
            motivo: 'Difesa a 5 per neutralizzare le tre punte',
            vantaggi: ['Parit√† numerica in difesa', 'Braccetti sui esterni avversari', 'Solidit√† difensiva'],
            tattiche: ['Difesa a 5 per coprire il fronte offensivo', 'Braccetti sulle ali avversarie', 'Ripartenze rapide'],
            ruoliChiave: [
              {
                ruolo: 'BRACCETTI (Difensori Laterali)',
                caratteristiche: ['Marcatura stretta sulle ali', 'Velocita per seguire gli attaccanti esterni', 'Capacita di duello 1vs1', 'Aggressivita nei contrasti', 'Copertura sulla fascia'],
                importanza: 'FONDAMENTALE - Devono annullare le ali avversarie'
              },
              {
                ruolo: 'CENTRALE LIBERO',
                caratteristiche: ['Lettura del gioco anticipatoria', 'Coperture sul centravanti', 'Leadership difensiva', 'Capacita di impostazione', 'Posizionamento impeccabile'],
                importanza: 'ESSENZIALE - Deve coordinare la linea a 5 e coprire il centro'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Capacita di tenere palla', 'Pressing coordinato', 'Finalizzazione nelle ripartenze', 'Movimenti per creare spazi', 'Resistenza fisica'],
                importanza: 'IMPORTANTE - Devono sfruttare le ripartenze rapide'
              }
            ]
          }
        ]
      },
      '3-5-2': {
        puntiDeboli: [
          'Tre difensori vulnerabili contro attacchi sulle fasce',
          'Quinti devono coprire molta fascia',
          'Spazi tra braccetti e centrale'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Ali larghe per attaccare i tre difensori centrali',
            vantaggi: ['Superiorit√† numerica in attacco (3 vs 3)', 'Ali larghe sfruttano gli spazi', 'Terzini per sovraccaricare le fasce'],
            tattiche: ['Ali molto larghe per allargare la difesa', 'Attaccare gli spazi laterali', 'Terzini alti per sovraccaricare i quinti'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Ampiezza massima per allargare i tre difensori', 'Velocita per attaccare gli spazi larghi', 'Dribbling per superare i braccetti', 'Movimenti dentro-fuori', 'Cross e finalizzazione'],
                importanza: 'FONDAMENTALE - Devono sfruttare l\'ampiezza e creare spazi'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni costanti sulle fasce', 'Capacita di creare 2vs1 contro i quinti', 'Cross dal fondo', 'Spinta offensiva continua', 'Sincronizzazione con le ali'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce e stancare i quinti'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Movimenti tra i tre difensori', 'Capacita di occupare il centrale', 'Finalizzazione precisa', 'Gioco aereo efficace', 'Attacco della profondita'],
                importanza: 'CRITICO - Deve impegnare i tre difensori centrali'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Esterni e terzini per attaccare le fasce',
            vantaggi: ['Quattro attaccanti sugli esterni', 'Centrocampo equilibrato', 'Ampiezza massima'],
            tattiche: ['Esterni larghi contro i braccetti', 'Terzini offensivi per sovraccarico', 'Attaccare gli spazi laterali'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Posizionamento largo contro i braccetti', 'Velocita per puntare 1vs1', 'Dribbling per superare l\'avversario', 'Capacita di tagliare dentro', 'Cross e finalizzazione'],
                importanza: 'FONDAMENTALE - Devono attaccare i braccetti e creare ampiezza'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni sincronizzate', 'Capacita di creare 2vs1 sui quinti', 'Cross dal fondo', 'Resistenza per spinta continua', 'Ampiezza offensiva massima'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con gli esterni'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita negli spazi centrali', 'Capacita di servire gli esterni', 'Visione per cambi di lato rapidi', 'Dribbling tra le linee', 'Inserimenti coordinati'],
                importanza: 'CRITICO - Deve orchestrare gli attacchi sulle fasce'
              }
            ]
          },
          {
            modulo: '3-4-3',
            efficacia: 85,
            motivo: 'Attacco speculare con maggiore offensivit√†',
            vantaggi: ['Parit√† difensiva ma pi√π punte', 'Ali contro quinti', 'Pressing alto efficace'],
            tattiche: ['Pressing alto sui tre difensori', 'Ali contro quinti affaticati', 'Attacco costante sulle fasce'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Pressing aggressivo sui quinti', 'Velocita per sfruttare stanchezza avversaria', 'Dribbling per saltare l\'uomo', 'Ampiezza massima sulle fasce', 'Finalizzazione da posizione laterale'],
                importanza: 'FONDAMENTALE - Devono sfinire e superare i quinti avversari'
              },
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Supporto alle ali', 'Sovrapposizioni coordinate', 'Capacita di creare superiorit√†', 'Cross e assistenza', 'Resistenza per doppia fase'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con le ali'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Pressing sul centrale libero', 'Movimenti per occupare i tre difensori', 'Capacita di finalizzazione', 'Gioco aereo efficace', 'Coordinazione con le ali'],
                importanza: 'CRITICO - Deve pressare e impegnare la difesa a tre'
              }
            ]
          }
        ]
      },
      '4-2-3-1': {
        puntiDeboli: [
          'Centrocampo pu√≤ essere sovraccaricato',
          'Due mediani soli contro centrocampi numerosi',
          'Punta isolata se trequartista non sostiene'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 90,
            motivo: 'Tre centrocampisti vs due mediani avversari',
            vantaggi: ['Superiorit√† numerica in mezzo', 'Dominio del centrocampo', 'Triangolazioni centrali'],
            tattiche: ['Pressare i due mediani', 'Dominare il centrocampo centrale', 'Giro palla rapido per aprire spazi'],
            ruoliChiave: [
              {
                ruolo: 'REGISTA (Centrocampista Centrale)',
                caratteristiche: ['Visione di gioco superiore', 'Passaggio preciso sotto pressione', 'Capacita di dettare i tempi', 'Intelligenza posizionale', 'Tecnica di base eccellente'],
                importanza: 'FONDAMENTALE - Deve dominare il duello con i due mediani'
              },
              {
                ruolo: 'MEZZALI (Centrocampisti Interni)',
                caratteristiche: ['Inserimenti coordinati negli spazi', 'Capacita di pressione sui mediani', 'Dinamismo e resistenza', 'Passaggio verticale preciso', 'Senso tattico elevato'],
                importanza: 'ESSENZIALE - Devono creare superiorit√† numerica costante'
              },
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Velocita per attaccare gli spazi', 'Dribbling per saltare i terzini', 'Capacita di tagliare dentro al campo', 'Finalizzazione precisa', 'Movimenti coordinati'],
                importanza: 'CRITICO - Devono sfruttare gli spazi creati dal centrocampo'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 85,
            motivo: 'Cinque centrocampisti dominano la zona centrale',
            vantaggi: ['Superiorit√† numerica totale a centrocampo', 'Quinti vs terzini', 'Controllo del gioco'],
            tattiche: ['Dominare il centrocampo', 'Pressione sui portatori di palla', 'Quinti per creare superiorit√†'],
            ruoliChiave: [
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Resistenza eccezionale per 90 minuti', 'Velocita nelle transizioni', 'Capacita offensive e difensive', 'Cross precisi', 'Disciplina tattica'],
                importanza: 'FONDAMENTALE - Devono sovraccarica re le fasce contro i terzini'
              },
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Trio)',
                caratteristiche: ['Dominio fisico e tecnico', 'Capacita di recupero palla', 'Passaggio verticale di qualita', 'Mobilita per coprire spazi', 'Intelligenza tattica superiore'],
                importanza: 'ESSENZIALE - Devono soffocare i due mediani avversari'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Mobilita per attaccare la profondita', 'Capacita di legare il gioco', 'Finalizzazione efficace', 'Movimenti coordinati', 'Pressing sui difensori'],
                importanza: 'IMPORTANTE - Devono sfruttare il dominio a centrocampo'
              }
            ]
          },
          {
            modulo: '4-1-4-1',
            efficacia: 80,
            motivo: 'Pressing ultra-aggressivo sul trequartista',
            vantaggi: ['Mediano sul trequartista avversario', 'Pressing alto coordinato', 'Recupero palla alto'],
            tattiche: ['Mediano che marca il trequartista', 'Pressing aggressivo sulla costruzione', 'Corto muso per recupero alto'],
            ruoliChiave: [
              {
                ruolo: 'MEDIANO (Davanti alla difesa)',
                caratteristiche: ['Marcatura asfissiante sul trequartista', 'Lettura preventiva dei passaggi', 'Aggressivita nel contrasto', 'Disciplina posizionale ferrea', 'Capacita di interdizione totale'],
                importanza: 'FONDAMENTALE - Deve annullare il trequartista avversario'
              },
              {
                ruolo: 'CENTROCAMPISTI (Quartetto)',
                caratteristiche: ['Pressing coordinato e aggressivo', 'Chiusura degli spazi centrali', 'Capacita di scaglionamento', 'Resistenza fisica elevata', 'Rapidita nelle transizioni'],
                importanza: 'ESSENZIALE - Devono recuperare palla nella meta campo avversaria'
              },
              {
                ruolo: 'PUNTA CENTRALE',
                caratteristiche: ['Pressing sui difensori centrali', 'Capacita di tenere palla', 'Finalizzazione nelle ripartenze', 'Intelligenza nei movimenti', 'Resistenza al gioco spalle alla porta'],
                importanza: 'IMPORTANTE - Deve essere il primo difensore e sfruttare le ripartenze'
              }
            ]
          }
        ]
      },
      '3-4-3': {
        puntiDeboli: [
          'Difesa esposta contro attacchi veloci',
          'Centrocampo in inferiorit√† numerica',
          'Esterni devono correre molto'
        ],
        moduliConsigliati: [
          {
            modulo: '4-4-2',
            efficacia: 90,
            motivo: 'Quattro difensori contro tre punte, equilibrio totale',
            vantaggi: ['Solidit√† difensiva', 'Equilibrio in tutti i reparti', 'Blocco compatto'],
            tattiche: ['Difesa solida contro le tre punte', 'Esterni che rientrano', 'Ripartenze verticali veloci'],
            ruoliChiave: [
              {
                ruolo: 'DIFENSORI CENTRALI (Coppia)',
                caratteristiche: ['Marcatura stretta sul centravanti', 'Coperture reciproche perfette', 'Fisicita nei duelli aerei', 'Capacita di anticipazione', 'Leadership difensiva'],
                importanza: 'FONDAMENTALE - Devono neutralizzare la punta centrale avversaria'
              },
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Disciplina nel rientrare sulle ali', 'Capacita di duello 1vs1', 'Resistenza per doppia fase', 'Velocita nelle ripartenze', 'Intelligenza posizionale'],
                importanza: 'ESSENZIALE - Devono chiudere le fasce contro le ali avversarie'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Velocita esplosiva nelle ripartenze', 'Capacita di tenere palla', 'Finalizzazione precisa', 'Movimenti coordinati', 'Pressing sui tre difensori'],
                importanza: 'CRITICO - Devono punire le ripartenze verticali'
              }
            ]
          },
          {
            modulo: '5-3-2',
            efficacia: 85,
            motivo: 'Difesa a 5 per contenere l\'attacco avversario',
            vantaggi: ['Superiorit√† numerica difensiva', 'Coperture costanti', 'Solidit√† estrema'],
            tattiche: ['Difesa a cinque per contenere', 'Braccetti sulle ali avversarie', 'Assorbire la pressione e ripartire'],
            ruoliChiave: [
              {
                ruolo: 'BRACCETTI (Difensori Laterali)',
                caratteristiche: ['Marcatura asfissiante sulle ali', 'Velocita per inseguire gli attaccanti', 'Capacita di duello aereo', 'Aggressivita nei contrasti', 'Copertura sulla fascia'],
                importanza: 'FONDAMENTALE - Devono annullare le ali avversarie'
              },
              {
                ruolo: 'CENTRALE LIBERO',
                caratteristiche: ['Lettura anticipatoria del gioco', 'Coperture preventive', 'Capacita di impostazione', 'Leadership difensiva assoluta', 'Posizionamento impeccabile'],
                importanza: 'ESSENZIALE - Deve coordinare la linea a 5 e coprire'
              },
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Capacita di assorbire pressione', 'Qualita nel passaggio verticale', 'Resistenza fisica elevata', 'Intelligenza nelle ripartenze', 'Controllo del tempo di gioco'],
                importanza: 'CRITICO - Devono gestire le transizioni difesa-attacco'
              }
            ]
          },
          {
            modulo: '4-3-1-2',
            efficacia: 80,
            motivo: 'Superiorit√† numerica a centrocampo',
            vantaggi: ['Dominio del centrocampo', 'Controllo del possesso', 'Trequartista libero'],
            tattiche: ['Controllare il centrocampo', 'Possesso palla per stancare l\'avversario', 'Pressing coordinato'],
            ruoliChiave: [
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Controllo totale del possesso palla', 'Passaggio corto preciso', 'Mobilita per coprire il campo', 'Capacita di recupero', 'Intelligenza nel giro palla'],
                importanza: 'FONDAMENTALE - Devono dominare il centrocampo e stancare l\'avversario'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita tra le linee', 'Visione di gioco superiore', 'Tecnica individuale eccellente', 'Capacita di verticalizzare', 'Dribbling in spazi stretti'],
                importanza: 'ESSENZIALE - Deve essere la chiave per sbloccare la difesa'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti coordinati', 'Capacita di attaccare la profondita', 'Finalizzazione precisa', 'Pressing sui tre difensori', 'Gioco spalle alla porta'],
                importanza: 'IMPORTANTE - Devono sfruttare gli spazi creati dal possesso'
              }
            ]
          }
        ]
      },
      '5-3-2': {
        puntiDeboli: [
          'Rinuncia all\'ampiezza offensiva',
          'Solo due attaccanti, scarso peso offensivo',
          'Centrocampo pu√≤ essere sopraffatto'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Attacco sulle fasce e superiorit√† in mezzo',
            vantaggi: ['Ali contro braccetti difensivi', 'Superiorit√† a centrocampo', 'Possesso palla prolungato'],
            tattiche: ['Allargare il gioco sulle fasce', 'Dominare il centrocampo', 'Possesso per far uscire l\'avversario'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Velocita per attaccare gli spazi larghi', 'Dribbling per superare i braccetti', 'Capacita di cross dal fondo', 'Movimenti dentro-fuori', 'Finalizzazione da posizione defilata'],
                importanza: 'FONDAMENTALE - Devono sfruttare l\'ampiezza e attaccare i braccetti'
              },
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Controllo del possesso palla', 'Passaggio preciso per allargare', 'Mobilita per coprire il campo', 'Capacita di verticalizzazione', 'Intelligenza nel giro palla'],
                importanza: 'ESSENZIALE - Devono dominare il centrocampo e servire le ali'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Spinta costante sulla fascia', 'Sovrapposizioni coordinate', 'Cross precisi', 'Capacita di creare superiorit√†', 'Resistenza per doppia fase'],
                importanza: 'CRITICO - Devono sovraccaricare le fasce con le ali'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Quattro attaccanti per scardinare il blocco difensivo',
            vantaggi: ['Attacco a cinque con terzini', 'Superiorit√† offensiva', 'Trequartista libero'],
            tattiche: ['Attaccare sulle fasce costantemente', 'Possesso prolungato', 'Terzini sempre alti'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Ampiezza massima sulle fasce', 'Dribbling per saltare i braccetti', 'Movimenti dentro-fuori coordinati', 'Cross precisi', 'Capacita di finalizzazione'],
                importanza: 'FONDAMENTALE - Devono allargare la difesa a 5 avversaria'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Creativita negli spazi centrali', 'Capacita di combinazioni rapide', 'Visione di gioco superiore', 'Dribbling in spazi stretti', 'Inserimenti negli spazi'],
                importanza: 'ESSENZIALE - Deve trovare varchi nella difesa compatta'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni costanti', 'Resistenza per fase offensiva prolungata', 'Cross dal fondo', 'Capacita di creare superiorit√†', 'Sincronia con gli esterni'],
                importanza: 'CRITICO - Devono sovraccaricare le fasce costantemente'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 80,
            motivo: 'Cinque centrocampisti per dominare il gioco',
            vantaggi: ['Superiorit√† a centrocampo', 'Controllo del possesso', 'Quinti offensivi'],
            tattiche: ['Dominare il centrocampo', 'Possesso palla lungo', 'Quinti che attaccano costantemente'],
            ruoliChiave: [
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Spinta offensiva continua', 'Resistenza per 90 minuti di fase attiva', 'Cross dal fondo', 'Capacita di creare superiorit√† numerica', 'Dribbling sulla fascia'],
                importanza: 'FONDAMENTALE - Devono attaccare costantemente le fasce'
              },
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Trio)',
                caratteristiche: ['Controllo del possesso prolungato', 'Passaggio preciso per cambiare gioco', 'Pazienza nel giro palla', 'Capacita di verticalizzare al momento giusto', 'Mobilita per aprire linee di passaggio'],
                importanza: 'ESSENZIALE - Devono dominare il possesso e stancare l\'avversario'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti per attaccare la profondita', 'Capacita di finalizzare occasioni', 'Gioco di sponda', 'Inserimenti coordinati', 'Pressing sui difensori'],
                importanza: 'IMPORTANTE - Devono sfruttare gli spazi creati dal possesso'
              }
            ]
          }
        ]
      },
      '4-1-4-1': {
        puntiDeboli: [
          'Punta molto isolata',
          'Distanze tra i reparti se non coordinati',
          'Dipendenza dal mediano davanti alla difesa'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-1-2',
            efficacia: 90,
            motivo: 'Due punte contro difesa a quattro e trequartista sul mediano',
            vantaggi: ['Superiorit√† in attacco', 'Trequartista sul mediano avversario', 'Peso offensivo maggiore'],
            tattiche: ['Due punte per impegnare i centrali', 'Trequartista a pressare il mediano', 'Centrocampisti che inseriscono'],
            ruoliChiave: [
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti complementari tra loro', 'Capacita di attaccare i due centrali', 'Finalizzazione precisa', 'Gioco di sponda efficace', 'Pressing coordinato'],
                importanza: 'FONDAMENTALE - Devono impegnare costantemente i due centrali'
              },
              {
                ruolo: 'TREQUARTISTA',
                caratteristiche: ['Pressing asfissiante sul mediano', 'Capacita di inserimento', 'Creativita negli spazi', 'Visione di gioco', 'Tecnica individuale superiore'],
                importanza: 'ESSENZIALE - Deve annullare il mediano e creare gioco'
              },
              {
                ruolo: 'CENTROCAMPISTI (Trio)',
                caratteristiche: ['Inserimenti negli spazi', 'Supporto alle punte', 'Capacita di finalizzazione da fuori', 'Equilibrio tra fase difensiva e offensiva', 'Mobilita costante'],
                importanza: 'CRITICO - Devono creare superiorit√† numerica in attacco'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 85,
            motivo: 'Quattro trequartisti per superare il pressing',
            vantaggi: ['Superiorit√† nella trequarti', 'Esterni mobili', 'Triangolazioni rapide'],
            tattiche: ['Giro palla veloce per superare il pressing', 'Esterni che attaccano gli spazi', 'Combinazioni strette'],
            ruoliChiave: [
              {
                ruolo: 'TREQUARTISTA CENTRALE',
                caratteristiche: ['Tecnica sopraffina sotto pressione', 'Capacita di giocate nello stretto', 'Visione per combinazioni rapide', 'Mobilita per sfuggire al mediano', 'Dribbling in spazi ridotti'],
                importanza: 'FONDAMENTALE - Deve battere il pressing del mediano avversario'
              },
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Velocita per attaccare gli spazi', 'Capacita di venire incontro', 'Triangolazioni con trequartista', 'Dribbling per saltare l\'uomo', 'Ampiezza e profondita'],
                importanza: 'ESSENZIALE - Devono allargare il pressing e creare superiorit√†'
              },
              {
                ruolo: 'MEDIANI (Coppia)',
                caratteristiche: ['Controllo del possesso', 'Passaggio veloce e preciso', 'Capacita di cambiare gioco', 'Mobilita per aprire linee', 'Copertura reciproca'],
                importanza: 'IMPORTANTE - Devono far girare palla velocemente per battere il pressing'
              }
            ]
          },
          {
            modulo: '3-5-2',
            efficacia: 80,
            motivo: 'Superiorit√† numerica a centrocampo',
            vantaggi: ['Cinque contro quattro in mezzo', 'Quinti offensivi', 'Controllo del gioco'],
            tattiche: ['Dominare il centrocampo', 'Quinti per creare superiorit√†', 'Possesso palla prolungato'],
            ruoliChiave: [
              {
                ruolo: 'CENTROCAMPISTI CENTRALI (Trio)',
                caratteristiche: ['Superiorit√† numerica sul quartetto avversario', 'Controllo del possesso', 'Capacita di verticalizzare', 'Mobilita per aprire spazi', 'Passaggio preciso'],
                importanza: 'FONDAMENTALE - Devono dominare il centrocampo con superiorit√†'
              },
              {
                ruolo: 'QUINTI (Esterni a tutta fascia)',
                caratteristiche: ['Ampiezza sulle fasce', 'Capacita di creare superiorit√† numerica', 'Cross dal fondo', 'Resistenza per fase attiva prolungata', 'Spinta offensiva costante'],
                importanza: 'ESSENZIALE - Devono allargare il campo e sovraccaricare le fasce'
              },
              {
                ruolo: 'PUNTE (Coppia)',
                caratteristiche: ['Movimenti per attaccare la profondita', 'Capacita di finalizzare', 'Gioco di sponda', 'Pressing sulla costruzione', 'Coordinazione nei movimenti'],
                importanza: 'IMPORTANTE - Devono sfruttare il dominio a centrocampo'
              }
            ]
          }
        ]
      },
      '4-3-1-2': {
        puntiDeboli: [
          'Mancanza di ampiezza, niente esterni',
          'Fasce scoperte in fase difensiva',
          'Terzini soli contro ali avversarie'
        ],
        moduliConsigliati: [
          {
            modulo: '4-3-3',
            efficacia: 95,
            motivo: 'Ali larghe per sfruttare le fasce scoperte',
            vantaggi: ['Ali libere sulle fasce', 'Terzini soli da attaccare', 'Ampiezza massima'],
            tattiche: ['Ali larghe contro terzini isolati', 'Attaccare costantemente le fasce', 'Cross dalle fasce'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Ampiezza massima sulle fasce', 'Velocita per puntare i terzini isolati', 'Dribbling superiore 1vs1', 'Cross precisi dal fondo', 'Capacita di finalizzazione'],
                importanza: 'FONDAMENTALE - Devono dominare i duelli con i terzini isolati'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni costanti', 'Sincronizzazione con le ali', 'Capacita di creare 2vs1', 'Cross dalla linea di fondo', 'Spinta offensiva continua'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con le ali'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Movimenti per attaccare gli spazi centrali', 'Capacita di finalizzare i cross', 'Gioco aereo efficace', 'Senso della posizione', 'Fisicita nei duelli'],
                importanza: 'CRITICO - Deve sfruttare i cross dalle fasce'
              }
            ]
          },
          {
            modulo: '4-2-3-1',
            efficacia: 90,
            motivo: 'Tre trequartisti sulle fasce per sovraccarico',
            vantaggi: ['Esterni che attaccano le fasce', 'Ampiezza offensiva', 'Terzini offensivi'],
            tattiche: ['Esterni larghi sulle fasce', 'Terzini che sovraccaricare', 'Attacco sugli spazi laterali'],
            ruoliChiave: [
              {
                ruolo: 'ESTERNI OFFENSIVI (Coppia)',
                caratteristiche: ['Posizionamento largo sulle fasce', 'Velocita per attaccare i terzini', 'Capacita di tagliare dentro al campo', 'Dribbling efficace', 'Cross e finalizzazione'],
                importanza: 'FONDAMENTALE - Devono attaccare costantemente le fasce scoperte'
              },
              {
                ruolo: 'TERZINI',
                caratteristiche: ['Sovrapposizioni sincronizzate', 'Capacita di creare 2vs1', 'Resistenza per spinta continua', 'Cross dal fondo', 'Ampiezza offensiva'],
                importanza: 'ESSENZIALE - Devono sovraccaricare le fasce con gli esterni'
              },
              {
                ruolo: 'TREQUARTISTA CENTRALE',
                caratteristiche: ['Creativita negli spazi centrali', 'Capacita di servire gli esterni', 'Visione di gioco per cambi di lato', 'Dribbling tra le linee', 'Inserimenti coordinati'],
                importanza: 'IMPORTANTE - Deve orchestrare gli attacchi sulle fasce'
              }
            ]
          },
          {
            modulo: '3-4-3',
            efficacia: 85,
            motivo: 'Ali e esterni per dominare le fasce',
            vantaggi: ['Sei giocatori sulle fasce', 'Ampiezza totale', 'Sovraccarichi laterali'],
            tattiche: ['Attacco costante sulle fasce', 'Ali e quinti insieme', 'Cross e sovrapposizioni'],
            ruoliChiave: [
              {
                ruolo: 'ALI (Attaccanti Esterni)',
                caratteristiche: ['Posizionamento largo massimo', 'Velocita per puntare i terzini', 'Dribbling superiore 1vs1', 'Finalizzazione da posizione laterale', 'Movimenti dentro-fuori'],
                importanza: 'FONDAMENTALE - Devono dominare le fasce esterne'
              },
              {
                ruolo: 'ESTERNI (Centrocampisti di fascia)',
                caratteristiche: ['Sovrapposizioni coordinate con le ali', 'Resistenza per doppia fase', 'Cross dal fondo', 'Capacita di creare 2vs1 o 3vs2', 'Spinta offensiva costante'],
                importanza: 'ESSENZIALE - Devono creare superiorit√† numerica sulle fasce'
              },
              {
                ruolo: 'CENTRAVANTI',
                caratteristiche: ['Punto di riferimento in area', 'Capacita di finalizzare cross', 'Gioco aereo dominante', 'Movimenti per liberare spazio', 'Fisicita nei duelli'],
                importanza: 'CRITICO - Deve capitalizzare i cross dalle fasce'
              }
            ]
          }
        ]
      }
    };

    return analisi[modulo] || null;
  };

  // Render condizionale autenticazione
  if (authLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-600 to-blue-900 flex items-center justify-center">
        <div className="text-center">
          <div className="text-7xl mb-4 animate-bounce">‚öΩ</div>
          <p className="text-white text-xl">Caricamento...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return <LoginScreen />;
  }

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center">
        <div className="text-center animate-scale-up">
          <div className="text-6xl mb-6 animate-bounce">‚öΩ</div>
          <div className="spinner mx-auto mb-4"></div>
          <div className="text-2xl font-bold text-gray-800 mb-2 animate-pulse">Caricamento dati...</div>
          <div className="text-gray-600 text-sm">Attendere prego</div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
      {/* ========== MODAL SELEZIONE DISPOSITIVO ========== */}
      {showDeviceModal && userRole === 'admin' && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full animate-scale-up">
            {/* Header */}
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-lg">
              <div className="flex items-center gap-3">
                <div className="text-4xl">üîÑ</div>
                <div>
                  <h3 className="text-2xl font-bold">Configurazione Sincronizzazione</h3>
                  <p className="text-blue-100 text-sm mt-1">
                    Scegli come gestire i dati su questo dispositivo
                  </p>
                </div>
              </div>
            </div>
            
            {/* Body */}
            <div className="p-6">
              <p className="text-gray-700 mb-6 text-lg">
                Questo √® il tuo <strong>dispositivo principale</strong> per gestire la squadra?
              </p>
              
              {/* Opzione Principale */}
              <button
                onClick={() => {
                  saveDeviceConfig('primary');
                  setShowDeviceModal(false);
                }}
                className="w-full mb-4 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-6 rounded-lg border-2 border-green-400 transition-all hover:scale-102 shadow-lg"
              >
                <div className="flex items-center gap-4">
                  <div className="text-5xl">‚úÖ</div>
                  <div className="text-left flex-1">
                    <div className="text-xl font-bold mb-1">S√å - Dispositivo Principale</div>
                    <div className="text-sm text-green-100">
                      ‚Ä¢ Sincronizzazione automatica ogni 2 minuti<br/>
                      ‚Ä¢ Salva sempre le tue modifiche sul cloud<br/>
                      ‚Ä¢ Usa questo dispositivo per gestire la squadra
                    </div>
                  </div>
                </div>
              </button>
              
              {/* Opzione Secondario */}
              <button
                onClick={() => {
                  saveDeviceConfig('secondary');
                  setShowDeviceModal(false);
                }}
                className="w-full mb-4 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-800 p-6 rounded-lg border-2 border-gray-300 transition-all hover:scale-102"
              >
                <div className="flex items-center gap-4">
                  <div className="text-5xl">üì±</div>
                  <div className="text-left flex-1">
                    <div className="text-xl font-bold mb-1">NO - Dispositivo Secondario</div>
                    <div className="text-sm text-gray-600">
                      ‚Ä¢ Solo sincronizzazione manuale (quando vuoi tu)<br/>
                      ‚Ä¢ Per consultare o fare modifiche occasionali<br/>
                      ‚Ä¢ Ideale per tablet/smartphone di riserva
                    </div>
                  </div>
                </div>
              </button>
              
              {/* Info */}
              <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mt-4">
                <div className="flex gap-3">
                  <div className="text-blue-600 text-xl">‚ÑπÔ∏è</div>
                  <div className="text-sm text-blue-800">
                    <strong>Nota:</strong> Puoi sempre cambiare questa impostazione dalla sezione 
                    "Sincronizzazione Cloud". La scelta viene riconfermata ogni giorno per sicurezza.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-lg shadow-xl p-3 md:p-6 mb-6 animate-fade-in card-modern mobile-header">
          <div className="flex flex-wrap items-start gap-2 md:gap-4 mb-2">
            <div className="flex items-center gap-2 md:gap-4 flex-1 min-w-0">
              <div className="relative flex-shrink-0">
                {teamLogo ? (
                  <div className="relative group">
                    <img 
                      src={teamLogo} 
                      alt="Logo squadra" 
                      className="w-16 h-16 md:w-32 md:h-32 object-contain rounded-lg"
                    />
                    <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-lg transition-all flex items-center justify-center gap-1">
                      <label className="opacity-0 group-hover:opacity-100 cursor-pointer bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition-all">
                        <input
                          type="file"
                          accept="image/*"
                          onChange={handleLogoUpload}
                          className="hidden"
                        />
                        ‚úèÔ∏è
                      </label>
                      <button
                        onClick={removeLogo}
                        className="opacity-0 group-hover:opacity-100 bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-all"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                ) : (
                  <label className="w-16 h-16 md:w-32 md:h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all group">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleLogoUpload}
                      className="hidden"
                    />
                    <div className="text-center">
                      <div className="text-2xl md:text-4xl group-hover:scale-110 transition-transform">üñºÔ∏è</div>
                      <div className="text-xs text-gray-500 mt-1 hidden md:block">Logo</div>
                    </div>
                  </label>
                )}
              </div>

              <div className="flex-1 min-w-0">
                {isEditingTitle ? (
                  <input
                    type="text"
                    value={appTitle}
                    onChange={(e) => setAppTitle(e.target.value)}
                    onBlur={() => setIsEditingTitle(false)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') setIsEditingTitle(false);
                    }}
                    className="text-xl md:text-3xl font-bold text-gray-800 border-2 border-blue-500 rounded px-2 py-1 w-full"
                    autoFocus
                  />
                ) : (
                  <h1 className="text-xl md:text-3xl font-bold text-gray-800 break-words">{appTitle}</h1>
                )}
              </div>
            </div>

            {/* Badge Stato Sync - Riga Separata su Mobile */}
            {userRole === 'admin' && deviceRole && (
              <div className="w-full md:w-auto mt-2 md:mt-0">
                {deviceRole === 'primary' ? (
                  <div className="bg-green-100 border-2 border-green-400 text-green-800 px-3 py-1 rounded-full text-xs md:text-sm font-semibold flex items-center gap-2 justify-center md:justify-start">
                    <span className="text-base md:text-lg">üîÑ</span>
                    <span className="hidden sm:inline">Auto-Sync Attivo</span>
                    <span className="sm:hidden">Auto</span>
                  </div>
                ) : (
                  <div className="bg-gray-100 border-2 border-gray-400 text-gray-800 px-3 py-1 rounded-full text-xs md:text-sm font-semibold flex items-center gap-2 justify-center md:justify-start">
                    <span className="text-base md:text-lg">üì±</span>
                    <span className="hidden sm:inline">Modalit√† Secondaria</span>
                    <span className="sm:hidden">Secondario</span>
                  </div>
                )}
              </div>
            )}

            <div className="flex flex-wrap items-center gap-2 md:gap-3 w-full md:w-auto">
              <div className="flex flex-col gap-1 md:gap-2">
                <button
                  onClick={() => setIsEditingTitle(true)}
                  className="px-2 md:px-4 py-1.5 md:py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-xs md:text-sm flex items-center gap-1 whitespace-nowrap"
                  title="Modifica titolo"
                >
                  ‚úèÔ∏è <span className="hidden sm:inline">Modifica Titolo</span>
                </button>
                <button
                  onClick={() => setShowInstructionsModal(true)}
                  className="px-2 md:px-4 py-1.5 md:py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold whitespace-nowrap text-xs md:text-sm"
                >
                  üìñ <span className="hidden sm:inline">Istruzioni</span>
                </button>
              </div>

              {/* Badge Ruolo, Logout e Chiudi App */}
              <div className="flex flex-col gap-1 md:gap-2">
                <div className={`px-2 md:px-4 py-1.5 md:py-2 rounded-lg font-bold text-xs md:text-sm text-center ${
                  userRole === 'admin' 
                    ? 'bg-yellow-400 text-yellow-900' 
                    : 'bg-blue-200 text-blue-900'
                }`}>
                  {userRole === 'admin' ? 'üëë ADMIN' : 'üëÅÔ∏è VISUALIZZATORE'}
                </div>
                
                {/* USER: Solo Logout */}
                {userRole === 'user' && (
                  <button
                    onClick={async () => {
                      try {
                        await auth.signOut();
                      } catch (error) {
                        console.error('Errore logout:', error);
                        showToast('‚ùå Errore logout', 'error');
                      }
                    }}
                    className="flex items-center justify-center gap-1 md:gap-2 px-2 md:px-4 py-1.5 md:py-2 bg-orange-500 hover:bg-orange-600 rounded-lg transition-colors font-semibold text-white whitespace-nowrap text-xs md:text-sm"
                    title="Cambia utente"
                  >
                    <LogOut className="w-4 h-4 md:w-5 md:h-5" />
                    <span>Logout</span>
                  </button>
                )}
                
                {/* ADMIN: Logout + Chiudi */}
                {userRole === 'admin' && (
                  <div className="flex gap-1 md:gap-2">
                    <button
                      onClick={async () => {
                        try {
                          await auth.signOut();
                        } catch (error) {
                          console.error('Errore logout:', error);
                          showToast('‚ùå Errore logout', 'error');
                        }
                      }}
                      className="flex-1 flex items-center justify-center gap-1 px-2 md:px-3 py-1.5 md:py-2 bg-orange-500 hover:bg-orange-600 rounded-lg transition-colors font-semibold text-white whitespace-nowrap text-xs md:text-sm"
                      title="Cambia utente"
                    >
                      <LogOut className="w-4 h-4" />
                      <span className="hidden sm:inline">Logout</span>
                    </button>
                    <button
                      onClick={handleLogout}
                      className="flex-1 flex items-center justify-center gap-1 px-2 md:px-3 py-1.5 md:py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors font-semibold text-white whitespace-nowrap text-xs md:text-sm"
                      title="Chiudi applicazione"
                    >
                      <span className="text-base">‚úï</span>
                      <span className="hidden sm:inline">Chiudi</span>
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
          <div className="hidden md:flex justify-between items-center">
            <div className="flex items-center gap-3">
              <p className="text-gray-600">Sistema di tracciamento allenamenti, partite e statistiche</p>
              <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold badge-animated">
                üíæ Salvataggio Automatico Attivo
              </span>
              {lastSaved && (
                <span className="text-xs text-gray-500">
                  Ultimo salvataggio: {lastSaved.toLocaleTimeString('it-IT')}
                </span>
              )}
            </div>
          </div>
        </div>

        {/* Banner Dispositivo Secondario (Compatto) */}
        {userRole === 'admin' && deviceRole === 'secondary' && (
          <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mb-4 animate-fade-in">
            <div className="flex items-center gap-2">
              <span className="text-yellow-600 text-xl">‚ö†Ô∏è</span>
              <p className="text-sm text-yellow-800 flex-1">
                <strong>Dispositivo Secondario:</strong> Ricordati di sincronizzare manualmente
              </p>
              <button
                onClick={() => setActiveTab('sync')}
                className="text-xs bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1.5 rounded font-semibold transition-colors whitespace-nowrap"
              >
                Sync ‚Üí
              </button>
            </div>
          </div>
        )}

        {/* Banner Sola Lettura (Compatto) */}
        {userRole === 'user' && (
          <div className="bg-blue-50 border border-blue-300 rounded-lg p-3 mb-4 animate-fade-in">
            <div className="flex items-center gap-2">
              <span className="text-blue-600 text-xl">üëÅÔ∏è</span>
              <p className="text-sm text-blue-800 flex-1">
                <strong>Modalit√† Sola Lettura:</strong> Puoi vedere i dati ma non modificare
              </p>
            </div>
          </div>
        )}

        <div className="bg-white rounded-lg shadow-xl p-3 md:p-6 mb-6 animate-fade-in card-modern">
          <div className="flex gap-2 mb-4 md:mb-6 border-b overflow-x-auto tab-container">
            {[
              'dashboard', 'classifica', 'top', 'stats', 
              'trainings',
              ...(userRole === 'admin' ? ['divisione'] : []),
              ...(userRole === 'admin' ? ['matches', 'convocazioni', 'tattica'] : []),
              'calendar', 'injuries', 'roster',
              ...(userRole === 'admin' ? ['export', 'sync', 'admin'] : [])
            ].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-3 sm:px-6 py-3 font-semibold whitespace-nowrap ripple rounded-t-lg text-sm sm:text-base flex-shrink-0 ${
                  activeTab === tab
                    ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                    : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'
                }`}
              >
                {tab === 'trainings' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">{`Allenamenti (${trainings.length})`}</span>
                    <span className="tab-icon-only sm:hidden">üèÉ {trainings.length}</span>
                  </>
                )}
                {tab === 'matches' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">{`Partite (${matches.length})`}</span>
                    <span className="tab-icon-only sm:hidden">‚öΩ {matches.length}</span>
                  </>
                )}
                {tab === 'stats' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">Statistiche</span>
                    <span className="tab-icon-only sm:hidden">üìä</span>
                  </>
                )}
                {tab === 'top' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">üèÜ Giocatori TOP</span>
                    <span className="tab-icon-only sm:hidden">üèÜ</span>
                  </>
                )}
                {tab === 'tattica' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">üéØ Analisi Tattica</span>
                    <span className="tab-icon-only sm:hidden">üéØ</span>
                  </>
                )}
                {tab === 'divisione' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">‚öñÔ∏è Divisione Squadre</span>
                    <span className="tab-icon-only sm:hidden">‚öñÔ∏è</span>
                  </>
                )}
                {tab === 'convocazioni' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">üìã Convocazioni</span>
                    <span className="tab-icon-only sm:hidden">üìã</span>
                  </>
                )}
                {tab === 'roster' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">Gestione Rosa</span>
                    <span className="tab-icon-only sm:hidden">üë•</span>
                  </>
                )}
                {tab === 'dashboard' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">üìä Dashboard</span>
                    <span className="tab-icon-only sm:hidden">üìä</span>
                  </>
                )}
                {tab === 'classifica' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ü•á Classifica</span>
                    <span className="tab-icon-only sm:hidden">ü•á</span>
                  </>
                )}
                {tab === 'injuries' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">ü§ï Infortuni</span>
                    <span className="tab-icon-only sm:hidden">ü§ï</span>
                  </>
                )}
                {tab === 'calendar' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">üìÖ Calendario</span>
                    <span className="tab-icon-only sm:hidden">üìÖ</span>
                  </>
                )}
                {tab === 'export' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">üíæ Esportazioni</span>
                    <span className="tab-icon-only sm:hidden">üíæ</span>
                  </>
                )}
                {tab === 'sync' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">‚òÅÔ∏è Sincronizzazione</span>
                    <span className="tab-icon-only sm:hidden">‚òÅÔ∏è</span>
                  </>
                )}
                {tab === 'admin' && (
                  <>
                    <span className="tab-text-portrait hidden sm:inline">üëë Gestione Utenti</span>
                    <span className="tab-icon-only sm:hidden">üëë</span>
                  </>
                )}
              </button>
            ))}
          </div>

          {/* ============================================ */}
          {/* TAB DASHBOARD - NUOVO */}
          {/* ============================================ */}
          {activeTab === 'dashboard' && (
            <div className="animate-fade-in">
              <div className="mb-6">
                <h2 className="text-3xl font-bold text-gray-800 mb-2">üìä Dashboard Stagionale</h2>
                <p className="text-gray-600">Panoramica completa delle statistiche e andamento della stagione</p>
              </div>

              {/* Quick Stats Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-6 border-2 border-blue-200 animate-scale-up">
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl">‚öΩ</div>
                    <div className="text-3xl font-bold text-blue-600">{matches.length}</div>
                  </div>
                  <div className="text-gray-700 font-semibold">Partite Giocate</div>
                  <div className="text-sm text-gray-600 mt-1">
                    {matches.filter(m => {
                      const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                      const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                      return golFatti > 0 || golSubiti > 0;
                    }).length} completate
                  </div>
                  <button
                    onClick={() => setShowResultsModal(true)}
                    className="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                  >
                    üìã Elenco Risultati
                  </button>
                </div>

                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200 animate-scale-up" style={{animationDelay: '0.1s'}}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl">üèÉ</div>
                    <div className="text-3xl font-bold text-green-600">{trainings.length}</div>
                  </div>
                  <div className="text-gray-700 font-semibold">Allenamenti</div>
                  <div className="text-sm text-gray-600 mt-1">
                    Media presenze: {trainings.length > 0 ? Math.round((trainings.reduce((acc, t) => {
                      const presentiCount = Object.entries(t.presenze)
                        .filter(([numero, presente]) => {
                          if (!presente) return false;
                          const player = players.find(p => p.numero === parseInt(numero));
                          if (!player || !player.nome) return false;
                          if (player.fuoriRosa) return false;
                          if (player.dataCreazione && new Date(player.dataCreazione) > new Date(t.data)) return false;
                          return true;
                        })
                        .length;
                      return acc + presentiCount;
                    }, 0) / trainings.length)) : 0}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow-lg p-6 border-2 border-yellow-200 animate-scale-up" style={{animationDelay: '0.2s'}}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl relative">
                      <span>ü•Ö</span>
                      <span className="absolute" style={{fontSize: '0.6em', left: '50%', top: '50%', transform: 'translate(-50%, -50%)'}}>‚öΩ</span>
                    </div>
                    <div className="text-3xl font-bold text-yellow-600">
                      {matches.reduce((sum, m) => {
                        if (!m.golFatti) return sum;
                        return sum + Object.values(m.golFatti).reduce((s, g) => s + (parseInt(g) || 0), 0);
                      }, 0)}
                    </div>
                  </div>
                  <div className="text-gray-700 font-semibold">Gol Fatti</div>
                  <div className="text-sm text-gray-600 mt-1">
                    Media: {matches.length > 0 ? (matches.reduce((sum, m) => sum + Object.values(m.golFatti || {}).reduce((s, g) => s + (parseInt(g) || 0), 0), 0) / matches.length).toFixed(1) : 0} per partita
                  </div>
                </div>

                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-lg p-6 border-2 border-purple-200 animate-scale-up" style={{animationDelay: '0.3s'}}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-4xl relative">
                      <span>ü•Ö</span>
                      <span className="absolute" style={{fontSize: '0.7em', left: '50%', top: '50%', transform: 'translate(-50%, -50%)', color: '#ef4444'}}>‚ùå</span>
                    </div>
                    <div className="text-3xl font-bold text-purple-600">
                      {matches.reduce((sum, m) => {
                        if (!m.golSubiti) return sum;
                        return sum + Object.values(m.golSubiti).reduce((s, g) => s + (parseInt(g) || 0), 0);
                      }, 0)}
                    </div>
                  </div>
                  <div className="text-gray-700 font-semibold">Gol Subiti</div>
                  <div className="text-sm text-gray-600 mt-1">
                    Media: {matches.length > 0 ? (matches.reduce((sum, m) => sum + Object.values(m.golSubiti || {}).reduce((s, g) => s + (parseInt(g) || 0), 0), 0) / matches.length).toFixed(1) : 0} per partita
                  </div>
                </div>
              </div>

              {/* Grafici */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* Grafico Gol Fatti/Subiti */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">üìà Andamento Gol</h3>
                  <canvas id="goalsChart" className="w-full" style={{maxHeight: '300px'}}></canvas>
                </div>

                {/* Grafico Risultati */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">üèÜ Risultati Partite</h3>
                  <canvas id="resultsChart" className="w-full" style={{maxHeight: '300px'}}></canvas>
                </div>

                {/* Grafico Presenze Allenamenti */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">üìä Presenze Allenamenti</h3>
                  <canvas id="attendanceChart" className="w-full" style={{maxHeight: '300px'}}></canvas>
                </div>

                {/* Top Marcatori Quick View */}
                <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
                  <h3 className="text-xl font-bold text-gray-800 mb-4">‚öΩ Top 5 Marcatori</h3>
                  <div className="space-y-3">
                    {players
                      .map(p => ({
                        ...p,
                        gol: matches.reduce((sum, m) => sum + (parseInt(m.golFatti?.[p.numero]) || 0), 0)
                      }))
                      .filter(p => p.gol > 0)
                      .sort((a, b) => b.gol - a.gol)
                      .slice(0, 5)
                      .map((p, idx) => (
                        <div key={p.numero} className="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                          <div className="flex items-center gap-3">
                            <div className={`text-2xl font-bold ${idx === 0 ? 'text-yellow-500' : idx === 1 ? 'text-gray-400' : idx === 2 ? 'text-orange-600' : 'text-gray-600'}`}>
                              {idx + 1}¬∞
                            </div>
                            {p.foto && (
                              <img src={p.foto} alt={p.nome} className="w-10 h-10 rounded-full object-cover" />
                            )}
                            <div>
                              <div className="font-semibold text-gray-800">{p.nome}</div>
                              <div className="text-sm text-gray-600">#{p.numero}</div>
                            </div>
                          </div>
                          <div className="text-2xl font-bold text-blue-600">{p.gol}</div>
                        </div>
                      ))}
                  </div>
                </div>
              </div>

              {/* Report Mensile Automatico */}
              <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">
                <h3 className="text-xl font-bold text-gray-800 mb-4">üìã Report Mensile Automatico</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-sm text-gray-600 mb-2">Partite del Mese</div>
                    <div className="text-3xl font-bold text-gray-800">
                      {matches.filter(m => {
                        const matchDate = new Date(m.data);
                        const now = new Date();
                        return matchDate.getMonth() === now.getMonth() && matchDate.getFullYear() === now.getFullYear();
                      }).length}
                    </div>
                  </div>
                  <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-sm text-gray-600 mb-2">Allenamenti del Mese</div>
                    <div className="text-3xl font-bold text-gray-800">
                      {trainings.filter(t => {
                        const trainDate = new Date(t.data);
                        const now = new Date();
                        return trainDate.getMonth() === now.getMonth() && trainDate.getFullYear() === now.getFullYear();
                      }).length}
                    </div>
                  </div>
                  <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-sm text-gray-600 mb-2">Gol del Mese</div>
                    <div className="text-3xl font-bold text-gray-800">
                      {matches
                        .filter(m => {
                          const matchDate = new Date(m.data);
                          const now = new Date();
                          return matchDate.getMonth() === now.getMonth() && matchDate.getFullYear() === now.getFullYear();
                        })
                        .reduce((sum, m) => sum + Object.values(m.golFatti || {}).reduce((s, g) => s + (parseInt(g) || 0), 0), 0)}
                    </div>
                  </div>
                </div>
              </div>

              {/* Classifica MVP (Man of the Match) */}
              <div className="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg shadow-lg p-6 border-2 border-yellow-200 mt-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                      üèÜ Man of the Match - Classifica Stagionale
                    </h3>
                    <p className="text-sm text-gray-600 mt-1">
                      I giocatori che hanno vinto pi√π volte il premio MVP
                    </p>
                  </div>
                  <div className="text-3xl">‚≠ê</div>
                </div>
                
                {(() => {
                  const leaderboard = getMVPLeaderboard();
                  
                  if (leaderboard.length === 0) {
                    return (
                      <div className="text-center py-8 text-gray-500">
                        <div className="text-4xl mb-2">üèÜ</div>
                        <p>Nessun MVP assegnato ancora</p>
                        <p className="text-sm mt-2">Vota il migliore in campo dopo ogni partita!</p>
                      </div>
                    );
                  }
                  
                  return (
                    <div className="space-y-3">
                      {leaderboard.map((entry, idx) => (
                        <div 
                          key={entry.playerNum}
                          className={`flex items-center justify-between rounded-lg p-4 transition-all hover:scale-102 ${
                            idx === 0 
                              ? 'bg-gradient-to-r from-yellow-100 to-amber-100 border-2 border-yellow-400 shadow-md'
                              : idx === 1
                              ? 'bg-gradient-to-r from-gray-100 to-slate-100 border-2 border-gray-300'
                              : idx === 2
                              ? 'bg-gradient-to-r from-orange-100 to-amber-100 border-2 border-orange-300'
                              : 'bg-white border-2 border-gray-200'
                          }`}
                        >
                          <div className="flex items-center gap-4">
                            <div className={`text-3xl font-bold ${
                              idx === 0 ? 'text-yellow-600' : 
                              idx === 1 ? 'text-gray-500' : 
                              idx === 2 ? 'text-orange-600' : 
                              'text-gray-600'
                            }`}>
                              {idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}¬∞`}
                            </div>
                            
                            {entry.playerPhoto ? (
                              <img 
                                src={entry.playerPhoto} 
                                alt={entry.playerName}
                                className="w-16 h-16 rounded-full object-cover border-2 border-white shadow-md"
                              />
                            ) : (
                              <div className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center border-2 border-white shadow-md">
                                <span className="text-2xl font-bold text-gray-500">
                                  {entry.playerNum}
                                </span>
                              </div>
                            )}
                            
                            <div>
                              <div className="font-bold text-gray-800 text-lg">
                                {entry.playerName}
                              </div>
                              <div className="text-sm text-gray-600">
                                #{entry.playerNum}
                              </div>
                            </div>
                          </div>
                          
                          <div className="flex items-center gap-3">
                            <div className="text-right">
                              <div className="text-3xl font-bold text-yellow-600">
                                {entry.mvpCount}
                              </div>
                              <div className="text-sm text-gray-600">
                                {entry.mvpCount === 1 ? 'MVP' : 'MVP'}
                              </div>
                            </div>
                            <div className="text-3xl">
                              {idx === 0 ? 'üåü' : '‚≠ê'}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  );
                })()}
              </div>
            </div>
          )}

          {/* ========== SEZIONE CLASSIFICA CAMPIONATO ========== */}
          {activeTab === 'classifica' && (
            <div className="animate-fade-in">
              <div className="mb-6">
                <h2 className="text-3xl font-bold text-gray-800 mb-2">ü•á Classifica Campionato</h2>
                <p className="text-gray-600">Gestisci squadre, risultati e visualizza la classifica del girone</p>
              </div>

              {/* Quick Stats */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow p-4 border-2 border-blue-200">
                  <div className="text-3xl font-bold text-blue-600">{squadreGirone.length}</div>
                  <div className="text-sm text-gray-700 font-semibold">Squadre</div>
                </div>
                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow p-4 border-2 border-green-200">
                  <div className="text-3xl font-bold text-green-600">
                    {risultatiCampionato.reduce((sum, g) => sum + g.partite.filter(p => p.giocata).length, 0)}
                  </div>
                  <div className="text-sm text-gray-700 font-semibold">Partite Giocate</div>
                </div>
                <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow p-4 border-2 border-yellow-200">
                  <div className="text-3xl font-bold text-yellow-600">
                    {risultatiCampionato.reduce((sum, g) => sum + g.partite.reduce((s, p) => 
                      s + (p.giocata ? (parseInt(p.golCasa) || 0) + (parseInt(p.golTrasferta) || 0) : 0), 0), 0)}
                  </div>
                  <div className="text-sm text-gray-700 font-semibold">Gol Totali</div>
                </div>
                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow p-4 border-2 border-purple-200">
                  <div className="text-3xl font-bold text-purple-600">{risultatiCampionato.length}</div>
                  <div className="text-sm text-gray-700 font-semibold">Giornate</div>
                </div>
              </div>

              {/* Sub-tabs */}
              <div className="flex gap-2 mb-6 border-b">
                <button
                  onClick={() => setClassificaTab('classifica')}
                  className={`px-6 py-3 font-semibold ${
                    classificaTab === 'classifica'
                      ? 'text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:text-blue-600'
                  }`}
                >
                  üìä Classifica
                </button>
                <button
                  onClick={() => setClassificaTab('statistiche')}
                  className={`px-6 py-3 font-semibold ${
                    classificaTab === 'statistiche'
                      ? 'text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:text-blue-600'
                  }`}
                >
                  üìà Statistiche
                </button>
                <button
                  onClick={() => setClassificaTab('risultati')}
                  className={`px-6 py-3 font-semibold ${
                    classificaTab === 'risultati'
                      ? 'text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:text-blue-600'
                  }`}
                >
                  ‚öΩ Risultati
                </button>
                <button
                  onClick={() => setClassificaTab('squadre')}
                  className={`px-6 py-3 font-semibold ${
                    classificaTab === 'squadre'
                      ? 'text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:text-blue-600'
                  }`}
                >
                  üë• Squadre
                </button>
              </div>

              {/* FINE PARTE 1 - Continua nella prossima sostituzione */}

              {/* TAB CLASSIFICA */}
              {classificaTab === 'classifica' && (
                <div className="bg-white rounded-lg shadow-lg p-6">
                  {/* Bottone Export PDF */}
                  {squadreGirone.length > 0 && (
                    <div className="mb-4 flex justify-end">
                      <button
                        onClick={() => {
                          // Funzione export PDF - implementata dopo
                          exportClassificaPDF();
                        }}
                        className="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 flex items-center gap-2"
                      >
                        üìÑ Esporta PDF
                      </button>
                    </div>
                  )}
                  
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="border-b-2">
                          <th className="p-3 text-left">Pos</th>
                          <th className="p-3 text-left">Squadra</th>
                          <th className="p-3 text-center">Pt</th>
                          <th className="p-3 text-center hidden md:table-cell classifica-col-giocate">G</th>
                          <th className="p-3 text-center classifica-col-risultati">V</th>
                          <th className="p-3 text-center classifica-col-risultati">P</th>
                          <th className="p-3 text-center classifica-col-risultati">S</th>
                          <th className="p-3 text-center classifica-col-gol">GF</th>
                          <th className="p-3 text-center classifica-col-gol">GS</th>
                          <th className="p-3 text-center classifica-col-gol">DR</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(() => {
                          // Calcolo classifica
                          const classifica = squadreGirone.map(sq => {
                            let punti = 0, giocate = 0, vinte = 0, pareggiate = 0, perse = 0, golFatti = 0, golSubiti = 0;
                            
                            risultatiCampionato.forEach(giornata => {
                              giornata.partite.forEach(partita => {
                                if (!partita.giocata) return;  // Solo partite giocate
                                
                                const golCasa = parseInt(partita.golCasa) || 0;
                                const golTrasferta = parseInt(partita.golTrasferta) || 0;
                                
                                if (partita.squadraCasa === sq.nome) {
                                  giocate++;
                                  golFatti += golCasa;
                                  golSubiti += golTrasferta;
                                  if (golCasa > golTrasferta) {
                                    punti += 3;
                                    vinte++;
                                  } else if (golCasa === golTrasferta) {
                                    punti += 1;
                                    pareggiate++;
                                  } else {
                                    perse++;
                                  }
                                } else if (partita.squadraTrasferta === sq.nome) {
                                  giocate++;
                                  golFatti += golTrasferta;
                                  golSubiti += golCasa;
                                  if (golTrasferta > golCasa) {
                                    punti += 3;
                                    vinte++;
                                  } else if (golTrasferta === golCasa) {
                                    punti += 1;
                                    pareggiate++;
                                  } else {
                                    perse++;
                                  }
                                }
                              });
                            });
                            
                            return { ...sq, punti, giocate, vinte, pareggiate, perse, golFatti, golSubiti, diffReti: golFatti - golSubiti };
                          }).sort((a, b) => {
                            if (b.punti !== a.punti) return b.punti - a.punti;
                            if (b.diffReti !== a.diffReti) return b.diffReti - a.diffReti;
                            return b.golFatti - a.golFatti;
                          });
                          
                          if (classifica.length === 0) {
                            return (
                              <tr>
                                <td colSpan="10" className="p-8 text-center text-gray-500">
                                  <div className="text-4xl mb-2">üèÜ</div>
                                  <p>Nessuna squadra inserita</p>
                                  <p className="text-sm mt-2">Vai su "üë• Squadre" per aggiungere le squadre del girone</p>
                                </td>
                              </tr>
                            );
                          }
                          
                          return classifica.map((sq, idx) => (
                            <tr key={sq.id} className={`border-b hover:bg-gray-50 ${idx === 0 ? 'bg-yellow-50' : idx <= 2 ? 'bg-blue-50' : idx >= classifica.length - 2 ? 'bg-red-50' : ''}`}>
                              <td className="p-3 font-bold">
                                {idx === 0 && 'ü•á'}
                                {idx === 1 && 'ü•à'}
                                {idx === 2 && 'ü•â'}
                                {idx >= 3 && (idx + 1)}
                              </td>
                              <td className="p-3 font-semibold">{sq.nome}</td>
                              <td className="p-3 text-center font-bold text-lg">{sq.punti}</td>
                              <td className="p-3 text-center hidden md:table-cell classifica-col-giocate">{sq.giocate}</td>
                              <td className="p-3 text-center classifica-col-risultati">{sq.vinte}</td>
                              <td className="p-3 text-center classifica-col-risultati">{sq.pareggiate}</td>
                              <td className="p-3 text-center classifica-col-risultati">{sq.perse}</td>
                              <td className="p-3 text-center classifica-col-gol">{sq.golFatti}</td>
                              <td className="p-3 text-center classifica-col-gol">{sq.golSubiti}</td>
                              <td className="p-3 text-center font-semibold classifica-col-gol">{sq.diffReti > 0 ? '+' : ''}{sq.diffReti}</td>
                            </tr>
                          ));
                        })()}
                      </tbody>
                    </table>
                  </div>
                  
                  {squadreGirone.length > 0 && (
                    <div className="mt-4 text-sm text-gray-600">
                      <p><strong>Legenda:</strong></p>
                      <p>Pt = Punti | G = Giocate | V = Vittorie | P = Pareggi | S = Sconfitte</p>
                      <p>GF = Gol Fatti | GS = Gol Subiti | DR = Differenza Reti</p>
                      <p className="mt-2">ü•á Primo | ü•àü•â Podio | üî¥ Zona retrocessione</p>
                    </div>
                  )}
                </div>
              )}

              {/* TAB STATISTICHE */}
              {classificaTab === 'statistiche' && (
                <div className="bg-white rounded-lg shadow-lg p-6">
                  {squadreGirone.length === 0 || !risultatiCampionato.some(g => g.partite.some(p => p.giocata)) ? (
                    <div className="text-center py-12">
                      <div className="text-6xl mb-4">üìä</div>
                      <h3 className="text-xl font-bold text-gray-800 mb-2">Nessuna statistica disponibile</h3>
                      <p className="text-gray-600">Inserisci squadre e risultati per vedere le statistiche</p>
                    </div>
                  ) : (
                    <>
                      {/* Sub-sub-tabs Statistiche */}
                      <div className="flex gap-2 mb-6 border-b">
                        <button
                          onClick={() => setStatsSubTab('overview')}
                          className={`px-4 py-2 font-semibold text-sm ${
                            statsSubTab === 'overview'
                              ? 'text-blue-600 border-b-2 border-blue-600'
                              : 'text-gray-600 hover:text-blue-600'
                          }`}
                        >
                          üìä Overview
                        </button>
                        <button
                          onClick={() => setStatsSubTab('dettagli')}
                          className={`px-4 py-2 font-semibold text-sm ${
                            statsSubTab === 'dettagli'
                              ? 'text-blue-600 border-b-2 border-blue-600'
                              : 'text-gray-600 hover:text-blue-600'
                          }`}
                        >
                          üìà Dettagli
                        </button>
                        <button
                          onClick={() => setStatsSubTab('record')}
                          className={`px-4 py-2 font-semibold text-sm ${
                            statsSubTab === 'record'
                              ? 'text-blue-600 border-b-2 border-blue-600'
                              : 'text-gray-600 hover:text-blue-600'
                          }`}
                        >
                          üèÜ Record
                        </button>
                      </div>

                      {/* OVERVIEW - 4 card esistenti */}
                      {statsSubTab === 'overview' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg p-4 border-2 border-yellow-200">
                        <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                          ‚öΩ Miglior Attacco
                        </h4>
                        {(() => {
                          // Calcola gol per squadra
                          const golPerSquadra = {};
                          risultatiCampionato.forEach(giornata => {
                            giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                                            if (!golPerSquadra[partita.squadraCasa]) golPerSquadra[partita.squadraCasa] = 0;
                              if (!golPerSquadra[partita.squadraTrasferta]) golPerSquadra[partita.squadraTrasferta] = 0;
                              golPerSquadra[partita.squadraCasa] += partita.golCasa;
                              golPerSquadra[partita.squadraTrasferta] += partita.golTrasferta;
                            });
                          });
                          
                          const topScorer = Object.entries(golPerSquadra)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3);
                          
                          return (
                            <div className="space-y-2">
                              {topScorer.map(([squadra, gol], idx) => (
                                <div key={squadra} className="flex justify-between items-center">
                                  <span className="font-semibold">
                                    {idx === 0 && 'ü•á '}
                                    {idx === 1 && 'ü•à '}
                                    {idx === 2 && 'ü•â '}
                                    {squadra}
                                  </span>
                                  <span className="text-2xl font-bold text-yellow-600">{gol} gol</span>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                      
                      <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-200">
                        <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                          üõ°Ô∏è Miglior Difesa
                        </h4>
                        {(() => {
                          // Calcola gol subiti per squadra
                          const golSubitiPerSquadra = {};
                          risultatiCampionato.forEach(giornata => {
                            giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                                            if (!golSubitiPerSquadra[partita.squadraCasa]) golSubitiPerSquadra[partita.squadraCasa] = 0;
                              if (!golSubitiPerSquadra[partita.squadraTrasferta]) golSubitiPerSquadra[partita.squadraTrasferta] = 0;
                              golSubitiPerSquadra[partita.squadraCasa] += partita.golTrasferta;
                              golSubitiPerSquadra[partita.squadraTrasferta] += partita.golCasa;
                            });
                          });
                          
                          const bestDefense = Object.entries(golSubitiPerSquadra)
                            .sort((a, b) => a[1] - b[1])
                            .slice(0, 3);
                          
                          return (
                            <div className="space-y-2">
                              {bestDefense.map(([squadra, gol], idx) => (
                                <div key={squadra} className="flex justify-between items-center">
                                  <span className="font-semibold">
                                    {idx === 0 && 'ü•á '}
                                    {idx === 1 && 'ü•à '}
                                    {idx === 2 && 'ü•â '}
                                    {squadra}
                                  </span>
                                  <span className="text-2xl font-bold text-green-600">{gol} subiti</span>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                      
                      <div className="bg-gradient-to-br from-blue-50 to-sky-50 rounded-lg p-4 border-2 border-blue-200">
                        <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                          üè† Rendimento Casa
                        </h4>
                        {(() => {
                          // Calcola punti in casa per squadra
                          const puntiCasa = {};
                          risultatiCampionato.forEach(giornata => {
                            giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                                            if (!puntiCasa[partita.squadraCasa]) puntiCasa[partita.squadraCasa] = 0;
                              if (partita.golCasa > partita.golTrasferta) puntiCasa[partita.squadraCasa] += 3;
                              else if (partita.golCasa === partita.golTrasferta) puntiCasa[partita.squadraCasa] += 1;
                            });
                          });
                          
                          const topCasa = Object.entries(puntiCasa)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3);
                          
                          return (
                            <div className="space-y-2">
                              {topCasa.map(([squadra, punti], idx) => (
                                <div key={squadra} className="flex justify-between items-center">
                                  <span className="font-semibold">
                                    {idx === 0 && 'ü•á '}
                                    {idx === 1 && 'ü•à '}
                                    {idx === 2 && 'ü•â '}
                                    {squadra}
                                  </span>
                                  <span className="text-2xl font-bold text-blue-600">{punti} pt</span>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                      
                      <div className="bg-gradient-to-br from-purple-50 to-violet-50 rounded-lg p-4 border-2 border-purple-200">
                        <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                          üöå Rendimento Trasferta
                        </h4>
                        {(() => {
                          // Calcola punti in trasferta per squadra
                          const puntiTrasferta = {};
                          risultatiCampionato.forEach(giornata => {
                            giornata.partite.forEach(partita => {
              if (!partita.giocata) return;
                                            if (!puntiTrasferta[partita.squadraTrasferta]) puntiTrasferta[partita.squadraTrasferta] = 0;
                              if (partita.golTrasferta > partita.golCasa) puntiTrasferta[partita.squadraTrasferta] += 3;
                              else if (partita.golTrasferta === partita.golCasa) puntiTrasferta[partita.squadraTrasferta] += 1;
                            });
                          });
                          
                          const topTrasferta = Object.entries(puntiTrasferta)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 3);
                          
                          return (
                            <div className="space-y-2">
                              {topTrasferta.map(([squadra, punti], idx) => (
                                <div key={squadra} className="flex justify-between items-center">
                                  <span className="font-semibold">
                                    {idx === 0 && 'ü•á '}
                                    {idx === 1 && 'ü•à '}
                                    {idx === 2 && 'ü•â '}
                                    {squadra}
                                  </span>
                                  <span className="text-2xl font-bold text-purple-600">{punti} pt</span>
                                </div>
                              ))}
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  )}

              {/* DETTAGLI - Form ultimi 5 + Clean sheet */}
              {statsSubTab === 'dettagli' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  {/* CARD 1: FORM ULTIMI 5 MATCH */}
                  <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border-2 border-blue-200">
                    <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                      üî• Form Ultimi 5 Match
                    </h4>
                    {(() => {
                      // Calcola classifica completa per prendere Real DOR
                      const classifica = squadreGirone.map(sq => {
                        let punti = 0, vinte = 0, pareggiate = 0, perse = 0;
                        const risultati = [];
                        
                        risultatiCampionato.forEach(giornata => {
                          giornata.partite.forEach(partita => {
                            if (!partita.giocata) return;
                            
                            const golCasa = parseInt(partita.golCasa) || 0;
                            const golTrasferta = parseInt(partita.golTrasferta) || 0;
                            
                            if (partita.squadraCasa === sq.nome) {
                              if (golCasa > golTrasferta) {
                                punti += 3;
                                vinte++;
                                risultati.push('V');
                              } else if (golCasa === golTrasferta) {
                                punti += 1;
                                pareggiate++;
                                risultati.push('P');
                              } else {
                                perse++;
                                risultati.push('S');
                              }
                            } else if (partita.squadraTrasferta === sq.nome) {
                              if (golTrasferta > golCasa) {
                                punti += 3;
                                vinte++;
                                risultati.push('V');
                              } else if (golTrasferta === golCasa) {
                                punti += 1;
                                pareggiate++;
                                risultati.push('P');
                              } else {
                                perse++;
                                risultati.push('S');
                              }
                            }
                          });
                        });
                        
                        return { ...sq, punti, vinte, pareggiate, perse, risultati };
                      }).sort((a, b) => b.punti - a.punti);
                      
                      // Prendi le prime 3 squadre
                      const top3 = classifica.slice(0, 3);
                      
                      return (
                        <div className="space-y-3">
                          {top3.map((squadra) => {
                            const ultimi5 = squadra.risultati.slice(-5);
                            const puntiUltimi5 = ultimi5.reduce((sum, r) => 
                              sum + (r === 'V' ? 3 : r === 'P' ? 1 : 0), 0
                            );
                            
                            // Calcola trend
                            let trend = '‚Üí';
                            let trendColor = 'text-gray-600';
                            if (puntiUltimi5 >= 12) {
                              trend = 'üìà';
                              trendColor = 'text-green-600';
                            } else if (puntiUltimi5 <= 6) {
                              trend = 'üìâ';
                              trendColor = 'text-red-600';
                            }
                            
                            // Calcola serie attuale
                            let serieAttuale = 0;
                            let tipoSerie = '';
                            if (ultimi5.length > 0) {
                              const ultimo = ultimi5[ultimi5.length - 1];
                              for (let i = ultimi5.length - 1; i >= 0; i--) {
                                if (ultimi5[i] === ultimo) {
                                  serieAttuale++;
                                } else break;
                              }
                              tipoSerie = ultimo === 'V' ? 'vittorie' : ultimo === 'P' ? 'pareggi' : 'sconfitte';
                            }
                            
                            return (
                              <div key={squadra.id} className="bg-white rounded p-3 border border-blue-200">
                                <div className="font-semibold text-gray-800 mb-2">{squadra.nome}</div>
                                <div className="flex items-center gap-2 mb-2">
                                  {ultimi5.map((r, idx) => (
                                    <span
                                      key={idx}
                                      className={`w-8 h-8 flex items-center justify-center rounded font-bold text-sm ${
                                        r === 'V' ? 'bg-green-500 text-white' :
                                        r === 'P' ? 'bg-yellow-500 text-white' :
                                        'bg-red-500 text-white'
                                      }`}
                                    >
                                      {r}
                                    </span>
                                  ))}
                                  <span className={`text-2xl ml-2 ${trendColor}`}>{trend}</span>
                                </div>
                                <div className="text-xs text-gray-600">
                                  <div>Ultimi 5: {ultimi5.filter(r => r === 'V').length}V {ultimi5.filter(r => r === 'P').length}P {ultimi5.filter(r => r === 'S').length}S ({puntiUltimi5} punti)</div>
                                  {serieAttuale > 1 && (
                                    <div className="font-semibold text-blue-600 mt-1">
                                      Serie attuale: {serieAttuale} {tipoSerie} {serieAttuale >= 3 ? 'üî•' : ''}
                                    </div>
                                  )}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      );
                    })()}
                  </div>
                  
                  {/* CARD 2: CLEAN SHEET & MEDIE */}
                  <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-200">
                    <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                      üõ°Ô∏è Clean Sheet & Medie
                    </h4>
                    {(() => {
                      // Calcola statistiche dettagliate per ogni squadra
                      const stats = squadreGirone.map(sq => {
                        let giocate = 0, golFatti = 0, golSubiti = 0, cleanSheet = 0;
                        
                        risultatiCampionato.forEach(giornata => {
                          giornata.partite.forEach(partita => {
                            if (!partita.giocata) return;
                            
                            const golCasa = parseInt(partita.golCasa) || 0;
                            const golTrasferta = parseInt(partita.golTrasferta) || 0;
                            
                            if (partita.squadraCasa === sq.nome) {
                              giocate++;
                              golFatti += golCasa;
                              golSubiti += golTrasferta;
                              if (golTrasferta === 0) cleanSheet++;
                            } else if (partita.squadraTrasferta === sq.nome) {
                              giocate++;
                              golFatti += golTrasferta;
                              golSubiti += golCasa;
                              if (golCasa === 0) cleanSheet++;
                            }
                          });
                        });
                        
                        return {
                          nome: sq.nome,
                          giocate,
                          golFatti,
                          golSubiti,
                          cleanSheet,
                          mediaGolFatti: giocate > 0 ? (golFatti / giocate).toFixed(1) : 0,
                          mediaGolSubiti: giocate > 0 ? (golSubiti / giocate).toFixed(1) : 0,
                          cleanSheetPerc: giocate > 0 ? ((cleanSheet / giocate) * 100).toFixed(0) : 0,
                          diffReti: golFatti - golSubiti
                        };
                      }).sort((a, b) => b.diffReti - a.diffReti);
                      
                      const top3 = stats.slice(0, 3);
                      
                      return (
                        <div className="space-y-3">
                          {top3.map((squadra, idx) => (
                            <div key={squadra.nome} className="bg-white rounded p-3 border border-green-200">
                              <div className="flex items-center justify-between mb-2">
                                <span className="font-semibold text-gray-800">
                                  {idx === 0 && 'ü•á '}
                                  {idx === 1 && 'ü•à '}
                                  {idx === 2 && 'ü•â '}
                                  {squadra.nome}
                                </span>
                              </div>
                              <div className="grid grid-cols-2 gap-2 text-xs">
                                <div className="bg-green-100 rounded p-2">
                                  <div className="text-gray-600">Porte inviolate</div>
                                  <div className="font-bold text-green-600">
                                    {squadra.cleanSheet}/{squadra.giocate} ({squadra.cleanSheetPerc}%)
                                  </div>
                                </div>
                                <div className="bg-blue-100 rounded p-2">
                                  <div className="text-gray-600">Media gol fatti</div>
                                  <div className="font-bold text-blue-600">{squadra.mediaGolFatti}/partita</div>
                                </div>
                                <div className="bg-yellow-100 rounded p-2">
                                  <div className="text-gray-600">Media gol subiti</div>
                                  <div className="font-bold text-yellow-600">{squadra.mediaGolSubiti}/partita</div>
                                </div>
                                <div className="bg-purple-100 rounded p-2">
                                  <div className="text-gray-600">Goal difference</div>
                                  <div className="font-bold text-purple-600">
                                    {squadra.diffReti > 0 ? '+' : ''}{squadra.diffReti}
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      );
                    })()}
                  </div>
                  
                </div>
              )}

              {/* RECORD - Record & Primati + Grafico */}
              {statsSubTab === 'record' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  {/* CARD 3: RECORD & PRIMATI */}
                  <div className="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg p-4 border-2 border-yellow-200">
                    <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                      üèÜ Record & Primati
                    </h4>
                    {(() => {
                      // Calcola record del campionato
                      let vittoriaPiuLarga = { squadra: '', margine: 0, risultato: '' };
                      let piuGolInPartita = { squadra: '', gol: 0, risultato: '' };
                      let capocannoniere = {};
                      
                      risultatiCampionato.forEach(giornata => {
                        giornata.partite.forEach(partita => {
                          if (!partita.giocata) return;
                          
                          const golCasa = parseInt(partita.golCasa) || 0;
                          const golTrasferta = parseInt(partita.golTrasferta) || 0;
                          
                          // Vittoria pi√π larga (SOLO VITTORIE, non sconfitte)
                          const margineCasa = golCasa - golTrasferta;
                          const margineTrasferta = golTrasferta - golCasa;
                          
                          if (margineCasa > 0 && margineCasa > vittoriaPiuLarga.margine) {
                            vittoriaPiuLarga = {
                              squadra: partita.squadraCasa,
                              margine: margineCasa,
                              risultato: `${golCasa}-${golTrasferta} vs ${partita.squadraTrasferta}`
                            };
                          }
                          if (margineTrasferta > 0 && margineTrasferta > vittoriaPiuLarga.margine) {
                            vittoriaPiuLarga = {
                              squadra: partita.squadraTrasferta,
                              margine: margineTrasferta,
                              risultato: `${golTrasferta}-${golCasa} vs ${partita.squadraCasa}`
                            };
                          }
                          
                          // Pi√π gol in partita (singola squadra)
                          if (golCasa > piuGolInPartita.gol) {
                            piuGolInPartita = {
                              squadra: partita.squadraCasa,
                              gol: golCasa,
                              risultato: `${golCasa}-${golTrasferta} vs ${partita.squadraTrasferta}`
                            };
                          }
                          if (golTrasferta > piuGolInPartita.gol) {
                            piuGolInPartita = {
                              squadra: partita.squadraTrasferta,
                              gol: golTrasferta,
                              risultato: `${golTrasferta}-${golCasa} vs ${partita.squadraCasa}`
                            };
                          }
                          
                          // Capocannoniere squadre
                          if (!capocannoniere[partita.squadraCasa]) capocannoniere[partita.squadraCasa] = 0;
                          if (!capocannoniere[partita.squadraTrasferta]) capocannoniere[partita.squadraTrasferta] = 0;
                          capocannoniere[partita.squadraCasa] += golCasa;
                          capocannoniere[partita.squadraTrasferta] += golTrasferta;
                        });
                      });
                      
                      // Serie migliore (pi√π vittorie consecutive)
                      // METODO CORRETTO: crea array cronologico per ogni squadra
                      let serieMigliore = { squadra: '', vittorie: 0 };
                      
                      squadreGirone.forEach(sq => {
                        // Raccogli TUTTE le partite della squadra in ordine cronologico
                        const partiteSquadra = [];
                        
                        risultatiCampionato.forEach(giornata => {
                          giornata.partite.forEach(partita => {
                            if (!partita.giocata) return;
                            
                            const golCasa = parseInt(partita.golCasa) || 0;
                            const golTrasferta = parseInt(partita.golTrasferta) || 0;
                            
                            if (partita.squadraCasa === sq.nome) {
                              partiteSquadra.push({
                                giornata: giornata.giornata,
                                vinto: golCasa > golTrasferta,
                                pareggio: golCasa === golTrasferta,
                                perso: golCasa < golTrasferta
                              });
                            } else if (partita.squadraTrasferta === sq.nome) {
                              partiteSquadra.push({
                                giornata: giornata.giornata,
                                vinto: golTrasferta > golCasa,
                                pareggio: golTrasferta === golCasa,
                                perso: golTrasferta < golCasa
                              });
                            }
                          });
                        });
                        
                        // Ora conta le vittorie consecutive sull'array ordinato
                        let serieCorrente = 0;
                        let serieMax = 0;
                        
                        partiteSquadra.forEach(partita => {
                          if (partita.vinto) {
                            serieCorrente++;
                            if (serieCorrente > serieMax) {
                              serieMax = serieCorrente;
                            }
                          } else {
                            serieCorrente = 0;
                          }
                        });
                        
                        if (serieMax > serieMigliore.vittorie) {
                          serieMigliore = { squadra: sq.nome, vittorie: serieMax };
                        }
                      });
                      
                      const topGoleador = Object.entries(capocannoniere)
                        .sort((a, b) => b[1] - a[1])[0];
                      
                      return (
                        <div className="space-y-3">
                          <div className="bg-white rounded p-3 border border-yellow-200">
                            <div className="text-xs text-gray-600 mb-1">üéØ Vittoria pi√π larga</div>
                            <div className="font-bold text-gray-800">{vittoriaPiuLarga.squadra}</div>
                            <div className="text-sm text-gray-600">{vittoriaPiuLarga.risultato}</div>
                          </div>
                          
                          <div className="bg-white rounded p-3 border border-yellow-200">
                            <div className="text-xs text-gray-600 mb-1">‚öΩ Pi√π gol in una partita</div>
                            <div className="font-bold text-gray-800">{piuGolInPartita.squadra} - {piuGolInPartita.gol} gol</div>
                            <div className="text-sm text-gray-600">{piuGolInPartita.risultato}</div>
                          </div>
                          
                          <div className="bg-white rounded p-3 border border-yellow-200">
                            <div className="text-xs text-gray-600 mb-1">üî• Miglior serie di vittorie</div>
                            <div className="font-bold text-gray-800">{serieMigliore.squadra}</div>
                            <div className="text-sm text-gray-600">{serieMigliore.vittorie} vittorie consecutive</div>
                          </div>
                          
                          {topGoleador && (
                            <div className="bg-white rounded p-3 border border-yellow-200">
                              <div className="text-xs text-gray-600 mb-1">üëü Squadra pi√π prolifica</div>
                              <div className="font-bold text-gray-800">{topGoleador[0]}</div>
                              <div className="text-sm text-gray-600">{topGoleador[1]} gol totali</div>
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                  
                  {/* CARD 4: GRAFICO ANDAMENTO PUNTI */}
                  <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-4 border-2 border-purple-200">
                    <h4 className="font-bold text-lg mb-3 flex items-center gap-2">
                      üìà Andamento Punti
                    </h4>
                    {(() => {
                      // Calcola andamento punti per le prime 3 squadre
                      const classifica = squadreGirone.map(sq => {
                        let puntiTotali = 0;
                        const andamento = [];
                        
                        risultatiCampionato.forEach(giornata => {
                          let puntiGiornata = 0;
                          
                          giornata.partite.forEach(partita => {
                            if (!partita.giocata) return;
                            
                            const golCasa = parseInt(partita.golCasa) || 0;
                            const golTrasferta = parseInt(partita.golTrasferta) || 0;
                            
                            if (partita.squadraCasa === sq.nome) {
                              if (golCasa > golTrasferta) puntiGiornata += 3;
                              else if (golCasa === golTrasferta) puntiGiornata += 1;
                            } else if (partita.squadraTrasferta === sq.nome) {
                              if (golTrasferta > golCasa) puntiGiornata += 3;
                              else if (golTrasferta === golCasa) puntiGiornata += 1;
                            }
                          });
                          
                          if (puntiGiornata > 0 || giornata.partite.some(p => 
                            p.giocata && (p.squadraCasa === sq.nome || p.squadraTrasferta === sq.nome)
                          )) {
                            puntiTotali += puntiGiornata;
                            andamento.push({ giornata: giornata.giornata, punti: puntiTotali });
                          }
                        });
                        
                        return { nome: sq.nome, andamento, puntiTotali };
                      }).sort((a, b) => b.puntiTotali - a.puntiTotali);
                      
                      const top3 = classifica.slice(0, 3);
                      const maxPunti = Math.max(...top3.flatMap(s => s.andamento.map(a => a.punti)));
                      const colors = ['#3b82f6', '#10b981', '#f59e0b'];
                      
                      // Calcola trend (ultimi 3 vs primi 3 giornate)
                      const getTrend = (andamento) => {
                        if (andamento.length < 6) return { text: '‚Üí', color: 'text-gray-600' };
                        const primi3 = andamento.slice(0, 3).reduce((sum, a, i, arr) => 
                          sum + (i > 0 ? a.punti - arr[i-1].punti : a.punti), 0
                        );
                        const ultimi3 = andamento.slice(-3).reduce((sum, a, i, arr) => 
                          sum + (i > 0 ? a.punti - arr[i-1].punti : 0), 0
                        );
                        
                        if (ultimi3 > primi3 + 2) return { text: 'üìà In crescita', color: 'text-green-600' };
                        if (ultimi3 < primi3 - 2) return { text: 'üìâ In calo', color: 'text-red-600' };
                        return { text: '‚Üí Stabile', color: 'text-gray-600' };
                      };
                      
                      return (
                        <div className="space-y-4">
                          {/* Grafico a linee ASCII-style */}
                          <div className="bg-white rounded p-3 border border-purple-200">
                            <div className="font-mono text-xs overflow-x-auto">
                              {top3.map((squadra, sIdx) => (
                                <div key={squadra.nome} className="mb-3">
                                  <div className="font-bold mb-1" style={{ color: colors[sIdx] }}>
                                    {squadra.nome}
                                  </div>
                                  <div className="flex items-center gap-1">
                                    {squadra.andamento.map((punto, idx) => {
                                      const height = Math.round((punto.punti / maxPunti) * 10);
                                      return (
                                        <div key={idx} className="flex flex-col items-center">
                                          <div 
                                            className="w-2 rounded-t"
                                            style={{ 
                                              height: `${height * 4}px`,
                                              backgroundColor: colors[sIdx]
                                            }}
                                            title={`G${punto.giornata}: ${punto.punti} pt`}
                                          />
                                          <div className="text-[8px] mt-1">{punto.giornata}</div>
                                        </div>
                                      );
                                    })}
                                    <div className="ml-2 font-bold" style={{ color: colors[sIdx] }}>
                                      {squadra.puntiTotali} pt
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                          
                          {/* Trend */}
                          <div className="space-y-2">
                            {top3.map((squadra) => {
                              const trend = getTrend(squadra.andamento);
                              return (
                                <div key={squadra.nome} className="bg-white rounded p-2 border border-purple-200 flex justify-between items-center">
                                  <span className="text-sm font-semibold text-gray-800">{squadra.nome}</span>
                                  <span className={`text-xs font-semibold ${trend.color}`}>{trend.text}</span>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                  
                </div>
              )}
                    </>
                  )}
                </div>
              )}

              {/* TAB SQUADRE */}
              {classificaTab === 'squadre' && (
                <div>
                  <div className="mb-4">
                    <button
                      onClick={() => setShowAddSquadraModal(true)}
                      disabled={userRole !== 'admin'}
                      className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50"
                    >
                      + Aggiungi Squadra
                    </button>
                  </div>
                  
                  {squadreGirone.length === 0 ? (
                    <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                      <div className="text-6xl mb-4">üë•</div>
                      <h3 className="text-xl font-bold text-gray-800 mb-2">Nessuna squadra inserita</h3>
                      <p className="text-gray-600 mb-4">Aggiungi le squadre del girone per iniziare</p>
                    </div>
                  ) : (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                      <div className="space-y-3">
                        {squadreGirone.map((sq, idx) => (
                          <div key={sq.id} className="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50">
                            <div className="flex items-center gap-4">
                              <div className="text-2xl font-bold text-gray-400">{idx + 1}</div>
                              <div>
                                <div className="font-bold text-lg">{sq.nome}</div>
                                <div className="text-sm text-gray-500">Aggiunta il {new Date(sq.dataAggiunta).toLocaleDateString('it-IT')}</div>
                              </div>
                            </div>
                            {userRole === 'admin' && (
                              <div className="flex gap-2">
                                <button
                                  onClick={() => {
                                    setEditingSquadra(sq);
                                    setShowAddSquadraModal(true);
                                  }}
                                  className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                >
                                  ‚úèÔ∏è Modifica
                                </button>
                                <button
                                  onClick={() => {
                                    if (window.confirm(`Eliminare "${sq.nome}"?`)) {
                                      setSquadreGirone(squadreGirone.filter(s => s.id !== sq.id));
                                      showToast('Squadra eliminata', 'success');
                                    }
                                  }}
                                  className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                                >
                                  üóëÔ∏è
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* TAB RISULTATI - Continua nella parte 3 */}
              {classificaTab === 'risultati' && (
                <div>
                  {squadreGirone.length < 2 ? (
                    <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 text-center">
                      <div className="text-4xl mb-2">‚ö†Ô∏è</div>
                      <p className="font-semibold">Aggiungi almeno 2 squadre per inserire risultati</p>
                    </div>
                  ) : (
                    <div>
                      <div className="flex gap-4 mb-4 items-center flex-wrap">
                        <select
                          value={selectedGiornata}
                          onChange={(e) => setSelectedGiornata(parseInt(e.target.value))}
                          className="p-3 border-2 border-gray-300 rounded-lg"
                        >
                          {[...Array(22)].map((_, i) => (
                            <option key={i + 1} value={i + 1}>Giornata {i + 1}</option>
                          ))}
                        </select>
                        {userRole === 'admin' && (
                          <button
                            onClick={() => {
                              const giornata = risultatiCampionato.find(g => g.giornata === selectedGiornata);
                              if (!giornata) {
                                setRisultatiCampionato([...risultatiCampionato, {
                                  giornata: selectedGiornata,
                                  data: new Date().toISOString().split('T')[0],
                                  partite: []
                                }]);
                              }
                              showToast('Giornata creata', 'success');
                            }}
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700"
                          >
                            + Nuova Giornata
                          </button>
                        )}
                      </div>
                      
                      {(() => {
                        const giornata = risultatiCampionato.find(g => g.giornata === selectedGiornata);
                        
                        if (!giornata) {
                          return (
                            <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                              <div className="text-6xl mb-4">‚öΩ</div>
                              <p className="text-gray-600">Nessun risultato per questa giornata</p>
                            </div>
                          );
                        }
                        
                        return (
                          <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="space-y-4">
                              {giornata.partite.map((partita, idx) => (
                                <div key={idx} className="border rounded-lg p-3 flex items-center gap-3">
                                  <select
                                    value={partita.squadraCasa}
                                    onChange={(e) => {
                                      const newRisultati = [...risultatiCampionato];
                                      const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                      g.partite[idx].squadraCasa = e.target.value;
                                      setRisultatiCampionato(newRisultati);
                                    }}
                                    disabled={userRole !== 'admin'}
                                    className="flex-1 p-2 border-2 rounded font-semibold"
                                  >
                                    {squadreGirone.map(sq => (
                                      <option key={sq.id} value={sq.nome}>{sq.nome}</option>
                                    ))}
                                  </select>
                                  
                                  <input
                                    type="number"
                                    min="0"
                                    placeholder="0"
                                    value={partita.golCasa === '' ? '' : partita.golCasa}
                                    onChange={(e) => {
                                      const newRisultati = [...risultatiCampionato];
                                      const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                      const value = e.target.value === '' ? '' : parseInt(e.target.value) || 0;
                                      g.partite[idx].golCasa = value;
                                      // Imposta giocata=true solo se entrambi i gol sono inseriti
                                      if (value !== '' && g.partite[idx].golTrasferta !== '') {
                                        g.partite[idx].giocata = true;
                                      } else {
                                        g.partite[idx].giocata = false;
                                      }
                                      setRisultatiCampionato(newRisultati);
                                    }}
                                    disabled={userRole !== 'admin'}
                                    className="w-16 p-2 border-2 text-center text-lg font-bold rounded"
                                  />
                                  
                                  <div className="text-gray-400 font-bold">-</div>
                                  
                                  <input
                                    type="number"
                                    min="0"
                                    placeholder="0"
                                    value={partita.golTrasferta === '' ? '' : partita.golTrasferta}
                                    onChange={(e) => {
                                      const newRisultati = [...risultatiCampionato];
                                      const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                      const value = e.target.value === '' ? '' : parseInt(e.target.value) || 0;
                                      g.partite[idx].golTrasferta = value;
                                      // Imposta giocata=true solo se entrambi i gol sono inseriti
                                      if (value !== '' && g.partite[idx].golCasa !== '') {
                                        g.partite[idx].giocata = true;
                                      } else {
                                        g.partite[idx].giocata = false;
                                      }
                                      setRisultatiCampionato(newRisultati);
                                    }}
                                    disabled={userRole !== 'admin'}
                                    className="w-16 p-2 border-2 text-center text-lg font-bold rounded"
                                  />
                                  
                                  <select
                                    value={partita.squadraTrasferta}
                                    onChange={(e) => {
                                      const newRisultati = [...risultatiCampionato];
                                      const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                      g.partite[idx].squadraTrasferta = e.target.value;
                                      setRisultatiCampionato(newRisultati);
                                    }}
                                    disabled={userRole !== 'admin'}
                                    className="flex-1 p-2 border-2 rounded font-semibold"
                                  >
                                    {squadreGirone.map(sq => (
                                      <option key={sq.id} value={sq.nome}>{sq.nome}</option>
                                    ))}
                                  </select>
                                  
                                  {userRole === 'admin' && (
                                    <button
                                      onClick={() => {
                                        if (window.confirm(`Eliminare questa partita?\n${partita.squadraCasa} vs ${partita.squadraTrasferta}`)) {
                                          const newRisultati = [...risultatiCampionato];
                                          const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                          g.partite.splice(idx, 1);
                                          setRisultatiCampionato(newRisultati);
                                          showToast('Partita eliminata', 'success');
                                        }
                                      }}
                                      className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold flex-shrink-0"
                                    >
                                      üóëÔ∏è
                                    </button>
                                  )}
                                </div>
                              ))}
                              
                              {userRole === 'admin' && (
                                <button
                                  onClick={() => {
                                    const newRisultati = [...risultatiCampionato];
                                    const g = newRisultati.find(r => r.giornata === selectedGiornata);
                                    g.partite.push({
                                      id: Date.now(),
                                      squadraCasa: squadreGirone[0]?.nome || '',
                                      squadraTrasferta: squadreGirone[1]?.nome || '',
                                      golCasa: '',
                                      golTrasferta: '',
                                      giocata: false
                                    });
                                    setRisultatiCampionato(newRisultati);
                                  }}
                                  className="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50"
                                >
                                  + Aggiungi Partita
                                </button>
                              )}
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  )}
                </div>
              )}

              {/* Modal Aggiungi/Modifica Squadra */}
              {showAddSquadraModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                    <h3 className="text-xl font-bold mb-4">{editingSquadra ? 'Modifica Squadra' : 'Aggiungi Squadra'}</h3>
                    <input
                      type="text"
                      placeholder="Nome squadra"
                      defaultValue={editingSquadra?.nome || ''}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          const nome = e.target.value.trim();
                          if (!nome) {
                            alert('Inserisci un nome');
                            return;
                          }
                          if (editingSquadra) {
                            setSquadreGirone(squadreGirone.map(s => s.id === editingSquadra.id ? {...s, nome} : s));
                            showToast('Squadra modificata', 'success');
                          } else {
                            setSquadreGirone([...squadreGirone, {
                              id: Date.now(),
                              nome,
                              dataAggiunta: new Date().toISOString()
                            }]);
                            showToast('Squadra aggiunta', 'success');
                          }
                          setShowAddSquadraModal(false);
                          setEditingSquadra(null);
                        }
                      }}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg mb-4"
                      autoFocus
                    />
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          const input = document.querySelector('input[placeholder="Nome squadra"]');
                          const nome = input.value.trim();
                          if (!nome) {
                            alert('Inserisci un nome');
                            return;
                          }
                          if (editingSquadra) {
                            setSquadreGirone(squadreGirone.map(s => s.id === editingSquadra.id ? {...s, nome} : s));
                            showToast('Squadra modificata', 'success');
                          } else {
                            setSquadreGirone([...squadreGirone, {
                              id: Date.now(),
                              nome,
                              dataAggiunta: new Date().toISOString()
                            }]);
                            showToast('Squadra aggiunta', 'success');
                          }
                          setShowAddSquadraModal(false);
                          setEditingSquadra(null);
                        }}
                        className="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700"
                      >
                        üíæ Salva
                      </button>
                      <button
                        onClick={() => {
                          setShowAddSquadraModal(false);
                          setEditingSquadra(null);
                        }}
                        className="flex-1 bg-gray-400 text-white py-2 rounded-lg font-bold hover:bg-gray-500"
                      >
                        ‚ùå Annulla
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === 'trainings' && (
            <div>
              <div className="flex justify-between items-center mb-4 flex-wrap gap-3">
                <h2 className="text-2xl font-bold text-gray-800">Allenamenti</h2>
                <div className="flex gap-3">
                  <button
                    onClick={stampaListaPresenze}
                    className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                  >
                    <Download size={20} />
                    üìã Stampa Lista Presenze
                  </button>
                  <button
                    onClick={addTraining}
                    disabled={userRole !== 'admin'}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${
                      userRole === 'admin'
                        ? 'bg-blue-600 text-white hover:bg-blue-700'
                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                    }`}
                    title={userRole !== 'admin' ? 'Solo Admin pu√≤ aggiungere' : ''}
                  >
                    <Plus size={20} />
                    Aggiungi Nuovo Allenamento
                  </button>
                </div>
              </div>

              {trainings.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-lg">Nessun allenamento registrato</p>
                  <p className="text-sm mt-2">Clicca su "Aggiungi Nuovo Allenamento" per iniziare</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {getSortedTrainings().map(training => (
                    <div key={training.id} className="border rounded-lg bg-gray-50">
                      <div 
                        className="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-100 transition-colors"
                        onClick={() => toggleTraining(training.id)}
                      >
                        <div className="flex items-center gap-4 flex-1">
                          <span className="text-2xl">{expandedTrainings[training.id] ? '‚ñº' : '‚ñ∂'}</span>
                          <div className="flex items-center gap-4">
                            <input
                              type="date"
                              value={training.data}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateTraining(training.id, 'data', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg font-semibold"
                            />
                            <div>
                              <span className="font-semibold text-lg">Allenamento</span>
                              <span className="text-sm text-gray-600 ml-4">
                                Presenti: {
                                  Object.entries(training.presenze)
                                    .filter(([numero, presente]) => {
                                      if (presente !== true) return false;
                                      const player = players.find(p => p.numero === parseInt(numero));
                                      if (!player || !player.nome) return false;
                                      if (player.fuoriRosa) return false;
                                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                                      return true;
                                    })
                                    .length
                                } | 
                                Assenti: {
                                  Object.entries(training.presenze)
                                    .filter(([numero, presente]) => {
                                      if (presente !== false) return false;
                                      const player = players.find(p => p.numero === parseInt(numero));
                                      if (!player || !player.nome) return false;
                                      if (player.fuoriRosa) return false;
                                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                                      return true;
                                    })
                                    .length
                                } | 
                                Infortuni: {
                                  Object.entries(training.infortuni)
                                    .filter(([numero, infortunato]) => {
                                      if (!infortunato) return false;
                                      const player = players.find(p => p.numero === parseInt(numero));
                                      if (!player || !player.nome) return false;
                                      if (player.fuoriRosa) return false;
                                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                                      return true;
                                    })
                                    .length
                                }
                                {training.esercizi && training.esercizi.length > 0 && (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      console.log('üîµ Click su esercizi!', training.id);
                                      console.log('Training object:', training);
                                      setExerciseModalTraining(training);
                                      console.log('‚úÖ exerciseModalTraining settato');
                                    }}
                                    className="ml-3 text-blue-600 font-semibold hover:text-blue-800 hover:underline transition-all cursor-pointer"
                                  >
                                    ‚è±Ô∏è {training.esercizi.length} esercizi - {calcolaTotaleMinuti(training.esercizi)} min
                                  </button>
                                )}
                              </span>
                            </div>
                          </div>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            if (userRole === 'admin') deleteTraining(training.id);
                          }}
                          disabled={userRole !== 'admin'}
                          className={`p-2 ${
                            userRole === 'admin'
                              ? 'text-red-600 hover:text-red-700'
                              : 'text-gray-400 cursor-not-allowed'
                          }`}
                          title={userRole !== 'admin' ? 'Solo Admin pu√≤ eliminare' : ''}
                        >
                          <Trash2 size={20} />
                        </button>
                      </div>

                      {expandedTrainings[training.id] && (
                        <div className="border-t bg-white">
                          {/* TAB NAVIGATION */}
                          <div className="flex border-b">
                            <button
                              onClick={() => setTrainingTabActive({...trainingTabActive, [training.id]: 'presenze'})}
                              className={`flex-1 px-6 py-3 font-semibold transition-colors ${
                                (trainingTabActive[training.id] || 'presenze') === 'presenze'
                                  ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                                  : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'
                              }`}
                            >
                              üë• Presenze
                            </button>
                            <button
                              onClick={() => setTrainingTabActive({...trainingTabActive, [training.id]: 'esercizi'})}
                              className={`flex-1 px-6 py-3 font-semibold transition-colors ${
                                trainingTabActive[training.id] === 'esercizi'
                                  ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50'
                                  : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'
                              }`}
                            >
                              üìù Esercizi ({training.esercizi?.length || 0})
                            </button>
                          </div>

                          {/* TAB CONTENT - PRESENZE */}
                          {(trainingTabActive[training.id] || 'presenze') === 'presenze' && (
                            <div 
                              className="p-4"
                              style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.7} : {}}
                            >
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                {players.filter(p => {
                                  if (!p.nome) return false;
                                  if (p.fuoriRosa) return false; // ‚úÖ Escludi giocatori fuori rosa
                                  if (!p.dataCreazione) return true;
                                  return new Date(p.dataCreazione) <= new Date(training.data);
                                }).map(player => (
                              <div key={player.numero} className="flex items-center gap-2 bg-white p-2 rounded">
                                <span className="font-bold text-gray-700 w-8">{player.numero}</span>
                                <span className="flex-1 text-sm">{player.nome}</span>
                                <label className="flex items-center gap-1">
                                  <input
                                    type="checkbox"
                                    checked={training.presenze[player.numero] === true}
                                    onChange={(e) => {
                                      const newPresenze = { ...training.presenze, [player.numero]: e.target.checked ? true : undefined };
                                      const newInfortuni = { ...training.infortuni };
                                      
                                      // Se spunta presente, togli automaticamente infortunato
                                      if (e.target.checked) {
                                        newInfortuni[player.numero] = false;
                                      }
                                      
                                      // Aggiorna entrambi
                                      setTrainings(trainings.map(t => 
                                        t.id === training.id 
                                          ? { ...t, presenze: newPresenze, infortuni: newInfortuni }
                                          : t
                                      ));
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-xs text-green-600">P</span>
                                </label>
                                <label className="flex items-center gap-1">
                                  <input
                                    type="checkbox"
                                    checked={training.presenze[player.numero] === false}
                                    onChange={(e) => {
                                      const newPresenze = { ...training.presenze, [player.numero]: e.target.checked ? false : undefined };
                                      updateTraining(training.id, 'presenze', newPresenze);
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-xs text-orange-600">A</span>
                                </label>
                                <label className="flex items-center gap-1">
                                  <input
                                    type="checkbox"
                                    checked={training.infortuni[player.numero] || false}
                                    onChange={(e) => {
                                      const newInfortuni = { ...training.infortuni, [player.numero]: e.target.checked };
                                      const newPresenze = { ...training.presenze };
                                      
                                      // Se spunta infortunato, togli automaticamente presente
                                      if (e.target.checked) {
                                        newPresenze[player.numero] = false;
                                      }
                                      
                                      // Aggiorna entrambi
                                      setTrainings(trainings.map(t => 
                                        t.id === training.id 
                                          ? { ...t, infortuni: newInfortuni, presenze: newPresenze }
                                          : t
                                      ));
                                    }}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-xs text-red-600">I</span>
                                </label>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* TAB CONTENT - ESERCIZI */}
                      {trainingTabActive[training.id] === 'esercizi' && (
                        <div className="p-4">
                          {/* FORM AGGIUNGI ESERCIZIO */}
                          <div className="bg-gray-50 rounded-lg p-4 mb-4 border-2 border-gray-200">
                            <h4 className="font-bold text-lg mb-3">‚ûï Aggiungi Esercizio</h4>
                            
                            {/* Template Dropdown */}
                            <div className="mb-3">
                              <label className="block text-sm font-semibold text-gray-700 mb-1">
                                Template (opzionale)
                              </label>
                              <select
                                value={(newEsercizio[training.id] || {}).template || ''}
                                onChange={(e) => {
                                  const template = templateEsercizi.find(t => t.nome === e.target.value);
                                  if (template) {
                                    setNewEsercizio({
                                      ...newEsercizio,
                                      [training.id]: {
                                        ...(newEsercizio[training.id] || {}),
                                        template: template.nome,
                                        nome: template.nome === 'Personalizzato' ? '' : template.nome,
                                        durata: template.durata.toString(),
                                        descrizione: template.descrizione
                                      }
                                    });
                                  }
                                }}
                                className="w-full p-2 border-2 border-gray-300 rounded-lg"
                              >
                                <option value="">Seleziona template o inserisci manualmente</option>
                                {templateEsercizi.map(t => (
                                  <option key={t.nome} value={t.nome}>
                                    {t.nome} {t.durata > 0 ? `(${t.durata} min)` : ''}
                                  </option>
                                ))}
                              </select>
                            </div>

                            {/* Nome */}
                            <div className="mb-3">
                              <label className="block text-sm font-semibold text-gray-700 mb-1">
                                Nome Esercizio *
                              </label>
                              <input
                                type="text"
                                value={(newEsercizio[training.id] || {}).nome || ''}
                                onChange={(e) => setNewEsercizio({
                                  ...newEsercizio,
                                  [training.id]: {
                                    ...(newEsercizio[training.id] || {}),
                                    nome: e.target.value
                                  }
                                })}
                                placeholder="es: Possesso palla 4v4"
                                className="w-full p-2 border-2 border-gray-300 rounded-lg"
                              />
                            </div>

                            {/* Durata */}
                            <div className="mb-3">
                              <label className="block text-sm font-semibold text-gray-700 mb-1">
                                Durata (minuti) *
                              </label>
                              <input
                                type="number"
                                value={(newEsercizio[training.id] || {}).durata || ''}
                                onChange={(e) => setNewEsercizio({
                                  ...newEsercizio,
                                  [training.id]: {
                                    ...(newEsercizio[training.id] || {}),
                                    durata: e.target.value
                                  }
                                })}
                                placeholder="es: 20"
                                min="0"
                                className="w-full p-2 border-2 border-gray-300 rounded-lg"
                              />
                            </div>

                            {/* Descrizione */}
                            <div className="mb-3">
                              <label className="block text-sm font-semibold text-gray-700 mb-1">
                                Descrizione (opzionale)
                              </label>
                              <textarea
                                value={(newEsercizio[training.id] || {}).descrizione || ''}
                                onChange={(e) => setNewEsercizio({
                                  ...newEsercizio,
                                  [training.id]: {
                                    ...(newEsercizio[training.id] || {}),
                                    descrizione: e.target.value
                                  }
                                })}
                                placeholder="es: Mantenimento palla in spazi stretti"
                                rows="2"
                                className="w-full p-2 border-2 border-gray-300 rounded-lg"
                              />
                            </div>

                            {/* Valutazione */}
                            <div className="mb-4">
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Valutazione (opzionale)
                              </label>
                              <div className="flex gap-4">
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="radio"
                                    name={`val-${training.id}`}
                                    value="Scarso"
                                    checked={((newEsercizio[training.id] || {}).valutazione || '') === 'Scarso'}
                                    onChange={(e) => setNewEsercizio({
                                      ...newEsercizio,
                                      [training.id]: {
                                        ...(newEsercizio[training.id] || {}),
                                        valutazione: e.target.value
                                      }
                                    })}
                                    className="w-4 h-4"
                                  />
                                  <span className={`${((newEsercizio[training.id] || {}).valutazione || '') === 'Scarso' ? 'text-red-600 font-bold' : 'text-gray-600'}`}>
                                    üî¥ Scarso
                                  </span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="radio"
                                    name={`val-${training.id}`}
                                    value="Medio"
                                    checked={((newEsercizio[training.id] || {}).valutazione || '') === 'Medio'}
                                    onChange={(e) => setNewEsercizio({
                                      ...newEsercizio,
                                      [training.id]: {
                                        ...(newEsercizio[training.id] || {}),
                                        valutazione: e.target.value
                                      }
                                    })}
                                    className="w-4 h-4"
                                  />
                                  <span className={`${((newEsercizio[training.id] || {}).valutazione || '') === 'Medio' ? 'text-yellow-600 font-bold' : 'text-gray-600'}`}>
                                    üü° Medio
                                  </span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="radio"
                                    name={`val-${training.id}`}
                                    value="Buono"
                                    checked={((newEsercizio[training.id] || {}).valutazione || '') === 'Buono'}
                                    onChange={(e) => setNewEsercizio({
                                      ...newEsercizio,
                                      [training.id]: {
                                        ...(newEsercizio[training.id] || {}),
                                        valutazione: e.target.value
                                      }
                                    })}
                                    className="w-4 h-4"
                                  />
                                  <span className={`${((newEsercizio[training.id] || {}).valutazione || '') === 'Buono' ? 'text-green-600 font-bold' : 'text-gray-600'}`}>
                                    üü¢ Buono
                                  </span>
                                </label>
                              </div>
                            </div>

                            {/* Bottone Aggiungi */}
                            <button
                              onClick={() => {
                                const form = newEsercizio[training.id] || {};
                                if (!form.nome || !form.durata) {
                                  showToast('‚ö†Ô∏è Nome e durata sono obbligatori', 'warning');
                                  return;
                                }
                                addEsercizio(training.id, form);
                                setNewEsercizio({
                                  ...newEsercizio,
                                  [training.id]: {
                                    template: '',
                                    nome: '',
                                    durata: '',
                                    descrizione: '',
                                    valutazione: ''
                                  }
                                });
                                showToast('‚úÖ Esercizio aggiunto!', 'success');
                              }}
                              className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                            >
                              ‚úÖ Aggiungi Esercizio
                            </button>
                          </div>

                          {/* LISTA ESERCIZI */}
                          {training.esercizi && training.esercizi.length > 0 ? (
                            <div className="space-y-3">
                              <h4 className="font-bold text-lg mb-3">üìã Esercizi Inseriti</h4>
                              
                              {training.esercizi.map((esercizio, idx) => (
                                <div key={esercizio.id} className="bg-white rounded-lg p-4 border-2 border-gray-200 hover:border-blue-300 transition-colors">
                                  <div className="flex justify-between items-start mb-2">
                                    <div className="flex-1">
                                      <div className="flex items-center gap-2 mb-1">
                                        <span className="font-bold text-gray-800 text-lg">{idx + 1}. {esercizio.nome}</span>
                                        {esercizio.valutazione && (
                                          <span className={`text-sm font-semibold ${
                                            esercizio.valutazione === 'Scarso' ? 'text-red-600' :
                                            esercizio.valutazione === 'Medio' ? 'text-yellow-600' :
                                            'text-green-600'
                                          }`}>
                                            {esercizio.valutazione === 'Scarso' ? 'üî¥' :
                                             esercizio.valutazione === 'Medio' ? 'üü°' : 'üü¢'} {esercizio.valutazione}
                                          </span>
                                        )}
                                      </div>
                                      <div className="text-sm text-gray-600">
                                        ‚è±Ô∏è {esercizio.durata} minuti
                                      </div>
                                      {esercizio.descrizione && (
                                        <div className="text-sm text-gray-600 mt-1">
                                          üí¨ {esercizio.descrizione}
                                        </div>
                                      )}
                                    </div>
                                    <div className="flex gap-2">
                                      <button
                                        onClick={() => {
                                          setEditingEsercizio({
                                            trainingId: training.id,
                                            esercizioId: esercizio.id,
                                            nome: esercizio.nome,
                                            durata: esercizio.durata,
                                            descrizione: esercizio.descrizione || '',
                                            valutazione: esercizio.valutazione || ''
                                          });
                                        }}
                                        className="p-2 text-blue-600 hover:bg-blue-50 rounded"
                                        title="Modifica"
                                      >
                                        ‚úèÔ∏è
                                      </button>
                                      <button
                                        onClick={() => {
                                          if (window.confirm(`Eliminare "${esercizio.nome}"?`)) {
                                            deleteEsercizio(training.id, esercizio.id);
                                            showToast('üóëÔ∏è Esercizio eliminato', 'success');
                                          }
                                        }}
                                        className="p-2 text-red-600 hover:bg-red-50 rounded"
                                        title="Elimina"
                                      >
                                        üóëÔ∏è
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              ))}

                              {/* TOTALE MINUTI */}
                              <div className="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
                                <div className="flex justify-between items-center">
                                  <span className="font-bold text-lg text-gray-800">‚è±Ô∏è TOTALE:</span>
                                  <span className="font-bold text-2xl text-blue-600">
                                    {calcolaTotaleMinuti(training.esercizi)} minuti
                                  </span>
                                </div>
                              </div>
                            </div>
                          ) : (
                            <div className="text-center py-8 text-gray-500">
                              <p className="text-lg">Nessun esercizio inserito</p>
                              <p className="text-sm mt-2">Aggiungi il primo esercizio usando il form sopra</p>
                            </div>
                          )}

                          {/* DUPLICA DA ALTRO ALLENAMENTO */}
                          {trainings.filter(t => t.id !== training.id && t.esercizi && t.esercizi.length > 0).length > 0 && (
                            <div className="mt-4 bg-purple-50 rounded-lg p-4 border-2 border-purple-200">
                              <h4 className="font-bold text-lg mb-3">üìã Duplica Esercizi</h4>
                              <div className="flex gap-2">
                                <select
                                  id={`duplicate-${training.id}`}
                                  className="flex-1 p-2 border-2 border-gray-300 rounded-lg"
                                  defaultValue=""
                                >
                                  <option value="" disabled>Seleziona allenamento...</option>
                                  {trainings
                                    .filter(t => t.id !== training.id && t.esercizi && t.esercizi.length > 0)
                                    .sort((a, b) => new Date(b.data) - new Date(a.data))
                                    .map(t => (
                                      <option key={t.id} value={t.id}>
                                        {t.data} - {t.esercizi.length} esercizi ({calcolaTotaleMinuti(t.esercizi)} min)
                                      </option>
                                    ))}
                                </select>
                                <button
                                  onClick={() => {
                                    const select = document.getElementById(`duplicate-${training.id}`);
                                    const sourceId = parseInt(select.value);
                                    if (sourceId) {
                                      duplicaEserciziDaAllenamento(training.id, sourceId);
                                      select.value = '';
                                    } else {
                                      showToast('‚ö†Ô∏è Seleziona un allenamento', 'warning');
                                    }
                                  }}
                                  className="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors whitespace-nowrap"
                                >
                                  üìã Duplica
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* MODAL MODIFICA ESERCIZIO */}
          {editingEsercizio && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-2xl font-bold mb-4 text-gray-800">‚úèÔ∏è Modifica Esercizio</h3>
                
                {/* Nome */}
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Nome Esercizio *
                  </label>
                  <input
                    type="text"
                    value={editingEsercizio.nome}
                    onChange={(e) => setEditingEsercizio({...editingEsercizio, nome: e.target.value})}
                    placeholder="es: Possesso palla 4v4"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg"
                  />
                </div>

                {/* Durata */}
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Durata (minuti) *
                  </label>
                  <input
                    type="number"
                    value={editingEsercizio.durata}
                    onChange={(e) => setEditingEsercizio({...editingEsercizio, durata: e.target.value})}
                    placeholder="es: 20"
                    min="0"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg"
                  />
                </div>

                {/* Descrizione */}
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Descrizione (opzionale)
                  </label>
                  <textarea
                    value={editingEsercizio.descrizione}
                    onChange={(e) => setEditingEsercizio({...editingEsercizio, descrizione: e.target.value})}
                    placeholder="es: Mantenimento palla in spazi stretti"
                    rows="3"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg"
                  />
                </div>

                {/* Valutazione */}
                <div className="mb-6">
                  <label className="block text-sm font-semibold text-gray-700 mb-3">
                    Valutazione
                  </label>
                  <div className="flex flex-wrap gap-4">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="edit-valutazione"
                        value=""
                        checked={editingEsercizio.valutazione === ''}
                        onChange={(e) => setEditingEsercizio({...editingEsercizio, valutazione: ''})}
                        className="w-5 h-5"
                      />
                      <span className={`text-lg ${editingEsercizio.valutazione === '' ? 'font-bold' : ''}`}>
                        Nessuna
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="edit-valutazione"
                        value="Scarso"
                        checked={editingEsercizio.valutazione === 'Scarso'}
                        onChange={(e) => setEditingEsercizio({...editingEsercizio, valutazione: e.target.value})}
                        className="w-5 h-5"
                      />
                      <span className={`text-lg ${editingEsercizio.valutazione === 'Scarso' ? 'text-red-600 font-bold' : 'text-gray-600'}`}>
                        üî¥ Scarso
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="edit-valutazione"
                        value="Medio"
                        checked={editingEsercizio.valutazione === 'Medio'}
                        onChange={(e) => setEditingEsercizio({...editingEsercizio, valutazione: e.target.value})}
                        className="w-5 h-5"
                      />
                      <span className={`text-lg ${editingEsercizio.valutazione === 'Medio' ? 'text-yellow-600 font-bold' : 'text-gray-600'}`}>
                        üü° Medio
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="radio"
                        name="edit-valutazione"
                        value="Buono"
                        checked={editingEsercizio.valutazione === 'Buono'}
                        onChange={(e) => setEditingEsercizio({...editingEsercizio, valutazione: e.target.value})}
                        className="w-5 h-5"
                      />
                      <span className={`text-lg ${editingEsercizio.valutazione === 'Buono' ? 'text-green-600 font-bold' : 'text-gray-600'}`}>
                        üü¢ Buono
                      </span>
                    </label>
                  </div>
                </div>

                {/* Bottoni */}
                <div className="flex gap-3 justify-end">
                  <button
                    onClick={() => setEditingEsercizio(null)}
                    className="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
                  >
                    ‚ùå Annulla
                  </button>
                  <button
                    onClick={() => {
                      if (!editingEsercizio.nome || !editingEsercizio.durata) {
                        showToast('‚ö†Ô∏è Nome e durata sono obbligatori', 'warning');
                        return;
                      }
                      
                      // Aggiorna l'esercizio completo in un'unica operazione
                      setTrainings(trainings.map(t => {
                        if (t.id === editingEsercizio.trainingId) {
                          return {
                            ...t,
                            esercizi: (t.esercizi || []).map(e => 
                              e.id === editingEsercizio.esercizioId 
                                ? {
                                    ...e,
                                    nome: editingEsercizio.nome,
                                    durata: parseInt(editingEsercizio.durata) || 0,
                                    descrizione: editingEsercizio.descrizione,
                                    valutazione: editingEsercizio.valutazione
                                  }
                                : e
                            )
                          };
                        }
                        return t;
                      }));
                      
                      setEditingEsercizio(null);
                      showToast('‚úÖ Esercizio modificato!', 'success');
                    }}
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                  >
                    ‚úÖ Salva Modifiche
                  </button>
                </div>
              </div>
            </div>
          )}

{activeTab === 'matches' && (
            <div>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold text-gray-800">Partite</h2>
                <button
                  onClick={addMatch}
                  disabled={userRole !== 'admin'}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${
                    userRole === 'admin'
                      ? 'bg-blue-600 text-white hover:bg-blue-700'
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                  title={userRole !== 'admin' ? 'Solo Admin pu√≤ aggiungere' : ''}
                >
                  <Plus size={20} />
                  Aggiungi Nuova Partita
                </button>
              </div>

              {matches.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-lg">Nessuna partita registrata</p>
                  <p className="text-sm mt-2">Clicca su "Aggiungi Nuova Partita" per iniziare</p>
                </div>
              ) : (
                <div className="space-y-6">
                  {getSortedMatches().map(match => (
                    <div key={match.id} className="border rounded-lg bg-gray-50">
                      <div 
                        className={`flex justify-between items-center p-4 cursor-pointer hover:bg-gray-100 transition-colors ${expandedMatches[match.id] ? 'sticky top-0 z-20 bg-gray-100 border-b-2 border-blue-300' : ''}`}
                        onClick={() => toggleMatch(match.id)}
                      >
                        <div className="flex items-center gap-4 flex-1">
                          <span className="text-2xl">{expandedMatches[match.id] ? '‚ñº' : '‚ñ∂'}</span>
                          <div className="flex gap-4 flex-wrap flex-1">
                            <input
                              type="date"
                              value={match.data}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'data', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg font-semibold"
                            />
                            <input
                              type="text"
                              placeholder="Squadra Casa"
                              value={match.squadraCasa}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'squadraCasa', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg"
                            />
                            <input
                              type="text"
                              placeholder="Squadra Trasferta"
                              value={match.squadraTrasferta}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'squadraTrasferta', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg"
                            />
                            <input
                              type="text"
                              placeholder="Risultato (es: 2-1)"
                              value={match.risultato}
                              onChange={(e) => {
                                e.stopPropagation();
                                updateMatch(match.id, 'risultato', e.target.value);
                              }}
                              onClick={(e) => e.stopPropagation()}
                              className="px-3 py-2 border rounded-lg w-32"
                            />
                          </div>
                        </div>
                        <div className="flex gap-2 flex-wrap">
                          {/* Pulsante MVP */}
                          {match.risultato && match.risultato.includes('-') && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                openMVPVoting(match.id);
                              }}
                              className={`px-4 py-2 rounded-lg transition-colors font-semibold flex items-center gap-2 ${
                                match.mvp 
                                  ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white hover:from-yellow-600 hover:to-yellow-700'
                                  : 'bg-yellow-100 text-yellow-700 border-2 border-yellow-400 hover:bg-yellow-200'
                              }`}
                            >
                              {match.mvp ? (
                                <>
                                  <span>üèÜ</span>
                                  <span className="hidden sm:inline">
                                    MVP: {players.find(p => p.numero === match.mvp)?.nome.split(' ')[0] || `#${match.mvp}`}
                                  </span>
                                </>
                              ) : (
                                <>
                                  <span>‚≠ê</span>
                                  <span className="hidden sm:inline">Vota MVP</span>
                                </>
                              )}
                            </button>
                          )}
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setShowModuloModal(match.id);
                            }}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                          >
                            ‚öΩ Modulo
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              startLiveMatch(match.id);
                            }}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold"
                          >
                            ‚ö° Live
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              if (userRole === 'admin') deleteMatch(match.id);
                            }}
                            disabled={userRole !== 'admin'}
                            className={`p-2 ${
                              userRole === 'admin'
                                ? 'text-red-600 hover:text-red-700'
                                : 'text-gray-400 cursor-not-allowed'
                            }`}
                            title={userRole !== 'admin' ? 'Solo Admin pu√≤ eliminare' : ''}
                          >
                            <Trash2 size={20} />
                          </button>
                        </div>
                      </div>

                      {expandedMatches[match.id] && (
                        <div 
                          className="border-t"
                          style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.7} : {}}
                        >
                          {/* Hint mobile */}
                          <div className="md:hidden bg-blue-50 p-2 text-xs text-center text-blue-700 border-b">
                            üëà Scorri a destra per vedere tutte le colonne ‚Üí
                          </div>
                          <div className="overflow-x-auto overflow-y-auto max-h-[600px]">
                            <table className="w-full text-xs">
                              <thead className="bg-blue-100 sticky top-0 z-10">
                                <tr>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">N¬∞ Maglia</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Giocatore</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Conv.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Tit.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Sost.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Entr.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Min.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Gol</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">Ass.</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">G.Sub</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">üü® Gio</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">üü® Pro</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">üü• Gio</th>
                                  <th className="p-1 text-center bg-blue-100 text-xs whitespace-nowrap">üü• Pro</th>
                                </tr>
                              </thead>
                            <tbody className="bg-white">
                              {players.filter(p => {
                                if (!p.nome) return false;
                                if (p.fuoriRosa) return false; // ‚úÖ Escludi giocatori fuori rosa
                                if (!p.dataCreazione) return true;
                                return new Date(p.dataCreazione) <= new Date(match.data);
                              }).sort((a, b) => {
                                const ordineDistinta = match.ordineDistinta || {};
                                const ordineA = parseInt(ordineDistinta[a.numero] || 999);
                                const ordineB = parseInt(ordineDistinta[b.numero] || 999);
                                if (ordineA === ordineB) return a.numero - b.numero;
                                return ordineA - ordineB;
                              }).map(player => (
                                <tr key={player.numero} className="border-b hover:bg-gray-50">
                                  <td className="p-1">
                                    <input
                                      type="number"
                                      min="1"
                                      max="99"
                                      value={(match.ordineDistinta || {})[player.numero] || ''}
                                      onChange={(e) => {
                                        const ordineDistinta = match.ordineDistinta || {};
                                        updateMatch(match.id, 'ordineDistinta', { ...ordineDistinta, [player.numero]: e.target.value });
                                      }}
                                      onBlur={(e) => {
                                        const newValue = e.target.value;
                                        const ordineDistinta = match.ordineDistinta || {};
                                        
                                        const isDuplicate = Object.entries(ordineDistinta).some(
                                          ([numero, valore]) => numero !== player.numero.toString() && valore === newValue && newValue !== ''
                                        );
                                        
                                        if (isDuplicate) {
                                          alert(`‚ö†Ô∏è Il numero ${newValue} √® gi√† assegnato ad un altro giocatore nella distinta!`);
                                          updateMatch(match.id, 'ordineDistinta', { ...ordineDistinta, [player.numero]: '' });
                                        }
                                      }}
                                      className={`w-12 px-2 py-1 border rounded text-center font-bold transition-colors ${
                                        match.convocati[player.numero] && (match.ordineDistinta || {})[player.numero]
                                          ? 'bg-green-100 border-green-400'
                                          : match.convocati[player.numero] && !(match.ordineDistinta || {})[player.numero]
                                          ? 'bg-orange-200 border-orange-400 animate-pulse-fast'
                                          : ''
                                      }`}
                                      placeholder={player.numero}
                                    />
                                  </td>
                                  <td className="p-1 text-sm font-bold">{player.nome}</td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.convocati[player.numero] || false}
                                      onChange={(e) => updateMatch(match.id, 'convocati', { ...match.convocati, [player.numero]: e.target.checked })}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.titolari[player.numero] || false}
                                      onChange={(e) => {
                                        const newTit = { ...match.titolari, [player.numero]: e.target.checked };
                                        const newMin = { ...match.minutiGiocati };
                                        if (e.target.checked) newMin[player.numero] = '90';
                                        setMatches(matches.map(m => m.id === match.id ? { ...m, titolari: newTit, minutiGiocati: newMin } : m));
                                      }}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.sostituzioni[player.numero] || false}
                                      onChange={(e) => updateMatch(match.id, 'sostituzioni', { ...match.sostituzioni, [player.numero]: e.target.checked })}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 text-center">
                                    <input
                                      type="checkbox"
                                      checked={match.entrati[player.numero] || false}
                                      onChange={(e) => updateMatch(match.id, 'entrati', { ...match.entrati, [player.numero]: e.target.checked })}
                                      className="w-4 h-4"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      max="90"
                                      value={match.minutiGiocati[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'minutiGiocati', { ...match.minutiGiocati, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-12">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.golFatti[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'golFatti', { ...match.golFatti, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-12">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.assist[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'assist', { ...match.assist, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    {player.ruolo.includes('Portiere') && (
                                      <input
                                        type="number"
                                        min="0"
                                        value={match.golSubiti[player.numero] || ''}
                                        onChange={(e) => updateMatch(match.id, 'golSubiti', { ...match.golSubiti, [player.numero]: e.target.value })}
                                        className="w-full px-2 py-1 border rounded text-center"
                                      />
                                    )}
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.gialli_gioco[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'gialli_gioco', { ...match.gialli_gioco, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.gialli_protesta[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'gialli_protesta', { ...match.gialli_protesta, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.rossi_gioco[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'rossi_gioco', { ...match.rossi_gioco, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                  <td className="p-1 w-16">
                                    <input
                                      type="number"
                                      min="0"
                                      value={match.rossi_protesta[player.numero] || ''}
                                      onChange={(e) => updateMatch(match.id, 'rossi_protesta', { ...match.rossi_protesta, [player.numero]: e.target.value })}
                                      className="w-full px-2 py-1 border rounded text-center"
                                    />
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                          </div>
                          <div className="text-xs text-gray-600 mt-2 px-4 pb-2">
                            üí° Inserisci il numero di maglia nell'ordine della distinta ufficiale (es: 1 per il primo, 12 per il portiere in panchina, ecc.)
                          </div>
                          
                          {/* STEP 2: Cronologia Eventi Partita */}
                          {match.timeline && match.timeline.length > 0 && (
                            <div className="border-t mt-4 pt-4 px-4 pb-4 bg-gradient-to-br from-blue-50 to-blue-100">
                              <h4 className="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <span className="text-2xl">üìã</span>
                                Cronologia Eventi Partita
                              </h4>
                              
                              <div className="space-y-2">
                                {match.timeline
                                  .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                                  .map((evento, idx) => {
                                    const time = new Date(evento.timestamp);
                                    const orario = time.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                                    
                                    // STEP 3: Mostra minuto se disponibile, altrimenti orario
                                    const displayTime = evento.minuto !== null && evento.minuto !== undefined 
                                      ? `${evento.minuto}'` 
                                      : orario;
                                    
                                    let icon = 'üìå';
                                    let bgColor = 'bg-gray-100';
                                    let textColor = 'text-gray-800';
                                    let label = evento.tipo;
                                    
                                    if (evento.tipo === 'gol') {
                                      icon = '‚öΩ';
                                      bgColor = 'bg-green-100';
                                      textColor = 'text-green-800';
                                      label = 'GOL';
                                    } else if (evento.tipo === 'golsubito') {
                                      icon = 'üî¥';
                                      bgColor = 'bg-red-100';
                                      textColor = 'text-red-800';
                                      label = 'GOL SUBITO';
                                    } else if (evento.tipo === 'assist') {
                                      icon = 'üéØ';
                                      bgColor = 'bg-blue-100';
                                      textColor = 'text-blue-800';
                                      label = 'ASSIST';
                                    } else if (evento.tipo === 'giallo') {
                                      icon = 'üü®';
                                      bgColor = 'bg-yellow-100';
                                      textColor = 'text-yellow-800';
                                      label = evento.sottotipo === 'gioco' ? 'GIALLO (gioco)' : 'GIALLO (proteste)';
                                    } else if (evento.tipo === 'rosso') {
                                      icon = 'üü•';
                                      bgColor = 'bg-red-100';
                                      textColor = 'text-red-800';
                                      label = evento.sottotipo === 'gioco' ? 'ROSSO (gioco)' : 'ROSSO (proteste)';
                                    }
                                    
                                    return (
                                      <div 
                                        key={evento.id || idx} 
                                        className={`${bgColor} rounded-lg p-3 flex items-center justify-between animate-fade-in hover:shadow-md transition-shadow`}
                                      >
                                        <div className="flex items-center gap-3 flex-1">
                                          <span className="text-3xl">{icon}</span>
                                          <div className="flex-1">
                                            <div className={`font-bold ${textColor} text-sm`}>{label}</div>
                                            <div className="text-gray-700 font-semibold">
                                              {evento.playerNome} 
                                              <span className="text-gray-600 text-xs ml-1">(#{evento.playerNum})</span>
                                            </div>
                                          </div>
                                        </div>
                                        
                                        <div className="flex items-center gap-3">
                                          <span className="text-gray-600 font-mono text-sm">{displayTime}</span>
                                          
                                          {/* Pulsante Rimuovi Evento */}
                                          <button
                                            onClick={() => {
                                              if (confirm(`Rimuovere evento: ${label} di ${evento.playerNome}?`)) {
                                                const newTimeline = match.timeline.filter((e, i) => (e.id || i) !== (evento.id || idx));
                                                updateMatch(match.id, 'timeline', newTimeline);
                                                showToast('üóëÔ∏è Evento rimosso', 'info');
                                              }
                                            }}
                                            className="text-red-600 hover:text-red-800 hover:bg-red-200 p-2 rounded-lg transition-colors"
                                            title="Rimuovi evento"
                                          >
                                            üóëÔ∏è
                                          </button>
                                        </div>
                                      </div>
                                    );
                                  })}
                              </div>
                              
                              <div className="mt-3 text-xs text-gray-600 flex items-center gap-2">
                                <span>‚ÑπÔ∏è</span>
                                <span>Gli eventi vengono registrati automaticamente quando usi i pulsanti quick-add durante la partita</span>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

{showModuloModal && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowModuloModal(null)}>
    <div className="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
      {(() => {
        const match = matches.find(m => m.id === showModuloModal);
        const titolari = players.filter(p => match.titolari[p.numero]);
        
        const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
        const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
        const posizioniModuloCorrente = (matchModulo.moduli[moduloCorrente] || {}).posizioni || {};
        const currentModulo = { modulo: moduloCorrente, posizioni: posizioniModuloCorrente };
        
        const moduli = {
          '4-4-2': { nome: '4-4-2', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'ED', 'CC1', 'CC2', 'ES', 'PC1', 'PC2'] },
          '4-3-3': { nome: '4-3-3', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MC1', 'CC', 'MC2', 'AD', 'PC', 'AS'] },
          '3-5-2': { nome: '3-5-2', posizioni: ['P', 'DC1', 'DC2', 'DC3', 'ED', 'MC1', 'CC', 'MC2', 'ES', 'PC1', 'PC2'] },
          '4-2-3-1': { nome: '4-2-3-1', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MD1', 'MD2', 'AE', 'TQ', 'AD', 'PC'] },
          '3-4-3': { nome: '3-4-3', posizioni: ['P', 'DC1', 'DC2', 'DC3', 'ED', 'CC1', 'CC2', 'ES', 'AD', 'PC', 'AS'] },
          '5-3-2': { nome: '5-3-2', posizioni: ['P', 'TD', 'DC1', 'DC2', 'DC3', 'TS', 'MC1', 'CC', 'MC2', 'PC1', 'PC2'] },
          '4-1-4-1': { nome: '4-1-4-1', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MD', 'ED', 'CC1', 'CC2', 'ES', 'PC'] },
          '4-3-1-2': { nome: '4-3-1-2', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MC1', 'CC', 'MC2', 'TQ', 'PC1', 'PC2'] },
          '4-1-2-2-1': { nome: '4-1-2-2-1', posizioni: ['P', 'TD', 'DC1', 'DC2', 'TS', 'MD', 'CC1', 'CC2', 'AE', 'AD', 'PC'] }
        };
        
        const layoutPosizioni = {
          '4-4-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'ED', top: '50%', left: '85%' },
            { pos: 'CC1', top: '50%', left: '60%' },
            { pos: 'CC2', top: '50%', left: '40%' },
            { pos: 'ES', top: '50%', left: '15%' },
            { pos: 'PC1', top: '20%', left: '60%' },
            { pos: 'PC2', top: '20%', left: '40%' }
          ],
          '4-3-3': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MC1', top: '50%', left: '75%' },
            { pos: 'CC', top: '50%', left: '50%' },
            { pos: 'MC2', top: '50%', left: '25%' },
            { pos: 'AD', top: '20%', left: '75%' },
            { pos: 'PC', top: '20%', left: '50%' },
            { pos: 'AS', top: '20%', left: '25%' }
          ],
          '3-5-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'DC1', top: '75%', left: '70%' },
            { pos: 'DC2', top: '75%', left: '50%' },
            { pos: 'DC3', top: '75%', left: '30%' },
            { pos: 'ED', top: '55%', left: '90%' },
            { pos: 'MC1', top: '55%', left: '65%' },
            { pos: 'CC', top: '55%', left: '50%' },
            { pos: 'MC2', top: '55%', left: '35%' },
            { pos: 'ES', top: '55%', left: '10%' },
            { pos: 'PC1', top: '20%', left: '60%' },
            { pos: 'PC2', top: '20%', left: '40%' }
          ],
          '4-2-3-1': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MD1', top: '60%', left: '60%' },
            { pos: 'MD2', top: '60%', left: '40%' },
            { pos: 'AE', top: '35%', left: '80%' },
            { pos: 'TQ', top: '35%', left: '50%' },
            { pos: 'AD', top: '35%', left: '20%' },
            { pos: 'PC', top: '15%', left: '50%' }
          ],
          '3-4-3': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'DC1', top: '75%', left: '70%' },
            { pos: 'DC2', top: '75%', left: '50%' },
            { pos: 'DC3', top: '75%', left: '30%' },
            { pos: 'ED', top: '55%', left: '85%' },
            { pos: 'CC1', top: '55%', left: '60%' },
            { pos: 'CC2', top: '55%', left: '40%' },
            { pos: 'ES', top: '55%', left: '15%' },
            { pos: 'AD', top: '20%', left: '75%' },
            { pos: 'PC', top: '20%', left: '50%' },
            { pos: 'AS', top: '20%', left: '25%' }
          ],
          '5-3-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '90%' },
            { pos: 'DC1', top: '75%', left: '70%' },
            { pos: 'DC2', top: '75%', left: '50%' },
            { pos: 'DC3', top: '75%', left: '30%' },
            { pos: 'TS', top: '75%', left: '10%' },
            { pos: 'MC1', top: '50%', left: '70%' },
            { pos: 'CC', top: '50%', left: '50%' },
            { pos: 'MC2', top: '50%', left: '30%' },
            { pos: 'PC1', top: '20%', left: '60%' },
            { pos: 'PC2', top: '20%', left: '40%' }
          ],
          '4-1-4-1': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MD', top: '60%', left: '50%' },
            { pos: 'ED', top: '45%', left: '85%' },
            { pos: 'CC1', top: '45%', left: '60%' },
            { pos: 'CC2', top: '45%', left: '40%' },
            { pos: 'ES', top: '45%', left: '15%' },
            { pos: 'PC', top: '15%', left: '50%' }
          ],
          '4-3-1-2': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MC1', top: '55%', left: '70%' },
            { pos: 'CC', top: '55%', left: '50%' },
            { pos: 'MC2', top: '55%', left: '30%' },
            { pos: 'TQ', top: '35%', left: '50%' },
            { pos: 'PC1', top: '15%', left: '60%' },
            { pos: 'PC2', top: '15%', left: '40%' }
          ],
          '4-1-2-2-1': [
            { pos: 'P', top: '90%', left: '50%' },
            { pos: 'TD', top: '75%', left: '85%' },
            { pos: 'DC1', top: '75%', left: '60%' },
            { pos: 'DC2', top: '75%', left: '40%' },
            { pos: 'TS', top: '75%', left: '15%' },
            { pos: 'MD', top: '60%', left: '50%' },
            { pos: 'CC1', top: '45%', left: '60%' },
            { pos: 'CC2', top: '45%', left: '40%' },
            { pos: 'AE', top: '25%', left: '75%' },
            { pos: 'AD', top: '25%', left: '25%' },
            { pos: 'PC', top: '10%', left: '50%' }
          ]
        };
        
        const layoutCorrente = layoutPosizioni[currentModulo.modulo];
        
        return (
          <>
            <div className="p-6 border-b sticky top-0 bg-white z-10">
              <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-blue-800">‚öΩ Modulo Tattico - {match.squadraCasa} vs {match.squadraTrasferta}</h2>
                <button onClick={() => setShowModuloModal(null)} className="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
              </div>
            </div>
            
            <div className="p-6">
              <div className="mb-6">
                <label className="block text-sm font-semibold text-gray-700 mb-2">Seleziona Modulo:</label>
                <div className="grid grid-cols-4 gap-2">
                {Object.keys(moduli).map(mod => (
                  <button
                    key={mod}
                    onClick={() => {
                      const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                      setModuloTattico({
                        ...moduloTattico, 
                        [match.id]: { 
                          moduloCorrente: mod,
                          moduli: matchModulo.moduli
                        }
                      });
                    }}
                    className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                      currentModulo.modulo === mod 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    {mod}
                  </button>
                ))}
              </div>
            </div>
              
              
              {titolari.length !== 11 && (
                <div className="mb-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg">
                  ‚ö†Ô∏è Attenzione: Hai selezionato {titolari.length} titolari. Seleziona esattamente 11 giocatori come titolari per visualizzare il modulo.
                </div>
              )}
              
              {titolari.length === 11 && (
                <div>
                  <div className="relative w-full rounded-lg overflow-hidden mb-12" style={{ 
                    paddingBottom: '85%', 
                    maxWidth: '455px', 
                    margin: '0 auto',
                    background: 'linear-gradient(180deg, #2d5016 0%, #1a3d0f 100%)',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
                  }}>
                    <div className="absolute inset-0">
                      <div className="absolute top-0 left-0 right-0 h-0.5 bg-white opacity-90"></div>
                      <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-white opacity-90"></div>
                      <div className="absolute top-0 bottom-0 left-0 w-0.5 bg-white opacity-90"></div>
                      <div className="absolute top-0 bottom-0 right-0 w-0.5 bg-white opacity-90"></div>
                      
                      <div className="absolute top-0 left-1/2 w-20 h-1 bg-white opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute top-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(-40px)' }}></div>
                      <div className="absolute top-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(40px)' }}></div>
                      
                      <div className="absolute top-0 left-1/2 w-36 h-20 border-2 border-white border-t-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute top-0 left-1/2 w-24 h-10 border-2 border-white border-t-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute left-1/2 w-16 h-16 border-2 border-white opacity-90 rounded-full border-t-0 border-l-0 border-r-0" style={{ top: '48px', transform: 'translateX(-50%) scaleY(0.5)' }}></div>
                      <div className="absolute left-1/2 w-2 h-2 bg-white opacity-90 rounded-full" style={{ top: '70px', transform: 'translateX(-50%)' }}></div>
                      
                      <div className="absolute top-1/2 left-0 right-0 h-0.5 bg-white opacity-90" style={{ transform: 'translateY(-50%)' }}></div>
                      
                      <div className="absolute top-1/2 left-1/2 w-24 h-24 border-2 border-white opacity-90 rounded-full" style={{ transform: 'translate(-50%, -50%)' }}></div>
                      <div className="absolute top-1/2 left-1/2 w-2 h-2 bg-white opacity-90 rounded-full" style={{ transform: 'translate(-50%, -50%)' }}></div>
                      
                      <div className="absolute bottom-0 left-1/2 w-36 h-20 border-2 border-white border-b-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute bottom-0 left-1/2 w-24 h-10 border-2 border-white border-b-0 opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute left-1/2 w-16 h-16 border-2 border-white opacity-90 rounded-full border-b-0 border-l-0 border-r-0" style={{ bottom: '48px', transform: 'translateX(-50%) scaleY(0.5)' }}></div>
                      <div className="absolute left-1/2 w-2 h-2 bg-white opacity-90 rounded-full" style={{ bottom: '70px', transform: 'translateX(-50%)' }}></div>
                      
                      <div className="absolute bottom-0 left-1/2 w-20 h-1 bg-white opacity-90" style={{ transform: 'translateX(-50%)' }}></div>
                      <div className="absolute bottom-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(-40px)' }}></div>
                      <div className="absolute bottom-0 left-1/2 w-0.5 h-2 bg-white opacity-90" style={{ transform: 'translateX(40px)' }}></div>
                      
                      <div className="absolute top-0 left-0 w-6 h-6 border-2 border-white opacity-90 rounded-br-full border-t-0 border-l-0"></div>
                      <div className="absolute top-0 left-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute top-0 left-0 w-2.5 h-2 bg-yellow-400 opacity-90"></div>
                      
                      <div className="absolute top-0 right-0 w-6 h-6 border-2 border-white opacity-90 rounded-bl-full border-t-0 border-r-0"></div>
                      <div className="absolute top-0 right-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute top-0 right-0 w-2.5 h-2 bg-yellow-400 opacity-90" style={{ transform: 'translateX(-2.5px)' }}></div>
                      
                      <div className="absolute bottom-0 left-0 w-6 h-6 border-2 border-white opacity-90 rounded-tr-full border-b-0 border-l-0"></div>
                      <div className="absolute bottom-0 left-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute bottom-0 left-0 w-2.5 h-2 bg-yellow-400 opacity-90"></div>
                      
                      <div className="absolute bottom-0 right-0 w-6 h-6 border-2 border-white opacity-90 rounded-tl-full border-b-0 border-r-0"></div>
                      <div className="absolute bottom-0 right-0 w-0.5 h-4 bg-yellow-400 opacity-90"></div>
                      <div className="absolute bottom-0 right-0 w-2.5 h-2 bg-yellow-400 opacity-90" style={{ transform: 'translateX(-2.5px)' }}></div>
                      
                      <div className="absolute inset-0 opacity-10" style={{
                        backgroundImage: 'repeating-linear-gradient(90deg, transparent, transparent 8%, rgba(255,255,255,0.1) 8%, rgba(255,255,255,0.1) 16%)'
                      }}></div>
                    </div>
                    
                    {layoutCorrente.map((pos, idx) => {
                      const giocatoreAssegnato = currentModulo.posizioni[pos.pos];
                      const giocatore = giocatoreAssegnato ? players.find(p => p.numero === giocatoreAssegnato) : null;
                      
                      // Ottieni offset salvato per questa posizione
                      const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                      const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                      const offsets = matchModulo.moduli?.[moduloCorrente]?.offsets || {};
                      const offset = offsets[pos.pos] || { x: 0, y: 0 };
                      
                      // Calcola posizione finale con offset
                      const finalTop = `calc(${pos.top} + ${offset.y}px)`;
                      const finalLeft = `calc(${pos.left} + ${offset.x}px)`;
                      
                      return (
                        <div
                          key={pos.pos}
                          className="absolute"
                          style={{ 
                            top: finalTop, 
                            left: finalLeft, 
                            transform: 'translate(-50%, -50%)'
                          }}
                          onDragOver={(e) => {
                            e.preventDefault();
                          }}
                        >
                          {giocatore ? (
                            <div 
                              className="relative group" 
                              draggable="true"
                              onDragStart={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                const campoRect = e.currentTarget.closest('.relative.w-full').getBoundingClientRect();
                                
                                setDragState({
                                  matchId: match.id,
                                  pos: pos.pos,
                                  startX: e.clientX,
                                  startY: e.clientY,
                                  campoRect: {
                                    width: campoRect.width,
                                    height: campoRect.height,
                                    left: campoRect.left,
                                    top: campoRect.top
                                  }
                                });
                                
                                e.dataTransfer.effectAllowed = 'move';
                              }}
                              onDragEnd={(e) => {
                                if (!dragState || dragState.matchId !== match.id || dragState.pos !== pos.pos) {
                                  setDragState(null);
                                  return;
                                }
                                
                                // Calcola quanto √® stato trascinato
                                const deltaX = e.clientX - dragState.startX;
                                const deltaY = e.clientY - dragState.startY;
                                
                                // Se movimento minimo, ignora (click accidentale)
                                if (Math.abs(deltaX) < 5 && Math.abs(deltaY) < 5) {
                                  setDragState(null);
                                  return;
                                }
                                
                                // Salva offset
                                const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                                const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                                const moduliAggiornati = { ...matchModulo.moduli };
                                
                                if (!moduliAggiornati[moduloCorrente]) {
                                  moduliAggiornati[moduloCorrente] = { posizioni: {}, offsets: {} };
                                }
                                
                                const currentOffsets = { ...(moduliAggiornati[moduloCorrente].offsets || {}) };
                                const existingOffset = currentOffsets[pos.pos] || { x: 0, y: 0 };
                                
                                // Aggiungi il nuovo offset a quello esistente
                                currentOffsets[pos.pos] = { 
                                  x: Math.round(existingOffset.x + deltaX), 
                                  y: Math.round(existingOffset.y + deltaY) 
                                };
                                
                                moduliAggiornati[moduloCorrente] = {
                                  ...moduliAggiornati[moduloCorrente],
                                  offsets: currentOffsets
                                };
                                
                                setModuloTattico({
                                  ...moduloTattico,
                                  [match.id]: {
                                    moduloCorrente: moduloCorrente,
                                    moduli: moduliAggiornati
                                  }
                                });
                                
                                setDragState(null);
                              }}
                              style={{ cursor: 'move' }}
                            >
                              <div className="relative" style={{ width: '39px', height: '49px' }}>
                                <div className="absolute -bottom-1 left-1/2 w-12 h-2.5 bg-black opacity-30 rounded-full blur-sm" style={{ transform: 'translateX(-50%)' }}></div>
                                
                                <svg viewBox="0 0 40 50" className="w-full h-full drop-shadow-md">
                                  <rect x="14" y="32" width="4" height="12" fill="#FF6B35" rx="2"/>
                                  <rect x="22" y="32" width="4" height="12" fill="#FF6B35" rx="2"/>
                                  <rect x="14" y="42" width="4" height="6" fill="#1a1a1a" rx="1"/>
                                  <rect x="22" y="42" width="4" height="6" fill="#1a1a1a" rx="1"/>
                                  
                                  <rect x="12" y="18" width="16" height="16" fill="#FF6B35" rx="3"/>
                                  <rect x="14" y="20" width="12" height="2" fill="#FF8C42" opacity="0.6"/>
                                  
                                  <rect x="8" y="20" width="4" height="10" fill="#FF6B35" rx="2"/>
                                  <rect x="28" y="20" width="4" height="10" fill="#FF6B35" rx="2"/>
                                  
                                  <circle cx="20" cy="12" r="6" fill="#FFD4B2"/>
                                  
                                  <path d="M 14 10 Q 14 6 20 6 Q 26 6 26 10" fill="#3d2817"/>
                                </svg>
                                
                                <div className="absolute top-4 left-1/2 transform -translate-x-1/2 text-white font-bold" style={{ fontSize: '16px', textShadow: '1px 1px 2px rgba(0,0,0,0.8)' }}>
                                  {(match.ordineDistinta && match.ordineDistinta[giocatore.numero]) || giocatore.numero}
                                </div>
                              </div>
                              
                              <div className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-center whitespace-nowrap">
                                <div className="bg-white px-1 py-0.5 rounded shadow-sm border border-gray-300">
                                  <div className="font-bold text-gray-900" style={{ fontSize: '8px' }}>
                                    {giocatore.nome}
                                  </div>
                                  <div className="text-blue-600 font-semibold" style={{ fontSize: '7px' }}>{pos.pos}</div>
                                </div>
                              </div>
                              
                              <button
                                onClick={() => {
                                  const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                                  const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                                  const moduliAggiornati = { ...matchModulo.moduli };
                                  
                                  const newPosizioni = { ...(moduliAggiornati[moduloCorrente]?.posizioni || {}) };
                                  delete newPosizioni[pos.pos];
                                  
                                  moduliAggiornati[moduloCorrente] = {
                                    ...moduliAggiornati[moduloCorrente],
                                    posizioni: newPosizioni
                                  };
                                  
                                  setModuloTattico({
                                    ...moduloTattico, 
                                    [match.id]: { 
                                      moduloCorrente: moduloCorrente,
                                      moduli: moduliAggiornati 
                                    }
                                  });
                                }}
                                className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 text-white rounded-full font-normal hover:bg-red-600 shadow-sm opacity-40 hover:opacity-100"
                                style={{ zIndex: 10, fontSize: '6px' }}
                              >
                                ‚úï
                              </button>
                              
                              {offset.x !== 0 || offset.y !== 0 ? (
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
                                    const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
                                    const moduliAggiornati = { ...matchModulo.moduli };
                                    
                                    const currentOffsets = { ...(moduliAggiornati[moduloCorrente]?.offsets || {}) };
                                    delete currentOffsets[pos.pos];
                                    
                                    moduliAggiornati[moduloCorrente] = {
                                      ...moduliAggiornati[moduloCorrente],
                                      offsets: currentOffsets
                                    };
                                    
                                    setModuloTattico({
                                      ...moduloTattico,
                                      [match.id]: {
                                        moduloCorrente: moduloCorrente,
                                        moduli: moduliAggiornati
                                      }
                                    });
                                  }}
                                  className="absolute -top-1 -left-1 w-3 h-3 bg-blue-500 text-white rounded-full font-normal hover:bg-blue-600 shadow-sm opacity-40 hover:opacity-100"
                                  style={{ zIndex: 10, fontSize: '6px' }}
                                  title="Reset posizione"
                                >
                                  ‚Ü∫
                                </button>
                              ) : null}
                            </div>
                          ) : (
                            <button
                              onClick={() => {
                                setPlayerSelectionModal({ matchId: match.id, posizione: pos.pos });
                              }}
                              className="relative hover:opacity-100 transition-opacity cursor-pointer"
                              style={{ width: '34px', height: '43px' }}
                            >
                              <svg viewBox="0 0 40 50" className="w-full h-full opacity-40 hover:opacity-60">
                                <rect x="14" y="32" width="4" height="12" fill="#999" rx="2"/>
                                <rect x="22" y="32" width="4" height="12" fill="#999" rx="2"/>
                                <rect x="12" y="18" width="16" height="16" fill="#999" rx="3"/>
                                <rect x="8" y="20" width="4" height="10" fill="#999" rx="2"/>
                                <rect x="28" y="20" width="4" height="10" fill="#999" rx="2"/>
                                <circle cx="20" cy="12" r="6" fill="#999"/>
                                <circle cx="20" cy="25" r="8" fill="#4CAF50" opacity="0.8"/>
                                <text x="20" y="30" textAnchor="middle" fill="white" fontSize="14" fontWeight="bold">+</text>
                              </svg>
                              <div className="absolute -bottom-7 left-1/2 transform -translate-x-1/2 text-center">
                                <div className="bg-gray-400 text-white px-1 py-0.5 rounded font-semibold" style={{ fontSize: '7px' }}>
                                  {pos.pos}
                                </div>
                              </div>
                            </button>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  
                  <div className="mt-20">
                    <h3 className="text-lg font-bold text-gray-800 mb-3">Giocatori da Assegnare:</h3>
                    <div className="grid grid-cols-2 gap-3">
                      {titolari.filter(p => !Object.values(currentModulo.posizioni).includes(p.numero)).sort((a, b) => {
                        const numA = parseInt((match.ordineDistinta && match.ordineDistinta[a.numero]) || a.numero);
                        const numB = parseInt((match.ordineDistinta && match.ordineDistinta[b.numero]) || b.numero);
                        return numA - numB;
                      }).map(player => (
                        <div key={player.numero} className="border rounded-lg p-3 bg-gray-50">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold">
                              {(match.ordineDistinta && match.ordineDistinta[player.numero]) || player.numero}
                            </div>
                            <div className="flex-1">
                              <div className="font-bold text-sm">{player.nome}</div>
                              <div className="text-xs text-gray-600">{player.ruolo}</div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {Object.keys(currentModulo.posizioni).length === 11 && (
                    <div className="mt-6 p-4 bg-green-100 border border-green-400 rounded-lg text-center">
                      ‚úÖ Modulo completo! Tutti i giocatori sono stati assegnati.
                    </div>
                  )}
                </div>
              )}
              
              <div className="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 className="font-bold text-sm mb-2">üìã Legenda Posizioni:</h4>
                <div className="grid grid-cols-4 gap-2 text-xs">
                  <div><strong>P:</strong> Portiere</div>
                  <div><strong>TD:</strong> Terzino Dx</div>
                  <div><strong>TS:</strong> Terzino Sx</div>
                  <div><strong>DC:</strong> Difensore Centrale</div>
                  <div><strong>ED:</strong> Esterno Dx</div>
                  <div><strong>ES:</strong> Esterno Sx</div>
                  <div><strong>CC:</strong> Centrocampista Centrale</div>
                  <div><strong>MC:</strong> Mezzala Centrale</div>
                  <div><strong>MD:</strong> Mediano</div>
                  <div><strong>TQ:</strong> Trequartista</div>
                  <div><strong>AD:</strong> Attaccante Dx</div>
                  <div><strong>AS:</strong> Attaccante Sx</div>
                  <div><strong>PC:</strong> Punta Centrale</div>
                  <div><strong>AE:</strong> Ala Esterna</div>
                </div>
              </div>
            </div>
          </>
        );
      })()}
    </div>
  </div>
)}

{playerSelectionModal && (() => {
  const match = matches.find(m => m.id === playerSelectionModal.matchId);
  const titolari = players.filter(p => match.titolari[p.numero]);
  const matchModulo = moduloTattico[match.id] || { moduloCorrente: '4-4-2', moduli: {} };
  const moduloCorrente = matchModulo.moduloCorrente || '4-4-2';
  const posizioniModuloCorrente = (matchModulo.moduli[moduloCorrente] || {}).posizioni || {};
  
  const giocatoriDisponibili = titolari.filter(p => 
    !Object.values(posizioniModuloCorrente).includes(p.numero)
  ).sort((a, b) => {
    const numA = parseInt((match.ordineDistinta && match.ordineDistinta[a.numero]) || a.numero);
    const numB = parseInt((match.ordineDistinta && match.ordineDistinta[b.numero]) || b.numero);
    return numA - numB;
  });
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setPlayerSelectionModal(null)}>
      <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={(e) => e.stopPropagation()}>
        <div className="p-4 border-b bg-blue-600 text-white rounded-t-lg">
          <div className="flex justify-between items-center">
            <h3 className="text-xl font-bold">Seleziona Giocatore per {playerSelectionModal.posizione}</h3>
            <button onClick={() => setPlayerSelectionModal(null)} className="text-white hover:text-gray-200 text-2xl">‚úï</button>
          </div>
        </div>
        
        <div className="p-4 max-h-[60vh] overflow-y-auto">
          {giocatoriDisponibili.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              <p className="text-lg font-semibold">Nessun giocatore disponibile</p>
              <p className="text-sm mt-2">Tutti i giocatori sono gi√† assegnati</p>
            </div>
          ) : (
            <div className="space-y-2">
              {giocatoriDisponibili.map(player => (
                <button
                  key={player.numero}
                  onClick={() => {
                    const moduliAggiornati = { ...matchModulo.moduli };
                    
                    moduliAggiornati[moduloCorrente] = {
                      ...moduliAggiornati[moduloCorrente],
                      posizioni: { 
                        ...(moduliAggiornati[moduloCorrente]?.posizioni || {}), 
                        [playerSelectionModal.posizione]: player.numero 
                      }
                    };
                    
                    setModuloTattico({
                      ...moduloTattico,
                      [match.id]: {
                        moduloCorrente: moduloCorrente,
                        moduli: moduliAggiornati
                      }
                    });
                    
                    setPlayerSelectionModal(null);
                  }}
                  className="w-full flex items-center gap-4 p-3 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors border-2 border-transparent hover:border-blue-500"
                >
                  <div className="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg flex-shrink-0">
                    {(match.ordineDistinta && match.ordineDistinta[player.numero]) || player.numero}
                  </div>
                  <div className="text-left flex-1">
                    <div className="font-bold text-gray-900 text-lg">{player.nome}</div>
                    <div className="text-sm text-gray-600">{player.ruolo}</div>
                  </div>
                  <div className="text-blue-600 font-bold text-xl">‚Üí</div>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
})()}

{activeTab === 'stats' && (
            <div className="h-[calc(100vh-280px)] flex flex-col stats-container-mobile">
              <h2 className="text-2xl font-bold text-gray-800 mb-3 stats-title-mobile">Statistiche Giocatori</h2>
              
              {/* Layout TABLET/DESKTOP - Tabella */}
              <div className="hidden md:flex flex-1 overflow-auto">
                <table className="w-full text-xs border-collapse">
                  <thead className="bg-blue-100 sticky top-0">
                    <tr>
                      <th className="p-1 text-left border">N¬∞</th>
                      <th className="p-1 text-left border">Nome</th>
                      <th className="p-1 text-left border">Ruolo</th>
                      <th className="p-1 text-center border">Allenamenti Presenze</th>
                      <th className="p-1 text-center border">Allenamenti Assenze</th>
                      <th className="p-1 text-center border">% Presenze</th>
                      <th className="p-1 text-center border">Infortuni</th>
                      <th className="p-1 text-center border">Partite Convocato</th>
                      <th className="p-1 text-center border">% Convocazioni</th>
                      <th className="p-1 text-center border">Partite Titolare</th>
                      <th className="p-1 text-center border">% Titolarit√†</th>
                      <th className="p-1 text-center border">Minuti Totali</th>
                      <th className="p-1 text-center border">Gol</th>
                      <th className="p-1 text-center border">Assist</th>
                      <th className="p-1 text-center border">Gol Subiti</th>
                      <th className="p-1 text-center border">Gialli Gioco</th>
                      <th className="p-1 text-center border">Gialli Protesta</th>
                      <th className="p-1 text-center border">Rossi Gioco</th>
                      <th className="p-1 text-center border">Rossi Protesta</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white">
                    {calculateStats().map((stat, index) => {
                      const totAllenamenti = stat.allenamenti_presenze + stat.allenamenti_assenze;
                      const percPresenze = totAllenamenti > 0 ? ((stat.allenamenti_presenze / totAllenamenti) * 100).toFixed(0) : '-';
                      const totPartite = matches.length;
                      const percConvocazioni = totPartite > 0 ? ((stat.partite_convocato / totPartite) * 100).toFixed(0) : '-';
                      const percTitolarita = totPartite > 0 ? ((stat.partite_titolare / totPartite) * 100).toFixed(0) : '-';
                      
                      return (
                        <tr key={stat.nome} className="border-b hover:bg-gray-50">
                          <td className="p-1 font-bold border">{index + 1}</td>
                          <td className="p-1 text-xs border">{stat.nome}</td>
                          <td className="p-1 text-xs border">{stat.ruolo}</td>
                          <td className="p-1 text-center border">{stat.allenamenti_presenze}</td>
                          <td className="p-1 text-center border">{stat.allenamenti_assenze}</td>
                          <td className="p-1 text-center border font-semibold text-blue-600">{percPresenze}{percPresenze !== '-' ? '%' : ''}</td>
                          <td className="p-1 text-center text-red-600 border">{stat.infortuni}</td>
                          <td className="p-1 text-center border">{stat.partite_convocato}</td>
                          <td className="p-1 text-center border font-semibold text-blue-600">{percConvocazioni}{percConvocazioni !== '-' ? '%' : ''}</td>
                          <td className="p-1 text-center border">{stat.partite_titolare}</td>
                          <td className="p-1 text-center border font-semibold text-purple-600">{percTitolarita}{percTitolarita !== '-' ? '%' : ''}</td>
                          <td className="p-1 text-center font-semibold border">{stat.minuti_totali}</td>
                          <td className="p-1 text-center text-green-600 font-bold border">{stat.gol}</td>
                          <td className="p-1 text-center text-blue-600 border">{stat.assist}</td>
                          <td className="p-1 text-center text-red-600 border">{stat.gol_subiti || '-'}</td>
                          <td className="p-1 text-center text-orange-400 border">{stat.gialli_gioco}</td>
                          <td className="p-1 text-center text-red-600 border">{stat.gialli_protesta}</td>
                          <td className="p-1 text-center text-orange-400 border">{stat.rossi_gioco}</td>
                          <td className="p-1 text-center text-red-600 border">{stat.rossi_protesta}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              
              {/* Layout MOBILE - Card */}
              <div className="flex md:hidden flex-1 overflow-auto">
                <div className="w-full space-y-3 pb-4">
                  {calculateStats().map((stat, index) => {
                    const totAllenamenti = stat.allenamenti_presenze + stat.allenamenti_assenze;
                    const percPresenze = totAllenamenti > 0 ? ((stat.allenamenti_presenze / totAllenamenti) * 100).toFixed(0) : '-';
                    const totPartite = matches.length;
                    const percConvocazioni = totPartite > 0 ? ((stat.partite_convocato / totPartite) * 100).toFixed(0) : '-';
                    const percTitolarita = totPartite > 0 ? ((stat.partite_titolare / totPartite) * 100).toFixed(0) : '-';
                    
                    return (
                      <div key={stat.nome} className="bg-white rounded-lg shadow-md border-2 border-gray-200 p-4">
                        {/* Header Card */}
                        <div className="flex items-center gap-3 mb-3 pb-3 border-b-2 border-gray-200">
                          <div className="text-2xl font-bold text-gray-700">#{index + 1}</div>
                          <div className="flex-1">
                            <div className="font-bold text-gray-800">{stat.nome}</div>
                            <div className="text-xs text-gray-600">{stat.ruolo}</div>
                          </div>
                        </div>
                        
                        {/* Allenamenti */}
                        <div className="mb-3">
                          <div className="text-xs font-bold text-gray-700 mb-1">üèãÔ∏è ALLENAMENTI</div>
                          <div className="grid grid-cols-3 gap-2 text-xs">
                            <div className="text-center">
                              <div className="text-gray-600">Presenze</div>
                              <div className="font-bold text-green-600">{stat.allenamenti_presenze}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Assenze</div>
                              <div className="font-bold text-red-600">{stat.allenamenti_assenze}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">% Pres.</div>
                              <div className="font-bold text-blue-600">{percPresenze}{percPresenze !== '-' ? '%' : ''}</div>
                            </div>
                          </div>
                          <div className="text-center mt-2">
                            <span className="text-gray-600 text-xs">Infortuni: </span>
                            <span className="font-bold text-red-600">{stat.infortuni}</span>
                          </div>
                        </div>
                        
                        {/* Partite */}
                        <div className="mb-3">
                          <div className="text-xs font-bold text-gray-700 mb-1">‚öΩ PARTITE</div>
                          <div className="grid grid-cols-3 gap-2 text-xs">
                            <div className="text-center">
                              <div className="text-gray-600">Convocato</div>
                              <div className="font-bold">{stat.partite_convocato}</div>
                              <div className="text-blue-600 font-semibold text-[10px]">{percConvocazioni}{percConvocazioni !== '-' ? '%' : ''}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Titolare</div>
                              <div className="font-bold">{stat.partite_titolare}</div>
                              <div className="text-purple-600 font-semibold text-[10px]">{percTitolarita}{percTitolarita !== '-' ? '%' : ''}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Minuti</div>
                              <div className="font-bold text-blue-700">{stat.minuti_totali}</div>
                            </div>
                          </div>
                        </div>
                        
                        {/* Statistiche Gioco */}
                        <div className="mb-3">
                          <div className="text-xs font-bold text-gray-700 mb-1">üìä STATISTICHE</div>
                          <div className="grid grid-cols-3 gap-2 text-xs">
                            <div className="text-center">
                              <div className="text-gray-600">Gol</div>
                              <div className="font-bold text-green-600 text-lg">{stat.gol}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Assist</div>
                              <div className="font-bold text-blue-600 text-lg">{stat.assist}</div>
                            </div>
                            <div className="text-center">
                              <div className="text-gray-600">Gol Sub.</div>
                              <div className="font-bold text-red-600 text-lg">{stat.gol_subiti || '-'}</div>
                            </div>
                          </div>
                        </div>
                        
                        {/* Cartellini */}
                        {(stat.gialli_gioco > 0 || stat.gialli_protesta > 0 || stat.rossi_gioco > 0 || stat.rossi_protesta > 0) && (
                          <div>
                            <div className="text-xs font-bold text-gray-700 mb-1">üü®üü• CARTELLINI</div>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center justify-between bg-yellow-50 p-2 rounded">
                                <span className="text-gray-700">üü® Gioco:</span>
                                <span className="font-bold text-orange-600">{stat.gialli_gioco}</span>
                              </div>
                              <div className="flex items-center justify-between bg-red-50 p-2 rounded">
                                <span className="text-gray-700">üü® Protesta:</span>
                                <span className="font-bold text-red-600">{stat.gialli_protesta}</span>
                              </div>
                              <div className="flex items-center justify-between bg-orange-50 p-2 rounded">
                                <span className="text-gray-700">üü• Gioco:</span>
                                <span className="font-bold text-orange-600">{stat.rossi_gioco}</span>
                              </div>
                              <div className="flex items-center justify-between bg-red-100 p-2 rounded">
                                <span className="text-gray-700">üü• Protesta:</span>
                                <span className="font-bold text-red-700">{stat.rossi_protesta}</span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}

{activeTab === 'top' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">üèÜ Giocatori TOP</h2>
              <p className="text-gray-600 mb-4">I migliori 3 giocatori per ogni categoria</p>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border-2 border-blue-300">
                  <h3 className="text-lg font-bold text-blue-800 mb-3">üéØ Top Presenze Allenamenti</h3>
                  <div className="space-y-2">
                    {calculateStats().sort((a, b) => b.allenamenti_presenze - a.allenamenti_presenze).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-blue-600">{p.allenamenti_presenze}</div>
                          <div className="text-xs text-gray-500">presenze</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border-2 border-green-300">
                  <h3 className="text-lg font-bold text-green-800 mb-3">‚öΩ Top Gol</h3>
                  <div className="space-y-2">
                    {calculateStats().filter(p => p.gol > 0).sort((a, b) => b.gol - a.gol).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-green-600">{p.gol}</div>
                          <div className="text-xs text-gray-500">gol</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => p.gol > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun gol segnato</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border-2 border-purple-300">
                  <h3 className="text-lg font-bold text-purple-800 mb-3">üéØ Top Assist</h3>
                  <div className="space-y-2">
                    {calculateStats().filter(p => p.assist > 0).sort((a, b) => b.assist - a.assist).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-purple-600">{p.assist}</div>
                          <div className="text-xs text-gray-500">assist</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => p.assist > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun assist</div>
                    )}
                  </div>
                </div>

                {/* ========== TOP MVP ========== */}
                <div className="bg-gradient-to-br from-amber-50 to-yellow-100 rounded-lg p-4 border-2 border-amber-300">
                  <h3 className="text-lg font-bold text-amber-800 mb-3">üèÜ Top MVP</h3>
                  <div className="space-y-2">
                    {(() => {
                      const leaderboard = getMVPLeaderboard().slice(0, 3);
                      
                      if (leaderboard.length === 0) {
                        return (
                          <div className="text-center text-gray-500 py-4">Nessun MVP assegnato</div>
                        );
                      }
                      
                      return leaderboard.map((entry, i) => (
                        <div key={entry.playerNum} className="bg-white rounded-lg p-3 flex items-center gap-3">
                          <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                            {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}
                          </div>
                          <div className="flex-1">
                            <div className="font-semibold">{entry.playerName}</div>
                            <div className="text-xs text-gray-600">#{entry.playerNum}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-2xl font-bold text-amber-600">{entry.mvpCount}</div>
                            <div className="text-xs text-gray-500">MVP</div>
                          </div>
                        </div>
                      ));
                    })()}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border-2 border-yellow-300">
                  <h3 className="text-lg font-bold text-yellow-800 mb-3">üü® Top Cartellini Gialli</h3>
                  <div className="space-y-2">
                    {calculateStats().map(p => ({...p, totGialli: p.gialli_gioco + p.gialli_protesta})).filter(p => p.totGialli > 0).sort((a, b) => b.totGialli - a.totGialli).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-yellow-600">{p.totGialli}</div>
                          <div className="text-xs text-gray-500">gialli</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => (p.gialli_gioco + p.gialli_protesta) > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun cartellino giallo</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border-2 border-red-300">
                  <h3 className="text-lg font-bold text-red-800 mb-3">üü• Top Cartellini Rossi</h3>
                  <div className="space-y-2">
                    {calculateStats().map(p => ({...p, totRossi: p.rossi_gioco + p.rossi_protesta})).filter(p => p.totRossi > 0).sort((a, b) => b.totRossi - a.totRossi).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-red-600">{p.totRossi}</div>
                          <div className="text-xs text-gray-500">rossi</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => (p.rossi_gioco + p.rossi_protesta) > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun cartellino rosso</div>
                    )}
                  </div>
                </div>

                <div className="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 border-2 border-indigo-300">
                  <h3 className="text-lg font-bold text-indigo-800 mb-3">‚è±Ô∏è Top Minuti Giocati</h3>
                  <div className="space-y-2">
                    {calculateStats().filter(p => p.minuti_totali > 0).sort((a, b) => b.minuti_totali - a.minuti_totali).slice(0, 3).map((p, i) => (
                      <div key={p.nome} className="bg-white rounded-lg p-3 flex items-center gap-3">
                        <div className={`text-2xl ${i === 0 ? 'text-yellow-500' : i === 1 ? 'text-gray-400' : 'text-orange-600'}`}>
                          {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{p.nome}</div>
                          <div className="text-xs text-gray-600">#{getNumeroAlfabetico(p.nome)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-indigo-600">{p.minuti_totali}</div>
                          <div className="text-xs text-gray-500">minuti</div>
                        </div>
                      </div>
                    ))}
                    {calculateStats().filter(p => p.minuti_totali > 0).length === 0 && (
                      <div className="text-center text-gray-500 py-4">Nessun minuto giocato</div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}

{activeTab === 'roster' && (
            <div>
              <div className="flex flex-wrap justify-between items-center gap-3 mb-4">
                <h2 className="text-2xl font-bold text-gray-800">Gestione Rosa</h2>
                <div className="flex flex-wrap gap-2">
                  {userRole === 'admin' && (
                    <button
                      onClick={migratePhotosToStorage}
                      className="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-semibold hover:from-green-700 hover:to-green-800 transition-all shadow-md hover:shadow-lg flex items-center gap-2"
                      title="Migra foto da base64 a Firebase Storage (risolve limite 1MB)"
                    >
                      <span>üöÄ</span>
                      <span className="hidden sm:inline">Migra su Cloud</span>
                      <span className="sm:hidden">Migra</span>
                    </button>
                  )}
                  <button
                    onClick={exportRosaPDF}
                    className="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-md hover:shadow-lg flex items-center gap-2"
                  >
                    <span>üìã</span>
                    <span className="hidden sm:inline">Stampa Rosa</span>
                    <span className="sm:hidden">Stampa</span>
                  </button>
                </div>
              </div>
              <div className="space-y-4">
                {players
                  .slice()
                  .sort((a, b) => {
                    if (!a.nome && !b.nome) return a.numero - b.numero;
                    if (!a.nome) return 1;
                    if (!b.nome) return -1;
                    return a.nome.localeCompare(b.nome);
                  })
                  .map((player, index) => (
                  <div key={player.numero} className={`bg-white border rounded-lg p-4 card-hover animate-fade-in roster-player-card ${player.fuoriRosa ? 'opacity-50 border-red-300 bg-red-50' : ''}`} style={{animationDelay: `${index * 0.05}s`}}>
                    <div className="flex gap-4">
                      <div className="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0 relative roster-player-photo">
                        {player.foto ? (
                          <img 
                            src={player.foto} 
                            alt={player.nome} 
                            className="w-full h-full object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity" 
                            onClick={() => setEnlargedPhoto({ foto: player.foto, nome: player.nome })}
                            title="Clicca per ingrandire"
                          />
                        ) : (
                          <div className="text-gray-400 text-center">
                            <div className="text-3xl font-bold">{player.nome ? index + 1 : player.numero}</div>
                          </div>
                        )}
                        {editingPlayer === player.numero && (
                          <label className="absolute bottom-0 right-0 bg-blue-600 text-white p-1 rounded-tl rounded-br cursor-pointer hover:bg-blue-700">
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageUpload(player.numero, e)}
                              className="hidden"
                            />
                            <span className="text-xs">üì∑</span>
                          </label>
                        )}
                      </div>
                      <div className="flex-1">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 roster-player-info">
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Numero</label>
                            <div className="text-xl font-bold text-blue-600 roster-player-number">{player.nome ? index + 1 : player.numero}</div>
                          </div>
                          <div className="md:col-span-2">
                            <label className="text-xs font-semibold text-gray-600">Nome Completo</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="text"
                                value={player.nome}
                                onChange={(e) => updatePlayer(player.numero, 'nome', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                                placeholder="Nome e Cognome"
                              />
                            ) : (
                              <div className="flex items-center gap-2">
                                <div className={player.nome ? 'font-semibold' : 'text-gray-400 italic'}>{player.nome || 'Slot libero'}</div>
                                {player.nome && (
                                  <>
                                    {getPlayerInjury(player.numero) ? (
                                      <span className="injury-badge active" title="Infortunato">ü§ï</span>
                                    ) : (
                                      <span className="injury-badge recovered" title="Disponibile">‚úÖ</span>
                                    )}
                                  </>
                                )}
                              </div>
                            )}
                          </div>
                          
                          {/* Quick Stats - Solo se giocatore attivo */}
                          {player.nome && editingPlayer !== player.numero && (
                            <div className="md:col-span-3 mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                              <div className="grid grid-cols-5 gap-4 text-center roster-quick-stats">
                                <div>
                                  <div className="text-2xl font-bold text-blue-600">
                                    {matches.reduce((sum, m) => sum + (parseInt(m.golFatti?.[player.numero]) || 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Gol</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-green-600">
                                    {matches.reduce((sum, m) => sum + (parseInt(m.assist?.[player.numero]) || 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Assist</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-purple-600">
                                    {trainings.reduce((sum, t) => sum + (t.presenze[player.numero] ? 1 : 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Allenamenti</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-orange-600">
                                    {matches.reduce((sum, m) => sum + (m.convocati?.[player.numero] ? 1 : 0), 0)}
                                  </div>
                                  <div className="text-xs text-gray-600">Convocazioni</div>
                                </div>
                                <div>
                                  <div className="text-2xl font-bold text-yellow-600">
                                    {getPlayerMVPCount(player.numero)}
                                  </div>
                                  <div className="text-xs text-gray-600">MVP üèÜ</div>
                                </div>
                              </div>
                            </div>
                          )}
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Ruolo</label>
                            {editingPlayer === player.numero ? (
                              <select
                                value={player.ruolo}
                                onChange={(e) => updatePlayer(player.numero, 'ruolo', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              >
                                <option value="">Seleziona...</option>
                                <option value="Portiere">Portiere</option>
                                <option value="Difensore centrale">Difensore centrale</option>
                                <option value="Terzino dx">Terzino dx</option>
                                <option value="Terzino sx">Terzino sx</option>
                                <option value="Mediano">Mediano</option>
                                <option value="Centrocampista centrale">Centrocampista centrale</option>
                                <option value="Esterno alto dx">Esterno alto dx</option>
                                <option value="Esterno alto sx">Esterno alto sx</option>
                                <option value="Trequartista">Trequartista</option>
                                <option value="Attaccante">Attaccante</option>
                              </select>
                            ) : (
                              <div className={player.ruolo ? '' : 'text-gray-400 italic'}>{player.ruolo || '-'}</div>
                            )}
                          </div>
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Data di Nascita</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="date"
                                value={player.dataNascita}
                                onChange={(e) => updatePlayer(player.numero, 'dataNascita', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            ) : (
                              <div className={player.dataNascita ? '' : 'text-gray-400 italic'}>
                                {player.dataNascita ? `${player.dataNascita} (${calculateAge(player.dataNascita)} anni)` : '-'}
                              </div>
                            )}
                          </div>
                          <div>
                            <label className="text-xs font-semibold text-gray-600">Piede Preferito</label>
                            {editingPlayer === player.numero ? (
                              <select
                                value={player.piede}
                                onChange={(e) => updatePlayer(player.numero, 'piede', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              >
                                <option value="">Seleziona...</option>
                                <option value="Destro">Destro</option>
                                <option value="Sinistro">Sinistro</option>
                                <option value="Ambidestro">Ambidestro</option>
                              </select>
                            ) : (
                              <div className={player.piede ? '' : 'text-gray-400 italic'}>{player.piede || '-'}</div>
                            )}
                          </div>
                          <div className="md:col-span-2 lg:col-span-3">
                            <label className="text-xs font-semibold text-gray-600">Telefono</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="tel"
                                value={player.telefono}
                                onChange={(e) => updatePlayer(player.numero, 'telefono', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                                placeholder="Numero di telefono"
                              />
                            ) : (
                              <div className={player.telefono ? '' : 'text-gray-400 italic'}>{player.telefono || '-'}</div>
                            )}
                          </div>
                          <div className="md:col-span-2 lg:col-span-3">
                            <label className="text-xs font-semibold text-gray-600">üìÖ Data Creazione in Rosa</label>
                            {editingPlayer === player.numero ? (
                              <input
                                type="date"
                                value={player.dataCreazione}
                                onChange={(e) => updatePlayer(player.numero, 'dataCreazione', e.target.value)}
                                className="w-full px-2 py-1 border rounded"
                              />
                            ) : (
                              <div className={player.dataCreazione ? 'text-sm' : 'text-gray-400 italic'}>
                                {player.dataCreazione ? `Dal ${new Date(player.dataCreazione).toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' })}` : 'Non impostata'}
                              </div>
                            )}
                            <div className="text-xs text-gray-500 mt-1">Il giocatore apparir√† solo negli allenamenti e partite dalla data indicata</div>
                          </div>
                          <div className="md:col-span-2 lg:col-span-3">
                            <label className="text-xs font-semibold text-gray-600">‚õî Stato Giocatore</label>
                            {editingPlayer === player.numero ? (
                              <div className="flex items-center gap-3 mt-1">
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={player.fuoriRosa || false}
                                    onChange={(e) => updatePlayer(player.numero, 'fuoriRosa', e.target.checked)}
                                    className="w-4 h-4"
                                  />
                                  <span className="text-sm">Fuori Rosa</span>
                                </label>
                              </div>
                            ) : (
                              <div className="mt-1">
                                {player.fuoriRosa ? (
                                  <span className="inline-block px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold border-2 border-red-300">
                                    ‚õî FUORI ROSA
                                  </span>
                                ) : (
                                  <span className="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold border-2 border-green-300">
                                    ‚úÖ IN ROSA
                                  </span>
                                )}
                              </div>
                            )}
                            <div className="text-xs text-gray-500 mt-1">I giocatori fuori rosa non appaiono negli elenchi operativi</div>
                          </div>
                        </div>
                      </div>
                      <div className="flex flex-col gap-2">
                        {editingPlayer === player.numero ? (
                          <>
                            <button 
                              onClick={() => {
                                setEditingPlayer(null);
                                showToast(`‚úÖ Giocatore ${player.nome || '#' + player.numero} salvato!`, 'success');
                              }} 
                              className="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 flex items-center gap-1"
                            >
                              <Save size={14} /> Salva
                            </button>
                            <button onClick={() => clearPlayer(player.numero)} className="px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                              Cancella
                            </button>
                          </>
                        ) : (
                          <>
                            <button 
                              onClick={() => setEditingPlayer(player.numero)} 
                              disabled={userRole !== 'admin'}
                              className={`px-3 py-2 rounded text-sm ${
                                userRole === 'admin'
                                  ? 'bg-blue-600 text-white hover:bg-blue-700'
                                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                              }`}
                              title={userRole !== 'admin' ? 'Solo Admin pu√≤ modificare' : ''}
                            >
                              Modifica
                            </button>
                            {player.nome && (
                              <button 
                                onClick={() => downloadPlayerCardPDF(player.numero)} 
                                className="px-3 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 flex items-center justify-center gap-1"
                                title="Genera Report PDF"
                              >
                                üìÑ Report
                              </button>
                            )}
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* ========== SEZIONE ANALISI TATTICA ========== */}
          {activeTab === 'tattica' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">üéØ Analisi Tattica Avversari</h2>
              
              <div className="mb-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg">
                <div className="flex items-start gap-3">
                  <div className="text-purple-600 text-3xl">‚öΩ</div>
                  <div>
                    <p className="font-semibold text-purple-900 mb-2">Analisi Tattica Intelligente</p>
                    <p className="text-sm text-purple-800">
                      Seleziona il modulo di gioco degli avversari e ricevi suggerimenti tattici personalizzati 
                      su quale modulo utilizzare per contrastarli efficacemente, con strategie dettagliate e punti chiave.
                    </p>
                  </div>
                </div>
              </div>

              <div className="mb-8">
                <label className="block text-lg font-bold text-gray-800 mb-3">
                  Seleziona il Modulo degli Avversari
                </label>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {moduliDisponibili.map(modulo => (
                    <button
                      key={modulo.nome}
                      onClick={() => setModuloAvversario(modulo.nome)}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        moduloAvversario === modulo.nome
                          ? 'bg-purple-600 text-white border-purple-600 shadow-lg transform scale-105'
                          : 'bg-white text-gray-800 border-gray-300 hover:border-purple-400 hover:shadow'
                      }`}
                    >
                      <div className="text-2xl font-bold mb-1">{modulo.nome}</div>
                      <div className="text-xs opacity-80">{modulo.descrizione}</div>
                    </button>
                  ))}
                </div>
              </div>

              {moduloAvversario && (() => {
                const analisi = analizzaModuloAvversario(moduloAvversario);
                if (!analisi) return null;

                return (
                  <div className="space-y-6">
                    {/* Punti deboli dell'avversario */}
                    <div className="bg-red-50 border-2 border-red-300 rounded-lg p-6">
                      <h3 className="text-xl font-bold text-red-900 mb-4 flex items-center gap-2">
                        <span className="text-2xl">‚ö†Ô∏è</span>
                        Punti Deboli del {moduloAvversario}
                      </h3>
                      <ul className="space-y-2">
                        {analisi.puntiDeboli.map((punto, idx) => (
                          <li key={idx} className="flex items-start gap-2">
                            <span className="text-red-600 font-bold mt-1">‚Ä¢</span>
                            <span className="text-red-900">{punto}</span>
                          </li>
                        ))}
                      </ul>
                    </div>

                    {/* Moduli consigliati */}
                    <div>
                      <h3 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span className="text-3xl">üí°</span>
                        Moduli Consigliati per Contrastarli
                      </h3>
                      
                      <div className="space-y-6">
                        {analisi.moduliConsigliati.map((consiglio, idx) => (
                          <div 
                            key={idx}
                            className="bg-white border-2 rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-shadow"
                            style={{
                              borderColor: idx === 0 ? '#10b981' : idx === 1 ? '#3b82f6' : '#8b5cf6'
                            }}
                          >
                            {/* Header con efficacia */}
                            <div 
                              className="p-4 text-white"
                              style={{
                                backgroundColor: idx === 0 ? '#10b981' : idx === 1 ? '#3b82f6' : '#8b5cf6'
                              }}
                            >
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                  <span className="text-3xl">
                                    {idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â'}
                                  </span>
                                  <div>
                                    <div className="text-2xl font-bold">{consiglio.modulo}</div>
                                    <div className="text-sm opacity-90">
                                      {idx === 0 ? 'Scelta Ottimale' : idx === 1 ? 'Alternativa Valida' : 'Opzione Tattica'}
                                    </div>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className="text-3xl font-bold">{consiglio.efficacia}%</div>
                                  <div className="text-xs opacity-90">Efficacia</div>
                                </div>
                              </div>
                            </div>

                            {/* Contenuto */}
                            <div className="p-6">
                              {/* Motivo principale */}
                              <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <div className="font-semibold text-blue-900 mb-1">üìã Perch√© funziona:</div>
                                <div className="text-blue-800">{consiglio.motivo}</div>
                              </div>

                              {/* Vantaggi */}
                              <div className="mb-4">
                                <div className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                  <span className="text-green-600">‚úì</span>
                                  Vantaggi Chiave:
                                </div>
                                <div className="grid md:grid-cols-2 gap-2">
                                  {consiglio.vantaggi.map((vantaggio, vIdx) => (
                                    <div key={vIdx} className="flex items-start gap-2 bg-green-50 p-2 rounded border border-green-200">
                                      <span className="text-green-600 font-bold">‚úì</span>
                                      <span className="text-green-900 text-sm">{vantaggio}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {/* Tattiche specifiche */}
                              <div>
                                <div className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                                  <span className="text-purple-600">‚ö°</span>
                                  Indicazioni Tattiche:
                                </div>
                                <div className="space-y-2">
                                  {consiglio.tattiche.map((tattica, tIdx) => (
                                    <div key={tIdx} className="flex items-start gap-2 bg-purple-50 p-3 rounded border border-purple-200">
                                      <span className="text-purple-600 font-bold text-lg">{tIdx + 1}.</span>
                                      <span className="text-purple-900">{tattica}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {consiglio.ruoliChiave && consiglio.ruoliChiave.length > 0 && (
                                <div className="mt-6">
                                  <div className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <span className="text-orange-600 text-xl">üë§</span>
                                    Ruoli Chiave - Giocatori Indispensabili:
                                  </div>
                                  <div className="space-y-3">
                                    {consiglio.ruoliChiave.map((ruolo, rIdx) => (
                                      <div key={rIdx} className="bg-gradient-to-r from-orange-50 to-yellow-50 p-4 rounded-lg border-2 border-orange-300">
                                        <div className="flex items-start gap-3 mb-2">
                                          <div className="flex-shrink-0 w-7 h-7 rounded-full bg-orange-600 text-white flex items-center justify-center font-bold text-sm">
                                            {rIdx + 1}
                                          </div>
                                          <div className="flex-1">
                                            <div className="font-bold text-base text-orange-900">{ruolo.ruolo}</div>
                                            <div className="text-xs text-orange-700 font-semibold mt-1">
                                              {ruolo.importanza}
                                            </div>
                                          </div>
                                        </div>
                                        <div className="ml-10">
                                          <div className="text-xs font-semibold text-gray-700 mb-1">Caratteristiche:</div>
                                          <div className="space-y-1">
                                            {ruolo.caratteristiche.map((car, cIdx) => (
                                              <div key={cIdx} className="flex items-start gap-2 text-xs">
                                                <span className="text-orange-600 font-bold">‚Ä¢</span>
                                                <span className="text-gray-800">{car}</span>
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                  <div className="mt-3 p-2 bg-orange-100 rounded border border-orange-300">
                                    <div className="text-xs text-orange-900">
                                      <span className="font-bold">Nota:</span> Per rendere al massimo con questo modulo, assicurati di avere giocatori forti in questi ruoli specifici.
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Rappresentazione tattica su campo */}
                              <div className="mt-6 pt-6 border-t-2 border-gray-200">
                                <div className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                  <span className="text-green-600 text-xl">‚öΩ</span>
                                  Rappresentazione Tattica:
                                </div>
                                <CampoTattico 
                                  moduloNostro={consiglio.modulo} 
                                  moduloAvversario={moduloAvversario}
                                  evidenziaContrasto={true}
                                />
                                <div className="mt-3 p-3 bg-green-50 rounded border border-green-200">
                                  <div className="text-sm text-green-900">
                                    <span className="font-bold">üí° Come leggere il campo:</span> I giocatori in rosso rappresentano gli avversari, 
                                    quelli in blu la tua squadra. Osserva come il tuo modulo {consiglio.modulo} crea superiorit√† numerica 
                                    nelle zone chiave rispetto al loro {moduloAvversario}.
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Nota finale */}
                    <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">üí°</span>
                        <div className="text-sm text-yellow-900">
                          <span className="font-bold">Nota Tattica:</span> Questi suggerimenti sono basati su principi tattici consolidati. 
                          Ricorda di adattare la strategia alle caratteristiche specifiche dei tuoi giocatori e alle condizioni della partita. 
                          La migliore tattica √® quella che i tuoi giocatori sanno eseguire al meglio!
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}

              {!moduloAvversario && (
                <div className="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                  <div className="text-6xl mb-4">üéØ</div>
                  <div className="text-xl font-semibold text-gray-600 mb-2">
                    Seleziona un modulo per iniziare l'analisi
                  </div>
                  <div className="text-gray-500">
                    Scegli il modulo tattico degli avversari per ricevere suggerimenti personalizzati
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ========== SEZIONE DIVISIONE SQUADRE ========== */}
          {activeTab === 'divisione' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">‚öñÔ∏è Divisione Squadre Equilibrate</h2>
              
              <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="flex items-start gap-3">
                  <div className="text-blue-600 text-2xl">‚ÑπÔ∏è</div>
                  <div>
                    <p className="font-semibold text-blue-900 mb-1">Come funziona</p>
                    <p className="text-sm text-blue-800">
                      Il sistema divide automaticamente i giocatori disponibili in squadre equilibrate per ruolo.
                      Ogni squadra avr√† un numero simile di portieri, difensori, centrocampisti e attaccanti.
                    </p>
                  </div>
                </div>
              </div>

              {/* ========== IMPORTA PRESENTI DA ALLENAMENTO ========== */}
              <div className="mb-6 bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-300 rounded-lg p-6">
                <div className="flex items-start gap-3 mb-4">
                  <div className="text-green-600 text-3xl">üìã</div>
                  <div>
                    <h3 className="font-bold text-green-900 text-lg mb-1">Importa Presenti da Allenamento</h3>
                    <p className="text-sm text-green-800">
                      Seleziona un allenamento per caricare automaticamente solo i giocatori presenti
                    </p>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Seleziona Allenamento
                    </label>
                    <select
                      value={selectedTrainingForDivision}
                      onChange={(e) => {
                        console.log('üîç Dropdown onChange:', e.target.value);
                        setSelectedTrainingForDivision(e.target.value);
                        console.log('‚úÖ selectedTrainingForDivision settato a:', e.target.value);
                      }}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-white"
                    >
                      <option value="">-- Seleziona un allenamento --</option>
                      {trainings
                        .filter(t => Object.values(t.presenze).some(p => p === true))
                        .sort((a, b) => new Date(b.data) - new Date(a.data))
                        .map(training => {
                          const presentiCount = Object.entries(training.presenze)
                            .filter(([numero, presente]) => {
                              if (presente !== true) return false;
                              const player = players.find(p => p.numero === parseInt(numero));
                              if (!player || !player.nome) return false;
                              if (player.fuoriRosa) return false;
                              if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                              return true;
                            })
                            .length;
                          return (
                            <option key={training.id} value={training.id}>
                              {new Date(training.data).toLocaleDateString('it-IT')} - {presentiCount} presenti
                            </option>
                          );
                        })}
                    </select>
                  </div>

                  <div className="flex items-end gap-2">
                    <button
                      onClick={() => {
                        console.log('üîò BOTTONE CLICCATO!');
                        console.log('   selectedTrainingForDivision:', selectedTrainingForDivision);
                        console.log('   userRole:', userRole);
                        
                        if (!selectedTrainingForDivision) {
                          alert('‚ö†Ô∏è Seleziona prima un allenamento');
                          return;
                        }
                        
                        // Converti in numero per il confronto
                        const trainingId = parseInt(selectedTrainingForDivision);
                        console.log('   üîç Cerco training con ID:', trainingId);
                        
                        const training = trainings.find(t => t.id === trainingId);
                        console.log('   üîç Training trovato?', training ? 'S√å' : 'NO');
                        
                        if (!training) {
                          alert('‚ùå Allenamento non trovato!');
                          return;
                        }
                        
                        // Le presenze sono salvate per NUMERO, non per nome
                        // training.presenze = { 1: true, 2: false, 3: true, ... }
                        const numeriPresenti = Object.entries(training.presenze)
                          .filter(([_, presente]) => presente === true)
                          .map(([numero, _]) => parseInt(numero));
                        
                        console.log('Numeri presenti nell\'allenamento:', numeriPresenti);
                        
                        // Seleziona solo giocatori con numero presente E non fuori rosa
                        const nuoviSelezionati = new Set();
                        players.forEach(player => {
                          if (player.nome && !player.fuoriRosa && numeriPresenti.includes(player.numero)) {
                            nuoviSelezionati.add(player.nome);
                          }
                        });
                        
                        console.log('Giocatori da selezionare:', Array.from(nuoviSelezionati));
                        console.log('Totale selezionati:', nuoviSelezionati.size);
                        console.log('Set dopo setGiocatoriSelezionati:', nuoviSelezionati);
                        
                        setGiocatoriSelezionati(nuoviSelezionati);
                        
                        // Toast feedback
                        showToast(`‚úÖ Caricati ${nuoviSelezionati.size} giocatori presenti!`, 'success');
                      }}
                      disabled={!selectedTrainingForDivision || userRole !== 'admin'}
                      className={`flex-1 px-6 py-3 rounded-lg font-bold transition-colors ${
                        selectedTrainingForDivision && userRole === 'admin'
                          ? 'bg-green-600 text-white hover:bg-green-700'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      ‚¨áÔ∏è Carica Presenti
                    </button>
                    
                    <button
                      onClick={() => {
                        setGiocatoriSelezionati(new Set());
                        console.log('Reset selezione: tutti i giocatori saranno inclusi');
                        showToast('‚úÖ Selezione resettata: tutti i giocatori inclusi!', 'success');
                      }}
                      disabled={userRole !== 'admin'}
                      className={`px-6 py-3 rounded-lg font-bold transition-colors whitespace-nowrap ${
                        userRole === 'admin'
                          ? 'bg-blue-600 text-white hover:bg-blue-700'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      üîÑ Reset
                    </button>
                  </div>
                </div>

                {selectedTrainingForDivision && (() => {
                  const training = trainings.find(t => t.id === selectedTrainingForDivision);
                  if (!training) return null;
                  
                  const presentiCount = Object.entries(training.presenze)
                    .filter(([numero, presente]) => {
                      if (presente !== true) return false;
                      const player = players.find(p => p.numero === parseInt(numero));
                      if (!player || !player.nome) return false;
                      if (player.fuoriRosa) return false;
                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                      return true;
                    })
                    .length;
                  const assentiCount = Object.entries(training.presenze)
                    .filter(([numero, presente]) => {
                      if (presente !== false) return false;
                      const player = players.find(p => p.numero === parseInt(numero));
                      if (!player || !player.nome) return false;
                      if (player.fuoriRosa) return false;
                      if (player.dataCreazione && new Date(player.dataCreazione) > new Date(training.data)) return false;
                      return true;
                    })
                    .length;
                  
                  return (
                    <div className="mt-4 p-3 bg-white border-2 border-green-200 rounded-lg">
                      <div className="text-sm text-gray-700">
                        <strong>Allenamento del {new Date(training.data).toLocaleDateString('it-IT')}:</strong>
                        <span className="ml-2">‚úÖ {presentiCount} presenti</span>
                        <span className="ml-2">‚ùå {assentiCount} assenti</span>
                      </div>
                    </div>
                  );
                })()}
              </div>

              <div className="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Numero di squadre
                  </label>
                  <select 
                    value={numSquadre}
                    onChange={(e) => setNumSquadre(Number(e.target.value))}
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value={2}>2 squadre</option>
                    <option value={3}>3 squadre</option>
                    <option value={4}>4 squadre</option>
                    <option value={5}>5 squadre</option>
                    <option value={6}>6 squadre</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Portieri
                  </label>
                  <div className="flex items-center space-x-4 p-3 border border-gray-300 rounded-lg">
                    <label className="flex items-center cursor-pointer">
                      <input
                        type="radio"
                        checked={includiPortieri}
                        onChange={() => setIncludiPortieri(true)}
                        className="mr-2 h-4 w-4"
                      />
                      <span>Includi portieri</span>
                    </label>
                    <label className="flex items-center cursor-pointer">
                      <input
                        type="radio"
                        checked={!includiPortieri}
                        onChange={() => setIncludiPortieri(false)}
                        className="mr-2 h-4 w-4"
                      />
                      <span>Escludi portieri</span>
                    </label>
                  </div>
                </div>
              </div>

              {/* ========== LISTA VISIVA CONTROLLO SELEZIONE ========== */}
              <div className="mb-6 bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-4">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-bold text-gray-800 text-lg">
                    üë• Controllo Selezione Giocatori
                  </h3>
                  <div className="flex gap-4 text-sm">
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 bg-green-400 rounded-full"></span>
                      <span className="font-medium">Selezionati: {giocatoriSelezionati.size || players.filter(p => p.nome && !p.fuoriRosa).length}</span>
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 bg-gray-400 rounded-full"></span>
                      <span className="font-medium">Esclusi: {players.filter(p => p.nome && !p.fuoriRosa).length - (giocatoriSelezionati.size || players.filter(p => p.nome && !p.fuoriRosa).length)}</span>
                    </span>
                  </div>
                </div>
                <p className="text-sm text-gray-600 mb-3">
                  {giocatoriSelezionati.size > 0 
                    ? '‚úÖ Importati dall\'allenamento selezionato'
                    : '‚ÑπÔ∏è Nessun allenamento importato - tutti i giocatori sono inclusi'}
                </p>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 max-h-96 overflow-y-auto">
                  {players
                    .filter(p => p.nome)
                    .sort((a, b) => {
                      // Ordina per: selezionati prima, poi per numero
                      const aSelected = giocatoriSelezionati.size === 0 || giocatoriSelezionati.has(a.nome);
                      const bSelected = giocatoriSelezionati.size === 0 || giocatoriSelezionati.has(b.nome);
                      if (aSelected === bSelected) return a.numero - b.numero;
                      return bSelected ? 1 : -1;
                    })
                    .map(player => {
                      const isSelected = giocatoriSelezionati.size === 0 || giocatoriSelezionati.has(player.nome);
                      const isInjured = infortunati.has(player.nome);
                      
                      return (
                        <div
                          key={player.numero}
                          className={`flex items-center gap-2 p-2 rounded-lg border-2 transition-all ${
                            isSelected
                              ? 'bg-green-50 border-green-400'
                              : 'bg-gray-100 border-gray-300 opacity-60'
                          }`}
                        >
                          <span className={`text-lg ${isSelected ? '' : 'grayscale'}`}>
                            {isSelected ? '‚úÖ' : '‚ùå'}
                          </span>
                          <div className="flex-1 min-w-0">
                            <div className={`text-sm font-medium truncate ${isSelected ? 'text-gray-900' : 'text-gray-500'}`}>
                              {player.nome}
                            </div>
                            <div className="text-xs text-gray-500">
                              #{player.numero} ‚Ä¢ {player.ruolo}
                              {isInjured && <span className="ml-1 text-red-600">ü§ï</span>}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                </div>
              </div>

              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p className="font-semibold text-blue-900 mb-1">üìä Informazioni distribuzione</p>
                <p className="text-sm text-blue-800">
                  <span className="font-medium">Giocatori disponibili:</span> <span className="font-bold">{giocatoriDisponibili}</span>
                  <br />
                  <span className="font-medium">Giocatori per squadra:</span> <span className="font-bold">
                    {Math.floor(giocatoriDisponibili / numSquadre)}
                    {giocatoriDisponibili % numSquadre > 0 && ` - ${Math.ceil(giocatoriDisponibili / numSquadre)}`}
                  </span>
                  {showDivisioneResults && (
                    <>
                      <br />
                      <span className={differenzaSquadre <= 1 ? 'text-green-700 font-semibold' : 'text-orange-700 font-semibold'}>
                        ‚öñÔ∏è Totali squadre: {conteggioSquadre.map(s => s.totale).join(', ')}
                        {differenzaSquadre <= 1 ? ' ‚úì PERFETTO' : ' ‚ö†Ô∏è NON BILANCIATO'}
                      </span>
                    </>
                  )}
                </p>
              </div>

              <div className="flex gap-4 mb-6">
                <button
                  onClick={rigeneraDivisione}
                  className="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition"
                >
                  {showDivisioneResults ? 'üîÑ Rigenera Divisione' : '‚öΩ Genera Divisione'}
                </button>
                {showDivisioneResults && (
                  <button
                    onClick={downloadDivisionePDF}
                    className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition"
                  >
                    üì• Scarica PDF Divisione
                  </button>
                )}
              </div>

              {showDivisioneResults && (
                <div className="space-y-6">
                  {dividiSquadre.map((squadra, index) => (
                    <div key={index} className="bg-white rounded-lg shadow-lg overflow-hidden border-2">
                      <div className={`${teamColors[index].bg} text-white p-4`}>
                        <h3 className="text-xl font-bold">
                          SQUADRA {teamColors[index].name} ({conteggioSquadre[index].totale} giocatori)
                        </h3>
                        <div className="mt-2 text-sm flex flex-wrap gap-x-4">
                          {includiPortieri && (
                            <span><span className="font-medium">Portieri:</span> {conteggioSquadre[index].portieri}</span>
                          )}
                          <span><span className="font-medium">Difensori:</span> {conteggioSquadre[index].difensori}</span>
                          <span><span className="font-medium">Centrocampisti:</span> {conteggioSquadre[index].centrocampisti}</span>
                          <span><span className="font-medium">Attaccanti:</span> {conteggioSquadre[index].attaccanti}</span>
                        </div>
                      </div>
                      
                      <div className="p-4">
                        {['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti'].map(ruolo => {
                          if (squadra[ruolo].length === 0) return null;
                          return (
                            <div key={ruolo} className="mb-4">
                              <h4 className="font-bold text-gray-700 mb-2">{ruolo} ({squadra[ruolo].length})</h4>
                              <div className="grid md:grid-cols-2 gap-2">
                                {squadra[ruolo].map(player => (
                                  <div key={player.numero} className="bg-gray-50 p-2 rounded border">
                                    <div className="font-medium">{player.nome}</div>
                                    <div className="text-sm text-gray-600">{player.ruolo}</div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* ========== SEZIONE CONVOCAZIONI ========== */}
          {activeTab === 'convocazioni' && (
            <div>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">üìã Convocazioni Partita</h2>
              
              <div className="mb-6 p-4 bg-cyan-50 border border-cyan-200 rounded-lg">
                <div className="flex items-start gap-3">
                  <div className="text-cyan-600 text-2xl">‚ÑπÔ∏è</div>
                  <div>
                    <p className="font-semibold text-cyan-900 mb-1">Crea la lista convocati</p>
                    <p className="text-sm text-cyan-800">
                      Seleziona i giocatori da convocare per la prossima partita (max 20) e genera un PDF con la lista ufficiale.
                      Inserisci le informazioni della partita per un documento completo.
                    </p>
                  </div>
                </div>
              </div>

              {/* ========== IMPORTA CONVOCATI DA PARTITA ========== */}
              <div className="mb-6 bg-gradient-to-r from-purple-50 to-purple-100 border-2 border-purple-300 rounded-lg p-6">
                <div className="flex items-start gap-3 mb-4">
                  <div className="text-purple-600 text-3xl">‚öΩ</div>
                  <div>
                    <h3 className="font-bold text-purple-900 text-lg mb-1">Importa Convocati da Partita</h3>
                    <p className="text-sm text-purple-800">
                      Seleziona una partita per caricare automaticamente i convocati gi√† registrati
                    </p>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Seleziona Partita
                    </label>
                    <select
                      value={selectedMatchForConvocazioni}
                      onChange={(e) => setSelectedMatchForConvocazioni(e.target.value)}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white"
                    >
                      <option value="">-- Seleziona una partita --</option>
                      {matches
                        .filter(m => m.convocati && Object.keys(m.convocati).some(key => m.convocati[key] === true))
                        .sort((a, b) => new Date(b.data) - new Date(a.data))
                        .map(match => {
                          const convocatiCount = Object.values(match.convocati).filter(v => v === true).length;
                          return (
                            <option key={match.id} value={match.id}>
                              {new Date(match.data).toLocaleDateString('it-IT')} - {match.squadraCasa || 'Casa'} vs {match.avversario || match.squadraTrasferta || 'Trasferta'} - {convocatiCount} convocati
                            </option>
                          );
                        })}
                    </select>
                  </div>

                  <div className="flex items-end">
                    <button
                      onClick={() => {
                        console.log('üîò CARICA CONVOCATI - Click!');
                        console.log('   selectedMatchForConvocazioni:', selectedMatchForConvocazioni);
                        console.log('   tipo:', typeof selectedMatchForConvocazioni);
                        
                        if (!selectedMatchForConvocazioni) {
                          alert('‚ö†Ô∏è Seleziona prima una partita');
                          return;
                        }
                        
                        // CRITICAL: Converti in numero prima del confronto
                        const matchId = parseInt(selectedMatchForConvocazioni);
                        console.log('   matchId convertito:', matchId);
                        
                        const match = matches.find(m => m.id === matchId);
                        console.log('   match trovato?', match ? 'S√å' : 'NO');
                        
                        if (!match) {
                          alert('‚ùå Partita non trovata!');
                          return;
                        }
                        
                        console.log('   Convocati nella partita:', match.convocati);
                        
                        // CRITICAL: Convocati sono salvati come NUMERI, ma il Set usa NOMI!
                        // Converti numeri in nomi (come per Importa Presenti)
                        
                        // 1. Estrai numeri dei giocatori convocati
                        const numeriConvocati = Object.entries(match.convocati || {})
                          .filter(([_, convocato]) => convocato === true)
                          .map(([num, _]) => parseInt(num));
                        
                        console.log('   Numeri convocati nella partita:', numeriConvocati);
                        
                        // 2. Converti numeri in nomi usando array players
                        const convocatiNomi = players
                          .filter(p => numeriConvocati.includes(p.numero))
                          .map(p => p.nome);
                        
                        console.log('   Nomi convocati trovati:', convocatiNomi);
                        console.log('   Totale convocati:', convocatiNomi.length);
                        
                        const nuoviConvocati = new Set(convocatiNomi);
                        setConvocati(nuoviConvocati);
                        
                        // Determina se la partita √® in casa o trasferta
                        const realDorInCasa = (match.squadraCasa && match.squadraCasa.toLowerCase().includes('real dor')) ||
                                              (match.squadraCasa && match.squadraCasa.toLowerCase().includes('brescia'));
                        
                        console.log('   Real DOR in casa?', realDorInCasa);
                        
                        // Pre-compila info partita con automazione casa/trasferta
                        if (realDorInCasa) {
                          console.log('   ‚öΩ PARTITA IN CASA - Pre-compilazione automatica');
                          setInfoPartita({
                            squadra1: match.squadraCasa || 'Real DOR Brescia',
                            squadra2: match.avversario || match.squadraTrasferta || '',
                            dataPartita: match.data || '',
                            oraRitrovo: '13:40',  // Automatico per casa
                            indirizzoCompo: 'Via Chiappa 12 - Brescia'  // Automatico per casa
                          });
                        } else {
                          console.log('   üöå PARTITA IN TRASFERTA - Pre-compilazione parziale');
                          setInfoPartita({
                            squadra1: match.squadraCasa || '',
                            squadra2: match.avversario || match.squadraTrasferta || 'Real DOR Brescia',
                            dataPartita: match.data || '',
                            oraRitrovo: match.oraRitrovo || '',  // Da compilare manualmente
                            indirizzoCompo: match.campo || ''  // Da compilare manualmente
                          });
                        }
                        
                        // Toast feedback
                        const tipoPartita = realDorInCasa ? 'üè† Casa' : 'üöå Trasferta';
                        showToast(`‚úÖ Caricati ${nuoviConvocati.size} convocati! ${tipoPartita}`, 'success');
                      }}
                      disabled={!selectedMatchForConvocazioni || userRole !== 'admin'}
                      className={`w-full px-6 py-3 rounded-lg font-bold transition-colors ${
                        selectedMatchForConvocazioni && userRole === 'admin'
                          ? 'bg-purple-600 text-white hover:bg-purple-700'
                          : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}
                    >
                      ‚¨áÔ∏è Carica Convocati
                    </button>
                  </div>
                </div>

                {selectedMatchForConvocazioni && (() => {
                  const match = matches.find(m => m.id === selectedMatchForConvocazioni);
                  if (!match) return null;
                  
                  const convocatiCount = Object.values(match.convocati || {}).filter(v => v === true).length;
                  
                  return (
                    <div className="mt-4 p-3 bg-white border-2 border-purple-200 rounded-lg">
                      <div className="text-sm text-gray-700">
                        <strong>Partita del {new Date(match.data).toLocaleDateString('it-IT')} - {match.squadraCasa || 'Casa'} vs {match.avversario || match.squadraTrasferta || 'Trasferta'}:</strong>
                        <span className="ml-2">üë• {convocatiCount} convocati</span>
                        <span className="ml-2">üìç {match.campo || 'Campo non specificato'}</span>
                      </div>
                    </div>
                  );
                })()}
              </div>

              <div 
                className="mb-6 bg-white border rounded-lg p-4"
                style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.7} : {}}
              >
                <h3 className="font-bold text-gray-800 mb-4">Informazioni Partita</h3>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Squadra Casa</label>
                    <input
                      type="text"
                      value={infoPartita.squadra1}
                      onChange={(e) => setInfoPartita({...infoPartita, squadra1: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                      placeholder="Es: Real DOR"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Squadra Ospite</label>
                    <input
                      type="text"
                      value={infoPartita.squadra2}
                      onChange={(e) => setInfoPartita({...infoPartita, squadra2: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                      placeholder="Es: Avversari"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Data Partita</label>
                    <input
                      type="date"
                      value={infoPartita.dataPartita}
                      onChange={(e) => setInfoPartita({...infoPartita, dataPartita: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Ora Ritrovo</label>
                    <input
                      type="time"
                      value={infoPartita.oraRitrovo}
                      onChange={(e) => setInfoPartita({...infoPartita, oraRitrovo: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Indirizzo Campo</label>
                    <input
                      type="text"
                      value={infoPartita.indirizzoCompo}
                      onChange={(e) => setInfoPartita({...infoPartita, indirizzoCompo: e.target.value})}
                      className="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-cyan-500"
                      placeholder="Es: Via dello Sport 123, Brescia"
                    />
                  </div>
                </div>
              </div>

              <div style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.7} : {}}>
              {['Portieri', 'Difensori', 'Centrocampisti', 'Attaccanti', 'Altri'].map(categoria => {
                const giocatori = players.filter(p => 
                  p.nome && mappaRuolo(p.ruolo) === categoria
                );
                if (giocatori.length === 0) return null;
                
                return (
                  <div key={categoria} className="mb-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-3 border-b pb-2">
                      {categoria} ({giocatori.filter(p => convocati.has(p.nome)).length}/{giocatori.length})
                    </h3>
                    <div className="grid md:grid-cols-2 gap-2">
                      {giocatori.map(player => {
                        const isInfortunato = infortunati.has(player.nome);
                        return (
                        <label 
                          key={player.numero}
                          className={`flex items-center p-3 rounded-lg cursor-pointer transition ${
                            convocati.has(player.nome) 
                              ? 'bg-cyan-50 border-2 border-cyan-400' 
                              : 'bg-gray-50 border-2 border-transparent hover:bg-gray-100'
                          } ${isInfortunato ? 'opacity-75' : ''}`}
                        >
                          <input
                            type="checkbox"
                            checked={convocati.has(player.nome)}
                            onChange={() => toggleConvocato(player.nome)}
                            className="mr-3 h-5 w-5 text-cyan-600 rounded"
                          />
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <span className="font-medium text-gray-900">{player.nome}</span>
                              {isInfortunato && (
                                <span className="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full font-semibold">
                                  ü§ï INFORTUNATO
                                </span>
                              )}
                            </div>
                            <div className="text-sm text-gray-500">{player.ruolo}</div>
                          </div>
                        </label>
                      )})}
                    </div>
                  </div>
                );
              })}
              </div>

              <div className="sticky bottom-0 bg-white border-t-2 border-gray-200 p-4 -mx-6 -mb-6 mt-6">
                <div className="flex justify-between items-center">
                  <span className="text-gray-700 font-medium text-lg">
                    {convocati.size} / 20 giocatori convocati
                  </span>
                  <button
                    onClick={downloadConvocazioni}
                    disabled={convocati.size === 0}
                    className={`py-3 px-8 rounded-lg font-semibold transition ${
                      convocati.size === 0
                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        : 'bg-cyan-600 text-white hover:bg-cyan-700'
                    }`}
                  >
                    üì• Scarica PDF Convocazione
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* ========== MODAL CHIUSURA APP ========== */}
        {showExitModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full animate-scale-up">
              {/* Header */}
              <div className="bg-gradient-to-r from-red-500 to-red-600 text-white p-6 rounded-t-lg">
                <div className="flex items-center gap-3">
                  <div className="text-4xl">üíæ</div>
                  <div>
                    <h3 className="text-2xl font-bold">Chiusura Applicazione</h3>
                    <p className="text-red-100 text-sm mt-1">
                      Salvare le modifiche prima di chiudere?
                    </p>
                  </div>
                </div>
              </div>
              
              {/* Body */}
              <div className="p-6">
                <p className="text-gray-700 mb-6">
                  Sei il <strong>dispositivo principale</strong>. Al prossimo accesso sarai ancora loggato, ma ti consiglio di salvare le modifiche sul cloud.
                </p>
                
                {/* Opzioni */}
                <div className="space-y-3">
                  {/* Salva e Chiudi */}
                  <button
                    onClick={handleExitWithSave}
                    className="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-4 rounded-lg transition-all hover:scale-102 shadow-lg flex items-center gap-3"
                  >
                    <div className="text-3xl">üíæ</div>
                    <div className="text-left flex-1">
                      <div className="font-bold">Salva e Chiudi</div>
                      <div className="text-xs text-green-100">Sincronizza i dati sul cloud e chiudi la finestra</div>
                    </div>
                  </button>
                  
                  {/* Chiudi Senza Salvare */}
                  <button
                    onClick={handleExitWithoutSave}
                    className="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-4 rounded-lg transition-all hover:scale-102 shadow-lg flex items-center gap-3"
                  >
                    <div className="text-3xl">‚úï</div>
                    <div className="text-left flex-1">
                      <div className="font-bold">Chiudi Senza Salvare</div>
                      <div className="text-xs text-orange-100">Chiudi senza sincronizzare (modifiche solo locali)</div>
                    </div>
                  </button>
                  
                  {/* Annulla */}
                  <button
                    onClick={handleCancelExit}
                    className="w-full bg-gray-500 hover:bg-gray-600 text-white p-4 rounded-lg transition-all hover:scale-102 shadow-lg flex items-center gap-3"
                  >
                    <div className="text-3xl">‚Ü©Ô∏è</div>
                    <div className="text-left flex-1">
                      <div className="font-bold">Annulla</div>
                      <div className="text-xs text-gray-100">Torna all'applicazione</div>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {showInstructionsModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
              <div className="p-6 border-b sticky top-0 bg-white">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold text-gray-800">üìñ Istruzioni d'uso</h3>
                  <button
                    onClick={() => setShowInstructionsModal(false)}
                    className="text-gray-600 hover:text-gray-800 text-2xl"
                  >
                    ‚úï
                  </button>
                </div>
              </div>
              
              <div className="p-6 space-y-6">
                <div className="bg-green-50 border-2 border-green-400 rounded-lg p-4">
                  <h4 className="font-bold text-green-800 mb-2">‚úÖ SALVATAGGIO AUTOMATICO ATTIVO</h4>
                  <p className="text-green-900 text-sm">
                    Tutti i dati vengono salvati automaticamente sul tuo dispositivo ogni volta che apporti modifiche. Non devi fare nulla! L'app funziona anche offline.
                  </p>
                </div>

                <div className="border-l-4 border-blue-500 pl-4">
                  <h4 className="font-bold text-blue-800 mb-3 text-lg">üì± 1. GESTIONE ROSA</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Aggiungi giocatori:</strong> Clicca "Aggiungi Giocatore" e compila nome, ruolo, numero maglia</li>
                    <li><strong>Foto giocatore:</strong> Clicca sull'icona üì∑ per aggiungere foto dal dispositivo (si comprime automaticamente)</li>
                    <li><strong>Modifica:</strong> Clicca "Modifica" per aggiornare i dati, poi "Salva" per confermare</li>
                    <li><strong>Infortuni:</strong> Segna i giocatori infortunati cliccando sull'icona ü§ï</li>
                    <li><strong>Logo squadra:</strong> Clicca sul logo in alto per caricarne uno personalizzato</li>
                  </ul>
                </div>

                <div className="border-l-4 border-green-500 pl-4">
                  <h4 className="font-bold text-green-800 mb-3 text-lg">‚öΩ 2. ALLENAMENTI</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Crea allenamento:</strong> Clicca "Aggiungi Nuovo Allenamento" e seleziona la data</li>
                    <li><strong>Presenze:</strong> Segna P (Presente), A (Assente), o I (Infortunato) per ogni giocatore</li>
                    <li><strong>Lista presenze PDF:</strong> Clicca "üìã Stampa Lista Presenze" per generare un foglio da compilare sul campo</li>
                    <li><strong>Statistiche:</strong> Le presenze vengono conteggiate automaticamente nelle statistiche</li>
                  </ul>
                </div>

                <div className="border-l-4 border-purple-500 pl-4">
                  <h4 className="font-bold text-purple-800 mb-3 text-lg">‚öñÔ∏è 3. DIVISIONE SQUADRE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Squadre equilibrate:</strong> Seleziona i giocatori disponibili e scegli il numero di squadre (2-6)</li>
                    <li><strong>Algoritmo automatico:</strong> Il sistema divide i giocatori per creare squadre bilanciate</li>
                    <li><strong>PDF stampabile:</strong> Genera un PDF con le squadre divise da portare in campo</li>
                    <li><strong>Perfetto per:</strong> Partitelle in allenamento, tornei interni, allenamenti specifici</li>
                  </ul>
                </div>

                <div className="border-l-4 border-red-500 pl-4">
                  <h4 className="font-bold text-red-800 mb-3 text-lg">üèÜ 4. PARTITE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Crea partita:</strong> Clicca "Aggiungi Nuova Partita", compila avversario, data e campo</li>
                    <li><strong>Convoca giocatori:</strong> Seleziona i convocati e scegli i titolari (max 11)</li>
                    <li><strong>Modalit√† Live ‚ö°:</strong> Durante la partita, usa la modalit√† live per registrare tutto in tempo reale</li>
                    <li><strong>Eventi live:</strong> Registra gol, assist, cartellini gialli/rossi, sostituzioni (max 5)</li>
                    <li><strong>Timer:</strong> Timer integrato con tempo di recupero e avviso sonoro a fine tempo</li>
                    <li><strong>Modulo tattico:</strong> Scegli il modulo (4-4-2, 4-3-3, 3-5-2, ecc.) e visualizza lo schema</li>
                  </ul>
                </div>

                <div className="border-l-4 border-indigo-500 pl-4">
                  <h4 className="font-bold text-indigo-800 mb-3 text-lg">üéØ 5. ANALISI TATTICA</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Studia avversari:</strong> Inserisci il modulo dell'avversario per vedere i punti deboli</li>
                    <li><strong>Moduli consigliati:</strong> Il sistema suggerisce i 3 moduli migliori con efficacia in %</li>
                    <li><strong>Tattiche dettagliate:</strong> Per ogni modulo consigliato trovi vantaggi, tattiche e contromosse</li>
                    <li><strong>Ruoli chiave:</strong> Scopri quali giocatori sono fondamentali e che caratteristiche devono avere</li>
                    <li><strong>8 moduli disponibili:</strong> 4-4-2, 4-3-3, 3-5-2, 4-2-3-1, 3-4-3, 5-3-2, 4-1-4-1, 4-3-1-2</li>
                  </ul>
                </div>

                <div className="border-l-4 border-cyan-500 pl-4">
                  <h4 className="font-bold text-cyan-800 mb-3 text-lg">üìã 6. CONVOCAZIONI</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Lista convocati:</strong> Seleziona fino a 20 giocatori per la prossima partita</li>
                    <li><strong>Infortunati:</strong> Puoi convocare anche gli infortunati (sono evidenziati con badge rosso)</li>
                    <li><strong>Info partita:</strong> Inserisci squadre, data, ora ritrovo e indirizzo campo</li>
                    <li><strong>PDF ufficiale:</strong> Genera un PDF professionale con tutti i dettagli da stampare e distribuire</li>
                  </ul>
                </div>

                <div className="border-l-4 border-yellow-500 pl-4">
                  <h4 className="font-bold text-yellow-800 mb-3 text-lg">üìä 7. STATISTICHE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Dati completi:</strong> Presenze allenamenti, partite giocate, minuti, gol, assist, cartellini</li>
                    <li><strong>Percentuali:</strong> % convocazioni, % titolarit√†, media minuti, media gol per partita</li>
                    <li><strong>Ordinamento:</strong> Clicca sulle intestazioni delle colonne per ordinare i dati</li>
                    <li><strong>Calcolo automatico:</strong> Le statistiche si aggiornano automaticamente ad ogni evento</li>
                  </ul>
                </div>

                <div className="border-l-4 border-orange-500 pl-4">
                  <h4 className="font-bold text-orange-800 mb-3 text-lg">üèÜ 8. GIOCATORI TOP</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Classifiche automatiche:</strong> Top 10 per ogni categoria prestazionale</li>
                    <li><strong>Categorie:</strong> Presenze, minuti giocati, gol segnati, assist forniti, MVP stagione</li>
                    <li><strong>Motivazione:</strong> Usa queste classifiche per premiare i migliori e motivare la squadra</li>
                  </ul>
                </div>

                <div className="border-l-4 border-gray-500 pl-4">
                  <h4 className="font-bold text-gray-800 mb-3 text-lg">üíæ 9. GESTIONE BACKUP</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Esporta JSON:</strong> Scarica un backup di tutti i dati in formato JSON</li>
                    <li><strong>Importa JSON:</strong> Carica un backup per trasferire dati su altro dispositivo</li>
                    <li><strong>Cloud storage:</strong> Salva il backup su Google Drive/Dropbox per sicurezza extra</li>
                    <li><strong>Sincronizza:</strong> Usa backup per sincronizzare tra PC e tablet</li>
                    <li><strong>Note:</strong> Il backup √® opzionale, i dati sono gi√† salvati automaticamente</li>
                  </ul>
                </div>

                <div className="border-l-4 border-red-600 pl-4">
                  <h4 className="font-bold text-red-800 mb-3 text-lg">üîÑ 10. RESET DATABASE - NUOVA STAGIONE</h4>
                  <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                    <li><strong>Reset Stagione (consigliato):</strong> Cancella allenamenti/partite ma mantiene la rosa giocatori</li>
                    <li><strong>Reset Completo:</strong> Cancella tutto e ricomincia da zero (usa con cautela!)</li>
                    <li><strong>Procedura consigliata:</strong> Fai backup ‚Üí Reset Stagione ‚Üí Riparti con stessa squadra</li>
                    <li><strong>Sicurezza:</strong> Multiple conferme prima di ogni operazione di reset</li>
                  </ul>
                </div>

                <div className="bg-blue-50 border-2 border-blue-400 rounded-lg p-4 mt-6">
                  <h4 className="font-bold text-blue-800 mb-2">üí° CONSIGLI PRATICI</h4>
                  <ul className="list-disc ml-6 text-sm text-blue-900 space-y-1">
                    <li>Usa il tablet durante le partite per la modalit√† Live</li>
                    <li>Stampa le liste presenze prima degli allenamenti</li>
                    <li>Studia i moduli avversari prima delle partite importanti</li>
                    <li>Scarica backup periodici come sicurezza</li>
                    <li>Usa le classifiche TOP per motivare i giocatori</li>
                    <li>Al cambio stagione: Backup ‚Üí Reset Stagione ‚Üí Continua</li>
                  </ul>
                </div>

                <div className="bg-purple-50 border-2 border-purple-400 rounded-lg p-4">
                  <h4 className="font-bold text-purple-800 mb-2">üì± COMPATIBILIT√Ä</h4>
                  <p className="text-purple-900 text-sm">
                    <strong>PC:</strong> Chrome, Firefox, Edge, Safari<br/>
                    <strong>Tablet/Smartphone:</strong> Android, iOS, iPad<br/>
                    <strong>Offline:</strong> Funziona senza connessione internet<br/>
                    <strong>Sincronizzazione:</strong> Usa backup JSON per trasferire dati tra dispositivi
                  </p>
                </div>
              </div>

              <div className="p-6 border-t bg-gray-50">
                <button
                  onClick={() => setShowInstructionsModal(false)}
                  className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                >
                  Ho capito, iniziamo!
                </button>
              </div>
            </div>
          </div>
        )}

        {/* ========== MODAL ELENCO RISULTATI PARTITE ========== */}
        {showResultsModal && (
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[110] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-5xl w-full p-6 animate-scale-up max-h-[90vh] overflow-y-auto">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">üìã</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Elenco Risultati Partite</h2>
                <p className="text-gray-600">Real DOR Under 18 - Stagione 2024/2025</p>
              </div>

              {/* Statistiche Riepilogative */}
              {(() => {
                const partiteCompletate = matches.filter(m => {
                  const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  return golFatti > 0 || golSubiti > 0;
                });
                
                const vittorie = partiteCompletate.filter(m => {
                  const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  return golFatti > golSubiti;
                }).length;
                
                const pareggi = partiteCompletate.filter(m => {
                  const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  return golFatti === golSubiti;
                }).length;
                
                const sconfitte = partiteCompletate.filter(m => {
                  const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                  return golFatti < golSubiti;
                }).length;
                
                const puntiTotali = vittorie * 3 + pareggi * 1;
                
                return (
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow p-4 border-2 border-blue-200">
                      <div className="text-3xl font-bold text-blue-600">{partiteCompletate.length}</div>
                      <div className="text-sm text-gray-700 font-semibold">Partite</div>
                    </div>
                    <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow p-4 border-2 border-green-200">
                      <div className="text-3xl font-bold text-green-600">{vittorie}</div>
                      <div className="text-sm text-gray-700 font-semibold">Vittorie</div>
                    </div>
                    <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow p-4 border-2 border-yellow-200">
                      <div className="text-3xl font-bold text-yellow-600">{pareggi}</div>
                      <div className="text-sm text-gray-700 font-semibold">Pareggi</div>
                    </div>
                    <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg shadow p-4 border-2 border-red-200">
                      <div className="text-3xl font-bold text-red-600">{sconfitte}</div>
                      <div className="text-sm text-gray-700 font-semibold">Sconfitte</div>
                    </div>
                    <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow p-4 border-2 border-purple-200">
                      <div className="text-3xl font-bold text-purple-600">{puntiTotali}</div>
                      <div className="text-sm text-gray-700 font-semibold">Punti</div>
                    </div>
                  </div>
                );
              })()}

              {/* Tabella Risultati */}
              <div className="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-blue-600 text-white">
                      <tr>
                        <th className="p-3 text-left">Data</th>
                        <th className="p-3 text-left">Partita</th>
                        <th className="p-3 text-center">Risultato</th>
                        <th className="p-3 text-center">Esito</th>
                        <th className="p-3 text-left hidden md:table-cell">Luogo</th>
                      </tr>
                    </thead>
                    <tbody>
                      {matches
                        .filter(m => {
                          const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                          const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                          return golFatti > 0 || golSubiti > 0;
                        })
                        .sort((a, b) => new Date(b.data) - new Date(a.data)) // Pi√π recenti prima
                        .map((m, idx) => {
                          const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                          const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                          const risultato = golFatti > golSubiti ? 'Vittoria' : golFatti === golSubiti ? 'Pareggio' : 'Sconfitta';
                          const esitoColor = risultato === 'Vittoria' ? 'bg-green-50 text-green-700' : risultato === 'Pareggio' ? 'bg-yellow-50 text-yellow-700' : 'bg-red-50 text-red-700';
                          const esitoIcon = risultato === 'Vittoria' ? '‚úÖ' : risultato === 'Pareggio' ? 'üü°' : '‚ùå';
                          
                          return (
                            <tr key={m.id || idx} className="border-b hover:bg-gray-50">
                              <td className="p-3 font-semibold">
                                {new Date(m.data).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' })}
                              </td>
                              <td className="p-3">
                                <div className="font-semibold text-gray-800">
                                  {m.squadraCasa && m.squadraTrasferta 
                                    ? `${m.squadraCasa} vs ${m.squadraTrasferta}`
                                    : m.avversario || m.squadraTrasferta || 'Avversario'}
                                </div>
                              </td>
                              <td className="p-3 text-center">
                                <span className="text-lg font-bold text-gray-800">{golFatti} - {golSubiti}</span>
                              </td>
                              <td className="p-3 text-center">
                                <span className={`inline-block px-3 py-1 rounded-full text-sm font-bold ${esitoColor}`}>
                                  {esitoIcon} {risultato}
                                </span>
                              </td>
                              <td className="p-3 text-gray-600 hidden md:table-cell">{m.luogo || '-'}</td>
                            </tr>
                          );
                        })}
                      {matches.filter(m => {
                        const golFatti = Object.values(m.golFatti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                        const golSubiti = Object.values(m.golSubiti || {}).reduce((sum, g) => sum + (parseInt(g) || 0), 0);
                        return golFatti > 0 || golSubiti > 0;
                      }).length === 0 && (
                        <tr>
                          <td colSpan="5" className="p-8 text-center text-gray-500">
                            <div className="text-4xl mb-2">‚öΩ</div>
                            <p>Nessuna partita completata</p>
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Pulsanti Azione */}
              <div className="flex flex-col sm:flex-row gap-3">
                <button
                  onClick={() => {
                    exportResultsPDF();
                  }}
                  className="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold flex items-center justify-center gap-2"
                >
                  üìÑ Esporta PDF
                </button>
                <button
                  onClick={() => setShowResultsModal(false)}
                  className="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
                >
                  ‚úï Chiudi
                </button>
              </div>
            </div>
          </div>
        )}

        {liveMatchMode && (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
            <div className="min-h-screen flex items-start justify-center p-4">
              <div className="bg-white rounded-lg shadow-2xl max-w-6xl w-full my-8 max-h-[calc(100vh-4rem)] flex flex-col">
                {(() => {
                  const match = matches.find(m => m.id === liveMatchMode);
                  
                  const sortByDistinta = (players) => {
                    return players.sort((a, b) => {
                      const posizioni = match.posizioneVisualizzazione || {};
                      const ordineDistinta = match.ordineDistinta || {};
                      
                      let ordineA = parseInt(posizioni[a.numero]);
                      if (!ordineA || isNaN(ordineA)) {
                        if (match.entrati && match.entrati[a.numero]) {
                          const dettaglio = (match.sostituzioniDettaglio || {})[a.numero];
                          if (dettaglio && dettaglio.alPostoDi) {
                            ordineA = parseInt(posizioni[dettaglio.alPostoDi]);
                          }
                        }
                        
                        if (!ordineA || isNaN(ordineA)) {
                          ordineA = parseInt(ordineDistinta[a.numero] || a.numero);
                        }
                      }
                      
                      let ordineB = parseInt(posizioni[b.numero]);
                      if (!ordineB || isNaN(ordineB)) {
                        if (match.entrati && match.entrati[b.numero]) {
                          const dettaglio = (match.sostituzioniDettaglio || {})[b.numero];
                          if (dettaglio && dettaglio.alPostoDi) {
                            ordineB = parseInt(posizioni[dettaglio.alPostoDi]);
                          }
                        }
                        
                        if (!ordineB || isNaN(ordineB)) {
                          ordineB = parseInt(ordineDistinta[b.numero] || b.numero);
                        }
                      }
                      
                      if (ordineA === ordineB) return a.numero - b.numero;
                      return ordineA - ordineB;
                    });
                  };
                  
                  // ‚úÖ CORREZIONE BUG: I giocatori sostituiti ora appaiono in panchina
                  const inCampo = sortByDistinta(players.filter(p => 
                    (match.titolari[p.numero] || match.entrati[p.numero]) && !match.sostituzioni[p.numero]
                  ));
                  
                  const panchina = sortByDistinta(players.filter(p => 
                    ((match.convocati[p.numero] && !match.titolari[p.numero] && !match.entrati[p.numero]) ||
                     match.sostituzioni[p.numero]) &&
                    !match.rossi_gioco[p.numero] &&
                    !match.rossi_protesta[p.numero]
                  ));
                  
                  return (
                    <>
                      <div className="flex-shrink-0 sticky top-0 z-20">
                        <div className="p-4 border-b bg-gradient-to-r from-green-600 to-blue-600 text-white">
                          <div className="flex justify-between items-center">
                            <div>
                              <h3 className="text-2xl font-bold">‚ö° MODALIT√Ä LIVE</h3>
                              <p className="text-sm">{match.squadraCasa} vs {match.squadraTrasferta}</p>
                              <div className="flex items-center gap-6 mt-2">
                                <div className="text-4xl font-bold">
                                  üìä {(() => {
                                    const golFatti = Object.values(match.golFatti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                    const golSubiti = Object.values(match.golSubiti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                    const realDorInCasa = match.squadraCasa && match.squadraCasa.toLowerCase().includes('real dor');
                                    const golCasa = realDorInCasa ? golFatti : golSubiti;
                                    const golTrasferta = realDorInCasa ? golSubiti : golFatti;
                                    return `${golCasa} - ${golTrasferta}`;
                                  })()}
                                </div>
                                <div className={`px-4 py-2 rounded-lg font-bold text-lg ${
                                  (() => {
                                    const numSost = Object.values(match.sostituzioni || {}).filter(v => v === true).length;
                                    if (numSost >= 5) return 'bg-red-600 animate-pulse';
                                    if (numSost === 4) return 'bg-yellow-600 animate-pulse';
                                    return 'bg-blue-600';
                                  })()
                                }`}>
                                  üîÑ Sostituzioni: {Object.values(match.sostituzioni || {}).filter(v => v === true).length}/5
                                </div>
                              </div>
                            </div>
                            <div className="flex gap-2">
                              {matchEnded && (() => {
                                const golFatti = Object.values(match.golFatti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                const golSubiti = Object.values(match.golSubiti || {}).reduce((sum, gol) => sum + parseInt(gol || 0), 0);
                                const realDorInCasa = match.squadraCasa && match.squadraCasa.toLowerCase().includes('real dor');
                                const golCasa = realDorInCasa ? golFatti : golSubiti;
                                const golTrasferta = realDorInCasa ? golSubiti : golFatti;
                                const abbiamovinto = golCasa > golTrasferta;
                                
                                if (abbiamovinto) {
                                  return (
                                    <button 
                                      onClick={() => setShowVictoryCelebration(true)} 
                                      className="px-6 py-3 bg-yellow-400 text-black rounded-lg hover:bg-yellow-500 font-black text-lg animate-pulse shadow-lg border-4 border-yellow-600"
                                    >
                                      üéâ VITTORIA! üéâ
                                    </button>
                                  );
                                }
                                return null;
                              })()}
                              <button onClick={closeLiveMatch} className="px-4 py-2 bg-white text-gray-800 rounded-lg hover:bg-gray-100 font-semibold">
                                ‚úï Chiudi
                              </button>
                            </div>
                          </div>
                        </div>

                        <div className="p-2 bg-gray-900 text-white shadow-xl border-b border-gray-700">
                        <div className="flex items-center justify-center gap-4">
                          <div className="flex items-center gap-3">
                            <div className="flex flex-col items-center gap-1">
                              <div className="flex items-center gap-2">
                                <div className={`px-3 py-1 rounded-lg font-bold text-sm ${halfTime === 1 ? 'bg-green-600' : 'bg-gray-600'}`}>
                                  1¬∞ TEMPO
                                </div>
                                <div className={`px-3 py-1 rounded-lg font-bold text-sm ${halfTime === 2 ? 'bg-green-600' : 'bg-gray-600'}`}>
                                  2¬∞ TEMPO
                                </div>
                              </div>
                              <div className="text-xs font-semibold opacity-70">TEMPO REGOLAMENTARE</div>
                              <div className="text-4xl font-bold font-mono">{formatTime(matchTimer)}</div>
                              {!matchEnded && (
                                <div className="flex gap-2">
                                  {!isTimerRunning ? (
                                    <button 
                                      onClick={startTimer} 
                                      disabled={(halfTime === 1 && matchTimer >= 2700) || (halfTime === 2 && matchTimer >= 5400)} 
                                      className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                      ‚ñ∂ Start
                                    </button>
                                  ) : (
                                    <button onClick={pauseTimer} className="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold">
                                      ‚è∏ Pausa
                                    </button>
                                  )}
                                </div>
                              )}
                            </div>
                            {!matchEnded && (
                              <div className="flex flex-col gap-1">
                                <button onClick={addMinute} className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xl">‚ñ≤</button>
                                <button onClick={removeMinute} className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xl">‚ñº</button>
                              </div>
                            )}
                          </div>

                          <div className="flex items-center gap-4 border-l-2 border-white pl-6">
                            <div className="flex flex-col items-center gap-2">
                              <div className="text-sm font-semibold opacity-70">RECUPERO</div>
                              <div className={`text-4xl font-bold font-mono ${
                                (matchTimer >= 2700 && halfTime === 1) || (matchTimer >= 5400 && halfTime === 2) 
                                  ? 'text-yellow-400' 
                                  : 'text-gray-600'
                              }`}>
                                +{formatTime(recoveryTime)}
                              </div>
                              {((matchTimer >= 2700 && halfTime === 1) || (matchTimer >= 5400 && halfTime === 2)) && (
                                <div className="flex items-center gap-2">
                                  <label className="text-xs opacity-70">Min previsti:</label>
                                  <input
                                    type="number"
                                    min="0"
                                    max="15"
                                    value={recoveryMinutes}
                                    onChange={(e) => setRecoveryMinutes(e.target.value)}
                                    placeholder="Min"
                                    className="w-12 px-2 py-1 bg-gray-800 border border-gray-600 rounded text-center text-white placeholder-gray-500"
                                  />
                                </div>
                              )}
                              {!matchEnded && isRecoveryRunning && (
                                <button onClick={() => setIsRecoveryRunning(false)} className="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold text-sm">
                                  ‚è∏ Pausa
                                </button>
                              )}
                              {!matchEnded && !isRecoveryRunning && ((matchTimer >= 2700 && halfTime === 1) || (matchTimer >= 5400 && halfTime === 2)) && (
                                <button onClick={() => setIsRecoveryRunning(true)} className="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold text-sm">
                                  ‚ñ∂ Riprendi
                                </button>
                              )}
                            </div>
                            {!matchEnded && matchTimer >= 2700 && (
                              <div className="flex flex-col gap-1">
                                <button onClick={addRecoveryMinute} className="px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-xl">‚ñ≤</button>
                                <button onClick={removeRecoveryMinute} className="px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-xl">‚ñº</button>
                              </div>
                            )}
                          </div>

                          {!matchEnded && (
                            <div className="border-l-2 border-white pl-6 flex flex-col gap-2">
                              {halfTime === 1 && matchTimer >= 2700 && (
                                <button onClick={() => {
                                  showConfirm('‚è±Ô∏è PASSA AL 2¬∞ TEMPO\n\nVuoi passare al secondo tempo?\nIl recupero del 1¬∞ tempo verr√† azzerato.\n\nConfermi?', () => {
                                    setHalfTime(2);
                                    setMatchTimer(2700);
                                    setRecoveryTime(0);
                                    setRecoveryMinutes('');
                                    setIsRecoveryRunning(false);
                                    setIsTimerRunning(false);
                                  });
                                }} className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm">
                                  ‚è© 2¬∞ TEMPO
                                </button>
                              )}
                              <button onClick={() => {
                                showConfirm('‚è±Ô∏è AZZERA TIMER\n\nIl timer verr√† resettato a 0:00 (inizio 1¬∞ tempo).\n\nConfermi?', () => {
                                  setMatchTimer(0);
                                  setIsTimerRunning(false);
                                  setRecoveryTime(0);
                                  setIsRecoveryRunning(false);
                                  setHalfTime(1);
                                  setRecoveryMinutes('');
                                  setMatchEnded(false);
                                });
                              }} className="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold text-sm">
                                ‚è±Ô∏è AZZERA
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                      </div>

                        {/* ========== TIMELINE EVENTI PARTITA ========== */}
                        <div className="p-1 bg-white border-b border-gray-200">
                          <h4 className="text-xs font-bold text-gray-800 mb-0.5">‚è±Ô∏è Timeline Eventi</h4>
                          <div className="relative">
                            {/* Linea temporale */}
                            <div className="absolute left-0 right-0 top-3 h-1 bg-gray-300 rounded"></div>
                            <div className="absolute left-0 top-3 h-1 bg-green-500 rounded" style={{ width: `${(matchTimer / 5400) * 100}%` }}></div>
                            
                            {/* Eventi sulla timeline */}
                            <div className="relative pt-3 min-h-[100px]">
                              {/* Marker inizio e fine */}
                              <div className="absolute left-0 top-0 flex flex-col items-center">
                                <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                <div className="text-xs text-gray-600 mt-1">0'</div>
                              </div>
                              <div className="absolute right-0 top-0 flex flex-col items-center">
                                <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                <div className="text-xs text-gray-600 mt-1">90'</div>
                              </div>
                              
                              {/* STEP 4: Eventi da match.timeline */}
                              {(match.timeline || []).map((evento, idx) => {
                                // Calcola posizione basata su minuto
                                let position = 5; // default all'inizio
                                
                                if (evento.minuto !== null && evento.minuto !== undefined) {
                                  // Usa minuto esatto se disponibile
                                  position = (parseInt(evento.minuto) / 90) * 100;
                                } else {
                                  // Altrimenti distribuzione uniforme
                                  const allEvents = match.timeline || [];
                                  const eventIndex = allEvents.findIndex(e => e.id === evento.id);
                                  position = ((eventIndex + 1) / (allEvents.length + 1)) * 100;
                                }
                                
                                // FIX: Calcola offset verticale per eventi allo stesso minuto
                                const eventsAtSameMinute = (match.timeline || []).filter((e, i) => {
                                  if (evento.minuto !== null && evento.minuto !== undefined) {
                                    return e.minuto === evento.minuto && i <= idx;
                                  }
                                  return false;
                                });
                                const verticalOffset = (eventsAtSameMinute.length - 1) * 28; // 28px di offset per ogni evento
                                
                                // Determina icona e colore
                                let icon = 'üìå';
                                let bgColor = 'bg-gray-500';
                                
                                if (evento.tipo === 'gol') {
                                  icon = '‚öΩ';
                                  bgColor = 'bg-green-500';
                                } else if (evento.tipo === 'golsubito') {
                                  icon = 'üî¥';
                                  bgColor = 'bg-red-600';
                                } else if (evento.tipo === 'assist') {
                                  icon = 'üéØ';
                                  bgColor = 'bg-blue-500';
                                } else if (evento.tipo === 'giallo') {
                                  icon = 'üü®';
                                  bgColor = 'bg-yellow-400';
                                } else if (evento.tipo === 'rosso') {
                                  icon = 'üü•';
                                  bgColor = 'bg-red-500';
                                } else {
                                  return null; // Non mostrare eventi sconosciuti
                                }
                                
                                return (
                                  <div 
                                    key={evento.id || `evento-${idx}`}
                                    className="absolute flex flex-col items-center"
                                    style={{ 
                                      left: `${Math.min(position, 95)}%`,
                                      top: `${verticalOffset}px`
                                    }}
                                    title={`${evento.playerNome} (${evento.tipo})`}
                                  >
                                    <div className={`w-4 h-4 ${bgColor} rounded-full flex items-center justify-center text-white text-xs font-bold`}>
                                      {icon}
                                    </div>
                                    <div className="text-xs text-gray-800 mt-1 whitespace-nowrap font-semibold">
                                      {evento.playerNome.split(' ')[0]}
                                    </div>
                                  </div>
                                );
                              })}
                              
                              {/* Sostituzioni sulla timeline */}
                              {Object.entries(match.sostituzioniDettaglio || {}).map(([playerNum, dettaglio]) => {
                                if (!dettaglio.minuto) return null;
                                
                                // Mostra solo per chi esce (sostituito), non duplicare per chi entra
                                if (!dettaglio.sostituito) return null;
                                
                                const position = (parseInt(dettaglio.minuto) / 90) * 100;
                                
                                // Trova giocatori
                                const playerOut = players.find(p => p.numero === parseInt(playerNum));
                                const playerIn = players.find(p => p.numero === dettaglio.sostituitoreDa);
                                
                                if (!playerOut || !playerIn) return null;
                                
                                // Estrai cognomi
                                const cognomeOut = playerOut.nome.split(' ')[0];
                                const cognomeIn = playerIn.nome.split(' ')[0];
                                
                                return (
                                  <div 
                                    key={`sost-${playerNum}`}
                                    className="absolute top-0 flex flex-col items-center"
                                    style={{ left: `${Math.min(position, 95)}%` }}
                                  >
                                    <div className="w-4 h-4 bg-yellow-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                      üîÑ
                                    </div>
                                    <div className="text-xs mt-1 whitespace-nowrap font-semibold">
                                      <div className="text-red-600">{cognomeOut}</div>
                                      <div className="text-green-600">{cognomeIn}</div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                          
                          {/* Legenda Timeline */}
                          <div className="flex items-center gap-2 justify-center mt-1 text-xs flex-wrap pb-1">
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                              <span>Gol</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                              <span>Assist</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-red-600 rounded-full"></div>
                              <span>Gol Subiti</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-yellow-400 rounded"></div>
                              <span>Gialli</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-red-500 rounded"></div>
                              <span>Rossi</span>
                            </div>
                            <div className="flex items-center gap-1">
                              <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
                              <span>Sostituzioni</span>
                            </div>
                          </div>
                        </div>

                      <div className="flex-1 overflow-y-auto">
                        <div className="p-4">
                        {substitutionMode && (
                          <div className="mb-4 p-4 bg-orange-100 border-2 border-orange-400 rounded-lg">
                            <div className="flex justify-between">
                              <div>
                                <h5 className="font-bold text-orange-800">üîÑ SOSTITUZIONE IN CORSO</h5>
                                <p className="text-sm text-orange-700">Esce: #{substitutionMode} - {players.find(p => p.numero === substitutionMode)?.nome}</p>
                              </div>
                              <button onClick={cancelSubstitution} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                                ‚úï Annulla
                              </button>
                            </div>
                          </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                          <div>
                            <h4 className="text-lg font-bold mb-3 text-green-700">‚öΩ IN CAMPO ({inCampo.length}/11)</h4>
                            <div className="space-y-2">
                              {inCampo.map(player => {
                                const isExpelled = (match.rossi_gioco[player.numero] > 0 || match.rossi_protesta[player.numero] > 0);
                                return (
                                <div key={player.numero} className={`border-2 rounded-lg p-3 relative ${
                                  isExpelled ? 'bg-gray-200 border-gray-400 opacity-40' :
                                  match.sostituzioni[player.numero] ? 'bg-red-200 border-red-500' : 
                                  substitutionMode === player.numero ? 'bg-orange-200 border-orange-600' : 
                                  match.entrati[player.numero] ? 'bg-blue-400 border-blue-700' : 'bg-green-100 border-green-400'
                                }`}
                                  style={isExpelled ? { pointerEvents: 'none' } : {}}
                                >
                                  {isExpelled && (
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30">
                                      <div className="bg-red-600 text-white font-black text-4xl px-6 py-3 rounded-lg shadow-2xl border-4 border-red-800" style={{textShadow: '2px 2px 4px rgba(0,0,0,0.8)'}}>
                                        ESPULSO
                                      </div>
                                    </div>
                                  )}
                                  <div className="flex justify-between mb-2 relative z-20">
                                    <div className="flex items-center gap-2">
                                      <span className="text-xl font-bold">#{(match.ordineDistinta || {})[player.numero] || player.numero}</span>
                                      <span className="font-semibold">{player.nome}</span>
                                      {match.entrati[player.numero] && (() => {
                                        const dettaglio = (match.sostituzioniDettaglio || {})[player.numero];
                                        if (dettaglio && dettaglio.alPostoDi) {
                                          const sostituito = players.find(p => p.numero === dettaglio.alPostoDi);
                                          return (
                                            <span className="px-2 py-1 bg-green-700 text-white rounded font-bold text-xs">
                                              ‚Üë ENTRATO al posto di #{dettaglio.alPostoDi} {sostituito ? sostituito.nome : ''}
                                            </span>
                                          );
                                        }
                                        return <span className="px-2 py-1 bg-green-700 text-white rounded font-bold text-xs">‚Üë ENTRATO</span>;
                                      })()}
                                      {match.sostituzioni[player.numero] && (() => {
                                        const dettaglio = (match.sostituzioniDettaglio || {})[player.numero];
                                        if (dettaglio && dettaglio.sostituitoreDa) {
                                          const sostitutore = players.find(p => p.numero === dettaglio.sostituitoreDa);
                                          return (
                                            <span className="px-2 py-1 bg-red-700 text-white rounded font-bold text-xs">
                                              ‚Üì SOSTITUITO da #{dettaglio.sostituitoreDa} {sostitutore ? sostitutore.nome : ''}
                                            </span>
                                          );
                                        }
                                        return null;
                                      })()}
                                      {(match.gialli_gioco[player.numero] > 0 || match.gialli_protesta[player.numero] > 0) && !match.rossi_gioco[player.numero] && !match.rossi_protesta[player.numero] && (
                                        <span className="px-2 py-1 bg-yellow-400 text-black rounded font-bold animate-pulse text-xs">‚ö†Ô∏è AMMONITO</span>
                                      )}
                                    </div>
                                    <div className="flex gap-1 text-xs">
                                      {player.ruolo === 'Portiere' ? (
                                        <span className="px-2 py-1 bg-red-600 text-white rounded font-bold">‚öΩ Subiti: {match.golSubiti[player.numero] || 0}</span>
                                      ) : (
                                        <>
                                          <span className="px-2 py-1 bg-green-600 text-white rounded">‚öΩ {match.golFatti[player.numero] || 0}</span>
                                          <span className="px-2 py-1 bg-blue-600 text-white rounded">üéØ {match.assist[player.numero] || 0}</span>
                                        </>
                                      )}
                                    </div>
                                  </div>
                                  {!substitutionMode && (
                                    <div className="flex gap-2 flex-wrap relative z-20">
                                      {player.ruolo === 'Portiere' ? (
                                        <>
                                          <button onClick={() => quickAddGoalConceded(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="flex-1 px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">
                                            ‚öΩ GOL SUBITO
                                          </button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">üü®</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">üü•</button>
                                        </>
                                      ) : (
                                        <>
                                          <button onClick={() => quickAddGoal(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold text-sm">‚öΩ GOL</button>
                                          <button onClick={() => quickAddAssist(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold text-sm">üéØ ASSIST</button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">üü®</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} disabled={match.sostituzioni[player.numero]} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">üü•</button>
                                        </>
                                      )}
                                    </div>
                                  )}
                                  {!match.sostituzioni[player.numero] && !substitutionMode && (
                                    <button onClick={() => initiateSubstitution(player.numero)} className="w-full mt-2 px-3 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 font-semibold text-sm relative z-20">
                                      üîÑ SOSTITUISCI
                                    </button>
                                  )}
                                </div>
                              );})}
                            </div>
                          </div>

                          <div>
                            <h4 className="text-lg font-bold mb-3 text-gray-700">ü™ë PANCHINA</h4>
                            <div className="space-y-2">
                              {panchina.map(player => {
                                const isExpelled = (match.rossi_gioco[player.numero] > 0 || match.rossi_protesta[player.numero] > 0);
                                const isSubstituted = match.sostituzioni[player.numero];
                                return (
                                <div key={player.numero} className={`border-2 rounded-lg p-3 relative ${
                                  isExpelled || isSubstituted ? 'bg-gray-200 border-gray-400 opacity-40' :
                                  match.entrati[player.numero] ? 'bg-blue-400 border-blue-700' : 
                                  substitutionMode ? 'bg-yellow-100 border-yellow-400 cursor-pointer hover:border-yellow-600' : 'bg-gray-100 border-gray-300'
                                }`}
                                  onClick={() => {
                                    if (substitutionMode && !match.entrati[player.numero] && !isSubstituted && !isExpelled) {
                                      completeSubstitution(liveMatchMode, substitutionMode, player.numero);
                                    }
                                  }}
                                  style={(isSubstituted || isExpelled) ? { pointerEvents: 'none' } : {}}
                                >
                                  {isExpelled && (
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30">
                                      <div className="bg-red-600 text-white font-black text-3xl px-4 py-2 rounded-lg shadow-2xl border-4 border-red-800" style={{textShadow: '2px 2px 4px rgba(0,0,0,0.8)'}}>
                                        ESPULSO
                                      </div>
                                    </div>
                                  )}
                                  <div className="flex justify-between mb-2 relative z-20">
                                    <div className="flex items-center gap-2">
                                      <span className="text-xl font-bold">#{(match.ordineDistinta || {})[player.numero] || player.numero}</span>
                                      <span className="font-semibold">{player.nome}</span>
                                      {match.sostituzioni[player.numero] && (() => {
                                        const dettaglio = (match.sostituzioniDettaglio || {})[player.numero];
                                        if (dettaglio && dettaglio.sostituitoreDa) {
                                          const sostitutore = players.find(p => p.numero === dettaglio.sostituitoreDa);
                                          return (
                                            <span className="px-2 py-1 bg-red-700 text-white rounded font-bold text-xs">
                                              ‚Üì SOSTITUITO da #{dettaglio.sostituitoreDa} {sostitutore ? sostitutore.nome : ''}
                                            </span>
                                          );
                                        }
                                        return <span className="px-2 py-1 bg-red-600 text-white rounded font-bold text-xs">‚Üì SOSTITUITO</span>;
                                      })()}
                                      {match.entrati[player.numero] && (match.gialli_gioco[player.numero] > 0 || match.gialli_protesta[player.numero] > 0) && !match.rossi_gioco[player.numero] && (
                                        <span className="px-2 py-1 bg-yellow-400 text-black rounded font-bold animate-pulse text-xs">‚ö†Ô∏è AMMONITO</span>
                                      )}
                                    </div>
                                    {match.entrati[player.numero] && !match.sostituzioni[player.numero] && (
                                      <div className="flex gap-1 text-xs">
                                        <span className="px-2 py-1 bg-green-700 text-white rounded font-semibold">‚Üë ENTRATO</span>
                                        {player.ruolo === 'Portiere' ? (
                                          <span className="px-2 py-1 bg-red-600 text-white rounded font-bold">‚öΩ Subiti: {match.golSubiti[player.numero] || 0}</span>
                                        ) : (
                                          <>
                                            <span className="px-2 py-1 bg-green-600 text-white rounded">‚öΩ {match.golFatti[player.numero] || 0}</span>
                                            <span className="px-2 py-1 bg-blue-600 text-white rounded">üéØ {match.assist[player.numero] || 0}</span>
                                          </>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                  {!match.entrati[player.numero] && !substitutionMode && (
                                    <button 
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        showConfirm(`‚ñ∂ Confermi l'INGRESSO IN CAMPO di ${player.nome} (#${player.numero})?`, () => {
                                          updateMatch(liveMatchMode, 'entrati', { ...match.entrati, [player.numero]: true });
                                        });
                                      }} 
                                      className="w-full px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold text-sm relative z-20"
                                    >
                                      ‚ñ∂ ENTRA IN CAMPO
                                    </button>
                                  )}
                                  {match.entrati[player.numero] && !substitutionMode && (
                                    <div className="flex gap-2 flex-wrap mt-2 relative z-20">
                                      {player.ruolo === 'Portiere' ? (
                                        <>
                                          <button onClick={() => quickAddGoalConceded(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="flex-1 px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">‚öΩ GOL SUBITO</button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">üü®</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">üü•</button>
                                        </>
                                      ) : (
                                        <>
                                          <button onClick={() => quickAddGoal(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold text-sm">‚öΩ GOL</button>
                                          <button onClick={() => quickAddAssist(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold text-sm">üéØ ASSIST</button>
                                          <button onClick={() => quickAddYellowCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500 font-semibold text-sm">üü®</button>
                                          <button onClick={() => quickAddRedCard(liveMatchMode, player.numero, Math.floor(matchTimer / 60))} className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold text-sm">üü•</button>
                                        </>
                                      )}
                                    </div>
                                  )}
                                </div>
                              );})}
                            </div>
                          </div>
                        </div>
                      </div>
                      </div>
                    </>
                  );
                })()}
              </div>
            </div>
          </div>
        )}

        {/* ============================================ */}
        {/* TAB CALENDARIO - NUOVO */}
        {/* ============================================ */}
        {activeTab === 'calendar' && (
          <div className="animate-fade-in">
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">üìÖ Calendario Eventi</h2>
              <p className="text-gray-600">Vista mensile di allenamenti e partite programmate</p>
            </div>

            {/* Controlli Mese/Anno */}
            <div className="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6 border-2 border-gray-200">
              <div className="flex items-center justify-between gap-2 mb-4">
                <button
                  onClick={() => {
                    if (selectedMonth === 0) {
                      setSelectedMonth(11);
                      setSelectedYear(selectedYear - 1);
                    } else {
                      setSelectedMonth(selectedMonth - 1);
                    }
                  }}
                  className="px-2 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs md:text-base whitespace-nowrap"
                >
                  <span className="hidden md:inline">‚Üê Mese Prec.</span>
                  <span className="md:hidden">‚Üê</span>
                </button>
                <h3 className="text-base md:text-2xl font-bold text-gray-800 text-center flex-1 min-w-0 px-2">
                  {new Date(selectedYear, selectedMonth).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}
                </h3>
                <button
                  onClick={() => {
                    if (selectedMonth === 11) {
                      setSelectedMonth(0);
                      setSelectedYear(selectedYear + 1);
                    } else {
                      setSelectedMonth(selectedMonth + 1);
                    }
                  }}
                  className="px-2 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs md:text-base whitespace-nowrap"
                >
                  <span className="hidden md:inline">Mese Succ. ‚Üí</span>
                  <span className="md:hidden">‚Üí</span>
                </button>
              </div>

              {/* Calendario Grid */}
              <div className="calendar-grid mb-4">
                {['L', 'M', 'M', 'G', 'V', 'S', 'D'].map((day, idx) => (
                  <div key={idx} className="text-center font-bold text-gray-600 p-2">
                    {day}
                  </div>
                ))}
                
                {/* Giorni vuoti iniziali */}
                {Array.from({ length: getFirstDayOfMonth(selectedMonth, selectedYear) === 0 ? 6 : getFirstDayOfMonth(selectedMonth, selectedYear) - 1 }).map((_, idx) => (
                  <div key={`empty-${idx}`} className="calendar-day opacity-0"></div>
                ))}
                
                {/* Giorni del mese */}
                {Array.from({ length: getDaysInMonth(selectedMonth, selectedYear) }).map((_, idx) => {
                  const day = idx + 1;
                  const date = new Date(selectedYear, selectedMonth, day);
                  const dateStr = date.toISOString().split('T')[0];
                  const events = getEventsForDate(date);
                  const isToday = new Date().toDateString() === date.toDateString();
                  const hasTrainings = events.trainings.length > 0;
                  const hasMatches = events.matches.length > 0;
                  const hasEvents = hasTrainings || hasMatches;
                  
                  // Determina classe evento
                  let eventClass = '';
                  if (hasTrainings && hasMatches) {
                    eventClass = 'has-both';
                  } else if (hasTrainings) {
                    eventClass = 'has-training';
                  } else if (hasMatches) {
                    eventClass = 'has-match';
                  }
                  
                  return (
                    <div
                      key={day}
                      className={`calendar-day ${isToday ? 'today' : ''} ${eventClass}`}
                      onClick={() => {
                        if (hasEvents) {
                          setSelectedDate(date);
                          setShowEventModal(true);
                        }
                      }}
                    >
                      <div className="font-semibold mb-1">{day}</div>
                      <div className="space-y-1 hidden md:block">
                        {events.trainings.length > 0 && (
                          <div className="text-xs bg-blue-200 text-blue-800 rounded px-1">
                            üèÉ {events.trainings.length}
                          </div>
                        )}
                        {events.matches.length > 0 && (
                          <div className="text-xs bg-green-200 text-green-800 rounded px-1">
                            ‚öΩ {events.matches.length}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Legenda */}
              <div className="flex flex-wrap items-center gap-2 md:gap-4 justify-center text-xs md:text-sm">
                <div className="flex items-center gap-1 md:gap-2">
                  <div className="w-3 h-3 md:w-4 md:h-4 bg-blue-200 rounded"></div>
                  <span>üèÉ Allenamento</span>
                </div>
                <div className="flex items-center gap-1 md:gap-2">
                  <div className="w-3 h-3 md:w-4 md:h-4 bg-green-200 rounded"></div>
                  <span>‚öΩ Partita</span>
                </div>
                <div className="flex items-center gap-1 md:gap-2">
                  <div className="w-3 h-3 md:w-4 md:h-4 bg-blue-100 border-2 border-blue-600 rounded"></div>
                  <span>üìÖ Oggi</span>
                </div>
              </div>
            </div>

            {/* Prossimi Eventi */}
            <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
              <h3 className="text-xl font-bold text-gray-800 mb-4">üìã Prossimi Eventi</h3>
              <div className="space-y-3">
                {[...trainings, ...matches]
                  .filter(e => new Date(e.data) >= new Date())
                  .sort((a, b) => new Date(a.data) - new Date(b.data))
                  .slice(0, 5)
                  .map((event, idx) => {
                    const isMatch = event.squadraCasa !== undefined;
                    return (
                      <div key={idx} className={`flex items-center justify-between p-3 rounded-lg ${isMatch ? 'bg-green-50 border-2 border-green-200' : 'bg-blue-50 border-2 border-blue-200'}`}>
                        <div className="flex items-center gap-3">
                          <div className="text-3xl">{isMatch ? '‚öΩ' : 'üèÉ'}</div>
                          <div>
                            <div className="font-semibold text-gray-800">
                              {isMatch ? `${event.squadraCasa} vs ${event.squadraTrasferta}` : 'Allenamento'}
                            </div>
                            <div className="text-sm text-gray-600">
                              {new Date(event.data).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}
                            </div>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm font-semibold text-gray-700">
                            {Math.ceil((new Date(event.data) - new Date()) / (1000 * 60 * 60 * 24))} giorni
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>
          </div>
        )}

        {/* Modal Eventi Giorno */}
        {showEventModal && selectedDate && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto animate-scale-up">
              <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold">
                    üìÖ {selectedDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                  </h3>
                  <button
                    onClick={() => setShowEventModal(false)}
                    className="text-white hover:text-gray-200 text-3xl font-bold"
                  >
                    √ó
                  </button>
                </div>
              </div>
              
              <div className="p-6">
                {(() => {
                  const events = getEventsForDate(selectedDate);
                  return (
                    <div className="space-y-4">
                      {events.trainings.length > 0 && (
                        <div>
                          <h4 className="text-lg font-bold text-gray-800 mb-3">üèÉ Allenamenti ({events.trainings.length})</h4>
                          {events.trainings.map(t => {
                            const presenti = players.filter(p => p.nome && t.presenze && t.presenze[p.nome] === true);
                            const assenti = players.filter(p => p.nome && t.presenze && t.presenze[p.nome] === false);
                            
                            return (
                              <div key={t.id} className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <div className="font-semibold text-gray-800 mb-3">
                                  Presenze: {presenti.length}/{players.filter(p => p.nome).length}
                                </div>
                                
                                {presenti.length > 0 && (
                                  <div className="mb-3">
                                    <div className="text-sm font-bold text-green-700 mb-1">‚úÖ Presenti ({presenti.length}):</div>
                                    <div className="flex flex-wrap gap-1">
                                      {presenti.map(p => (
                                        <span key={p.nome} className="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                                          {p.nome}
                                        </span>
                                      ))}
                                    </div>
                                  </div>
                                )}
                                
                                {assenti.length > 0 && (
                                  <div>
                                    <div className="text-sm font-bold text-red-700 mb-1">‚ùå Assenti ({assenti.length}):</div>
                                    <div className="flex flex-wrap gap-1">
                                      {assenti.map(p => (
                                        <span key={p.nome} className="inline-block bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-medium">
                                          {p.nome}
                                        </span>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      )}
                      
                      {events.matches.length > 0 && (
                        <div>
                          <h4 className="text-lg font-bold text-gray-800 mb-3">‚öΩ Partite ({events.matches.length})</h4>
                          {events.matches.map(m => (
                            <div key={m.id} className="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                              <div className="font-bold text-xl text-gray-800 mb-2 text-center">
                                {m.squadraCasa || 'Casa'} vs {m.squadraTrasferta || m.avversario || 'Trasferta'}
                              </div>
                              {m.risultato ? (
                                <div className="text-center">
                                  <div className="text-3xl font-bold text-green-600 mb-1">{m.risultato}</div>
                                  <div className="text-sm text-gray-600">Risultato Finale</div>
                                </div>
                              ) : (
                                <div className="text-center text-gray-500 text-sm">
                                  Partita da giocare
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {events.trainings.length === 0 && events.matches.length === 0 && (
                        <div className="text-center text-gray-500 py-8">
                          Nessun evento in questa data
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
            </div>
          </div>
        )}

        {/* ============================================ */}
        {/* TAB GESTIONE INFORTUNI - NUOVO */}
        {/* ============================================ */}
        {activeTab === 'injuries' && (
          <div className="animate-fade-in">
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">ü§ï Gestione Infortuni</h2>
              <p className="text-gray-600">Traccia e gestisci gli infortuni dei giocatori</p>
            </div>

            {/* Pulsante Nuovo Infortunio */}
            <div className="mb-6">
              <button
                onClick={() => setShowInjuryModal(true)}
                disabled={userRole !== 'admin'}
                className={`flex items-center gap-2 px-6 py-3 rounded-lg transition-colors font-semibold ${
                  userRole === 'admin'
                    ? 'bg-red-600 text-white hover:bg-red-700'
                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                }`}
                title={userRole !== 'admin' ? 'Solo Admin pu√≤ registrare infortuni' : ''}
              >
                <Plus size={20} />
                Registra Nuovo Infortunio
              </button>
            </div>

            {/* Statistiche Infortuni */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg shadow-lg p-6 border-2 border-red-200">
                <div className="text-4xl mb-2">ü§ï</div>
                <div className="text-3xl font-bold text-red-600">{getActiveInjuries().length}</div>
                <div className="text-gray-700 font-semibold">Infortuni Attivi</div>
              </div>
              
              <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg shadow-lg p-6 border-2 border-yellow-200">
                <div className="text-4xl mb-2">üìà</div>
                <div className="text-3xl font-bold text-yellow-600">
                  {injuries.filter(i => i.status === 'recovering').length}
                </div>
                <div className="text-gray-700 font-semibold">In Recupero</div>
              </div>
              
              <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200">
                <div className="text-4xl mb-2">‚úÖ</div>
                <div className="text-3xl font-bold text-green-600">
                  {injuries.filter(i => i.status === 'recovered').length}
                </div>
                <div className="text-gray-700 font-semibold">Recuperati</div>
              </div>
            </div>

            {/* Lista Infortuni Attivi */}
            {getActiveInjuries().length > 0 && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6 border-2 border-red-200">
                <h3 className="text-xl font-bold text-gray-800 mb-4">üö® Infortuni Attivi</h3>
                <div className="space-y-4">
                  {getActiveInjuries().map(injury => {
                    const daysSince = Math.floor((new Date() - new Date(injury.startDate)) / (1000 * 60 * 60 * 24));
                    const daysUntil = Math.ceil((new Date(injury.estimatedReturn) - new Date()) / (1000 * 60 * 60 * 24));
                    const totalDays = Math.ceil((new Date(injury.estimatedReturn) - new Date(injury.startDate)) / (1000 * 60 * 60 * 24));
                    const progress = Math.min(100, Math.max(0, (daysSince / totalDays) * 100));
                    
                    return (
                      <div key={injury.id} className="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                              <h4 className="text-lg font-bold text-gray-800">{injury.playerName}</h4>
                              <span className="text-sm text-gray-600">#{injury.playerNum}</span>
                            </div>
                            <div className="space-y-1 text-sm text-gray-700">
                              <div><strong>Tipo:</strong> {injury.type}</div>
                              <div><strong>Dal:</strong> {new Date(injury.startDate).toLocaleDateString('it-IT')}</div>
                              <div><strong>Rientro stimato:</strong> {new Date(injury.estimatedReturn).toLocaleDateString('it-IT')} 
                                <span className="ml-2 font-semibold text-red-600">
                                  ({daysUntil > 0 ? `${daysUntil} giorni` : 'Oggi o passato'})
                                </span>
                              </div>
                              {injury.notes && <div><strong>Note:</strong> {injury.notes}</div>}
                            </div>
                          </div>
                          <div 
                            className="flex gap-2"
                            style={userRole !== 'admin' ? {pointerEvents: 'none', opacity: 0.5} : {}}
                          >
                            <button
                              onClick={() => updateInjuryStatus(injury.id, 'recovering')}
                              className="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm"
                              title="Segna come in recupero"
                            >
                              üìà
                            </button>
                            <button
                              onClick={() => updateInjuryStatus(injury.id, 'recovered')}
                              className="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm"
                              title="Segna come recuperato"
                            >
                              ‚úÖ
                            </button>
                            <button
                              onClick={() => removeInjury(injury.id)}
                              className="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm"
                              title="Rimuovi"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        </div>
                        
                        {/* Progress Bar Recupero */}
                        <div className="mt-3">
                          <div className="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Progresso recupero</span>
                            <span>{progress.toFixed(0)}%</span>
                          </div>
                          <div className="progress-bar">
                            <div 
                              className="progress-bar-fill"
                              style={{
                                width: `${progress}%`,
                                background: progress < 33 ? '#ef4444' : progress < 66 ? '#f59e0b' : '#10b981'
                              }}
                            ></div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Tutti gli Infortuni (con filtro stato) */}
            <div className="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200">
              <h3 className="text-xl font-bold text-gray-800 mb-4">üìã Storico Completo</h3>
              {injuries.length === 0 ? (
                <div className="text-center text-gray-500 py-8">
                  Nessun infortunio registrato
                </div>
              ) : (
                <div className="space-y-3">
                  {injuries.map(injury => (
                    <div key={injury.id} className={`rounded-lg p-4 border-2 ${
                      injury.status === 'active' ? 'bg-red-50 border-red-200' :
                      injury.status === 'recovering' ? 'bg-yellow-50 border-yellow-200' :
                      'bg-green-50 border-green-200'
                    }`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3 flex-1">
                          <span className={`injury-badge ${injury.status}`}>
                            {injury.status === 'active' ? 'ü§ï Attivo' :
                             injury.status === 'recovering' ? 'üìà Recupero' :
                             '‚úÖ Recuperato'}
                          </span>
                          <div>
                            <div className="font-semibold text-gray-800">{injury.playerName} #{injury.playerNum}</div>
                            <div className="text-sm text-gray-600">{injury.type}</div>
                          </div>
                        </div>
                        <div className="flex items-center gap-4">
                          <div className="text-sm text-gray-600">
                            {new Date(injury.startDate).toLocaleDateString('it-IT')} ‚Üí {new Date(injury.estimatedReturn).toLocaleDateString('it-IT')}
                          </div>
                          {userRole === 'admin' && (
                            <div className="flex gap-2">
                              <button
                                onClick={() => {
                                  setEditingInjury(injury);
                                  setShowEditInjuryModal(true);
                                }}
                                className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm font-semibold"
                                title="Modifica infortunio"
                              >
                                ‚úèÔ∏è
                              </button>
                              <button
                                onClick={() => removeInjury(injury.id)}
                                className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm font-semibold"
                                title="Elimina infortunio"
                              >
                                üóëÔ∏è
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Modal Nuovo Infortunio */}
        {showInjuryModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full animate-scale-up">
              <div className="bg-gradient-to-r from-red-600 to-red-800 text-white p-6 rounded-t-lg">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold">ü§ï Registra Nuovo Infortunio</h3>
                  <button
                    onClick={() => {
                      setShowInjuryModal(false);
                      setSelectedPlayerForInjury(null);
                    }}
                    className="text-white hover:text-gray-200 text-3xl font-bold"
                  >
                    √ó
                  </button>
                </div>
              </div>
              
              <div className="p-6">
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Giocatore</label>
                    <select
                      value={selectedPlayerForInjury || ''}
                      onChange={(e) => setSelectedPlayerForInjury(parseInt(e.target.value))}
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    >
                      <option value="">Seleziona giocatore...</option>
                      {players.filter(p => p.nome).map(p => (
                        <option key={p.numero} value={p.numero}>
                          #{p.numero} - {p.nome}
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Tipo di Infortunio</label>
                    <input
                      type="text"
                      id="injuryType"
                      placeholder="Es: Distorsione caviglia, Stiramento muscolare..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    />
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Data Inizio</label>
                      <input
                        type="date"
                        id="injuryStartDate"
                        defaultValue={new Date().toISOString().split('T')[0]}
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Rientro Stimato</label>
                      <input
                        type="date"
                        id="injuryReturnDate"
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Note (opzionale)</label>
                    <textarea
                      id="injuryNotes"
                      rows="3"
                      placeholder="Descrizione, trattamenti, raccomandazioni..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    ></textarea>
                  </div>
                  
                  <button
                    onClick={() => {
                      if (!selectedPlayerForInjury) {
                        showToast('Seleziona un giocatore!', 'warning');
                        return;
                      }
                      
                      const type = document.getElementById('injuryType').value;
                      const startDate = document.getElementById('injuryStartDate').value;
                      const returnDate = document.getElementById('injuryReturnDate').value;
                      const notes = document.getElementById('injuryNotes').value;
                      
                      if (!type || !returnDate) {
                        showToast('Compila tutti i campi obbligatori!', 'warning');
                        return;
                      }
                      
                      addInjury(selectedPlayerForInjury, {
                        type,
                        startDate,
                        estimatedReturn: returnDate,
                        notes
                      });
                      
                      setShowInjuryModal(false);
                      setSelectedPlayerForInjury(null);
                    }}
                    className="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold"
                  >
                    Registra Infortunio
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Modifica Infortunio */}
        {showEditInjuryModal && editingInjury && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full animate-scale-up">
              <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg">
                <div className="flex justify-between items-center">
                  <h3 className="text-2xl font-bold">‚úèÔ∏è Modifica Infortunio</h3>
                  <button
                    onClick={() => {
                      setShowEditInjuryModal(false);
                      setEditingInjury(null);
                    }}
                    className="text-white hover:text-gray-200 text-3xl font-bold"
                  >
                    √ó
                  </button>
                </div>
              </div>
              
              <div className="p-6">
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Giocatore</label>
                    <div className="w-full px-4 py-2 bg-gray-100 border-2 border-gray-300 rounded-lg">
                      #{editingInjury.playerNum} - {editingInjury.playerName}
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Tipo di Infortunio</label>
                    <input
                      type="text"
                      id="editInjuryType"
                      defaultValue={editingInjury.type}
                      placeholder="Es: Distorsione caviglia, Stiramento muscolare..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Stato</label>
                    <select
                      id="editInjuryStatus"
                      defaultValue={editingInjury.status}
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    >
                      <option value="active">ü§ï Attivo</option>
                      <option value="recovering">üìà In Recupero</option>
                      <option value="recovered">‚úÖ Recuperato</option>
                    </select>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Data Inizio</label>
                      <input
                        type="date"
                        id="editInjuryStartDate"
                        defaultValue={editingInjury.startDate}
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Rientro Stimato</label>
                      <input
                        type="date"
                        id="editInjuryReturnDate"
                        defaultValue={editingInjury.estimatedReturn}
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Note (opzionale)</label>
                    <textarea
                      id="editInjuryNotes"
                      rows="3"
                      defaultValue={editingInjury.notes || ''}
                      placeholder="Descrizione, trattamenti, raccomandazioni..."
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                    ></textarea>
                  </div>
                  
                  <button
                    onClick={() => {
                      const type = document.getElementById('editInjuryType').value;
                      const status = document.getElementById('editInjuryStatus').value;
                      const startDate = document.getElementById('editInjuryStartDate').value;
                      const returnDate = document.getElementById('editInjuryReturnDate').value;
                      const notes = document.getElementById('editInjuryNotes').value;
                      
                      if (!type || !returnDate) {
                        showToast('Compila tutti i campi obbligatori!', 'warning');
                        return;
                      }
                      
                      // Aggiorna l'infortunio
                      setInjuries(injuries.map(inj => 
                        inj.id === editingInjury.id 
                          ? {
                              ...inj,
                              type,
                              status,
                              startDate,
                              estimatedReturn: returnDate,
                              notes
                            }
                          : inj
                      ));
                      
                      showToast('Infortunio aggiornato!', 'success');
                      setShowEditInjuryModal(false);
                      setEditingInjury(null);
                    }}
                    className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                  >
                    Salva Modifiche
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Votazione MVP */}
        {showMVPModal && selectedMatchForMVP && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-3xl w-full animate-scale-up max-h-[90vh] overflow-y-auto">
              {(() => {
                const match = matches.find(m => m.id === selectedMatchForMVP);
                if (!match) return null;
                
                const convocati = players.filter(p => match.convocati[p.numero]);
                
                return (
                  <>
                    <div className="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-6 rounded-t-lg sticky top-0 z-10">
                      <div className="flex justify-between items-center">
                        <div>
                          <h3 className="text-2xl font-bold">üèÜ Man of the Match</h3>
                          <p className="text-yellow-100 mt-1">
                            {match.squadraCasa} vs {match.squadraTrasferta}
                          </p>
                        </div>
                        <button
                          onClick={() => {
                            setShowMVPModal(false);
                            setSelectedMatchForMVP(null);
                          }}
                          className="text-white hover:text-yellow-200 text-3xl font-bold"
                        >
                          √ó
                        </button>
                      </div>
                    </div>
                    
                    <div className="p-6">
                      <div className="mb-4">
                        <p className="text-gray-600 text-center">
                          Chi √® stato il migliore in campo? ‚≠ê
                        </p>
                      </div>
                      
                      {convocati.length === 0 ? (
                        <div className="text-center py-8 text-gray-500">
                          Nessun giocatore convocato per questa partita
                        </div>
                      ) : (
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                          {convocati.map(player => {
                            const isCurrentMVP = match.mvp === player.numero;
                            const gol = match.golFatti[player.numero] || 0;
                            const assist = match.assist[player.numero] || 0;
                            
                            return (
                              <button
                                key={player.numero}
                                onClick={() => assignMVP(match.id, player.numero)}
                                className={`relative p-4 rounded-lg border-2 transition-all hover:scale-105 ${
                                  isCurrentMVP
                                    ? 'bg-gradient-to-br from-yellow-100 to-yellow-200 border-yellow-500 shadow-lg'
                                    : 'bg-white border-gray-200 hover:border-yellow-400 hover:shadow-md'
                                }`}
                              >
                                {isCurrentMVP && (
                                  <div className="absolute -top-2 -right-2 bg-yellow-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg animate-pulse-slow">
                                    üèÜ
                                  </div>
                                )}
                                
                                <div className="flex flex-col items-center">
                                  {player.foto ? (
                                    <img
                                      src={player.foto}
                                      alt={player.nome}
                                      className="w-16 h-16 rounded-full object-cover mb-2 border-2 border-gray-200"
                                    />
                                  ) : (
                                    <div className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mb-2 border-2 border-gray-300">
                                      <span className="text-2xl font-bold text-gray-500">
                                        {player.numero}
                                      </span>
                                    </div>
                                  )}
                                  
                                  <div className="text-center">
                                    <p className="font-bold text-sm text-gray-800 mb-1">
                                      {player.nome.split(' ')[0]}
                                    </p>
                                    <p className="text-xs text-gray-600 mb-2 line-clamp-2">
                                      {player.nome}
                                    </p>
                                    
                                    {(gol > 0 || assist > 0) && (
                                      <div className="flex justify-center gap-2 text-xs">
                                        {gol > 0 && (
                                          <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded">
                                            ‚öΩ {gol}
                                          </span>
                                        )}
                                        {assist > 0 && (
                                          <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                                            üéØ {assist}
                                          </span>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      )}
                      
                      {match.mvp && (
                        <div className="mt-6 pt-6 border-t border-gray-200">
                          <button
                            onClick={() => {
                              removeMVP(match.id);
                              setShowMVPModal(false);
                              setSelectedMatchForMVP(null);
                            }}
                            className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg transition-colors font-semibold"
                          >
                            üîÑ Rimuovi MVP
                          </button>
                        </div>
                      )}
                    </div>
                  </>
                );
              })()}
            </div>
          </div>
        )}

        {activeTab === 'export' && (
          <div className="space-y-6">
            {userRole !== 'admin' ? (
              // Accesso negato per user
              <div className="bg-red-50 border-2 border-red-300 rounded-lg p-12 text-center animate-fade-in">
                <div className="text-6xl mb-4">üîí</div>
                <h2 className="text-2xl font-bold text-red-900 mb-2">Accesso Negato</h2>
                <p className="text-red-700 mb-4">
                  Solo gli amministratori possono accedere alle esportazioni e ai backup del database.
                </p>
                <button
                  onClick={() => setActiveTab('dashboard')}
                  className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                >
                  ‚Üê Torna alla Dashboard
                </button>
              </div>
            ) : (
              // Contenuto normale per admin
              <div>
            <h2 className="text-2xl font-bold text-gray-800 mb-6">üíæ Esportazioni e Backup</h2>
            
            {/* ========== SEZIONE ESPORTAZIONI ========== */}
            <div>
              <h3 className="text-xl font-bold text-gray-700 mb-4">üìä Esportazioni</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-6 border-2 border-blue-200">
                  <div className="text-4xl mb-4">üìä</div>
                  <h3 className="text-xl font-bold text-gray-800 mb-2">Report Stagionale</h3>
                  <p className="text-gray-600 text-sm mb-4">
                    Esporta un report completo con tutte le statistiche della stagione in PDF
                  </p>
                  <button
                    onClick={downloadSeasonReportPDF}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    Scarica Report PDF
                  </button>
                </div>
                
                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200">
                  <div className="text-4xl mb-4">üë§</div>
                  <h3 className="text-xl font-bold text-gray-800 mb-2">Scheda Giocatore</h3>
                  <p className="text-gray-600 text-sm mb-4">
                    Esporta la scheda dettagliata di un singolo giocatore con tutte le sue statistiche
                  </p>
                  <select 
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-3"
                    id="playerSelect"
                  >
                    <option value="">Seleziona giocatore...</option>
                    {players.filter(p => p.nome).map(p => (
                      <option key={p.numero} value={p.numero}>#{p.numero} - {p.nome}</option>
                    ))}
                  </select>
                  <button
                    onClick={() => {
                      const select = document.getElementById('playerSelect');
                      const playerNum = parseInt(select.value);
                      if (playerNum) {
                        downloadPlayerCardPDF(playerNum);
                      } else {
                        alert('Seleziona un giocatore!');
                      }
                    }}
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    Scarica Scheda PDF
                  </button>
                </div>
                
                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-lg p-6 border-2 border-purple-200">
                  <div className="text-4xl mb-4">üíæ</div>
                  <h3 className="text-xl font-bold text-gray-800 mb-2">Backup Completo</h3>
                  <p className="text-gray-600 text-sm mb-4">
                    Scarica un backup completo di tutti i dati in formato JSON
                  </p>
                  <button
                    onClick={downloadBackupJSON}
                    className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    Scarica Backup JSON
                  </button>
                </div>
              </div>
              
              <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-6 mt-6">
                <div className="flex items-start gap-3">
                  <div className="text-2xl">‚ÑπÔ∏è</div>
                  <div>
                    <h4 className="font-bold text-gray-800 mb-2">Note sulle esportazioni:</h4>
                    <ul className="text-sm text-gray-700 space-y-1">
                      <li>‚Ä¢ Il <strong>Report Stagionale</strong> include statistiche generali, top marcatori, assist e rosa completa</li>
                      <li>‚Ä¢ La <strong>Scheda Giocatore</strong> contiene foto, dati anagrafici e statistiche dettagliate individuali</li>
                      <li>‚Ä¢ Il <strong>Backup JSON</strong> pu√≤ essere reimportato in seguito per ripristinare tutti i dati</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            
            {/* ========== SEZIONE BACKUP E RESET ========== */}
            <div className="pt-6 border-t-4 border-gray-200">
              <h3 className="text-xl font-bold text-gray-700 mb-4">üíæ Gestione Backup e Reset Stagione</h3>
              
              <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
                <h3 className="text-xl font-bold text-gray-800 mb-4">üíæ Gestione Backup (Opzionale)</h3>
                <div className="mb-4 p-4 bg-green-50 border-2 border-green-400 rounded-lg">
                  <p className="font-bold text-green-800 mb-2">‚úÖ I tuoi dati sono salvati automaticamente sul dispositivo</p>
                  <p className="text-sm text-green-900">
                    Usa queste funzioni solo se vuoi:
                  </p>
                  <ul className="list-disc ml-6 mt-2 text-sm text-green-900">
                    <li><strong>Trasferire i dati</strong> su un altro dispositivo</li>
                    <li><strong>Creare un backup</strong> di sicurezza su cloud (Google Drive, Dropbox, ecc.)</li>
                    <li><strong>Ripristinare</strong> dati da un file di backup precedente</li>
                  </ul>
                </div>
                <div className="flex gap-4 flex-wrap">
                  <label className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors cursor-pointer">
                    <Download size={20} className="rotate-180" />
                    üì± Importa da File JSON
                    <input
                      type="file"
                      accept=".json,application/json,text/plain"
                      onChange={handleFileImport}
                      className="hidden"
                      multiple={false}
                    />
                  </label>
                  <button
                    onClick={() => setShowManualImport(true)}
                    className="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors"
                  >
                    üìã Importa Manualmente
                  </button>
                  <button
                    onClick={exportToJSON}
                    className="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors"
                  >
                    <Download size={20} />
                    üíæ Scarica Backup JSON
                  </button>
                </div>
              </div>

              <div className="bg-white rounded-lg shadow-xl p-6 border-2 border-red-200">
                <h3 className="text-xl font-bold text-red-700 mb-4">üî¥ Reset Database - Nuova Stagione</h3>
                <div className="mb-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                  <p className="font-bold text-red-800 mb-2">‚ö†Ô∏è ATTENZIONE: Operazioni Permanenti</p>
                  <p className="text-sm text-red-900">
                    Usa queste funzioni solo quando devi iniziare una nuova stagione o resettare completamente l'app.
                  </p>
                  <p className="text-sm text-red-900 font-bold mt-2">
                    üí° CONSIGLIO: Crea un backup prima di resettare!
                  </p>
                </div>
                
                <div className="space-y-4">
                  <div className="p-4 bg-orange-50 border-2 border-orange-300 rounded-lg">
                    <h4 className="font-bold text-orange-900 mb-2">üîÑ Reset Stagione (consigliato)</h4>
                    <p className="text-sm text-orange-800 mb-3">
                      Cancella allenamenti, partite e statistiche ma <strong>mantiene la rosa giocatori</strong> e il logo.
                      Ideale per iniziare una nuova stagione con la stessa squadra.
                    </p>
                    <button
                      onClick={resetStagione}
                      className="w-full flex items-center justify-center gap-2 bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors font-semibold"
                    >
                      üîÑ Reset Stagione (mantieni rosa)
                    </button>
                  </div>
                  
                  <div className="p-4 bg-red-50 border-2 border-red-400 rounded-lg">
                    <h4 className="font-bold text-red-900 mb-2">üî¥ Reset Completo (pericoloso)</h4>
                    <p className="text-sm text-red-800 mb-3">
                      Cancella <strong>TUTTO</strong>: giocatori, allenamenti, partite, statistiche, logo.
                      L'app torner√† come nuova. Usa solo se vuoi ricominciare da zero.
                    </p>
                    <button
                      onClick={resetCompleto}
                      className="w-full flex items-center justify-center gap-2 bg-red-700 text-white px-6 py-3 rounded-lg hover:bg-red-800 transition-colors font-semibold"
                    >
                      üî¥ Reset Completo (cancella tutto)
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {showManualImport && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[80vh] flex flex-col">
              <div className="p-6 border-b">
                <h3 className="text-2xl font-bold text-gray-800">üìã Importa Manualmente</h3>
                <p className="text-blue-600 font-bold text-lg mt-2">INCOLLA QUI IL CONTENUTO DEL FILE JSON</p>
                <p className="text-gray-600 mt-1 text-sm">Apri il file JSON con un editor di testo, seleziona tutto (Ctrl+A o Cmd+A) e incolla qui sotto</p>
              </div>
              
              <div className="flex-1 overflow-auto p-6">
                <textarea
                  value={manualImportData}
                  onChange={(e) => setManualImportData(e.target.value)}
                  placeholder='Incolla qui il contenuto del file JSON...'
                  className="w-full h-full min-h-[400px] p-4 border rounded-lg font-mono text-sm"
                />
              </div>
              
              <div className="p-6 border-t flex gap-3 justify-end">
                <button
                  onClick={handleManualImport}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                >
                  ‚úÖ Importa Dati
                </button>
                <button
                  onClick={() => {
                    setShowManualImport(false);
                    setManualImportData('');
                  }}
                  className="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-semibold"
                >
                  Annulla
                </button>
              </div>
            </div>
            </div>
            )}
          </div>
        )}

        {/* ============================================ */}
        {/* TAB SINCRONIZZAZIONE CLOUD */}
        {/* ============================================ */}
        {activeTab === 'sync' && (
          <div className="animate-fade-in">
            {userRole !== 'admin' ? (
              // Accesso negato per user
              <div className="bg-red-50 border-2 border-red-300 rounded-lg p-12 text-center animate-fade-in">
                <div className="text-6xl mb-4">üîí</div>
                <h2 className="text-2xl font-bold text-red-900 mb-2">Accesso Negato</h2>
                <p className="text-red-700 mb-4">
                  Solo gli amministratori possono gestire la sincronizzazione cloud del database.
                </p>
                <button
                  onClick={() => setActiveTab('dashboard')}
                  className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                >
                  ‚Üê Torna alla Dashboard
                </button>
              </div>
            ) : (
              // Contenuto normale per admin
              <div>
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">‚òÅÔ∏è Sincronizzazione Cloud</h2>
              <p className="text-gray-600">Gestisci la sincronizzazione dei dati tra dispositivo locale e cloud Firebase</p>
            </div>

            {/* ========== CARD STATO DISPOSITIVO ========== */}
            {deviceRole && (
              <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg shadow-lg p-6 mb-6 border-2 border-indigo-300">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-xl font-bold text-gray-800">üñ•Ô∏è Configurazione Dispositivo</h3>
                  <button
                    onClick={() => setShowDeviceModal(true)}
                    className="text-sm bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
                  >
                    ‚öôÔ∏è Cambia
                  </button>
                </div>
                
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="bg-white rounded-lg p-4 border-2 border-gray-200">
                    <div className="text-sm text-gray-600 mb-1">Tipo Dispositivo</div>
                    <div className="text-lg font-bold text-gray-800">{getDeviceName()}</div>
                  </div>
                  
                  <div className="bg-white rounded-lg p-4 border-2 border-gray-200">
                    <div className="text-sm text-gray-600 mb-1">Ruolo</div>
                    <div className="text-lg font-bold text-gray-800">
                      {deviceRole === 'primary' ? 'üëë Principale' : 'üì± Secondario'}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Status Card */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 mb-6 border-2 border-blue-200">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-gray-800">Stato Sincronizzazione</h3>
                {syncStatus === 'syncing' && (
                  <div className="spinner"></div>
                )}
                {syncStatus === 'success' && (
                  <span className="text-green-600 text-2xl animate-pulse">‚úÖ</span>
                )}
                {syncStatus === 'error' && (
                  <span className="text-red-600 text-2xl animate-shake">‚ùå</span>
                )}
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-sm text-gray-600 mb-1">Ultimo Salvataggio Locale</div>
                  <div className="text-lg font-bold text-gray-800">
                    {lastSaved ? lastSaved.toLocaleString('it-IT') : 'Mai salvato'}
                  </div>
                </div>
                <div className="bg-white rounded-lg p-4 shadow">
                  <div className="text-sm text-gray-600 mb-1">Ultima Sincronizzazione Cloud</div>
                  <div className="text-lg font-bold text-gray-800">
                    {lastSynced ? lastSynced.toLocaleString('it-IT') : 'Mai sincronizzato'}
                  </div>
                </div>
              </div>

              {syncError && (
                <div className="bg-red-100 border-2 border-red-300 rounded-lg p-4 mb-4">
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">‚ö†Ô∏è</span>
                    <div>
                      <div className="font-bold text-red-800 mb-1">Errore di Sincronizzazione</div>
                      <div className="text-sm text-red-700">{syncError}</div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Azioni di Sincronizzazione */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              
              {/* Upload Cloud */}
              <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-6 border-2 border-green-200">
                <div className="text-4xl mb-4">‚òÅÔ∏è‚Üë</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Carica su Cloud</h3>
                <p className="text-gray-600 text-sm mb-4">
                  Carica forzatamente i dati locali sul cloud, sovrascrivendo quelli presenti
                </p>
                <button
                  onClick={() => {
                    if (window.confirm('‚ö†Ô∏è Questa operazione sovrascriver√† i dati nel cloud con quelli locali.\n\nSei sicuro?')) {
                      syncToFirestore();
                    }
                  }}
                  disabled={syncStatus === 'syncing'}
                  className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {syncStatus === 'syncing' ? '‚è≥ Caricamento...' : '‚òÅÔ∏è Carica su Cloud'}
                </button>
              </div>

              {/* Download Cloud */}
              <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg shadow-lg p-6 border-2 border-orange-200">
                <div className="text-4xl mb-4">‚òÅÔ∏è‚Üì</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Scarica da Cloud</h3>
                <p className="text-gray-600 text-sm mb-4">
                  Scarica forzatamente i dati dal cloud, sovrascrivendo quelli locali
                </p>
                <button
                  onClick={() => {
                    console.log('üîò BOTTONE SCARICA CLICCATO!');
                    console.log('   User:', user?.email);
                    console.log('   syncStatus:', syncStatus);
                    console.log('   disabled:', syncStatus === 'syncing');
                    
                    if (window.confirm('‚ö†Ô∏è Questa operazione sovrascriver√† i dati locali con quelli del cloud.\n\nSei sicuro?')) {
                      console.log('‚úÖ Confermato! Chiamo syncFromFirestore(true)...');
                      syncFromFirestore(true);
                    } else {
                      console.log('‚ùå Annullato dall\'utente');
                    }
                  }}
                  disabled={syncStatus === 'syncing'}
                  className="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {syncStatus === 'syncing' ? '‚è≥ Scaricamento...' : '‚òÅÔ∏è Scarica da Cloud'}
                </button>
              </div>

              {/* Statistiche Dati */}
              <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-lg p-6 border-2 border-purple-200">
                <div className="text-4xl mb-4">üìä</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Statistiche Dati</h3>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between">
                    <span className="text-gray-600">Giocatori in rosa:</span>
                    <span className="font-bold text-gray-800">{players.filter(p => p.nome).length}/30</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Allenamenti registrati:</span>
                    <span className="font-bold text-gray-800">{trainings.length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Partite registrate:</span>
                    <span className="font-bold text-gray-800">{matches.length}</span>
                  </div>
                  <div className="flex justify-between pt-2 border-t">
                    <span className="text-gray-600">Utente connesso:</span>
                    <span className="font-bold text-gray-800 truncate max-w-[200px]" title={user?.email}>
                      {user?.email || 'N/A'}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            {/* Info Box */}
            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
              <div className="flex items-start gap-3">
                <div className="text-2xl">‚ÑπÔ∏è</div>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">Come Funziona la Sincronizzazione</h4>
                  <ul className="text-sm text-gray-700 space-y-2">
                    <li>
                      <strong>‚òÅÔ∏è‚Üë Carica su Cloud:</strong> Salva i dati locali sul cloud Firebase. Usa questa opzione quando hai fatto modifiche importanti che vuoi conservare nel cloud come backup.
                    </li>
                    <li>
                      <strong>‚òÅÔ∏è‚Üì Scarica da Cloud:</strong> Scarica i dati dal cloud e sostituisce quelli locali. Usa questa opzione quando hai modificato i dati da un altro dispositivo e vuoi aggiornarli su questo dispositivo.
                    </li>
                    <li>
                      <strong>üíæ Backup Locale:</strong> I dati sono SEMPRE salvati automaticamente in locale (IndexedDB) ad ogni modifica. La sincronizzazione cloud √® un backup aggiuntivo che devi gestire manualmente.
                    </li>
                    <li>
                      <strong>‚ö†Ô∏è Attenzione:</strong> Le operazioni di carica/scarica SOVRASCRIVONO i dati. Usa sempre la conferma per evitare perdite accidentali. In caso di dubbio, esporta prima un backup JSON dalla sezione Esportazioni.
                    </li>
                    <li>
                      <strong>üîí Privacy:</strong> I tuoi dati sono privati. Solo tu puoi accedere ai dati del tuo account. Ogni utente ha il suo spazio cloud separato.
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            {/* Compatibilit√† Export/Import */}
            <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6 mt-6">
              <div className="flex items-start gap-3">
                <div className="text-2xl">‚úÖ</div>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">Compatibilit√† con Export/Import JSON</h4>
                  <p className="text-sm text-gray-700 mb-2">
                    La sincronizzazione cloud NON sostituisce le funzioni di export/import JSON! Puoi sempre:
                  </p>
                  <ul className="text-sm text-gray-700 space-y-1 ml-4">
                    <li>‚Ä¢ Esportare i dati in JSON come backup manuale</li>
                    <li>‚Ä¢ Importare JSON per ripristinare o migrare dati</li>
                    <li>‚Ä¢ Utilizzare JSON per trasferire dati tra account diversi</li>
                    <li>‚Ä¢ Creare backup offline dei dati</li>
                  </ul>
                  <p className="text-sm text-gray-700 mt-2">
                    <strong>üí° Consiglio:</strong> Usa la sincronizzazione cloud per l'accesso multi-dispositivo quotidiano, e l'export JSON per backup di sicurezza periodici!
                  </p>
                </div>
              </div>
            </div>
            </div>
            )}
          </div>
        )}

        {/* ============================================ */}
        {/* TAB GESTIONE UTENTI ADMIN */}
        {/* ============================================ */}
        {activeTab === 'admin' && userRole === 'admin' && (
          <div className="animate-fade-in">
            <div className="mb-6">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">üëë Gestione Utenti</h2>
              <p className="text-gray-600">Gestisci account utenti e permessi (Solo Admin)</p>
            </div>

            {/* Azioni Rapide */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <button
                onClick={loadAllUsers}
                disabled={loadingUsers}
                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {loadingUsers ? (
                  <>
                    <div className="spinner"></div>
                    <span>Caricamento...</span>
                  </>
                ) : (
                  <>
                    <span className="text-2xl">üîÑ</span>
                    <span>Carica Lista Utenti</span>
                  </>
                )}
              </button>

              <button
                onClick={() => setShowCreateUserModal(true)}
                className="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
              >
                <span className="text-2xl">‚ûï</span>
                <span>Crea Nuovo Utente</span>
              </button>
            </div>

            {/* Avviso Importante */}
            <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
              <div className="flex items-start gap-3">
                <span className="text-2xl">‚ö†Ô∏è</span>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">Note Importanti</h4>
                  <ul className="text-sm text-gray-700 space-y-1">
                    <li>‚Ä¢ <strong>Crea Utente:</strong> Ti far√† logout temporaneamente. Dovrai rifare login come admin.</li>
                    <li>‚Ä¢ <strong>Reset Password:</strong> Invia email all'utente con link per cambiare password.</li>
                    <li>‚Ä¢ <strong>Elimina Utente:</strong> Rimuove solo da Firestore. Per eliminare completamente, usa Firebase Console.</li>
                    <li>‚Ä¢ <strong>Cambio Email:</strong> Per cambiare email, usa Firebase Console ‚Üí Authentication ‚Üí Edit user.</li>
                  </ul>
                </div>
              </div>
            </div>

            {/* Lista Utenti */}
            {allUsers.length > 0 && (
              <div className="bg-white border-2 border-gray-200 rounded-lg overflow-hidden">
                <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-4">
                  <h3 className="text-xl font-bold text-white">üìã Utenti Registrati ({allUsers.length})</h3>
                </div>

                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-4 py-3 text-left text-sm font-bold text-gray-700">Email</th>
                        <th className="px-4 py-3 text-left text-sm font-bold text-gray-700">Ruolo</th>
                        <th className="px-4 py-3 text-left text-sm font-bold text-gray-700">Creato</th>
                        <th className="px-4 py-3 text-center text-sm font-bold text-gray-700">Azioni</th>
                      </tr>
                    </thead>
                    <tbody>
                      {allUsers.map((usr, index) => (
                        <tr key={usr.uid} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                          <td className="px-4 py-3 text-sm">
                            <div className="flex items-center gap-2">
                              <span className="text-lg">{usr.role === 'admin' ? 'üëë' : 'üëÅÔ∏è'}</span>
                              <span className="font-medium">{usr.email || usr.uid}</span>
                              {usr.uid === user.uid && (
                                <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded">TU</span>
                              )}
                            </div>
                          </td>
                          <td className="px-4 py-3">
                            <select
                              value={usr.role || 'user'}
                              onChange={(e) => changeUserRole(usr.uid, e.target.value)}
                              disabled={usr.uid === user.uid || userActionLoading}
                              className={`px-3 py-1 rounded-lg text-sm font-bold ${
                                usr.role === 'admin'
                                  ? 'bg-yellow-100 text-yellow-800'
                                  : 'bg-blue-100 text-blue-800'
                              } disabled:opacity-50`}
                            >
                              <option value="admin">üëë Admin</option>
                              <option value="user">üëÅÔ∏è User</option>
                            </select>
                          </td>
                          <td className="px-4 py-3 text-sm text-gray-600">
                            {usr.createdAt ? new Date(usr.createdAt).toLocaleDateString('it-IT') : 'N/A'}
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex items-center justify-center gap-2">
                              <button
                                onClick={() => sendPasswordReset(usr.email)}
                                disabled={userActionLoading || !usr.email}
                                className="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                title="Invia email reset password"
                              >
                                üîë Reset
                              </button>
                              <button
                                onClick={() => deleteUser(usr.uid, usr.email)}
                                disabled={usr.uid === user.uid || userActionLoading}
                                className="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs font-bold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                title="Elimina utente"
                              >
                                üóëÔ∏è
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {allUsers.length === 0 && !loadingUsers && (
              <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-12 text-center">
                <div className="text-6xl mb-4">üë•</div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">Nessun Utente Caricato</h3>
                <p className="text-gray-600 mb-4">Clicca "Carica Lista Utenti" per vedere tutti gli account</p>
              </div>
            )}

            {/* Guida Firebase Console */}
            <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-6 mt-6">
              <div className="flex items-start gap-3">
                <span className="text-2xl">üí°</span>
                <div>
                  <h4 className="font-bold text-gray-800 mb-2">Per Gestione Avanzata: Firebase Console</h4>
                  <p className="text-sm text-gray-700 mb-2">
                    Per operazioni avanzate come cambio email, vai su Firebase Console:
                  </p>
                  <ol className="text-sm text-gray-700 space-y-1 ml-4 list-decimal">
                    <li>Vai su <strong>console.firebase.google.com</strong></li>
                    <li>Seleziona il progetto</li>
                    <li>Menu ‚Üí <strong>Authentication</strong> ‚Üí Tab <strong>Users</strong></li>
                    <li>Click <strong>‚ãÆ</strong> sull'utente ‚Üí <strong>Edit user</strong></li>
                    <li>Modifica email, disabilita account, o elimina completamente</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Crea Nuovo Utente */}
        {showCreateUserModal && (
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[110] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6 animate-scale-up">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">‚ûï</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Crea Nuovo Utente</h2>
              </div>

              <div className="space-y-4 mb-6">
                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-2">Email</label>
                  <input
                    type="email"
                    value={newUserEmail}
                    onChange={(e) => setNewUserEmail(e.target.value)}
                    placeholder="utente@example.com"
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    disabled={userActionLoading}
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-2">Password</label>
                  <input
                    type="password"
                    value={newUserPassword}
                    onChange={(e) => setNewUserPassword(e.target.value)}
                    placeholder="Minimo 6 caratteri"
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    disabled={userActionLoading}
                  />
                  <p className="text-xs text-gray-500 mt-1">Minimo 6 caratteri</p>
                </div>

                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-2">Ruolo</label>
                  <select
                    value={newUserRole}
                    onChange={(e) => setNewUserRole(e.target.value)}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    disabled={userActionLoading}
                  >
                    <option value="user">üëÅÔ∏è Visualizzatore (User)</option>
                    <option value="admin">üëë Amministratore (Admin)</option>
                  </select>
                </div>
              </div>

              <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                <div className="flex items-start gap-2">
                  <span className="text-xl">‚ö†Ô∏è</span>
                  <p className="text-sm text-gray-700">
                    <strong>ATTENZIONE:</strong> Questa operazione ti far√† logout temporaneamente. Dovrai rifare login come admin dopo la creazione.
                  </p>
                </div>
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowCreateUserModal(false);
                    setNewUserEmail('');
                    setNewUserPassword('');
                    setNewUserRole('user');
                  }}
                  disabled={userActionLoading}
                  className="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50"
                >
                  Annulla
                </button>
                <button
                  onClick={createNewUser}
                  disabled={userActionLoading || !newUserEmail || !newUserPassword}
                  className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {userActionLoading ? 'Creazione...' : '‚úÖ Crea'}
                </button>
              </div>
            </div>
          </div>
        )}

        {confirmDialog.show && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6 animate-scale-up">
              <div className="text-lg font-semibold text-gray-800 mb-4 whitespace-pre-line">
                {confirmDialog.message}
              </div>
              <div className="flex gap-3 justify-end">
                <button
                  onClick={handleCancel}
                  className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
                >
                  Annulla
                </button>
                <button
                  onClick={handleConfirm}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                >
                  Conferma
                </button>
              </div>
            </div>
          </div>
        )}

        {cardTypeDialog.show && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">
                  {cardTypeDialog.cardType === 'yellow' ? 'üü®' : 'üü•'}
                </div>
                <div className="text-xl font-bold text-gray-800 mb-2">
                  Cartellino {cardTypeDialog.cardType === 'yellow' ? 'GIALLO' : 'ROSSO'}
                </div>
                <div className="text-lg text-gray-700">
                  {cardTypeDialog.playerName} (#{cardTypeDialog.playerNum})
                </div>
              </div>
              
              <div className="text-center text-gray-700 font-semibold mb-4">
                Per quale motivo?
              </div>
              
              <div className="flex flex-col gap-3">
                <button
                  onClick={() => assignCard('gioco')}
                  className="px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-bold text-lg shadow-lg"
                >
                  ‚öΩ Per GIOCO
                </button>
                <button
                  onClick={() => assignCard('protesta')}
                  className="px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-bold text-lg shadow-lg"
                >
                  üó£Ô∏è Per PROTESTA
                </button>
                <button
                  onClick={() => setCardTypeDialog({ show: false, cardType: '', playerNum: 0, matchId: null, playerName: '', minuto: null })}
                  className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
                >
                  Annulla
                </button>
              </div>
            </div>
          </div>
        )}

        {enlargedPhoto && (
          <div 
            className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[100] p-4"
            onClick={() => setEnlargedPhoto(null)}
          >
            <div className="relative max-w-4xl max-h-[90vh] w-full">
              <button 
                onClick={() => setEnlargedPhoto(null)}
                className="absolute -top-12 right-0 text-white text-4xl font-bold hover:text-gray-300 transition-colors"
              >
                ‚úï
              </button>
              {enlargedPhoto.nome && (
                <div className="absolute -top-12 left-0 text-white text-xl font-semibold">
                  {enlargedPhoto.nome}
                </div>
              )}
              <img 
                src={enlargedPhoto.foto} 
                alt={enlargedPhoto.nome || 'Giocatore'} 
                className="w-full h-full object-contain rounded-lg"
                onClick={(e) => e.stopPropagation()}
              />
            </div>
          </div>
        )}

        {showVictoryCelebration && (
          <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[110]">
            <div className="relative w-full h-full flex items-center justify-center">
              <div className="absolute inset-0 overflow-hidden pointer-events-none">
                {[...Array(50)].map((_, i) => (
                  <div
                    key={i}
                    className="absolute animate-confetti"
                    style={{
                      left: `${Math.random() * 100}%`,
                      top: `-${Math.random() * 20}%`,
                      width: '10px',
                      height: '10px',
                      backgroundColor: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'][Math.floor(Math.random() * 6)],
                      animationDelay: `${Math.random() * 3}s`,
                      animationDuration: `${3 + Math.random() * 2}s`,
                      transform: `rotate(${Math.random() * 360}deg)`
                    }}
                  />
                ))}
              </div>
              
              <div className="relative z-10 text-center px-4">
                <div className="text-8xl md:text-9xl font-black text-yellow-400 animate-bounce mb-4" style={{textShadow: '4px 4px 8px rgba(0,0,0,0.8), 0 0 40px rgba(255,215,0,0.8)'}}>
                  üèÜ VITTORIA! üèÜ
                </div>
                <div className="text-7xl md:text-8xl font-black text-white animate-pulse" style={{textShadow: '4px 4px 10px rgba(0,0,0,0.9), 0 0 30px rgba(255,255,255,0.5)'}}>
                  Volevano Vincere!!
                </div>
                <div className="text-7xl md:text-8xl font-black text-white animate-pulse mt-2" style={{textShadow: '4px 4px 10px rgba(0,0,0,0.9), 0 0 30px rgba(255,255,255,0.5)', animationDelay: '0.3s'}}>
                  Volevano Vincere!!
                </div>
                
                <div className="flex justify-center gap-4 mt-6 text-5xl">
                  <span className="animate-bounce" style={{animationDelay: '0s'}}>üéµ</span>
                  <span className="animate-bounce" style={{animationDelay: '0.2s'}}>üé∂</span>
                  <span className="animate-bounce" style={{animationDelay: '0.4s'}}>üéµ</span>
                  <span className="animate-bounce" style={{animationDelay: '0.6s'}}>üé∂</span>
                  <span className="animate-bounce" style={{animationDelay: '0.8s'}}>üéµ</span>
                </div>
                
                <button 
                  onClick={() => setShowVictoryCelebration(false)}
                  className="mt-8 px-4 py-2 bg-yellow-400 text-black rounded-lg hover:bg-yellow-500 font-bold text-sm shadow-lg border-2 border-yellow-600"
                >
                  ‚úï Chiudi Festeggiamento
                </button>
              </div>
            </div>
          </div>
        )}
        
        {/* Modal Risoluzione Conflitti Sincronizzazione */}
        {showConflictModal && syncConflicts && (
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[110] p-4 animate-fade-in">
            <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full p-6 animate-scale-up max-h-[90vh] overflow-y-auto">
              <div className="text-center mb-6">
                <div className="text-6xl mb-3">‚ö†Ô∏è</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Conflitto di Sincronizzazione</h2>
                <p className="text-gray-600">Sono stati trovati dati sia in locale che nel cloud. Scegli quale versione mantenere:</p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                {/* Dati Locali */}
                <div className="border-2 border-blue-300 rounded-lg p-4 bg-blue-50">
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-3xl">üíæ</span>
                    <h3 className="text-xl font-bold text-gray-800">Dati Locali (Questo Dispositivo)</h3>
                  </div>
                  <div className="space-y-2 text-sm mb-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giocatori:</span>
                      <span className="font-bold">{syncConflicts.local.players.filter(p => p.nome).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Allenamenti:</span>
                      <span className="font-bold">{syncConflicts.local.trainings.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Partite:</span>
                      <span className="font-bold">{syncConflicts.local.matches.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Squadre Girone:</span>
                      <span className="font-bold">{(syncConflicts.local.squadreGirone || []).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giornate Campionato:</span>
                      <span className="font-bold">{(syncConflicts.local.risultatiCampionato || []).length}</span>
                    </div>
                    <div className="flex justify-between pt-2 border-t">
                      <span className="text-gray-600">Ultima modifica:</span>
                      <span className="font-bold">{syncConflicts.local.lastSaved.toLocaleString('it-IT')}</span>
                    </div>
                  </div>
                  <button
                    onClick={() => resolveConflict('local')}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    ‚úÖ Mantieni Dati Locali
                  </button>
                  <p className="text-xs text-gray-600 mt-2 text-center">
                    Sovrascriver√† i dati nel cloud
                  </p>
                </div>

                {/* Dati Cloud */}
                <div className="border-2 border-green-300 rounded-lg p-4 bg-green-50">
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-3xl">‚òÅÔ∏è</span>
                    <h3 className="text-xl font-bold text-gray-800">Dati Cloud (Firebase)</h3>
                  </div>
                  <div className="space-y-2 text-sm mb-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giocatori:</span>
                      <span className="font-bold">{syncConflicts.cloud.players.filter(p => p.nome).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Allenamenti:</span>
                      <span className="font-bold">{syncConflicts.cloud.trainings.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Partite:</span>
                      <span className="font-bold">{syncConflicts.cloud.matches.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Squadre Girone:</span>
                      <span className="font-bold">{(syncConflicts.cloud.squadreGirone || []).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Giornate Campionato:</span>
                      <span className="font-bold">{(syncConflicts.cloud.risultatiCampionato || []).length}</span>
                    </div>
                    <div className="flex justify-between pt-2 border-t">
                      <span className="text-gray-600">Ultima sincronizzazione:</span>
                      <span className="font-bold">{syncConflicts.cloud.lastSynced.toLocaleString('it-IT')}</span>
                    </div>
                  </div>
                  <button
                    onClick={() => resolveConflict('cloud')}
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                  >
                    ‚úÖ Mantieni Dati Cloud
                  </button>
                  <p className="text-xs text-gray-600 mt-2 text-center">
                    Sovrascriver√† i dati locali
                  </p>
                </div>
              </div>

              <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                <div className="flex items-start gap-3">
                  <span className="text-2xl">‚ö†Ô∏è</span>
                  <div>
                    <h4 className="font-bold text-gray-800 mb-2">Attenzione!</h4>
                    <p className="text-sm text-gray-700">
                      Scegliendo una versione, l'altra verr√† <strong>completamente sovrascritta</strong>. 
                      Assicurati di scegliere la versione con i dati pi√π aggiornati e completi.
                    </p>
                    {(syncConflicts.local.players.filter(p => p.nome).length === 0 || 
                      syncConflicts.cloud.players.filter(p => p.nome).length === 0) && (
                      <p className="text-sm font-bold text-red-600 mt-2">
                        üö® ATTENZIONE: Una delle versioni √® VUOTA! Non sovrascrivere dati pieni con dati vuoti!
                      </p>
                    )}
                    <p className="text-sm text-gray-700 mt-2">
                      <strong>üí° Suggerimento:</strong> Se non sei sicuro, esporta prima un backup JSON dal tab Esportazioni!
                    </p>
                  </div>
                </div>
              </div>

              <button
                onClick={() => {
                  setSyncConflicts(null);
                  setShowConflictModal(false);
                }}
                className="w-full px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-semibold"
              >
                ‚Üê Annulla
              </button>
            </div>
          </div>
        )}
        
        <style>{`
          @keyframes confetti {
            0% {
              transform: translateY(0) rotate(0deg);
              opacity: 1;
            }
            100% {
              transform: translateY(100vh) rotate(720deg);
              opacity: 0;
            }
          }
          
          .animate-confetti {
            animation: confetti linear infinite;
          }
        `}</style>
        
        {/* ========== MODAL ESERCIZI RAPIDO (ROOT LEVEL) ========== */}
        {exerciseModalTraining && (() => {
          console.log('üé®üé®üé® MODAL STA RENDERIZZANDO! Training ID:', exerciseModalTraining.id);
          console.log('üé® exerciseModalTraining:', exerciseModalTraining);
          return (
          <div 
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              zIndex: 9999,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              backgroundColor: 'rgba(0, 0, 0, 0.5)'
            }}
            onClick={() => {
              console.log('üö™ Click overlay - chiudo modal');
              setExerciseModalTraining(null);
            }}
          >
            <div 
              className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden"
              style={{ position: 'relative', zIndex: 10000 }}
              onClick={(e) => {
                console.log('üõë Click modal content - non chiudo');
                e.stopPropagation();
              }}
            >
              {/* Header */}
              <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 flex justify-between items-center">
                <div>
                  <h3 className="text-xl font-bold">Esercizi Allenamento</h3>
                  <p className="text-sm text-blue-100 mt-1">
                    {new Date(exerciseModalTraining.data).toLocaleDateString('it-IT', { 
                      weekday: 'long', 
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric' 
                    })}
                  </p>
                </div>
                <button
                  onClick={() => setExerciseModalTraining(null)}
                  className="text-white hover:bg-blue-800 rounded-full p-2 transition-colors text-2xl font-bold"
                  title="Chiudi"
                >
                  ‚úï
                </button>
              </div>
              
              {/* Body */}
              <div className="p-6 overflow-y-auto max-h-[calc(80vh-120px)]">
                {exerciseModalTraining.esercizi && exerciseModalTraining.esercizi.length > 0 ? (
                  <div className="space-y-4">
                    {/* Riepilogo totale */}
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
                      <div className="flex items-center justify-between">
                        <div>
                          <span className="text-3xl font-bold text-blue-700">
                            {exerciseModalTraining.esercizi.length}
                          </span>
                          <span className="text-gray-700 ml-2">esercizi totali</span>
                        </div>
                        <div>
                          <span className="text-3xl font-bold text-blue-700">
                            {calcolaTotaleMinuti(exerciseModalTraining.esercizi)}
                          </span>
                          <span className="text-gray-700 ml-2">minuti totali</span>
                        </div>
                      </div>
                    </div>
                    
                    {/* Lista esercizi */}
                    {exerciseModalTraining.esercizi.map((esercizio, idx) => (
                      <div 
                        key={idx}
                        className="bg-white border-2 border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                      >
                        <div className="flex items-start gap-3">
                          <div className="flex-shrink-0 w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-lg">
                            {idx + 1}
                          </div>
                          <div className="flex-1">
                            <div className="flex items-center gap-3 mb-2">
                              <h4 className="text-lg font-bold text-gray-800">
                                {esercizio.nome}
                              </h4>
                              <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
                                {esercizio.durata} min
                              </span>
                            </div>
                            {esercizio.descrizione && (
                              <p className="text-gray-600 text-sm whitespace-pre-wrap">
                                {esercizio.descrizione}
                              </p>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12 text-gray-500">
                    <p className="text-lg">Nessun esercizio registrato</p>
                  </div>
                )}
              </div>
              
              {/* Footer */}
              <div className="bg-gray-50 p-4 flex justify-between items-center border-t gap-3">
                <button
                  onClick={() => exportEserciziPDF(exerciseModalTraining)}
                  className="flex items-center gap-2 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                  </svg>
                  Esporta PDF
                </button>
                <button
                  onClick={() => setExerciseModalTraining(null)}
                  className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                >
                  Chiudi
                </button>
              </div>
            </div>
          </div>
          );
        })()}
        
        {/* ========== TOAST NOTIFICATIONS ========== */}
        <div className="toast-container">
          {toasts.map(toast => (
            <div
              key={toast.id}
              className={`toast toast-${toast.type} ${toast.exiting ? 'toast-exit' : ''}`}
            >
              <div className="text-2xl">
                {toast.type === 'success' && '‚úÖ'}
                {toast.type === 'error' && '‚ùå'}
                {toast.type === 'warning' && '‚ö†Ô∏è'}
                {toast.type === 'info' && '‚ÑπÔ∏è'}
              </div>
              <div className="flex-1">
                <div className="font-semibold text-gray-800">{toast.message}</div>
              </div>
              <button
                onClick={() => setToasts(prev => prev.filter(t => t.id !== toast.id))}
                className="text-gray-400 hover:text-gray-600 text-xl font-bold"
              >
                √ó
              </button>
            </div>
          ))}
        </div>

        {/* ========== LOADING OVERLAY MIGLIORATO ========== */}
        {showLoading && (
          <div className="loading-overlay">
            <div className="loading-content">
              <div className="text-6xl mb-4 animate-pulse">‚öΩ</div>
              <div className="text-xl font-bold text-gray-800 mb-2">{loadingMessage}</div>
              {loadingProgress > 0 && (
                <>
                  <div className="progress-bar">
                    <div 
                      className="progress-bar-fill"
                      style={{ width: `${loadingProgress}%` }}
                    ></div>
                  </div>
                  <div className="text-sm text-gray-600 mt-2">{loadingProgress}%</div>
                </>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<SoccerTeamTracker />);
  </script>
  
  <script>
    // ========== FIX RIDIMENSIONAMENTO ORIENTAMENTO MOBILE ==========
    if (window.matchMedia("(max-width: 640px)").matches) {
      let resizeTimeout;
      
      // Gestione cambio orientamento
      window.addEventListener('orientationchange', function() {
        // Forza ridimensionamento dopo cambio orientamento
        setTimeout(function() {
          // Forza reflow
          document.body.style.height = window.innerHeight + 'px';
          setTimeout(function() {
            document.body.style.height = '';
          }, 100);
        }, 100);
      });
      
      // Gestione resize window per zoom corretto
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          // Aggiusta viewport se necessario
          const viewport = document.querySelector('meta[name=viewport]');
          if (viewport) {
            viewport.setAttribute('content', 
              'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes'
            );
          }
        }, 250);
      });
      
      // Fix iniziale
      window.addEventListener('load', function() {
        setTimeout(function() {
          window.scrollTo(0, 0);
        }, 100);
      });
    }
  </script>
</body>
</html>
